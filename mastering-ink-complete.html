<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="" xml:lang="">
<head>
  <meta charset="utf-8" />
  <meta name="generator" content="pandoc" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes" />
  <title>Mastering ink!</title>
  <style>
    code{white-space: pre-wrap;}
    span.smallcaps{font-variant: small-caps;}
    div.columns{display: flex; gap: min(4vw, 1.5em);}
    div.column{flex: auto; overflow-x: auto;}
    div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
    /* The extra [class] is a hack that increases specificity enough to
       override a similar rule in reveal.js */
    ul.task-list[class]{list-style: none;}
    ul.task-list li input[type="checkbox"] {
      font-size: inherit;
      width: 0.8em;
      margin: 0 0.8em 0.2em -1.6em;
      vertical-align: middle;
    }
    .display.math{display: block; text-align: center; margin: 0.5rem auto;}
    /* CSS for syntax highlighting */
    html { -webkit-text-size-adjust: 100%; }
    pre > code.sourceCode { white-space: pre; position: relative; }
    pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
    pre > code.sourceCode > span:empty { height: 1.2em; }
    .sourceCode { overflow: visible; }
    code.sourceCode > span { color: inherit; text-decoration: inherit; }
    div.sourceCode { margin: 1em 0; }
    pre.sourceCode { margin: 0; }
    @media screen {
    div.sourceCode { overflow: auto; }
    }
    @media print {
    pre > code.sourceCode { white-space: pre-wrap; }
    pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
    }
    pre.numberSource code
      { counter-reset: source-line 0; }
    pre.numberSource code > span
      { position: relative; left: -4em; counter-increment: source-line; }
    pre.numberSource code > span > a:first-child::before
      { content: counter(source-line);
        position: relative; left: -1em; text-align: right; vertical-align: baseline;
        border: none; display: inline-block;
        -webkit-touch-callout: none; -webkit-user-select: none;
        -khtml-user-select: none; -moz-user-select: none;
        -ms-user-select: none; user-select: none;
        padding: 0 4px; width: 4em;
        color: #aaaaaa;
      }
    pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
    div.sourceCode
      {   }
    @media screen {
    pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
    }
    code span.al { color: #ff0000; font-weight: bold; } /* Alert */
    code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
    code span.at { color: #7d9029; } /* Attribute */
    code span.bn { color: #40a070; } /* BaseN */
    code span.bu { color: #008000; } /* BuiltIn */
    code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
    code span.ch { color: #4070a0; } /* Char */
    code span.cn { color: #880000; } /* Constant */
    code span.co { color: #60a0b0; font-style: italic; } /* Comment */
    code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
    code span.do { color: #ba2121; font-style: italic; } /* Documentation */
    code span.dt { color: #902000; } /* DataType */
    code span.dv { color: #40a070; } /* DecVal */
    code span.er { color: #ff0000; font-weight: bold; } /* Error */
    code span.ex { } /* Extension */
    code span.fl { color: #40a070; } /* Float */
    code span.fu { color: #06287e; } /* Function */
    code span.im { color: #008000; font-weight: bold; } /* Import */
    code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
    code span.kw { color: #007020; font-weight: bold; } /* Keyword */
    code span.op { color: #666666; } /* Operator */
    code span.ot { color: #007020; } /* Other */
    code span.pp { color: #bc7a00; } /* Preprocessor */
    code span.sc { color: #4070a0; } /* SpecialChar */
    code span.ss { color: #bb6688; } /* SpecialString */
    code span.st { color: #4070a0; } /* String */
    code span.va { color: #19177c; } /* Variable */
    code span.vs { color: #4070a0; } /* VerbatimString */
    code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
  </style>
  <link rel="stylesheet" href="style.css" />
</head>
<body>
<header id="title-block-header">
<h1 class="title">Mastering ink!</h1>
</header>
<nav id="TOC" role="doc-toc">
<ul>
<li><a href="#mastering-ink-building-production-ready-smart-contracts"
id="toc-mastering-ink-building-production-ready-smart-contracts">Mastering
ink!: Building Production-Ready Smart Contracts</a>
<ul>
<li><a href="#table-of-contents" id="toc-table-of-contents">Table of
Contents</a></li>
</ul></li>
<li><a href="#preface-who-this-book-is-for"
id="toc-preface-who-this-book-is-for">Preface: Who This Book Is For</a>
<ul>
<li><a href="#what-is-ink" id="toc-what-is-ink">What is ink!?</a></li>
<li><a href="#the-goal-of-this-book" id="toc-the-goal-of-this-book">The
Goal of This Book</a></li>
<li><a href="#prerequisites" id="toc-prerequisites">Prerequisites</a>
<ul>
<li><a href="#blockchain-fundamentals"
id="toc-blockchain-fundamentals">Blockchain Fundamentals</a></li>
<li><a href="#rust-programming-language"
id="toc-rust-programming-language">Rust Programming Language</a></li>
<li><a href="#development-environment"
id="toc-development-environment">Development Environment</a></li>
</ul></li>
<li><a href="#what-this-book-covers" id="toc-what-this-book-covers">What
This Book Covers</a>
<ul>
<li><a href="#structure-overview" id="toc-structure-overview">Structure
Overview</a></li>
<li><a href="#code-standards" id="toc-code-standards">Code
Standards</a></li>
<li><a href="#mathematical-notation"
id="toc-mathematical-notation">Mathematical Notation</a></li>
</ul></li>
<li><a href="#who-should-read-this-book"
id="toc-who-should-read-this-book">Who Should Read This Book</a>
<ul>
<li><a href="#primary-audience" id="toc-primary-audience">Primary
Audience</a></li>
<li><a href="#secondary-audience" id="toc-secondary-audience">Secondary
Audience</a></li>
</ul></li>
<li><a href="#who-should-not-read-this-book"
id="toc-who-should-not-read-this-book">Who Should NOT Read This
Book</a></li>
<li><a href="#how-to-use-this-book" id="toc-how-to-use-this-book">How to
Use This Book</a>
<ul>
<li><a href="#linear-reading" id="toc-linear-reading">Linear
Reading</a></li>
<li><a href="#reference-usage" id="toc-reference-usage">Reference
Usage</a></li>
<li><a href="#hands-on-approach" id="toc-hands-on-approach">Hands-On
Approach</a></li>
<li><a href="#community-engagement"
id="toc-community-engagement">Community Engagement</a></li>
</ul></li>
<li><a href="#acknowledgments"
id="toc-acknowledgments">Acknowledgments</a></li>
</ul></li>
<li><a href="#chapter-1-the-ink-paradigm-rust-on-the-blockchain"
id="toc-chapter-1-the-ink-paradigm-rust-on-the-blockchain">Chapter 1:
The ink! Paradigm: Rust on the Blockchain</a>
<ul>
<li><a href="#understanding-the-blockchain-foundation"
id="toc-understanding-the-blockchain-foundation">Understanding the
Blockchain Foundation</a>
<ul>
<li><a href="#what-is-a-blockchain" id="toc-what-is-a-blockchain">What
is a Blockchain?</a></li>
<li><a href="#the-evolution-from-simple-transfers-to-smart-contracts"
id="toc-the-evolution-from-simple-transfers-to-smart-contracts">The
Evolution from Simple Transfers to Smart Contracts</a></li>
<li><a href="#what-are-smart-contracts"
id="toc-what-are-smart-contracts">What Are Smart Contracts?</a></li>
<li><a href="#smart-contract-use-cases"
id="toc-smart-contract-use-cases">Smart Contract Use Cases</a></li>
<li><a href="#the-technical-challenge-execution-environments"
id="toc-the-technical-challenge-execution-environments">The Technical
Challenge: Execution Environments</a></li>
</ul></li>
<li><a href="#the-smart-contract-development-landscape"
id="toc-the-smart-contract-development-landscape">The Smart Contract
Development Landscape</a>
<ul>
<li><a href="#current-platforms-and-their-limitations"
id="toc-current-platforms-and-their-limitations">Current Platforms and
Their Limitations</a></li>
<li><a href="#enter-ink-the-rust-advantage"
id="toc-enter-ink-the-rust-advantage">Enter ink!: The Rust
Advantage</a></li>
</ul></li>
<li><a href="#why-ink-the-rust-advantage"
id="toc-why-ink-the-rust-advantage">Why ink!? The Rust Advantage</a>
<ul>
<li><a href="#memory-safety-without-garbage-collection"
id="toc-memory-safety-without-garbage-collection">Memory Safety Without
Garbage Collection</a></li>
<li><a href="#zero-cost-abstractions"
id="toc-zero-cost-abstractions">Zero-Cost Abstractions</a></li>
<li><a href="#type-system-guarantees"
id="toc-type-system-guarantees">Type System Guarantees</a></li>
<li><a href="#ecosystem-maturity" id="toc-ecosystem-maturity">Ecosystem
Maturity</a></li>
</ul></li>
<li><a href="#ink-vs.-solidity-a-technical-comparison"
id="toc-ink-vs.-solidity-a-technical-comparison">ink! vs. Solidity: A
Technical Comparison</a>
<ul>
<li><a href="#solidity-erc-20-token-simplified"
id="toc-solidity-erc-20-token-simplified">Solidity ERC-20 Token
(Simplified)</a></li>
<li><a href="#ink-erc-20-token-simplified"
id="toc-ink-erc-20-token-simplified">ink! ERC-20 Token
(Simplified)</a></li>
<li><a href="#key-differences-analysis"
id="toc-key-differences-analysis">Key Differences Analysis</a></li>
<li><a href="#performance-implications"
id="toc-performance-implications">Performance Implications</a></li>
</ul></li>
<li><a href="#the-polkadot-sdk-stack-where-ink-fits"
id="toc-the-polkadot-sdk-stack-where-ink-fits">The polkadot-sdk Stack:
Where ink! Fits</a>
<ul>
<li><a href="#polkadot-sdk-architecture-layers"
id="toc-polkadot-sdk-architecture-layers">polkadot-sdk Architecture
Layers</a></li>
<li><a href="#pallet-contracts-the-execution-environment"
id="toc-pallet-contracts-the-execution-environment">pallet-contracts:
The Execution Environment</a></li>
<li><a href="#comparison-with-native-pallets"
id="toc-comparison-with-native-pallets">Comparison with Native
Pallets</a></li>
<li><a href="#ink-contract-lifecycle"
id="toc-ink-contract-lifecycle">ink! Contract Lifecycle</a></li>
</ul></li>
<li><a href="#setting-up-your-development-environment"
id="toc-setting-up-your-development-environment">Setting Up Your
Development Environment</a>
<ul>
<li><a href="#step-1-install-rust" id="toc-step-1-install-rust">Step 1:
Install Rust</a></li>
<li><a href="#step-2-configure-the-rust-toolchain"
id="toc-step-2-configure-the-rust-toolchain">Step 2: Configure the Rust
Toolchain</a></li>
<li><a href="#step-3-install-cargo-contract"
id="toc-step-3-install-cargo-contract">Step 3: Install
cargo-contract</a></li>
<li><a href="#step-4-verify-your-setup"
id="toc-step-4-verify-your-setup">Step 4: Verify Your Setup</a></li>
<li><a href="#step-5-install-a-local-test-node"
id="toc-step-5-install-a-local-test-node">Step 5: Install a Local Test
Node</a></li>
<li><a href="#step-6-install-additional-development-tools"
id="toc-step-6-install-additional-development-tools">Step 6: Install
Additional Development Tools</a></li>
<li><a href="#environment-configuration"
id="toc-environment-configuration">Environment Configuration</a></li>
<li><a href="#ide-setup-recommendations"
id="toc-ide-setup-recommendations">IDE Setup Recommendations</a></li>
<li><a href="#troubleshooting-common-setup-issues"
id="toc-troubleshooting-common-setup-issues">Troubleshooting Common
Setup Issues</a></li>
<li><a href="#verification-checklist"
id="toc-verification-checklist">Verification Checklist</a></li>
</ul></li>
<li><a href="#summary" id="toc-summary">Summary</a></li>
</ul></li>
<li><a href="#chapter-2-anatomy-of-an-ink-contract-your-first-build"
id="toc-chapter-2-anatomy-of-an-ink-contract-your-first-build">Chapter
2: Anatomy of an ink! Contract: Your First Build</a>
<ul>
<li><a href="#project-scaffolding-creating-your-first-contract"
id="toc-project-scaffolding-creating-your-first-contract">Project
Scaffolding: Creating Your First Contract</a>
<ul>
<li><a href="#generating-the-project"
id="toc-generating-the-project">Generating the Project</a></li>
<li><a href="#understanding-cargo.toml"
id="toc-understanding-cargo.toml">Understanding Cargo.toml</a></li>
<li><a href="#the-feature-flag-pattern"
id="toc-the-feature-flag-pattern">The Feature Flag Pattern</a></li>
</ul></li>
<li><a href="#the-anatomy-of-lib.rs-a-complete-walkthrough"
id="toc-the-anatomy-of-lib.rs-a-complete-walkthrough">The Anatomy of
lib.rs: A Complete Walkthrough</a></li>
<li><a href="#macro-deep-dive-understanding-ink-attributes"
id="toc-macro-deep-dive-understanding-ink-attributes">Macro Deep Dive:
Understanding ink! Attributes</a>
<ul>
<li><a href="#inkcontract"
id="toc-inkcontract">#[ink::contract]</a></li>
<li><a href="#inkstorage" id="toc-inkstorage">#[ink(storage)]</a></li>
<li><a href="#inkconstructor"
id="toc-inkconstructor">#[ink(constructor)]</a></li>
<li><a href="#inkmessage" id="toc-inkmessage">#[ink(message)]</a></li>
<li><a href="#conditional-compilation-deep-dive"
id="toc-conditional-compilation-deep-dive">Conditional Compilation Deep
Dive</a></li>
</ul></li>
<li><a href="#the-compilation-pipeline-from-rust-to-wasm"
id="toc-the-compilation-pipeline-from-rust-to-wasm">The Compilation
Pipeline: From Rust to WASM</a>
<ul>
<li><a href="#step-1-cargo-contract-build"
id="toc-step-1-cargo-contract-build">Step 1: Cargo Contract
Build</a></li>
<li><a href="#step-4-bundle-creation"
id="toc-step-4-bundle-creation">Step 4: Bundle Creation</a></li>
</ul></li>
<li><a href="#build-output-analysis"
id="toc-build-output-analysis">Build Output Analysis</a>
<ul>
<li><a href="#directory-structure-after-build"
id="toc-directory-structure-after-build">Directory Structure After
Build</a></li>
<li><a href="#wasm-binary-analysis" id="toc-wasm-binary-analysis">WASM
Binary Analysis</a></li>
<li><a href="#gas-estimation" id="toc-gas-estimation">Gas
Estimation</a></li>
<li><a href="#memory-layout" id="toc-memory-layout">Memory
Layout</a></li>
</ul></li>
<li><a href="#advanced-build-configuration"
id="toc-advanced-build-configuration">Advanced Build Configuration</a>
<ul>
<li><a href="#custom-optimization-settings"
id="toc-custom-optimization-settings">Custom Optimization
Settings</a></li>
<li><a href="#feature-flags-for-different-builds"
id="toc-feature-flags-for-different-builds">Feature Flags for Different
Builds</a></li>
<li><a href="#build-scripts-for-complex-projects"
id="toc-build-scripts-for-complex-projects">Build Scripts for Complex
Projects</a></li>
</ul></li>
<li><a href="#troubleshooting-common-build-issues"
id="toc-troubleshooting-common-build-issues">Troubleshooting Common
Build Issues</a>
<ul>
<li><a href="#issue-cannot-find-macro-ink-in-this-scope"
id="toc-issue-cannot-find-macro-ink-in-this-scope">Issue: “cannot find
macro <code>ink</code> in this scope”</a></li>
<li><a href="#issue-trait-bound-mystruct-scaleencode-is-not-satisfied"
id="toc-issue-trait-bound-mystruct-scaleencode-is-not-satisfied">Issue:
“trait bound <code>MyStruct: scale::Encode</code> is not
satisfied”</a></li>
<li><a href="#issue-wasm-binary-too-large"
id="toc-issue-wasm-binary-too-large">Issue: WASM binary too
large</a></li>
<li><a href="#issue-memory-allocation-failed"
id="toc-issue-memory-allocation-failed">Issue: “memory allocation
failed”</a></li>
</ul></li>
<li><a href="#best-practices-for-contract-structure"
id="toc-best-practices-for-contract-structure">Best Practices for
Contract Structure</a>
<ul>
<li><a href="#organize-code-with-modules"
id="toc-organize-code-with-modules">1. Organize Code with
Modules</a></li>
<li><a href="#document-everything" id="toc-document-everything">2.
Document Everything</a></li>
<li><a href="#use-type-aliases-for-clarity"
id="toc-use-type-aliases-for-clarity">3. Use Type Aliases for
Clarity</a></li>
</ul></li>
<li><a href="#summary-1" id="toc-summary-1">Summary</a></li>
</ul></li>
<li><a href="#chapter-3-deep-dive-into-state-managing-contract-storage"
id="toc-chapter-3-deep-dive-into-state-managing-contract-storage">Chapter
3: Deep Dive into State: Managing Contract Storage</a>
<ul>
<li><a href="#understanding-the-storage-model"
id="toc-understanding-the-storage-model">Understanding the Storage
Model</a>
<ul>
<li><a href="#the-single-storage-root-principle"
id="toc-the-single-storage-root-principle">The Single Storage Root
Principle</a></li>
<li><a href="#storage-key-generation"
id="toc-storage-key-generation">Storage Key Generation</a></li>
</ul></li>
<li><a href="#supported-storage-types"
id="toc-supported-storage-types">Supported Storage Types</a>
<ul>
<li><a href="#primitive-types" id="toc-primitive-types">Primitive
Types</a></li>
<li><a href="#custom-structs-and-enums"
id="toc-custom-structs-and-enums">Custom Structs and Enums</a></li>
<li><a href="#collections-vec-and-btreemap"
id="toc-collections-vec-and-btreemap">Collections: Vec and
BTreeMap</a></li>
</ul></li>
<li><a href="#the-mapping-type-your-primary-tool"
id="toc-the-mapping-type-your-primary-tool">The Mapping Type: Your
Primary Tool</a>
<ul>
<li><a href="#basic-mapping-usage" id="toc-basic-mapping-usage">Basic
Mapping Usage</a></li>
<li><a href="#mapping-key-types" id="toc-mapping-key-types">Mapping Key
Types</a></li>
<li><a href="#mapping-internals-how-keys-become-storage-addresses"
id="toc-mapping-internals-how-keys-become-storage-addresses">Mapping
Internals: How Keys Become Storage Addresses</a></li>
</ul></li>
<li><a href="#advanced-storage-strategies"
id="toc-advanced-storage-strategies">Advanced Storage Strategies</a>
<ul>
<li><a href="#lazy-loading-with-inkstoragelazy"
id="toc-lazy-loading-with-inkstoragelazy">Lazy Loading with
ink::storage::Lazy</a></li>
<li><a href="#memory-optimization-with-inkstoragepacked"
id="toc-memory-optimization-with-inkstoragepacked">Memory Optimization
with ink::storage::Packed</a></li>
<li><a href="#storage-clearing-and-cleanup"
id="toc-storage-clearing-and-cleanup">Storage Clearing and
Cleanup</a></li>
</ul></li>
<li><a href="#storage-patterns-and-best-practices"
id="toc-storage-patterns-and-best-practices">Storage Patterns and Best
Practices</a>
<ul>
<li><a href="#pattern-1-hierarchical-data-with-compound-keys"
id="toc-pattern-1-hierarchical-data-with-compound-keys">Pattern 1:
Hierarchical Data with Compound Keys</a></li>
<li><a href="#pattern-2-pagination-for-large-data-sets"
id="toc-pattern-2-pagination-for-large-data-sets">Pattern 2: Pagination
for Large Data Sets</a></li>
<li><a href="#pattern-3-efficient-existence-checks"
id="toc-pattern-3-efficient-existence-checks">Pattern 3: Efficient
Existence Checks</a></li>
</ul></li>
<li><a href="#gas-optimization-strategies"
id="toc-gas-optimization-strategies">Gas Optimization Strategies</a>
<ul>
<li><a href="#minimize-storage-operations"
id="toc-minimize-storage-operations">1. Minimize Storage
Operations</a></li>
<li><a href="#use-appropriate-data-types"
id="toc-use-appropriate-data-types">2. Use Appropriate Data
Types</a></li>
<li><a href="#lazy-initialization-patterns"
id="toc-lazy-initialization-patterns">3. Lazy Initialization
Patterns</a></li>
</ul></li>
<li><a href="#testing-storage-behavior"
id="toc-testing-storage-behavior">Testing Storage Behavior</a>
<ul>
<li><a href="#unit-tests-for-storage-logic"
id="toc-unit-tests-for-storage-logic">Unit Tests for Storage
Logic</a></li>
<li><a href="#property-based-testing-for-storage"
id="toc-property-based-testing-for-storage">Property-Based Testing for
Storage</a></li>
</ul></li>
<li><a href="#common-storage-pitfalls-and-solutions"
id="toc-common-storage-pitfalls-and-solutions">Common Storage Pitfalls
and Solutions</a>
<ul>
<li><a href="#pitfall-1-large-vector-modifications"
id="toc-pitfall-1-large-vector-modifications">Pitfall 1: Large Vector
Modifications</a></li>
<li><a href="#pitfall-2-inefficient-existence-checks"
id="toc-pitfall-2-inefficient-existence-checks">Pitfall 2: Inefficient
Existence Checks</a></li>
<li><a href="#pitfall-3-unbounded-loops-over-storage"
id="toc-pitfall-3-unbounded-loops-over-storage">Pitfall 3: Unbounded
Loops Over Storage</a></li>
</ul></li>
<li><a href="#summary-2" id="toc-summary-2">Summary</a></li>
</ul></li>
<li><a href="#chapter-4-the-logic-layer-messages-and-constructors"
id="toc-chapter-4-the-logic-layer-messages-and-constructors">Chapter 4:
The Logic Layer: Messages and Constructors</a>
<ul>
<li><a href="#constructor-patterns-flexible-initialization"
id="toc-constructor-patterns-flexible-initialization">Constructor
Patterns: Flexible Initialization</a>
<ul>
<li><a href="#multiple-constructor-pattern"
id="toc-multiple-constructor-pattern">Multiple Constructor
Pattern</a></li>
<li><a href="#constructor-validation-patterns"
id="toc-constructor-validation-patterns">Constructor Validation
Patterns</a></li>
<li><a href="#constructor-initialization-patterns"
id="toc-constructor-initialization-patterns">Constructor Initialization
Patterns</a></li>
</ul></li>
<li><a href="#message-design-building-clear-apis"
id="toc-message-design-building-clear-apis">Message Design: Building
Clear APIs</a>
<ul>
<li><a href="#immutable-vs.-mutable-messages"
id="toc-immutable-vs.-mutable-messages">Immutable vs. Mutable
Messages</a></li>
<li><a href="#message-parameter-patterns"
id="toc-message-parameter-patterns">Message Parameter Patterns</a></li>
<li><a href="#error-handling-patterns"
id="toc-error-handling-patterns">Error Handling Patterns</a></li>
</ul></li>
<li><a href="#payable-messages-handling-native-token-transfers"
id="toc-payable-messages-handling-native-token-transfers">Payable
Messages: Handling Native Token Transfers</a>
<ul>
<li><a href="#basic-payable-message-pattern"
id="toc-basic-payable-message-pattern">Basic Payable Message
Pattern</a></li>
<li><a href="#token-sale-contract-with-payable-messages"
id="toc-token-sale-contract-with-payable-messages">Token Sale Contract
with Payable Messages</a></li>
<li><a href="#advanced-payable-patterns"
id="toc-advanced-payable-patterns">Advanced Payable Patterns</a></li>
</ul></li>
<li><a href="#accessing-environmental-information"
id="toc-accessing-environmental-information">Accessing Environmental
Information</a>
<ul>
<li><a href="#core-environmental-functions"
id="toc-core-environmental-functions">Core Environmental
Functions</a></li>
<li><a href="#advanced-environmental-patterns"
id="toc-advanced-environmental-patterns">Advanced Environmental
Patterns</a></li>
<li><a href="#gas-estimation-and-optimization"
id="toc-gas-estimation-and-optimization">Gas Estimation and
Optimization</a></li>
</ul></li>
<li><a href="#message-testing-patterns"
id="toc-message-testing-patterns">Message Testing Patterns</a></li>
<li><a href="#summary-3" id="toc-summary-3">Summary</a></li>
</ul></li>
<li><a
href="#chapter-5-interoperability-events-and-cross-contract-calls"
id="toc-chapter-5-interoperability-events-and-cross-contract-calls">Chapter
5: Interoperability: Events and Cross-Contract Calls</a>
<ul>
<li><a href="#events-communicating-with-the-outside-world"
id="toc-events-communicating-with-the-outside-world">Events:
Communicating with the Outside World</a>
<ul>
<li><a href="#basic-event-definition-and-emission"
id="toc-basic-event-definition-and-emission">Basic Event Definition and
Emission</a></li>
<li><a href="#understanding-topics-efficient-event-filtering"
id="toc-understanding-topics-efficient-event-filtering">Understanding
Topics: Efficient Event Filtering</a></li>
<li><a href="#event-driven-architecture-patterns"
id="toc-event-driven-architecture-patterns">Event-Driven Architecture
Patterns</a></li>
<li><a href="#event-data-optimization"
id="toc-event-data-optimization">Event Data Optimization</a></li>
</ul></li>
<li><a href="#cross-contract-calls-building-composable-systems"
id="toc-cross-contract-calls-building-composable-systems">Cross-Contract
Calls: Building Composable Systems</a>
<ul>
<li><a href="#basic-cross-contract-call-pattern"
id="toc-basic-cross-contract-call-pattern">Basic Cross-Contract Call
Pattern</a></li>
<li><a href="#advanced-cross-contract-patterns"
id="toc-advanced-cross-contract-patterns">Advanced Cross-Contract
Patterns</a></li>
<li><a href="#security-considerations-for-cross-contract-calls"
id="toc-security-considerations-for-cross-contract-calls">Security
Considerations for Cross-Contract Calls</a></li>
<li><a href="#cross-contract-call-patterns-for-defi"
id="toc-cross-contract-call-patterns-for-defi">Cross-Contract Call
Patterns for DeFi</a></li>
</ul></li>
<li><a href="#testing-interoperability"
id="toc-testing-interoperability">Testing Interoperability</a></li>
<li><a href="#summary-4" id="toc-summary-4">Summary</a></li>
</ul></li>
<li><a href="#chapter-6-advanced-ink-patterns-and-techniques"
id="toc-chapter-6-advanced-ink-patterns-and-techniques">Chapter 6:
Advanced ink! Patterns and Techniques</a>
<ul>
<li><a href="#comprehensive-error-handling"
id="toc-comprehensive-error-handling">Comprehensive Error Handling</a>
<ul>
<li><a href="#structured-error-types"
id="toc-structured-error-types">Structured Error Types</a></li>
<li><a href="#error-context-and-propagation"
id="toc-error-context-and-propagation">Error Context and
Propagation</a></li>
<li><a href="#recovery-and-fallback-mechanisms"
id="toc-recovery-and-fallback-mechanisms">Recovery and Fallback
Mechanisms</a></li>
</ul></li>
<li><a href="#trait-based-contract-architecture"
id="toc-trait-based-contract-architecture">Trait-Based Contract
Architecture</a>
<ul>
<li><a href="#standard-interface-definitions"
id="toc-standard-interface-definitions">Standard Interface
Definitions</a></li>
<li><a href="#modular-contract-implementation"
id="toc-modular-contract-implementation">Modular Contract
Implementation</a></li>
<li><a href="#extensible-architecture-with-hooks"
id="toc-extensible-architecture-with-hooks">Extensible Architecture with
Hooks</a></li>
</ul></li>
<li><a href="#standard-library-usage-in-no_std"
id="toc-standard-library-usage-in-no_std">Standard Library Usage in
no_std</a></li>
<li><a href="#contract-upgradability"
id="toc-contract-upgradability">Contract Upgradability</a>
<ul>
<li><a href="#proxy-pattern-implementation"
id="toc-proxy-pattern-implementation">Proxy Pattern
Implementation</a></li>
<li><a href="#data-migration-strategies"
id="toc-data-migration-strategies">Data Migration Strategies</a></li>
</ul></li>
<li><a href="#summary-5" id="toc-summary-5">Summary</a></li>
</ul></li>
<li><a
href="#chapter-7-bulletproof-your-logic-comprehensive-contract-testing"
id="toc-chapter-7-bulletproof-your-logic-comprehensive-contract-testing">Chapter
7: Bulletproof Your Logic: Comprehensive Contract Testing</a>
<ul>
<li><a href="#the-testing-pyramid-for-smart-contracts"
id="toc-the-testing-pyramid-for-smart-contracts">The Testing Pyramid for
Smart Contracts</a>
<ul>
<li><a href="#testing-strategy-overview"
id="toc-testing-strategy-overview">Testing Strategy Overview</a></li>
</ul></li>
<li><a href="#unit-testing-the-foundation"
id="toc-unit-testing-the-foundation">Unit Testing: The Foundation</a>
<ul>
<li><a href="#basic-unit-test-structure"
id="toc-basic-unit-test-structure">Basic Unit Test Structure</a></li>
<li><a href="#advanced-unit-testing-patterns"
id="toc-advanced-unit-testing-patterns">Advanced Unit Testing
Patterns</a></li>
</ul></li>
<li><a href="#integration-testing-contract-interactions"
id="toc-integration-testing-contract-interactions">Integration Testing:
Contract Interactions</a>
<ul>
<li><a href="#testing-event-emission"
id="toc-testing-event-emission">Testing Event Emission</a></li>
<li><a href="#testing-cross-contract-interactions"
id="toc-testing-cross-contract-interactions">Testing Cross-Contract
Interactions</a></li>
</ul></li>
<li><a href="#end-to-end-testing-real-blockchain-interaction"
id="toc-end-to-end-testing-real-blockchain-interaction">End-to-End
Testing: Real Blockchain Interaction</a>
<ul>
<li><a href="#e2e-test-structure" id="toc-e2e-test-structure">E2E Test
Structure</a></li>
</ul></li>
<li><a href="#security-testing-finding-vulnerabilities"
id="toc-security-testing-finding-vulnerabilities">Security Testing:
Finding Vulnerabilities</a>
<ul>
<li><a href="#testing-access-controls"
id="toc-testing-access-controls">Testing Access Controls</a></li>
<li><a href="#fuzz-testing" id="toc-fuzz-testing">Fuzz Testing</a></li>
</ul></li>
<li><a href="#performance-and-gas-testing"
id="toc-performance-and-gas-testing">Performance and Gas Testing</a>
<ul>
<li><a href="#gas-consumption-testing"
id="toc-gas-consumption-testing">Gas Consumption Testing</a></li>
</ul></li>
<li><a href="#test-organization-and-cicd"
id="toc-test-organization-and-cicd">Test Organization and CI/CD</a>
<ul>
<li><a href="#test-configuration" id="toc-test-configuration">Test
Configuration</a></li>
<li><a href="#cicd-pipeline" id="toc-cicd-pipeline">CI/CD
Pipeline</a></li>
</ul></li>
<li><a href="#summary-6" id="toc-summary-6">Summary</a></li>
</ul></li>
<li><a href="#chapter-8-debugging-and-optimization"
id="toc-chapter-8-debugging-and-optimization">Chapter 8: Debugging and
Optimization</a>
<ul>
<li><a href="#debugging-techniques"
id="toc-debugging-techniques">Debugging Techniques</a>
<ul>
<li><a href="#using-debug_println-for-development"
id="toc-using-debug_println-for-development">Using debug_println! for
Development</a></li>
<li><a href="#gas-analysis-and-optimization"
id="toc-gas-analysis-and-optimization">Gas Analysis and
Optimization</a></li>
</ul></li>
<li><a href="#performance-optimization"
id="toc-performance-optimization">Performance Optimization</a>
<ul>
<li><a href="#storage-access-patterns"
id="toc-storage-access-patterns">Storage Access Patterns</a></li>
<li><a href="#gas-estimation-tools" id="toc-gas-estimation-tools">Gas
Estimation Tools</a></li>
</ul></li>
<li><a href="#common-performance-pitfalls"
id="toc-common-performance-pitfalls">Common Performance
Pitfalls</a></li>
<li><a href="#summary-7" id="toc-summary-7">Summary</a></li>
</ul></li>
<li><a
href="#chapter-9-from-localhost-to-live-deployment-and-interaction"
id="toc-chapter-9-from-localhost-to-live-deployment-and-interaction">Chapter
9: From Localhost to Live: Deployment and Interaction</a>
<ul>
<li><a href="#local-development-environment"
id="toc-local-development-environment">Local Development Environment</a>
<ul>
<li><a href="#setting-up-a-local-test-network"
id="toc-setting-up-a-local-test-network">Setting Up a Local Test
Network</a></li>
<li><a href="#contract-deployment-process"
id="toc-contract-deployment-process">Contract Deployment
Process</a></li>
</ul></li>
<li><a href="#using-contracts-ui" id="toc-using-contracts-ui">Using
Contracts UI</a>
<ul>
<li><a href="#ui-workflow-example" id="toc-ui-workflow-example">UI
Workflow Example</a></li>
</ul></li>
<li><a href="#production-deployment-considerations"
id="toc-production-deployment-considerations">Production Deployment
Considerations</a>
<ul>
<li><a href="#network-selection" id="toc-network-selection">Network
Selection</a></li>
<li><a href="#security-checklist-for-production"
id="toc-security-checklist-for-production">Security Checklist for
Production</a></li>
<li><a href="#deployment-script-example"
id="toc-deployment-script-example">Deployment Script Example</a></li>
</ul></li>
<li><a href="#contract-interaction-patterns"
id="toc-contract-interaction-patterns">Contract Interaction Patterns</a>
<ul>
<li><a href="#cli-interaction-examples"
id="toc-cli-interaction-examples">CLI Interaction Examples</a></li>
<li><a href="#javascripttypescript-integration"
id="toc-javascripttypescript-integration">JavaScript/TypeScript
Integration</a></li>
</ul></li>
<li><a href="#monitoring-and-maintenance"
id="toc-monitoring-and-maintenance">Monitoring and Maintenance</a>
<ul>
<li><a href="#event-monitoring" id="toc-event-monitoring">Event
Monitoring</a></li>
<li><a href="#health-checks" id="toc-health-checks">Health
Checks</a></li>
</ul></li>
<li><a href="#summary-8" id="toc-summary-8">Summary</a></li>
</ul></li>
<li><a
href="#chapter-10-capstone-project-building-a-decentralized-autonomous-organization-dao"
id="toc-chapter-10-capstone-project-building-a-decentralized-autonomous-organization-dao">Chapter
10: Capstone Project: Building a Decentralized Autonomous Organization
(DAO)</a>
<ul>
<li><a href="#dao-architecture-overview"
id="toc-dao-architecture-overview">DAO Architecture Overview</a></li>
<li><a href="#core-dao-contract-implementation"
id="toc-core-dao-contract-implementation">Core DAO Contract
Implementation</a></li>
<li><a href="#dao-usage-examples" id="toc-dao-usage-examples">DAO Usage
Examples</a>
<ul>
<li><a href="#deploying-and-setting-up-the-dao"
id="toc-deploying-and-setting-up-the-dao">Deploying and Setting Up the
DAO</a></li>
<li><a href="#interacting-with-the-dao"
id="toc-interacting-with-the-dao">Interacting with the DAO</a></li>
</ul></li>
<li><a href="#summary-9" id="toc-summary-9">Summary</a></li>
</ul></li>
<li><a href="#appendix-cheatsheets-and-further-resources"
id="toc-appendix-cheatsheets-and-further-resources">Appendix:
Cheatsheets and Further Resources</a>
<ul>
<li><a href="#cargo-contract-cheatsheet"
id="toc-cargo-contract-cheatsheet">cargo contract Cheatsheet</a>
<ul>
<li><a href="#project-management" id="toc-project-management">Project
Management</a></li>
<li><a href="#deployment-and-interaction"
id="toc-deployment-and-interaction">Deployment and Interaction</a></li>
<li><a href="#information-and-verification"
id="toc-information-and-verification">Information and
Verification</a></li>
</ul></li>
<li><a href="#self.env-reference" id="toc-self.env-reference">self.env()
Reference</a>
<ul>
<li><a href="#account-information" id="toc-account-information">Account
Information</a></li>
<li><a href="#block-information" id="toc-block-information">Block
Information</a></li>
<li><a href="#transaction-operations"
id="toc-transaction-operations">Transaction Operations</a></li>
<li><a href="#gas-and-weight" id="toc-gas-and-weight">Gas and
Weight</a></li>
</ul></li>
<li><a href="#common-patterns-quick-reference"
id="toc-common-patterns-quick-reference">Common Patterns Quick
Reference</a>
<ul>
<li><a href="#storage-patterns" id="toc-storage-patterns">Storage
Patterns</a></li>
<li><a href="#error-handling" id="toc-error-handling">Error
Handling</a></li>
<li><a href="#event-patterns" id="toc-event-patterns">Event
Patterns</a></li>
<li><a href="#access-control" id="toc-access-control">Access
Control</a></li>
<li><a href="#cross-contract-calls"
id="toc-cross-contract-calls">Cross-Contract Calls</a></li>
</ul></li>
<li><a href="#testing-patterns" id="toc-testing-patterns">Testing
Patterns</a>
<ul>
<li><a href="#unit-test-setup" id="toc-unit-test-setup">Unit Test
Setup</a></li>
<li><a href="#e2e-test-setup" id="toc-e2e-test-setup">E2E Test
Setup</a></li>
</ul></li>
<li><a href="#build-configuration" id="toc-build-configuration">Build
Configuration</a>
<ul>
<li><a href="#cargo.toml-template"
id="toc-cargo.toml-template">Cargo.toml Template</a></li>
<li><a href="#optimization-settings"
id="toc-optimization-settings">Optimization Settings</a></li>
</ul></li>
<li><a href="#network-endpoints" id="toc-network-endpoints">Network
Endpoints</a>
<ul>
<li><a href="#testnet-endpoints" id="toc-testnet-endpoints">Testnet
Endpoints</a></li>
<li><a href="#development-tools" id="toc-development-tools">Development
Tools</a></li>
</ul></li>
<li><a href="#common-error-solutions"
id="toc-common-error-solutions">Common Error Solutions</a>
<ul>
<li><a href="#compilation-errors"
id="toc-compilation-errors">Compilation Errors</a></li>
<li><a href="#runtime-errors" id="toc-runtime-errors">Runtime
Errors</a></li>
</ul></li>
<li><a href="#further-resources" id="toc-further-resources">Further
Resources</a>
<ul>
<li><a href="#official-documentation"
id="toc-official-documentation">Official Documentation</a></li>
<li><a href="#community-resources"
id="toc-community-resources">Community Resources</a></li>
<li><a href="#educational-content"
id="toc-educational-content">Educational Content</a></li>
<li><a href="#development-tools-1"
id="toc-development-tools-1">Development Tools</a></li>
<li><a href="#security-resources" id="toc-security-resources">Security
Resources</a></li>
</ul></li>
<li><a href="#about-this-book" id="toc-about-this-book">About This
Book</a>
<ul>
<li><a href="#technical-specifications"
id="toc-technical-specifications">Technical Specifications</a></li>
<li><a href="#contributing" id="toc-contributing">Contributing</a></li>
<li><a href="#license" id="toc-license">License</a></li>
</ul></li>
</ul></li>
</ul>
</nav>
<h1
id="mastering-ink-building-production-ready-smart-contracts">Mastering
ink!: Building Production-Ready Smart Contracts</h1>
<p><strong>A Comprehensive Technical Guide</strong></p>
<p><em>For developers who want to build sophisticated smart contracts
using ink! on polkadot-sdk</em></p>
<hr />
<p><strong>Prerequisites:</strong> Intermediate Rust proficiency and
basic blockchain knowledge<br />
<strong>Target Audience:</strong> Rust developers, blockchain
developers, smart contract architects<br />
<strong>Publication Date:</strong> 2024</p>
<hr />
<h2 id="table-of-contents">Table of Contents</h2>
<ul>
<li><strong>Preface</strong>: Who This Book Is For</li>
<li><strong>Chapter 1</strong>: The ink! Paradigm: Rust on the
Blockchain</li>
<li><strong>Chapter 2</strong>: Anatomy of an ink! Contract: Your First
Build</li>
<li><strong>Chapter 3</strong>: Deep Dive into State: Managing Contract
Storage</li>
<li><strong>Chapter 4</strong>: The Logic Layer: Messages and
Constructors</li>
<li><strong>Chapter 5</strong>: Interoperability: Events and
Cross-Contract Calls</li>
<li><strong>Chapter 6</strong>: Advanced ink! Patterns and
Techniques</li>
<li><strong>Chapter 7</strong>: Bulletproof Your Logic: Comprehensive
Contract Testing</li>
<li><strong>Chapter 8</strong>: Debugging and Optimization</li>
<li><strong>Chapter 9</strong>: From Localhost to Live: Deployment and
Interaction</li>
<li><strong>Chapter 10</strong>: Capstone Project: Building a
Decentralized Autonomous Organization (DAO)</li>
<li><strong>Appendix</strong>: Cheatsheets and Further Resources</li>
</ul>
<hr />
<hr />
<h1 id="preface-who-this-book-is-for">Preface: Who This Book Is For</h1>
<p>Welcome to <strong>Mastering ink! Building Production-Ready Smart
Contracts</strong>. This book is your comprehensive guide to becoming
proficient in ink!, the Rust-based embedded domain-specific language
(eDSL) for writing smart contracts that run on polkadot-sdk-based
blockchains, including the Polkadot ecosystem.</p>
<h2 id="what-is-ink">What is ink!?</h2>
<p>ink! is a Rust-based eDSL specifically designed for writing smart
contracts that compile to WebAssembly (Wasm) and execute on
polkadot-sdk’s <code>pallet-contracts</code>. Unlike other smart
contract languages, ink! leverages Rust’s powerful type system, memory
safety guarantees, and growing ecosystem to provide developers with a
robust foundation for building secure, efficient smart contracts.</p>
<p>ink! contracts benefit from: - <strong>Memory Safety</strong>: Rust’s
ownership system prevents common vulnerabilities like buffer overflows -
<strong>Type Safety</strong>: Compile-time guarantees that reduce
runtime errors - <strong>Performance</strong>: WebAssembly compilation
provides near-native execution speeds - <strong>Ecosystem</strong>:
Access to Rust’s rich crate ecosystem (with some limitations in the
<code>no_std</code> environment)</p>
<h2 id="the-goal-of-this-book">The Goal of This Book</h2>
<p>This book will take you from having zero knowledge of ink! to being
able to architect, implement, test, and deploy sophisticated smart
contracts in production environments. You’ll learn not just the syntax
and features of ink!, but also the patterns, best practices, and
advanced techniques that separate hobbyist code from production-ready
smart contracts.</p>
<p>By the end of this book, you will be able to:</p>
<ul>
<li>Design and implement complex smart contract architectures using
ink!</li>
<li>Leverage advanced ink! features like cross-contract calls, events,
and upgradeable contracts</li>
<li>Write comprehensive test suites that ensure contract
correctness</li>
<li>Debug and optimize contracts for gas efficiency and performance</li>
<li>Deploy and interact with contracts on both local and live
networks</li>
<li>Build a complete decentralized autonomous organization (DAO) from
scratch</li>
</ul>
<h2 id="prerequisites">Prerequisites</h2>
<p>This book assumes you already possess certain foundational knowledge.
We will <strong>not</strong> cover:</p>
<h3 id="blockchain-fundamentals">Blockchain Fundamentals</h3>
<p>You should already understand: - What blockchains are and how they
work - The concept of transactions, blocks, and state - Basic consensus
mechanisms - What smart contracts are and their role in blockchain
ecosystems - Gas/fee concepts</p>
<h3 id="rust-programming-language">Rust Programming Language</h3>
<p>You must have <strong>intermediate</strong> proficiency with Rust,
including: - <strong>Ownership and Borrowing</strong>: Understanding
<code>move</code>, <code>&amp;</code>, <code>&amp;mut</code>, and
lifetime annotations - <strong>Traits</strong>: Defining and
implementing traits, trait bounds, and associated types - <strong>Error
Handling</strong>: Using <code>Result&lt;T, E&gt;</code> and
<code>Option&lt;T&gt;</code> effectively - <strong>Pattern
Matching</strong>: Advanced <code>match</code> expressions and
destructuring - <strong>Generics</strong>: Writing and using generic
functions and structs - <strong>Modules and Crates</strong>: Organizing
code with <code>mod</code>, <code>use</code>, and understanding
<code>Cargo.toml</code> - <strong>Standard Collections</strong>: Working
with <code>Vec</code>, <code>HashMap</code>, <code>BTreeMap</code>, etc.
- <strong>Async Programming</strong>: Basic understanding of
<code>async</code>/<code>await</code> (for testing)</p>
<p>If you need to brush up on any Rust concepts, we recommend “The Rust
Programming Language” (the official Rust book) or “Programming Rust” by
Jim Blandy and Jason Orendorff.</p>
<h3 id="development-environment">Development Environment</h3>
<p>You should be comfortable with: - Command-line interfaces and
terminal usage - Git version control basics - Basic JSON understanding
(for metadata and configuration files)</p>
<h2 id="what-this-book-covers">What This Book Covers</h2>
<h3 id="structure-overview">Structure Overview</h3>
<p><strong>Chapters 1-2</strong> establish the foundation: understanding
why ink! exists, setting up your development environment, and building
your first contract.</p>
<p><strong>Chapters 3-5</strong> dive deep into the core concepts: state
management, contract logic, and interoperability patterns.</p>
<p><strong>Chapters 6-8</strong> cover advanced topics: sophisticated
design patterns, comprehensive testing strategies, and
debugging/optimization techniques.</p>
<p><strong>Chapters 9-10</strong> focus on real-world deployment: going
from localhost to production, and building a complete DAO project that
synthesizes everything you’ve learned.</p>
<p><strong>The Appendix</strong> provides quick reference materials for
ongoing development.</p>
<h3 id="code-standards">Code Standards</h3>
<p>All code examples in this book: - Use the latest stable version of
ink! (6.x series at time of writing) - Follow Rust community style
guidelines (<code>rustfmt</code> compatible) - Are complete and runnable
(not pseudocode) - Include comprehensive comments explaining non-obvious
logic - Use the primary toolchain: <code>cargo contract</code></p>
<h3 id="mathematical-notation">Mathematical Notation</h3>
<p>When discussing algorithmic complexity or formal concepts, we use
LaTeX notation: - <span
class="math inline"><em>O</em>(<em>n</em>)</span> for Big O complexity
analysis - <span class="math inline">ℕ</span> for natural numbers in
formal definitions - Mathematical expressions inline with <span
class="math inline"><em>x</em> = <em>y</em> + <em>z</em></span>
format</p>
<h2 id="who-should-read-this-book">Who Should Read This Book</h2>
<h3 id="primary-audience">Primary Audience</h3>
<ul>
<li><strong>Rust developers</strong> looking to enter the blockchain
space</li>
<li><strong>Blockchain developers</strong> with Solidity experience
wanting to learn ink!</li>
<li><strong>polkadot-sdk developers</strong> who need to add smart
contract capabilities</li>
<li><strong>Security researchers</strong> analyzing ink! contract
patterns</li>
</ul>
<h3 id="secondary-audience">Secondary Audience</h3>
<ul>
<li><strong>Technical architects</strong> evaluating ink! for enterprise
projects</li>
<li><strong>DevOps engineers</strong> responsible for deploying
polkadot-sdk-based systems</li>
<li><strong>Academic researchers</strong> studying smart contract
languages</li>
</ul>
<h2 id="who-should-not-read-this-book">Who Should NOT Read This
Book</h2>
<p>This book is <strong>not</strong> suitable for: - Complete
programming beginners - Developers unfamiliar with Rust’s ownership
model - Those seeking an introduction to blockchain concepts -
Developers looking for visual/GUI-based development tools</p>
<h2 id="how-to-use-this-book">How to Use This Book</h2>
<h3 id="linear-reading">Linear Reading</h3>
<p>The chapters build upon each other, so we recommend reading
sequentially on your first pass.</p>
<h3 id="reference-usage">Reference Usage</h3>
<p>After your initial read-through, the book serves as a reference. Each
chapter is self-contained enough for targeted consultation.</p>
<h3 id="hands-on-approach">Hands-On Approach</h3>
<p>This book is highly practical. Have your development environment
ready and execute every code example. The knowledge will only solidify
through practice.</p>
<h3 id="community-engagement">Community Engagement</h3>
<p>Join the ink! community: - <strong>Element Chat</strong>: <a
href="https://matrix.to/#/#ink:matrix.parity.io">ink! channel</a> -
<strong>Stack Overflow</strong>: Use the <code>ink!</code> and
<code>polkadot-sdk</code> tags - <strong>GitHub</strong>: <a
href="https://github.com/paritytech/ink">ink! repository</a> for issues
and discussions</p>
<h2 id="acknowledgments">Acknowledgments</h2>
<p>This book builds upon the excellent work of the Parity Technologies
team and the broader polkadot-sdk/Polkadot ecosystem. Special
recognition goes to the ink! core developers who have created
comprehensive documentation and examples that make this technology
accessible.</p>
<p>The patterns and best practices presented here have been refined
through real-world usage across numerous production deployments and
extensive community feedback.</p>
<hr />
<p>Ready to master ink!? Let’s begin with understanding the paradigm
that makes ink! unique in the smart contract landscape.</p>
<hr />
<h1 id="chapter-1-the-ink-paradigm-rust-on-the-blockchain">Chapter 1:
The ink! Paradigm: Rust on the Blockchain</h1>
<p>ink! is a domain-specific language (DSL) embedded in Rust, designed
specifically for writing smart contracts that compile to WebAssembly
(Wasm). It leverages Rust’s renowned safety features—such as type
safety, memory safety, and absence of undefined behaviors—to create
secure and efficient smart contracts for blockchains built on the
polkadot-sdk framework, including ecosystems like Polkadot and
Kusama.</p>
<p>When you first sit down to write a smart contract that will move real
value and coordinate real people, you discover that language is not just
syntax and semantics, but a shape that a system grows into. ink! is such
a language: pragmatic because it is Rust, safe because it borrows Rust’s
strict guarantees, fast because it compiles to Wasm, and open to
composition because it lives inside polkadot-sdk’s contracts pallet.
This book is a long walk through the craft of building production-ready
contracts with ink!. We will code, of course, but more importantly we
will learn how to think in ink!: how to choose data structures that the
chain can love, how to shape interfaces that people and programs can
trust, and how to ship software that can bear the weight of other
people’s money.</p>
<p>ink! is ideal for developers familiar with blockchain concepts (e.g.,
smart contracts, gas fees, state management) who want to build on
polkadot-sdk-based networks. It targets parachains like Aleph Zero,
Phala, or Astar, where smart contracts run in a Wasm environment via the
pallet-contracts module. For examples and further reading, explore the
official GitHub repository for ink! examples, which includes basic
contracts like flipper (a simple state toggler), ERC20 (token standard),
ERC721 (NFTs), and incrementer (counter demo).</p>
<p>These demonstrate core features such as state management, events, and
cross-contract calls.This book will guide you through fundamentals,
writing contracts, testing, debugging, and deployment, assuming basic
blockchain knowledge.</p>
<h2 id="understanding-the-blockchain-foundation">Understanding the
Blockchain Foundation</h2>
<p>A blockchain is a ledger in the open—blocks stacked in time, each one
linked by a cryptographic hash to the one before it, so that to change
yesterday you would have to break today. There is comfort in that: a
public memory that resists forgetting. On such a ledger, a smart
contract is a promise written as code. Instead of a human arbiter there
is a virtual machine; instead of a notary there is consensus; instead of
signatures there are transactions; instead of trust there is
determinism. If the conditions are satisfied, the program executes; if
they are not, the program refuses. No midnight renegotiations. No
partial truths. Just state transitions anyone can verify. The result is
programmable money, programmable organizations, programmable
markets—systems that are transparent because they cannot lie, and
accountable because they cannot hide.</p>
<p>Before diving into ink! development, let’s establish the foundational
concepts that make smart contracts possible and understand why they
represent a revolutionary approach to building decentralized
applications.</p>
<h3 id="what-is-a-blockchain">What is a Blockchain?</h3>
<p>A blockchain is a distributed ledger technology that maintains a
continuously growing list of records (blocks) that are linked and
secured using cryptography. Each block contains:</p>
<ul>
<li><strong>A cryptographic hash</strong> of the previous block</li>
<li><strong>A timestamp</strong> indicating when the block was
created</li>
<li><strong>Transaction data</strong> representing state changes in the
system</li>
</ul>
<p>This structure creates an immutable chain where altering any
historical record would require recomputing all subsequent blocks—a
computationally infeasible task in a properly designed system.</p>
<p><strong>Key Properties of Blockchains:</strong></p>
<ol type="1">
<li><strong>Decentralization</strong>: No single point of control or
failure</li>
<li><strong>Immutability</strong>: Historical records cannot be altered
without detection</li>
<li><strong>Transparency</strong>: All transactions are publicly
verifiable</li>
<li><strong>Consensus</strong>: Network participants agree on the
current state through consensus mechanisms</li>
<li><strong>Trustlessness</strong>: Participants don’t need to trust
each other, only the protocol</li>
</ol>
<h3 id="the-evolution-from-simple-transfers-to-smart-contracts">The
Evolution from Simple Transfers to Smart Contracts</h3>
<p>Early blockchains like Bitcoin primarily handled simple value
transfers: Alice sends X coins to Bob. While revolutionary, this model
was limited to basic financial transactions.</p>
<p><strong>The Smart Contract Revolution:</strong></p>
<p>Smart contracts extend blockchain capabilities by enabling
<strong>programmable money</strong> and <strong>decentralized
applications (dApps)</strong>. Instead of just transferring value,
participants can:</p>
<ul>
<li>Lock funds in escrow with automatic release conditions</li>
<li>Create complex financial instruments (loans, derivatives,
insurance)</li>
<li>Build decentralized governance systems</li>
<li>Implement supply chain tracking and verification</li>
<li>Create non-fungible tokens (NFTs) and digital collectibles</li>
</ul>
<h3 id="what-are-smart-contracts">What Are Smart Contracts?</h3>
<p>A smart contract is <strong>self-executing code</strong> deployed on
a blockchain that automatically enforces the terms of an agreement.
Think of it as a vending machine for digital assets:</p>
<ol type="1">
<li><strong>Deposit conditions are met</strong> (correct payment, valid
inputs)</li>
<li><strong>Contract logic executes</strong> (verification,
calculations, state changes)</li>
<li><strong>Outcomes are automatically enforced</strong> (assets
transferred, events emitted)</li>
</ol>
<p>But smart contracts also need a home, an execution environment that
enforces limits and fairness. Some communities choose the EVM and its
battle-scarred, hand‑crafted bytecode. We choose WebAssembly: a compact,
fast, and portable instruction format with real compilers and real
tooling, and we choose Rust to reach it, because in Rust the programmer
must make memory safe by design—no nulls, no data races, no silent
integer overflows unless you ask for them on purpose. That is the ethos
ink! brings to polkadot-sdk’s world: write contracts as normal Rust
modules, with a few macros to reveal your storage and messages, compile
to Wasm, and let <code>pallet-contracts</code> host your logic on
chain.</p>
<p><strong>Key Characteristics:</strong></p>
<ul>
<li><strong>Deterministic</strong>: Same inputs always produce same
outputs</li>
<li><strong>Immutable</strong>: Code cannot be changed once deployed
(unless designed with upgrade mechanisms)</li>
<li><strong>Transparent</strong>: Code and execution are publicly
verifiable</li>
<li><strong>Autonomous</strong>: Execute without human intervention</li>
<li><strong>Tamper-proof</strong>: Protected by blockchain’s
cryptographic security</li>
</ul>
<h3 id="smart-contract-use-cases">Smart Contract Use Cases</h3>
<p><strong>Financial Services (DeFi):</strong> - Decentralized exchanges
(DEXs) for trading without intermediaries - Lending protocols that
automatically manage collateral and interest - Yield farming and
liquidity mining programs - Algorithmic stablecoins with automatic
supply adjustments</p>
<p><strong>Digital Identity and Governance:</strong> - Decentralized
Autonomous Organizations (DAOs) with voting mechanisms - Identity
verification systems without central authorities - Reputation systems
based on verifiable on-chain activity</p>
<p><strong>Supply Chain and Real-World Assets:</strong> - Tracking
products from manufacture to consumer - Carbon credit trading and
environmental monitoring - Real estate tokenization and fractional
ownership - Insurance claims processing with automated payouts</p>
<h3 id="the-technical-challenge-execution-environments">The Technical
Challenge: Execution Environments</h3>
<p>Smart contracts need a <strong>virtual machine</strong> that can:</p>
<ol type="1">
<li><strong>Execute code deterministically</strong> across all network
nodes</li>
<li><strong>Meter resource usage</strong> to prevent infinite loops and
denial-of-service attacks</li>
<li><strong>Manage state</strong> persistently between contract
calls</li>
<li><strong>Handle failures gracefully</strong> without corrupting
blockchain state</li>
</ol>
<p>Different blockchain platforms have approached this challenge in
various ways:</p>
<ul>
<li><strong>Ethereum Virtual Machine (EVM)</strong>: Stack-based virtual
machine with gas metering</li>
<li><strong>WebAssembly (Wasm)</strong>: Near-native performance with
sandboxed execution</li>
<li><strong>Move Virtual Machine</strong>: Resource-oriented programming
with formal verification</li>
</ul>
<h2 id="the-smart-contract-development-landscape">The Smart Contract
Development Landscape</h2>
<p>Smart contracts have revolutionized how we think about decentralized
applications, but most existing solutions come with significant
trade-offs. Let’s examine the current landscape:</p>
<h3 id="current-platforms-and-their-limitations">Current Platforms and
Their Limitations</h3>
<p><strong>Ethereum and Solidity:</strong> - <strong>Pros</strong>:
Mature ecosystem, extensive tooling, large developer community -
<strong>Cons</strong>: High gas costs, limited throughput, memory safety
vulnerabilities - <strong>Key Issue</strong>: Solidity lacks
compile-time safety guarantees that prevent entire classes of bugs</p>
<p><strong>Cosmos and CosmWasm:</strong> - <strong>Pros</strong>:
Inter-blockchain communication, modular architecture -
<strong>Cons</strong>: Smaller ecosystem, Go/Rust context switching
complexity - <strong>Key Issue</strong>: Complex multi-language
development environment</p>
<p><strong>Aptos/Sui and Move:</strong> - <strong>Pros</strong>:
Resource-oriented programming, formal verification capabilities -
<strong>Cons</strong>: Completely new paradigm, limited ecosystem
maturity - <strong>Key Issue</strong>: Requires learning fundamentally
different programming concepts</p>
<h3 id="enter-ink-the-rust-advantage">Enter ink!: The Rust
Advantage</h3>
<p>ink! takes a different approach: it leverages the mature,
battle-tested Rust ecosystem to bring memory safety, type safety, and
performance to smart contract development. Rather than inventing new
paradigms, ink! builds upon established Rust patterns that developers
already know and trust.</p>
<p><strong>Why This Matters:</strong></p>
<ol type="1">
<li><strong>Existing Expertise</strong>: Rust developers can apply their
knowledge directly</li>
<li><strong>Proven Patterns</strong>: Leverage established error
handling, testing, and architectural patterns</li>
<li><strong>Ecosystem Access</strong>: Use (compatible) crates from the
broader Rust ecosystem</li>
<li><strong>Tool Maturity</strong>: Benefit from Rust’s excellent
tooling and IDE support</li>
</ol>
<p>In this chapter, we’ll explore why ink! represents a paradigm shift
in smart contract development, how it compares to existing solutions,
and where it fits within the broader polkadot-sdk ecosystem. We’ll then
set up a complete development environment so you’re ready to start
building.</p>
<h2 id="why-ink-the-rust-advantage">Why ink!? The Rust Advantage</h2>
<h3 id="memory-safety-without-garbage-collection">Memory Safety Without
Garbage Collection</h3>
<p>Traditional smart contract platforms either sacrifice memory safety
(C++) or rely on garbage collection (Ethereum’s EVM, which impacts gas
costs). Rust’s ownership system provides memory safety guarantees at
compile time without runtime overhead.</p>
<p>Consider this common vulnerability in C-style languages:</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="co">// Potential buffer overflow</span></span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="dt">char</span> buffer<span class="op">[</span><span class="dv">100</span><span class="op">];</span></span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a>strcpy<span class="op">(</span>buffer<span class="op">,</span> user_input<span class="op">);</span> <span class="co">// No bounds checking!</span></span></code></pre></div>
<p>In Rust, this simply cannot compile:</p>
<div class="sourceCode" id="cb2"><pre
class="sourceCode rust"><code class="sourceCode rust"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="co">// This won&#39;t compile - Rust prevents buffer overflows at compile time</span></span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a><span class="kw">let</span> <span class="kw">mut</span> buffer <span class="op">=</span> [<span class="dv">0u8</span><span class="op">;</span> <span class="dv">100</span>]<span class="op">;</span></span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a><span class="kw">let</span> user_input<span class="op">:</span> <span class="op">&amp;</span>[<span class="dt">u8</span>] <span class="op">=</span> get_user_input()<span class="op">;</span></span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a>buffer[<span class="op">..</span>user_input<span class="op">.</span>len()]<span class="op">.</span>copy_from_slice(user_input)<span class="op">;</span> <span class="co">// Bounds checked</span></span></code></pre></div>
<p>This compile-time safety extends to smart contracts. Memory-related
vulnerabilities that have caused millions in losses on other platforms
are prevented by design in ink!.</p>
<h3 id="zero-cost-abstractions">Zero-Cost Abstractions</h3>
<p>Rust’s “zero-cost abstractions” philosophy means that high-level code
constructs compile down to the same efficiency as hand-optimized
low-level code. In the context of smart contracts, this translates
directly to gas efficiency.</p>
<div class="sourceCode" id="cb3"><pre
class="sourceCode rust"><code class="sourceCode rust"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="co">// High-level iterator chain</span></span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a><span class="kw">let</span> result<span class="op">:</span> <span class="dt">u32</span> <span class="op">=</span> numbers</span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a>    <span class="op">.</span>iter()</span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true" tabindex="-1"></a>    <span class="op">.</span>filter(<span class="op">|&amp;</span>x<span class="op">|</span> x <span class="op">%</span> <span class="dv">2</span> <span class="op">==</span> <span class="dv">0</span>)</span>
<span id="cb3-5"><a href="#cb3-5" aria-hidden="true" tabindex="-1"></a>    <span class="op">.</span>map(<span class="op">|&amp;</span>x<span class="op">|</span> x <span class="op">*</span> x)</span>
<span id="cb3-6"><a href="#cb3-6" aria-hidden="true" tabindex="-1"></a>    <span class="op">.</span>sum()<span class="op">;</span></span>
<span id="cb3-7"><a href="#cb3-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-8"><a href="#cb3-8" aria-hidden="true" tabindex="-1"></a><span class="co">// Compiles to the same efficiency as:</span></span>
<span id="cb3-9"><a href="#cb3-9" aria-hidden="true" tabindex="-1"></a><span class="kw">let</span> <span class="kw">mut</span> result <span class="op">=</span> <span class="dv">0u32</span><span class="op">;</span></span>
<span id="cb3-10"><a href="#cb3-10" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> number <span class="kw">in</span> numbers <span class="op">{</span></span>
<span id="cb3-11"><a href="#cb3-11" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> number <span class="op">%</span> <span class="dv">2</span> <span class="op">==</span> <span class="dv">0</span> <span class="op">{</span></span>
<span id="cb3-12"><a href="#cb3-12" aria-hidden="true" tabindex="-1"></a>        result <span class="op">+=</span> number <span class="op">*</span> number<span class="op">;</span></span>
<span id="cb3-13"><a href="#cb3-13" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb3-14"><a href="#cb3-14" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<h3 id="type-system-guarantees">Type System Guarantees</h3>
<p>Rust’s type system prevents entire categories of bugs that are common
in smart contracts:</p>
<div class="sourceCode" id="cb4"><pre
class="sourceCode rust"><code class="sourceCode rust"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="co">// This won&#39;t compile - prevents integer overflow vulnerabilities</span></span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a><span class="kw">fn</span> transfer(amount<span class="op">:</span> <span class="dt">u128</span>) <span class="op">-&gt;</span> <span class="dt">Result</span><span class="op">&lt;</span>()<span class="op">,</span> <span class="bu">Error</span><span class="op">&gt;</span> <span class="op">{</span></span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a>    <span class="kw">let</span> new_balance <span class="op">=</span> <span class="kw">self</span><span class="op">.</span>balance <span class="op">+</span> amount<span class="op">;</span> <span class="co">// Compiler error if overflow possible</span></span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Must use checked_add, saturating_add, or wrapping_add</span></span>
<span id="cb4-5"><a href="#cb4-5" aria-hidden="true" tabindex="-1"></a>    <span class="cn">Ok</span>(())</span>
<span id="cb4-6"><a href="#cb4-6" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb4-7"><a href="#cb4-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-8"><a href="#cb4-8" aria-hidden="true" tabindex="-1"></a><span class="co">// Correct approach</span></span>
<span id="cb4-9"><a href="#cb4-9" aria-hidden="true" tabindex="-1"></a><span class="kw">fn</span> transfer(amount<span class="op">:</span> <span class="dt">u128</span>) <span class="op">-&gt;</span> <span class="dt">Result</span><span class="op">&lt;</span>()<span class="op">,</span> <span class="bu">Error</span><span class="op">&gt;</span> <span class="op">{</span></span>
<span id="cb4-10"><a href="#cb4-10" aria-hidden="true" tabindex="-1"></a>    <span class="kw">let</span> new_balance <span class="op">=</span> <span class="kw">self</span><span class="op">.</span>balance</span>
<span id="cb4-11"><a href="#cb4-11" aria-hidden="true" tabindex="-1"></a>        <span class="op">.</span>checked_add(amount)</span>
<span id="cb4-12"><a href="#cb4-12" aria-hidden="true" tabindex="-1"></a>        <span class="op">.</span>ok_or(<span class="bu">Error</span><span class="pp">::</span>ArithmeticOverflow)<span class="op">?;</span></span>
<span id="cb4-13"><a href="#cb4-13" aria-hidden="true" tabindex="-1"></a>    <span class="kw">self</span><span class="op">.</span>balance <span class="op">=</span> new_balance<span class="op">;</span></span>
<span id="cb4-14"><a href="#cb4-14" aria-hidden="true" tabindex="-1"></a>    <span class="cn">Ok</span>(())</span>
<span id="cb4-15"><a href="#cb4-15" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<h3 id="ecosystem-maturity">Ecosystem Maturity</h3>
<p>Rust has a mature ecosystem with crates.io hosting over 100,000
packages. While ink! contracts run in a <code>no_std</code> environment
(limiting available crates), you still have access to:</p>
<ul>
<li><strong>Cryptographic libraries</strong>: <code>sp-crypto</code>,
<code>secp256k1</code>, etc.</li>
<li><strong>Data structures</strong>: <code>BTreeMap</code>,
<code>BTreeSet</code> from <code>alloc</code></li>
<li><strong>Serialization</strong>: <code>scale-codec</code> for
efficient encoding</li>
<li><strong>Mathematical operations</strong>: Fixed-point arithmetic
libraries</li>
</ul>
<h2 id="ink-vs.-solidity-a-technical-comparison">ink! vs. Solidity: A
Technical Comparison</h2>
<p>Let’s examine the fundamental differences through equivalent contract
implementations:</p>
<h3 id="solidity-erc-20-token-simplified">Solidity ERC-20 Token
(Simplified)</h3>
<div class="sourceCode" id="cb5"><pre
class="sourceCode javascript"><code class="sourceCode javascript"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a>pragma solidity <span class="op">^</span><span class="fl">0.8.0</span><span class="op">;</span></span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a>contract SimpleToken {</span>
<span id="cb5-4"><a href="#cb5-4" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mapping</span>(address <span class="kw">=&gt;</span> uint256) <span class="kw">private</span> balances<span class="op">;</span></span>
<span id="cb5-5"><a href="#cb5-5" aria-hidden="true" tabindex="-1"></a>    uint256 <span class="kw">private</span> totalSupply<span class="op">;</span></span>
<span id="cb5-6"><a href="#cb5-6" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb5-7"><a href="#cb5-7" aria-hidden="true" tabindex="-1"></a>    <span class="fu">constructor</span>(uint256 _totalSupply) {</span>
<span id="cb5-8"><a href="#cb5-8" aria-hidden="true" tabindex="-1"></a>        totalSupply <span class="op">=</span> _totalSupply<span class="op">;</span></span>
<span id="cb5-9"><a href="#cb5-9" aria-hidden="true" tabindex="-1"></a>        balances[msg<span class="op">.</span><span class="at">sender</span>] <span class="op">=</span> _totalSupply<span class="op">;</span></span>
<span id="cb5-10"><a href="#cb5-10" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb5-11"><a href="#cb5-11" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb5-12"><a href="#cb5-12" aria-hidden="true" tabindex="-1"></a>    <span class="kw">function</span> <span class="fu">transfer</span>(address to<span class="op">,</span> uint256 amount) <span class="kw">public</span> <span class="fu">returns</span> (bool) {</span>
<span id="cb5-13"><a href="#cb5-13" aria-hidden="true" tabindex="-1"></a>        <span class="pp">require</span>(balances[msg<span class="op">.</span><span class="at">sender</span>] <span class="op">&gt;=</span> amount<span class="op">,</span> <span class="st">&quot;Insufficient balance&quot;</span>)<span class="op">;</span></span>
<span id="cb5-14"><a href="#cb5-14" aria-hidden="true" tabindex="-1"></a>        balances[msg<span class="op">.</span><span class="at">sender</span>] <span class="op">-=</span> amount<span class="op">;</span></span>
<span id="cb5-15"><a href="#cb5-15" aria-hidden="true" tabindex="-1"></a>        balances[to] <span class="op">+=</span> amount<span class="op">;</span></span>
<span id="cb5-16"><a href="#cb5-16" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="kw">true</span><span class="op">;</span></span>
<span id="cb5-17"><a href="#cb5-17" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb5-18"><a href="#cb5-18" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb5-19"><a href="#cb5-19" aria-hidden="true" tabindex="-1"></a>    <span class="kw">function</span> <span class="fu">balanceOf</span>(address account) <span class="kw">public</span> view <span class="fu">returns</span> (uint256) {</span>
<span id="cb5-20"><a href="#cb5-20" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> balances[account]<span class="op">;</span></span>
<span id="cb5-21"><a href="#cb5-21" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb5-22"><a href="#cb5-22" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<h3 id="ink-erc-20-token-simplified">ink! ERC-20 Token (Simplified)</h3>
<div class="sourceCode" id="cb6"><pre
class="sourceCode rust"><code class="sourceCode rust"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a><span class="at">#![</span>cfg_attr<span class="at">(</span>not<span class="at">(</span>feature <span class="op">=</span> <span class="st">&quot;std&quot;</span><span class="at">)</span><span class="op">,</span> no_std<span class="at">)]</span></span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a><span class="at">#[</span><span class="pp">ink::</span>contract<span class="at">]</span></span>
<span id="cb6-4"><a href="#cb6-4" aria-hidden="true" tabindex="-1"></a><span class="kw">mod</span> simple_token <span class="op">{</span></span>
<span id="cb6-5"><a href="#cb6-5" aria-hidden="true" tabindex="-1"></a>    <span class="kw">use</span> <span class="pp">ink::storage::</span>Mapping<span class="op">;</span></span>
<span id="cb6-6"><a href="#cb6-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-7"><a href="#cb6-7" aria-hidden="true" tabindex="-1"></a>    <span class="at">#[</span>ink<span class="at">(</span>storage<span class="at">)]</span></span>
<span id="cb6-8"><a href="#cb6-8" aria-hidden="true" tabindex="-1"></a>    <span class="kw">pub</span> <span class="kw">struct</span> SimpleToken <span class="op">{</span></span>
<span id="cb6-9"><a href="#cb6-9" aria-hidden="true" tabindex="-1"></a>        total_supply<span class="op">:</span> Balance<span class="op">,</span></span>
<span id="cb6-10"><a href="#cb6-10" aria-hidden="true" tabindex="-1"></a>        balances<span class="op">:</span> Mapping<span class="op">&lt;</span>AccountId<span class="op">,</span> Balance<span class="op">&gt;,</span></span>
<span id="cb6-11"><a href="#cb6-11" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb6-12"><a href="#cb6-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-13"><a href="#cb6-13" aria-hidden="true" tabindex="-1"></a>    <span class="at">#[</span>derive<span class="at">(</span><span class="bu">Debug</span><span class="op">,</span> <span class="bu">PartialEq</span><span class="op">,</span> <span class="bu">Eq</span><span class="op">,</span> <span class="pp">scale::</span>Encode<span class="op">,</span> <span class="pp">scale::</span>Decode<span class="at">)]</span></span>
<span id="cb6-14"><a href="#cb6-14" aria-hidden="true" tabindex="-1"></a>    <span class="at">#[</span>cfg_attr<span class="at">(</span>feature <span class="op">=</span> <span class="st">&quot;std&quot;</span><span class="op">,</span> derive<span class="at">(</span><span class="pp">scale_info::</span>TypeInfo<span class="at">))]</span></span>
<span id="cb6-15"><a href="#cb6-15" aria-hidden="true" tabindex="-1"></a>    <span class="kw">pub</span> <span class="kw">enum</span> <span class="bu">Error</span> <span class="op">{</span></span>
<span id="cb6-16"><a href="#cb6-16" aria-hidden="true" tabindex="-1"></a>        InsufficientBalance<span class="op">,</span></span>
<span id="cb6-17"><a href="#cb6-17" aria-hidden="true" tabindex="-1"></a>        ArithmeticOverflow<span class="op">,</span></span>
<span id="cb6-18"><a href="#cb6-18" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb6-19"><a href="#cb6-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-20"><a href="#cb6-20" aria-hidden="true" tabindex="-1"></a>    <span class="kw">impl</span> SimpleToken <span class="op">{</span></span>
<span id="cb6-21"><a href="#cb6-21" aria-hidden="true" tabindex="-1"></a>        <span class="at">#[</span>ink<span class="at">(</span>constructor<span class="at">)]</span></span>
<span id="cb6-22"><a href="#cb6-22" aria-hidden="true" tabindex="-1"></a>        <span class="kw">pub</span> <span class="kw">fn</span> new(total_supply<span class="op">:</span> Balance) <span class="op">-&gt;</span> <span class="dt">Self</span> <span class="op">{</span></span>
<span id="cb6-23"><a href="#cb6-23" aria-hidden="true" tabindex="-1"></a>            <span class="kw">let</span> <span class="kw">mut</span> balances <span class="op">=</span> <span class="pp">Mapping::</span><span class="kw">default</span>()<span class="op">;</span></span>
<span id="cb6-24"><a href="#cb6-24" aria-hidden="true" tabindex="-1"></a>            <span class="kw">let</span> caller <span class="op">=</span> <span class="dt">Self</span><span class="pp">::</span>env()<span class="op">.</span>caller()<span class="op">;</span></span>
<span id="cb6-25"><a href="#cb6-25" aria-hidden="true" tabindex="-1"></a>            balances<span class="op">.</span>insert(caller<span class="op">,</span> <span class="op">&amp;</span>total_supply)<span class="op">;</span></span>
<span id="cb6-26"><a href="#cb6-26" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb6-27"><a href="#cb6-27" aria-hidden="true" tabindex="-1"></a>            <span class="dt">Self</span> <span class="op">{</span></span>
<span id="cb6-28"><a href="#cb6-28" aria-hidden="true" tabindex="-1"></a>                total_supply<span class="op">,</span></span>
<span id="cb6-29"><a href="#cb6-29" aria-hidden="true" tabindex="-1"></a>                balances<span class="op">,</span></span>
<span id="cb6-30"><a href="#cb6-30" aria-hidden="true" tabindex="-1"></a>            <span class="op">}</span></span>
<span id="cb6-31"><a href="#cb6-31" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb6-32"><a href="#cb6-32" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-33"><a href="#cb6-33" aria-hidden="true" tabindex="-1"></a>        <span class="at">#[</span>ink<span class="at">(</span>message<span class="at">)]</span></span>
<span id="cb6-34"><a href="#cb6-34" aria-hidden="true" tabindex="-1"></a>        <span class="kw">pub</span> <span class="kw">fn</span> transfer(<span class="op">&amp;</span><span class="kw">mut</span> <span class="kw">self</span><span class="op">,</span> to<span class="op">:</span> AccountId<span class="op">,</span> amount<span class="op">:</span> Balance) <span class="op">-&gt;</span> <span class="dt">Result</span><span class="op">&lt;</span>()<span class="op">,</span> <span class="bu">Error</span><span class="op">&gt;</span> <span class="op">{</span></span>
<span id="cb6-35"><a href="#cb6-35" aria-hidden="true" tabindex="-1"></a>            <span class="kw">let</span> caller <span class="op">=</span> <span class="kw">self</span><span class="op">.</span>env()<span class="op">.</span>caller()<span class="op">;</span></span>
<span id="cb6-36"><a href="#cb6-36" aria-hidden="true" tabindex="-1"></a>            <span class="kw">let</span> caller_balance <span class="op">=</span> <span class="kw">self</span><span class="op">.</span>balances<span class="op">.</span>get(caller)<span class="op">.</span>unwrap_or(<span class="dv">0</span>)<span class="op">;</span></span>
<span id="cb6-37"><a href="#cb6-37" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb6-38"><a href="#cb6-38" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> caller_balance <span class="op">&lt;</span> amount <span class="op">{</span></span>
<span id="cb6-39"><a href="#cb6-39" aria-hidden="true" tabindex="-1"></a>                <span class="cf">return</span> <span class="cn">Err</span>(<span class="bu">Error</span><span class="pp">::</span>InsufficientBalance)<span class="op">;</span></span>
<span id="cb6-40"><a href="#cb6-40" aria-hidden="true" tabindex="-1"></a>            <span class="op">}</span></span>
<span id="cb6-41"><a href="#cb6-41" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb6-42"><a href="#cb6-42" aria-hidden="true" tabindex="-1"></a>            <span class="kw">let</span> new_caller_balance <span class="op">=</span> caller_balance</span>
<span id="cb6-43"><a href="#cb6-43" aria-hidden="true" tabindex="-1"></a>                <span class="op">.</span>checked_sub(amount)</span>
<span id="cb6-44"><a href="#cb6-44" aria-hidden="true" tabindex="-1"></a>                <span class="op">.</span>ok_or(<span class="bu">Error</span><span class="pp">::</span>ArithmeticOverflow)<span class="op">?;</span></span>
<span id="cb6-45"><a href="#cb6-45" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb6-46"><a href="#cb6-46" aria-hidden="true" tabindex="-1"></a>            <span class="kw">let</span> to_balance <span class="op">=</span> <span class="kw">self</span><span class="op">.</span>balances<span class="op">.</span>get(to)<span class="op">.</span>unwrap_or(<span class="dv">0</span>)<span class="op">;</span></span>
<span id="cb6-47"><a href="#cb6-47" aria-hidden="true" tabindex="-1"></a>            <span class="kw">let</span> new_to_balance <span class="op">=</span> to_balance</span>
<span id="cb6-48"><a href="#cb6-48" aria-hidden="true" tabindex="-1"></a>                <span class="op">.</span>checked_add(amount)</span>
<span id="cb6-49"><a href="#cb6-49" aria-hidden="true" tabindex="-1"></a>                <span class="op">.</span>ok_or(<span class="bu">Error</span><span class="pp">::</span>ArithmeticOverflow)<span class="op">?;</span></span>
<span id="cb6-50"><a href="#cb6-50" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb6-51"><a href="#cb6-51" aria-hidden="true" tabindex="-1"></a>            <span class="kw">self</span><span class="op">.</span>balances<span class="op">.</span>insert(caller<span class="op">,</span> <span class="op">&amp;</span>new_caller_balance)<span class="op">;</span></span>
<span id="cb6-52"><a href="#cb6-52" aria-hidden="true" tabindex="-1"></a>            <span class="kw">self</span><span class="op">.</span>balances<span class="op">.</span>insert(to<span class="op">,</span> <span class="op">&amp;</span>new_to_balance)<span class="op">;</span></span>
<span id="cb6-53"><a href="#cb6-53" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb6-54"><a href="#cb6-54" aria-hidden="true" tabindex="-1"></a>            <span class="cn">Ok</span>(())</span>
<span id="cb6-55"><a href="#cb6-55" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb6-56"><a href="#cb6-56" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-57"><a href="#cb6-57" aria-hidden="true" tabindex="-1"></a>        <span class="at">#[</span>ink<span class="at">(</span>message<span class="at">)]</span></span>
<span id="cb6-58"><a href="#cb6-58" aria-hidden="true" tabindex="-1"></a>        <span class="kw">pub</span> <span class="kw">fn</span> balance_of(<span class="op">&amp;</span><span class="kw">self</span><span class="op">,</span> account<span class="op">:</span> AccountId) <span class="op">-&gt;</span> Balance <span class="op">{</span></span>
<span id="cb6-59"><a href="#cb6-59" aria-hidden="true" tabindex="-1"></a>            <span class="kw">self</span><span class="op">.</span>balances<span class="op">.</span>get(account)<span class="op">.</span>unwrap_or(<span class="dv">0</span>)</span>
<span id="cb6-60"><a href="#cb6-60" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb6-61"><a href="#cb6-61" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb6-62"><a href="#cb6-62" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<h3 id="key-differences-analysis">Key Differences Analysis</h3>
<table>
<colgroup>
<col style="width: 33%" />
<col style="width: 41%" />
<col style="width: 25%" />
</colgroup>
<thead>
<tr>
<th>Aspect</th>
<th>Solidity</th>
<th>ink!</th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>Memory Safety</strong></td>
<td>Runtime checks only</td>
<td>Compile-time guarantees</td>
</tr>
<tr>
<td><strong>Integer Overflow</strong></td>
<td>Silent overflow (pre-0.8) or panic</td>
<td>Explicit handling required</td>
</tr>
<tr>
<td><strong>Error Handling</strong></td>
<td><code>require()</code> statements</td>
<td><code>Result&lt;T, E&gt;</code> types</td>
</tr>
<tr>
<td><strong>Type Safety</strong></td>
<td>Dynamic typing elements</td>
<td>Strict static typing</td>
</tr>
<tr>
<td><strong>Testing</strong></td>
<td>External frameworks</td>
<td>Built-in unit and E2E testing</td>
</tr>
<tr>
<td><strong>Compilation Target</strong></td>
<td>EVM bytecode</td>
<td>WebAssembly</td>
</tr>
</tbody>
</table>
<h3 id="performance-implications">Performance Implications</h3>
<p>WebAssembly execution offers several advantages over EVM
bytecode:</p>
<ol type="1">
<li><strong>Near-native Performance</strong>: Wasm can achieve 95%+ of
native execution speed</li>
<li><strong>Smaller Code Size</strong>: More efficient encoding reduces
storage costs</li>
<li><strong>Better Tooling</strong>: Standard debugging and profiling
tools work with Wasm</li>
</ol>
<p>Benchmark comparison for a simple transfer operation: -
<strong>EVM</strong>: ~21,000 gas - <strong>ink!/Wasm</strong>: ~15,000
gas equivalent (varies by implementation)</p>
<h2 id="the-polkadot-sdk-stack-where-ink-fits">The polkadot-sdk Stack:
Where ink! Fits</h2>
<p>Understanding ink!’s place in the polkadot-sdk ecosystem is crucial
for effective development.</p>
<h3 id="polkadot-sdk-architecture-layers">polkadot-sdk Architecture
Layers</h3>
<pre><code>┌─────────────────────────────────────────┐
│            Runtime (STF)                │
│  ┌─────────────┐  ┌─────────────────┐   │
│  │   Pallets   │  │ pallet-contracts│   │
│  │             │  │                 │   │
│  │ - Balances  │  │  ┌───────────┐  │   │
│  │ - Timestamp │  │  │ink!       │  │   |
│  │ - System    │  │  │Contracts  │  │   │
│  │ - ...       │  │  └───────────┘  │   │
│  └─────────────┘  └─────────────────┘   │
└─────────────────────────────────────────┘
┌─────────────────────────────────────────┐
│            Consensus Layer              │
└─────────────────────────────────────────┘
┌─────────────────────────────────────────┐
│            Networking Layer             │
└─────────────────────────────────────────┘</code></pre>
<h3 id="pallet-contracts-the-execution-environment">pallet-contracts:
The Execution Environment</h3>
<p>The <code>pallet-contracts</code> pallet provides:</p>
<ol type="1">
<li><strong>Wasm Virtual Machine</strong>: Executes compiled ink!
contracts</li>
<li><strong>Gas Metering</strong>: Prevents infinite loops and resource
exhaustion</li>
<li><strong>Storage Management</strong>: Persistent key-value storage
for contracts</li>
<li><strong>Call Stack Management</strong>: Handles cross-contract
calls</li>
<li><strong>Event Emission</strong>: Allows contracts to emit events for
off-chain consumption</li>
</ol>
<h3 id="comparison-with-native-pallets">Comparison with Native
Pallets</h3>
<table>
<colgroup>
<col style="width: 23%" />
<col style="width: 38%" />
<col style="width: 38%" />
</colgroup>
<thead>
<tr>
<th>Feature</th>
<th>Native Pallet</th>
<th>ink! Contract</th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>Performance</strong></td>
<td>Highest (native Rust)</td>
<td>High (Wasm overhead ~5-10%)</td>
</tr>
<tr>
<td><strong>Flexibility</strong></td>
<td>Requires runtime upgrade</td>
<td>Deployable anytime</td>
</tr>
<tr>
<td><strong>Gas Costs</strong></td>
<td>No gas (weight-based)</td>
<td>Gas metered execution</td>
</tr>
<tr>
<td><strong>Upgradability</strong></td>
<td>Hard fork required</td>
<td>Proxy patterns possible</td>
</tr>
<tr>
<td><strong>Development Complexity</strong></td>
<td>Higher (runtime knowledge)</td>
<td>Lower (contract-focused)</td>
</tr>
</tbody>
</table>
<h3 id="ink-contract-lifecycle">ink! Contract Lifecycle</h3>
<figure>
<img src="lifecycle.png" title="Lifecycle" alt="Lifecycle" />
<figcaption aria-hidden="true">Lifecycle</figcaption>
</figure>
<h2 id="setting-up-your-development-environment">Setting Up Your
Development Environment</h2>
<p>Let’s establish a complete development environment for ink! contract
development.</p>
<h3 id="step-1-install-rust">Step 1: Install Rust</h3>
<p>First, ensure you have the latest stable Rust toolchain:</p>
<div class="sourceCode" id="cb8"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Install Rust via rustup (if not already installed)</span></span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a><span class="ex">curl</span> <span class="at">--proto</span> <span class="st">&#39;=https&#39;</span> <span class="at">--tlsv1.2</span> <span class="at">-sSf</span> https://sh.rustup.rs <span class="kw">|</span> <span class="fu">sh</span></span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-4"><a href="#cb8-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Reload your shell or source the environment</span></span>
<span id="cb8-5"><a href="#cb8-5" aria-hidden="true" tabindex="-1"></a><span class="bu">source</span> ~/.cargo/env</span>
<span id="cb8-6"><a href="#cb8-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-7"><a href="#cb8-7" aria-hidden="true" tabindex="-1"></a><span class="co"># Verify installation</span></span>
<span id="cb8-8"><a href="#cb8-8" aria-hidden="true" tabindex="-1"></a><span class="ex">rustc</span> <span class="at">--version</span></span>
<span id="cb8-9"><a href="#cb8-9" aria-hidden="true" tabindex="-1"></a><span class="co"># Should output: rustc 1.75.0 (stable)</span></span></code></pre></div>
<h3 id="step-2-configure-the-rust-toolchain">Step 2: Configure the Rust
Toolchain</h3>
<p>ink! contracts compile to WebAssembly, requiring the Wasm target:</p>
<div class="sourceCode" id="cb9"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Add the WebAssembly target</span></span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a><span class="ex">rustup</span> target add wasm32-unknown-unknown</span>
<span id="cb9-3"><a href="#cb9-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-4"><a href="#cb9-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Verify the target is installed</span></span>
<span id="cb9-5"><a href="#cb9-5" aria-hidden="true" tabindex="-1"></a><span class="ex">rustup</span> target list <span class="at">--installed</span> <span class="kw">|</span> <span class="fu">grep</span> wasm32</span>
<span id="cb9-6"><a href="#cb9-6" aria-hidden="true" tabindex="-1"></a><span class="co"># Should output: wasm32-unknown-unknown</span></span></code></pre></div>
<p>For optimal development experience, also install useful
components:</p>
<div class="sourceCode" id="cb10"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Add clippy for linting</span></span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a><span class="ex">rustup</span> component add clippy</span>
<span id="cb10-3"><a href="#cb10-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-4"><a href="#cb10-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Add rustfmt for code formatting</span></span>
<span id="cb10-5"><a href="#cb10-5" aria-hidden="true" tabindex="-1"></a><span class="ex">rustup</span> component add rustfmt</span>
<span id="cb10-6"><a href="#cb10-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-7"><a href="#cb10-7" aria-hidden="true" tabindex="-1"></a><span class="co"># Verify components are installed</span></span>
<span id="cb10-8"><a href="#cb10-8" aria-hidden="true" tabindex="-1"></a><span class="ex">cargo</span> clippy <span class="at">--version</span></span>
<span id="cb10-9"><a href="#cb10-9" aria-hidden="true" tabindex="-1"></a><span class="ex">cargo</span> fmt <span class="at">--version</span></span></code></pre></div>
<h3 id="step-3-install-cargo-contract">Step 3: Install
cargo-contract</h3>
<p><code>cargo-contract</code> is the primary command-line tool for ink!
development:</p>
<div class="sourceCode" id="cb11"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Install the latest version</span></span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a><span class="ex">cargo</span> install <span class="at">--force</span> <span class="at">--locked</span> cargo-contract</span>
<span id="cb11-3"><a href="#cb11-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-4"><a href="#cb11-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Verify installation</span></span>
<span id="cb11-5"><a href="#cb11-5" aria-hidden="true" tabindex="-1"></a><span class="ex">cargo</span> contract <span class="at">--version</span></span>
<span id="cb11-6"><a href="#cb11-6" aria-hidden="true" tabindex="-1"></a><span class="co"># Should output: cargo-contract-contract 4.0.0</span></span></code></pre></div>
<h3 id="step-4-verify-your-setup">Step 4: Verify Your Setup</h3>
<p>Create a test project to verify everything works:</p>
<div class="sourceCode" id="cb12"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Create a new directory for testing</span></span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true" tabindex="-1"></a><span class="fu">mkdir</span> ~/ink-test <span class="kw">&amp;&amp;</span> <span class="bu">cd</span> ~/ink-test</span>
<span id="cb12-3"><a href="#cb12-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-4"><a href="#cb12-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Generate a new ink! project</span></span>
<span id="cb12-5"><a href="#cb12-5" aria-hidden="true" tabindex="-1"></a><span class="ex">cargo</span> contract new flipper</span>
<span id="cb12-6"><a href="#cb12-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-7"><a href="#cb12-7" aria-hidden="true" tabindex="-1"></a><span class="co"># Navigate to the project</span></span>
<span id="cb12-8"><a href="#cb12-8" aria-hidden="true" tabindex="-1"></a><span class="bu">cd</span> flipper</span>
<span id="cb12-9"><a href="#cb12-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-10"><a href="#cb12-10" aria-hidden="true" tabindex="-1"></a><span class="co"># Build the contract</span></span>
<span id="cb12-11"><a href="#cb12-11" aria-hidden="true" tabindex="-1"></a><span class="ex">cargo</span> contract build</span>
<span id="cb12-12"><a href="#cb12-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-13"><a href="#cb12-13" aria-hidden="true" tabindex="-1"></a><span class="co"># Verify build artifacts</span></span>
<span id="cb12-14"><a href="#cb12-14" aria-hidden="true" tabindex="-1"></a><span class="fu">ls</span> <span class="at">-la</span> target/ink/</span>
<span id="cb12-15"><a href="#cb12-15" aria-hidden="true" tabindex="-1"></a><span class="co"># Should contain: flipper.wasm, flipper.json, flipper.contract</span></span></code></pre></div>
<p>Expected output structure:</p>
<pre><code>target/ink/
├── flipper.wasm      # Compiled WebAssembly binary
├── flipper.json      # Contract metadata
└── flipper.contract  # Bundle file (contains both .wasm and .json)</code></pre>
<h3 id="step-5-install-a-local-test-node">Step 5: Install a Local Test
Node</h3>
<p>For testing and development, install
<code>substrate-contracts-node</code>:</p>
<div class="sourceCode" id="cb14"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Install the contracts node</span></span>
<span id="cb14-2"><a href="#cb14-2" aria-hidden="true" tabindex="-1"></a><span class="ex">cargo</span> install contracts-node <span class="at">--git</span> https://github.com/paritytech/substrate-contracts-node.git</span>
<span id="cb14-3"><a href="#cb14-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-4"><a href="#cb14-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Start the node (in a separate terminal)</span></span>
<span id="cb14-5"><a href="#cb14-5" aria-hidden="true" tabindex="-1"></a><span class="ex">substrate-contracts-node</span> <span class="at">--dev</span> <span class="at">--tmp</span></span>
<span id="cb14-6"><a href="#cb14-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-7"><a href="#cb14-7" aria-hidden="true" tabindex="-1"></a><span class="co"># The node should start and begin producing blocks</span></span>
<span id="cb14-8"><a href="#cb14-8" aria-hidden="true" tabindex="-1"></a><span class="co"># Keep this running in a separate terminal session</span></span></code></pre></div>
<p>Expected output:</p>
<pre><code>2024-01-15 10:30:00 polkadot-sdk Contracts Node
2024-01-15 10:30:00 Running in --dev mode, RPC CORS has been disabled.
2024-01-15 10:30:00 Local node identity is: 12D3KooW...
2024-01-15 10:30:06 💤 Idle (0 peers), best: #0 (0x1234...), finalized #0
2024-01-15 10:30:12 💤 Idle (0 peers), best: #1 (0x5678...), finalized #0</code></pre>
<h3 id="step-6-install-additional-development-tools">Step 6: Install
Additional Development Tools</h3>
<p>For enhanced development experience:</p>
<div class="sourceCode" id="cb16"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Install polkadot-js-api CLI tools (optional, for advanced interaction)</span></span>
<span id="cb16-2"><a href="#cb16-2" aria-hidden="true" tabindex="-1"></a><span class="ex">npm</span> install <span class="at">-g</span> @polkadot/api-cli</span>
<span id="cb16-3"><a href="#cb16-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-4"><a href="#cb16-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Install substrate development tools (optional)</span></span>
<span id="cb16-5"><a href="#cb16-5" aria-hidden="true" tabindex="-1"></a><span class="ex">cargo</span> install subxt-cli</span></code></pre></div>
<h3 id="environment-configuration">Environment Configuration</h3>
<p>Create a development configuration file to standardize your
setup:</p>
<div class="sourceCode" id="cb17"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Create a config directory</span></span>
<span id="cb17-2"><a href="#cb17-2" aria-hidden="true" tabindex="-1"></a><span class="fu">mkdir</span> <span class="at">-p</span> ~/.config/ink-dev</span>
<span id="cb17-3"><a href="#cb17-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-4"><a href="#cb17-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Create an environment configuration file</span></span>
<span id="cb17-5"><a href="#cb17-5" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span> <span class="op">&gt;</span> ~/.config/ink-dev/config.toml <span class="op">&lt;&lt; &#39;EOF&#39;</span></span>
<span id="cb17-6"><a href="#cb17-6" aria-hidden="true" tabindex="-1"></a><span class="st">[environment]</span></span>
<span id="cb17-7"><a href="#cb17-7" aria-hidden="true" tabindex="-1"></a><span class="st">node_url = &quot;ws://127.0.0.1:9944&quot;</span></span>
<span id="cb17-8"><a href="#cb17-8" aria-hidden="true" tabindex="-1"></a><span class="st">default_account = &quot;//Alice&quot;</span></span>
<span id="cb17-9"><a href="#cb17-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-10"><a href="#cb17-10" aria-hidden="true" tabindex="-1"></a><span class="st">[build]</span></span>
<span id="cb17-11"><a href="#cb17-11" aria-hidden="true" tabindex="-1"></a><span class="st">optimization_passes = &quot;Z&quot;</span></span>
<span id="cb17-12"><a href="#cb17-12" aria-hidden="true" tabindex="-1"></a><span class="st">keep_debug_symbols = false</span></span>
<span id="cb17-13"><a href="#cb17-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-14"><a href="#cb17-14" aria-hidden="true" tabindex="-1"></a><span class="st">[deployment]</span></span>
<span id="cb17-15"><a href="#cb17-15" aria-hidden="true" tabindex="-1"></a><span class="st">gas_limit = &quot;1000000000000&quot;</span></span>
<span id="cb17-16"><a href="#cb17-16" aria-hidden="true" tabindex="-1"></a><span class="st">value = &quot;0&quot;</span></span>
<span id="cb17-17"><a href="#cb17-17" aria-hidden="true" tabindex="-1"></a><span class="op">EOF</span></span></code></pre></div>
<h3 id="ide-setup-recommendations">IDE Setup Recommendations</h3>
<p>For the best development experience, configure your IDE:</p>
<h4 id="visual-studio-code">Visual Studio Code</h4>
<p>Install these extensions:</p>
<div class="sourceCode" id="cb18"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a><span class="ex">code</span> <span class="at">--install-extension</span> rust-lang.rust-analyzer</span>
<span id="cb18-2"><a href="#cb18-2" aria-hidden="true" tabindex="-1"></a><span class="ex">code</span> <span class="at">--install-extension</span> vadimcn.vscode-lldb</span>
<span id="cb18-3"><a href="#cb18-3" aria-hidden="true" tabindex="-1"></a><span class="ex">code</span> <span class="at">--install-extension</span> serayuzgur.crates</span></code></pre></div>
<p>Create a workspace configuration
(<code>.vscode/settings.json</code>):</p>
<div class="sourceCode" id="cb19"><pre
class="sourceCode json"><code class="sourceCode json"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a><span class="fu">{</span></span>
<span id="cb19-2"><a href="#cb19-2" aria-hidden="true" tabindex="-1"></a>    <span class="dt">&quot;rust-analyzer.cargo.features&quot;</span><span class="fu">:</span> <span class="ot">[</span><span class="st">&quot;std&quot;</span><span class="ot">]</span><span class="fu">,</span></span>
<span id="cb19-3"><a href="#cb19-3" aria-hidden="true" tabindex="-1"></a>    <span class="dt">&quot;rust-analyzer.checkOnSave.command&quot;</span><span class="fu">:</span> <span class="st">&quot;clippy&quot;</span><span class="fu">,</span></span>
<span id="cb19-4"><a href="#cb19-4" aria-hidden="true" tabindex="-1"></a>    <span class="dt">&quot;rust-analyzer.cargo.target&quot;</span><span class="fu">:</span> <span class="st">&quot;wasm32-unknown-unknown&quot;</span><span class="fu">,</span></span>
<span id="cb19-5"><a href="#cb19-5" aria-hidden="true" tabindex="-1"></a>    <span class="dt">&quot;files.watcherExclude&quot;</span><span class="fu">:</span> <span class="fu">{</span></span>
<span id="cb19-6"><a href="#cb19-6" aria-hidden="true" tabindex="-1"></a>        <span class="dt">&quot;**/target/**&quot;</span><span class="fu">:</span> <span class="kw">true</span></span>
<span id="cb19-7"><a href="#cb19-7" aria-hidden="true" tabindex="-1"></a>    <span class="fu">}</span></span>
<span id="cb19-8"><a href="#cb19-8" aria-hidden="true" tabindex="-1"></a><span class="fu">}</span></span></code></pre></div>
<h4 id="vimneovim">Vim/Neovim</h4>
<p>Add to your configuration:</p>
<pre class="vim"><code>&quot; For rust-analyzer LSP support
Plug &#39;neovim/nvim-lspconfig&#39;
Plug &#39;rust-lang/rust.vim&#39;

&quot; Configure rust-analyzer
lua &lt;&lt; EOF
require&#39;lspconfig&#39;.rust_analyzer.setup{
    settings = {
        [&quot;rust-analyzer&quot;] = {
            cargo = {
                target = &quot;wasm32-unknown-unknown&quot;,
                features = {&quot;std&quot;}
            }
        }
    }
}
EOF</code></pre>
<h3 id="troubleshooting-common-setup-issues">Troubleshooting Common
Setup Issues</h3>
<h4 id="issue-cargo-contract-not-found">Issue:
<code>cargo contract</code> not found</h4>
<p><strong>Solution</strong>: Ensure <code>~/.cargo/bin</code> is in
your <code>PATH</code>:</p>
<div class="sourceCode" id="cb21"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a><span class="bu">echo</span> <span class="st">&#39;export PATH=&quot;$HOME/.cargo/bin:$PATH&quot;&#39;</span> <span class="op">&gt;&gt;</span> ~/.bashrc</span>
<span id="cb21-2"><a href="#cb21-2" aria-hidden="true" tabindex="-1"></a><span class="bu">source</span> ~/.bashrc</span></code></pre></div>
<h4 id="issue-wasm-target-not-found-during-build">Issue: Wasm target not
found during build</h4>
<p><strong>Solution</strong>: Reinstall the Wasm target:</p>
<div class="sourceCode" id="cb22"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb22-1"><a href="#cb22-1" aria-hidden="true" tabindex="-1"></a><span class="ex">rustup</span> target remove wasm32-unknown-unknown</span>
<span id="cb22-2"><a href="#cb22-2" aria-hidden="true" tabindex="-1"></a><span class="ex">rustup</span> target add wasm32-unknown-unknown</span></code></pre></div>
<h4 id="issue-permission-denied-when-installing-contracts-node">Issue:
Permission denied when installing <code>contracts-node</code></h4>
<p><strong>Solution</strong>: Use local installation:</p>
<div class="sourceCode" id="cb23"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb23-1"><a href="#cb23-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Install to a local directory</span></span>
<span id="cb23-2"><a href="#cb23-2" aria-hidden="true" tabindex="-1"></a><span class="ex">cargo</span> install contracts-node <span class="at">--git</span> https://github.com/paritytech/substrate-contracts-node.git <span class="at">--root</span> ~/.local</span>
<span id="cb23-3"><a href="#cb23-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-4"><a href="#cb23-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Add to PATH</span></span>
<span id="cb23-5"><a href="#cb23-5" aria-hidden="true" tabindex="-1"></a><span class="bu">echo</span> <span class="st">&#39;export PATH=&quot;$HOME/.local/bin:$PATH&quot;&#39;</span> <span class="op">&gt;&gt;</span> ~/.bashrc</span>
<span id="cb23-6"><a href="#cb23-6" aria-hidden="true" tabindex="-1"></a><span class="bu">source</span> ~/.bashrc</span></code></pre></div>
<h4 id="issue-build-fails-with-linker-not-found">Issue: Build fails with
“linker not found”</h4>
<p><strong>Solution</strong>: Install build essentials:</p>
<div class="sourceCode" id="cb24"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb24-1"><a href="#cb24-1" aria-hidden="true" tabindex="-1"></a><span class="co"># On Ubuntu/Debian</span></span>
<span id="cb24-2"><a href="#cb24-2" aria-hidden="true" tabindex="-1"></a><span class="fu">sudo</span> apt-get install build-essential</span>
<span id="cb24-3"><a href="#cb24-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-4"><a href="#cb24-4" aria-hidden="true" tabindex="-1"></a><span class="co"># On macOS</span></span>
<span id="cb24-5"><a href="#cb24-5" aria-hidden="true" tabindex="-1"></a><span class="ex">xcode-select</span> <span class="at">--install</span></span>
<span id="cb24-6"><a href="#cb24-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-7"><a href="#cb24-7" aria-hidden="true" tabindex="-1"></a><span class="co"># On Windows (use WSL or install Visual Studio Build Tools)</span></span></code></pre></div>
<h3 id="verification-checklist">Verification Checklist</h3>
<p>Before proceeding to the next chapter, verify your environment:</p>
<ul class="task-list">
<li><label><input type="checkbox" /><code>rustc --version</code> shows
stable Rust 1.75+</label></li>
<li><label><input
type="checkbox" /><code>rustup target list --installed</code> includes
<code>wasm32-unknown-unknown</code></label></li>
<li><label><input
type="checkbox" /><code>cargo contract --version</code> shows
4.0+</label></li>
<li><label><input
type="checkbox" /><code>cargo contract new test &amp;&amp; cd test &amp;&amp; cargo contract build</code>
succeeds</label></li>
<li><label><input
type="checkbox" /><code>substrate-contracts-node --dev</code> starts
successfully</label></li>
<li><label><input type="checkbox" />Your IDE has Rust language support
configured</label></li>
</ul>
<h2 id="summary">Summary</h2>
<p>In this chapter, we explored the fundamental advantages of using Rust
for smart contract development through ink!. The combination of memory
safety, zero-cost abstractions, and a mature ecosystem provides a
compelling foundation for building production-ready smart contracts.</p>
<p>Key takeaways:</p>
<ol type="1">
<li><p><strong>ink! leverages Rust’s strengths</strong>: Memory safety,
type safety, and performance benefits translate directly to more secure
and efficient smart contracts.</p></li>
<li><p><strong>WebAssembly execution</strong>: Provides near-native
performance while maintaining the sandboxed security model required for
smart contracts.</p></li>
<li><p><strong>polkadot-sdk integration</strong>: ink! contracts run
within the <code>pallet-contracts</code> environment, providing a bridge
between native runtime performance and flexible contract
deployment.</p></li>
<li><p><strong>Comprehensive toolchain</strong>:
<code>cargo-contract</code> provides everything needed for the complete
development lifecycle.</p></li>
<li><p><strong>Development environment</strong>: A properly configured
environment with Rust, WebAssembly targets, and local test nodes enables
efficient development and testing.</p></li>
</ol>
<p>With your development environment ready, you’re prepared to dive into
the practical aspects of ink! contract development. In the next chapter,
we’ll dissect the anatomy of an ink! contract by building and
understanding the classic “flipper” contract from the ground up.</p>
<hr />
<h1 id="chapter-2-anatomy-of-an-ink-contract-your-first-build">Chapter
2: Anatomy of an ink! Contract: Your First Build</h1>
<p>The best way to see ink!’s shape is to compare it to what came
before. Solidity is expressive but permissive; it trusts you to remember
every overflow, every reentrancy, every storage write you forgot to
persist. ink! is demanding: you must make errors explicit with
<code>Result</code>, you must request mutability when you intend to
change state, you must choose checked arithmetic if the numbers might
betray you. In return, the compiler becomes your first auditor. The
polkadot-sdk stack welcomes these Wasm contracts inside
<code>pallet-contracts</code>, an execution engine that meters gas,
persists key–value storage, dispatches messages, and emits events that
off‑chain clients can index. Your development environment is pleasantly
ordinary: install Rust with <code>rustup</code>, add the
<code>wasm32-unknown-unknown</code> target, install
<code>cargo-contract</code>, and you can scaffold, build, and inspect
artifacts (.wasm, metadata.json, and the bundled .contract) with a few
terminal commands. The ritual is simple but powerful: write Rust, mark a
struct as <code>#[ink(storage)]</code>, annotate your constructors and
messages, then <code>cargo contract build</code> and ship a Wasm that
any polkadot-sdk node can execute. Soon you will feel the rhythm: a
contract is just a Rust module with a storage root at its heart and a
public surface of messages that the world may call.</p>
<p>Every ink! developer begins their journey with the flipper contract—a
simple boolean toggle that demonstrates the fundamental building blocks
of smart contract development. While deceptively simple, this contract
introduces every core concept you’ll use in sophisticated applications:
storage management, state transitions, message handling, and the
compilation pipeline.</p>
<p>In this chapter, we’ll build the flipper contract from scratch,
dissecting each component to understand how ink! transforms Rust code
into deployable WebAssembly contracts. By the end, you’ll understand the
complete development cycle and be ready to tackle more complex contract
architectures.</p>
<h2 id="project-scaffolding-creating-your-first-contract">Project
Scaffolding: Creating Your First Contract</h2>
<p>Let’s begin by generating a new ink! project and examining the
structure it creates.</p>
<h3 id="generating-the-project">Generating the Project</h3>
<div class="sourceCode" id="cb25"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb25-1"><a href="#cb25-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Create a new ink! contract project</span></span>
<span id="cb25-2"><a href="#cb25-2" aria-hidden="true" tabindex="-1"></a><span class="ex">cargo</span> contract new flipper</span>
<span id="cb25-3"><a href="#cb25-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-4"><a href="#cb25-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Navigate to the project directory</span></span>
<span id="cb25-5"><a href="#cb25-5" aria-hidden="true" tabindex="-1"></a><span class="bu">cd</span> flipper</span>
<span id="cb25-6"><a href="#cb25-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-7"><a href="#cb25-7" aria-hidden="true" tabindex="-1"></a><span class="co"># Examine the project structure</span></span>
<span id="cb25-8"><a href="#cb25-8" aria-hidden="true" tabindex="-1"></a><span class="ex">tree</span> .</span></code></pre></div>
<p>Expected output:</p>
<pre><code>flipper/
├── Cargo.toml
├── lib.rs
└── .gitignore</code></pre>
<h3 id="understanding-cargo.toml">Understanding Cargo.toml</h3>
<p>The <code>Cargo.toml</code> file configures your ink! project with
specific dependencies and features:</p>
<div class="sourceCode" id="cb27"><pre
class="sourceCode toml"><code class="sourceCode toml"><span id="cb27-1"><a href="#cb27-1" aria-hidden="true" tabindex="-1"></a><span class="kw">[package]</span></span>
<span id="cb27-2"><a href="#cb27-2" aria-hidden="true" tabindex="-1"></a><span class="dt">name</span> <span class="op">=</span> <span class="st">&quot;flipper&quot;</span></span>
<span id="cb27-3"><a href="#cb27-3" aria-hidden="true" tabindex="-1"></a><span class="dt">version</span> <span class="op">=</span> <span class="st">&quot;0.1.0&quot;</span></span>
<span id="cb27-4"><a href="#cb27-4" aria-hidden="true" tabindex="-1"></a><span class="dt">authors</span> <span class="op">=</span> <span class="op">[</span><span class="st">&quot;Your Name &lt;your.email@example.com&gt;&quot;</span><span class="op">]</span></span>
<span id="cb27-5"><a href="#cb27-5" aria-hidden="true" tabindex="-1"></a><span class="dt">edition</span> <span class="op">=</span> <span class="st">&quot;2021&quot;</span></span>
<span id="cb27-6"><a href="#cb27-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-7"><a href="#cb27-7" aria-hidden="true" tabindex="-1"></a><span class="kw">[dependencies]</span></span>
<span id="cb27-8"><a href="#cb27-8" aria-hidden="true" tabindex="-1"></a><span class="dt">ink</span> <span class="op">=</span> <span class="op">{ </span><span class="dt">version</span><span class="op"> =</span> <span class="st">&quot;4.3&quot;</span><span class="op">, </span><span class="dt">default-features</span><span class="op"> =</span> <span class="cn">false</span><span class="op"> }</span></span>
<span id="cb27-9"><a href="#cb27-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-10"><a href="#cb27-10" aria-hidden="true" tabindex="-1"></a><span class="kw">[lib]</span></span>
<span id="cb27-11"><a href="#cb27-11" aria-hidden="true" tabindex="-1"></a><span class="dt">path</span> <span class="op">=</span> <span class="st">&quot;lib.rs&quot;</span></span>
<span id="cb27-12"><a href="#cb27-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-13"><a href="#cb27-13" aria-hidden="true" tabindex="-1"></a><span class="kw">[[bin]]</span></span>
<span id="cb27-14"><a href="#cb27-14" aria-hidden="true" tabindex="-1"></a><span class="dt">name</span> <span class="op">=</span> <span class="st">&quot;flipper&quot;</span></span>
<span id="cb27-15"><a href="#cb27-15" aria-hidden="true" tabindex="-1"></a><span class="dt">path</span> <span class="op">=</span> <span class="st">&quot;lib.rs&quot;</span></span>
<span id="cb27-16"><a href="#cb27-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-17"><a href="#cb27-17" aria-hidden="true" tabindex="-1"></a><span class="kw">[features]</span></span>
<span id="cb27-18"><a href="#cb27-18" aria-hidden="true" tabindex="-1"></a><span class="dt">default</span> <span class="op">=</span> <span class="op">[</span><span class="st">&quot;std&quot;</span><span class="op">]</span></span>
<span id="cb27-19"><a href="#cb27-19" aria-hidden="true" tabindex="-1"></a><span class="dt">std</span> <span class="op">=</span> <span class="op">[</span></span>
<span id="cb27-20"><a href="#cb27-20" aria-hidden="true" tabindex="-1"></a>    <span class="st">&quot;ink/std&quot;</span><span class="op">,</span></span>
<span id="cb27-21"><a href="#cb27-21" aria-hidden="true" tabindex="-1"></a><span class="op">]</span></span>
<span id="cb27-22"><a href="#cb27-22" aria-hidden="true" tabindex="-1"></a><span class="dt">ink-as-dependency</span> <span class="op">=</span> <span class="op">[]</span></span></code></pre></div>
<p><strong>Key Configuration Details:</strong></p>
<ul>
<li><strong><code>default-features = false</code></strong>: Disables
standard library features by default</li>
<li><strong><code>std</code> feature</strong>: Enables standard library
support for testing and development</li>
<li><strong><code>ink-as-dependency</code></strong>: Allows this
contract to be used as a dependency by other contracts</li>
<li><strong><code>[[bin]]</code> section</strong>: Configures the
contract as an executable binary for deployment</li>
</ul>
<h3 id="the-feature-flag-pattern">The Feature Flag Pattern</h3>
<p>ink! uses Rust’s feature flag system to handle the dual nature of
contract development:</p>
<div class="sourceCode" id="cb28"><pre
class="sourceCode rust"><code class="sourceCode rust"><span id="cb28-1"><a href="#cb28-1" aria-hidden="true" tabindex="-1"></a><span class="at">#![</span>cfg_attr<span class="at">(</span>not<span class="at">(</span>feature <span class="op">=</span> <span class="st">&quot;std&quot;</span><span class="at">)</span><span class="op">,</span> no_std<span class="at">)]</span></span></code></pre></div>
<p>This conditional compilation attribute means: - <strong>During
development/testing</strong>: <code>std</code> feature is enabled,
allowing use of the standard library - <strong>During contract
compilation</strong>: <code>std</code> feature is disabled, creating a
<code>no_std</code> environment suitable for WebAssembly</p>
<h2 id="the-anatomy-of-lib.rs-a-complete-walkthrough">The Anatomy of
lib.rs: A Complete Walkthrough</h2>
<p>Let’s examine the complete flipper contract and understand each
component:</p>
<div class="sourceCode" id="cb29"><pre
class="sourceCode rust"><code class="sourceCode rust"><span id="cb29-1"><a href="#cb29-1" aria-hidden="true" tabindex="-1"></a><span class="at">#![</span>cfg_attr<span class="at">(</span>not<span class="at">(</span>feature <span class="op">=</span> <span class="st">&quot;std&quot;</span><span class="at">)</span><span class="op">,</span> no_std<span class="at">)]</span></span>
<span id="cb29-2"><a href="#cb29-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-3"><a href="#cb29-3" aria-hidden="true" tabindex="-1"></a><span class="at">#[</span><span class="pp">ink::</span>contract<span class="at">]</span></span>
<span id="cb29-4"><a href="#cb29-4" aria-hidden="true" tabindex="-1"></a><span class="kw">mod</span> flipper <span class="op">{</span></span>
<span id="cb29-5"><a href="#cb29-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-6"><a href="#cb29-6" aria-hidden="true" tabindex="-1"></a>    <span class="co">/// The storage struct that defines the contract&#39;s persistent state</span></span>
<span id="cb29-7"><a href="#cb29-7" aria-hidden="true" tabindex="-1"></a>    <span class="at">#[</span>ink<span class="at">(</span>storage<span class="at">)]</span></span>
<span id="cb29-8"><a href="#cb29-8" aria-hidden="true" tabindex="-1"></a>    <span class="kw">pub</span> <span class="kw">struct</span> Flipper <span class="op">{</span></span>
<span id="cb29-9"><a href="#cb29-9" aria-hidden="true" tabindex="-1"></a>        value<span class="op">:</span> <span class="dt">bool</span><span class="op">,</span></span>
<span id="cb29-10"><a href="#cb29-10" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb29-11"><a href="#cb29-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-12"><a href="#cb29-12" aria-hidden="true" tabindex="-1"></a>    <span class="kw">impl</span> Flipper <span class="op">{</span></span>
<span id="cb29-13"><a href="#cb29-13" aria-hidden="true" tabindex="-1"></a>        <span class="co">/// Constructor that initializes the contract with a given value</span></span>
<span id="cb29-14"><a href="#cb29-14" aria-hidden="true" tabindex="-1"></a>        <span class="co">/// </span></span>
<span id="cb29-15"><a href="#cb29-15" aria-hidden="true" tabindex="-1"></a>        <span class="co">/// # Arguments</span></span>
<span id="cb29-16"><a href="#cb29-16" aria-hidden="true" tabindex="-1"></a>        <span class="co">/// * `init_value` - The initial boolean value for the flipper</span></span>
<span id="cb29-17"><a href="#cb29-17" aria-hidden="true" tabindex="-1"></a>        <span class="at">#[</span>ink<span class="at">(</span>constructor<span class="at">)]</span></span>
<span id="cb29-18"><a href="#cb29-18" aria-hidden="true" tabindex="-1"></a>        <span class="kw">pub</span> <span class="kw">fn</span> new(init_value<span class="op">:</span> <span class="dt">bool</span>) <span class="op">-&gt;</span> <span class="dt">Self</span> <span class="op">{</span></span>
<span id="cb29-19"><a href="#cb29-19" aria-hidden="true" tabindex="-1"></a>            <span class="dt">Self</span> <span class="op">{</span> value<span class="op">:</span> init_value <span class="op">}</span></span>
<span id="cb29-20"><a href="#cb29-20" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb29-21"><a href="#cb29-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-22"><a href="#cb29-22" aria-hidden="true" tabindex="-1"></a>        <span class="co">/// Default constructor that initializes the contract with `false`</span></span>
<span id="cb29-23"><a href="#cb29-23" aria-hidden="true" tabindex="-1"></a>        <span class="at">#[</span>ink<span class="at">(</span>constructor<span class="at">)]</span></span>
<span id="cb29-24"><a href="#cb29-24" aria-hidden="true" tabindex="-1"></a>        <span class="kw">pub</span> <span class="kw">fn</span> default() <span class="op">-&gt;</span> <span class="dt">Self</span> <span class="op">{</span></span>
<span id="cb29-25"><a href="#cb29-25" aria-hidden="true" tabindex="-1"></a>            <span class="dt">Self</span><span class="pp">::</span>new(<span class="bu">Default</span><span class="pp">::</span><span class="kw">default</span>())</span>
<span id="cb29-26"><a href="#cb29-26" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb29-27"><a href="#cb29-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-28"><a href="#cb29-28" aria-hidden="true" tabindex="-1"></a>        <span class="co">/// Flips the current boolean value</span></span>
<span id="cb29-29"><a href="#cb29-29" aria-hidden="true" tabindex="-1"></a>        <span class="co">/// </span></span>
<span id="cb29-30"><a href="#cb29-30" aria-hidden="true" tabindex="-1"></a>        <span class="co">/// This is a mutable message that changes the contract&#39;s state</span></span>
<span id="cb29-31"><a href="#cb29-31" aria-hidden="true" tabindex="-1"></a>        <span class="at">#[</span>ink<span class="at">(</span>message<span class="at">)]</span></span>
<span id="cb29-32"><a href="#cb29-32" aria-hidden="true" tabindex="-1"></a>        <span class="kw">pub</span> <span class="kw">fn</span> flip(<span class="op">&amp;</span><span class="kw">mut</span> <span class="kw">self</span>) <span class="op">{</span></span>
<span id="cb29-33"><a href="#cb29-33" aria-hidden="true" tabindex="-1"></a>            <span class="kw">self</span><span class="op">.</span>value <span class="op">=</span> <span class="op">!</span><span class="kw">self</span><span class="op">.</span>value<span class="op">;</span></span>
<span id="cb29-34"><a href="#cb29-34" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb29-35"><a href="#cb29-35" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-36"><a href="#cb29-36" aria-hidden="true" tabindex="-1"></a>        <span class="co">/// Returns the current boolean value</span></span>
<span id="cb29-37"><a href="#cb29-37" aria-hidden="true" tabindex="-1"></a>        <span class="co">/// </span></span>
<span id="cb29-38"><a href="#cb29-38" aria-hidden="true" tabindex="-1"></a>        <span class="co">/// This is an immutable message that only reads state</span></span>
<span id="cb29-39"><a href="#cb29-39" aria-hidden="true" tabindex="-1"></a>        <span class="at">#[</span>ink<span class="at">(</span>message<span class="at">)]</span></span>
<span id="cb29-40"><a href="#cb29-40" aria-hidden="true" tabindex="-1"></a>        <span class="kw">pub</span> <span class="kw">fn</span> get(<span class="op">&amp;</span><span class="kw">self</span>) <span class="op">-&gt;</span> <span class="dt">bool</span> <span class="op">{</span></span>
<span id="cb29-41"><a href="#cb29-41" aria-hidden="true" tabindex="-1"></a>            <span class="kw">self</span><span class="op">.</span>value</span>
<span id="cb29-42"><a href="#cb29-42" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb29-43"><a href="#cb29-43" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb29-44"><a href="#cb29-44" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-45"><a href="#cb29-45" aria-hidden="true" tabindex="-1"></a>    <span class="co">/// Unit tests for the flipper contract</span></span>
<span id="cb29-46"><a href="#cb29-46" aria-hidden="true" tabindex="-1"></a>    <span class="co">/// </span></span>
<span id="cb29-47"><a href="#cb29-47" aria-hidden="true" tabindex="-1"></a>    <span class="co">/// These tests run in a simulated environment and verify</span></span>
<span id="cb29-48"><a href="#cb29-48" aria-hidden="true" tabindex="-1"></a>    <span class="co">/// the contract logic without deploying to a blockchain</span></span>
<span id="cb29-49"><a href="#cb29-49" aria-hidden="true" tabindex="-1"></a>    <span class="at">#[</span>cfg<span class="at">(</span>test<span class="at">)]</span></span>
<span id="cb29-50"><a href="#cb29-50" aria-hidden="true" tabindex="-1"></a>    <span class="kw">mod</span> tests <span class="op">{</span></span>
<span id="cb29-51"><a href="#cb29-51" aria-hidden="true" tabindex="-1"></a>        <span class="kw">use</span> <span class="kw">super</span><span class="pp">::</span><span class="op">*;</span></span>
<span id="cb29-52"><a href="#cb29-52" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-53"><a href="#cb29-53" aria-hidden="true" tabindex="-1"></a>        <span class="at">#[</span><span class="pp">ink::</span>test<span class="at">]</span></span>
<span id="cb29-54"><a href="#cb29-54" aria-hidden="true" tabindex="-1"></a>        <span class="kw">fn</span> default_works() <span class="op">{</span></span>
<span id="cb29-55"><a href="#cb29-55" aria-hidden="true" tabindex="-1"></a>            <span class="kw">let</span> flipper <span class="op">=</span> <span class="pp">Flipper::</span><span class="kw">default</span>()<span class="op">;</span></span>
<span id="cb29-56"><a href="#cb29-56" aria-hidden="true" tabindex="-1"></a>            <span class="pp">assert_eq!</span>(flipper<span class="op">.</span>get()<span class="op">,</span> <span class="cn">false</span>)<span class="op">;</span></span>
<span id="cb29-57"><a href="#cb29-57" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb29-58"><a href="#cb29-58" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-59"><a href="#cb29-59" aria-hidden="true" tabindex="-1"></a>        <span class="at">#[</span><span class="pp">ink::</span>test<span class="at">]</span></span>
<span id="cb29-60"><a href="#cb29-60" aria-hidden="true" tabindex="-1"></a>        <span class="kw">fn</span> it_works() <span class="op">{</span></span>
<span id="cb29-61"><a href="#cb29-61" aria-hidden="true" tabindex="-1"></a>            <span class="kw">let</span> <span class="kw">mut</span> flipper <span class="op">=</span> <span class="pp">Flipper::</span>new(<span class="cn">false</span>)<span class="op">;</span></span>
<span id="cb29-62"><a href="#cb29-62" aria-hidden="true" tabindex="-1"></a>            <span class="pp">assert_eq!</span>(flipper<span class="op">.</span>get()<span class="op">,</span> <span class="cn">false</span>)<span class="op">;</span></span>
<span id="cb29-63"><a href="#cb29-63" aria-hidden="true" tabindex="-1"></a>            flipper<span class="op">.</span>flip()<span class="op">;</span></span>
<span id="cb29-64"><a href="#cb29-64" aria-hidden="true" tabindex="-1"></a>            <span class="pp">assert_eq!</span>(flipper<span class="op">.</span>get()<span class="op">,</span> <span class="cn">true</span>)<span class="op">;</span></span>
<span id="cb29-65"><a href="#cb29-65" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb29-66"><a href="#cb29-66" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb29-67"><a href="#cb29-67" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-68"><a href="#cb29-68" aria-hidden="true" tabindex="-1"></a>    <span class="co">/// End-to-end tests that deploy the contract to a test node</span></span>
<span id="cb29-69"><a href="#cb29-69" aria-hidden="true" tabindex="-1"></a>    <span class="co">/// </span></span>
<span id="cb29-70"><a href="#cb29-70" aria-hidden="true" tabindex="-1"></a>    <span class="co">/// These tests verify the complete deployment and interaction cycle</span></span>
<span id="cb29-71"><a href="#cb29-71" aria-hidden="true" tabindex="-1"></a>    <span class="at">#[</span>cfg<span class="at">(</span>all<span class="at">(</span>test<span class="op">,</span> feature <span class="op">=</span> <span class="st">&quot;e2e-tests&quot;</span><span class="at">))]</span></span>
<span id="cb29-72"><a href="#cb29-72" aria-hidden="true" tabindex="-1"></a>    <span class="kw">mod</span> e2e_tests <span class="op">{</span></span>
<span id="cb29-73"><a href="#cb29-73" aria-hidden="true" tabindex="-1"></a>        <span class="kw">use</span> <span class="kw">super</span><span class="pp">::</span><span class="op">*;</span></span>
<span id="cb29-74"><a href="#cb29-74" aria-hidden="true" tabindex="-1"></a>        <span class="kw">use</span> <span class="pp">ink_e2e::</span>build_message<span class="op">;</span></span>
<span id="cb29-75"><a href="#cb29-75" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-76"><a href="#cb29-76" aria-hidden="true" tabindex="-1"></a>        <span class="kw">type</span> E2EResult<span class="op">&lt;</span>T<span class="op">&gt;</span> <span class="op">=</span> <span class="pp">std::result::</span><span class="dt">Result</span><span class="op">&lt;</span>T<span class="op">,</span> <span class="dt">Box</span><span class="op">&lt;</span><span class="kw">dyn</span> <span class="pp">std::error::</span><span class="bu">Error</span><span class="op">&gt;&gt;;</span></span>
<span id="cb29-77"><a href="#cb29-77" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-78"><a href="#cb29-78" aria-hidden="true" tabindex="-1"></a>        <span class="at">#[</span><span class="pp">ink_e2e::</span>test<span class="at">]</span></span>
<span id="cb29-79"><a href="#cb29-79" aria-hidden="true" tabindex="-1"></a>        <span class="kw">async</span> <span class="kw">fn</span> default_works(<span class="kw">mut</span> client<span class="op">:</span> <span class="pp">ink_e2e::</span>Client<span class="op">&lt;</span>C<span class="op">,</span> E<span class="op">&gt;</span>) <span class="op">-&gt;</span> E2EResult<span class="op">&lt;</span>()<span class="op">&gt;</span> <span class="op">{</span></span>
<span id="cb29-80"><a href="#cb29-80" aria-hidden="true" tabindex="-1"></a>            <span class="co">// Instantiate the contract with default constructor</span></span>
<span id="cb29-81"><a href="#cb29-81" aria-hidden="true" tabindex="-1"></a>            <span class="kw">let</span> constructor <span class="op">=</span> <span class="pp">FlipperRef::</span><span class="kw">default</span>()<span class="op">;</span></span>
<span id="cb29-82"><a href="#cb29-82" aria-hidden="true" tabindex="-1"></a>            <span class="kw">let</span> contract_account_id <span class="op">=</span> client</span>
<span id="cb29-83"><a href="#cb29-83" aria-hidden="true" tabindex="-1"></a>                <span class="op">.</span>instantiate(<span class="st">&quot;flipper&quot;</span><span class="op">,</span> <span class="op">&amp;</span><span class="pp">ink_e2e::</span>alice()<span class="op">,</span> constructor<span class="op">,</span> <span class="dv">0</span><span class="op">,</span> <span class="cn">None</span>)</span>
<span id="cb29-84"><a href="#cb29-84" aria-hidden="true" tabindex="-1"></a>                <span class="op">.</span><span class="kw">await</span></span>
<span id="cb29-85"><a href="#cb29-85" aria-hidden="true" tabindex="-1"></a>                <span class="op">.</span>expect(<span class="st">&quot;instantiate failed&quot;</span>)</span>
<span id="cb29-86"><a href="#cb29-86" aria-hidden="true" tabindex="-1"></a>                <span class="op">.</span>account_id<span class="op">;</span></span>
<span id="cb29-87"><a href="#cb29-87" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-88"><a href="#cb29-88" aria-hidden="true" tabindex="-1"></a>            <span class="co">// Call the get message to verify initial state</span></span>
<span id="cb29-89"><a href="#cb29-89" aria-hidden="true" tabindex="-1"></a>            <span class="kw">let</span> get <span class="op">=</span> <span class="pp">build_message::</span><span class="op">&lt;</span>FlipperRef<span class="op">&gt;</span>(contract_account_id<span class="op">.</span>clone())</span>
<span id="cb29-90"><a href="#cb29-90" aria-hidden="true" tabindex="-1"></a>                <span class="op">.</span>call(<span class="op">|</span>flipper<span class="op">|</span> flipper<span class="op">.</span>get())<span class="op">;</span></span>
<span id="cb29-91"><a href="#cb29-91" aria-hidden="true" tabindex="-1"></a>            <span class="kw">let</span> get_result <span class="op">=</span> client<span class="op">.</span>call_dry_run(<span class="op">&amp;</span><span class="pp">ink_e2e::</span>alice()<span class="op">,</span> <span class="op">&amp;</span>get<span class="op">,</span> <span class="dv">0</span><span class="op">,</span> <span class="cn">None</span>)<span class="op">.</span><span class="kw">await</span><span class="op">;</span></span>
<span id="cb29-92"><a href="#cb29-92" aria-hidden="true" tabindex="-1"></a>            <span class="pp">assert_eq!</span>(get_result<span class="op">.</span>return_value()<span class="op">,</span> <span class="cn">false</span>)<span class="op">;</span></span>
<span id="cb29-93"><a href="#cb29-93" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-94"><a href="#cb29-94" aria-hidden="true" tabindex="-1"></a>            <span class="cn">Ok</span>(())</span>
<span id="cb29-95"><a href="#cb29-95" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb29-96"><a href="#cb29-96" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-97"><a href="#cb29-97" aria-hidden="true" tabindex="-1"></a>        <span class="at">#[</span><span class="pp">ink_e2e::</span>test<span class="at">]</span></span>
<span id="cb29-98"><a href="#cb29-98" aria-hidden="true" tabindex="-1"></a>        <span class="kw">async</span> <span class="kw">fn</span> it_works(<span class="kw">mut</span> client<span class="op">:</span> <span class="pp">ink_e2e::</span>Client<span class="op">&lt;</span>C<span class="op">,</span> E<span class="op">&gt;</span>) <span class="op">-&gt;</span> E2EResult<span class="op">&lt;</span>()<span class="op">&gt;</span> <span class="op">{</span></span>
<span id="cb29-99"><a href="#cb29-99" aria-hidden="true" tabindex="-1"></a>            <span class="co">// Instantiate the contract</span></span>
<span id="cb29-100"><a href="#cb29-100" aria-hidden="true" tabindex="-1"></a>            <span class="kw">let</span> constructor <span class="op">=</span> <span class="pp">FlipperRef::</span>new(<span class="cn">false</span>)<span class="op">;</span></span>
<span id="cb29-101"><a href="#cb29-101" aria-hidden="true" tabindex="-1"></a>            <span class="kw">let</span> contract_account_id <span class="op">=</span> client</span>
<span id="cb29-102"><a href="#cb29-102" aria-hidden="true" tabindex="-1"></a>                <span class="op">.</span>instantiate(<span class="st">&quot;flipper&quot;</span><span class="op">,</span> <span class="op">&amp;</span><span class="pp">ink_e2e::</span>alice()<span class="op">,</span> constructor<span class="op">,</span> <span class="dv">0</span><span class="op">,</span> <span class="cn">None</span>)</span>
<span id="cb29-103"><a href="#cb29-103" aria-hidden="true" tabindex="-1"></a>                <span class="op">.</span><span class="kw">await</span></span>
<span id="cb29-104"><a href="#cb29-104" aria-hidden="true" tabindex="-1"></a>                <span class="op">.</span>expect(<span class="st">&quot;instantiate failed&quot;</span>)</span>
<span id="cb29-105"><a href="#cb29-105" aria-hidden="true" tabindex="-1"></a>                <span class="op">.</span>account_id<span class="op">;</span></span>
<span id="cb29-106"><a href="#cb29-106" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-107"><a href="#cb29-107" aria-hidden="true" tabindex="-1"></a>            <span class="co">// Verify initial state</span></span>
<span id="cb29-108"><a href="#cb29-108" aria-hidden="true" tabindex="-1"></a>            <span class="kw">let</span> get <span class="op">=</span> <span class="pp">build_message::</span><span class="op">&lt;</span>FlipperRef<span class="op">&gt;</span>(contract_account_id<span class="op">.</span>clone())</span>
<span id="cb29-109"><a href="#cb29-109" aria-hidden="true" tabindex="-1"></a>                <span class="op">.</span>call(<span class="op">|</span>flipper<span class="op">|</span> flipper<span class="op">.</span>get())<span class="op">;</span></span>
<span id="cb29-110"><a href="#cb29-110" aria-hidden="true" tabindex="-1"></a>            <span class="kw">let</span> get_result <span class="op">=</span> client<span class="op">.</span>call_dry_run(<span class="op">&amp;</span><span class="pp">ink_e2e::</span>alice()<span class="op">,</span> <span class="op">&amp;</span>get<span class="op">,</span> <span class="dv">0</span><span class="op">,</span> <span class="cn">None</span>)<span class="op">.</span><span class="kw">await</span><span class="op">;</span></span>
<span id="cb29-111"><a href="#cb29-111" aria-hidden="true" tabindex="-1"></a>            <span class="pp">assert_eq!</span>(get_result<span class="op">.</span>return_value()<span class="op">,</span> <span class="cn">false</span>)<span class="op">;</span></span>
<span id="cb29-112"><a href="#cb29-112" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-113"><a href="#cb29-113" aria-hidden="true" tabindex="-1"></a>            <span class="co">// Flip the value</span></span>
<span id="cb29-114"><a href="#cb29-114" aria-hidden="true" tabindex="-1"></a>            <span class="kw">let</span> flip <span class="op">=</span> <span class="pp">build_message::</span><span class="op">&lt;</span>FlipperRef<span class="op">&gt;</span>(contract_account_id<span class="op">.</span>clone())</span>
<span id="cb29-115"><a href="#cb29-115" aria-hidden="true" tabindex="-1"></a>                <span class="op">.</span>call(<span class="op">|</span>flipper<span class="op">|</span> flipper<span class="op">.</span>flip())<span class="op">;</span></span>
<span id="cb29-116"><a href="#cb29-116" aria-hidden="true" tabindex="-1"></a>            <span class="kw">let</span> _flip_result <span class="op">=</span> client</span>
<span id="cb29-117"><a href="#cb29-117" aria-hidden="true" tabindex="-1"></a>                <span class="op">.</span>call(<span class="op">&amp;</span><span class="pp">ink_e2e::</span>alice()<span class="op">,</span> flip<span class="op">,</span> <span class="dv">0</span><span class="op">,</span> <span class="cn">None</span>)</span>
<span id="cb29-118"><a href="#cb29-118" aria-hidden="true" tabindex="-1"></a>                <span class="op">.</span><span class="kw">await</span></span>
<span id="cb29-119"><a href="#cb29-119" aria-hidden="true" tabindex="-1"></a>                <span class="op">.</span>expect(<span class="st">&quot;flip failed&quot;</span>)<span class="op">;</span></span>
<span id="cb29-120"><a href="#cb29-120" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-121"><a href="#cb29-121" aria-hidden="true" tabindex="-1"></a>            <span class="co">// Verify the value was flipped</span></span>
<span id="cb29-122"><a href="#cb29-122" aria-hidden="true" tabindex="-1"></a>            <span class="kw">let</span> get <span class="op">=</span> <span class="pp">build_message::</span><span class="op">&lt;</span>FlipperRef<span class="op">&gt;</span>(contract_account_id<span class="op">.</span>clone())</span>
<span id="cb29-123"><a href="#cb29-123" aria-hidden="true" tabindex="-1"></a>                <span class="op">.</span>call(<span class="op">|</span>flipper<span class="op">|</span> flipper<span class="op">.</span>get())<span class="op">;</span></span>
<span id="cb29-124"><a href="#cb29-124" aria-hidden="true" tabindex="-1"></a>            <span class="kw">let</span> get_result <span class="op">=</span> client<span class="op">.</span>call_dry_run(<span class="op">&amp;</span><span class="pp">ink_e2e::</span>alice()<span class="op">,</span> <span class="op">&amp;</span>get<span class="op">,</span> <span class="dv">0</span><span class="op">,</span> <span class="cn">None</span>)<span class="op">.</span><span class="kw">await</span><span class="op">;</span></span>
<span id="cb29-125"><a href="#cb29-125" aria-hidden="true" tabindex="-1"></a>            <span class="pp">assert_eq!</span>(get_result<span class="op">.</span>return_value()<span class="op">,</span> <span class="cn">true</span>)<span class="op">;</span></span>
<span id="cb29-126"><a href="#cb29-126" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-127"><a href="#cb29-127" aria-hidden="true" tabindex="-1"></a>            <span class="cn">Ok</span>(())</span>
<span id="cb29-128"><a href="#cb29-128" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb29-129"><a href="#cb29-129" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb29-130"><a href="#cb29-130" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<h2 id="macro-deep-dive-understanding-ink-attributes">Macro Deep Dive:
Understanding ink! Attributes</h2>
<p>ink! uses procedural macros to transform standard Rust code into
smart contract components. Let’s examine each macro in detail.</p>
<h3 id="inkcontract">#[ink::contract]</h3>
<div class="sourceCode" id="cb30"><pre
class="sourceCode rust"><code class="sourceCode rust"><span id="cb30-1"><a href="#cb30-1" aria-hidden="true" tabindex="-1"></a><span class="at">#[</span><span class="pp">ink::</span>contract<span class="at">]</span></span>
<span id="cb30-2"><a href="#cb30-2" aria-hidden="true" tabindex="-1"></a><span class="kw">mod</span> flipper <span class="op">{</span></span>
<span id="cb30-3"><a href="#cb30-3" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Contract definition goes here</span></span>
<span id="cb30-4"><a href="#cb30-4" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<p>The <code>#[ink::contract]</code> macro is the entry point that:</p>
<ol type="1">
<li><strong>Establishes the contract module</strong>: Creates a
namespace for the contract</li>
<li><strong>Generates boilerplate code</strong>: Adds necessary traits
and implementations</li>
<li><strong>Enables ink! macros</strong>: Makes other ink! macros
available within the module</li>
<li><strong>Creates the contract ABI</strong>: Generates metadata for
external interaction</li>
</ol>
<p>Behind the scenes, this macro generates: - Implementation of the
<code>ink::codegen::ContractCallBuilder</code> trait - Storage layout
information for the runtime - Message dispatch logic for incoming calls
- Metadata structure describing the contract interface</p>
<h3 id="inkstorage">#[ink(storage)]</h3>
<div class="sourceCode" id="cb31"><pre
class="sourceCode rust"><code class="sourceCode rust"><span id="cb31-1"><a href="#cb31-1" aria-hidden="true" tabindex="-1"></a><span class="at">#[</span>ink<span class="at">(</span>storage<span class="at">)]</span></span>
<span id="cb31-2"><a href="#cb31-2" aria-hidden="true" tabindex="-1"></a><span class="kw">pub</span> <span class="kw">struct</span> Flipper <span class="op">{</span></span>
<span id="cb31-3"><a href="#cb31-3" aria-hidden="true" tabindex="-1"></a>    value<span class="op">:</span> <span class="dt">bool</span><span class="op">,</span></span>
<span id="cb31-4"><a href="#cb31-4" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<p>The storage macro transforms a regular Rust struct into the
contract’s persistent state:</p>
<p><strong>What it generates:</strong> - <strong>Storage key
mapping</strong>: Each field gets a unique storage key -
<strong>Serialization code</strong>: Implements SCALE encoding/decoding
for persistence - <strong>Storage access methods</strong>: Creates
optimized read/write operations - <strong>Root key computation</strong>:
Establishes the storage root for the contract</p>
<p><strong>Storage Layout:</strong></p>
<pre><code>Storage Root: 0x00000000...
├── value: Key(0x00000001) -&gt; bool
└── (future fields would get 0x00000002, 0x00000003, etc.)</code></pre>
<p><strong>Critical constraints:</strong> - Only <strong>one</strong>
struct per contract can have <code>#[ink(storage)]</code> - All fields
must implement <code>scale::Encode</code> and <code>scale::Decode</code>
- The struct becomes the single source of truth for contract state</p>
<h3 id="inkconstructor">#[ink(constructor)]</h3>
<div class="sourceCode" id="cb33"><pre
class="sourceCode rust"><code class="sourceCode rust"><span id="cb33-1"><a href="#cb33-1" aria-hidden="true" tabindex="-1"></a><span class="at">#[</span>ink<span class="at">(</span>constructor<span class="at">)]</span></span>
<span id="cb33-2"><a href="#cb33-2" aria-hidden="true" tabindex="-1"></a><span class="kw">pub</span> <span class="kw">fn</span> new(init_value<span class="op">:</span> <span class="dt">bool</span>) <span class="op">-&gt;</span> <span class="dt">Self</span> <span class="op">{</span></span>
<span id="cb33-3"><a href="#cb33-3" aria-hidden="true" tabindex="-1"></a>    <span class="dt">Self</span> <span class="op">{</span> value<span class="op">:</span> init_value <span class="op">}</span></span>
<span id="cb33-4"><a href="#cb33-4" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<p>Constructor macros define how contracts are initialized:</p>
<p><strong>Generated functionality:</strong> - <strong>Deployment
dispatch</strong>: Routes deployment calls to the correct constructor -
<strong>State initialization</strong>: Ensures storage is properly set
up - <strong>Return value handling</strong>: Manages the contract
instance creation - <strong>Gas accounting</strong>: Tracks gas usage
during deployment</p>
<p><strong>Key characteristics:</strong> - Must return <code>Self</code>
(the storage struct) - Can accept parameters for customized
initialization - Multiple constructors are allowed (overloading) -
Cannot access <code>self.env()</code> (no environment context yet)</p>
<p><strong>Constructor vs. Function:</strong></p>
<div class="sourceCode" id="cb34"><pre
class="sourceCode rust"><code class="sourceCode rust"><span id="cb34-1"><a href="#cb34-1" aria-hidden="true" tabindex="-1"></a><span class="co">// Constructor - called once during deployment</span></span>
<span id="cb34-2"><a href="#cb34-2" aria-hidden="true" tabindex="-1"></a><span class="at">#[</span>ink<span class="at">(</span>constructor<span class="at">)]</span></span>
<span id="cb34-3"><a href="#cb34-3" aria-hidden="true" tabindex="-1"></a><span class="kw">pub</span> <span class="kw">fn</span> new() <span class="op">-&gt;</span> <span class="dt">Self</span> <span class="op">{</span></span>
<span id="cb34-4"><a href="#cb34-4" aria-hidden="true" tabindex="-1"></a>    <span class="dt">Self</span> <span class="op">{</span> value<span class="op">:</span> <span class="cn">false</span> <span class="op">}</span></span>
<span id="cb34-5"><a href="#cb34-5" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb34-6"><a href="#cb34-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-7"><a href="#cb34-7" aria-hidden="true" tabindex="-1"></a><span class="co">// Message - called after deployment</span></span>
<span id="cb34-8"><a href="#cb34-8" aria-hidden="true" tabindex="-1"></a><span class="at">#[</span>ink<span class="at">(</span>message<span class="at">)]</span></span>
<span id="cb34-9"><a href="#cb34-9" aria-hidden="true" tabindex="-1"></a><span class="kw">pub</span> <span class="kw">fn</span> initialize(<span class="op">&amp;</span><span class="kw">mut</span> <span class="kw">self</span>) <span class="op">{</span></span>
<span id="cb34-10"><a href="#cb34-10" aria-hidden="true" tabindex="-1"></a>    <span class="kw">self</span><span class="op">.</span>value <span class="op">=</span> <span class="cn">false</span><span class="op">;</span> <span class="co">// This modifies existing state</span></span>
<span id="cb34-11"><a href="#cb34-11" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<h3 id="inkmessage">#[ink(message)]</h3>
<div class="sourceCode" id="cb35"><pre
class="sourceCode rust"><code class="sourceCode rust"><span id="cb35-1"><a href="#cb35-1" aria-hidden="true" tabindex="-1"></a><span class="co">// Immutable message (read-only)</span></span>
<span id="cb35-2"><a href="#cb35-2" aria-hidden="true" tabindex="-1"></a><span class="at">#[</span>ink<span class="at">(</span>message<span class="at">)]</span></span>
<span id="cb35-3"><a href="#cb35-3" aria-hidden="true" tabindex="-1"></a><span class="kw">pub</span> <span class="kw">fn</span> get(<span class="op">&amp;</span><span class="kw">self</span>) <span class="op">-&gt;</span> <span class="dt">bool</span> <span class="op">{</span></span>
<span id="cb35-4"><a href="#cb35-4" aria-hidden="true" tabindex="-1"></a>    <span class="kw">self</span><span class="op">.</span>value</span>
<span id="cb35-5"><a href="#cb35-5" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb35-6"><a href="#cb35-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-7"><a href="#cb35-7" aria-hidden="true" tabindex="-1"></a><span class="co">// Mutable message (can modify state)</span></span>
<span id="cb35-8"><a href="#cb35-8" aria-hidden="true" tabindex="-1"></a><span class="at">#[</span>ink<span class="at">(</span>message<span class="at">)]</span></span>
<span id="cb35-9"><a href="#cb35-9" aria-hidden="true" tabindex="-1"></a><span class="kw">pub</span> <span class="kw">fn</span> flip(<span class="op">&amp;</span><span class="kw">mut</span> <span class="kw">self</span>) <span class="op">{</span></span>
<span id="cb35-10"><a href="#cb35-10" aria-hidden="true" tabindex="-1"></a>    <span class="kw">self</span><span class="op">.</span>value <span class="op">=</span> <span class="op">!</span><span class="kw">self</span><span class="op">.</span>value<span class="op">;</span></span>
<span id="cb35-11"><a href="#cb35-11" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<p>Message macros define the contract’s public API:</p>
<p><strong>Generated functionality:</strong> - <strong>Message
dispatch</strong>: Routes external calls to the correct method -
<strong>Parameter serialization</strong>: Handles input/output encoding
- <strong>Gas metering</strong>: Tracks and limits execution cost -
<strong>Environment access</strong>: Provides <code>self.env()</code>
for blockchain interaction</p>
<p><strong>Immutable vs. Mutable Messages:</strong></p>
<table>
<colgroup>
<col style="width: 16%" />
<col style="width: 38%" />
<col style="width: 44%" />
</colgroup>
<thead>
<tr>
<th>Aspect</th>
<th><code>&amp;self</code> (Immutable)</th>
<th><code>&amp;mut self</code> (Mutable)</th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>State changes</strong></td>
<td>Not allowed</td>
<td>Allowed</td>
</tr>
<tr>
<td><strong>Gas cost</strong></td>
<td>Lower (no state writes)</td>
<td>Higher (potential state writes)</td>
</tr>
<tr>
<td><strong>Concurrency</strong></td>
<td>Multiple simultaneous calls</td>
<td>Sequential execution</td>
</tr>
<tr>
<td><strong>Rollback</strong></td>
<td>N/A</td>
<td>State reverts on error</td>
</tr>
</tbody>
</table>
<h3 id="conditional-compilation-deep-dive">Conditional Compilation Deep
Dive</h3>
<p>The <code>#![cfg_attr(not(feature = "std"), no_std)]</code> attribute
manages dual compilation modes:</p>
<p><strong>Standard Mode (std enabled):</strong></p>
<div class="sourceCode" id="cb36"><pre
class="sourceCode rust"><code class="sourceCode rust"><span id="cb36-1"><a href="#cb36-1" aria-hidden="true" tabindex="-1"></a><span class="co">// Full standard library available</span></span>
<span id="cb36-2"><a href="#cb36-2" aria-hidden="true" tabindex="-1"></a><span class="kw">use</span> <span class="pp">std::collections::</span>HashMap<span class="op">;</span></span>
<span id="cb36-3"><a href="#cb36-3" aria-hidden="true" tabindex="-1"></a><span class="kw">use</span> <span class="pp">std::vec::</span><span class="dt">Vec</span><span class="op">;</span></span>
<span id="cb36-4"><a href="#cb36-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-5"><a href="#cb36-5" aria-hidden="true" tabindex="-1"></a><span class="at">#[</span>cfg<span class="at">(</span>feature <span class="op">=</span> <span class="st">&quot;std&quot;</span><span class="at">)]</span></span>
<span id="cb36-6"><a href="#cb36-6" aria-hidden="true" tabindex="-1"></a><span class="kw">fn</span> debug_function() <span class="op">{</span></span>
<span id="cb36-7"><a href="#cb36-7" aria-hidden="true" tabindex="-1"></a>    <span class="pp">println!</span>(<span class="st">&quot;Debug information&quot;</span>)<span class="op">;</span> <span class="co">// Available in std mode</span></span>
<span id="cb36-8"><a href="#cb36-8" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<p><strong>No-std Mode (contract compilation):</strong></p>
<div class="sourceCode" id="cb37"><pre
class="sourceCode rust"><code class="sourceCode rust"><span id="cb37-1"><a href="#cb37-1" aria-hidden="true" tabindex="-1"></a><span class="co">// Limited to core and alloc</span></span>
<span id="cb37-2"><a href="#cb37-2" aria-hidden="true" tabindex="-1"></a><span class="kw">use</span> <span class="pp">ink::prelude::vec::</span><span class="dt">Vec</span><span class="op">;</span></span>
<span id="cb37-3"><a href="#cb37-3" aria-hidden="true" tabindex="-1"></a><span class="kw">use</span> <span class="pp">ink::prelude::collections::</span>BTreeMap<span class="op">;</span></span>
<span id="cb37-4"><a href="#cb37-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-5"><a href="#cb37-5" aria-hidden="true" tabindex="-1"></a><span class="at">#[</span>cfg<span class="at">(</span>not<span class="at">(</span>feature <span class="op">=</span> <span class="st">&quot;std&quot;</span><span class="at">))]</span></span>
<span id="cb37-6"><a href="#cb37-6" aria-hidden="true" tabindex="-1"></a><span class="kw">fn</span> optimized_function() <span class="op">{</span></span>
<span id="cb37-7"><a href="#cb37-7" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Code optimized for WASM execution</span></span>
<span id="cb37-8"><a href="#cb37-8" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<p><strong>Feature-gated dependencies:</strong></p>
<div class="sourceCode" id="cb38"><pre
class="sourceCode toml"><code class="sourceCode toml"><span id="cb38-1"><a href="#cb38-1" aria-hidden="true" tabindex="-1"></a><span class="kw">[dependencies]</span></span>
<span id="cb38-2"><a href="#cb38-2" aria-hidden="true" tabindex="-1"></a><span class="dt">ink</span> <span class="op">=</span> <span class="op">{ </span><span class="dt">version</span><span class="op"> =</span> <span class="st">&quot;4.3&quot;</span><span class="op">, </span><span class="dt">default-features</span><span class="op"> =</span> <span class="cn">false</span><span class="op"> }</span></span>
<span id="cb38-3"><a href="#cb38-3" aria-hidden="true" tabindex="-1"></a><span class="dt">scale</span> <span class="op">=</span> <span class="op">{ </span><span class="dt">version</span><span class="op"> =</span> <span class="st">&quot;3&quot;</span><span class="op">, </span><span class="dt">default-features</span><span class="op"> =</span> <span class="cn">false</span><span class="op">, </span><span class="dt">features</span><span class="op"> =</span> <span class="op">[</span><span class="st">&quot;derive&quot;</span><span class="op">] }</span></span>
<span id="cb38-4"><a href="#cb38-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-5"><a href="#cb38-5" aria-hidden="true" tabindex="-1"></a><span class="kw">[features]</span></span>
<span id="cb38-6"><a href="#cb38-6" aria-hidden="true" tabindex="-1"></a><span class="dt">std</span> <span class="op">=</span> <span class="op">[</span></span>
<span id="cb38-7"><a href="#cb38-7" aria-hidden="true" tabindex="-1"></a>    <span class="st">&quot;ink/std&quot;</span><span class="op">,</span></span>
<span id="cb38-8"><a href="#cb38-8" aria-hidden="true" tabindex="-1"></a>    <span class="st">&quot;scale/std&quot;</span><span class="op">,</span></span>
<span id="cb38-9"><a href="#cb38-9" aria-hidden="true" tabindex="-1"></a><span class="op">]</span></span></code></pre></div>
<h2 id="the-compilation-pipeline-from-rust-to-wasm">The Compilation
Pipeline: From Rust to WASM</h2>
<p>Understanding the compilation process helps debug issues and optimize
contracts.</p>
<h3 id="step-1-cargo-contract-build">Step 1: Cargo Contract Build</h3>
<div class="sourceCode" id="cb39"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb39-1"><a href="#cb39-1" aria-hidden="true" tabindex="-1"></a><span class="ex">cargo</span> contract build</span></code></pre></div>
<p>This command executes several phases:</p>
<h4 id="phase-1-rust-compilation">Phase 1: Rust Compilation</h4>
<div class="sourceCode" id="cb40"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb40-1"><a href="#cb40-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Equivalent to:</span></span>
<span id="cb40-2"><a href="#cb40-2" aria-hidden="true" tabindex="-1"></a><span class="ex">cargo</span> build <span class="at">--target</span> wasm32-unknown-unknown <span class="at">--release</span></span></code></pre></div>
<p><strong>Compiler optimizations applied:</strong> - <strong>Dead code
elimination</strong>: Removes unused functions -
<strong>Inlining</strong>: Reduces function call overhead -
<strong>Constant folding</strong>: Evaluates constants at compile time -
<strong>Loop optimization</strong>: Unrolls small loops for
performance</p>
<h4 id="phase-2-wasm-optimization">Phase 2: WASM Optimization</h4>
<div class="sourceCode" id="cb41"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb41-1"><a href="#cb41-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Using wasm-opt (part of Binaryen toolkit)</span></span>
<span id="cb41-2"><a href="#cb41-2" aria-hidden="true" tabindex="-1"></a><span class="ex">wasm-opt</span> target/wasm32-unknown-unknown/release/flipper.wasm <span class="dt">\</span></span>
<span id="cb41-3"><a href="#cb41-3" aria-hidden="true" tabindex="-1"></a>    <span class="at">-o</span> optimized.wasm <span class="dt">\</span></span>
<span id="cb41-4"><a href="#cb41-4" aria-hidden="true" tabindex="-1"></a>    <span class="at">-Oz</span>  <span class="co"># Optimize for size</span></span></code></pre></div>
<p><strong>Optimizations include:</strong> - <strong>Size
reduction</strong>: Removes metadata and debug info -
<strong>Instruction optimization</strong>: Uses more efficient WASM
instructions - <strong>Memory layout optimization</strong>: Improves
cache locality</p>
<h4 id="phase-3-metadata-generation">Phase 3: Metadata Generation</h4>
<p>The build process generates contract metadata in JSON format:</p>
<div class="sourceCode" id="cb42"><pre
class="sourceCode json"><code class="sourceCode json"><span id="cb42-1"><a href="#cb42-1" aria-hidden="true" tabindex="-1"></a><span class="fu">{</span></span>
<span id="cb42-2"><a href="#cb42-2" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&quot;source&quot;</span><span class="fu">:</span> <span class="fu">{</span></span>
<span id="cb42-3"><a href="#cb42-3" aria-hidden="true" tabindex="-1"></a>    <span class="dt">&quot;hash&quot;</span><span class="fu">:</span> <span class="st">&quot;0x1234...&quot;</span><span class="fu">,</span></span>
<span id="cb42-4"><a href="#cb42-4" aria-hidden="true" tabindex="-1"></a>    <span class="dt">&quot;language&quot;</span><span class="fu">:</span> <span class="st">&quot;ink! 4.3.0&quot;</span><span class="fu">,</span></span>
<span id="cb42-5"><a href="#cb42-5" aria-hidden="true" tabindex="-1"></a>    <span class="dt">&quot;compiler&quot;</span><span class="fu">:</span> <span class="st">&quot;rustc 1.75.0&quot;</span></span>
<span id="cb42-6"><a href="#cb42-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">},</span></span>
<span id="cb42-7"><a href="#cb42-7" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&quot;contract&quot;</span><span class="fu">:</span> <span class="fu">{</span></span>
<span id="cb42-8"><a href="#cb42-8" aria-hidden="true" tabindex="-1"></a>    <span class="dt">&quot;name&quot;</span><span class="fu">:</span> <span class="st">&quot;flipper&quot;</span><span class="fu">,</span></span>
<span id="cb42-9"><a href="#cb42-9" aria-hidden="true" tabindex="-1"></a>    <span class="dt">&quot;version&quot;</span><span class="fu">:</span> <span class="st">&quot;0.1.0&quot;</span><span class="fu">,</span></span>
<span id="cb42-10"><a href="#cb42-10" aria-hidden="true" tabindex="-1"></a>    <span class="dt">&quot;authors&quot;</span><span class="fu">:</span> <span class="ot">[</span><span class="st">&quot;Developer&quot;</span><span class="ot">]</span></span>
<span id="cb42-11"><a href="#cb42-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">},</span></span>
<span id="cb42-12"><a href="#cb42-12" aria-hidden="true" tabindex="-1"></a>  <span class="dt">&quot;spec&quot;</span><span class="fu">:</span> <span class="fu">{</span></span>
<span id="cb42-13"><a href="#cb42-13" aria-hidden="true" tabindex="-1"></a>    <span class="dt">&quot;constructors&quot;</span><span class="fu">:</span> <span class="ot">[</span></span>
<span id="cb42-14"><a href="#cb42-14" aria-hidden="true" tabindex="-1"></a>      <span class="fu">{</span></span>
<span id="cb42-15"><a href="#cb42-15" aria-hidden="true" tabindex="-1"></a>        <span class="dt">&quot;label&quot;</span><span class="fu">:</span> <span class="st">&quot;new&quot;</span><span class="fu">,</span></span>
<span id="cb42-16"><a href="#cb42-16" aria-hidden="true" tabindex="-1"></a>        <span class="dt">&quot;payable&quot;</span><span class="fu">:</span> <span class="kw">false</span><span class="fu">,</span></span>
<span id="cb42-17"><a href="#cb42-17" aria-hidden="true" tabindex="-1"></a>        <span class="dt">&quot;selector&quot;</span><span class="fu">:</span> <span class="st">&quot;0x9bae9d5e&quot;</span><span class="fu">,</span></span>
<span id="cb42-18"><a href="#cb42-18" aria-hidden="true" tabindex="-1"></a>        <span class="dt">&quot;args&quot;</span><span class="fu">:</span> <span class="ot">[</span></span>
<span id="cb42-19"><a href="#cb42-19" aria-hidden="true" tabindex="-1"></a>          <span class="fu">{</span></span>
<span id="cb42-20"><a href="#cb42-20" aria-hidden="true" tabindex="-1"></a>            <span class="dt">&quot;label&quot;</span><span class="fu">:</span> <span class="st">&quot;init_value&quot;</span><span class="fu">,</span></span>
<span id="cb42-21"><a href="#cb42-21" aria-hidden="true" tabindex="-1"></a>            <span class="dt">&quot;type&quot;</span><span class="fu">:</span> <span class="fu">{</span></span>
<span id="cb42-22"><a href="#cb42-22" aria-hidden="true" tabindex="-1"></a>              <span class="dt">&quot;displayName&quot;</span><span class="fu">:</span> <span class="ot">[</span><span class="st">&quot;bool&quot;</span><span class="ot">]</span><span class="fu">,</span></span>
<span id="cb42-23"><a href="#cb42-23" aria-hidden="true" tabindex="-1"></a>              <span class="dt">&quot;type&quot;</span><span class="fu">:</span> <span class="dv">0</span></span>
<span id="cb42-24"><a href="#cb42-24" aria-hidden="true" tabindex="-1"></a>            <span class="fu">}</span></span>
<span id="cb42-25"><a href="#cb42-25" aria-hidden="true" tabindex="-1"></a>          <span class="fu">}</span></span>
<span id="cb42-26"><a href="#cb42-26" aria-hidden="true" tabindex="-1"></a>        <span class="ot">]</span><span class="fu">,</span></span>
<span id="cb42-27"><a href="#cb42-27" aria-hidden="true" tabindex="-1"></a>        <span class="dt">&quot;docs&quot;</span><span class="fu">:</span> <span class="ot">[</span><span class="st">&quot;Constructor that initializes...&quot;</span><span class="ot">]</span></span>
<span id="cb42-28"><a href="#cb42-28" aria-hidden="true" tabindex="-1"></a>      <span class="fu">}</span></span>
<span id="cb42-29"><a href="#cb42-29" aria-hidden="true" tabindex="-1"></a>    <span class="ot">]</span><span class="fu">,</span></span>
<span id="cb42-30"><a href="#cb42-30" aria-hidden="true" tabindex="-1"></a>    <span class="dt">&quot;messages&quot;</span><span class="fu">:</span> <span class="ot">[</span></span>
<span id="cb42-31"><a href="#cb42-31" aria-hidden="true" tabindex="-1"></a>      <span class="fu">{</span></span>
<span id="cb42-32"><a href="#cb42-32" aria-hidden="true" tabindex="-1"></a>        <span class="dt">&quot;label&quot;</span><span class="fu">:</span> <span class="st">&quot;flip&quot;</span><span class="fu">,</span></span>
<span id="cb42-33"><a href="#cb42-33" aria-hidden="true" tabindex="-1"></a>        <span class="dt">&quot;mutates&quot;</span><span class="fu">:</span> <span class="kw">true</span><span class="fu">,</span></span>
<span id="cb42-34"><a href="#cb42-34" aria-hidden="true" tabindex="-1"></a>        <span class="dt">&quot;payable&quot;</span><span class="fu">:</span> <span class="kw">false</span><span class="fu">,</span></span>
<span id="cb42-35"><a href="#cb42-35" aria-hidden="true" tabindex="-1"></a>        <span class="dt">&quot;selector&quot;</span><span class="fu">:</span> <span class="st">&quot;0x633aa551&quot;</span><span class="fu">,</span></span>
<span id="cb42-36"><a href="#cb42-36" aria-hidden="true" tabindex="-1"></a>        <span class="dt">&quot;args&quot;</span><span class="fu">:</span> <span class="ot">[]</span><span class="fu">,</span></span>
<span id="cb42-37"><a href="#cb42-37" aria-hidden="true" tabindex="-1"></a>        <span class="dt">&quot;returnType&quot;</span><span class="fu">:</span> <span class="kw">null</span><span class="fu">,</span></span>
<span id="cb42-38"><a href="#cb42-38" aria-hidden="true" tabindex="-1"></a>        <span class="dt">&quot;docs&quot;</span><span class="fu">:</span> <span class="ot">[</span><span class="st">&quot;Flips the current boolean value&quot;</span><span class="ot">]</span></span>
<span id="cb42-39"><a href="#cb42-39" aria-hidden="true" tabindex="-1"></a>      <span class="fu">}</span></span>
<span id="cb42-40"><a href="#cb42-40" aria-hidden="true" tabindex="-1"></a>    <span class="ot">]</span></span>
<span id="cb42-41"><a href="#cb42-41" aria-hidden="true" tabindex="-1"></a>  <span class="fu">}</span></span>
<span id="cb42-42"><a href="#cb42-42" aria-hidden="true" tabindex="-1"></a><span class="fu">}</span></span></code></pre></div>
<p><strong>Metadata purposes:</strong> - <strong>UI generation</strong>:
Enables automatic UI creation for contract interaction - <strong>Type
safety</strong>: Provides type information for external callers -
<strong>Documentation</strong>: Includes inline documentation for
methods - <strong>Selector mapping</strong>: Maps function selectors to
method names</p>
<h3 id="step-4-bundle-creation">Step 4: Bundle Creation</h3>
<p>The final <code>.contract</code> file combines the WASM binary and
metadata:</p>
<div class="sourceCode" id="cb43"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb43-1"><a href="#cb43-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Bundle structure (simplified)</span></span>
<span id="cb43-2"><a href="#cb43-2" aria-hidden="true" tabindex="-1"></a><span class="ex">flipper.contract</span> = {</span>
<span id="cb43-3"><a href="#cb43-3" aria-hidden="true" tabindex="-1"></a>    <span class="st">&quot;wasm&quot;</span><span class="ex">:</span> <span class="st">&quot;&lt;base64-encoded-wasm-binary&gt;&quot;</span>,</span>
<span id="cb43-4"><a href="#cb43-4" aria-hidden="true" tabindex="-1"></a>    <span class="st">&quot;metadata&quot;</span><span class="ex">:</span> { /<span class="pp">*</span> metadata object <span class="pp">*</span>/ }</span>
<span id="cb43-5"><a href="#cb43-5" aria-hidden="true" tabindex="-1"></a><span class="er">}</span></span></code></pre></div>
<h2 id="build-output-analysis">Build Output Analysis</h2>
<p>Let’s examine the artifacts created by the build process:</p>
<h3 id="directory-structure-after-build">Directory Structure After
Build</h3>
<div class="sourceCode" id="cb44"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb44-1"><a href="#cb44-1" aria-hidden="true" tabindex="-1"></a><span class="fu">ls</span> <span class="at">-la</span> target/ink/</span></code></pre></div>
<pre><code>target/ink/
├── flipper.wasm          # Optimized WebAssembly binary (3.2KB)
├── flipper.json          # Contract metadata (15.7KB)
└── flipper.contract      # Bundle file (18.9KB)</code></pre>
<h3 id="wasm-binary-analysis">WASM Binary Analysis</h3>
<div class="sourceCode" id="cb46"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb46-1"><a href="#cb46-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Examine WASM structure using wasm-objdump</span></span>
<span id="cb46-2"><a href="#cb46-2" aria-hidden="true" tabindex="-1"></a><span class="ex">wasm-objdump</span> <span class="at">-h</span> target/ink/flipper.wasm</span></code></pre></div>
<p>Expected sections:</p>
<pre><code>Sections:
     Type start=0x0000000a end=0x00000023 (size=0x00000019) count: 6
 Function start=0x00000025 end=0x0000002e (size=0x00000009) count: 8
    Table start=0x00000030 end=0x00000035 (size=0x00000005) count: 1
   Memory start=0x00000037 end=0x0000003a (size=0x00000003) count: 1
   Global start=0x0000003c end=0x00000047 (size=0x0000000b) count: 1
   Export start=0x00000049 end=0x000000ce (size=0x00000085) count: 7
     Code start=0x000000d1 end=0x00000c53 (size=0x00000b82) count: 8</code></pre>
<h3 id="gas-estimation">Gas Estimation</h3>
<div class="sourceCode" id="cb48"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb48-1"><a href="#cb48-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Estimate gas usage for contract operations</span></span>
<span id="cb48-2"><a href="#cb48-2" aria-hidden="true" tabindex="-1"></a><span class="ex">cargo</span> contract call <span class="at">--contract</span> <span class="va">$CONTRACT_ADDRESS</span> <span class="dt">\</span></span>
<span id="cb48-3"><a href="#cb48-3" aria-hidden="true" tabindex="-1"></a>                   <span class="at">--message</span> get <span class="dt">\</span></span>
<span id="cb48-4"><a href="#cb48-4" aria-hidden="true" tabindex="-1"></a>                   <span class="at">--dry-run</span></span></code></pre></div>
<p>Typical gas usage for flipper operations: -
<strong>Deployment</strong>: ~150,000 gas - <strong>flip()</strong>:
~8,000 gas - <strong>get()</strong>: ~2,000 gas</p>
<h3 id="memory-layout">Memory Layout</h3>
<p>The contract’s memory layout in WASM:</p>
<pre><code>WASM Memory Layout:
┌─────────────────┐ 0x10000 (64KB)
│   Stack Space   │
├─────────────────┤ 0x8000
│  Contract Data  │
├─────────────────┤ 0x4000
│ Global Variables│
├─────────────────┤ 0x1000
│  Static Data    │
└─────────────────┘ 0x0000</code></pre>
<h2 id="advanced-build-configuration">Advanced Build Configuration</h2>
<h3 id="custom-optimization-settings">Custom Optimization Settings</h3>
<p>Create a <code>.cargo/config.toml</code> file for custom build
settings:</p>
<div class="sourceCode" id="cb50"><pre
class="sourceCode toml"><code class="sourceCode toml"><span id="cb50-1"><a href="#cb50-1" aria-hidden="true" tabindex="-1"></a><span class="kw">[build]</span></span>
<span id="cb50-2"><a href="#cb50-2" aria-hidden="true" tabindex="-1"></a><span class="dt">target</span> <span class="op">=</span> <span class="st">&quot;wasm32-unknown-unknown&quot;</span></span>
<span id="cb50-3"><a href="#cb50-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-4"><a href="#cb50-4" aria-hidden="true" tabindex="-1"></a><span class="kw">[target.wasm32-unknown-unknown]</span></span>
<span id="cb50-5"><a href="#cb50-5" aria-hidden="true" tabindex="-1"></a><span class="dt">rustflags</span> <span class="op">=</span> <span class="op">[</span></span>
<span id="cb50-6"><a href="#cb50-6" aria-hidden="true" tabindex="-1"></a>  <span class="st">&quot;-C&quot;</span><span class="op">,</span> <span class="st">&quot;link-arg=-z&quot;</span><span class="op">,</span></span>
<span id="cb50-7"><a href="#cb50-7" aria-hidden="true" tabindex="-1"></a>  <span class="st">&quot;-C&quot;</span><span class="op">,</span> <span class="st">&quot;link-arg=stack-size=65536&quot;</span><span class="op">,</span></span>
<span id="cb50-8"><a href="#cb50-8" aria-hidden="true" tabindex="-1"></a>  <span class="st">&quot;-C&quot;</span><span class="op">,</span> <span class="st">&quot;link-arg=--import-memory&quot;</span><span class="op">,</span></span>
<span id="cb50-9"><a href="#cb50-9" aria-hidden="true" tabindex="-1"></a>  <span class="st">&quot;-C&quot;</span><span class="op">,</span> <span class="st">&quot;target-feature=+bulk-memory&quot;</span><span class="op">,</span></span>
<span id="cb50-10"><a href="#cb50-10" aria-hidden="true" tabindex="-1"></a><span class="op">]</span></span></code></pre></div>
<h3 id="feature-flags-for-different-builds">Feature Flags for Different
Builds</h3>
<div class="sourceCode" id="cb51"><pre
class="sourceCode toml"><code class="sourceCode toml"><span id="cb51-1"><a href="#cb51-1" aria-hidden="true" tabindex="-1"></a><span class="kw">[features]</span></span>
<span id="cb51-2"><a href="#cb51-2" aria-hidden="true" tabindex="-1"></a><span class="dt">default</span> <span class="op">=</span> <span class="op">[</span><span class="st">&quot;std&quot;</span><span class="op">]</span></span>
<span id="cb51-3"><a href="#cb51-3" aria-hidden="true" tabindex="-1"></a><span class="dt">std</span> <span class="op">=</span> <span class="op">[</span><span class="st">&quot;ink/std&quot;</span><span class="op">]</span></span>
<span id="cb51-4"><a href="#cb51-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-5"><a href="#cb51-5" aria-hidden="true" tabindex="-1"></a><span class="co"># Enable additional optimizations</span></span>
<span id="cb51-6"><a href="#cb51-6" aria-hidden="true" tabindex="-1"></a><span class="dt">aggressive-optimizations</span> <span class="op">=</span> <span class="op">[]</span></span>
<span id="cb51-7"><a href="#cb51-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-8"><a href="#cb51-8" aria-hidden="true" tabindex="-1"></a><span class="co"># Enable debug prints in WASM</span></span>
<span id="cb51-9"><a href="#cb51-9" aria-hidden="true" tabindex="-1"></a><span class="dt">debug-prints</span> <span class="op">=</span> <span class="op">[]</span></span>
<span id="cb51-10"><a href="#cb51-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-11"><a href="#cb51-11" aria-hidden="true" tabindex="-1"></a><span class="co"># Enable ink! allocator debugging</span></span>
<span id="cb51-12"><a href="#cb51-12" aria-hidden="true" tabindex="-1"></a><span class="dt">ink-debug</span> <span class="op">=</span> <span class="op">[</span><span class="st">&quot;ink/ink-debug&quot;</span><span class="op">]</span></span></code></pre></div>
<h3 id="build-scripts-for-complex-projects">Build Scripts for Complex
Projects</h3>
<p>Create a <code>build.sh</code> script for reproducible builds:</p>
<div class="sourceCode" id="cb52"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb52-1"><a href="#cb52-1" aria-hidden="true" tabindex="-1"></a><span class="co">#!/bin/bash</span></span>
<span id="cb52-2"><a href="#cb52-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-3"><a href="#cb52-3" aria-hidden="true" tabindex="-1"></a><span class="co"># Clean previous builds</span></span>
<span id="cb52-4"><a href="#cb52-4" aria-hidden="true" tabindex="-1"></a><span class="ex">cargo</span> contract clean</span>
<span id="cb52-5"><a href="#cb52-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-6"><a href="#cb52-6" aria-hidden="true" tabindex="-1"></a><span class="co"># Build with maximum optimizations</span></span>
<span id="cb52-7"><a href="#cb52-7" aria-hidden="true" tabindex="-1"></a><span class="va">RUSTFLAGS</span><span class="op">=</span><span class="st">&quot;-C target-cpu=mvp -C target-feature=-sign-ext&quot;</span> <span class="dt">\</span></span>
<span id="cb52-8"><a href="#cb52-8" aria-hidden="true" tabindex="-1"></a><span class="ex">cargo</span> contract build <span class="at">--release</span></span>
<span id="cb52-9"><a href="#cb52-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-10"><a href="#cb52-10" aria-hidden="true" tabindex="-1"></a><span class="co"># Verify the build</span></span>
<span id="cb52-11"><a href="#cb52-11" aria-hidden="true" tabindex="-1"></a><span class="bu">echo</span> <span class="st">&quot;Build artifacts:&quot;</span></span>
<span id="cb52-12"><a href="#cb52-12" aria-hidden="true" tabindex="-1"></a><span class="fu">ls</span> <span class="at">-lh</span> target/ink/</span>
<span id="cb52-13"><a href="#cb52-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-14"><a href="#cb52-14" aria-hidden="true" tabindex="-1"></a><span class="co"># Check WASM size</span></span>
<span id="cb52-15"><a href="#cb52-15" aria-hidden="true" tabindex="-1"></a><span class="bu">echo</span> <span class="st">&quot;WASM size: </span><span class="va">$(</span><span class="fu">wc</span> <span class="at">-c</span> <span class="op">&lt;</span> target/ink/flipper.wasm<span class="va">)</span><span class="st"> bytes&quot;</span></span>
<span id="cb52-16"><a href="#cb52-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-17"><a href="#cb52-17" aria-hidden="true" tabindex="-1"></a><span class="co"># Validate metadata</span></span>
<span id="cb52-18"><a href="#cb52-18" aria-hidden="true" tabindex="-1"></a><span class="bu">echo</span> <span class="st">&quot;Validating metadata...&quot;</span></span>
<span id="cb52-19"><a href="#cb52-19" aria-hidden="true" tabindex="-1"></a><span class="ex">cargo</span> contract info target/ink/flipper.contract</span></code></pre></div>
<h2 id="troubleshooting-common-build-issues">Troubleshooting Common
Build Issues</h2>
<h3 id="issue-cannot-find-macro-ink-in-this-scope">Issue: “cannot find
macro <code>ink</code> in this scope”</h3>
<p><strong>Cause</strong>: Missing or incorrect ink! dependency</p>
<p><strong>Solution</strong>:</p>
<div class="sourceCode" id="cb53"><pre
class="sourceCode toml"><code class="sourceCode toml"><span id="cb53-1"><a href="#cb53-1" aria-hidden="true" tabindex="-1"></a><span class="kw">[dependencies]</span></span>
<span id="cb53-2"><a href="#cb53-2" aria-hidden="true" tabindex="-1"></a><span class="dt">ink</span> <span class="op">=</span> <span class="op">{ </span><span class="dt">version</span><span class="op"> =</span> <span class="st">&quot;4.3&quot;</span><span class="op">, </span><span class="dt">default-features</span><span class="op"> =</span> <span class="cn">false</span><span class="op"> }</span></span>
<span id="cb53-3"><a href="#cb53-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-4"><a href="#cb53-4" aria-hidden="true" tabindex="-1"></a><span class="kw">[features]</span></span>
<span id="cb53-5"><a href="#cb53-5" aria-hidden="true" tabindex="-1"></a><span class="dt">std</span> <span class="op">=</span> <span class="op">[</span><span class="st">&quot;ink/std&quot;</span><span class="op">]</span></span></code></pre></div>
<h3 id="issue-trait-bound-mystruct-scaleencode-is-not-satisfied">Issue:
“trait bound <code>MyStruct: scale::Encode</code> is not satisfied”</h3>
<p><strong>Cause</strong>: Custom types in storage must implement SCALE
codecs</p>
<p><strong>Solution</strong>:</p>
<div class="sourceCode" id="cb54"><pre
class="sourceCode rust"><code class="sourceCode rust"><span id="cb54-1"><a href="#cb54-1" aria-hidden="true" tabindex="-1"></a><span class="at">#[</span>derive<span class="at">(</span><span class="pp">scale::</span>Encode<span class="op">,</span> <span class="pp">scale::</span>Decode<span class="at">)]</span></span>
<span id="cb54-2"><a href="#cb54-2" aria-hidden="true" tabindex="-1"></a><span class="at">#[</span>cfg_attr<span class="at">(</span>feature <span class="op">=</span> <span class="st">&quot;std&quot;</span><span class="op">,</span> derive<span class="at">(</span><span class="pp">scale_info::</span>TypeInfo<span class="at">))]</span></span>
<span id="cb54-3"><a href="#cb54-3" aria-hidden="true" tabindex="-1"></a><span class="kw">pub</span> <span class="kw">struct</span> MyStruct <span class="op">{</span></span>
<span id="cb54-4"><a href="#cb54-4" aria-hidden="true" tabindex="-1"></a>    field<span class="op">:</span> <span class="dt">u32</span><span class="op">,</span></span>
<span id="cb54-5"><a href="#cb54-5" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<h3 id="issue-wasm-binary-too-large">Issue: WASM binary too large</h3>
<p><strong>Cause</strong>: Inefficient code or large dependencies</p>
<p><strong>Solutions</strong>: 1. <strong>Remove debug symbols</strong>:
<code>toml    [profile.release]    debug = false</code></p>
<ol start="2" type="1">
<li><p><strong>Enable aggressive optimizations</strong>:</p>
<div class="sourceCode" id="cb55"><pre
class="sourceCode toml"><code class="sourceCode toml"><span id="cb55-1"><a href="#cb55-1" aria-hidden="true" tabindex="-1"></a><span class="kw">[profile.release]</span></span>
<span id="cb55-2"><a href="#cb55-2" aria-hidden="true" tabindex="-1"></a><span class="dt">opt-level</span> <span class="op">=</span> <span class="st">&quot;z&quot;</span></span>
<span id="cb55-3"><a href="#cb55-3" aria-hidden="true" tabindex="-1"></a><span class="dt">lto</span> <span class="op">=</span> <span class="cn">true</span></span>
<span id="cb55-4"><a href="#cb55-4" aria-hidden="true" tabindex="-1"></a><span class="dt">codegen-units</span> <span class="op">=</span> <span class="dv">1</span></span></code></pre></div></li>
<li><p><strong>Review dependencies</strong>: Remove unnecessary
crates</p></li>
</ol>
<h3 id="issue-memory-allocation-failed">Issue: “memory allocation
failed”</h3>
<p><strong>Cause</strong>: Contract exceeds memory limits</p>
<p><strong>Solution</strong>: Increase stack size:</p>
<div class="sourceCode" id="cb56"><pre
class="sourceCode toml"><code class="sourceCode toml"><span id="cb56-1"><a href="#cb56-1" aria-hidden="true" tabindex="-1"></a><span class="kw">[target.wasm32-unknown-unknown]</span></span>
<span id="cb56-2"><a href="#cb56-2" aria-hidden="true" tabindex="-1"></a><span class="dt">rustflags</span> <span class="op">=</span> <span class="op">[</span><span class="st">&quot;-C&quot;</span><span class="op">,</span> <span class="st">&quot;link-arg=-z&quot;</span><span class="op">,</span> <span class="st">&quot;-C&quot;</span><span class="op">,</span> <span class="st">&quot;link-arg=stack-size=131072&quot;</span><span class="op">]</span></span></code></pre></div>
<h2 id="best-practices-for-contract-structure">Best Practices for
Contract Structure</h2>
<h3 id="organize-code-with-modules">1. Organize Code with Modules</h3>
<div class="sourceCode" id="cb57"><pre
class="sourceCode rust"><code class="sourceCode rust"><span id="cb57-1"><a href="#cb57-1" aria-hidden="true" tabindex="-1"></a><span class="at">#[</span><span class="pp">ink::</span>contract<span class="at">]</span></span>
<span id="cb57-2"><a href="#cb57-2" aria-hidden="true" tabindex="-1"></a><span class="kw">mod</span> my_contract <span class="op">{</span></span>
<span id="cb57-3"><a href="#cb57-3" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Keep the storage struct simple</span></span>
<span id="cb57-4"><a href="#cb57-4" aria-hidden="true" tabindex="-1"></a>    <span class="at">#[</span>ink<span class="at">(</span>storage<span class="at">)]</span></span>
<span id="cb57-5"><a href="#cb57-5" aria-hidden="true" tabindex="-1"></a>    <span class="kw">pub</span> <span class="kw">struct</span> MyContract <span class="op">{</span></span>
<span id="cb57-6"><a href="#cb57-6" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Only essential state here</span></span>
<span id="cb57-7"><a href="#cb57-7" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb57-8"><a href="#cb57-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb57-9"><a href="#cb57-9" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Organize complex logic in implementation blocks</span></span>
<span id="cb57-10"><a href="#cb57-10" aria-hidden="true" tabindex="-1"></a>    <span class="kw">impl</span> MyContract <span class="op">{</span></span>
<span id="cb57-11"><a href="#cb57-11" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Constructors first</span></span>
<span id="cb57-12"><a href="#cb57-12" aria-hidden="true" tabindex="-1"></a>        <span class="at">#[</span>ink<span class="at">(</span>constructor<span class="at">)]</span></span>
<span id="cb57-13"><a href="#cb57-13" aria-hidden="true" tabindex="-1"></a>        <span class="kw">pub</span> <span class="kw">fn</span> new() <span class="op">-&gt;</span> <span class="dt">Self</span> <span class="op">{</span> <span class="co">/* ... */</span> <span class="op">}</span></span>
<span id="cb57-14"><a href="#cb57-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb57-15"><a href="#cb57-15" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Public messages next</span></span>
<span id="cb57-16"><a href="#cb57-16" aria-hidden="true" tabindex="-1"></a>        <span class="at">#[</span>ink<span class="at">(</span>message<span class="at">)]</span></span>
<span id="cb57-17"><a href="#cb57-17" aria-hidden="true" tabindex="-1"></a>        <span class="kw">pub</span> <span class="kw">fn</span> public_method(<span class="op">&amp;</span><span class="kw">self</span>) <span class="op">{</span> <span class="co">/* ... */</span> <span class="op">}</span></span>
<span id="cb57-18"><a href="#cb57-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb57-19"><a href="#cb57-19" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Private helper methods last</span></span>
<span id="cb57-20"><a href="#cb57-20" aria-hidden="true" tabindex="-1"></a>        <span class="kw">fn</span> private_helper(<span class="op">&amp;</span><span class="kw">self</span>) <span class="op">{</span> <span class="co">/* ... */</span> <span class="op">}</span></span>
<span id="cb57-21"><a href="#cb57-21" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb57-22"><a href="#cb57-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb57-23"><a href="#cb57-23" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Separate error definitions</span></span>
<span id="cb57-24"><a href="#cb57-24" aria-hidden="true" tabindex="-1"></a>    <span class="at">#[</span>derive<span class="at">(</span><span class="bu">Debug</span><span class="op">,</span> <span class="bu">PartialEq</span><span class="op">,</span> <span class="bu">Eq</span><span class="op">,</span> <span class="pp">scale::</span>Encode<span class="op">,</span> <span class="pp">scale::</span>Decode<span class="at">)]</span></span>
<span id="cb57-25"><a href="#cb57-25" aria-hidden="true" tabindex="-1"></a>    <span class="at">#[</span>cfg_attr<span class="at">(</span>feature <span class="op">=</span> <span class="st">&quot;std&quot;</span><span class="op">,</span> derive<span class="at">(</span><span class="pp">scale_info::</span>TypeInfo<span class="at">))]</span></span>
<span id="cb57-26"><a href="#cb57-26" aria-hidden="true" tabindex="-1"></a>    <span class="kw">pub</span> <span class="kw">enum</span> <span class="bu">Error</span> <span class="op">{</span></span>
<span id="cb57-27"><a href="#cb57-27" aria-hidden="true" tabindex="-1"></a>        CustomError<span class="op">,</span></span>
<span id="cb57-28"><a href="#cb57-28" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb57-29"><a href="#cb57-29" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<h3 id="document-everything">2. Document Everything</h3>
<div class="sourceCode" id="cb58"><pre
class="sourceCode rust"><code class="sourceCode rust"><span id="cb58-1"><a href="#cb58-1" aria-hidden="true" tabindex="-1"></a><span class="co">/// A simple flipper contract for demonstration</span></span>
<span id="cb58-2"><a href="#cb58-2" aria-hidden="true" tabindex="-1"></a><span class="co">/// </span></span>
<span id="cb58-3"><a href="#cb58-3" aria-hidden="true" tabindex="-1"></a><span class="co">/// This contract maintains a boolean value that can be toggled</span></span>
<span id="cb58-4"><a href="#cb58-4" aria-hidden="true" tabindex="-1"></a><span class="co">/// and provides read access to external callers.</span></span>
<span id="cb58-5"><a href="#cb58-5" aria-hidden="true" tabindex="-1"></a><span class="at">#[</span><span class="pp">ink::</span>contract<span class="at">]</span></span>
<span id="cb58-6"><a href="#cb58-6" aria-hidden="true" tabindex="-1"></a><span class="kw">mod</span> flipper <span class="op">{</span></span>
<span id="cb58-7"><a href="#cb58-7" aria-hidden="true" tabindex="-1"></a>    <span class="co">/// The contract&#39;s storage containing a single boolean value</span></span>
<span id="cb58-8"><a href="#cb58-8" aria-hidden="true" tabindex="-1"></a>    <span class="co">/// </span></span>
<span id="cb58-9"><a href="#cb58-9" aria-hidden="true" tabindex="-1"></a>    <span class="co">/// This value represents the current state of the flipper</span></span>
<span id="cb58-10"><a href="#cb58-10" aria-hidden="true" tabindex="-1"></a>    <span class="co">/// and persists across contract calls.</span></span>
<span id="cb58-11"><a href="#cb58-11" aria-hidden="true" tabindex="-1"></a>    <span class="at">#[</span>ink<span class="at">(</span>storage<span class="at">)]</span></span>
<span id="cb58-12"><a href="#cb58-12" aria-hidden="true" tabindex="-1"></a>    <span class="kw">pub</span> <span class="kw">struct</span> Flipper <span class="op">{</span></span>
<span id="cb58-13"><a href="#cb58-13" aria-hidden="true" tabindex="-1"></a>        <span class="co">/// The current boolean state</span></span>
<span id="cb58-14"><a href="#cb58-14" aria-hidden="true" tabindex="-1"></a>        value<span class="op">:</span> <span class="dt">bool</span><span class="op">,</span></span>
<span id="cb58-15"><a href="#cb58-15" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb58-16"><a href="#cb58-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-17"><a href="#cb58-17" aria-hidden="true" tabindex="-1"></a>    <span class="kw">impl</span> Flipper <span class="op">{</span></span>
<span id="cb58-18"><a href="#cb58-18" aria-hidden="true" tabindex="-1"></a>        <span class="co">/// Creates a new flipper contract with the specified initial value</span></span>
<span id="cb58-19"><a href="#cb58-19" aria-hidden="true" tabindex="-1"></a>        <span class="co">/// </span></span>
<span id="cb58-20"><a href="#cb58-20" aria-hidden="true" tabindex="-1"></a>        <span class="co">/// # Arguments</span></span>
<span id="cb58-21"><a href="#cb58-21" aria-hidden="true" tabindex="-1"></a>        <span class="co">/// </span></span>
<span id="cb58-22"><a href="#cb58-22" aria-hidden="true" tabindex="-1"></a>        <span class="co">/// * `init_value` - The initial boolean value for the flipper</span></span>
<span id="cb58-23"><a href="#cb58-23" aria-hidden="true" tabindex="-1"></a>        <span class="co">/// </span></span>
<span id="cb58-24"><a href="#cb58-24" aria-hidden="true" tabindex="-1"></a>        <span class="co">/// # Examples</span></span>
<span id="cb58-25"><a href="#cb58-25" aria-hidden="true" tabindex="-1"></a>        <span class="co">/// </span></span>
<span id="cb58-26"><a href="#cb58-26" aria-hidden="true" tabindex="-1"></a>        <span class="co">/// ```</span></span>
<span id="cb58-27"><a href="#cb58-27" aria-hidden="true" tabindex="-1"></a>        <span class="co">/// let flipper = Flipper::new(true);</span></span>
<span id="cb58-28"><a href="#cb58-28" aria-hidden="true" tabindex="-1"></a>        <span class="co">/// assert_eq!(flipper.get(), true);</span></span>
<span id="cb58-29"><a href="#cb58-29" aria-hidden="true" tabindex="-1"></a>        <span class="co">/// ```</span></span>
<span id="cb58-30"><a href="#cb58-30" aria-hidden="true" tabindex="-1"></a>        <span class="at">#[</span>ink<span class="at">(</span>constructor<span class="at">)]</span></span>
<span id="cb58-31"><a href="#cb58-31" aria-hidden="true" tabindex="-1"></a>        <span class="kw">pub</span> <span class="kw">fn</span> new(init_value<span class="op">:</span> <span class="dt">bool</span>) <span class="op">-&gt;</span> <span class="dt">Self</span> <span class="op">{</span></span>
<span id="cb58-32"><a href="#cb58-32" aria-hidden="true" tabindex="-1"></a>            <span class="dt">Self</span> <span class="op">{</span> value<span class="op">:</span> init_value <span class="op">}</span></span>
<span id="cb58-33"><a href="#cb58-33" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb58-34"><a href="#cb58-34" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb58-35"><a href="#cb58-35" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<h3 id="use-type-aliases-for-clarity">3. Use Type Aliases for
Clarity</h3>
<div class="sourceCode" id="cb59"><pre
class="sourceCode rust"><code class="sourceCode rust"><span id="cb59-1"><a href="#cb59-1" aria-hidden="true" tabindex="-1"></a><span class="at">#[</span><span class="pp">ink::</span>contract<span class="at">]</span></span>
<span id="cb59-2"><a href="#cb59-2" aria-hidden="true" tabindex="-1"></a><span class="kw">mod</span> flipper <span class="op">{</span></span>
<span id="cb59-3"><a href="#cb59-3" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Type aliases improve readability</span></span>
<span id="cb59-4"><a href="#cb59-4" aria-hidden="true" tabindex="-1"></a>    <span class="kw">type</span> FlipCount <span class="op">=</span> <span class="dt">u32</span><span class="op">;</span></span>
<span id="cb59-5"><a href="#cb59-5" aria-hidden="true" tabindex="-1"></a>    <span class="kw">type</span> FlipperResult<span class="op">&lt;</span>T<span class="op">&gt;</span> <span class="op">=</span> <span class="dt">Result</span><span class="op">&lt;</span>T<span class="op">,</span> <span class="bu">Error</span><span class="op">&gt;;</span></span>
<span id="cb59-6"><a href="#cb59-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb59-7"><a href="#cb59-7" aria-hidden="true" tabindex="-1"></a>    <span class="at">#[</span>ink<span class="at">(</span>storage<span class="at">)]</span></span>
<span id="cb59-8"><a href="#cb59-8" aria-hidden="true" tabindex="-1"></a>    <span class="kw">pub</span> <span class="kw">struct</span> Flipper <span class="op">{</span></span>
<span id="cb59-9"><a href="#cb59-9" aria-hidden="true" tabindex="-1"></a>        value<span class="op">:</span> <span class="dt">bool</span><span class="op">,</span></span>
<span id="cb59-10"><a href="#cb59-10" aria-hidden="true" tabindex="-1"></a>        flip_count<span class="op">:</span> FlipCount<span class="op">,</span></span>
<span id="cb59-11"><a href="#cb59-11" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb59-12"><a href="#cb59-12" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<h2 id="summary-1">Summary</h2>
<p>In this chapter, we deconstructed the flipper contract to understand
the fundamental building blocks of ink! development:</p>
<p><strong>Key Concepts Learned:</strong></p>
<ol type="1">
<li><p><strong>Project Structure</strong>: How
<code>cargo contract new</code> scaffolds a complete ink! project with
proper configuration</p></li>
<li><p><strong>Macro System</strong>: Deep understanding of
<code>#[ink::contract]</code>, <code>#[ink(storage)]</code>,
<code>#[ink(constructor)]</code>, and <code>#[ink(message)]</code>
macros</p></li>
<li><p><strong>Compilation Pipeline</strong>: From Rust source to
optimized WebAssembly, including metadata generation</p></li>
<li><p><strong>Build Artifacts</strong>: Understanding the purpose and
contents of <code>.wasm</code>, <code>.json</code>, and
<code>.contract</code> files</p></li>
<li><p><strong>Feature Flags</strong>: How ink! uses conditional
compilation to support both development and production
environments</p></li>
<li><p><strong>Testing Framework</strong>: Both unit tests and
end-to-end tests for comprehensive validation</p></li>
</ol>
<p><strong>Essential Patterns:</strong> - Storage structs as the single
source of truth - Constructor overloading for flexible initialization -
Immutable vs. mutable message patterns - Comprehensive error handling
with custom error types</p>
<p>With this foundation, you’re ready to explore more sophisticated
state management patterns. In the next chapter, we’ll dive deep into
ink!’s storage system, learning how to efficiently manage complex data
structures and optimize for gas costs.</p>
<hr />
<h1
id="chapter-3-deep-dive-into-state-managing-contract-storage">Chapter 3:
Deep Dive into State: Managing Contract Storage</h1>
<p>Storage is the heart of any smart contract—it’s where your contract’s
state persists between transactions and across blockchain upgrades.
Unlike traditional applications where you might use databases or file
systems, smart contracts store data directly on the blockchain, making
every byte precious and every access pattern critical for gas
efficiency.</p>
<p>In this chapter, we’ll explore ink!’s sophisticated storage system,
from basic primitives to advanced optimization techniques. You’ll learn
how to design storage layouts that scale, when to use different storage
types, and how to avoid common pitfalls that can make your contracts
expensive or unusable.</p>
<h2 id="understanding-the-storage-model">Understanding the Storage
Model</h2>
<h3 id="the-single-storage-root-principle">The Single Storage Root
Principle</h3>
<p>Every ink! contract has exactly one storage struct marked with
<code>#[ink(storage)]</code>. This struct serves as the root of all
persistent data:</p>
<div class="sourceCode" id="cb60"><pre
class="sourceCode rust"><code class="sourceCode rust"><span id="cb60-1"><a href="#cb60-1" aria-hidden="true" tabindex="-1"></a><span class="at">#[</span><span class="pp">ink::</span>contract<span class="at">]</span></span>
<span id="cb60-2"><a href="#cb60-2" aria-hidden="true" tabindex="-1"></a><span class="kw">mod</span> my_contract <span class="op">{</span></span>
<span id="cb60-3"><a href="#cb60-3" aria-hidden="true" tabindex="-1"></a>    <span class="at">#[</span>ink<span class="at">(</span>storage<span class="at">)]</span></span>
<span id="cb60-4"><a href="#cb60-4" aria-hidden="true" tabindex="-1"></a>    <span class="kw">pub</span> <span class="kw">struct</span> MyContract <span class="op">{</span></span>
<span id="cb60-5"><a href="#cb60-5" aria-hidden="true" tabindex="-1"></a>        <span class="co">// This is the ONLY persistent storage in your contract</span></span>
<span id="cb60-6"><a href="#cb60-6" aria-hidden="true" tabindex="-1"></a>        value<span class="op">:</span> <span class="dt">u32</span><span class="op">,</span></span>
<span id="cb60-7"><a href="#cb60-7" aria-hidden="true" tabindex="-1"></a>        owner<span class="op">:</span> AccountId<span class="op">,</span></span>
<span id="cb60-8"><a href="#cb60-8" aria-hidden="true" tabindex="-1"></a>        balances<span class="op">:</span> <span class="pp">ink::storage::</span>Mapping<span class="op">&lt;</span>AccountId<span class="op">,</span> Balance<span class="op">&gt;,</span></span>
<span id="cb60-9"><a href="#cb60-9" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb60-10"><a href="#cb60-10" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb60-11"><a href="#cb60-11" aria-hidden="true" tabindex="-1"></a>    <span class="co">// This struct is NOT storage - it&#39;s just a regular Rust struct</span></span>
<span id="cb60-12"><a href="#cb60-12" aria-hidden="true" tabindex="-1"></a>    <span class="kw">pub</span> <span class="kw">struct</span> TempData <span class="op">{</span></span>
<span id="cb60-13"><a href="#cb60-13" aria-hidden="true" tabindex="-1"></a>        calculation<span class="op">:</span> <span class="dt">u64</span><span class="op">,</span></span>
<span id="cb60-14"><a href="#cb60-14" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb60-15"><a href="#cb60-15" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<p><strong>Why only one storage struct?</strong> - <strong>Deterministic
layout</strong>: Ensures consistent storage access patterns -
<strong>Gas optimization</strong>: Single root eliminates storage lookup
overhead<br />
- <strong>Upgrade safety</strong>: Prevents storage layout conflicts
during contract upgrades</p>
<h3 id="storage-key-generation">Storage Key Generation</h3>
<p>ink! automatically generates unique storage keys for each field using
a deterministic algorithm:</p>
<div class="sourceCode" id="cb61"><pre
class="sourceCode rust"><code class="sourceCode rust"><span id="cb61-1"><a href="#cb61-1" aria-hidden="true" tabindex="-1"></a><span class="at">#[</span>ink<span class="at">(</span>storage<span class="at">)]</span></span>
<span id="cb61-2"><a href="#cb61-2" aria-hidden="true" tabindex="-1"></a><span class="kw">pub</span> <span class="kw">struct</span> MyContract <span class="op">{</span></span>
<span id="cb61-3"><a href="#cb61-3" aria-hidden="true" tabindex="-1"></a>    value<span class="op">:</span> <span class="dt">u32</span><span class="op">,</span>        <span class="co">// Storage key: 0x00000000</span></span>
<span id="cb61-4"><a href="#cb61-4" aria-hidden="true" tabindex="-1"></a>    owner<span class="op">:</span> AccountId<span class="op">,</span>  <span class="co">// Storage key: 0x00000001</span></span>
<span id="cb61-5"><a href="#cb61-5" aria-hidden="true" tabindex="-1"></a>    data<span class="op">:</span> <span class="dt">Vec</span><span class="op">&lt;</span><span class="dt">u8</span><span class="op">&gt;,</span>     <span class="co">// Storage key: 0x00000002</span></span>
<span id="cb61-6"><a href="#cb61-6" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<p><strong>Key generation algorithm:</strong> 1. Start with base key
<code>0x00000000</code> 2. Increment by 1 for each field in declaration
order 3. Apply cryptographic hashing for nested structures</p>
<p><strong>Visualizing storage layout:</strong></p>
<pre><code>Blockchain Storage:
┌─────────────────────────────────┐
│ Contract Address: 0xABC123...   │
├─────────────────────────────────┤
│ Storage Root                    │
│ ├─ Key 0x00000000: value        │
│ ├─ Key 0x00000001: owner        │
│ └─ Key 0x00000002: data         │
└─────────────────────────────────┘</code></pre>
<h2 id="supported-storage-types">Supported Storage Types</h2>
<h3 id="primitive-types">Primitive Types</h3>
<p>All Rust primitive types work directly in storage:</p>
<div class="sourceCode" id="cb63"><pre
class="sourceCode rust"><code class="sourceCode rust"><span id="cb63-1"><a href="#cb63-1" aria-hidden="true" tabindex="-1"></a><span class="at">#[</span>ink<span class="at">(</span>storage<span class="at">)]</span></span>
<span id="cb63-2"><a href="#cb63-2" aria-hidden="true" tabindex="-1"></a><span class="kw">pub</span> <span class="kw">struct</span> PrimitiveStorage <span class="op">{</span></span>
<span id="cb63-3"><a href="#cb63-3" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Unsigned integers</span></span>
<span id="cb63-4"><a href="#cb63-4" aria-hidden="true" tabindex="-1"></a>    small_number<span class="op">:</span> <span class="dt">u8</span><span class="op">,</span>      <span class="co">// 1 byte</span></span>
<span id="cb63-5"><a href="#cb63-5" aria-hidden="true" tabindex="-1"></a>    medium_number<span class="op">:</span> <span class="dt">u32</span><span class="op">,</span>    <span class="co">// 4 bytes</span></span>
<span id="cb63-6"><a href="#cb63-6" aria-hidden="true" tabindex="-1"></a>    large_number<span class="op">:</span> <span class="dt">u128</span><span class="op">,</span>    <span class="co">// 16 bytes</span></span>
<span id="cb63-7"><a href="#cb63-7" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb63-8"><a href="#cb63-8" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Signed integers</span></span>
<span id="cb63-9"><a href="#cb63-9" aria-hidden="true" tabindex="-1"></a>    signed_value<span class="op">:</span> <span class="dt">i64</span><span class="op">,</span>     <span class="co">// 8 bytes</span></span>
<span id="cb63-10"><a href="#cb63-10" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb63-11"><a href="#cb63-11" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Boolean</span></span>
<span id="cb63-12"><a href="#cb63-12" aria-hidden="true" tabindex="-1"></a>    flag<span class="op">:</span> <span class="dt">bool</span><span class="op">,</span>            <span class="co">// 1 byte (but stored as u8)</span></span>
<span id="cb63-13"><a href="#cb63-13" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb63-14"><a href="#cb63-14" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Arrays (fixed size)</span></span>
<span id="cb63-15"><a href="#cb63-15" aria-hidden="true" tabindex="-1"></a>    bytes<span class="op">:</span> [<span class="dt">u8</span><span class="op">;</span> <span class="dv">32</span>]<span class="op">,</span>       <span class="co">// 32 bytes</span></span>
<span id="cb63-16"><a href="#cb63-16" aria-hidden="true" tabindex="-1"></a>    numbers<span class="op">:</span> [<span class="dt">u64</span><span class="op">;</span> <span class="dv">10</span>]<span class="op">,</span>    <span class="co">// 80 bytes</span></span>
<span id="cb63-17"><a href="#cb63-17" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<p><strong>Gas implications:</strong> - Reading any primitive costs ~200
gas base + size penalty - Writing costs ~5,000 gas base + size penalty -
Arrays are stored as single items (efficient for small, fixed sizes)</p>
<h3 id="custom-structs-and-enums">Custom Structs and Enums</h3>
<p>Any type implementing the required traits can be stored:</p>
<div class="sourceCode" id="cb64"><pre
class="sourceCode rust"><code class="sourceCode rust"><span id="cb64-1"><a href="#cb64-1" aria-hidden="true" tabindex="-1"></a><span class="co">// Custom struct for storage</span></span>
<span id="cb64-2"><a href="#cb64-2" aria-hidden="true" tabindex="-1"></a><span class="at">#[</span>derive<span class="at">(</span><span class="pp">scale::</span>Encode<span class="op">,</span> <span class="pp">scale::</span>Decode<span class="at">)]</span></span>
<span id="cb64-3"><a href="#cb64-3" aria-hidden="true" tabindex="-1"></a><span class="at">#[</span>cfg_attr<span class="at">(</span>feature <span class="op">=</span> <span class="st">&quot;std&quot;</span><span class="op">,</span> derive<span class="at">(</span><span class="pp">scale_info::</span>TypeInfo<span class="at">))]</span></span>
<span id="cb64-4"><a href="#cb64-4" aria-hidden="true" tabindex="-1"></a><span class="kw">pub</span> <span class="kw">struct</span> UserProfile <span class="op">{</span></span>
<span id="cb64-5"><a href="#cb64-5" aria-hidden="true" tabindex="-1"></a>    name<span class="op">:</span> <span class="dt">Vec</span><span class="op">&lt;</span><span class="dt">u8</span><span class="op">&gt;,</span></span>
<span id="cb64-6"><a href="#cb64-6" aria-hidden="true" tabindex="-1"></a>    age<span class="op">:</span> <span class="dt">u8</span><span class="op">,</span></span>
<span id="cb64-7"><a href="#cb64-7" aria-hidden="true" tabindex="-1"></a>    verified<span class="op">:</span> <span class="dt">bool</span><span class="op">,</span></span>
<span id="cb64-8"><a href="#cb64-8" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb64-9"><a href="#cb64-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb64-10"><a href="#cb64-10" aria-hidden="true" tabindex="-1"></a><span class="co">// Custom enum for storage</span></span>
<span id="cb64-11"><a href="#cb64-11" aria-hidden="true" tabindex="-1"></a><span class="at">#[</span>derive<span class="at">(</span><span class="pp">scale::</span>Encode<span class="op">,</span> <span class="pp">scale::</span>Decode<span class="at">)]</span></span>
<span id="cb64-12"><a href="#cb64-12" aria-hidden="true" tabindex="-1"></a><span class="at">#[</span>cfg_attr<span class="at">(</span>feature <span class="op">=</span> <span class="st">&quot;std&quot;</span><span class="op">,</span> derive<span class="at">(</span><span class="pp">scale_info::</span>TypeInfo<span class="at">))]</span></span>
<span id="cb64-13"><a href="#cb64-13" aria-hidden="true" tabindex="-1"></a><span class="kw">pub</span> <span class="kw">enum</span> Status <span class="op">{</span></span>
<span id="cb64-14"><a href="#cb64-14" aria-hidden="true" tabindex="-1"></a>    Pending<span class="op">,</span></span>
<span id="cb64-15"><a href="#cb64-15" aria-hidden="true" tabindex="-1"></a>    Active <span class="op">{</span> since<span class="op">:</span> <span class="dt">u64</span> <span class="op">},</span></span>
<span id="cb64-16"><a href="#cb64-16" aria-hidden="true" tabindex="-1"></a>    Suspended <span class="op">{</span> reason<span class="op">:</span> <span class="dt">Vec</span><span class="op">&lt;</span><span class="dt">u8</span><span class="op">&gt;</span> <span class="op">},</span></span>
<span id="cb64-17"><a href="#cb64-17" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb64-18"><a href="#cb64-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb64-19"><a href="#cb64-19" aria-hidden="true" tabindex="-1"></a><span class="at">#[</span>ink<span class="at">(</span>storage<span class="at">)]</span></span>
<span id="cb64-20"><a href="#cb64-20" aria-hidden="true" tabindex="-1"></a><span class="kw">pub</span> <span class="kw">struct</span> ProfileContract <span class="op">{</span></span>
<span id="cb64-21"><a href="#cb64-21" aria-hidden="true" tabindex="-1"></a>    profiles<span class="op">:</span> <span class="pp">ink::storage::</span>Mapping<span class="op">&lt;</span>AccountId<span class="op">,</span> UserProfile<span class="op">&gt;,</span></span>
<span id="cb64-22"><a href="#cb64-22" aria-hidden="true" tabindex="-1"></a>    user_status<span class="op">:</span> <span class="pp">ink::storage::</span>Mapping<span class="op">&lt;</span>AccountId<span class="op">,</span> Status<span class="op">&gt;,</span></span>
<span id="cb64-23"><a href="#cb64-23" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<p><strong>Required trait implementations:</strong> -
<code>scale::Encode</code>: Serializes data for storage -
<code>scale::Decode</code>: Deserializes data from storage<br />
- <code>scale_info::TypeInfo</code>: Provides type metadata (std feature
only)</p>
<h3 id="collections-vec-and-btreemap">Collections: Vec and BTreeMap</h3>
<p>Standard Rust collections work in storage but with performance
caveats:</p>
<div class="sourceCode" id="cb65"><pre
class="sourceCode rust"><code class="sourceCode rust"><span id="cb65-1"><a href="#cb65-1" aria-hidden="true" tabindex="-1"></a><span class="kw">use</span> <span class="pp">ink::prelude::</span><span class="op">{</span><span class="pp">vec::</span><span class="dt">Vec</span><span class="op">,</span> <span class="pp">collections::</span>BTreeMap<span class="op">};</span></span>
<span id="cb65-2"><a href="#cb65-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb65-3"><a href="#cb65-3" aria-hidden="true" tabindex="-1"></a><span class="at">#[</span>ink<span class="at">(</span>storage<span class="at">)]</span></span>
<span id="cb65-4"><a href="#cb65-4" aria-hidden="true" tabindex="-1"></a><span class="kw">pub</span> <span class="kw">struct</span> CollectionStorage <span class="op">{</span></span>
<span id="cb65-5"><a href="#cb65-5" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Vector - good for small, sequential data</span></span>
<span id="cb65-6"><a href="#cb65-6" aria-hidden="true" tabindex="-1"></a>    items<span class="op">:</span> <span class="dt">Vec</span><span class="op">&lt;</span><span class="dt">u32</span><span class="op">&gt;,</span></span>
<span id="cb65-7"><a href="#cb65-7" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb65-8"><a href="#cb65-8" aria-hidden="true" tabindex="-1"></a>    <span class="co">// BTreeMap - good for small, sorted key-value data</span></span>
<span id="cb65-9"><a href="#cb65-9" aria-hidden="true" tabindex="-1"></a>    metadata<span class="op">:</span> BTreeMap<span class="op">&lt;</span><span class="dt">Vec</span><span class="op">&lt;</span><span class="dt">u8</span><span class="op">&gt;,</span> <span class="dt">Vec</span><span class="op">&lt;</span><span class="dt">u8</span><span class="op">&gt;&gt;,</span></span>
<span id="cb65-10"><a href="#cb65-10" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb65-11"><a href="#cb65-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb65-12"><a href="#cb65-12" aria-hidden="true" tabindex="-1"></a><span class="kw">impl</span> CollectionStorage <span class="op">{</span></span>
<span id="cb65-13"><a href="#cb65-13" aria-hidden="true" tabindex="-1"></a>    <span class="at">#[</span>ink<span class="at">(</span>message<span class="at">)]</span></span>
<span id="cb65-14"><a href="#cb65-14" aria-hidden="true" tabindex="-1"></a>    <span class="kw">pub</span> <span class="kw">fn</span> add_item(<span class="op">&amp;</span><span class="kw">mut</span> <span class="kw">self</span><span class="op">,</span> item<span class="op">:</span> <span class="dt">u32</span>) <span class="op">{</span></span>
<span id="cb65-15"><a href="#cb65-15" aria-hidden="true" tabindex="-1"></a>        <span class="kw">self</span><span class="op">.</span>items<span class="op">.</span>push(item)<span class="op">;</span> <span class="co">// Rewrites entire vector!</span></span>
<span id="cb65-16"><a href="#cb65-16" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb65-17"><a href="#cb65-17" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb65-18"><a href="#cb65-18" aria-hidden="true" tabindex="-1"></a>    <span class="at">#[</span>ink<span class="at">(</span>message<span class="at">)]</span></span>
<span id="cb65-19"><a href="#cb65-19" aria-hidden="true" tabindex="-1"></a>    <span class="kw">pub</span> <span class="kw">fn</span> get_item(<span class="op">&amp;</span><span class="kw">self</span><span class="op">,</span> index<span class="op">:</span> <span class="dt">usize</span>) <span class="op">-&gt;</span> <span class="dt">Option</span><span class="op">&lt;</span><span class="dt">u32</span><span class="op">&gt;</span> <span class="op">{</span></span>
<span id="cb65-20"><a href="#cb65-20" aria-hidden="true" tabindex="-1"></a>        <span class="kw">self</span><span class="op">.</span>items<span class="op">.</span>get(index)<span class="op">.</span>copied() <span class="co">// Reads entire vector!</span></span>
<span id="cb65-21"><a href="#cb65-21" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb65-22"><a href="#cb65-22" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<p><strong>Performance warnings:</strong> - <strong>Vec
operations</strong>: Any modification rewrites the entire vector -
<strong>BTreeMap operations</strong>: Potentially rebalances and
rewrites tree structure - <strong>Gas costs scale with collection
size</strong>: <span class="math inline"><em>O</em>(<em>n</em>)</span>
for most operations</p>
<h2 id="the-mapping-type-your-primary-tool">The Mapping Type: Your
Primary Tool</h2>
<p>The <code>ink::storage::Mapping</code> type is specifically designed
for efficient blockchain storage:</p>
<h3 id="basic-mapping-usage">Basic Mapping Usage</h3>
<div class="sourceCode" id="cb66"><pre
class="sourceCode rust"><code class="sourceCode rust"><span id="cb66-1"><a href="#cb66-1" aria-hidden="true" tabindex="-1"></a><span class="kw">use</span> <span class="pp">ink::storage::</span>Mapping<span class="op">;</span></span>
<span id="cb66-2"><a href="#cb66-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-3"><a href="#cb66-3" aria-hidden="true" tabindex="-1"></a><span class="at">#[</span>ink<span class="at">(</span>storage<span class="at">)]</span></span>
<span id="cb66-4"><a href="#cb66-4" aria-hidden="true" tabindex="-1"></a><span class="kw">pub</span> <span class="kw">struct</span> TokenContract <span class="op">{</span></span>
<span id="cb66-5"><a href="#cb66-5" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Key-value storage with individual item access</span></span>
<span id="cb66-6"><a href="#cb66-6" aria-hidden="true" tabindex="-1"></a>    balances<span class="op">:</span> Mapping<span class="op">&lt;</span>AccountId<span class="op">,</span> Balance<span class="op">&gt;,</span></span>
<span id="cb66-7"><a href="#cb66-7" aria-hidden="true" tabindex="-1"></a>    allowances<span class="op">:</span> Mapping<span class="op">&lt;</span>(AccountId<span class="op">,</span> AccountId)<span class="op">,</span> Balance<span class="op">&gt;,</span></span>
<span id="cb66-8"><a href="#cb66-8" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb66-9"><a href="#cb66-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-10"><a href="#cb66-10" aria-hidden="true" tabindex="-1"></a><span class="kw">impl</span> TokenContract <span class="op">{</span></span>
<span id="cb66-11"><a href="#cb66-11" aria-hidden="true" tabindex="-1"></a>    <span class="at">#[</span>ink<span class="at">(</span>constructor<span class="at">)]</span></span>
<span id="cb66-12"><a href="#cb66-12" aria-hidden="true" tabindex="-1"></a>    <span class="kw">pub</span> <span class="kw">fn</span> new(total_supply<span class="op">:</span> Balance) <span class="op">-&gt;</span> <span class="dt">Self</span> <span class="op">{</span></span>
<span id="cb66-13"><a href="#cb66-13" aria-hidden="true" tabindex="-1"></a>        <span class="kw">let</span> <span class="kw">mut</span> balances <span class="op">=</span> <span class="pp">Mapping::</span><span class="kw">default</span>()<span class="op">;</span></span>
<span id="cb66-14"><a href="#cb66-14" aria-hidden="true" tabindex="-1"></a>        <span class="kw">let</span> caller <span class="op">=</span> <span class="dt">Self</span><span class="pp">::</span>env()<span class="op">.</span>caller()<span class="op">;</span></span>
<span id="cb66-15"><a href="#cb66-15" aria-hidden="true" tabindex="-1"></a>        balances<span class="op">.</span>insert(caller<span class="op">,</span> <span class="op">&amp;</span>total_supply)<span class="op">;</span></span>
<span id="cb66-16"><a href="#cb66-16" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb66-17"><a href="#cb66-17" aria-hidden="true" tabindex="-1"></a>        <span class="dt">Self</span> <span class="op">{</span></span>
<span id="cb66-18"><a href="#cb66-18" aria-hidden="true" tabindex="-1"></a>            balances<span class="op">,</span></span>
<span id="cb66-19"><a href="#cb66-19" aria-hidden="true" tabindex="-1"></a>            allowances<span class="op">:</span> <span class="pp">Mapping::</span><span class="kw">default</span>()<span class="op">,</span></span>
<span id="cb66-20"><a href="#cb66-20" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb66-21"><a href="#cb66-21" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb66-22"><a href="#cb66-22" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb66-23"><a href="#cb66-23" aria-hidden="true" tabindex="-1"></a>    <span class="at">#[</span>ink<span class="at">(</span>message<span class="at">)]</span></span>
<span id="cb66-24"><a href="#cb66-24" aria-hidden="true" tabindex="-1"></a>    <span class="kw">pub</span> <span class="kw">fn</span> balance_of(<span class="op">&amp;</span><span class="kw">self</span><span class="op">,</span> account<span class="op">:</span> AccountId) <span class="op">-&gt;</span> Balance <span class="op">{</span></span>
<span id="cb66-25"><a href="#cb66-25" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Returns default value (0) if key doesn&#39;t exist</span></span>
<span id="cb66-26"><a href="#cb66-26" aria-hidden="true" tabindex="-1"></a>        <span class="kw">self</span><span class="op">.</span>balances<span class="op">.</span>get(account)<span class="op">.</span>unwrap_or(<span class="dv">0</span>)</span>
<span id="cb66-27"><a href="#cb66-27" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb66-28"><a href="#cb66-28" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb66-29"><a href="#cb66-29" aria-hidden="true" tabindex="-1"></a>    <span class="at">#[</span>ink<span class="at">(</span>message<span class="at">)]</span></span>
<span id="cb66-30"><a href="#cb66-30" aria-hidden="true" tabindex="-1"></a>    <span class="kw">pub</span> <span class="kw">fn</span> transfer(<span class="op">&amp;</span><span class="kw">mut</span> <span class="kw">self</span><span class="op">,</span> to<span class="op">:</span> AccountId<span class="op">,</span> amount<span class="op">:</span> Balance) <span class="op">-&gt;</span> <span class="dt">Result</span><span class="op">&lt;</span>()<span class="op">,</span> <span class="bu">Error</span><span class="op">&gt;</span> <span class="op">{</span></span>
<span id="cb66-31"><a href="#cb66-31" aria-hidden="true" tabindex="-1"></a>        <span class="kw">let</span> caller <span class="op">=</span> <span class="kw">self</span><span class="op">.</span>env()<span class="op">.</span>caller()<span class="op">;</span></span>
<span id="cb66-32"><a href="#cb66-32" aria-hidden="true" tabindex="-1"></a>        <span class="kw">let</span> caller_balance <span class="op">=</span> <span class="kw">self</span><span class="op">.</span>balance_of(caller)<span class="op">;</span></span>
<span id="cb66-33"><a href="#cb66-33" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb66-34"><a href="#cb66-34" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> caller_balance <span class="op">&lt;</span> amount <span class="op">{</span></span>
<span id="cb66-35"><a href="#cb66-35" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> <span class="cn">Err</span>(<span class="bu">Error</span><span class="pp">::</span>InsufficientBalance)<span class="op">;</span></span>
<span id="cb66-36"><a href="#cb66-36" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb66-37"><a href="#cb66-37" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb66-38"><a href="#cb66-38" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Update balances - each operation touches only one storage slot</span></span>
<span id="cb66-39"><a href="#cb66-39" aria-hidden="true" tabindex="-1"></a>        <span class="kw">let</span> new_caller_balance <span class="op">=</span> caller_balance <span class="op">-</span> amount<span class="op">;</span></span>
<span id="cb66-40"><a href="#cb66-40" aria-hidden="true" tabindex="-1"></a>        <span class="kw">let</span> to_balance <span class="op">=</span> <span class="kw">self</span><span class="op">.</span>balance_of(to)<span class="op">;</span></span>
<span id="cb66-41"><a href="#cb66-41" aria-hidden="true" tabindex="-1"></a>        <span class="kw">let</span> new_to_balance <span class="op">=</span> to_balance <span class="op">+</span> amount<span class="op">;</span></span>
<span id="cb66-42"><a href="#cb66-42" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb66-43"><a href="#cb66-43" aria-hidden="true" tabindex="-1"></a>        <span class="kw">self</span><span class="op">.</span>balances<span class="op">.</span>insert(caller<span class="op">,</span> <span class="op">&amp;</span>new_caller_balance)<span class="op">;</span></span>
<span id="cb66-44"><a href="#cb66-44" aria-hidden="true" tabindex="-1"></a>        <span class="kw">self</span><span class="op">.</span>balances<span class="op">.</span>insert(to<span class="op">,</span> <span class="op">&amp;</span>new_to_balance)<span class="op">;</span></span>
<span id="cb66-45"><a href="#cb66-45" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb66-46"><a href="#cb66-46" aria-hidden="true" tabindex="-1"></a>        <span class="cn">Ok</span>(())</span>
<span id="cb66-47"><a href="#cb66-47" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb66-48"><a href="#cb66-48" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<h3 id="mapping-key-types">Mapping Key Types</h3>
<p>Mappings support complex key types through hashing:</p>
<div class="sourceCode" id="cb67"><pre
class="sourceCode rust"><code class="sourceCode rust"><span id="cb67-1"><a href="#cb67-1" aria-hidden="true" tabindex="-1"></a><span class="at">#[</span>ink<span class="at">(</span>storage<span class="at">)]</span></span>
<span id="cb67-2"><a href="#cb67-2" aria-hidden="true" tabindex="-1"></a><span class="kw">pub</span> <span class="kw">struct</span> ComplexMappings <span class="op">{</span></span>
<span id="cb67-3"><a href="#cb67-3" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Simple keys</span></span>
<span id="cb67-4"><a href="#cb67-4" aria-hidden="true" tabindex="-1"></a>    simple<span class="op">:</span> Mapping<span class="op">&lt;</span>AccountId<span class="op">,</span> Balance<span class="op">&gt;,</span></span>
<span id="cb67-5"><a href="#cb67-5" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb67-6"><a href="#cb67-6" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Tuple keys - useful for relationships</span></span>
<span id="cb67-7"><a href="#cb67-7" aria-hidden="true" tabindex="-1"></a>    approvals<span class="op">:</span> Mapping<span class="op">&lt;</span>(AccountId<span class="op">,</span> AccountId)<span class="op">,</span> Balance<span class="op">&gt;,</span></span>
<span id="cb67-8"><a href="#cb67-8" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb67-9"><a href="#cb67-9" aria-hidden="true" tabindex="-1"></a>    <span class="co">// String keys (as Vec&lt;u8&gt;)</span></span>
<span id="cb67-10"><a href="#cb67-10" aria-hidden="true" tabindex="-1"></a>    names<span class="op">:</span> Mapping<span class="op">&lt;</span><span class="dt">Vec</span><span class="op">&lt;</span><span class="dt">u8</span><span class="op">&gt;,</span> AccountId<span class="op">&gt;,</span></span>
<span id="cb67-11"><a href="#cb67-11" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb67-12"><a href="#cb67-12" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Custom struct keys</span></span>
<span id="cb67-13"><a href="#cb67-13" aria-hidden="true" tabindex="-1"></a>    positions<span class="op">:</span> Mapping<span class="op">&lt;</span>Position<span class="op">,</span> PlayerData<span class="op">&gt;,</span></span>
<span id="cb67-14"><a href="#cb67-14" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb67-15"><a href="#cb67-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb67-16"><a href="#cb67-16" aria-hidden="true" tabindex="-1"></a><span class="co">// Custom key type</span></span>
<span id="cb67-17"><a href="#cb67-17" aria-hidden="true" tabindex="-1"></a><span class="at">#[</span>derive<span class="at">(</span><span class="pp">scale::</span>Encode<span class="op">,</span> <span class="pp">scale::</span>Decode<span class="op">,</span> <span class="bu">PartialEq</span><span class="op">,</span> <span class="bu">Eq</span><span class="at">)]</span></span>
<span id="cb67-18"><a href="#cb67-18" aria-hidden="true" tabindex="-1"></a><span class="at">#[</span>cfg_attr<span class="at">(</span>feature <span class="op">=</span> <span class="st">&quot;std&quot;</span><span class="op">,</span> derive<span class="at">(</span><span class="pp">scale_info::</span>TypeInfo<span class="at">))]</span></span>
<span id="cb67-19"><a href="#cb67-19" aria-hidden="true" tabindex="-1"></a><span class="kw">pub</span> <span class="kw">struct</span> Position <span class="op">{</span></span>
<span id="cb67-20"><a href="#cb67-20" aria-hidden="true" tabindex="-1"></a>    x<span class="op">:</span> <span class="dt">i32</span><span class="op">,</span></span>
<span id="cb67-21"><a href="#cb67-21" aria-hidden="true" tabindex="-1"></a>    y<span class="op">:</span> <span class="dt">i32</span><span class="op">,</span></span>
<span id="cb67-22"><a href="#cb67-22" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb67-23"><a href="#cb67-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb67-24"><a href="#cb67-24" aria-hidden="true" tabindex="-1"></a><span class="at">#[</span>derive<span class="at">(</span><span class="pp">scale::</span>Encode<span class="op">,</span> <span class="pp">scale::</span>Decode<span class="at">)]</span></span>
<span id="cb67-25"><a href="#cb67-25" aria-hidden="true" tabindex="-1"></a><span class="at">#[</span>cfg_attr<span class="at">(</span>feature <span class="op">=</span> <span class="st">&quot;std&quot;</span><span class="op">,</span> derive<span class="at">(</span><span class="pp">scale_info::</span>TypeInfo<span class="at">))]</span></span>
<span id="cb67-26"><a href="#cb67-26" aria-hidden="true" tabindex="-1"></a><span class="kw">pub</span> <span class="kw">struct</span> PlayerData <span class="op">{</span></span>
<span id="cb67-27"><a href="#cb67-27" aria-hidden="true" tabindex="-1"></a>    health<span class="op">:</span> <span class="dt">u32</span><span class="op">,</span></span>
<span id="cb67-28"><a href="#cb67-28" aria-hidden="true" tabindex="-1"></a>    score<span class="op">:</span> <span class="dt">u64</span><span class="op">,</span></span>
<span id="cb67-29"><a href="#cb67-29" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<h3 id="mapping-internals-how-keys-become-storage-addresses">Mapping
Internals: How Keys Become Storage Addresses</h3>
<p>Understanding mapping internals helps optimize gas usage:</p>
<div class="sourceCode" id="cb68"><pre
class="sourceCode rust"><code class="sourceCode rust"><span id="cb68-1"><a href="#cb68-1" aria-hidden="true" tabindex="-1"></a><span class="co">// Conceptual implementation (simplified)</span></span>
<span id="cb68-2"><a href="#cb68-2" aria-hidden="true" tabindex="-1"></a><span class="kw">impl</span><span class="op">&lt;</span>K<span class="op">,</span> V<span class="op">&gt;</span> Mapping<span class="op">&lt;</span>K<span class="op">,</span> V<span class="op">&gt;</span> <span class="op">{</span></span>
<span id="cb68-3"><a href="#cb68-3" aria-hidden="true" tabindex="-1"></a>    <span class="kw">fn</span> storage_key(<span class="op">&amp;</span><span class="kw">self</span><span class="op">,</span> key<span class="op">:</span> <span class="op">&amp;</span>K) <span class="op">-&gt;</span> [<span class="dt">u8</span><span class="op">;</span> <span class="dv">32</span>] <span class="op">{</span></span>
<span id="cb68-4"><a href="#cb68-4" aria-hidden="true" tabindex="-1"></a>        <span class="kw">let</span> encoded_key <span class="op">=</span> <span class="pp">scale::Encode::</span>encode(key)<span class="op">;</span></span>
<span id="cb68-5"><a href="#cb68-5" aria-hidden="true" tabindex="-1"></a>        <span class="kw">let</span> base_key <span class="op">=</span> <span class="kw">self</span><span class="op">.</span>base_key()<span class="op">;</span> <span class="co">// From storage position</span></span>
<span id="cb68-6"><a href="#cb68-6" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb68-7"><a href="#cb68-7" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Combine base key with encoded key using cryptographic hash</span></span>
<span id="cb68-8"><a href="#cb68-8" aria-hidden="true" tabindex="-1"></a>        <span class="pp">Blake2b256::</span>hash(<span class="op">&amp;</span>[base_key<span class="op">.</span>as_slice()<span class="op">,</span> encoded_key<span class="op">.</span>as_slice()])</span>
<span id="cb68-9"><a href="#cb68-9" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb68-10"><a href="#cb68-10" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb68-11"><a href="#cb68-11" aria-hidden="true" tabindex="-1"></a>    <span class="kw">fn</span> get(<span class="op">&amp;</span><span class="kw">self</span><span class="op">,</span> key<span class="op">:</span> K) <span class="op">-&gt;</span> <span class="dt">Option</span><span class="op">&lt;</span>V<span class="op">&gt;</span> <span class="op">{</span></span>
<span id="cb68-12"><a href="#cb68-12" aria-hidden="true" tabindex="-1"></a>        <span class="kw">let</span> storage_key <span class="op">=</span> <span class="kw">self</span><span class="op">.</span>storage_key(<span class="op">&amp;</span>key)<span class="op">;</span></span>
<span id="cb68-13"><a href="#cb68-13" aria-hidden="true" tabindex="-1"></a>        <span class="kw">self</span><span class="op">.</span>env()<span class="op">.</span>storage()<span class="op">.</span>get(<span class="op">&amp;</span>storage_key)</span>
<span id="cb68-14"><a href="#cb68-14" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb68-15"><a href="#cb68-15" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb68-16"><a href="#cb68-16" aria-hidden="true" tabindex="-1"></a>    <span class="kw">fn</span> insert(<span class="op">&amp;</span><span class="kw">mut</span> <span class="kw">self</span><span class="op">,</span> key<span class="op">:</span> K<span class="op">,</span> value<span class="op">:</span> <span class="op">&amp;</span>V) <span class="op">{</span></span>
<span id="cb68-17"><a href="#cb68-17" aria-hidden="true" tabindex="-1"></a>        <span class="kw">let</span> storage_key <span class="op">=</span> <span class="kw">self</span><span class="op">.</span>storage_key(<span class="op">&amp;</span>key)<span class="op">;</span></span>
<span id="cb68-18"><a href="#cb68-18" aria-hidden="true" tabindex="-1"></a>        <span class="kw">self</span><span class="op">.</span>env()<span class="op">.</span>storage()<span class="op">.</span>set(<span class="op">&amp;</span>storage_key<span class="op">,</span> value)<span class="op">;</span></span>
<span id="cb68-19"><a href="#cb68-19" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb68-20"><a href="#cb68-20" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<p><strong>Gas analysis:</strong> - <strong>Key hashing</strong>: ~50
gas per key hash - <strong>Storage read</strong>: ~200 gas + value size
- <strong>Storage write</strong>: ~5,000 gas + value size -
<strong>Complex keys</strong>: Additional encoding overhead</p>
<h2 id="advanced-storage-strategies">Advanced Storage Strategies</h2>
<h3 id="lazy-loading-with-inkstoragelazy">Lazy Loading with
ink::storage::Lazy</h3>
<p>The <code>Lazy&lt;T&gt;</code> type prevents automatic loading of
large storage items:</p>
<div class="sourceCode" id="cb69"><pre
class="sourceCode rust"><code class="sourceCode rust"><span id="cb69-1"><a href="#cb69-1" aria-hidden="true" tabindex="-1"></a><span class="kw">use</span> <span class="pp">ink::storage::</span>Lazy<span class="op">;</span></span>
<span id="cb69-2"><a href="#cb69-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb69-3"><a href="#cb69-3" aria-hidden="true" tabindex="-1"></a><span class="at">#[</span>ink<span class="at">(</span>storage<span class="at">)]</span></span>
<span id="cb69-4"><a href="#cb69-4" aria-hidden="true" tabindex="-1"></a><span class="kw">pub</span> <span class="kw">struct</span> OptimizedContract <span class="op">{</span></span>
<span id="cb69-5"><a href="#cb69-5" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Always loaded (small, frequently accessed)</span></span>
<span id="cb69-6"><a href="#cb69-6" aria-hidden="true" tabindex="-1"></a>    owner<span class="op">:</span> AccountId<span class="op">,</span></span>
<span id="cb69-7"><a href="#cb69-7" aria-hidden="true" tabindex="-1"></a>    counter<span class="op">:</span> <span class="dt">u32</span><span class="op">,</span></span>
<span id="cb69-8"><a href="#cb69-8" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb69-9"><a href="#cb69-9" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Lazy loaded (large, infrequently accessed)</span></span>
<span id="cb69-10"><a href="#cb69-10" aria-hidden="true" tabindex="-1"></a>    large_data<span class="op">:</span> Lazy<span class="op">&lt;</span><span class="dt">Vec</span><span class="op">&lt;</span><span class="dt">u8</span><span class="op">&gt;&gt;,</span></span>
<span id="cb69-11"><a href="#cb69-11" aria-hidden="true" tabindex="-1"></a>    configuration<span class="op">:</span> Lazy<span class="op">&lt;</span>Config<span class="op">&gt;,</span></span>
<span id="cb69-12"><a href="#cb69-12" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb69-13"><a href="#cb69-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb69-14"><a href="#cb69-14" aria-hidden="true" tabindex="-1"></a><span class="at">#[</span>derive<span class="at">(</span><span class="pp">scale::</span>Encode<span class="op">,</span> <span class="pp">scale::</span>Decode<span class="at">)]</span></span>
<span id="cb69-15"><a href="#cb69-15" aria-hidden="true" tabindex="-1"></a><span class="at">#[</span>cfg_attr<span class="at">(</span>feature <span class="op">=</span> <span class="st">&quot;std&quot;</span><span class="op">,</span> derive<span class="at">(</span><span class="pp">scale_info::</span>TypeInfo<span class="at">))]</span></span>
<span id="cb69-16"><a href="#cb69-16" aria-hidden="true" tabindex="-1"></a><span class="kw">pub</span> <span class="kw">struct</span> Config <span class="op">{</span></span>
<span id="cb69-17"><a href="#cb69-17" aria-hidden="true" tabindex="-1"></a>    settings<span class="op">:</span> BTreeMap<span class="op">&lt;</span><span class="dt">Vec</span><span class="op">&lt;</span><span class="dt">u8</span><span class="op">&gt;,</span> <span class="dt">Vec</span><span class="op">&lt;</span><span class="dt">u8</span><span class="op">&gt;&gt;,</span></span>
<span id="cb69-18"><a href="#cb69-18" aria-hidden="true" tabindex="-1"></a>    thresholds<span class="op">:</span> [<span class="dt">u64</span><span class="op">;</span> <span class="dv">100</span>]<span class="op">,</span></span>
<span id="cb69-19"><a href="#cb69-19" aria-hidden="true" tabindex="-1"></a>    metadata<span class="op">:</span> <span class="dt">Vec</span><span class="op">&lt;</span><span class="dt">u8</span><span class="op">&gt;,</span></span>
<span id="cb69-20"><a href="#cb69-20" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb69-21"><a href="#cb69-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb69-22"><a href="#cb69-22" aria-hidden="true" tabindex="-1"></a><span class="kw">impl</span> OptimizedContract <span class="op">{</span></span>
<span id="cb69-23"><a href="#cb69-23" aria-hidden="true" tabindex="-1"></a>    <span class="at">#[</span>ink<span class="at">(</span>constructor<span class="at">)]</span></span>
<span id="cb69-24"><a href="#cb69-24" aria-hidden="true" tabindex="-1"></a>    <span class="kw">pub</span> <span class="kw">fn</span> new() <span class="op">-&gt;</span> <span class="dt">Self</span> <span class="op">{</span></span>
<span id="cb69-25"><a href="#cb69-25" aria-hidden="true" tabindex="-1"></a>        <span class="dt">Self</span> <span class="op">{</span></span>
<span id="cb69-26"><a href="#cb69-26" aria-hidden="true" tabindex="-1"></a>            owner<span class="op">:</span> <span class="dt">Self</span><span class="pp">::</span>env()<span class="op">.</span>caller()<span class="op">,</span></span>
<span id="cb69-27"><a href="#cb69-27" aria-hidden="true" tabindex="-1"></a>            counter<span class="op">:</span> <span class="dv">0</span><span class="op">,</span></span>
<span id="cb69-28"><a href="#cb69-28" aria-hidden="true" tabindex="-1"></a>            <span class="co">// Lazy items start uninitialized</span></span>
<span id="cb69-29"><a href="#cb69-29" aria-hidden="true" tabindex="-1"></a>            large_data<span class="op">:</span> <span class="pp">Lazy::</span>new()<span class="op">,</span></span>
<span id="cb69-30"><a href="#cb69-30" aria-hidden="true" tabindex="-1"></a>            configuration<span class="op">:</span> <span class="pp">Lazy::</span>new()<span class="op">,</span></span>
<span id="cb69-31"><a href="#cb69-31" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb69-32"><a href="#cb69-32" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb69-33"><a href="#cb69-33" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb69-34"><a href="#cb69-34" aria-hidden="true" tabindex="-1"></a>    <span class="at">#[</span>ink<span class="at">(</span>message<span class="at">)]</span></span>
<span id="cb69-35"><a href="#cb69-35" aria-hidden="true" tabindex="-1"></a>    <span class="kw">pub</span> <span class="kw">fn</span> increment(<span class="op">&amp;</span><span class="kw">mut</span> <span class="kw">self</span>) <span class="op">{</span></span>
<span id="cb69-36"><a href="#cb69-36" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Fast operation - no lazy loading triggered</span></span>
<span id="cb69-37"><a href="#cb69-37" aria-hidden="true" tabindex="-1"></a>        <span class="kw">self</span><span class="op">.</span>counter <span class="op">+=</span> <span class="dv">1</span><span class="op">;</span></span>
<span id="cb69-38"><a href="#cb69-38" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb69-39"><a href="#cb69-39" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb69-40"><a href="#cb69-40" aria-hidden="true" tabindex="-1"></a>    <span class="at">#[</span>ink<span class="at">(</span>message<span class="at">)]</span></span>
<span id="cb69-41"><a href="#cb69-41" aria-hidden="true" tabindex="-1"></a>    <span class="kw">pub</span> <span class="kw">fn</span> set_config(<span class="op">&amp;</span><span class="kw">mut</span> <span class="kw">self</span><span class="op">,</span> config<span class="op">:</span> Config) <span class="op">{</span></span>
<span id="cb69-42"><a href="#cb69-42" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Only loads/stores when explicitly accessed</span></span>
<span id="cb69-43"><a href="#cb69-43" aria-hidden="true" tabindex="-1"></a>        <span class="kw">self</span><span class="op">.</span>configuration<span class="op">.</span>set(<span class="op">&amp;</span>config)<span class="op">;</span></span>
<span id="cb69-44"><a href="#cb69-44" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb69-45"><a href="#cb69-45" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb69-46"><a href="#cb69-46" aria-hidden="true" tabindex="-1"></a>    <span class="at">#[</span>ink<span class="at">(</span>message<span class="at">)]</span></span>
<span id="cb69-47"><a href="#cb69-47" aria-hidden="true" tabindex="-1"></a>    <span class="kw">pub</span> <span class="kw">fn</span> get_config_setting(<span class="op">&amp;</span><span class="kw">self</span><span class="op">,</span> key<span class="op">:</span> <span class="op">&amp;</span>[<span class="dt">u8</span>]) <span class="op">-&gt;</span> <span class="dt">Option</span><span class="op">&lt;</span><span class="dt">Vec</span><span class="op">&lt;</span><span class="dt">u8</span><span class="op">&gt;&gt;</span> <span class="op">{</span></span>
<span id="cb69-48"><a href="#cb69-48" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Loads entire config from storage</span></span>
<span id="cb69-49"><a href="#cb69-49" aria-hidden="true" tabindex="-1"></a>        <span class="kw">self</span><span class="op">.</span>configuration<span class="op">.</span>get()</span>
<span id="cb69-50"><a href="#cb69-50" aria-hidden="true" tabindex="-1"></a>            <span class="op">.</span>and_then(<span class="op">|</span>config<span class="op">|</span> config<span class="op">.</span>settings<span class="op">.</span>get(key)<span class="op">.</span>cloned())</span>
<span id="cb69-51"><a href="#cb69-51" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb69-52"><a href="#cb69-52" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<p><strong>When to use Lazy:</strong> - Large data structures (&gt; 1KB)
- Infrequently accessed data - Optional configuration data - Historical
data that’s rarely queried</p>
<p><strong>Gas savings example:</strong></p>
<div class="sourceCode" id="cb70"><pre
class="sourceCode rust"><code class="sourceCode rust"><span id="cb70-1"><a href="#cb70-1" aria-hidden="true" tabindex="-1"></a><span class="co">// Without Lazy: Every message loads entire storage struct</span></span>
<span id="cb70-2"><a href="#cb70-2" aria-hidden="true" tabindex="-1"></a><span class="co">// Gas cost: 10,000 (base) + 50,000 (large_data) + 30,000 (config) = 90,000</span></span>
<span id="cb70-3"><a href="#cb70-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-4"><a href="#cb70-4" aria-hidden="true" tabindex="-1"></a><span class="co">// With Lazy: Only loads accessed items</span></span>
<span id="cb70-5"><a href="#cb70-5" aria-hidden="true" tabindex="-1"></a><span class="co">// Gas cost: 10,000 (base) + 0 (lazy items) = 10,000</span></span></code></pre></div>
<h3 id="memory-optimization-with-inkstoragepacked">Memory Optimization
with ink::storage::Packed</h3>
<p>The <code>Packed&lt;T&gt;</code> type optimizes memory layout for
small structs:</p>
<div class="sourceCode" id="cb71"><pre
class="sourceCode rust"><code class="sourceCode rust"><span id="cb71-1"><a href="#cb71-1" aria-hidden="true" tabindex="-1"></a><span class="kw">use</span> <span class="pp">ink::storage::</span><span class="op">{</span>Mapping<span class="op">,</span> Packed<span class="op">};</span></span>
<span id="cb71-2"><a href="#cb71-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb71-3"><a href="#cb71-3" aria-hidden="true" tabindex="-1"></a><span class="co">// Small struct that benefits from packing</span></span>
<span id="cb71-4"><a href="#cb71-4" aria-hidden="true" tabindex="-1"></a><span class="at">#[</span>derive<span class="at">(</span><span class="pp">scale::</span>Encode<span class="op">,</span> <span class="pp">scale::</span>Decode<span class="op">,</span> PackedLayout<span class="at">)]</span></span>
<span id="cb71-5"><a href="#cb71-5" aria-hidden="true" tabindex="-1"></a><span class="at">#[</span>cfg_attr<span class="at">(</span>feature <span class="op">=</span> <span class="st">&quot;std&quot;</span><span class="op">,</span> derive<span class="at">(</span><span class="pp">scale_info::</span>TypeInfo<span class="at">))]</span></span>
<span id="cb71-6"><a href="#cb71-6" aria-hidden="true" tabindex="-1"></a><span class="kw">pub</span> <span class="kw">struct</span> UserStats <span class="op">{</span></span>
<span id="cb71-7"><a href="#cb71-7" aria-hidden="true" tabindex="-1"></a>    level<span class="op">:</span> <span class="dt">u8</span><span class="op">,</span>        <span class="co">// 1 byte</span></span>
<span id="cb71-8"><a href="#cb71-8" aria-hidden="true" tabindex="-1"></a>    experience<span class="op">:</span> <span class="dt">u32</span><span class="op">,</span>  <span class="co">// 4 bytes  </span></span>
<span id="cb71-9"><a href="#cb71-9" aria-hidden="true" tabindex="-1"></a>    active<span class="op">:</span> <span class="dt">bool</span><span class="op">,</span>     <span class="co">// 1 byte</span></span>
<span id="cb71-10"><a href="#cb71-10" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Total: 6 bytes instead of potential 12 with padding</span></span>
<span id="cb71-11"><a href="#cb71-11" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb71-12"><a href="#cb71-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb71-13"><a href="#cb71-13" aria-hidden="true" tabindex="-1"></a><span class="at">#[</span>ink<span class="at">(</span>storage<span class="at">)]</span></span>
<span id="cb71-14"><a href="#cb71-14" aria-hidden="true" tabindex="-1"></a><span class="kw">pub</span> <span class="kw">struct</span> GameContract <span class="op">{</span></span>
<span id="cb71-15"><a href="#cb71-15" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Packed storage for small, frequently accessed data</span></span>
<span id="cb71-16"><a href="#cb71-16" aria-hidden="true" tabindex="-1"></a>    user_stats<span class="op">:</span> Mapping<span class="op">&lt;</span>AccountId<span class="op">,</span> Packed<span class="op">&lt;</span>UserStats<span class="op">&gt;&gt;,</span></span>
<span id="cb71-17"><a href="#cb71-17" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb71-18"><a href="#cb71-18" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Regular storage for larger data</span></span>
<span id="cb71-19"><a href="#cb71-19" aria-hidden="true" tabindex="-1"></a>    user_profiles<span class="op">:</span> Mapping<span class="op">&lt;</span>AccountId<span class="op">,</span> UserProfile<span class="op">&gt;,</span></span>
<span id="cb71-20"><a href="#cb71-20" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb71-21"><a href="#cb71-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb71-22"><a href="#cb71-22" aria-hidden="true" tabindex="-1"></a><span class="kw">impl</span> GameContract <span class="op">{</span></span>
<span id="cb71-23"><a href="#cb71-23" aria-hidden="true" tabindex="-1"></a>    <span class="at">#[</span>ink<span class="at">(</span>message<span class="at">)]</span></span>
<span id="cb71-24"><a href="#cb71-24" aria-hidden="true" tabindex="-1"></a>    <span class="kw">pub</span> <span class="kw">fn</span> level_up(<span class="op">&amp;</span><span class="kw">mut</span> <span class="kw">self</span><span class="op">,</span> user<span class="op">:</span> AccountId) <span class="op">-&gt;</span> <span class="dt">Result</span><span class="op">&lt;</span>()<span class="op">,</span> <span class="bu">Error</span><span class="op">&gt;</span> <span class="op">{</span></span>
<span id="cb71-25"><a href="#cb71-25" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Load packed data efficiently</span></span>
<span id="cb71-26"><a href="#cb71-26" aria-hidden="true" tabindex="-1"></a>        <span class="kw">let</span> <span class="kw">mut</span> stats <span class="op">=</span> <span class="kw">self</span><span class="op">.</span>user_stats<span class="op">.</span>get(user)</span>
<span id="cb71-27"><a href="#cb71-27" aria-hidden="true" tabindex="-1"></a>            <span class="op">.</span>unwrap_or_default()<span class="op">;</span></span>
<span id="cb71-28"><a href="#cb71-28" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb71-29"><a href="#cb71-29" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Modify through packed interface</span></span>
<span id="cb71-30"><a href="#cb71-30" aria-hidden="true" tabindex="-1"></a>        stats<span class="op">.</span>level <span class="op">=</span> stats<span class="op">.</span>level<span class="op">.</span>saturating_add(<span class="dv">1</span>)<span class="op">;</span></span>
<span id="cb71-31"><a href="#cb71-31" aria-hidden="true" tabindex="-1"></a>        stats<span class="op">.</span>experience <span class="op">=</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb71-32"><a href="#cb71-32" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb71-33"><a href="#cb71-33" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Store packed data</span></span>
<span id="cb71-34"><a href="#cb71-34" aria-hidden="true" tabindex="-1"></a>        <span class="kw">self</span><span class="op">.</span>user_stats<span class="op">.</span>insert(user<span class="op">,</span> <span class="op">&amp;</span>stats)<span class="op">;</span></span>
<span id="cb71-35"><a href="#cb71-35" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb71-36"><a href="#cb71-36" aria-hidden="true" tabindex="-1"></a>        <span class="cn">Ok</span>(())</span>
<span id="cb71-37"><a href="#cb71-37" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb71-38"><a href="#cb71-38" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<p><strong>Packed benefits:</strong> - <strong>Reduced storage
costs</strong>: Smaller serialized size - <strong>Better cache
locality</strong>: More data fits in each storage read - <strong>Lower
gas costs</strong>: Fewer storage operations needed</p>
<p><strong>When NOT to use Packed:</strong> - Large structs (&gt; 100
bytes) - Structs with complex nested data - Data that changes frequently
(unpacking overhead)</p>
<h3 id="storage-clearing-and-cleanup">Storage Clearing and Cleanup</h3>
<p>Implement cleanup functions to recover storage costs:</p>
<div class="sourceCode" id="cb72"><pre
class="sourceCode rust"><code class="sourceCode rust"><span id="cb72-1"><a href="#cb72-1" aria-hidden="true" tabindex="-1"></a><span class="at">#[</span><span class="pp">ink::</span>contract<span class="at">]</span></span>
<span id="cb72-2"><a href="#cb72-2" aria-hidden="true" tabindex="-1"></a><span class="kw">mod</span> cleanable_contract <span class="op">{</span></span>
<span id="cb72-3"><a href="#cb72-3" aria-hidden="true" tabindex="-1"></a>    <span class="kw">use</span> <span class="pp">ink::storage::</span>Mapping<span class="op">;</span></span>
<span id="cb72-4"><a href="#cb72-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb72-5"><a href="#cb72-5" aria-hidden="true" tabindex="-1"></a>    <span class="at">#[</span>ink<span class="at">(</span>storage<span class="at">)]</span></span>
<span id="cb72-6"><a href="#cb72-6" aria-hidden="true" tabindex="-1"></a>    <span class="kw">pub</span> <span class="kw">struct</span> CleanableContract <span class="op">{</span></span>
<span id="cb72-7"><a href="#cb72-7" aria-hidden="true" tabindex="-1"></a>        data<span class="op">:</span> Mapping<span class="op">&lt;</span>AccountId<span class="op">,</span> <span class="dt">Vec</span><span class="op">&lt;</span><span class="dt">u8</span><span class="op">&gt;&gt;,</span></span>
<span id="cb72-8"><a href="#cb72-8" aria-hidden="true" tabindex="-1"></a>        expired_keys<span class="op">:</span> <span class="dt">Vec</span><span class="op">&lt;</span>AccountId<span class="op">&gt;,</span></span>
<span id="cb72-9"><a href="#cb72-9" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb72-10"><a href="#cb72-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb72-11"><a href="#cb72-11" aria-hidden="true" tabindex="-1"></a>    <span class="kw">impl</span> CleanableContract <span class="op">{</span></span>
<span id="cb72-12"><a href="#cb72-12" aria-hidden="true" tabindex="-1"></a>        <span class="at">#[</span>ink<span class="at">(</span>message<span class="at">)]</span></span>
<span id="cb72-13"><a href="#cb72-13" aria-hidden="true" tabindex="-1"></a>        <span class="kw">pub</span> <span class="kw">fn</span> clear_user_data(<span class="op">&amp;</span><span class="kw">mut</span> <span class="kw">self</span><span class="op">,</span> user<span class="op">:</span> AccountId) <span class="op">-&gt;</span> <span class="dt">Result</span><span class="op">&lt;</span>()<span class="op">,</span> <span class="bu">Error</span><span class="op">&gt;</span> <span class="op">{</span></span>
<span id="cb72-14"><a href="#cb72-14" aria-hidden="true" tabindex="-1"></a>            <span class="co">// Check authorization</span></span>
<span id="cb72-15"><a href="#cb72-15" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> <span class="kw">self</span><span class="op">.</span>env()<span class="op">.</span>caller() <span class="op">!=</span> user <span class="op">{</span></span>
<span id="cb72-16"><a href="#cb72-16" aria-hidden="true" tabindex="-1"></a>                <span class="cf">return</span> <span class="cn">Err</span>(<span class="bu">Error</span><span class="pp">::</span>Unauthorized)<span class="op">;</span></span>
<span id="cb72-17"><a href="#cb72-17" aria-hidden="true" tabindex="-1"></a>            <span class="op">}</span></span>
<span id="cb72-18"><a href="#cb72-18" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb72-19"><a href="#cb72-19" aria-hidden="true" tabindex="-1"></a>            <span class="co">// Remove from mapping - storage cost is refunded</span></span>
<span id="cb72-20"><a href="#cb72-20" aria-hidden="true" tabindex="-1"></a>            <span class="kw">self</span><span class="op">.</span>data<span class="op">.</span>remove(user)<span class="op">;</span></span>
<span id="cb72-21"><a href="#cb72-21" aria-hidden="true" tabindex="-1"></a>            <span class="cn">Ok</span>(())</span>
<span id="cb72-22"><a href="#cb72-22" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb72-23"><a href="#cb72-23" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb72-24"><a href="#cb72-24" aria-hidden="true" tabindex="-1"></a>        <span class="at">#[</span>ink<span class="at">(</span>message<span class="at">)]</span></span>
<span id="cb72-25"><a href="#cb72-25" aria-hidden="true" tabindex="-1"></a>        <span class="kw">pub</span> <span class="kw">fn</span> batch_cleanup(<span class="op">&amp;</span><span class="kw">mut</span> <span class="kw">self</span><span class="op">,</span> users<span class="op">:</span> <span class="dt">Vec</span><span class="op">&lt;</span>AccountId<span class="op">&gt;</span>) <span class="op">-&gt;</span> <span class="dt">u32</span> <span class="op">{</span></span>
<span id="cb72-26"><a href="#cb72-26" aria-hidden="true" tabindex="-1"></a>            <span class="kw">let</span> <span class="kw">mut</span> cleaned <span class="op">=</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb72-27"><a href="#cb72-27" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb72-28"><a href="#cb72-28" aria-hidden="true" tabindex="-1"></a>            <span class="cf">for</span> user <span class="kw">in</span> users<span class="op">.</span>iter()<span class="op">.</span>take(<span class="dv">50</span>) <span class="op">{</span> <span class="co">// Limit batch size</span></span>
<span id="cb72-29"><a href="#cb72-29" aria-hidden="true" tabindex="-1"></a>                <span class="cf">if</span> <span class="kw">self</span><span class="op">.</span>data<span class="op">.</span>contains(user) <span class="op">{</span></span>
<span id="cb72-30"><a href="#cb72-30" aria-hidden="true" tabindex="-1"></a>                    <span class="kw">self</span><span class="op">.</span>data<span class="op">.</span>remove(<span class="op">*</span>user)<span class="op">;</span></span>
<span id="cb72-31"><a href="#cb72-31" aria-hidden="true" tabindex="-1"></a>                    cleaned <span class="op">+=</span> <span class="dv">1</span><span class="op">;</span></span>
<span id="cb72-32"><a href="#cb72-32" aria-hidden="true" tabindex="-1"></a>                <span class="op">}</span></span>
<span id="cb72-33"><a href="#cb72-33" aria-hidden="true" tabindex="-1"></a>            <span class="op">}</span></span>
<span id="cb72-34"><a href="#cb72-34" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb72-35"><a href="#cb72-35" aria-hidden="true" tabindex="-1"></a>            cleaned</span>
<span id="cb72-36"><a href="#cb72-36" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb72-37"><a href="#cb72-37" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb72-38"><a href="#cb72-38" aria-hidden="true" tabindex="-1"></a>        <span class="at">#[</span>ink<span class="at">(</span>message<span class="at">)]</span></span>
<span id="cb72-39"><a href="#cb72-39" aria-hidden="true" tabindex="-1"></a>        <span class="kw">pub</span> <span class="kw">fn</span> storage_info(<span class="op">&amp;</span><span class="kw">self</span>) <span class="op">-&gt;</span> (<span class="dt">u32</span><span class="op">,</span> <span class="dt">u32</span>) <span class="op">{</span></span>
<span id="cb72-40"><a href="#cb72-40" aria-hidden="true" tabindex="-1"></a>            <span class="co">// Note: These are estimates since mappings don&#39;t track size</span></span>
<span id="cb72-41"><a href="#cb72-41" aria-hidden="true" tabindex="-1"></a>            <span class="kw">let</span> approximate_entries <span class="op">=</span> <span class="kw">self</span><span class="op">.</span>expired_keys<span class="op">.</span>len() <span class="kw">as</span> <span class="dt">u32</span><span class="op">;</span></span>
<span id="cb72-42"><a href="#cb72-42" aria-hidden="true" tabindex="-1"></a>            <span class="kw">let</span> storage_bytes <span class="op">=</span> approximate_entries <span class="op">*</span> <span class="dv">100</span><span class="op">;</span> <span class="co">// Rough estimate</span></span>
<span id="cb72-43"><a href="#cb72-43" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb72-44"><a href="#cb72-44" aria-hidden="true" tabindex="-1"></a>            (approximate_entries<span class="op">,</span> storage_bytes)</span>
<span id="cb72-45"><a href="#cb72-45" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb72-46"><a href="#cb72-46" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb72-47"><a href="#cb72-47" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<h2 id="storage-patterns-and-best-practices">Storage Patterns and Best
Practices</h2>
<h3 id="pattern-1-hierarchical-data-with-compound-keys">Pattern 1:
Hierarchical Data with Compound Keys</h3>
<p>For complex relationships, use tuple keys to create hierarchical
storage:</p>
<div class="sourceCode" id="cb73"><pre
class="sourceCode rust"><code class="sourceCode rust"><span id="cb73-1"><a href="#cb73-1" aria-hidden="true" tabindex="-1"></a><span class="at">#[</span>ink<span class="at">(</span>storage<span class="at">)]</span></span>
<span id="cb73-2"><a href="#cb73-2" aria-hidden="true" tabindex="-1"></a><span class="kw">pub</span> <span class="kw">struct</span> ForumContract <span class="op">{</span></span>
<span id="cb73-3"><a href="#cb73-3" aria-hidden="true" tabindex="-1"></a>    <span class="co">// posts[forum_id][post_id] = Post</span></span>
<span id="cb73-4"><a href="#cb73-4" aria-hidden="true" tabindex="-1"></a>    posts<span class="op">:</span> Mapping<span class="op">&lt;</span>(<span class="dt">u32</span><span class="op">,</span> <span class="dt">u32</span>)<span class="op">,</span> Post<span class="op">&gt;,</span></span>
<span id="cb73-5"><a href="#cb73-5" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb73-6"><a href="#cb73-6" aria-hidden="true" tabindex="-1"></a>    <span class="co">// comments[post_id][comment_id] = Comment  </span></span>
<span id="cb73-7"><a href="#cb73-7" aria-hidden="true" tabindex="-1"></a>    comments<span class="op">:</span> Mapping<span class="op">&lt;</span>(<span class="dt">u32</span><span class="op">,</span> <span class="dt">u32</span>)<span class="op">,</span> Comment<span class="op">&gt;,</span></span>
<span id="cb73-8"><a href="#cb73-8" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb73-9"><a href="#cb73-9" aria-hidden="true" tabindex="-1"></a>    <span class="co">// user_posts[user][post_id] = true (existence mapping)</span></span>
<span id="cb73-10"><a href="#cb73-10" aria-hidden="true" tabindex="-1"></a>    user_posts<span class="op">:</span> Mapping<span class="op">&lt;</span>(AccountId<span class="op">,</span> <span class="dt">u32</span>)<span class="op">,</span> ()<span class="op">&gt;,</span></span>
<span id="cb73-11"><a href="#cb73-11" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb73-12"><a href="#cb73-12" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Counters for ID generation</span></span>
<span id="cb73-13"><a href="#cb73-13" aria-hidden="true" tabindex="-1"></a>    next_post_id<span class="op">:</span> <span class="dt">u32</span><span class="op">,</span></span>
<span id="cb73-14"><a href="#cb73-14" aria-hidden="true" tabindex="-1"></a>    next_comment_id<span class="op">:</span> <span class="dt">u32</span><span class="op">,</span></span>
<span id="cb73-15"><a href="#cb73-15" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb73-16"><a href="#cb73-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-17"><a href="#cb73-17" aria-hidden="true" tabindex="-1"></a><span class="kw">impl</span> ForumContract <span class="op">{</span></span>
<span id="cb73-18"><a href="#cb73-18" aria-hidden="true" tabindex="-1"></a>    <span class="at">#[</span>ink<span class="at">(</span>message<span class="at">)]</span></span>
<span id="cb73-19"><a href="#cb73-19" aria-hidden="true" tabindex="-1"></a>    <span class="kw">pub</span> <span class="kw">fn</span> create_post(<span class="op">&amp;</span><span class="kw">mut</span> <span class="kw">self</span><span class="op">,</span> forum_id<span class="op">:</span> <span class="dt">u32</span><span class="op">,</span> content<span class="op">:</span> <span class="dt">Vec</span><span class="op">&lt;</span><span class="dt">u8</span><span class="op">&gt;</span>) <span class="op">-&gt;</span> <span class="dt">Result</span><span class="op">&lt;</span><span class="dt">u32</span><span class="op">,</span> <span class="bu">Error</span><span class="op">&gt;</span> <span class="op">{</span></span>
<span id="cb73-20"><a href="#cb73-20" aria-hidden="true" tabindex="-1"></a>        <span class="kw">let</span> post_id <span class="op">=</span> <span class="kw">self</span><span class="op">.</span>next_post_id<span class="op">;</span></span>
<span id="cb73-21"><a href="#cb73-21" aria-hidden="true" tabindex="-1"></a>        <span class="kw">let</span> author <span class="op">=</span> <span class="kw">self</span><span class="op">.</span>env()<span class="op">.</span>caller()<span class="op">;</span></span>
<span id="cb73-22"><a href="#cb73-22" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb73-23"><a href="#cb73-23" aria-hidden="true" tabindex="-1"></a>        <span class="kw">let</span> post <span class="op">=</span> Post <span class="op">{</span></span>
<span id="cb73-24"><a href="#cb73-24" aria-hidden="true" tabindex="-1"></a>            author<span class="op">,</span></span>
<span id="cb73-25"><a href="#cb73-25" aria-hidden="true" tabindex="-1"></a>            content<span class="op">,</span></span>
<span id="cb73-26"><a href="#cb73-26" aria-hidden="true" tabindex="-1"></a>            timestamp<span class="op">:</span> <span class="kw">self</span><span class="op">.</span>env()<span class="op">.</span>block_timestamp()<span class="op">,</span></span>
<span id="cb73-27"><a href="#cb73-27" aria-hidden="true" tabindex="-1"></a>        <span class="op">};</span></span>
<span id="cb73-28"><a href="#cb73-28" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb73-29"><a href="#cb73-29" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Store with compound key</span></span>
<span id="cb73-30"><a href="#cb73-30" aria-hidden="true" tabindex="-1"></a>        <span class="kw">self</span><span class="op">.</span>posts<span class="op">.</span>insert((forum_id<span class="op">,</span> post_id)<span class="op">,</span> <span class="op">&amp;</span>post)<span class="op">;</span></span>
<span id="cb73-31"><a href="#cb73-31" aria-hidden="true" tabindex="-1"></a>        <span class="kw">self</span><span class="op">.</span>user_posts<span class="op">.</span>insert((author<span class="op">,</span> post_id)<span class="op">,</span> <span class="op">&amp;</span>())<span class="op">;</span></span>
<span id="cb73-32"><a href="#cb73-32" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb73-33"><a href="#cb73-33" aria-hidden="true" tabindex="-1"></a>        <span class="kw">self</span><span class="op">.</span>next_post_id <span class="op">+=</span> <span class="dv">1</span><span class="op">;</span></span>
<span id="cb73-34"><a href="#cb73-34" aria-hidden="true" tabindex="-1"></a>        <span class="cn">Ok</span>(post_id)</span>
<span id="cb73-35"><a href="#cb73-35" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb73-36"><a href="#cb73-36" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb73-37"><a href="#cb73-37" aria-hidden="true" tabindex="-1"></a>    <span class="at">#[</span>ink<span class="at">(</span>message<span class="at">)]</span></span>
<span id="cb73-38"><a href="#cb73-38" aria-hidden="true" tabindex="-1"></a>    <span class="kw">pub</span> <span class="kw">fn</span> get_user_posts(<span class="op">&amp;</span><span class="kw">self</span><span class="op">,</span> user<span class="op">:</span> AccountId<span class="op">,</span> limit<span class="op">:</span> <span class="dt">u32</span>) <span class="op">-&gt;</span> <span class="dt">Vec</span><span class="op">&lt;</span><span class="dt">u32</span><span class="op">&gt;</span> <span class="op">{</span></span>
<span id="cb73-39"><a href="#cb73-39" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Note: This is inefficient - in practice, you&#39;d maintain</span></span>
<span id="cb73-40"><a href="#cb73-40" aria-hidden="true" tabindex="-1"></a>        <span class="co">// a separate user_post_list mapping for efficient queries</span></span>
<span id="cb73-41"><a href="#cb73-41" aria-hidden="true" tabindex="-1"></a>        <span class="kw">let</span> <span class="kw">mut</span> posts <span class="op">=</span> <span class="dt">Vec</span><span class="pp">::</span>new()<span class="op">;</span></span>
<span id="cb73-42"><a href="#cb73-42" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb73-43"><a href="#cb73-43" aria-hidden="true" tabindex="-1"></a>        <span class="co">// This would require iterating all possible post IDs</span></span>
<span id="cb73-44"><a href="#cb73-44" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Better to maintain separate index structures</span></span>
<span id="cb73-45"><a href="#cb73-45" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb73-46"><a href="#cb73-46" aria-hidden="true" tabindex="-1"></a>        posts</span>
<span id="cb73-47"><a href="#cb73-47" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb73-48"><a href="#cb73-48" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<h3 id="pattern-2-pagination-for-large-data-sets">Pattern 2: Pagination
for Large Data Sets</h3>
<p>Implement pagination to handle large collections efficiently:</p>
<div class="sourceCode" id="cb74"><pre
class="sourceCode rust"><code class="sourceCode rust"><span id="cb74-1"><a href="#cb74-1" aria-hidden="true" tabindex="-1"></a><span class="at">#[</span>ink<span class="at">(</span>storage<span class="at">)]</span></span>
<span id="cb74-2"><a href="#cb74-2" aria-hidden="true" tabindex="-1"></a><span class="kw">pub</span> <span class="kw">struct</span> PaginatedContract <span class="op">{</span></span>
<span id="cb74-3"><a href="#cb74-3" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Main data storage</span></span>
<span id="cb74-4"><a href="#cb74-4" aria-hidden="true" tabindex="-1"></a>    items<span class="op">:</span> Mapping<span class="op">&lt;</span><span class="dt">u32</span><span class="op">,</span> Item<span class="op">&gt;,</span></span>
<span id="cb74-5"><a href="#cb74-5" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb74-6"><a href="#cb74-6" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Pagination indices</span></span>
<span id="cb74-7"><a href="#cb74-7" aria-hidden="true" tabindex="-1"></a>    item_count<span class="op">:</span> <span class="dt">u32</span><span class="op">,</span></span>
<span id="cb74-8"><a href="#cb74-8" aria-hidden="true" tabindex="-1"></a>    items_per_page<span class="op">:</span> <span class="dt">u32</span><span class="op">,</span></span>
<span id="cb74-9"><a href="#cb74-9" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb74-10"><a href="#cb74-10" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Optional: Category indices for filtered pagination</span></span>
<span id="cb74-11"><a href="#cb74-11" aria-hidden="true" tabindex="-1"></a>    category_items<span class="op">:</span> Mapping<span class="op">&lt;</span>(Category<span class="op">,</span> <span class="dt">u32</span>)<span class="op">,</span> <span class="dt">u32</span><span class="op">&gt;,</span> <span class="co">// (category, index) -&gt; item_id</span></span>
<span id="cb74-12"><a href="#cb74-12" aria-hidden="true" tabindex="-1"></a>    category_counts<span class="op">:</span> Mapping<span class="op">&lt;</span>Category<span class="op">,</span> <span class="dt">u32</span><span class="op">&gt;,</span></span>
<span id="cb74-13"><a href="#cb74-13" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb74-14"><a href="#cb74-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb74-15"><a href="#cb74-15" aria-hidden="true" tabindex="-1"></a><span class="kw">impl</span> PaginatedContract <span class="op">{</span></span>
<span id="cb74-16"><a href="#cb74-16" aria-hidden="true" tabindex="-1"></a>    <span class="at">#[</span>ink<span class="at">(</span>message<span class="at">)]</span></span>
<span id="cb74-17"><a href="#cb74-17" aria-hidden="true" tabindex="-1"></a>    <span class="kw">pub</span> <span class="kw">fn</span> get_items_page(<span class="op">&amp;</span><span class="kw">self</span><span class="op">,</span> page<span class="op">:</span> <span class="dt">u32</span><span class="op">,</span> per_page<span class="op">:</span> <span class="dt">u32</span>) <span class="op">-&gt;</span> <span class="dt">Result</span><span class="op">&lt;</span><span class="dt">Vec</span><span class="op">&lt;</span>Item<span class="op">&gt;,</span> <span class="bu">Error</span><span class="op">&gt;</span> <span class="op">{</span></span>
<span id="cb74-18"><a href="#cb74-18" aria-hidden="true" tabindex="-1"></a>        <span class="kw">let</span> max_per_page <span class="op">=</span> <span class="dv">50</span><span class="op">;</span> <span class="co">// Prevent gas limit issues</span></span>
<span id="cb74-19"><a href="#cb74-19" aria-hidden="true" tabindex="-1"></a>        <span class="kw">let</span> actual_per_page <span class="op">=</span> per_page<span class="op">.</span>min(max_per_page)<span class="op">;</span></span>
<span id="cb74-20"><a href="#cb74-20" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb74-21"><a href="#cb74-21" aria-hidden="true" tabindex="-1"></a>        <span class="kw">let</span> start_id <span class="op">=</span> page <span class="op">*</span> actual_per_page<span class="op">;</span></span>
<span id="cb74-22"><a href="#cb74-22" aria-hidden="true" tabindex="-1"></a>        <span class="kw">let</span> end_id <span class="op">=</span> (start_id <span class="op">+</span> actual_per_page)<span class="op">.</span>min(<span class="kw">self</span><span class="op">.</span>item_count)<span class="op">;</span></span>
<span id="cb74-23"><a href="#cb74-23" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb74-24"><a href="#cb74-24" aria-hidden="true" tabindex="-1"></a>        <span class="kw">let</span> <span class="kw">mut</span> results <span class="op">=</span> <span class="dt">Vec</span><span class="pp">::</span>new()<span class="op">;</span></span>
<span id="cb74-25"><a href="#cb74-25" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb74-26"><a href="#cb74-26" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> item_id <span class="kw">in</span> start_id<span class="op">..</span>end_id <span class="op">{</span></span>
<span id="cb74-27"><a href="#cb74-27" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> <span class="kw">let</span> <span class="cn">Some</span>(item) <span class="op">=</span> <span class="kw">self</span><span class="op">.</span>items<span class="op">.</span>get(item_id) <span class="op">{</span></span>
<span id="cb74-28"><a href="#cb74-28" aria-hidden="true" tabindex="-1"></a>                results<span class="op">.</span>push(item)<span class="op">;</span></span>
<span id="cb74-29"><a href="#cb74-29" aria-hidden="true" tabindex="-1"></a>            <span class="op">}</span></span>
<span id="cb74-30"><a href="#cb74-30" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb74-31"><a href="#cb74-31" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb74-32"><a href="#cb74-32" aria-hidden="true" tabindex="-1"></a>        <span class="cn">Ok</span>(results)</span>
<span id="cb74-33"><a href="#cb74-33" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb74-34"><a href="#cb74-34" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb74-35"><a href="#cb74-35" aria-hidden="true" tabindex="-1"></a>    <span class="at">#[</span>ink<span class="at">(</span>message<span class="at">)]</span></span>
<span id="cb74-36"><a href="#cb74-36" aria-hidden="true" tabindex="-1"></a>    <span class="kw">pub</span> <span class="kw">fn</span> get_category_page(<span class="op">&amp;</span><span class="kw">self</span><span class="op">,</span> category<span class="op">:</span> Category<span class="op">,</span> page<span class="op">:</span> <span class="dt">u32</span>) <span class="op">-&gt;</span> <span class="dt">Result</span><span class="op">&lt;</span><span class="dt">Vec</span><span class="op">&lt;</span>Item<span class="op">&gt;,</span> <span class="bu">Error</span><span class="op">&gt;</span> <span class="op">{</span></span>
<span id="cb74-37"><a href="#cb74-37" aria-hidden="true" tabindex="-1"></a>        <span class="kw">let</span> category_count <span class="op">=</span> <span class="kw">self</span><span class="op">.</span>category_counts<span class="op">.</span>get(category)<span class="op">.</span>unwrap_or(<span class="dv">0</span>)<span class="op">;</span></span>
<span id="cb74-38"><a href="#cb74-38" aria-hidden="true" tabindex="-1"></a>        <span class="kw">let</span> per_page <span class="op">=</span> <span class="dv">20</span><span class="op">;</span></span>
<span id="cb74-39"><a href="#cb74-39" aria-hidden="true" tabindex="-1"></a>        <span class="kw">let</span> start_index <span class="op">=</span> page <span class="op">*</span> per_page<span class="op">;</span></span>
<span id="cb74-40"><a href="#cb74-40" aria-hidden="true" tabindex="-1"></a>        <span class="kw">let</span> end_index <span class="op">=</span> (start_index <span class="op">+</span> per_page)<span class="op">.</span>min(category_count)<span class="op">;</span></span>
<span id="cb74-41"><a href="#cb74-41" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb74-42"><a href="#cb74-42" aria-hidden="true" tabindex="-1"></a>        <span class="kw">let</span> <span class="kw">mut</span> results <span class="op">=</span> <span class="dt">Vec</span><span class="pp">::</span>new()<span class="op">;</span></span>
<span id="cb74-43"><a href="#cb74-43" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb74-44"><a href="#cb74-44" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> index <span class="kw">in</span> start_index<span class="op">..</span>end_index <span class="op">{</span></span>
<span id="cb74-45"><a href="#cb74-45" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> <span class="kw">let</span> <span class="cn">Some</span>(item_id) <span class="op">=</span> <span class="kw">self</span><span class="op">.</span>category_items<span class="op">.</span>get((category<span class="op">,</span> index)) <span class="op">{</span></span>
<span id="cb74-46"><a href="#cb74-46" aria-hidden="true" tabindex="-1"></a>                <span class="cf">if</span> <span class="kw">let</span> <span class="cn">Some</span>(item) <span class="op">=</span> <span class="kw">self</span><span class="op">.</span>items<span class="op">.</span>get(item_id) <span class="op">{</span></span>
<span id="cb74-47"><a href="#cb74-47" aria-hidden="true" tabindex="-1"></a>                    results<span class="op">.</span>push(item)<span class="op">;</span></span>
<span id="cb74-48"><a href="#cb74-48" aria-hidden="true" tabindex="-1"></a>                <span class="op">}</span></span>
<span id="cb74-49"><a href="#cb74-49" aria-hidden="true" tabindex="-1"></a>            <span class="op">}</span></span>
<span id="cb74-50"><a href="#cb74-50" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb74-51"><a href="#cb74-51" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb74-52"><a href="#cb74-52" aria-hidden="true" tabindex="-1"></a>        <span class="cn">Ok</span>(results)</span>
<span id="cb74-53"><a href="#cb74-53" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb74-54"><a href="#cb74-54" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<h3 id="pattern-3-efficient-existence-checks">Pattern 3: Efficient
Existence Checks</h3>
<p>Use empty tuples <code>()</code> as values for efficient set-like
behavior:</p>
<div class="sourceCode" id="cb75"><pre
class="sourceCode rust"><code class="sourceCode rust"><span id="cb75-1"><a href="#cb75-1" aria-hidden="true" tabindex="-1"></a><span class="at">#[</span>ink<span class="at">(</span>storage<span class="at">)]</span></span>
<span id="cb75-2"><a href="#cb75-2" aria-hidden="true" tabindex="-1"></a><span class="kw">pub</span> <span class="kw">struct</span> AccessControlContract <span class="op">{</span></span>
<span id="cb75-3"><a href="#cb75-3" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Set membership using () as value</span></span>
<span id="cb75-4"><a href="#cb75-4" aria-hidden="true" tabindex="-1"></a>    admins<span class="op">:</span> Mapping<span class="op">&lt;</span>AccountId<span class="op">,</span> ()<span class="op">&gt;,</span></span>
<span id="cb75-5"><a href="#cb75-5" aria-hidden="true" tabindex="-1"></a>    banned_users<span class="op">:</span> Mapping<span class="op">&lt;</span>AccountId<span class="op">,</span> ()<span class="op">&gt;,</span></span>
<span id="cb75-6"><a href="#cb75-6" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb75-7"><a href="#cb75-7" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Time-based permissions</span></span>
<span id="cb75-8"><a href="#cb75-8" aria-hidden="true" tabindex="-1"></a>    temporary_access<span class="op">:</span> Mapping<span class="op">&lt;</span>AccountId<span class="op">,</span> <span class="dt">u64</span><span class="op">&gt;,</span> <span class="co">// account -&gt; expiry_timestamp</span></span>
<span id="cb75-9"><a href="#cb75-9" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb75-10"><a href="#cb75-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-11"><a href="#cb75-11" aria-hidden="true" tabindex="-1"></a><span class="kw">impl</span> AccessControlContract <span class="op">{</span></span>
<span id="cb75-12"><a href="#cb75-12" aria-hidden="true" tabindex="-1"></a>    <span class="at">#[</span>ink<span class="at">(</span>message<span class="at">)]</span></span>
<span id="cb75-13"><a href="#cb75-13" aria-hidden="true" tabindex="-1"></a>    <span class="kw">pub</span> <span class="kw">fn</span> add_admin(<span class="op">&amp;</span><span class="kw">mut</span> <span class="kw">self</span><span class="op">,</span> account<span class="op">:</span> AccountId) <span class="op">-&gt;</span> <span class="dt">Result</span><span class="op">&lt;</span>()<span class="op">,</span> <span class="bu">Error</span><span class="op">&gt;</span> <span class="op">{</span></span>
<span id="cb75-14"><a href="#cb75-14" aria-hidden="true" tabindex="-1"></a>        <span class="kw">self</span><span class="op">.</span>ensure_admin()<span class="op">?;</span></span>
<span id="cb75-15"><a href="#cb75-15" aria-hidden="true" tabindex="-1"></a>        <span class="kw">self</span><span class="op">.</span>admins<span class="op">.</span>insert(account<span class="op">,</span> <span class="op">&amp;</span>())<span class="op">;</span></span>
<span id="cb75-16"><a href="#cb75-16" aria-hidden="true" tabindex="-1"></a>        <span class="cn">Ok</span>(())</span>
<span id="cb75-17"><a href="#cb75-17" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb75-18"><a href="#cb75-18" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb75-19"><a href="#cb75-19" aria-hidden="true" tabindex="-1"></a>    <span class="at">#[</span>ink<span class="at">(</span>message<span class="at">)]</span></span>
<span id="cb75-20"><a href="#cb75-20" aria-hidden="true" tabindex="-1"></a>    <span class="kw">pub</span> <span class="kw">fn</span> is_admin(<span class="op">&amp;</span><span class="kw">self</span><span class="op">,</span> account<span class="op">:</span> AccountId) <span class="op">-&gt;</span> <span class="dt">bool</span> <span class="op">{</span></span>
<span id="cb75-21"><a href="#cb75-21" aria-hidden="true" tabindex="-1"></a>        <span class="kw">self</span><span class="op">.</span>admins<span class="op">.</span>contains(account)</span>
<span id="cb75-22"><a href="#cb75-22" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb75-23"><a href="#cb75-23" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb75-24"><a href="#cb75-24" aria-hidden="true" tabindex="-1"></a>    <span class="at">#[</span>ink<span class="at">(</span>message<span class="at">)]</span>  </span>
<span id="cb75-25"><a href="#cb75-25" aria-hidden="true" tabindex="-1"></a>    <span class="kw">pub</span> <span class="kw">fn</span> has_access(<span class="op">&amp;</span><span class="kw">self</span><span class="op">,</span> account<span class="op">:</span> AccountId) <span class="op">-&gt;</span> <span class="dt">bool</span> <span class="op">{</span></span>
<span id="cb75-26"><a href="#cb75-26" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Check if admin</span></span>
<span id="cb75-27"><a href="#cb75-27" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="kw">self</span><span class="op">.</span>admins<span class="op">.</span>contains(account) <span class="op">{</span></span>
<span id="cb75-28"><a href="#cb75-28" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> <span class="cn">true</span><span class="op">;</span></span>
<span id="cb75-29"><a href="#cb75-29" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb75-30"><a href="#cb75-30" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb75-31"><a href="#cb75-31" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Check if banned</span></span>
<span id="cb75-32"><a href="#cb75-32" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="kw">self</span><span class="op">.</span>banned_users<span class="op">.</span>contains(account) <span class="op">{</span></span>
<span id="cb75-33"><a href="#cb75-33" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> <span class="cn">false</span><span class="op">;</span></span>
<span id="cb75-34"><a href="#cb75-34" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb75-35"><a href="#cb75-35" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb75-36"><a href="#cb75-36" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Check temporary access</span></span>
<span id="cb75-37"><a href="#cb75-37" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="kw">let</span> <span class="cn">Some</span>(expiry) <span class="op">=</span> <span class="kw">self</span><span class="op">.</span>temporary_access<span class="op">.</span>get(account) <span class="op">{</span></span>
<span id="cb75-38"><a href="#cb75-38" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> <span class="kw">self</span><span class="op">.</span>env()<span class="op">.</span>block_timestamp() <span class="op">&lt;</span> expiry<span class="op">;</span></span>
<span id="cb75-39"><a href="#cb75-39" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb75-40"><a href="#cb75-40" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb75-41"><a href="#cb75-41" aria-hidden="true" tabindex="-1"></a>        <span class="cn">false</span></span>
<span id="cb75-42"><a href="#cb75-42" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb75-43"><a href="#cb75-43" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb75-44"><a href="#cb75-44" aria-hidden="true" tabindex="-1"></a>    <span class="kw">fn</span> ensure_admin(<span class="op">&amp;</span><span class="kw">self</span>) <span class="op">-&gt;</span> <span class="dt">Result</span><span class="op">&lt;</span>()<span class="op">,</span> <span class="bu">Error</span><span class="op">&gt;</span> <span class="op">{</span></span>
<span id="cb75-45"><a href="#cb75-45" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="op">!</span><span class="kw">self</span><span class="op">.</span>is_admin(<span class="kw">self</span><span class="op">.</span>env()<span class="op">.</span>caller()) <span class="op">{</span></span>
<span id="cb75-46"><a href="#cb75-46" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> <span class="cn">Err</span>(<span class="bu">Error</span><span class="pp">::</span>Unauthorized)<span class="op">;</span></span>
<span id="cb75-47"><a href="#cb75-47" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb75-48"><a href="#cb75-48" aria-hidden="true" tabindex="-1"></a>        <span class="cn">Ok</span>(())</span>
<span id="cb75-49"><a href="#cb75-49" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb75-50"><a href="#cb75-50" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<h2 id="gas-optimization-strategies">Gas Optimization Strategies</h2>
<h3 id="minimize-storage-operations">1. Minimize Storage Operations</h3>
<div class="sourceCode" id="cb76"><pre
class="sourceCode rust"><code class="sourceCode rust"><span id="cb76-1"><a href="#cb76-1" aria-hidden="true" tabindex="-1"></a><span class="co">// ❌ Inefficient: Multiple storage writes</span></span>
<span id="cb76-2"><a href="#cb76-2" aria-hidden="true" tabindex="-1"></a><span class="at">#[</span>ink<span class="at">(</span>message<span class="at">)]</span></span>
<span id="cb76-3"><a href="#cb76-3" aria-hidden="true" tabindex="-1"></a><span class="kw">pub</span> <span class="kw">fn</span> bad_transfer(<span class="op">&amp;</span><span class="kw">mut</span> <span class="kw">self</span><span class="op">,</span> to<span class="op">:</span> AccountId<span class="op">,</span> amount<span class="op">:</span> Balance) <span class="op">-&gt;</span> <span class="dt">Result</span><span class="op">&lt;</span>()<span class="op">,</span> <span class="bu">Error</span><span class="op">&gt;</span> <span class="op">{</span></span>
<span id="cb76-4"><a href="#cb76-4" aria-hidden="true" tabindex="-1"></a>    <span class="kw">let</span> caller <span class="op">=</span> <span class="kw">self</span><span class="op">.</span>env()<span class="op">.</span>caller()<span class="op">;</span></span>
<span id="cb76-5"><a href="#cb76-5" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb76-6"><a href="#cb76-6" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Each balance_of() call reads from storage</span></span>
<span id="cb76-7"><a href="#cb76-7" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="kw">self</span><span class="op">.</span>balance_of(caller) <span class="op">&lt;</span> amount <span class="op">{</span></span>
<span id="cb76-8"><a href="#cb76-8" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="cn">Err</span>(<span class="bu">Error</span><span class="pp">::</span>InsufficientBalance)<span class="op">;</span></span>
<span id="cb76-9"><a href="#cb76-9" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb76-10"><a href="#cb76-10" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb76-11"><a href="#cb76-11" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Multiple storage writes</span></span>
<span id="cb76-12"><a href="#cb76-12" aria-hidden="true" tabindex="-1"></a>    <span class="kw">self</span><span class="op">.</span>balances<span class="op">.</span>insert(caller<span class="op">,</span> <span class="op">&amp;</span>(<span class="kw">self</span><span class="op">.</span>balance_of(caller) <span class="op">-</span> amount))<span class="op">;</span></span>
<span id="cb76-13"><a href="#cb76-13" aria-hidden="true" tabindex="-1"></a>    <span class="kw">self</span><span class="op">.</span>balances<span class="op">.</span>insert(to<span class="op">,</span> <span class="op">&amp;</span>(<span class="kw">self</span><span class="op">.</span>balance_of(to) <span class="op">+</span> amount))<span class="op">;</span></span>
<span id="cb76-14"><a href="#cb76-14" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb76-15"><a href="#cb76-15" aria-hidden="true" tabindex="-1"></a>    <span class="cn">Ok</span>(())</span>
<span id="cb76-16"><a href="#cb76-16" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb76-17"><a href="#cb76-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb76-18"><a href="#cb76-18" aria-hidden="true" tabindex="-1"></a><span class="co">// ✅ Efficient: Batch reads, minimize writes</span></span>
<span id="cb76-19"><a href="#cb76-19" aria-hidden="true" tabindex="-1"></a><span class="at">#[</span>ink<span class="at">(</span>message<span class="at">)]</span></span>
<span id="cb76-20"><a href="#cb76-20" aria-hidden="true" tabindex="-1"></a><span class="kw">pub</span> <span class="kw">fn</span> good_transfer(<span class="op">&amp;</span><span class="kw">mut</span> <span class="kw">self</span><span class="op">,</span> to<span class="op">:</span> AccountId<span class="op">,</span> amount<span class="op">:</span> Balance) <span class="op">-&gt;</span> <span class="dt">Result</span><span class="op">&lt;</span>()<span class="op">,</span> <span class="bu">Error</span><span class="op">&gt;</span> <span class="op">{</span></span>
<span id="cb76-21"><a href="#cb76-21" aria-hidden="true" tabindex="-1"></a>    <span class="kw">let</span> caller <span class="op">=</span> <span class="kw">self</span><span class="op">.</span>env()<span class="op">.</span>caller()<span class="op">;</span></span>
<span id="cb76-22"><a href="#cb76-22" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb76-23"><a href="#cb76-23" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Read once, store in memory</span></span>
<span id="cb76-24"><a href="#cb76-24" aria-hidden="true" tabindex="-1"></a>    <span class="kw">let</span> caller_balance <span class="op">=</span> <span class="kw">self</span><span class="op">.</span>balances<span class="op">.</span>get(caller)<span class="op">.</span>unwrap_or(<span class="dv">0</span>)<span class="op">;</span></span>
<span id="cb76-25"><a href="#cb76-25" aria-hidden="true" tabindex="-1"></a>    <span class="kw">let</span> to_balance <span class="op">=</span> <span class="kw">self</span><span class="op">.</span>balances<span class="op">.</span>get(to)<span class="op">.</span>unwrap_or(<span class="dv">0</span>)<span class="op">;</span></span>
<span id="cb76-26"><a href="#cb76-26" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb76-27"><a href="#cb76-27" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> caller_balance <span class="op">&lt;</span> amount <span class="op">{</span></span>
<span id="cb76-28"><a href="#cb76-28" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="cn">Err</span>(<span class="bu">Error</span><span class="pp">::</span>InsufficientBalance)<span class="op">;</span></span>
<span id="cb76-29"><a href="#cb76-29" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb76-30"><a href="#cb76-30" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb76-31"><a href="#cb76-31" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Calculate new balances in memory</span></span>
<span id="cb76-32"><a href="#cb76-32" aria-hidden="true" tabindex="-1"></a>    <span class="kw">let</span> new_caller_balance <span class="op">=</span> caller_balance <span class="op">-</span> amount<span class="op">;</span></span>
<span id="cb76-33"><a href="#cb76-33" aria-hidden="true" tabindex="-1"></a>    <span class="kw">let</span> new_to_balance <span class="op">=</span> to_balance <span class="op">+</span> amount<span class="op">;</span></span>
<span id="cb76-34"><a href="#cb76-34" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb76-35"><a href="#cb76-35" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Write once per account</span></span>
<span id="cb76-36"><a href="#cb76-36" aria-hidden="true" tabindex="-1"></a>    <span class="kw">self</span><span class="op">.</span>balances<span class="op">.</span>insert(caller<span class="op">,</span> <span class="op">&amp;</span>new_caller_balance)<span class="op">;</span></span>
<span id="cb76-37"><a href="#cb76-37" aria-hidden="true" tabindex="-1"></a>    <span class="kw">self</span><span class="op">.</span>balances<span class="op">.</span>insert(to<span class="op">,</span> <span class="op">&amp;</span>new_to_balance)<span class="op">;</span></span>
<span id="cb76-38"><a href="#cb76-38" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb76-39"><a href="#cb76-39" aria-hidden="true" tabindex="-1"></a>    <span class="cn">Ok</span>(())</span>
<span id="cb76-40"><a href="#cb76-40" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<h3 id="use-appropriate-data-types">2. Use Appropriate Data Types</h3>
<div class="sourceCode" id="cb77"><pre
class="sourceCode rust"><code class="sourceCode rust"><span id="cb77-1"><a href="#cb77-1" aria-hidden="true" tabindex="-1"></a><span class="co">// ❌ Oversized types waste gas</span></span>
<span id="cb77-2"><a href="#cb77-2" aria-hidden="true" tabindex="-1"></a><span class="at">#[</span>ink<span class="at">(</span>storage<span class="at">)]</span></span>
<span id="cb77-3"><a href="#cb77-3" aria-hidden="true" tabindex="-1"></a><span class="kw">pub</span> <span class="kw">struct</span> WastefulStorage <span class="op">{</span></span>
<span id="cb77-4"><a href="#cb77-4" aria-hidden="true" tabindex="-1"></a>    small_counter<span class="op">:</span> u256<span class="op">,</span>    <span class="co">// Overkill for counters</span></span>
<span id="cb77-5"><a href="#cb77-5" aria-hidden="true" tabindex="-1"></a>    flags<span class="op">:</span> <span class="dt">Vec</span><span class="op">&lt;</span><span class="dt">bool</span><span class="op">&gt;,</span>       <span class="co">// Vec has overhead for simple flags</span></span>
<span id="cb77-6"><a href="#cb77-6" aria-hidden="true" tabindex="-1"></a>    status<span class="op">:</span> <span class="dt">String</span><span class="op">,</span>         <span class="co">// String has UTF-8 overhead</span></span>
<span id="cb77-7"><a href="#cb77-7" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb77-8"><a href="#cb77-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb77-9"><a href="#cb77-9" aria-hidden="true" tabindex="-1"></a><span class="co">// ✅ Right-sized types save gas</span></span>
<span id="cb77-10"><a href="#cb77-10" aria-hidden="true" tabindex="-1"></a><span class="at">#[</span>ink<span class="at">(</span>storage<span class="at">)]</span></span>
<span id="cb77-11"><a href="#cb77-11" aria-hidden="true" tabindex="-1"></a><span class="kw">pub</span> <span class="kw">struct</span> EfficientStorage <span class="op">{</span></span>
<span id="cb77-12"><a href="#cb77-12" aria-hidden="true" tabindex="-1"></a>    small_counter<span class="op">:</span> <span class="dt">u32</span><span class="op">,</span>     <span class="co">// Sufficient for most counters</span></span>
<span id="cb77-13"><a href="#cb77-13" aria-hidden="true" tabindex="-1"></a>    flags<span class="op">:</span> <span class="dt">u64</span><span class="op">,</span>             <span class="co">// Bitfield for up to 64 boolean flags</span></span>
<span id="cb77-14"><a href="#cb77-14" aria-hidden="true" tabindex="-1"></a>    status<span class="op">:</span> <span class="dt">u8</span><span class="op">,</span>             <span class="co">// Enum represented as u8</span></span>
<span id="cb77-15"><a href="#cb77-15" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb77-16"><a href="#cb77-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb77-17"><a href="#cb77-17" aria-hidden="true" tabindex="-1"></a><span class="kw">impl</span> EfficientStorage <span class="op">{</span></span>
<span id="cb77-18"><a href="#cb77-18" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Bitfield operations for flags</span></span>
<span id="cb77-19"><a href="#cb77-19" aria-hidden="true" tabindex="-1"></a>    <span class="kw">fn</span> set_flag(<span class="op">&amp;</span><span class="kw">mut</span> <span class="kw">self</span><span class="op">,</span> position<span class="op">:</span> <span class="dt">u8</span><span class="op">,</span> value<span class="op">:</span> <span class="dt">bool</span>) <span class="op">{</span></span>
<span id="cb77-20"><a href="#cb77-20" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> position <span class="op">&lt;</span> <span class="dv">64</span> <span class="op">{</span></span>
<span id="cb77-21"><a href="#cb77-21" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> value <span class="op">{</span></span>
<span id="cb77-22"><a href="#cb77-22" aria-hidden="true" tabindex="-1"></a>                <span class="kw">self</span><span class="op">.</span>flags <span class="op">|=</span> <span class="dv">1</span> <span class="op">&lt;&lt;</span> position<span class="op">;</span></span>
<span id="cb77-23"><a href="#cb77-23" aria-hidden="true" tabindex="-1"></a>            <span class="op">}</span> <span class="cf">else</span> <span class="op">{</span></span>
<span id="cb77-24"><a href="#cb77-24" aria-hidden="true" tabindex="-1"></a>                <span class="kw">self</span><span class="op">.</span>flags <span class="op">&amp;=</span> <span class="op">!</span>(<span class="dv">1</span> <span class="op">&lt;&lt;</span> position)<span class="op">;</span></span>
<span id="cb77-25"><a href="#cb77-25" aria-hidden="true" tabindex="-1"></a>            <span class="op">}</span></span>
<span id="cb77-26"><a href="#cb77-26" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb77-27"><a href="#cb77-27" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb77-28"><a href="#cb77-28" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb77-29"><a href="#cb77-29" aria-hidden="true" tabindex="-1"></a>    <span class="kw">fn</span> get_flag(<span class="op">&amp;</span><span class="kw">self</span><span class="op">,</span> position<span class="op">:</span> <span class="dt">u8</span>) <span class="op">-&gt;</span> <span class="dt">bool</span> <span class="op">{</span></span>
<span id="cb77-30"><a href="#cb77-30" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> position <span class="op">&lt;</span> <span class="dv">64</span> <span class="op">{</span></span>
<span id="cb77-31"><a href="#cb77-31" aria-hidden="true" tabindex="-1"></a>            (<span class="kw">self</span><span class="op">.</span>flags <span class="op">&gt;&gt;</span> position) <span class="op">&amp;</span> <span class="dv">1</span> <span class="op">==</span> <span class="dv">1</span></span>
<span id="cb77-32"><a href="#cb77-32" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span> <span class="cf">else</span> <span class="op">{</span></span>
<span id="cb77-33"><a href="#cb77-33" aria-hidden="true" tabindex="-1"></a>            <span class="cn">false</span></span>
<span id="cb77-34"><a href="#cb77-34" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb77-35"><a href="#cb77-35" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb77-36"><a href="#cb77-36" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<h3 id="lazy-initialization-patterns">3. Lazy Initialization
Patterns</h3>
<div class="sourceCode" id="cb78"><pre
class="sourceCode rust"><code class="sourceCode rust"><span id="cb78-1"><a href="#cb78-1" aria-hidden="true" tabindex="-1"></a><span class="at">#[</span>ink<span class="at">(</span>storage<span class="at">)]</span></span>
<span id="cb78-2"><a href="#cb78-2" aria-hidden="true" tabindex="-1"></a><span class="kw">pub</span> <span class="kw">struct</span> LazyContract <span class="op">{</span></span>
<span id="cb78-3"><a href="#cb78-3" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Always present</span></span>
<span id="cb78-4"><a href="#cb78-4" aria-hidden="true" tabindex="-1"></a>    owner<span class="op">:</span> AccountId<span class="op">,</span></span>
<span id="cb78-5"><a href="#cb78-5" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb78-6"><a href="#cb78-6" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Lazy-initialized when first needed</span></span>
<span id="cb78-7"><a href="#cb78-7" aria-hidden="true" tabindex="-1"></a>    configuration<span class="op">:</span> Lazy<span class="op">&lt;</span>Configuration<span class="op">&gt;,</span></span>
<span id="cb78-8"><a href="#cb78-8" aria-hidden="true" tabindex="-1"></a>    user_data<span class="op">:</span> Mapping<span class="op">&lt;</span>AccountId<span class="op">,</span> UserData<span class="op">&gt;,</span></span>
<span id="cb78-9"><a href="#cb78-9" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb78-10"><a href="#cb78-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb78-11"><a href="#cb78-11" aria-hidden="true" tabindex="-1"></a><span class="kw">impl</span> LazyContract <span class="op">{</span></span>
<span id="cb78-12"><a href="#cb78-12" aria-hidden="true" tabindex="-1"></a>    <span class="at">#[</span>ink<span class="at">(</span>constructor<span class="at">)]</span></span>
<span id="cb78-13"><a href="#cb78-13" aria-hidden="true" tabindex="-1"></a>    <span class="kw">pub</span> <span class="kw">fn</span> new() <span class="op">-&gt;</span> <span class="dt">Self</span> <span class="op">{</span></span>
<span id="cb78-14"><a href="#cb78-14" aria-hidden="true" tabindex="-1"></a>        <span class="dt">Self</span> <span class="op">{</span></span>
<span id="cb78-15"><a href="#cb78-15" aria-hidden="true" tabindex="-1"></a>            owner<span class="op">:</span> <span class="dt">Self</span><span class="pp">::</span>env()<span class="op">.</span>caller()<span class="op">,</span></span>
<span id="cb78-16"><a href="#cb78-16" aria-hidden="true" tabindex="-1"></a>            <span class="co">// Don&#39;t initialize Lazy - saves deployment gas</span></span>
<span id="cb78-17"><a href="#cb78-17" aria-hidden="true" tabindex="-1"></a>            configuration<span class="op">:</span> <span class="pp">Lazy::</span>new()<span class="op">,</span></span>
<span id="cb78-18"><a href="#cb78-18" aria-hidden="true" tabindex="-1"></a>            user_data<span class="op">:</span> <span class="pp">Mapping::</span><span class="kw">default</span>()<span class="op">,</span></span>
<span id="cb78-19"><a href="#cb78-19" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb78-20"><a href="#cb78-20" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb78-21"><a href="#cb78-21" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb78-22"><a href="#cb78-22" aria-hidden="true" tabindex="-1"></a>    <span class="at">#[</span>ink<span class="at">(</span>message<span class="at">)]</span></span>
<span id="cb78-23"><a href="#cb78-23" aria-hidden="true" tabindex="-1"></a>    <span class="kw">pub</span> <span class="kw">fn</span> get_config(<span class="op">&amp;</span><span class="kw">self</span>) <span class="op">-&gt;</span> Configuration <span class="op">{</span></span>
<span id="cb78-24"><a href="#cb78-24" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Initialize with default if not present</span></span>
<span id="cb78-25"><a href="#cb78-25" aria-hidden="true" tabindex="-1"></a>        <span class="kw">self</span><span class="op">.</span>configuration<span class="op">.</span>get()<span class="op">.</span>unwrap_or_else(<span class="op">||</span> <span class="op">{</span></span>
<span id="cb78-26"><a href="#cb78-26" aria-hidden="true" tabindex="-1"></a>            <span class="pp">Configuration::</span><span class="kw">default</span>()</span>
<span id="cb78-27"><a href="#cb78-27" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span>)</span>
<span id="cb78-28"><a href="#cb78-28" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb78-29"><a href="#cb78-29" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb78-30"><a href="#cb78-30" aria-hidden="true" tabindex="-1"></a>    <span class="at">#[</span>ink<span class="at">(</span>message<span class="at">)]</span></span>
<span id="cb78-31"><a href="#cb78-31" aria-hidden="true" tabindex="-1"></a>    <span class="kw">pub</span> <span class="kw">fn</span> set_config(<span class="op">&amp;</span><span class="kw">mut</span> <span class="kw">self</span><span class="op">,</span> config<span class="op">:</span> Configuration) <span class="op">-&gt;</span> <span class="dt">Result</span><span class="op">&lt;</span>()<span class="op">,</span> <span class="bu">Error</span><span class="op">&gt;</span> <span class="op">{</span></span>
<span id="cb78-32"><a href="#cb78-32" aria-hidden="true" tabindex="-1"></a>        <span class="kw">self</span><span class="op">.</span>ensure_owner()<span class="op">?;</span></span>
<span id="cb78-33"><a href="#cb78-33" aria-hidden="true" tabindex="-1"></a>        <span class="kw">self</span><span class="op">.</span>configuration<span class="op">.</span>set(<span class="op">&amp;</span>config)<span class="op">;</span></span>
<span id="cb78-34"><a href="#cb78-34" aria-hidden="true" tabindex="-1"></a>        <span class="cn">Ok</span>(())</span>
<span id="cb78-35"><a href="#cb78-35" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb78-36"><a href="#cb78-36" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<h2 id="testing-storage-behavior">Testing Storage Behavior</h2>
<h3 id="unit-tests-for-storage-logic">Unit Tests for Storage Logic</h3>
<div class="sourceCode" id="cb79"><pre
class="sourceCode rust"><code class="sourceCode rust"><span id="cb79-1"><a href="#cb79-1" aria-hidden="true" tabindex="-1"></a><span class="at">#[</span>cfg<span class="at">(</span>test<span class="at">)]</span></span>
<span id="cb79-2"><a href="#cb79-2" aria-hidden="true" tabindex="-1"></a><span class="kw">mod</span> tests <span class="op">{</span></span>
<span id="cb79-3"><a href="#cb79-3" aria-hidden="true" tabindex="-1"></a>    <span class="kw">use</span> <span class="kw">super</span><span class="pp">::</span><span class="op">*;</span></span>
<span id="cb79-4"><a href="#cb79-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb79-5"><a href="#cb79-5" aria-hidden="true" tabindex="-1"></a>    <span class="at">#[</span><span class="pp">ink::</span>test<span class="at">]</span></span>
<span id="cb79-6"><a href="#cb79-6" aria-hidden="true" tabindex="-1"></a>    <span class="kw">fn</span> storage_operations_work() <span class="op">{</span></span>
<span id="cb79-7"><a href="#cb79-7" aria-hidden="true" tabindex="-1"></a>        <span class="kw">let</span> <span class="kw">mut</span> contract <span class="op">=</span> <span class="pp">MyContract::</span>new()<span class="op">;</span></span>
<span id="cb79-8"><a href="#cb79-8" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb79-9"><a href="#cb79-9" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Test initial state</span></span>
<span id="cb79-10"><a href="#cb79-10" aria-hidden="true" tabindex="-1"></a>        <span class="pp">assert_eq!</span>(contract<span class="op">.</span>get_value(<span class="dv">1</span>)<span class="op">,</span> <span class="cn">None</span>)<span class="op">;</span></span>
<span id="cb79-11"><a href="#cb79-11" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb79-12"><a href="#cb79-12" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Test insertion</span></span>
<span id="cb79-13"><a href="#cb79-13" aria-hidden="true" tabindex="-1"></a>        contract<span class="op">.</span>set_value(<span class="dv">1</span><span class="op">,</span> <span class="dv">42</span>)<span class="op">;</span></span>
<span id="cb79-14"><a href="#cb79-14" aria-hidden="true" tabindex="-1"></a>        <span class="pp">assert_eq!</span>(contract<span class="op">.</span>get_value(<span class="dv">1</span>)<span class="op">,</span> <span class="cn">Some</span>(<span class="dv">42</span>))<span class="op">;</span></span>
<span id="cb79-15"><a href="#cb79-15" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb79-16"><a href="#cb79-16" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Test overwrite</span></span>
<span id="cb79-17"><a href="#cb79-17" aria-hidden="true" tabindex="-1"></a>        contract<span class="op">.</span>set_value(<span class="dv">1</span><span class="op">,</span> <span class="dv">100</span>)<span class="op">;</span></span>
<span id="cb79-18"><a href="#cb79-18" aria-hidden="true" tabindex="-1"></a>        <span class="pp">assert_eq!</span>(contract<span class="op">.</span>get_value(<span class="dv">1</span>)<span class="op">,</span> <span class="cn">Some</span>(<span class="dv">100</span>))<span class="op">;</span></span>
<span id="cb79-19"><a href="#cb79-19" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb79-20"><a href="#cb79-20" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Test multiple keys</span></span>
<span id="cb79-21"><a href="#cb79-21" aria-hidden="true" tabindex="-1"></a>        contract<span class="op">.</span>set_value(<span class="dv">2</span><span class="op">,</span> <span class="dv">200</span>)<span class="op">;</span></span>
<span id="cb79-22"><a href="#cb79-22" aria-hidden="true" tabindex="-1"></a>        <span class="pp">assert_eq!</span>(contract<span class="op">.</span>get_value(<span class="dv">1</span>)<span class="op">,</span> <span class="cn">Some</span>(<span class="dv">100</span>))<span class="op">;</span></span>
<span id="cb79-23"><a href="#cb79-23" aria-hidden="true" tabindex="-1"></a>        <span class="pp">assert_eq!</span>(contract<span class="op">.</span>get_value(<span class="dv">2</span>)<span class="op">,</span> <span class="cn">Some</span>(<span class="dv">200</span>))<span class="op">;</span></span>
<span id="cb79-24"><a href="#cb79-24" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb79-25"><a href="#cb79-25" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb79-26"><a href="#cb79-26" aria-hidden="true" tabindex="-1"></a>    <span class="at">#[</span><span class="pp">ink::</span>test<span class="at">]</span></span>
<span id="cb79-27"><a href="#cb79-27" aria-hidden="true" tabindex="-1"></a>    <span class="kw">fn</span> large_data_storage() <span class="op">{</span></span>
<span id="cb79-28"><a href="#cb79-28" aria-hidden="true" tabindex="-1"></a>        <span class="kw">let</span> <span class="kw">mut</span> contract <span class="op">=</span> <span class="pp">MyContract::</span>new()<span class="op">;</span></span>
<span id="cb79-29"><a href="#cb79-29" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb79-30"><a href="#cb79-30" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Test storage of larger data structures</span></span>
<span id="cb79-31"><a href="#cb79-31" aria-hidden="true" tabindex="-1"></a>        <span class="kw">let</span> large_vec<span class="op">:</span> <span class="dt">Vec</span><span class="op">&lt;</span><span class="dt">u8</span><span class="op">&gt;</span> <span class="op">=</span> (<span class="dv">0</span><span class="op">..</span><span class="dv">1000</span>)<span class="op">.</span>map(<span class="op">|</span>i<span class="op">|</span> (i <span class="op">%</span> <span class="dv">256</span>) <span class="kw">as</span> <span class="dt">u8</span>)<span class="op">.</span>collect()<span class="op">;</span></span>
<span id="cb79-32"><a href="#cb79-32" aria-hidden="true" tabindex="-1"></a>        contract<span class="op">.</span>set_large_data(large_vec<span class="op">.</span>clone())<span class="op">;</span></span>
<span id="cb79-33"><a href="#cb79-33" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb79-34"><a href="#cb79-34" aria-hidden="true" tabindex="-1"></a>        <span class="pp">assert_eq!</span>(contract<span class="op">.</span>get_large_data()<span class="op">,</span> <span class="cn">Some</span>(large_vec))<span class="op">;</span></span>
<span id="cb79-35"><a href="#cb79-35" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb79-36"><a href="#cb79-36" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb79-37"><a href="#cb79-37" aria-hidden="true" tabindex="-1"></a>    <span class="at">#[</span><span class="pp">ink::</span>test<span class="at">]</span> </span>
<span id="cb79-38"><a href="#cb79-38" aria-hidden="true" tabindex="-1"></a>    <span class="kw">fn</span> mapping_edge_cases() <span class="op">{</span></span>
<span id="cb79-39"><a href="#cb79-39" aria-hidden="true" tabindex="-1"></a>        <span class="kw">let</span> <span class="kw">mut</span> contract <span class="op">=</span> <span class="pp">MyContract::</span>new()<span class="op">;</span></span>
<span id="cb79-40"><a href="#cb79-40" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb79-41"><a href="#cb79-41" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Test with complex keys</span></span>
<span id="cb79-42"><a href="#cb79-42" aria-hidden="true" tabindex="-1"></a>        <span class="kw">let</span> key1 <span class="op">=</span> (<span class="pp">AccountId::</span>from([<span class="dv">1</span><span class="op">;</span> <span class="dv">32</span>])<span class="op">,</span> <span class="dv">42u32</span>)<span class="op">;</span></span>
<span id="cb79-43"><a href="#cb79-43" aria-hidden="true" tabindex="-1"></a>        <span class="kw">let</span> key2 <span class="op">=</span> (<span class="pp">AccountId::</span>from([<span class="dv">2</span><span class="op">;</span> <span class="dv">32</span>])<span class="op">,</span> <span class="dv">42u32</span>)<span class="op">;</span></span>
<span id="cb79-44"><a href="#cb79-44" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb79-45"><a href="#cb79-45" aria-hidden="true" tabindex="-1"></a>        contract<span class="op">.</span>set_complex_value(key1<span class="op">,</span> <span class="pp">vec!</span>[<span class="dv">1</span><span class="op">,</span> <span class="dv">2</span><span class="op">,</span> <span class="dv">3</span>])<span class="op">;</span></span>
<span id="cb79-46"><a href="#cb79-46" aria-hidden="true" tabindex="-1"></a>        contract<span class="op">.</span>set_complex_value(key2<span class="op">,</span> <span class="pp">vec!</span>[<span class="dv">4</span><span class="op">,</span> <span class="dv">5</span><span class="op">,</span> <span class="dv">6</span>])<span class="op">;</span></span>
<span id="cb79-47"><a href="#cb79-47" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb79-48"><a href="#cb79-48" aria-hidden="true" tabindex="-1"></a>        <span class="pp">assert_eq!</span>(contract<span class="op">.</span>get_complex_value(key1)<span class="op">,</span> <span class="cn">Some</span>(<span class="pp">vec!</span>[<span class="dv">1</span><span class="op">,</span> <span class="dv">2</span><span class="op">,</span> <span class="dv">3</span>]))<span class="op">;</span></span>
<span id="cb79-49"><a href="#cb79-49" aria-hidden="true" tabindex="-1"></a>        <span class="pp">assert_eq!</span>(contract<span class="op">.</span>get_complex_value(key2)<span class="op">,</span> <span class="cn">Some</span>(<span class="pp">vec!</span>[<span class="dv">4</span><span class="op">,</span> <span class="dv">5</span><span class="op">,</span> <span class="dv">6</span>]))<span class="op">;</span></span>
<span id="cb79-50"><a href="#cb79-50" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb79-51"><a href="#cb79-51" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<h3 id="property-based-testing-for-storage">Property-Based Testing for
Storage</h3>
<div class="sourceCode" id="cb80"><pre
class="sourceCode rust"><code class="sourceCode rust"><span id="cb80-1"><a href="#cb80-1" aria-hidden="true" tabindex="-1"></a><span class="at">#[</span>cfg<span class="at">(</span>test<span class="at">)]</span></span>
<span id="cb80-2"><a href="#cb80-2" aria-hidden="true" tabindex="-1"></a><span class="kw">mod</span> property_tests <span class="op">{</span></span>
<span id="cb80-3"><a href="#cb80-3" aria-hidden="true" tabindex="-1"></a>    <span class="kw">use</span> <span class="kw">super</span><span class="pp">::</span><span class="op">*;</span></span>
<span id="cb80-4"><a href="#cb80-4" aria-hidden="true" tabindex="-1"></a>    <span class="kw">use</span> <span class="pp">quickcheck::</span><span class="op">{</span>quickcheck<span class="op">,</span> TestResult<span class="op">};</span></span>
<span id="cb80-5"><a href="#cb80-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb80-6"><a href="#cb80-6" aria-hidden="true" tabindex="-1"></a>    <span class="at">#[</span>quickcheck<span class="at">]</span></span>
<span id="cb80-7"><a href="#cb80-7" aria-hidden="true" tabindex="-1"></a>    <span class="kw">fn</span> storage_consistency(operations<span class="op">:</span> <span class="dt">Vec</span><span class="op">&lt;</span>(<span class="dt">u32</span><span class="op">,</span> <span class="dt">Option</span><span class="op">&lt;</span><span class="dt">u32</span><span class="op">&gt;</span>)<span class="op">&gt;</span>) <span class="op">-&gt;</span> TestResult <span class="op">{</span></span>
<span id="cb80-8"><a href="#cb80-8" aria-hidden="true" tabindex="-1"></a>        <span class="kw">let</span> <span class="kw">mut</span> contract <span class="op">=</span> <span class="pp">MyContract::</span>new()<span class="op">;</span></span>
<span id="cb80-9"><a href="#cb80-9" aria-hidden="true" tabindex="-1"></a>        <span class="kw">let</span> <span class="kw">mut</span> expected_state <span class="op">=</span> <span class="pp">std::collections::HashMap::</span>new()<span class="op">;</span></span>
<span id="cb80-10"><a href="#cb80-10" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb80-11"><a href="#cb80-11" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> (key<span class="op">,</span> value_opt) <span class="kw">in</span> operations <span class="op">{</span></span>
<span id="cb80-12"><a href="#cb80-12" aria-hidden="true" tabindex="-1"></a>            <span class="cf">match</span> value_opt <span class="op">{</span></span>
<span id="cb80-13"><a href="#cb80-13" aria-hidden="true" tabindex="-1"></a>                <span class="cn">Some</span>(value) <span class="op">=&gt;</span> <span class="op">{</span></span>
<span id="cb80-14"><a href="#cb80-14" aria-hidden="true" tabindex="-1"></a>                    contract<span class="op">.</span>set_value(key<span class="op">,</span> value)<span class="op">;</span></span>
<span id="cb80-15"><a href="#cb80-15" aria-hidden="true" tabindex="-1"></a>                    expected_state<span class="op">.</span>insert(key<span class="op">,</span> value)<span class="op">;</span></span>
<span id="cb80-16"><a href="#cb80-16" aria-hidden="true" tabindex="-1"></a>                <span class="op">}</span></span>
<span id="cb80-17"><a href="#cb80-17" aria-hidden="true" tabindex="-1"></a>                <span class="cn">None</span> <span class="op">=&gt;</span> <span class="op">{</span></span>
<span id="cb80-18"><a href="#cb80-18" aria-hidden="true" tabindex="-1"></a>                    contract<span class="op">.</span>remove_value(key)<span class="op">;</span></span>
<span id="cb80-19"><a href="#cb80-19" aria-hidden="true" tabindex="-1"></a>                    expected_state<span class="op">.</span>remove(<span class="op">&amp;</span>key)<span class="op">;</span></span>
<span id="cb80-20"><a href="#cb80-20" aria-hidden="true" tabindex="-1"></a>                <span class="op">}</span></span>
<span id="cb80-21"><a href="#cb80-21" aria-hidden="true" tabindex="-1"></a>            <span class="op">}</span></span>
<span id="cb80-22"><a href="#cb80-22" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb80-23"><a href="#cb80-23" aria-hidden="true" tabindex="-1"></a>            <span class="co">// Verify consistency after each operation</span></span>
<span id="cb80-24"><a href="#cb80-24" aria-hidden="true" tabindex="-1"></a>            <span class="cf">for</span> (<span class="op">&amp;</span>check_key<span class="op">,</span> <span class="op">&amp;</span>expected_value) <span class="kw">in</span> <span class="op">&amp;</span>expected_state <span class="op">{</span></span>
<span id="cb80-25"><a href="#cb80-25" aria-hidden="true" tabindex="-1"></a>                <span class="cf">if</span> contract<span class="op">.</span>get_value(check_key) <span class="op">!=</span> <span class="cn">Some</span>(expected_value) <span class="op">{</span></span>
<span id="cb80-26"><a href="#cb80-26" aria-hidden="true" tabindex="-1"></a>                    <span class="cf">return</span> <span class="pp">TestResult::</span>failed()<span class="op">;</span></span>
<span id="cb80-27"><a href="#cb80-27" aria-hidden="true" tabindex="-1"></a>                <span class="op">}</span></span>
<span id="cb80-28"><a href="#cb80-28" aria-hidden="true" tabindex="-1"></a>            <span class="op">}</span></span>
<span id="cb80-29"><a href="#cb80-29" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb80-30"><a href="#cb80-30" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb80-31"><a href="#cb80-31" aria-hidden="true" tabindex="-1"></a>        <span class="pp">TestResult::</span>passed()</span>
<span id="cb80-32"><a href="#cb80-32" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb80-33"><a href="#cb80-33" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<h2 id="common-storage-pitfalls-and-solutions">Common Storage Pitfalls
and Solutions</h2>
<h3 id="pitfall-1-large-vector-modifications">Pitfall 1: Large Vector
Modifications</h3>
<div class="sourceCode" id="cb81"><pre
class="sourceCode rust"><code class="sourceCode rust"><span id="cb81-1"><a href="#cb81-1" aria-hidden="true" tabindex="-1"></a><span class="co">// ❌ Problem: Modifying large vectors is extremely expensive</span></span>
<span id="cb81-2"><a href="#cb81-2" aria-hidden="true" tabindex="-1"></a><span class="at">#[</span>ink<span class="at">(</span>storage<span class="at">)]</span></span>
<span id="cb81-3"><a href="#cb81-3" aria-hidden="true" tabindex="-1"></a><span class="kw">pub</span> <span class="kw">struct</span> ExpensiveContract <span class="op">{</span></span>
<span id="cb81-4"><a href="#cb81-4" aria-hidden="true" tabindex="-1"></a>    items<span class="op">:</span> <span class="dt">Vec</span><span class="op">&lt;</span>Item<span class="op">&gt;,</span>  <span class="co">// Gets rewritten entirely on each modification</span></span>
<span id="cb81-5"><a href="#cb81-5" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb81-6"><a href="#cb81-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb81-7"><a href="#cb81-7" aria-hidden="true" tabindex="-1"></a><span class="co">// ❌ This rewrites the entire vector for each push</span></span>
<span id="cb81-8"><a href="#cb81-8" aria-hidden="true" tabindex="-1"></a><span class="kw">impl</span> ExpensiveContract <span class="op">{</span></span>
<span id="cb81-9"><a href="#cb81-9" aria-hidden="true" tabindex="-1"></a>    <span class="at">#[</span>ink<span class="at">(</span>message<span class="at">)]</span></span>
<span id="cb81-10"><a href="#cb81-10" aria-hidden="true" tabindex="-1"></a>    <span class="kw">pub</span> <span class="kw">fn</span> add_item(<span class="op">&amp;</span><span class="kw">mut</span> <span class="kw">self</span><span class="op">,</span> item<span class="op">:</span> Item) <span class="op">{</span></span>
<span id="cb81-11"><a href="#cb81-11" aria-hidden="true" tabindex="-1"></a>        <span class="kw">self</span><span class="op">.</span>items<span class="op">.</span>push(item)<span class="op">;</span> <span class="co">// O(n) gas cost!</span></span>
<span id="cb81-12"><a href="#cb81-12" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb81-13"><a href="#cb81-13" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb81-14"><a href="#cb81-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb81-15"><a href="#cb81-15" aria-hidden="true" tabindex="-1"></a><span class="co">// ✅ Solution: Use Mapping for individual item access</span></span>
<span id="cb81-16"><a href="#cb81-16" aria-hidden="true" tabindex="-1"></a><span class="at">#[</span>ink<span class="at">(</span>storage<span class="at">)]</span></span>
<span id="cb81-17"><a href="#cb81-17" aria-hidden="true" tabindex="-1"></a><span class="kw">pub</span> <span class="kw">struct</span> EfficientContract <span class="op">{</span></span>
<span id="cb81-18"><a href="#cb81-18" aria-hidden="true" tabindex="-1"></a>    items<span class="op">:</span> Mapping<span class="op">&lt;</span><span class="dt">u32</span><span class="op">,</span> Item<span class="op">&gt;,</span></span>
<span id="cb81-19"><a href="#cb81-19" aria-hidden="true" tabindex="-1"></a>    item_count<span class="op">:</span> <span class="dt">u32</span><span class="op">,</span></span>
<span id="cb81-20"><a href="#cb81-20" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb81-21"><a href="#cb81-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb81-22"><a href="#cb81-22" aria-hidden="true" tabindex="-1"></a><span class="kw">impl</span> EfficientContract <span class="op">{</span></span>
<span id="cb81-23"><a href="#cb81-23" aria-hidden="true" tabindex="-1"></a>    <span class="at">#[</span>ink<span class="at">(</span>message<span class="at">)]</span></span>
<span id="cb81-24"><a href="#cb81-24" aria-hidden="true" tabindex="-1"></a>    <span class="kw">pub</span> <span class="kw">fn</span> add_item(<span class="op">&amp;</span><span class="kw">mut</span> <span class="kw">self</span><span class="op">,</span> item<span class="op">:</span> Item) <span class="op">{</span></span>
<span id="cb81-25"><a href="#cb81-25" aria-hidden="true" tabindex="-1"></a>        <span class="kw">self</span><span class="op">.</span>items<span class="op">.</span>insert(<span class="kw">self</span><span class="op">.</span>item_count<span class="op">,</span> <span class="op">&amp;</span>item)<span class="op">;</span> <span class="co">// O(1) gas cost</span></span>
<span id="cb81-26"><a href="#cb81-26" aria-hidden="true" tabindex="-1"></a>        <span class="kw">self</span><span class="op">.</span>item_count <span class="op">+=</span> <span class="dv">1</span><span class="op">;</span></span>
<span id="cb81-27"><a href="#cb81-27" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb81-28"><a href="#cb81-28" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<h3 id="pitfall-2-inefficient-existence-checks">Pitfall 2: Inefficient
Existence Checks</h3>
<div class="sourceCode" id="cb82"><pre
class="sourceCode rust"><code class="sourceCode rust"><span id="cb82-1"><a href="#cb82-1" aria-hidden="true" tabindex="-1"></a><span class="co">// ❌ Problem: Loading entire values just to check existence</span></span>
<span id="cb82-2"><a href="#cb82-2" aria-hidden="true" tabindex="-1"></a><span class="at">#[</span>ink<span class="at">(</span>message<span class="at">)]</span></span>
<span id="cb82-3"><a href="#cb82-3" aria-hidden="true" tabindex="-1"></a><span class="kw">pub</span> <span class="kw">fn</span> expensive_contains(<span class="op">&amp;</span><span class="kw">self</span><span class="op">,</span> user<span class="op">:</span> AccountId) <span class="op">-&gt;</span> <span class="dt">bool</span> <span class="op">{</span></span>
<span id="cb82-4"><a href="#cb82-4" aria-hidden="true" tabindex="-1"></a>    <span class="kw">self</span><span class="op">.</span>user_data<span class="op">.</span>get(user)<span class="op">.</span>is_some() <span class="co">// Loads entire UserData struct!</span></span>
<span id="cb82-5"><a href="#cb82-5" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb82-6"><a href="#cb82-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb82-7"><a href="#cb82-7" aria-hidden="true" tabindex="-1"></a><span class="co">// ✅ Solution: Use separate existence mapping</span></span>
<span id="cb82-8"><a href="#cb82-8" aria-hidden="true" tabindex="-1"></a><span class="at">#[</span>ink<span class="at">(</span>storage<span class="at">)]</span></span>
<span id="cb82-9"><a href="#cb82-9" aria-hidden="true" tabindex="-1"></a><span class="kw">pub</span> <span class="kw">struct</span> OptimizedContract <span class="op">{</span></span>
<span id="cb82-10"><a href="#cb82-10" aria-hidden="true" tabindex="-1"></a>    user_data<span class="op">:</span> Mapping<span class="op">&lt;</span>AccountId<span class="op">,</span> UserData<span class="op">&gt;,</span></span>
<span id="cb82-11"><a href="#cb82-11" aria-hidden="true" tabindex="-1"></a>    user_exists<span class="op">:</span> Mapping<span class="op">&lt;</span>AccountId<span class="op">,</span> ()<span class="op">&gt;,</span> <span class="co">// Just for existence checks</span></span>
<span id="cb82-12"><a href="#cb82-12" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb82-13"><a href="#cb82-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb82-14"><a href="#cb82-14" aria-hidden="true" tabindex="-1"></a><span class="at">#[</span>ink<span class="at">(</span>message<span class="at">)]</span></span>
<span id="cb82-15"><a href="#cb82-15" aria-hidden="true" tabindex="-1"></a><span class="kw">pub</span> <span class="kw">fn</span> cheap_contains(<span class="op">&amp;</span><span class="kw">self</span><span class="op">,</span> user<span class="op">:</span> AccountId) <span class="op">-&gt;</span> <span class="dt">bool</span> <span class="op">{</span></span>
<span id="cb82-16"><a href="#cb82-16" aria-hidden="true" tabindex="-1"></a>    <span class="kw">self</span><span class="op">.</span>user_exists<span class="op">.</span>contains(user) <span class="co">// Only checks key existence</span></span>
<span id="cb82-17"><a href="#cb82-17" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<h3 id="pitfall-3-unbounded-loops-over-storage">Pitfall 3: Unbounded
Loops Over Storage</h3>
<div class="sourceCode" id="cb83"><pre
class="sourceCode rust"><code class="sourceCode rust"><span id="cb83-1"><a href="#cb83-1" aria-hidden="true" tabindex="-1"></a><span class="co">// ❌ Problem: Loops that could exceed gas limits</span></span>
<span id="cb83-2"><a href="#cb83-2" aria-hidden="true" tabindex="-1"></a><span class="at">#[</span>ink<span class="at">(</span>message<span class="at">)]</span></span>
<span id="cb83-3"><a href="#cb83-3" aria-hidden="true" tabindex="-1"></a><span class="kw">pub</span> <span class="kw">fn</span> dangerous_sum(<span class="op">&amp;</span><span class="kw">self</span>) <span class="op">-&gt;</span> <span class="dt">u32</span> <span class="op">{</span></span>
<span id="cb83-4"><a href="#cb83-4" aria-hidden="true" tabindex="-1"></a>    <span class="kw">let</span> <span class="kw">mut</span> sum <span class="op">=</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb83-5"><a href="#cb83-5" aria-hidden="true" tabindex="-1"></a>    <span class="co">// This could run out of gas if there are many items</span></span>
<span id="cb83-6"><a href="#cb83-6" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> i <span class="kw">in</span> <span class="dv">0</span><span class="op">..</span><span class="kw">self</span><span class="op">.</span>item_count <span class="op">{</span></span>
<span id="cb83-7"><a href="#cb83-7" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="kw">let</span> <span class="cn">Some</span>(value) <span class="op">=</span> <span class="kw">self</span><span class="op">.</span>items<span class="op">.</span>get(i) <span class="op">{</span></span>
<span id="cb83-8"><a href="#cb83-8" aria-hidden="true" tabindex="-1"></a>            sum <span class="op">+=</span> value<span class="op">;</span></span>
<span id="cb83-9"><a href="#cb83-9" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb83-10"><a href="#cb83-10" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb83-11"><a href="#cb83-11" aria-hidden="true" tabindex="-1"></a>    sum</span>
<span id="cb83-12"><a href="#cb83-12" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb83-13"><a href="#cb83-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb83-14"><a href="#cb83-14" aria-hidden="true" tabindex="-1"></a><span class="co">// ✅ Solution: Implement pagination or maintain aggregates</span></span>
<span id="cb83-15"><a href="#cb83-15" aria-hidden="true" tabindex="-1"></a><span class="at">#[</span>ink<span class="at">(</span>storage<span class="at">)]</span></span>
<span id="cb83-16"><a href="#cb83-16" aria-hidden="true" tabindex="-1"></a><span class="kw">pub</span> <span class="kw">struct</span> SafeContract <span class="op">{</span></span>
<span id="cb83-17"><a href="#cb83-17" aria-hidden="true" tabindex="-1"></a>    items<span class="op">:</span> Mapping<span class="op">&lt;</span><span class="dt">u32</span><span class="op">,</span> <span class="dt">u32</span><span class="op">&gt;,</span></span>
<span id="cb83-18"><a href="#cb83-18" aria-hidden="true" tabindex="-1"></a>    item_count<span class="op">:</span> <span class="dt">u32</span><span class="op">,</span></span>
<span id="cb83-19"><a href="#cb83-19" aria-hidden="true" tabindex="-1"></a>    running_sum<span class="op">:</span> <span class="dt">u32</span><span class="op">,</span> <span class="co">// Maintained incrementally</span></span>
<span id="cb83-20"><a href="#cb83-20" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb83-21"><a href="#cb83-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb83-22"><a href="#cb83-22" aria-hidden="true" tabindex="-1"></a><span class="at">#[</span>ink<span class="at">(</span>message<span class="at">)]</span></span>
<span id="cb83-23"><a href="#cb83-23" aria-hidden="true" tabindex="-1"></a><span class="kw">pub</span> <span class="kw">fn</span> safe_sum(<span class="op">&amp;</span><span class="kw">self</span>) <span class="op">-&gt;</span> <span class="dt">u32</span> <span class="op">{</span></span>
<span id="cb83-24"><a href="#cb83-24" aria-hidden="true" tabindex="-1"></a>    <span class="kw">self</span><span class="op">.</span>running_sum <span class="co">// O(1) access</span></span>
<span id="cb83-25"><a href="#cb83-25" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb83-26"><a href="#cb83-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb83-27"><a href="#cb83-27" aria-hidden="true" tabindex="-1"></a><span class="at">#[</span>ink<span class="at">(</span>message<span class="at">)]</span></span>
<span id="cb83-28"><a href="#cb83-28" aria-hidden="true" tabindex="-1"></a><span class="kw">pub</span> <span class="kw">fn</span> add_item(<span class="op">&amp;</span><span class="kw">mut</span> <span class="kw">self</span><span class="op">,</span> value<span class="op">:</span> <span class="dt">u32</span>) <span class="op">{</span></span>
<span id="cb83-29"><a href="#cb83-29" aria-hidden="true" tabindex="-1"></a>    <span class="kw">self</span><span class="op">.</span>items<span class="op">.</span>insert(<span class="kw">self</span><span class="op">.</span>item_count<span class="op">,</span> <span class="op">&amp;</span>value)<span class="op">;</span></span>
<span id="cb83-30"><a href="#cb83-30" aria-hidden="true" tabindex="-1"></a>    <span class="kw">self</span><span class="op">.</span>running_sum <span class="op">+=</span> value<span class="op">;</span> <span class="co">// Update aggregate</span></span>
<span id="cb83-31"><a href="#cb83-31" aria-hidden="true" tabindex="-1"></a>    <span class="kw">self</span><span class="op">.</span>item_count <span class="op">+=</span> <span class="dv">1</span><span class="op">;</span></span>
<span id="cb83-32"><a href="#cb83-32" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<h2 id="summary-2">Summary</h2>
<p>In this chapter, we’ve explored the sophisticated storage system that
makes ink! contracts efficient and scalable:</p>
<p><strong>Key Storage Concepts:</strong></p>
<ol type="1">
<li><p><strong>Single Storage Root</strong>: Every contract has exactly
one <code>#[ink(storage)]</code> struct that serves as the root of all
persistent data</p></li>
<li><p><strong>Storage Key Generation</strong>: Deterministic key
generation ensures consistent access patterns and upgrade
safety</p></li>
<li><p><strong>Type Support</strong>: From primitives to complex custom
types, with required SCALE codec implementations</p></li>
<li><p><strong>Mapping Efficiency</strong>: The primary tool for
key-value storage with <span class="math inline"><em>O</em>(1)</span>
access patterns</p></li>
</ol>
<p><strong>Advanced Techniques:</strong></p>
<ol start="5" type="1">
<li><p><strong>Lazy Loading</strong>: <code>Lazy&lt;T&gt;</code>
prevents automatic loading of large, infrequently accessed data</p></li>
<li><p><strong>Memory Packing</strong>: <code>Packed&lt;T&gt;</code>
optimizes storage layout for small structs</p></li>
<li><p><strong>Storage Patterns</strong>: Hierarchical data with
compound keys, pagination for large sets, and efficient existence
checks</p></li>
</ol>
<p><strong>Optimization Strategies:</strong></p>
<ol start="8" type="1">
<li><p><strong>Gas Efficiency</strong>: Minimize storage operations, use
appropriate data types, and implement lazy initialization</p></li>
<li><p><strong>Avoiding Pitfalls</strong>: Understanding why large
vector modifications, inefficient existence checks, and unbounded loops
can be expensive</p></li>
</ol>
<p><strong>Testing Approaches:</strong></p>
<ol start="10" type="1">
<li><strong>Comprehensive Testing</strong>: Both unit tests for logic
and property-based tests for storage consistency</li>
</ol>
<p>With a solid understanding of storage management, you’re ready to
build the logic layer that operates on this persistent state. In the
next chapter, we’ll explore how to design robust message handlers and
constructors that leverage your storage system effectively.</p>
<hr />
<h1 id="chapter-4-the-logic-layer-messages-and-constructors">Chapter 4:
The Logic Layer: Messages and Constructors</h1>
<p>While storage defines what your contract knows, messages and
constructors define what your contract can do. These form the public
interface through which users, other contracts, and external
applications interact with your smart contract. Understanding how to
design robust, secure, and efficient message handlers is crucial for
building production-ready contracts.</p>
<p>In this chapter, we’ll explore constructor patterns for flexible
initialization, message design for clear APIs, payable messages for
handling native token transfers, and environmental information access
for context-aware contract behavior.</p>
<h2 id="constructor-patterns-flexible-initialization">Constructor
Patterns: Flexible Initialization</h2>
<p>Constructors are your contract’s entry point—they execute exactly
once during deployment and establish the initial state. Well-designed
constructors provide flexibility while maintaining security and
correctness guarantees.</p>
<h3 id="multiple-constructor-pattern">Multiple Constructor Pattern</h3>
<p>Unlike many smart contract platforms that allow only one constructor,
ink! supports multiple constructors, enabling flexible initialization
patterns:</p>
<div class="sourceCode" id="cb84"><pre
class="sourceCode rust"><code class="sourceCode rust"><span id="cb84-1"><a href="#cb84-1" aria-hidden="true" tabindex="-1"></a><span class="at">#[</span><span class="pp">ink::</span>contract<span class="at">]</span></span>
<span id="cb84-2"><a href="#cb84-2" aria-hidden="true" tabindex="-1"></a><span class="kw">mod</span> flexible_token <span class="op">{</span></span>
<span id="cb84-3"><a href="#cb84-3" aria-hidden="true" tabindex="-1"></a>    <span class="kw">use</span> <span class="pp">ink::storage::</span>Mapping<span class="op">;</span></span>
<span id="cb84-4"><a href="#cb84-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb84-5"><a href="#cb84-5" aria-hidden="true" tabindex="-1"></a>    <span class="at">#[</span>ink<span class="at">(</span>storage<span class="at">)]</span></span>
<span id="cb84-6"><a href="#cb84-6" aria-hidden="true" tabindex="-1"></a>    <span class="kw">pub</span> <span class="kw">struct</span> FlexibleToken <span class="op">{</span></span>
<span id="cb84-7"><a href="#cb84-7" aria-hidden="true" tabindex="-1"></a>        total_supply<span class="op">:</span> Balance<span class="op">,</span></span>
<span id="cb84-8"><a href="#cb84-8" aria-hidden="true" tabindex="-1"></a>        balances<span class="op">:</span> Mapping<span class="op">&lt;</span>AccountId<span class="op">,</span> Balance<span class="op">&gt;,</span></span>
<span id="cb84-9"><a href="#cb84-9" aria-hidden="true" tabindex="-1"></a>        owner<span class="op">:</span> AccountId<span class="op">,</span></span>
<span id="cb84-10"><a href="#cb84-10" aria-hidden="true" tabindex="-1"></a>        name<span class="op">:</span> <span class="dt">String</span><span class="op">,</span></span>
<span id="cb84-11"><a href="#cb84-11" aria-hidden="true" tabindex="-1"></a>        symbol<span class="op">:</span> <span class="dt">String</span><span class="op">,</span></span>
<span id="cb84-12"><a href="#cb84-12" aria-hidden="true" tabindex="-1"></a>        decimals<span class="op">:</span> <span class="dt">u8</span><span class="op">,</span></span>
<span id="cb84-13"><a href="#cb84-13" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb84-14"><a href="#cb84-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb84-15"><a href="#cb84-15" aria-hidden="true" tabindex="-1"></a>    <span class="at">#[</span>derive<span class="at">(</span><span class="bu">Debug</span><span class="op">,</span> <span class="bu">PartialEq</span><span class="op">,</span> <span class="bu">Eq</span><span class="op">,</span> <span class="pp">scale::</span>Encode<span class="op">,</span> <span class="pp">scale::</span>Decode<span class="at">)]</span></span>
<span id="cb84-16"><a href="#cb84-16" aria-hidden="true" tabindex="-1"></a>    <span class="at">#[</span>cfg_attr<span class="at">(</span>feature <span class="op">=</span> <span class="st">&quot;std&quot;</span><span class="op">,</span> derive<span class="at">(</span><span class="pp">scale_info::</span>TypeInfo<span class="at">))]</span></span>
<span id="cb84-17"><a href="#cb84-17" aria-hidden="true" tabindex="-1"></a>    <span class="kw">pub</span> <span class="kw">enum</span> <span class="bu">Error</span> <span class="op">{</span></span>
<span id="cb84-18"><a href="#cb84-18" aria-hidden="true" tabindex="-1"></a>        InvalidParameters<span class="op">,</span></span>
<span id="cb84-19"><a href="#cb84-19" aria-hidden="true" tabindex="-1"></a>        InsufficientBalance<span class="op">,</span></span>
<span id="cb84-20"><a href="#cb84-20" aria-hidden="true" tabindex="-1"></a>        Unauthorized<span class="op">,</span></span>
<span id="cb84-21"><a href="#cb84-21" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb84-22"><a href="#cb84-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb84-23"><a href="#cb84-23" aria-hidden="true" tabindex="-1"></a>    <span class="kw">impl</span> FlexibleToken <span class="op">{</span></span>
<span id="cb84-24"><a href="#cb84-24" aria-hidden="true" tabindex="-1"></a>        <span class="co">/// Standard constructor with all parameters</span></span>
<span id="cb84-25"><a href="#cb84-25" aria-hidden="true" tabindex="-1"></a>        <span class="at">#[</span>ink<span class="at">(</span>constructor<span class="at">)]</span></span>
<span id="cb84-26"><a href="#cb84-26" aria-hidden="true" tabindex="-1"></a>        <span class="kw">pub</span> <span class="kw">fn</span> new(</span>
<span id="cb84-27"><a href="#cb84-27" aria-hidden="true" tabindex="-1"></a>            total_supply<span class="op">:</span> Balance<span class="op">,</span></span>
<span id="cb84-28"><a href="#cb84-28" aria-hidden="true" tabindex="-1"></a>            name<span class="op">:</span> <span class="dt">String</span><span class="op">,</span></span>
<span id="cb84-29"><a href="#cb84-29" aria-hidden="true" tabindex="-1"></a>            symbol<span class="op">:</span> <span class="dt">String</span><span class="op">,</span></span>
<span id="cb84-30"><a href="#cb84-30" aria-hidden="true" tabindex="-1"></a>            decimals<span class="op">:</span> <span class="dt">u8</span><span class="op">,</span></span>
<span id="cb84-31"><a href="#cb84-31" aria-hidden="true" tabindex="-1"></a>        ) <span class="op">-&gt;</span> <span class="dt">Result</span><span class="op">&lt;</span><span class="dt">Self</span><span class="op">,</span> <span class="bu">Error</span><span class="op">&gt;</span> <span class="op">{</span></span>
<span id="cb84-32"><a href="#cb84-32" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> total_supply <span class="op">==</span> <span class="dv">0</span> <span class="op">||</span> name<span class="op">.</span>is_empty() <span class="op">||</span> symbol<span class="op">.</span>is_empty() <span class="op">{</span></span>
<span id="cb84-33"><a href="#cb84-33" aria-hidden="true" tabindex="-1"></a>                <span class="cf">return</span> <span class="cn">Err</span>(<span class="bu">Error</span><span class="pp">::</span>InvalidParameters)<span class="op">;</span></span>
<span id="cb84-34"><a href="#cb84-34" aria-hidden="true" tabindex="-1"></a>            <span class="op">}</span></span>
<span id="cb84-35"><a href="#cb84-35" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb84-36"><a href="#cb84-36" aria-hidden="true" tabindex="-1"></a>            <span class="kw">let</span> caller <span class="op">=</span> <span class="dt">Self</span><span class="pp">::</span>env()<span class="op">.</span>caller()<span class="op">;</span></span>
<span id="cb84-37"><a href="#cb84-37" aria-hidden="true" tabindex="-1"></a>            <span class="kw">let</span> <span class="kw">mut</span> balances <span class="op">=</span> <span class="pp">Mapping::</span><span class="kw">default</span>()<span class="op">;</span></span>
<span id="cb84-38"><a href="#cb84-38" aria-hidden="true" tabindex="-1"></a>            balances<span class="op">.</span>insert(caller<span class="op">,</span> <span class="op">&amp;</span>total_supply)<span class="op">;</span></span>
<span id="cb84-39"><a href="#cb84-39" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb84-40"><a href="#cb84-40" aria-hidden="true" tabindex="-1"></a>            <span class="cn">Ok</span>(<span class="dt">Self</span> <span class="op">{</span></span>
<span id="cb84-41"><a href="#cb84-41" aria-hidden="true" tabindex="-1"></a>                total_supply<span class="op">,</span></span>
<span id="cb84-42"><a href="#cb84-42" aria-hidden="true" tabindex="-1"></a>                balances<span class="op">,</span></span>
<span id="cb84-43"><a href="#cb84-43" aria-hidden="true" tabindex="-1"></a>                owner<span class="op">:</span> caller<span class="op">,</span></span>
<span id="cb84-44"><a href="#cb84-44" aria-hidden="true" tabindex="-1"></a>                name<span class="op">,</span></span>
<span id="cb84-45"><a href="#cb84-45" aria-hidden="true" tabindex="-1"></a>                symbol<span class="op">,</span></span>
<span id="cb84-46"><a href="#cb84-46" aria-hidden="true" tabindex="-1"></a>                decimals<span class="op">,</span></span>
<span id="cb84-47"><a href="#cb84-47" aria-hidden="true" tabindex="-1"></a>            <span class="op">}</span>)</span>
<span id="cb84-48"><a href="#cb84-48" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb84-49"><a href="#cb84-49" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb84-50"><a href="#cb84-50" aria-hidden="true" tabindex="-1"></a>        <span class="co">/// Simple constructor with defaults</span></span>
<span id="cb84-51"><a href="#cb84-51" aria-hidden="true" tabindex="-1"></a>        <span class="at">#[</span>ink<span class="at">(</span>constructor<span class="at">)]</span></span>
<span id="cb84-52"><a href="#cb84-52" aria-hidden="true" tabindex="-1"></a>        <span class="kw">pub</span> <span class="kw">fn</span> new_simple(total_supply<span class="op">:</span> Balance) <span class="op">-&gt;</span> <span class="dt">Result</span><span class="op">&lt;</span><span class="dt">Self</span><span class="op">,</span> <span class="bu">Error</span><span class="op">&gt;</span> <span class="op">{</span></span>
<span id="cb84-53"><a href="#cb84-53" aria-hidden="true" tabindex="-1"></a>            <span class="dt">Self</span><span class="pp">::</span>new(</span>
<span id="cb84-54"><a href="#cb84-54" aria-hidden="true" tabindex="-1"></a>                total_supply<span class="op">,</span></span>
<span id="cb84-55"><a href="#cb84-55" aria-hidden="true" tabindex="-1"></a>                <span class="st">&quot;SimpleToken&quot;</span><span class="op">.</span>to_string()<span class="op">,</span></span>
<span id="cb84-56"><a href="#cb84-56" aria-hidden="true" tabindex="-1"></a>                <span class="st">&quot;STK&quot;</span><span class="op">.</span>to_string()<span class="op">,</span></span>
<span id="cb84-57"><a href="#cb84-57" aria-hidden="true" tabindex="-1"></a>                <span class="dv">18</span><span class="op">,</span></span>
<span id="cb84-58"><a href="#cb84-58" aria-hidden="true" tabindex="-1"></a>            )</span>
<span id="cb84-59"><a href="#cb84-59" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb84-60"><a href="#cb84-60" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb84-61"><a href="#cb84-61" aria-hidden="true" tabindex="-1"></a>        <span class="co">/// Constructor for creating wrapped tokens</span></span>
<span id="cb84-62"><a href="#cb84-62" aria-hidden="true" tabindex="-1"></a>        <span class="at">#[</span>ink<span class="at">(</span>constructor<span class="at">)]</span></span>
<span id="cb84-63"><a href="#cb84-63" aria-hidden="true" tabindex="-1"></a>        <span class="kw">pub</span> <span class="kw">fn</span> new_wrapped(</span>
<span id="cb84-64"><a href="#cb84-64" aria-hidden="true" tabindex="-1"></a>            name<span class="op">:</span> <span class="dt">String</span><span class="op">,</span></span>
<span id="cb84-65"><a href="#cb84-65" aria-hidden="true" tabindex="-1"></a>            symbol<span class="op">:</span> <span class="dt">String</span><span class="op">,</span></span>
<span id="cb84-66"><a href="#cb84-66" aria-hidden="true" tabindex="-1"></a>        ) <span class="op">-&gt;</span> <span class="dt">Result</span><span class="op">&lt;</span><span class="dt">Self</span><span class="op">,</span> <span class="bu">Error</span><span class="op">&gt;</span> <span class="op">{</span></span>
<span id="cb84-67"><a href="#cb84-67" aria-hidden="true" tabindex="-1"></a>            <span class="dt">Self</span><span class="pp">::</span>new(<span class="dv">0</span><span class="op">,</span> name<span class="op">,</span> symbol<span class="op">,</span> <span class="dv">18</span>)</span>
<span id="cb84-68"><a href="#cb84-68" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb84-69"><a href="#cb84-69" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb84-70"><a href="#cb84-70" aria-hidden="true" tabindex="-1"></a>        <span class="co">/// Constructor that mints initial supply to specific account</span></span>
<span id="cb84-71"><a href="#cb84-71" aria-hidden="true" tabindex="-1"></a>        <span class="at">#[</span>ink<span class="at">(</span>constructor<span class="at">)]</span></span>
<span id="cb84-72"><a href="#cb84-72" aria-hidden="true" tabindex="-1"></a>        <span class="kw">pub</span> <span class="kw">fn</span> new_with_recipient(</span>
<span id="cb84-73"><a href="#cb84-73" aria-hidden="true" tabindex="-1"></a>            total_supply<span class="op">:</span> Balance<span class="op">,</span></span>
<span id="cb84-74"><a href="#cb84-74" aria-hidden="true" tabindex="-1"></a>            recipient<span class="op">:</span> AccountId<span class="op">,</span></span>
<span id="cb84-75"><a href="#cb84-75" aria-hidden="true" tabindex="-1"></a>            name<span class="op">:</span> <span class="dt">String</span><span class="op">,</span></span>
<span id="cb84-76"><a href="#cb84-76" aria-hidden="true" tabindex="-1"></a>            symbol<span class="op">:</span> <span class="dt">String</span><span class="op">,</span></span>
<span id="cb84-77"><a href="#cb84-77" aria-hidden="true" tabindex="-1"></a>        ) <span class="op">-&gt;</span> <span class="dt">Result</span><span class="op">&lt;</span><span class="dt">Self</span><span class="op">,</span> <span class="bu">Error</span><span class="op">&gt;</span> <span class="op">{</span></span>
<span id="cb84-78"><a href="#cb84-78" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> total_supply <span class="op">==</span> <span class="dv">0</span> <span class="op">||</span> name<span class="op">.</span>is_empty() <span class="op">||</span> symbol<span class="op">.</span>is_empty() <span class="op">{</span></span>
<span id="cb84-79"><a href="#cb84-79" aria-hidden="true" tabindex="-1"></a>                <span class="cf">return</span> <span class="cn">Err</span>(<span class="bu">Error</span><span class="pp">::</span>InvalidParameters)<span class="op">;</span></span>
<span id="cb84-80"><a href="#cb84-80" aria-hidden="true" tabindex="-1"></a>            <span class="op">}</span></span>
<span id="cb84-81"><a href="#cb84-81" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb84-82"><a href="#cb84-82" aria-hidden="true" tabindex="-1"></a>            <span class="kw">let</span> caller <span class="op">=</span> <span class="dt">Self</span><span class="pp">::</span>env()<span class="op">.</span>caller()<span class="op">;</span></span>
<span id="cb84-83"><a href="#cb84-83" aria-hidden="true" tabindex="-1"></a>            <span class="kw">let</span> <span class="kw">mut</span> balances <span class="op">=</span> <span class="pp">Mapping::</span><span class="kw">default</span>()<span class="op">;</span></span>
<span id="cb84-84"><a href="#cb84-84" aria-hidden="true" tabindex="-1"></a>            balances<span class="op">.</span>insert(recipient<span class="op">,</span> <span class="op">&amp;</span>total_supply)<span class="op">;</span></span>
<span id="cb84-85"><a href="#cb84-85" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb84-86"><a href="#cb84-86" aria-hidden="true" tabindex="-1"></a>            <span class="cn">Ok</span>(<span class="dt">Self</span> <span class="op">{</span></span>
<span id="cb84-87"><a href="#cb84-87" aria-hidden="true" tabindex="-1"></a>                total_supply<span class="op">,</span></span>
<span id="cb84-88"><a href="#cb84-88" aria-hidden="true" tabindex="-1"></a>                balances<span class="op">,</span></span>
<span id="cb84-89"><a href="#cb84-89" aria-hidden="true" tabindex="-1"></a>                owner<span class="op">:</span> caller<span class="op">,</span></span>
<span id="cb84-90"><a href="#cb84-90" aria-hidden="true" tabindex="-1"></a>                name<span class="op">,</span></span>
<span id="cb84-91"><a href="#cb84-91" aria-hidden="true" tabindex="-1"></a>                symbol<span class="op">,</span></span>
<span id="cb84-92"><a href="#cb84-92" aria-hidden="true" tabindex="-1"></a>                decimals<span class="op">:</span> <span class="dv">18</span><span class="op">,</span></span>
<span id="cb84-93"><a href="#cb84-93" aria-hidden="true" tabindex="-1"></a>            <span class="op">}</span>)</span>
<span id="cb84-94"><a href="#cb84-94" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb84-95"><a href="#cb84-95" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb84-96"><a href="#cb84-96" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<h3 id="constructor-validation-patterns">Constructor Validation
Patterns</h3>
<p>Implement comprehensive validation in constructors to prevent invalid
deployments:</p>
<div class="sourceCode" id="cb85"><pre
class="sourceCode rust"><code class="sourceCode rust"><span id="cb85-1"><a href="#cb85-1" aria-hidden="true" tabindex="-1"></a><span class="kw">impl</span> FlexibleToken <span class="op">{</span></span>
<span id="cb85-2"><a href="#cb85-2" aria-hidden="true" tabindex="-1"></a>    <span class="co">/// Constructor with comprehensive validation</span></span>
<span id="cb85-3"><a href="#cb85-3" aria-hidden="true" tabindex="-1"></a>    <span class="at">#[</span>ink<span class="at">(</span>constructor<span class="at">)]</span></span>
<span id="cb85-4"><a href="#cb85-4" aria-hidden="true" tabindex="-1"></a>    <span class="kw">pub</span> <span class="kw">fn</span> new_validated(</span>
<span id="cb85-5"><a href="#cb85-5" aria-hidden="true" tabindex="-1"></a>        total_supply<span class="op">:</span> Balance<span class="op">,</span></span>
<span id="cb85-6"><a href="#cb85-6" aria-hidden="true" tabindex="-1"></a>        name<span class="op">:</span> <span class="dt">String</span><span class="op">,</span></span>
<span id="cb85-7"><a href="#cb85-7" aria-hidden="true" tabindex="-1"></a>        symbol<span class="op">:</span> <span class="dt">String</span><span class="op">,</span></span>
<span id="cb85-8"><a href="#cb85-8" aria-hidden="true" tabindex="-1"></a>        decimals<span class="op">:</span> <span class="dt">u8</span><span class="op">,</span></span>
<span id="cb85-9"><a href="#cb85-9" aria-hidden="true" tabindex="-1"></a>    ) <span class="op">-&gt;</span> <span class="dt">Result</span><span class="op">&lt;</span><span class="dt">Self</span><span class="op">,</span> <span class="bu">Error</span><span class="op">&gt;</span> <span class="op">{</span></span>
<span id="cb85-10"><a href="#cb85-10" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Validate total supply</span></span>
<span id="cb85-11"><a href="#cb85-11" aria-hidden="true" tabindex="-1"></a>        <span class="dt">Self</span><span class="pp">::</span>validate_total_supply(total_supply)<span class="op">?;</span></span>
<span id="cb85-12"><a href="#cb85-12" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb85-13"><a href="#cb85-13" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Validate metadata</span></span>
<span id="cb85-14"><a href="#cb85-14" aria-hidden="true" tabindex="-1"></a>        <span class="dt">Self</span><span class="pp">::</span>validate_metadata(<span class="op">&amp;</span>name<span class="op">,</span> <span class="op">&amp;</span>symbol<span class="op">,</span> decimals)<span class="op">?;</span></span>
<span id="cb85-15"><a href="#cb85-15" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb85-16"><a href="#cb85-16" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Create instance</span></span>
<span id="cb85-17"><a href="#cb85-17" aria-hidden="true" tabindex="-1"></a>        <span class="kw">let</span> caller <span class="op">=</span> <span class="dt">Self</span><span class="pp">::</span>env()<span class="op">.</span>caller()<span class="op">;</span></span>
<span id="cb85-18"><a href="#cb85-18" aria-hidden="true" tabindex="-1"></a>        <span class="kw">let</span> <span class="kw">mut</span> balances <span class="op">=</span> <span class="pp">Mapping::</span><span class="kw">default</span>()<span class="op">;</span></span>
<span id="cb85-19"><a href="#cb85-19" aria-hidden="true" tabindex="-1"></a>        balances<span class="op">.</span>insert(caller<span class="op">,</span> <span class="op">&amp;</span>total_supply)<span class="op">;</span></span>
<span id="cb85-20"><a href="#cb85-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb85-21"><a href="#cb85-21" aria-hidden="true" tabindex="-1"></a>        <span class="cn">Ok</span>(<span class="dt">Self</span> <span class="op">{</span></span>
<span id="cb85-22"><a href="#cb85-22" aria-hidden="true" tabindex="-1"></a>            total_supply<span class="op">,</span></span>
<span id="cb85-23"><a href="#cb85-23" aria-hidden="true" tabindex="-1"></a>            balances<span class="op">,</span></span>
<span id="cb85-24"><a href="#cb85-24" aria-hidden="true" tabindex="-1"></a>            owner<span class="op">:</span> caller<span class="op">,</span></span>
<span id="cb85-25"><a href="#cb85-25" aria-hidden="true" tabindex="-1"></a>            name<span class="op">,</span></span>
<span id="cb85-26"><a href="#cb85-26" aria-hidden="true" tabindex="-1"></a>            symbol<span class="op">,</span></span>
<span id="cb85-27"><a href="#cb85-27" aria-hidden="true" tabindex="-1"></a>            decimals<span class="op">,</span></span>
<span id="cb85-28"><a href="#cb85-28" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span>)</span>
<span id="cb85-29"><a href="#cb85-29" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb85-30"><a href="#cb85-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb85-31"><a href="#cb85-31" aria-hidden="true" tabindex="-1"></a>    <span class="co">/// Validate total supply constraints</span></span>
<span id="cb85-32"><a href="#cb85-32" aria-hidden="true" tabindex="-1"></a>    <span class="kw">fn</span> validate_total_supply(total_supply<span class="op">:</span> Balance) <span class="op">-&gt;</span> <span class="dt">Result</span><span class="op">&lt;</span>()<span class="op">,</span> <span class="bu">Error</span><span class="op">&gt;</span> <span class="op">{</span></span>
<span id="cb85-33"><a href="#cb85-33" aria-hidden="true" tabindex="-1"></a>        <span class="kw">const</span> MAX_SUPPLY<span class="op">:</span> Balance <span class="op">=</span> <span class="dv">1_000_000_000_000_000_000_000</span><span class="op">;</span> <span class="co">// 1 billion with 18 decimals</span></span>
<span id="cb85-34"><a href="#cb85-34" aria-hidden="true" tabindex="-1"></a>        <span class="kw">const</span> MIN_SUPPLY<span class="op">:</span> Balance <span class="op">=</span> <span class="dv">1_000_000_000_000_000</span><span class="op">;</span> <span class="co">// 0.001 with 18 decimals</span></span>
<span id="cb85-35"><a href="#cb85-35" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb85-36"><a href="#cb85-36" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> total_supply <span class="op">==</span> <span class="dv">0</span> <span class="op">||</span> total_supply <span class="op">&gt;</span> MAX_SUPPLY <span class="op">{</span></span>
<span id="cb85-37"><a href="#cb85-37" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> <span class="cn">Err</span>(<span class="bu">Error</span><span class="pp">::</span>InvalidParameters)<span class="op">;</span></span>
<span id="cb85-38"><a href="#cb85-38" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb85-39"><a href="#cb85-39" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb85-40"><a href="#cb85-40" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> total_supply <span class="op">&lt;</span> MIN_SUPPLY <span class="op">{</span></span>
<span id="cb85-41"><a href="#cb85-41" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> <span class="cn">Err</span>(<span class="bu">Error</span><span class="pp">::</span>InvalidParameters)<span class="op">;</span></span>
<span id="cb85-42"><a href="#cb85-42" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb85-43"><a href="#cb85-43" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb85-44"><a href="#cb85-44" aria-hidden="true" tabindex="-1"></a>        <span class="cn">Ok</span>(())</span>
<span id="cb85-45"><a href="#cb85-45" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb85-46"><a href="#cb85-46" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb85-47"><a href="#cb85-47" aria-hidden="true" tabindex="-1"></a>    <span class="co">/// Validate token metadata</span></span>
<span id="cb85-48"><a href="#cb85-48" aria-hidden="true" tabindex="-1"></a>    <span class="kw">fn</span> validate_metadata(name<span class="op">:</span> <span class="op">&amp;</span><span class="dt">str</span><span class="op">,</span> symbol<span class="op">:</span> <span class="op">&amp;</span><span class="dt">str</span><span class="op">,</span> decimals<span class="op">:</span> <span class="dt">u8</span>) <span class="op">-&gt;</span> <span class="dt">Result</span><span class="op">&lt;</span>()<span class="op">,</span> <span class="bu">Error</span><span class="op">&gt;</span> <span class="op">{</span></span>
<span id="cb85-49"><a href="#cb85-49" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Name validation</span></span>
<span id="cb85-50"><a href="#cb85-50" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> name<span class="op">.</span>is_empty() <span class="op">||</span> name<span class="op">.</span>len() <span class="op">&gt;</span> <span class="dv">50</span> <span class="op">{</span></span>
<span id="cb85-51"><a href="#cb85-51" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> <span class="cn">Err</span>(<span class="bu">Error</span><span class="pp">::</span>InvalidParameters)<span class="op">;</span></span>
<span id="cb85-52"><a href="#cb85-52" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb85-53"><a href="#cb85-53" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb85-54"><a href="#cb85-54" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Symbol validation</span></span>
<span id="cb85-55"><a href="#cb85-55" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> symbol<span class="op">.</span>is_empty() <span class="op">||</span> symbol<span class="op">.</span>len() <span class="op">&gt;</span> <span class="dv">10</span> <span class="op">{</span></span>
<span id="cb85-56"><a href="#cb85-56" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> <span class="cn">Err</span>(<span class="bu">Error</span><span class="pp">::</span>InvalidParameters)<span class="op">;</span></span>
<span id="cb85-57"><a href="#cb85-57" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb85-58"><a href="#cb85-58" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb85-59"><a href="#cb85-59" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Decimals validation (most tokens use 0-18 decimals)</span></span>
<span id="cb85-60"><a href="#cb85-60" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> decimals <span class="op">&gt;</span> <span class="dv">18</span> <span class="op">{</span></span>
<span id="cb85-61"><a href="#cb85-61" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> <span class="cn">Err</span>(<span class="bu">Error</span><span class="pp">::</span>InvalidParameters)<span class="op">;</span></span>
<span id="cb85-62"><a href="#cb85-62" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb85-63"><a href="#cb85-63" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb85-64"><a href="#cb85-64" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Check for valid characters (alphanumeric only)</span></span>
<span id="cb85-65"><a href="#cb85-65" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="op">!</span>name<span class="op">.</span>chars()<span class="op">.</span>all(<span class="op">|</span>c<span class="op">|</span> c<span class="op">.</span>is_alphanumeric() <span class="op">||</span> c<span class="op">.</span>is_whitespace()) <span class="op">{</span></span>
<span id="cb85-66"><a href="#cb85-66" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> <span class="cn">Err</span>(<span class="bu">Error</span><span class="pp">::</span>InvalidParameters)<span class="op">;</span></span>
<span id="cb85-67"><a href="#cb85-67" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb85-68"><a href="#cb85-68" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb85-69"><a href="#cb85-69" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="op">!</span>symbol<span class="op">.</span>chars()<span class="op">.</span>all(<span class="op">|</span>c<span class="op">|</span> c<span class="op">.</span>is_alphanumeric()) <span class="op">{</span></span>
<span id="cb85-70"><a href="#cb85-70" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> <span class="cn">Err</span>(<span class="bu">Error</span><span class="pp">::</span>InvalidParameters)<span class="op">;</span></span>
<span id="cb85-71"><a href="#cb85-71" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb85-72"><a href="#cb85-72" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb85-73"><a href="#cb85-73" aria-hidden="true" tabindex="-1"></a>        <span class="cn">Ok</span>(())</span>
<span id="cb85-74"><a href="#cb85-74" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb85-75"><a href="#cb85-75" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<h3 id="constructor-initialization-patterns">Constructor Initialization
Patterns</h3>
<div class="sourceCode" id="cb86"><pre
class="sourceCode rust"><code class="sourceCode rust"><span id="cb86-1"><a href="#cb86-1" aria-hidden="true" tabindex="-1"></a><span class="at">#[</span><span class="pp">ink::</span>contract<span class="at">]</span></span>
<span id="cb86-2"><a href="#cb86-2" aria-hidden="true" tabindex="-1"></a><span class="kw">mod</span> initialization_patterns <span class="op">{</span></span>
<span id="cb86-3"><a href="#cb86-3" aria-hidden="true" tabindex="-1"></a>    <span class="kw">use</span> <span class="pp">ink::storage::</span><span class="op">{</span>Mapping<span class="op">,</span> Lazy<span class="op">};</span></span>
<span id="cb86-4"><a href="#cb86-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-5"><a href="#cb86-5" aria-hidden="true" tabindex="-1"></a>    <span class="at">#[</span>ink<span class="at">(</span>storage<span class="at">)]</span></span>
<span id="cb86-6"><a href="#cb86-6" aria-hidden="true" tabindex="-1"></a>    <span class="kw">pub</span> <span class="kw">struct</span> InitializationContract <span class="op">{</span></span>
<span id="cb86-7"><a href="#cb86-7" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Always initialized</span></span>
<span id="cb86-8"><a href="#cb86-8" aria-hidden="true" tabindex="-1"></a>        owner<span class="op">:</span> AccountId<span class="op">,</span></span>
<span id="cb86-9"><a href="#cb86-9" aria-hidden="true" tabindex="-1"></a>        created_at<span class="op">:</span> <span class="dt">u64</span><span class="op">,</span></span>
<span id="cb86-10"><a href="#cb86-10" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb86-11"><a href="#cb86-11" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Conditionally initialized</span></span>
<span id="cb86-12"><a href="#cb86-12" aria-hidden="true" tabindex="-1"></a>        admin_data<span class="op">:</span> <span class="dt">Option</span><span class="op">&lt;</span>AdminData<span class="op">&gt;,</span></span>
<span id="cb86-13"><a href="#cb86-13" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb86-14"><a href="#cb86-14" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Lazy initialized</span></span>
<span id="cb86-15"><a href="#cb86-15" aria-hidden="true" tabindex="-1"></a>        large_config<span class="op">:</span> Lazy<span class="op">&lt;</span>Configuration<span class="op">&gt;,</span></span>
<span id="cb86-16"><a href="#cb86-16" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb86-17"><a href="#cb86-17" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Empty mappings (always valid)</span></span>
<span id="cb86-18"><a href="#cb86-18" aria-hidden="true" tabindex="-1"></a>        balances<span class="op">:</span> Mapping<span class="op">&lt;</span>AccountId<span class="op">,</span> Balance<span class="op">&gt;,</span></span>
<span id="cb86-19"><a href="#cb86-19" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb86-20"><a href="#cb86-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-21"><a href="#cb86-21" aria-hidden="true" tabindex="-1"></a>    <span class="kw">impl</span> InitializationContract <span class="op">{</span></span>
<span id="cb86-22"><a href="#cb86-22" aria-hidden="true" tabindex="-1"></a>        <span class="co">/// Minimal constructor - only essential data</span></span>
<span id="cb86-23"><a href="#cb86-23" aria-hidden="true" tabindex="-1"></a>        <span class="at">#[</span>ink<span class="at">(</span>constructor<span class="at">)]</span></span>
<span id="cb86-24"><a href="#cb86-24" aria-hidden="true" tabindex="-1"></a>        <span class="kw">pub</span> <span class="kw">fn</span> new() <span class="op">-&gt;</span> <span class="dt">Self</span> <span class="op">{</span></span>
<span id="cb86-25"><a href="#cb86-25" aria-hidden="true" tabindex="-1"></a>            <span class="dt">Self</span> <span class="op">{</span></span>
<span id="cb86-26"><a href="#cb86-26" aria-hidden="true" tabindex="-1"></a>                owner<span class="op">:</span> <span class="dt">Self</span><span class="pp">::</span>env()<span class="op">.</span>caller()<span class="op">,</span></span>
<span id="cb86-27"><a href="#cb86-27" aria-hidden="true" tabindex="-1"></a>                created_at<span class="op">:</span> <span class="dt">Self</span><span class="pp">::</span>env()<span class="op">.</span>block_timestamp()<span class="op">,</span></span>
<span id="cb86-28"><a href="#cb86-28" aria-hidden="true" tabindex="-1"></a>                admin_data<span class="op">:</span> <span class="cn">None</span><span class="op">,</span></span>
<span id="cb86-29"><a href="#cb86-29" aria-hidden="true" tabindex="-1"></a>                large_config<span class="op">:</span> <span class="pp">Lazy::</span>new()<span class="op">,</span></span>
<span id="cb86-30"><a href="#cb86-30" aria-hidden="true" tabindex="-1"></a>                balances<span class="op">:</span> <span class="pp">Mapping::</span><span class="kw">default</span>()<span class="op">,</span></span>
<span id="cb86-31"><a href="#cb86-31" aria-hidden="true" tabindex="-1"></a>            <span class="op">}</span></span>
<span id="cb86-32"><a href="#cb86-32" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb86-33"><a href="#cb86-33" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-34"><a href="#cb86-34" aria-hidden="true" tabindex="-1"></a>        <span class="co">/// Constructor with admin setup</span></span>
<span id="cb86-35"><a href="#cb86-35" aria-hidden="true" tabindex="-1"></a>        <span class="at">#[</span>ink<span class="at">(</span>constructor<span class="at">)]</span></span>
<span id="cb86-36"><a href="#cb86-36" aria-hidden="true" tabindex="-1"></a>        <span class="kw">pub</span> <span class="kw">fn</span> new_with_admin(admin_key<span class="op">:</span> [<span class="dt">u8</span><span class="op">;</span> <span class="dv">32</span>]) <span class="op">-&gt;</span> <span class="dt">Self</span> <span class="op">{</span></span>
<span id="cb86-37"><a href="#cb86-37" aria-hidden="true" tabindex="-1"></a>            <span class="kw">let</span> <span class="kw">mut</span> contract <span class="op">=</span> <span class="dt">Self</span><span class="pp">::</span>new()<span class="op">;</span></span>
<span id="cb86-38"><a href="#cb86-38" aria-hidden="true" tabindex="-1"></a>            contract<span class="op">.</span>admin_data <span class="op">=</span> <span class="cn">Some</span>(AdminData <span class="op">{</span></span>
<span id="cb86-39"><a href="#cb86-39" aria-hidden="true" tabindex="-1"></a>                key<span class="op">:</span> admin_key<span class="op">,</span></span>
<span id="cb86-40"><a href="#cb86-40" aria-hidden="true" tabindex="-1"></a>                permissions<span class="op">:</span> <span class="pp">AdminPermissions::</span>Full<span class="op">,</span></span>
<span id="cb86-41"><a href="#cb86-41" aria-hidden="true" tabindex="-1"></a>            <span class="op">}</span>)<span class="op">;</span></span>
<span id="cb86-42"><a href="#cb86-42" aria-hidden="true" tabindex="-1"></a>            contract</span>
<span id="cb86-43"><a href="#cb86-43" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb86-44"><a href="#cb86-44" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-45"><a href="#cb86-45" aria-hidden="true" tabindex="-1"></a>        <span class="co">/// Constructor with pre-configuration</span></span>
<span id="cb86-46"><a href="#cb86-46" aria-hidden="true" tabindex="-1"></a>        <span class="at">#[</span>ink<span class="at">(</span>constructor<span class="at">)]</span></span>
<span id="cb86-47"><a href="#cb86-47" aria-hidden="true" tabindex="-1"></a>        <span class="kw">pub</span> <span class="kw">fn</span> new_configured(config<span class="op">:</span> Configuration) <span class="op">-&gt;</span> <span class="dt">Self</span> <span class="op">{</span></span>
<span id="cb86-48"><a href="#cb86-48" aria-hidden="true" tabindex="-1"></a>            <span class="kw">let</span> <span class="kw">mut</span> contract <span class="op">=</span> <span class="dt">Self</span><span class="pp">::</span>new()<span class="op">;</span></span>
<span id="cb86-49"><a href="#cb86-49" aria-hidden="true" tabindex="-1"></a>            contract<span class="op">.</span>large_config<span class="op">.</span>set(<span class="op">&amp;</span>config)<span class="op">;</span></span>
<span id="cb86-50"><a href="#cb86-50" aria-hidden="true" tabindex="-1"></a>            contract</span>
<span id="cb86-51"><a href="#cb86-51" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb86-52"><a href="#cb86-52" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb86-53"><a href="#cb86-53" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<h2 id="message-design-building-clear-apis">Message Design: Building
Clear APIs</h2>
<p>Messages form your contract’s public API. Well-designed messages are
intuitive, secure, and efficient.</p>
<h3 id="immutable-vs.-mutable-messages">Immutable vs. Mutable
Messages</h3>
<p>Understanding the distinction between read-only and state-changing
operations is fundamental:</p>
<div class="sourceCode" id="cb87"><pre
class="sourceCode rust"><code class="sourceCode rust"><span id="cb87-1"><a href="#cb87-1" aria-hidden="true" tabindex="-1"></a><span class="kw">impl</span> FlexibleToken <span class="op">{</span></span>
<span id="cb87-2"><a href="#cb87-2" aria-hidden="true" tabindex="-1"></a>    <span class="co">// ========== READ-ONLY MESSAGES (Immutable) ==========</span></span>
<span id="cb87-3"><a href="#cb87-3" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb87-4"><a href="#cb87-4" aria-hidden="true" tabindex="-1"></a>    <span class="co">/// Get account balance - pure query, no state changes</span></span>
<span id="cb87-5"><a href="#cb87-5" aria-hidden="true" tabindex="-1"></a>    <span class="at">#[</span>ink<span class="at">(</span>message<span class="at">)]</span></span>
<span id="cb87-6"><a href="#cb87-6" aria-hidden="true" tabindex="-1"></a>    <span class="kw">pub</span> <span class="kw">fn</span> balance_of(<span class="op">&amp;</span><span class="kw">self</span><span class="op">,</span> account<span class="op">:</span> AccountId) <span class="op">-&gt;</span> Balance <span class="op">{</span></span>
<span id="cb87-7"><a href="#cb87-7" aria-hidden="true" tabindex="-1"></a>        <span class="kw">self</span><span class="op">.</span>balances<span class="op">.</span>get(account)<span class="op">.</span>unwrap_or(<span class="dv">0</span>)</span>
<span id="cb87-8"><a href="#cb87-8" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb87-9"><a href="#cb87-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb87-10"><a href="#cb87-10" aria-hidden="true" tabindex="-1"></a>    <span class="co">/// Get total supply - constant value query</span></span>
<span id="cb87-11"><a href="#cb87-11" aria-hidden="true" tabindex="-1"></a>    <span class="at">#[</span>ink<span class="at">(</span>message<span class="at">)]</span></span>
<span id="cb87-12"><a href="#cb87-12" aria-hidden="true" tabindex="-1"></a>    <span class="kw">pub</span> <span class="kw">fn</span> total_supply(<span class="op">&amp;</span><span class="kw">self</span>) <span class="op">-&gt;</span> Balance <span class="op">{</span></span>
<span id="cb87-13"><a href="#cb87-13" aria-hidden="true" tabindex="-1"></a>        <span class="kw">self</span><span class="op">.</span>total_supply</span>
<span id="cb87-14"><a href="#cb87-14" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb87-15"><a href="#cb87-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb87-16"><a href="#cb87-16" aria-hidden="true" tabindex="-1"></a>    <span class="co">/// Check if account has sufficient balance</span></span>
<span id="cb87-17"><a href="#cb87-17" aria-hidden="true" tabindex="-1"></a>    <span class="at">#[</span>ink<span class="at">(</span>message<span class="at">)]</span></span>
<span id="cb87-18"><a href="#cb87-18" aria-hidden="true" tabindex="-1"></a>    <span class="kw">pub</span> <span class="kw">fn</span> has_sufficient_balance(<span class="op">&amp;</span><span class="kw">self</span><span class="op">,</span> account<span class="op">:</span> AccountId<span class="op">,</span> amount<span class="op">:</span> Balance) <span class="op">-&gt;</span> <span class="dt">bool</span> <span class="op">{</span></span>
<span id="cb87-19"><a href="#cb87-19" aria-hidden="true" tabindex="-1"></a>        <span class="kw">self</span><span class="op">.</span>balance_of(account) <span class="op">&gt;=</span> amount</span>
<span id="cb87-20"><a href="#cb87-20" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb87-21"><a href="#cb87-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb87-22"><a href="#cb87-22" aria-hidden="true" tabindex="-1"></a>    <span class="co">/// Get token metadata</span></span>
<span id="cb87-23"><a href="#cb87-23" aria-hidden="true" tabindex="-1"></a>    <span class="at">#[</span>ink<span class="at">(</span>message<span class="at">)]</span></span>
<span id="cb87-24"><a href="#cb87-24" aria-hidden="true" tabindex="-1"></a>    <span class="kw">pub</span> <span class="kw">fn</span> token_info(<span class="op">&amp;</span><span class="kw">self</span>) <span class="op">-&gt;</span> (<span class="dt">String</span><span class="op">,</span> <span class="dt">String</span><span class="op">,</span> <span class="dt">u8</span>) <span class="op">{</span></span>
<span id="cb87-25"><a href="#cb87-25" aria-hidden="true" tabindex="-1"></a>        (<span class="kw">self</span><span class="op">.</span>name<span class="op">.</span>clone()<span class="op">,</span> <span class="kw">self</span><span class="op">.</span>symbol<span class="op">.</span>clone()<span class="op">,</span> <span class="kw">self</span><span class="op">.</span>decimals)</span>
<span id="cb87-26"><a href="#cb87-26" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb87-27"><a href="#cb87-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb87-28"><a href="#cb87-28" aria-hidden="true" tabindex="-1"></a>    <span class="co">// ========== STATE-CHANGING MESSAGES (Mutable) ==========</span></span>
<span id="cb87-29"><a href="#cb87-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb87-30"><a href="#cb87-30" aria-hidden="true" tabindex="-1"></a>    <span class="co">/// Transfer tokens between accounts</span></span>
<span id="cb87-31"><a href="#cb87-31" aria-hidden="true" tabindex="-1"></a>    <span class="at">#[</span>ink<span class="at">(</span>message<span class="at">)]</span></span>
<span id="cb87-32"><a href="#cb87-32" aria-hidden="true" tabindex="-1"></a>    <span class="kw">pub</span> <span class="kw">fn</span> transfer(<span class="op">&amp;</span><span class="kw">mut</span> <span class="kw">self</span><span class="op">,</span> to<span class="op">:</span> AccountId<span class="op">,</span> amount<span class="op">:</span> Balance) <span class="op">-&gt;</span> <span class="dt">Result</span><span class="op">&lt;</span>()<span class="op">,</span> <span class="bu">Error</span><span class="op">&gt;</span> <span class="op">{</span></span>
<span id="cb87-33"><a href="#cb87-33" aria-hidden="true" tabindex="-1"></a>        <span class="kw">let</span> caller <span class="op">=</span> <span class="kw">self</span><span class="op">.</span>env()<span class="op">.</span>caller()<span class="op">;</span></span>
<span id="cb87-34"><a href="#cb87-34" aria-hidden="true" tabindex="-1"></a>        <span class="kw">self</span><span class="op">.</span>transfer_from_to(caller<span class="op">,</span> to<span class="op">,</span> amount)</span>
<span id="cb87-35"><a href="#cb87-35" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb87-36"><a href="#cb87-36" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb87-37"><a href="#cb87-37" aria-hidden="true" tabindex="-1"></a>    <span class="co">/// Mint new tokens (owner only)</span></span>
<span id="cb87-38"><a href="#cb87-38" aria-hidden="true" tabindex="-1"></a>    <span class="at">#[</span>ink<span class="at">(</span>message<span class="at">)]</span></span>
<span id="cb87-39"><a href="#cb87-39" aria-hidden="true" tabindex="-1"></a>    <span class="kw">pub</span> <span class="kw">fn</span> mint(<span class="op">&amp;</span><span class="kw">mut</span> <span class="kw">self</span><span class="op">,</span> to<span class="op">:</span> AccountId<span class="op">,</span> amount<span class="op">:</span> Balance) <span class="op">-&gt;</span> <span class="dt">Result</span><span class="op">&lt;</span>()<span class="op">,</span> <span class="bu">Error</span><span class="op">&gt;</span> <span class="op">{</span></span>
<span id="cb87-40"><a href="#cb87-40" aria-hidden="true" tabindex="-1"></a>        <span class="kw">self</span><span class="op">.</span>ensure_owner()<span class="op">?;</span></span>
<span id="cb87-41"><a href="#cb87-41" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb87-42"><a href="#cb87-42" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Check for overflow</span></span>
<span id="cb87-43"><a href="#cb87-43" aria-hidden="true" tabindex="-1"></a>        <span class="kw">let</span> new_total_supply <span class="op">=</span> <span class="kw">self</span><span class="op">.</span>total_supply</span>
<span id="cb87-44"><a href="#cb87-44" aria-hidden="true" tabindex="-1"></a>            <span class="op">.</span>checked_add(amount)</span>
<span id="cb87-45"><a href="#cb87-45" aria-hidden="true" tabindex="-1"></a>            <span class="op">.</span>ok_or(<span class="bu">Error</span><span class="pp">::</span>ArithmeticOverflow)<span class="op">?;</span></span>
<span id="cb87-46"><a href="#cb87-46" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb87-47"><a href="#cb87-47" aria-hidden="true" tabindex="-1"></a>        <span class="kw">let</span> current_balance <span class="op">=</span> <span class="kw">self</span><span class="op">.</span>balance_of(to)<span class="op">;</span></span>
<span id="cb87-48"><a href="#cb87-48" aria-hidden="true" tabindex="-1"></a>        <span class="kw">let</span> new_balance <span class="op">=</span> current_balance</span>
<span id="cb87-49"><a href="#cb87-49" aria-hidden="true" tabindex="-1"></a>            <span class="op">.</span>checked_add(amount)</span>
<span id="cb87-50"><a href="#cb87-50" aria-hidden="true" tabindex="-1"></a>            <span class="op">.</span>ok_or(<span class="bu">Error</span><span class="pp">::</span>ArithmeticOverflow)<span class="op">?;</span></span>
<span id="cb87-51"><a href="#cb87-51" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb87-52"><a href="#cb87-52" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Update state</span></span>
<span id="cb87-53"><a href="#cb87-53" aria-hidden="true" tabindex="-1"></a>        <span class="kw">self</span><span class="op">.</span>total_supply <span class="op">=</span> new_total_supply<span class="op">;</span></span>
<span id="cb87-54"><a href="#cb87-54" aria-hidden="true" tabindex="-1"></a>        <span class="kw">self</span><span class="op">.</span>balances<span class="op">.</span>insert(to<span class="op">,</span> <span class="op">&amp;</span>new_balance)<span class="op">;</span></span>
<span id="cb87-55"><a href="#cb87-55" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb87-56"><a href="#cb87-56" aria-hidden="true" tabindex="-1"></a>        <span class="cn">Ok</span>(())</span>
<span id="cb87-57"><a href="#cb87-57" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb87-58"><a href="#cb87-58" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb87-59"><a href="#cb87-59" aria-hidden="true" tabindex="-1"></a>    <span class="co">/// Burn tokens from caller&#39;s account</span></span>
<span id="cb87-60"><a href="#cb87-60" aria-hidden="true" tabindex="-1"></a>    <span class="at">#[</span>ink<span class="at">(</span>message<span class="at">)]</span></span>
<span id="cb87-61"><a href="#cb87-61" aria-hidden="true" tabindex="-1"></a>    <span class="kw">pub</span> <span class="kw">fn</span> burn(<span class="op">&amp;</span><span class="kw">mut</span> <span class="kw">self</span><span class="op">,</span> amount<span class="op">:</span> Balance) <span class="op">-&gt;</span> <span class="dt">Result</span><span class="op">&lt;</span>()<span class="op">,</span> <span class="bu">Error</span><span class="op">&gt;</span> <span class="op">{</span></span>
<span id="cb87-62"><a href="#cb87-62" aria-hidden="true" tabindex="-1"></a>        <span class="kw">let</span> caller <span class="op">=</span> <span class="kw">self</span><span class="op">.</span>env()<span class="op">.</span>caller()<span class="op">;</span></span>
<span id="cb87-63"><a href="#cb87-63" aria-hidden="true" tabindex="-1"></a>        <span class="kw">let</span> current_balance <span class="op">=</span> <span class="kw">self</span><span class="op">.</span>balance_of(caller)<span class="op">;</span></span>
<span id="cb87-64"><a href="#cb87-64" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb87-65"><a href="#cb87-65" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> current_balance <span class="op">&lt;</span> amount <span class="op">{</span></span>
<span id="cb87-66"><a href="#cb87-66" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> <span class="cn">Err</span>(<span class="bu">Error</span><span class="pp">::</span>InsufficientBalance)<span class="op">;</span></span>
<span id="cb87-67"><a href="#cb87-67" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb87-68"><a href="#cb87-68" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb87-69"><a href="#cb87-69" aria-hidden="true" tabindex="-1"></a>        <span class="kw">let</span> new_balance <span class="op">=</span> current_balance <span class="op">-</span> amount<span class="op">;</span></span>
<span id="cb87-70"><a href="#cb87-70" aria-hidden="true" tabindex="-1"></a>        <span class="kw">let</span> new_total_supply <span class="op">=</span> <span class="kw">self</span><span class="op">.</span>total_supply <span class="op">-</span> amount<span class="op">;</span></span>
<span id="cb87-71"><a href="#cb87-71" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb87-72"><a href="#cb87-72" aria-hidden="true" tabindex="-1"></a>        <span class="kw">self</span><span class="op">.</span>balances<span class="op">.</span>insert(caller<span class="op">,</span> <span class="op">&amp;</span>new_balance)<span class="op">;</span></span>
<span id="cb87-73"><a href="#cb87-73" aria-hidden="true" tabindex="-1"></a>        <span class="kw">self</span><span class="op">.</span>total_supply <span class="op">=</span> new_total_supply<span class="op">;</span></span>
<span id="cb87-74"><a href="#cb87-74" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb87-75"><a href="#cb87-75" aria-hidden="true" tabindex="-1"></a>        <span class="cn">Ok</span>(())</span>
<span id="cb87-76"><a href="#cb87-76" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb87-77"><a href="#cb87-77" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<h3 id="message-parameter-patterns">Message Parameter Patterns</h3>
<p>Design message parameters for clarity and safety:</p>
<div class="sourceCode" id="cb88"><pre
class="sourceCode rust"><code class="sourceCode rust"><span id="cb88-1"><a href="#cb88-1" aria-hidden="true" tabindex="-1"></a><span class="kw">impl</span> FlexibleToken <span class="op">{</span></span>
<span id="cb88-2"><a href="#cb88-2" aria-hidden="true" tabindex="-1"></a>    <span class="co">/// Batch transfer - efficient multi-recipient transfers</span></span>
<span id="cb88-3"><a href="#cb88-3" aria-hidden="true" tabindex="-1"></a>    <span class="at">#[</span>ink<span class="at">(</span>message<span class="at">)]</span></span>
<span id="cb88-4"><a href="#cb88-4" aria-hidden="true" tabindex="-1"></a>    <span class="kw">pub</span> <span class="kw">fn</span> batch_transfer(</span>
<span id="cb88-5"><a href="#cb88-5" aria-hidden="true" tabindex="-1"></a>        <span class="op">&amp;</span><span class="kw">mut</span> <span class="kw">self</span><span class="op">,</span></span>
<span id="cb88-6"><a href="#cb88-6" aria-hidden="true" tabindex="-1"></a>        recipients<span class="op">:</span> <span class="dt">Vec</span><span class="op">&lt;</span>(AccountId<span class="op">,</span> Balance)<span class="op">&gt;,</span></span>
<span id="cb88-7"><a href="#cb88-7" aria-hidden="true" tabindex="-1"></a>    ) <span class="op">-&gt;</span> <span class="dt">Result</span><span class="op">&lt;</span><span class="dt">u32</span><span class="op">,</span> <span class="bu">Error</span><span class="op">&gt;</span> <span class="op">{</span></span>
<span id="cb88-8"><a href="#cb88-8" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Validate batch size to prevent gas limit issues</span></span>
<span id="cb88-9"><a href="#cb88-9" aria-hidden="true" tabindex="-1"></a>        <span class="kw">const</span> MAX_BATCH_SIZE<span class="op">:</span> <span class="dt">usize</span> <span class="op">=</span> <span class="dv">50</span><span class="op">;</span></span>
<span id="cb88-10"><a href="#cb88-10" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> recipients<span class="op">.</span>len() <span class="op">&gt;</span> MAX_BATCH_SIZE <span class="op">{</span></span>
<span id="cb88-11"><a href="#cb88-11" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> <span class="cn">Err</span>(<span class="bu">Error</span><span class="pp">::</span>InvalidParameters)<span class="op">;</span></span>
<span id="cb88-12"><a href="#cb88-12" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb88-13"><a href="#cb88-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb88-14"><a href="#cb88-14" aria-hidden="true" tabindex="-1"></a>        <span class="kw">let</span> caller <span class="op">=</span> <span class="kw">self</span><span class="op">.</span>env()<span class="op">.</span>caller()<span class="op">;</span></span>
<span id="cb88-15"><a href="#cb88-15" aria-hidden="true" tabindex="-1"></a>        <span class="kw">let</span> <span class="kw">mut</span> total_amount <span class="op">=</span> <span class="dv">0u128</span><span class="op">;</span></span>
<span id="cb88-16"><a href="#cb88-16" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb88-17"><a href="#cb88-17" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Calculate total amount first</span></span>
<span id="cb88-18"><a href="#cb88-18" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> (_<span class="op">,</span> amount) <span class="kw">in</span> <span class="op">&amp;</span>recipients <span class="op">{</span></span>
<span id="cb88-19"><a href="#cb88-19" aria-hidden="true" tabindex="-1"></a>            total_amount <span class="op">=</span> total_amount</span>
<span id="cb88-20"><a href="#cb88-20" aria-hidden="true" tabindex="-1"></a>                <span class="op">.</span>checked_add(<span class="op">*</span>amount)</span>
<span id="cb88-21"><a href="#cb88-21" aria-hidden="true" tabindex="-1"></a>                <span class="op">.</span>ok_or(<span class="bu">Error</span><span class="pp">::</span>ArithmeticOverflow)<span class="op">?;</span></span>
<span id="cb88-22"><a href="#cb88-22" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb88-23"><a href="#cb88-23" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb88-24"><a href="#cb88-24" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Check sufficient balance</span></span>
<span id="cb88-25"><a href="#cb88-25" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="kw">self</span><span class="op">.</span>balance_of(caller) <span class="op">&lt;</span> total_amount <span class="op">{</span></span>
<span id="cb88-26"><a href="#cb88-26" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> <span class="cn">Err</span>(<span class="bu">Error</span><span class="pp">::</span>InsufficientBalance)<span class="op">;</span></span>
<span id="cb88-27"><a href="#cb88-27" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb88-28"><a href="#cb88-28" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb88-29"><a href="#cb88-29" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Execute transfers</span></span>
<span id="cb88-30"><a href="#cb88-30" aria-hidden="true" tabindex="-1"></a>        <span class="kw">let</span> <span class="kw">mut</span> successful_transfers <span class="op">=</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb88-31"><a href="#cb88-31" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> (to<span class="op">,</span> amount) <span class="kw">in</span> recipients <span class="op">{</span></span>
<span id="cb88-32"><a href="#cb88-32" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> <span class="kw">self</span><span class="op">.</span>transfer_from_to(caller<span class="op">,</span> to<span class="op">,</span> amount)<span class="op">.</span>is_ok() <span class="op">{</span></span>
<span id="cb88-33"><a href="#cb88-33" aria-hidden="true" tabindex="-1"></a>                successful_transfers <span class="op">+=</span> <span class="dv">1</span><span class="op">;</span></span>
<span id="cb88-34"><a href="#cb88-34" aria-hidden="true" tabindex="-1"></a>            <span class="op">}</span></span>
<span id="cb88-35"><a href="#cb88-35" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb88-36"><a href="#cb88-36" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb88-37"><a href="#cb88-37" aria-hidden="true" tabindex="-1"></a>        <span class="cn">Ok</span>(successful_transfers)</span>
<span id="cb88-38"><a href="#cb88-38" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb88-39"><a href="#cb88-39" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb88-40"><a href="#cb88-40" aria-hidden="true" tabindex="-1"></a>    <span class="co">/// Transfer with metadata - includes reason/memo</span></span>
<span id="cb88-41"><a href="#cb88-41" aria-hidden="true" tabindex="-1"></a>    <span class="at">#[</span>ink<span class="at">(</span>message<span class="at">)]</span></span>
<span id="cb88-42"><a href="#cb88-42" aria-hidden="true" tabindex="-1"></a>    <span class="kw">pub</span> <span class="kw">fn</span> transfer_with_memo(</span>
<span id="cb88-43"><a href="#cb88-43" aria-hidden="true" tabindex="-1"></a>        <span class="op">&amp;</span><span class="kw">mut</span> <span class="kw">self</span><span class="op">,</span></span>
<span id="cb88-44"><a href="#cb88-44" aria-hidden="true" tabindex="-1"></a>        to<span class="op">:</span> AccountId<span class="op">,</span></span>
<span id="cb88-45"><a href="#cb88-45" aria-hidden="true" tabindex="-1"></a>        amount<span class="op">:</span> Balance<span class="op">,</span></span>
<span id="cb88-46"><a href="#cb88-46" aria-hidden="true" tabindex="-1"></a>        memo<span class="op">:</span> <span class="dt">Vec</span><span class="op">&lt;</span><span class="dt">u8</span><span class="op">&gt;,</span></span>
<span id="cb88-47"><a href="#cb88-47" aria-hidden="true" tabindex="-1"></a>    ) <span class="op">-&gt;</span> <span class="dt">Result</span><span class="op">&lt;</span>()<span class="op">,</span> <span class="bu">Error</span><span class="op">&gt;</span> <span class="op">{</span></span>
<span id="cb88-48"><a href="#cb88-48" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Limit memo size to prevent abuse</span></span>
<span id="cb88-49"><a href="#cb88-49" aria-hidden="true" tabindex="-1"></a>        <span class="kw">const</span> MAX_MEMO_SIZE<span class="op">:</span> <span class="dt">usize</span> <span class="op">=</span> <span class="dv">256</span><span class="op">;</span></span>
<span id="cb88-50"><a href="#cb88-50" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> memo<span class="op">.</span>len() <span class="op">&gt;</span> MAX_MEMO_SIZE <span class="op">{</span></span>
<span id="cb88-51"><a href="#cb88-51" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> <span class="cn">Err</span>(<span class="bu">Error</span><span class="pp">::</span>InvalidParameters)<span class="op">;</span></span>
<span id="cb88-52"><a href="#cb88-52" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb88-53"><a href="#cb88-53" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb88-54"><a href="#cb88-54" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Execute transfer</span></span>
<span id="cb88-55"><a href="#cb88-55" aria-hidden="true" tabindex="-1"></a>        <span class="kw">self</span><span class="op">.</span>transfer(to<span class="op">,</span> amount)<span class="op">?;</span></span>
<span id="cb88-56"><a href="#cb88-56" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb88-57"><a href="#cb88-57" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Emit event with memo (covered in next chapter)</span></span>
<span id="cb88-58"><a href="#cb88-58" aria-hidden="true" tabindex="-1"></a>        <span class="kw">self</span><span class="op">.</span>env()<span class="op">.</span>emit_event(TransferWithMemo <span class="op">{</span></span>
<span id="cb88-59"><a href="#cb88-59" aria-hidden="true" tabindex="-1"></a>            from<span class="op">:</span> <span class="cn">Some</span>(<span class="kw">self</span><span class="op">.</span>env()<span class="op">.</span>caller())<span class="op">,</span></span>
<span id="cb88-60"><a href="#cb88-60" aria-hidden="true" tabindex="-1"></a>            to<span class="op">:</span> <span class="cn">Some</span>(to)<span class="op">,</span></span>
<span id="cb88-61"><a href="#cb88-61" aria-hidden="true" tabindex="-1"></a>            amount<span class="op">,</span></span>
<span id="cb88-62"><a href="#cb88-62" aria-hidden="true" tabindex="-1"></a>            memo<span class="op">,</span></span>
<span id="cb88-63"><a href="#cb88-63" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span>)<span class="op">;</span></span>
<span id="cb88-64"><a href="#cb88-64" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb88-65"><a href="#cb88-65" aria-hidden="true" tabindex="-1"></a>        <span class="cn">Ok</span>(())</span>
<span id="cb88-66"><a href="#cb88-66" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb88-67"><a href="#cb88-67" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb88-68"><a href="#cb88-68" aria-hidden="true" tabindex="-1"></a>    <span class="co">/// Conditional transfer - only execute if condition is met</span></span>
<span id="cb88-69"><a href="#cb88-69" aria-hidden="true" tabindex="-1"></a>    <span class="at">#[</span>ink<span class="at">(</span>message<span class="at">)]</span></span>
<span id="cb88-70"><a href="#cb88-70" aria-hidden="true" tabindex="-1"></a>    <span class="kw">pub</span> <span class="kw">fn</span> conditional_transfer(</span>
<span id="cb88-71"><a href="#cb88-71" aria-hidden="true" tabindex="-1"></a>        <span class="op">&amp;</span><span class="kw">mut</span> <span class="kw">self</span><span class="op">,</span></span>
<span id="cb88-72"><a href="#cb88-72" aria-hidden="true" tabindex="-1"></a>        to<span class="op">:</span> AccountId<span class="op">,</span></span>
<span id="cb88-73"><a href="#cb88-73" aria-hidden="true" tabindex="-1"></a>        amount<span class="op">:</span> Balance<span class="op">,</span></span>
<span id="cb88-74"><a href="#cb88-74" aria-hidden="true" tabindex="-1"></a>        min_balance_required<span class="op">:</span> Balance<span class="op">,</span></span>
<span id="cb88-75"><a href="#cb88-75" aria-hidden="true" tabindex="-1"></a>    ) <span class="op">-&gt;</span> <span class="dt">Result</span><span class="op">&lt;</span><span class="dt">bool</span><span class="op">,</span> <span class="bu">Error</span><span class="op">&gt;</span> <span class="op">{</span></span>
<span id="cb88-76"><a href="#cb88-76" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Check if recipient meets minimum balance requirement</span></span>
<span id="cb88-77"><a href="#cb88-77" aria-hidden="true" tabindex="-1"></a>        <span class="kw">let</span> recipient_balance <span class="op">=</span> <span class="kw">self</span><span class="op">.</span>balance_of(to)<span class="op">;</span></span>
<span id="cb88-78"><a href="#cb88-78" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> recipient_balance <span class="op">&lt;</span> min_balance_required <span class="op">{</span></span>
<span id="cb88-79"><a href="#cb88-79" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> <span class="cn">Ok</span>(<span class="cn">false</span>)<span class="op">;</span> <span class="co">// Condition not met, no transfer</span></span>
<span id="cb88-80"><a href="#cb88-80" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb88-81"><a href="#cb88-81" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb88-82"><a href="#cb88-82" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Execute transfer</span></span>
<span id="cb88-83"><a href="#cb88-83" aria-hidden="true" tabindex="-1"></a>        <span class="kw">self</span><span class="op">.</span>transfer(to<span class="op">,</span> amount)<span class="op">?;</span></span>
<span id="cb88-84"><a href="#cb88-84" aria-hidden="true" tabindex="-1"></a>        <span class="cn">Ok</span>(<span class="cn">true</span>) <span class="co">// Transfer executed</span></span>
<span id="cb88-85"><a href="#cb88-85" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb88-86"><a href="#cb88-86" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<h3 id="error-handling-patterns">Error Handling Patterns</h3>
<p>Comprehensive error handling makes contracts robust and
user-friendly:</p>
<div class="sourceCode" id="cb89"><pre
class="sourceCode rust"><code class="sourceCode rust"><span id="cb89-1"><a href="#cb89-1" aria-hidden="true" tabindex="-1"></a><span class="at">#[</span>derive<span class="at">(</span><span class="bu">Debug</span><span class="op">,</span> <span class="bu">PartialEq</span><span class="op">,</span> <span class="bu">Eq</span><span class="op">,</span> <span class="pp">scale::</span>Encode<span class="op">,</span> <span class="pp">scale::</span>Decode<span class="at">)]</span></span>
<span id="cb89-2"><a href="#cb89-2" aria-hidden="true" tabindex="-1"></a><span class="at">#[</span>cfg_attr<span class="at">(</span>feature <span class="op">=</span> <span class="st">&quot;std&quot;</span><span class="op">,</span> derive<span class="at">(</span><span class="pp">scale_info::</span>TypeInfo<span class="at">))]</span></span>
<span id="cb89-3"><a href="#cb89-3" aria-hidden="true" tabindex="-1"></a><span class="kw">pub</span> <span class="kw">enum</span> <span class="bu">Error</span> <span class="op">{</span></span>
<span id="cb89-4"><a href="#cb89-4" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Balance-related errors</span></span>
<span id="cb89-5"><a href="#cb89-5" aria-hidden="true" tabindex="-1"></a>    InsufficientBalance<span class="op">,</span></span>
<span id="cb89-6"><a href="#cb89-6" aria-hidden="true" tabindex="-1"></a>    ArithmeticOverflow<span class="op">,</span></span>
<span id="cb89-7"><a href="#cb89-7" aria-hidden="true" tabindex="-1"></a>    ArithmeticUnderflow<span class="op">,</span></span>
<span id="cb89-8"><a href="#cb89-8" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb89-9"><a href="#cb89-9" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Authorization errors</span></span>
<span id="cb89-10"><a href="#cb89-10" aria-hidden="true" tabindex="-1"></a>    Unauthorized<span class="op">,</span></span>
<span id="cb89-11"><a href="#cb89-11" aria-hidden="true" tabindex="-1"></a>    NotOwner<span class="op">,</span></span>
<span id="cb89-12"><a href="#cb89-12" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb89-13"><a href="#cb89-13" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Parameter validation errors</span></span>
<span id="cb89-14"><a href="#cb89-14" aria-hidden="true" tabindex="-1"></a>    InvalidParameters<span class="op">,</span></span>
<span id="cb89-15"><a href="#cb89-15" aria-hidden="true" tabindex="-1"></a>    InvalidAddress<span class="op">,</span></span>
<span id="cb89-16"><a href="#cb89-16" aria-hidden="true" tabindex="-1"></a>    InvalidAmount<span class="op">,</span></span>
<span id="cb89-17"><a href="#cb89-17" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb89-18"><a href="#cb89-18" aria-hidden="true" tabindex="-1"></a>    <span class="co">// State-related errors</span></span>
<span id="cb89-19"><a href="#cb89-19" aria-hidden="true" tabindex="-1"></a>    ContractPaused<span class="op">,</span></span>
<span id="cb89-20"><a href="#cb89-20" aria-hidden="true" tabindex="-1"></a>    TransferDisabled<span class="op">,</span></span>
<span id="cb89-21"><a href="#cb89-21" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb89-22"><a href="#cb89-22" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Custom business logic errors</span></span>
<span id="cb89-23"><a href="#cb89-23" aria-hidden="true" tabindex="-1"></a>    TransferLimitExceeded<span class="op">,</span></span>
<span id="cb89-24"><a href="#cb89-24" aria-hidden="true" tabindex="-1"></a>    RecipientBlacklisted<span class="op">,</span></span>
<span id="cb89-25"><a href="#cb89-25" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb89-26"><a href="#cb89-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb89-27"><a href="#cb89-27" aria-hidden="true" tabindex="-1"></a><span class="kw">impl</span> FlexibleToken <span class="op">{</span></span>
<span id="cb89-28"><a href="#cb89-28" aria-hidden="true" tabindex="-1"></a>    <span class="co">/// Robust transfer with comprehensive error handling</span></span>
<span id="cb89-29"><a href="#cb89-29" aria-hidden="true" tabindex="-1"></a>    <span class="at">#[</span>ink<span class="at">(</span>message<span class="at">)]</span></span>
<span id="cb89-30"><a href="#cb89-30" aria-hidden="true" tabindex="-1"></a>    <span class="kw">pub</span> <span class="kw">fn</span> robust_transfer(<span class="op">&amp;</span><span class="kw">mut</span> <span class="kw">self</span><span class="op">,</span> to<span class="op">:</span> AccountId<span class="op">,</span> amount<span class="op">:</span> Balance) <span class="op">-&gt;</span> <span class="dt">Result</span><span class="op">&lt;</span>()<span class="op">,</span> <span class="bu">Error</span><span class="op">&gt;</span> <span class="op">{</span></span>
<span id="cb89-31"><a href="#cb89-31" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Parameter validation</span></span>
<span id="cb89-32"><a href="#cb89-32" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> amount <span class="op">==</span> <span class="dv">0</span> <span class="op">{</span></span>
<span id="cb89-33"><a href="#cb89-33" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> <span class="cn">Err</span>(<span class="bu">Error</span><span class="pp">::</span>InvalidAmount)<span class="op">;</span></span>
<span id="cb89-34"><a href="#cb89-34" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb89-35"><a href="#cb89-35" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb89-36"><a href="#cb89-36" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> to <span class="op">==</span> <span class="pp">AccountId::</span>from([<span class="dv">0u8</span><span class="op">;</span> <span class="dv">32</span>]) <span class="op">{</span></span>
<span id="cb89-37"><a href="#cb89-37" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> <span class="cn">Err</span>(<span class="bu">Error</span><span class="pp">::</span>InvalidAddress)<span class="op">;</span></span>
<span id="cb89-38"><a href="#cb89-38" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb89-39"><a href="#cb89-39" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb89-40"><a href="#cb89-40" aria-hidden="true" tabindex="-1"></a>        <span class="kw">let</span> caller <span class="op">=</span> <span class="kw">self</span><span class="op">.</span>env()<span class="op">.</span>caller()<span class="op">;</span></span>
<span id="cb89-41"><a href="#cb89-41" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb89-42"><a href="#cb89-42" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Self-transfer check</span></span>
<span id="cb89-43"><a href="#cb89-43" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> caller <span class="op">==</span> to <span class="op">{</span></span>
<span id="cb89-44"><a href="#cb89-44" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> <span class="cn">Ok</span>(())<span class="op">;</span> <span class="co">// No-op for self transfers</span></span>
<span id="cb89-45"><a href="#cb89-45" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb89-46"><a href="#cb89-46" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb89-47"><a href="#cb89-47" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Balance checks with specific error messages</span></span>
<span id="cb89-48"><a href="#cb89-48" aria-hidden="true" tabindex="-1"></a>        <span class="kw">let</span> caller_balance <span class="op">=</span> <span class="kw">self</span><span class="op">.</span>balance_of(caller)<span class="op">;</span></span>
<span id="cb89-49"><a href="#cb89-49" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> caller_balance <span class="op">==</span> <span class="dv">0</span> <span class="op">{</span></span>
<span id="cb89-50"><a href="#cb89-50" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> <span class="cn">Err</span>(<span class="bu">Error</span><span class="pp">::</span>InsufficientBalance)<span class="op">;</span></span>
<span id="cb89-51"><a href="#cb89-51" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb89-52"><a href="#cb89-52" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb89-53"><a href="#cb89-53" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> caller_balance <span class="op">&lt;</span> amount <span class="op">{</span></span>
<span id="cb89-54"><a href="#cb89-54" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> <span class="cn">Err</span>(<span class="bu">Error</span><span class="pp">::</span>InsufficientBalance)<span class="op">;</span></span>
<span id="cb89-55"><a href="#cb89-55" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb89-56"><a href="#cb89-56" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb89-57"><a href="#cb89-57" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Arithmetic safety checks</span></span>
<span id="cb89-58"><a href="#cb89-58" aria-hidden="true" tabindex="-1"></a>        <span class="kw">let</span> new_caller_balance <span class="op">=</span> caller_balance</span>
<span id="cb89-59"><a href="#cb89-59" aria-hidden="true" tabindex="-1"></a>            <span class="op">.</span>checked_sub(amount)</span>
<span id="cb89-60"><a href="#cb89-60" aria-hidden="true" tabindex="-1"></a>            <span class="op">.</span>ok_or(<span class="bu">Error</span><span class="pp">::</span>ArithmeticUnderflow)<span class="op">?;</span></span>
<span id="cb89-61"><a href="#cb89-61" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb89-62"><a href="#cb89-62" aria-hidden="true" tabindex="-1"></a>        <span class="kw">let</span> to_balance <span class="op">=</span> <span class="kw">self</span><span class="op">.</span>balance_of(to)<span class="op">;</span></span>
<span id="cb89-63"><a href="#cb89-63" aria-hidden="true" tabindex="-1"></a>        <span class="kw">let</span> new_to_balance <span class="op">=</span> to_balance</span>
<span id="cb89-64"><a href="#cb89-64" aria-hidden="true" tabindex="-1"></a>            <span class="op">.</span>checked_add(amount)</span>
<span id="cb89-65"><a href="#cb89-65" aria-hidden="true" tabindex="-1"></a>            <span class="op">.</span>ok_or(<span class="bu">Error</span><span class="pp">::</span>ArithmeticOverflow)<span class="op">?;</span></span>
<span id="cb89-66"><a href="#cb89-66" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb89-67"><a href="#cb89-67" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Execute transfer</span></span>
<span id="cb89-68"><a href="#cb89-68" aria-hidden="true" tabindex="-1"></a>        <span class="kw">self</span><span class="op">.</span>balances<span class="op">.</span>insert(caller<span class="op">,</span> <span class="op">&amp;</span>new_caller_balance)<span class="op">;</span></span>
<span id="cb89-69"><a href="#cb89-69" aria-hidden="true" tabindex="-1"></a>        <span class="kw">self</span><span class="op">.</span>balances<span class="op">.</span>insert(to<span class="op">,</span> <span class="op">&amp;</span>new_to_balance)<span class="op">;</span></span>
<span id="cb89-70"><a href="#cb89-70" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb89-71"><a href="#cb89-71" aria-hidden="true" tabindex="-1"></a>        <span class="cn">Ok</span>(())</span>
<span id="cb89-72"><a href="#cb89-72" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb89-73"><a href="#cb89-73" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb89-74"><a href="#cb89-74" aria-hidden="true" tabindex="-1"></a>    <span class="co">/// Helper function for consistent error checking</span></span>
<span id="cb89-75"><a href="#cb89-75" aria-hidden="true" tabindex="-1"></a>    <span class="kw">fn</span> ensure_owner(<span class="op">&amp;</span><span class="kw">self</span>) <span class="op">-&gt;</span> <span class="dt">Result</span><span class="op">&lt;</span>()<span class="op">,</span> <span class="bu">Error</span><span class="op">&gt;</span> <span class="op">{</span></span>
<span id="cb89-76"><a href="#cb89-76" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="kw">self</span><span class="op">.</span>env()<span class="op">.</span>caller() <span class="op">!=</span> <span class="kw">self</span><span class="op">.</span>owner <span class="op">{</span></span>
<span id="cb89-77"><a href="#cb89-77" aria-hidden="true" tabindex="-1"></a>            <span class="cn">Err</span>(<span class="bu">Error</span><span class="pp">::</span>NotOwner)</span>
<span id="cb89-78"><a href="#cb89-78" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span> <span class="cf">else</span> <span class="op">{</span></span>
<span id="cb89-79"><a href="#cb89-79" aria-hidden="true" tabindex="-1"></a>            <span class="cn">Ok</span>(())</span>
<span id="cb89-80"><a href="#cb89-80" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb89-81"><a href="#cb89-81" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb89-82"><a href="#cb89-82" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb89-83"><a href="#cb89-83" aria-hidden="true" tabindex="-1"></a>    <span class="co">/// Helper for amount validation</span></span>
<span id="cb89-84"><a href="#cb89-84" aria-hidden="true" tabindex="-1"></a>    <span class="kw">fn</span> validate_amount(<span class="op">&amp;</span><span class="kw">self</span><span class="op">,</span> amount<span class="op">:</span> Balance) <span class="op">-&gt;</span> <span class="dt">Result</span><span class="op">&lt;</span>()<span class="op">,</span> <span class="bu">Error</span><span class="op">&gt;</span> <span class="op">{</span></span>
<span id="cb89-85"><a href="#cb89-85" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> amount <span class="op">==</span> <span class="dv">0</span> <span class="op">{</span></span>
<span id="cb89-86"><a href="#cb89-86" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> <span class="cn">Err</span>(<span class="bu">Error</span><span class="pp">::</span>InvalidAmount)<span class="op">;</span></span>
<span id="cb89-87"><a href="#cb89-87" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb89-88"><a href="#cb89-88" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb89-89"><a href="#cb89-89" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Check against maximum per-transaction limit</span></span>
<span id="cb89-90"><a href="#cb89-90" aria-hidden="true" tabindex="-1"></a>        <span class="kw">const</span> MAX_TRANSFER_AMOUNT<span class="op">:</span> Balance <span class="op">=</span> <span class="dv">1_000_000_000_000_000_000_000</span><span class="op">;</span> <span class="co">// 1 million tokens</span></span>
<span id="cb89-91"><a href="#cb89-91" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> amount <span class="op">&gt;</span> MAX_TRANSFER_AMOUNT <span class="op">{</span></span>
<span id="cb89-92"><a href="#cb89-92" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> <span class="cn">Err</span>(<span class="bu">Error</span><span class="pp">::</span>TransferLimitExceeded)<span class="op">;</span></span>
<span id="cb89-93"><a href="#cb89-93" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb89-94"><a href="#cb89-94" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb89-95"><a href="#cb89-95" aria-hidden="true" tabindex="-1"></a>        <span class="cn">Ok</span>(())</span>
<span id="cb89-96"><a href="#cb89-96" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb89-97"><a href="#cb89-97" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<h2 id="payable-messages-handling-native-token-transfers">Payable
Messages: Handling Native Token Transfers</h2>
<p>Payable messages allow contracts to receive native tokens (like DOT
on Polkadot) alongside message calls, enabling powerful patterns for
token sales, deposits, and payment processing.</p>
<h3 id="basic-payable-message-pattern">Basic Payable Message
Pattern</h3>
<div class="sourceCode" id="cb90"><pre
class="sourceCode rust"><code class="sourceCode rust"><span id="cb90-1"><a href="#cb90-1" aria-hidden="true" tabindex="-1"></a><span class="at">#[</span><span class="pp">ink::</span>contract<span class="at">]</span></span>
<span id="cb90-2"><a href="#cb90-2" aria-hidden="true" tabindex="-1"></a><span class="kw">mod</span> payable_contract <span class="op">{</span></span>
<span id="cb90-3"><a href="#cb90-3" aria-hidden="true" tabindex="-1"></a>    <span class="at">#[</span>ink<span class="at">(</span>storage<span class="at">)]</span></span>
<span id="cb90-4"><a href="#cb90-4" aria-hidden="true" tabindex="-1"></a>    <span class="kw">pub</span> <span class="kw">struct</span> PayableContract <span class="op">{</span></span>
<span id="cb90-5"><a href="#cb90-5" aria-hidden="true" tabindex="-1"></a>        owner<span class="op">:</span> AccountId<span class="op">,</span></span>
<span id="cb90-6"><a href="#cb90-6" aria-hidden="true" tabindex="-1"></a>        total_deposits<span class="op">:</span> Balance<span class="op">,</span></span>
<span id="cb90-7"><a href="#cb90-7" aria-hidden="true" tabindex="-1"></a>        user_deposits<span class="op">:</span> <span class="pp">ink::storage::</span>Mapping<span class="op">&lt;</span>AccountId<span class="op">,</span> Balance<span class="op">&gt;,</span></span>
<span id="cb90-8"><a href="#cb90-8" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb90-9"><a href="#cb90-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb90-10"><a href="#cb90-10" aria-hidden="true" tabindex="-1"></a>    <span class="kw">impl</span> PayableContract <span class="op">{</span></span>
<span id="cb90-11"><a href="#cb90-11" aria-hidden="true" tabindex="-1"></a>        <span class="at">#[</span>ink<span class="at">(</span>constructor<span class="at">)]</span></span>
<span id="cb90-12"><a href="#cb90-12" aria-hidden="true" tabindex="-1"></a>        <span class="kw">pub</span> <span class="kw">fn</span> new() <span class="op">-&gt;</span> <span class="dt">Self</span> <span class="op">{</span></span>
<span id="cb90-13"><a href="#cb90-13" aria-hidden="true" tabindex="-1"></a>            <span class="dt">Self</span> <span class="op">{</span></span>
<span id="cb90-14"><a href="#cb90-14" aria-hidden="true" tabindex="-1"></a>                owner<span class="op">:</span> <span class="dt">Self</span><span class="pp">::</span>env()<span class="op">.</span>caller()<span class="op">,</span></span>
<span id="cb90-15"><a href="#cb90-15" aria-hidden="true" tabindex="-1"></a>                total_deposits<span class="op">:</span> <span class="dv">0</span><span class="op">,</span></span>
<span id="cb90-16"><a href="#cb90-16" aria-hidden="true" tabindex="-1"></a>                user_deposits<span class="op">:</span> <span class="pp">ink::storage::Mapping::</span><span class="kw">default</span>()<span class="op">,</span></span>
<span id="cb90-17"><a href="#cb90-17" aria-hidden="true" tabindex="-1"></a>            <span class="op">}</span></span>
<span id="cb90-18"><a href="#cb90-18" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb90-19"><a href="#cb90-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb90-20"><a href="#cb90-20" aria-hidden="true" tabindex="-1"></a>        <span class="co">/// Accept deposits of native tokens</span></span>
<span id="cb90-21"><a href="#cb90-21" aria-hidden="true" tabindex="-1"></a>        <span class="at">#[</span>ink<span class="at">(</span>message<span class="op">,</span> payable<span class="at">)]</span></span>
<span id="cb90-22"><a href="#cb90-22" aria-hidden="true" tabindex="-1"></a>        <span class="kw">pub</span> <span class="kw">fn</span> deposit(<span class="op">&amp;</span><span class="kw">mut</span> <span class="kw">self</span>) <span class="op">-&gt;</span> <span class="dt">Result</span><span class="op">&lt;</span>()<span class="op">,</span> <span class="bu">Error</span><span class="op">&gt;</span> <span class="op">{</span></span>
<span id="cb90-23"><a href="#cb90-23" aria-hidden="true" tabindex="-1"></a>            <span class="kw">let</span> caller <span class="op">=</span> <span class="kw">self</span><span class="op">.</span>env()<span class="op">.</span>caller()<span class="op">;</span></span>
<span id="cb90-24"><a href="#cb90-24" aria-hidden="true" tabindex="-1"></a>            <span class="kw">let</span> deposited_value <span class="op">=</span> <span class="kw">self</span><span class="op">.</span>env()<span class="op">.</span>transferred_value()<span class="op">;</span></span>
<span id="cb90-25"><a href="#cb90-25" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb90-26"><a href="#cb90-26" aria-hidden="true" tabindex="-1"></a>            <span class="co">// Validate deposit amount</span></span>
<span id="cb90-27"><a href="#cb90-27" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> deposited_value <span class="op">==</span> <span class="dv">0</span> <span class="op">{</span></span>
<span id="cb90-28"><a href="#cb90-28" aria-hidden="true" tabindex="-1"></a>                <span class="cf">return</span> <span class="cn">Err</span>(<span class="bu">Error</span><span class="pp">::</span>InvalidAmount)<span class="op">;</span></span>
<span id="cb90-29"><a href="#cb90-29" aria-hidden="true" tabindex="-1"></a>            <span class="op">}</span></span>
<span id="cb90-30"><a href="#cb90-30" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb90-31"><a href="#cb90-31" aria-hidden="true" tabindex="-1"></a>            <span class="co">// Update user&#39;s deposit balance</span></span>
<span id="cb90-32"><a href="#cb90-32" aria-hidden="true" tabindex="-1"></a>            <span class="kw">let</span> current_deposit <span class="op">=</span> <span class="kw">self</span><span class="op">.</span>user_deposits<span class="op">.</span>get(caller)<span class="op">.</span>unwrap_or(<span class="dv">0</span>)<span class="op">;</span></span>
<span id="cb90-33"><a href="#cb90-33" aria-hidden="true" tabindex="-1"></a>            <span class="kw">let</span> new_deposit <span class="op">=</span> current_deposit</span>
<span id="cb90-34"><a href="#cb90-34" aria-hidden="true" tabindex="-1"></a>                <span class="op">.</span>checked_add(deposited_value)</span>
<span id="cb90-35"><a href="#cb90-35" aria-hidden="true" tabindex="-1"></a>                <span class="op">.</span>ok_or(<span class="bu">Error</span><span class="pp">::</span>ArithmeticOverflow)<span class="op">?;</span></span>
<span id="cb90-36"><a href="#cb90-36" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb90-37"><a href="#cb90-37" aria-hidden="true" tabindex="-1"></a>            <span class="kw">self</span><span class="op">.</span>user_deposits<span class="op">.</span>insert(caller<span class="op">,</span> <span class="op">&amp;</span>new_deposit)<span class="op">;</span></span>
<span id="cb90-38"><a href="#cb90-38" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb90-39"><a href="#cb90-39" aria-hidden="true" tabindex="-1"></a>            <span class="co">// Update total deposits</span></span>
<span id="cb90-40"><a href="#cb90-40" aria-hidden="true" tabindex="-1"></a>            <span class="kw">self</span><span class="op">.</span>total_deposits <span class="op">=</span> <span class="kw">self</span><span class="op">.</span>total_deposits</span>
<span id="cb90-41"><a href="#cb90-41" aria-hidden="true" tabindex="-1"></a>                <span class="op">.</span>checked_add(deposited_value)</span>
<span id="cb90-42"><a href="#cb90-42" aria-hidden="true" tabindex="-1"></a>                <span class="op">.</span>ok_or(<span class="bu">Error</span><span class="pp">::</span>ArithmeticOverflow)<span class="op">?;</span></span>
<span id="cb90-43"><a href="#cb90-43" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb90-44"><a href="#cb90-44" aria-hidden="true" tabindex="-1"></a>            <span class="cn">Ok</span>(())</span>
<span id="cb90-45"><a href="#cb90-45" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb90-46"><a href="#cb90-46" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb90-47"><a href="#cb90-47" aria-hidden="true" tabindex="-1"></a>        <span class="co">/// Withdraw deposited tokens</span></span>
<span id="cb90-48"><a href="#cb90-48" aria-hidden="true" tabindex="-1"></a>        <span class="at">#[</span>ink<span class="at">(</span>message<span class="at">)]</span></span>
<span id="cb90-49"><a href="#cb90-49" aria-hidden="true" tabindex="-1"></a>        <span class="kw">pub</span> <span class="kw">fn</span> withdraw(<span class="op">&amp;</span><span class="kw">mut</span> <span class="kw">self</span><span class="op">,</span> amount<span class="op">:</span> Balance) <span class="op">-&gt;</span> <span class="dt">Result</span><span class="op">&lt;</span>()<span class="op">,</span> <span class="bu">Error</span><span class="op">&gt;</span> <span class="op">{</span></span>
<span id="cb90-50"><a href="#cb90-50" aria-hidden="true" tabindex="-1"></a>            <span class="kw">let</span> caller <span class="op">=</span> <span class="kw">self</span><span class="op">.</span>env()<span class="op">.</span>caller()<span class="op">;</span></span>
<span id="cb90-51"><a href="#cb90-51" aria-hidden="true" tabindex="-1"></a>            <span class="kw">let</span> user_deposit <span class="op">=</span> <span class="kw">self</span><span class="op">.</span>user_deposits<span class="op">.</span>get(caller)<span class="op">.</span>unwrap_or(<span class="dv">0</span>)<span class="op">;</span></span>
<span id="cb90-52"><a href="#cb90-52" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb90-53"><a href="#cb90-53" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> user_deposit <span class="op">&lt;</span> amount <span class="op">{</span></span>
<span id="cb90-54"><a href="#cb90-54" aria-hidden="true" tabindex="-1"></a>                <span class="cf">return</span> <span class="cn">Err</span>(<span class="bu">Error</span><span class="pp">::</span>InsufficientBalance)<span class="op">;</span></span>
<span id="cb90-55"><a href="#cb90-55" aria-hidden="true" tabindex="-1"></a>            <span class="op">}</span></span>
<span id="cb90-56"><a href="#cb90-56" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb90-57"><a href="#cb90-57" aria-hidden="true" tabindex="-1"></a>            <span class="co">// Update balances</span></span>
<span id="cb90-58"><a href="#cb90-58" aria-hidden="true" tabindex="-1"></a>            <span class="kw">let</span> new_deposit <span class="op">=</span> user_deposit <span class="op">-</span> amount<span class="op">;</span></span>
<span id="cb90-59"><a href="#cb90-59" aria-hidden="true" tabindex="-1"></a>            <span class="kw">self</span><span class="op">.</span>user_deposits<span class="op">.</span>insert(caller<span class="op">,</span> <span class="op">&amp;</span>new_deposit)<span class="op">;</span></span>
<span id="cb90-60"><a href="#cb90-60" aria-hidden="true" tabindex="-1"></a>            <span class="kw">self</span><span class="op">.</span>total_deposits <span class="op">-=</span> amount<span class="op">;</span></span>
<span id="cb90-61"><a href="#cb90-61" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb90-62"><a href="#cb90-62" aria-hidden="true" tabindex="-1"></a>            <span class="co">// Transfer tokens back to user</span></span>
<span id="cb90-63"><a href="#cb90-63" aria-hidden="true" tabindex="-1"></a>            <span class="kw">self</span><span class="op">.</span>env()<span class="op">.</span>transfer(caller<span class="op">,</span> amount)</span>
<span id="cb90-64"><a href="#cb90-64" aria-hidden="true" tabindex="-1"></a>                <span class="op">.</span>map_err(<span class="op">|</span>_<span class="op">|</span> <span class="bu">Error</span><span class="pp">::</span>TransferFailed)<span class="op">?;</span></span>
<span id="cb90-65"><a href="#cb90-65" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb90-66"><a href="#cb90-66" aria-hidden="true" tabindex="-1"></a>            <span class="cn">Ok</span>(())</span>
<span id="cb90-67"><a href="#cb90-67" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb90-68"><a href="#cb90-68" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb90-69"><a href="#cb90-69" aria-hidden="true" tabindex="-1"></a>        <span class="co">/// Check user&#39;s deposit balance</span></span>
<span id="cb90-70"><a href="#cb90-70" aria-hidden="true" tabindex="-1"></a>        <span class="at">#[</span>ink<span class="at">(</span>message<span class="at">)]</span></span>
<span id="cb90-71"><a href="#cb90-71" aria-hidden="true" tabindex="-1"></a>        <span class="kw">pub</span> <span class="kw">fn</span> deposit_of(<span class="op">&amp;</span><span class="kw">self</span><span class="op">,</span> account<span class="op">:</span> AccountId) <span class="op">-&gt;</span> Balance <span class="op">{</span></span>
<span id="cb90-72"><a href="#cb90-72" aria-hidden="true" tabindex="-1"></a>            <span class="kw">self</span><span class="op">.</span>user_deposits<span class="op">.</span>get(account)<span class="op">.</span>unwrap_or(<span class="dv">0</span>)</span>
<span id="cb90-73"><a href="#cb90-73" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb90-74"><a href="#cb90-74" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb90-75"><a href="#cb90-75" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<h3 id="token-sale-contract-with-payable-messages">Token Sale Contract
with Payable Messages</h3>
<div class="sourceCode" id="cb91"><pre
class="sourceCode rust"><code class="sourceCode rust"><span id="cb91-1"><a href="#cb91-1" aria-hidden="true" tabindex="-1"></a><span class="at">#[</span><span class="pp">ink::</span>contract<span class="at">]</span></span>
<span id="cb91-2"><a href="#cb91-2" aria-hidden="true" tabindex="-1"></a><span class="kw">mod</span> token_sale <span class="op">{</span></span>
<span id="cb91-3"><a href="#cb91-3" aria-hidden="true" tabindex="-1"></a>    <span class="kw">use</span> <span class="pp">ink::storage::</span>Mapping<span class="op">;</span></span>
<span id="cb91-4"><a href="#cb91-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb91-5"><a href="#cb91-5" aria-hidden="true" tabindex="-1"></a>    <span class="at">#[</span>ink<span class="at">(</span>storage<span class="at">)]</span></span>
<span id="cb91-6"><a href="#cb91-6" aria-hidden="true" tabindex="-1"></a>    <span class="kw">pub</span> <span class="kw">struct</span> TokenSale <span class="op">{</span></span>
<span id="cb91-7"><a href="#cb91-7" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Sale parameters</span></span>
<span id="cb91-8"><a href="#cb91-8" aria-hidden="true" tabindex="-1"></a>        token_price<span class="op">:</span> Balance<span class="op">,</span>     <span class="co">// Price per token in native currency</span></span>
<span id="cb91-9"><a href="#cb91-9" aria-hidden="true" tabindex="-1"></a>        tokens_sold<span class="op">:</span> Balance<span class="op">,</span></span>
<span id="cb91-10"><a href="#cb91-10" aria-hidden="true" tabindex="-1"></a>        max_tokens<span class="op">:</span> Balance<span class="op">,</span></span>
<span id="cb91-11"><a href="#cb91-11" aria-hidden="true" tabindex="-1"></a>        sale_active<span class="op">:</span> <span class="dt">bool</span><span class="op">,</span></span>
<span id="cb91-12"><a href="#cb91-12" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb91-13"><a href="#cb91-13" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Balances</span></span>
<span id="cb91-14"><a href="#cb91-14" aria-hidden="true" tabindex="-1"></a>        purchased_tokens<span class="op">:</span> Mapping<span class="op">&lt;</span>AccountId<span class="op">,</span> Balance<span class="op">&gt;,</span></span>
<span id="cb91-15"><a href="#cb91-15" aria-hidden="true" tabindex="-1"></a>        total_raised<span class="op">:</span> Balance<span class="op">,</span></span>
<span id="cb91-16"><a href="#cb91-16" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb91-17"><a href="#cb91-17" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Access control</span></span>
<span id="cb91-18"><a href="#cb91-18" aria-hidden="true" tabindex="-1"></a>        owner<span class="op">:</span> AccountId<span class="op">,</span></span>
<span id="cb91-19"><a href="#cb91-19" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb91-20"><a href="#cb91-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb91-21"><a href="#cb91-21" aria-hidden="true" tabindex="-1"></a>    <span class="kw">impl</span> TokenSale <span class="op">{</span></span>
<span id="cb91-22"><a href="#cb91-22" aria-hidden="true" tabindex="-1"></a>        <span class="at">#[</span>ink<span class="at">(</span>constructor<span class="at">)]</span></span>
<span id="cb91-23"><a href="#cb91-23" aria-hidden="true" tabindex="-1"></a>        <span class="kw">pub</span> <span class="kw">fn</span> new(token_price<span class="op">:</span> Balance<span class="op">,</span> max_tokens<span class="op">:</span> Balance) <span class="op">-&gt;</span> <span class="dt">Result</span><span class="op">&lt;</span><span class="dt">Self</span><span class="op">,</span> <span class="bu">Error</span><span class="op">&gt;</span> <span class="op">{</span></span>
<span id="cb91-24"><a href="#cb91-24" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> token_price <span class="op">==</span> <span class="dv">0</span> <span class="op">||</span> max_tokens <span class="op">==</span> <span class="dv">0</span> <span class="op">{</span></span>
<span id="cb91-25"><a href="#cb91-25" aria-hidden="true" tabindex="-1"></a>                <span class="cf">return</span> <span class="cn">Err</span>(<span class="bu">Error</span><span class="pp">::</span>InvalidParameters)<span class="op">;</span></span>
<span id="cb91-26"><a href="#cb91-26" aria-hidden="true" tabindex="-1"></a>            <span class="op">}</span></span>
<span id="cb91-27"><a href="#cb91-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb91-28"><a href="#cb91-28" aria-hidden="true" tabindex="-1"></a>            <span class="cn">Ok</span>(<span class="dt">Self</span> <span class="op">{</span></span>
<span id="cb91-29"><a href="#cb91-29" aria-hidden="true" tabindex="-1"></a>                token_price<span class="op">,</span></span>
<span id="cb91-30"><a href="#cb91-30" aria-hidden="true" tabindex="-1"></a>                tokens_sold<span class="op">:</span> <span class="dv">0</span><span class="op">,</span></span>
<span id="cb91-31"><a href="#cb91-31" aria-hidden="true" tabindex="-1"></a>                max_tokens<span class="op">,</span></span>
<span id="cb91-32"><a href="#cb91-32" aria-hidden="true" tabindex="-1"></a>                sale_active<span class="op">:</span> <span class="cn">true</span><span class="op">,</span></span>
<span id="cb91-33"><a href="#cb91-33" aria-hidden="true" tabindex="-1"></a>                purchased_tokens<span class="op">:</span> <span class="pp">Mapping::</span><span class="kw">default</span>()<span class="op">,</span></span>
<span id="cb91-34"><a href="#cb91-34" aria-hidden="true" tabindex="-1"></a>                total_raised<span class="op">:</span> <span class="dv">0</span><span class="op">,</span></span>
<span id="cb91-35"><a href="#cb91-35" aria-hidden="true" tabindex="-1"></a>                owner<span class="op">:</span> <span class="dt">Self</span><span class="pp">::</span>env()<span class="op">.</span>caller()<span class="op">,</span></span>
<span id="cb91-36"><a href="#cb91-36" aria-hidden="true" tabindex="-1"></a>            <span class="op">}</span>)</span>
<span id="cb91-37"><a href="#cb91-37" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb91-38"><a href="#cb91-38" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb91-39"><a href="#cb91-39" aria-hidden="true" tabindex="-1"></a>        <span class="co">/// Purchase tokens with native currency</span></span>
<span id="cb91-40"><a href="#cb91-40" aria-hidden="true" tabindex="-1"></a>        <span class="at">#[</span>ink<span class="at">(</span>message<span class="op">,</span> payable<span class="at">)]</span></span>
<span id="cb91-41"><a href="#cb91-41" aria-hidden="true" tabindex="-1"></a>        <span class="kw">pub</span> <span class="kw">fn</span> buy_tokens(<span class="op">&amp;</span><span class="kw">mut</span> <span class="kw">self</span>) <span class="op">-&gt;</span> <span class="dt">Result</span><span class="op">&lt;</span>Balance<span class="op">,</span> <span class="bu">Error</span><span class="op">&gt;</span> <span class="op">{</span></span>
<span id="cb91-42"><a href="#cb91-42" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> <span class="op">!</span><span class="kw">self</span><span class="op">.</span>sale_active <span class="op">{</span></span>
<span id="cb91-43"><a href="#cb91-43" aria-hidden="true" tabindex="-1"></a>                <span class="cf">return</span> <span class="cn">Err</span>(<span class="bu">Error</span><span class="pp">::</span>SaleInactive)<span class="op">;</span></span>
<span id="cb91-44"><a href="#cb91-44" aria-hidden="true" tabindex="-1"></a>            <span class="op">}</span></span>
<span id="cb91-45"><a href="#cb91-45" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb91-46"><a href="#cb91-46" aria-hidden="true" tabindex="-1"></a>            <span class="kw">let</span> payment <span class="op">=</span> <span class="kw">self</span><span class="op">.</span>env()<span class="op">.</span>transferred_value()<span class="op">;</span></span>
<span id="cb91-47"><a href="#cb91-47" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> payment <span class="op">==</span> <span class="dv">0</span> <span class="op">{</span></span>
<span id="cb91-48"><a href="#cb91-48" aria-hidden="true" tabindex="-1"></a>                <span class="cf">return</span> <span class="cn">Err</span>(<span class="bu">Error</span><span class="pp">::</span>InvalidAmount)<span class="op">;</span></span>
<span id="cb91-49"><a href="#cb91-49" aria-hidden="true" tabindex="-1"></a>            <span class="op">}</span></span>
<span id="cb91-50"><a href="#cb91-50" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb91-51"><a href="#cb91-51" aria-hidden="true" tabindex="-1"></a>            <span class="co">// Calculate tokens to purchase</span></span>
<span id="cb91-52"><a href="#cb91-52" aria-hidden="true" tabindex="-1"></a>            <span class="kw">let</span> tokens_to_buy <span class="op">=</span> payment <span class="op">/</span> <span class="kw">self</span><span class="op">.</span>token_price<span class="op">;</span></span>
<span id="cb91-53"><a href="#cb91-53" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> tokens_to_buy <span class="op">==</span> <span class="dv">0</span> <span class="op">{</span></span>
<span id="cb91-54"><a href="#cb91-54" aria-hidden="true" tabindex="-1"></a>                <span class="cf">return</span> <span class="cn">Err</span>(<span class="bu">Error</span><span class="pp">::</span>InsufficientPayment)<span class="op">;</span></span>
<span id="cb91-55"><a href="#cb91-55" aria-hidden="true" tabindex="-1"></a>            <span class="op">}</span></span>
<span id="cb91-56"><a href="#cb91-56" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb91-57"><a href="#cb91-57" aria-hidden="true" tabindex="-1"></a>            <span class="co">// Check if enough tokens are available</span></span>
<span id="cb91-58"><a href="#cb91-58" aria-hidden="true" tabindex="-1"></a>            <span class="kw">let</span> remaining_tokens <span class="op">=</span> <span class="kw">self</span><span class="op">.</span>max_tokens <span class="op">-</span> <span class="kw">self</span><span class="op">.</span>tokens_sold<span class="op">;</span></span>
<span id="cb91-59"><a href="#cb91-59" aria-hidden="true" tabindex="-1"></a>            <span class="kw">let</span> actual_tokens <span class="op">=</span> tokens_to_buy<span class="op">.</span>min(remaining_tokens)<span class="op">;</span></span>
<span id="cb91-60"><a href="#cb91-60" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb91-61"><a href="#cb91-61" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> actual_tokens <span class="op">==</span> <span class="dv">0</span> <span class="op">{</span></span>
<span id="cb91-62"><a href="#cb91-62" aria-hidden="true" tabindex="-1"></a>                <span class="cf">return</span> <span class="cn">Err</span>(<span class="bu">Error</span><span class="pp">::</span>SoldOut)<span class="op">;</span></span>
<span id="cb91-63"><a href="#cb91-63" aria-hidden="true" tabindex="-1"></a>            <span class="op">}</span></span>
<span id="cb91-64"><a href="#cb91-64" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb91-65"><a href="#cb91-65" aria-hidden="true" tabindex="-1"></a>            <span class="co">// Calculate actual cost and refund excess</span></span>
<span id="cb91-66"><a href="#cb91-66" aria-hidden="true" tabindex="-1"></a>            <span class="kw">let</span> actual_cost <span class="op">=</span> actual_tokens <span class="op">*</span> <span class="kw">self</span><span class="op">.</span>token_price<span class="op">;</span></span>
<span id="cb91-67"><a href="#cb91-67" aria-hidden="true" tabindex="-1"></a>            <span class="kw">let</span> refund <span class="op">=</span> payment <span class="op">-</span> actual_cost<span class="op">;</span></span>
<span id="cb91-68"><a href="#cb91-68" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb91-69"><a href="#cb91-69" aria-hidden="true" tabindex="-1"></a>            <span class="co">// Update state</span></span>
<span id="cb91-70"><a href="#cb91-70" aria-hidden="true" tabindex="-1"></a>            <span class="kw">let</span> caller <span class="op">=</span> <span class="kw">self</span><span class="op">.</span>env()<span class="op">.</span>caller()<span class="op">;</span></span>
<span id="cb91-71"><a href="#cb91-71" aria-hidden="true" tabindex="-1"></a>            <span class="kw">let</span> current_tokens <span class="op">=</span> <span class="kw">self</span><span class="op">.</span>purchased_tokens<span class="op">.</span>get(caller)<span class="op">.</span>unwrap_or(<span class="dv">0</span>)<span class="op">;</span></span>
<span id="cb91-72"><a href="#cb91-72" aria-hidden="true" tabindex="-1"></a>            <span class="kw">let</span> new_tokens <span class="op">=</span> current_tokens <span class="op">+</span> actual_tokens<span class="op">;</span></span>
<span id="cb91-73"><a href="#cb91-73" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb91-74"><a href="#cb91-74" aria-hidden="true" tabindex="-1"></a>            <span class="kw">self</span><span class="op">.</span>purchased_tokens<span class="op">.</span>insert(caller<span class="op">,</span> <span class="op">&amp;</span>new_tokens)<span class="op">;</span></span>
<span id="cb91-75"><a href="#cb91-75" aria-hidden="true" tabindex="-1"></a>            <span class="kw">self</span><span class="op">.</span>tokens_sold <span class="op">+=</span> actual_tokens<span class="op">;</span></span>
<span id="cb91-76"><a href="#cb91-76" aria-hidden="true" tabindex="-1"></a>            <span class="kw">self</span><span class="op">.</span>total_raised <span class="op">+=</span> actual_cost<span class="op">;</span></span>
<span id="cb91-77"><a href="#cb91-77" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb91-78"><a href="#cb91-78" aria-hidden="true" tabindex="-1"></a>            <span class="co">// Process refund if necessary</span></span>
<span id="cb91-79"><a href="#cb91-79" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> refund <span class="op">&gt;</span> <span class="dv">0</span> <span class="op">{</span></span>
<span id="cb91-80"><a href="#cb91-80" aria-hidden="true" tabindex="-1"></a>                <span class="kw">self</span><span class="op">.</span>env()<span class="op">.</span>transfer(caller<span class="op">,</span> refund)</span>
<span id="cb91-81"><a href="#cb91-81" aria-hidden="true" tabindex="-1"></a>                    <span class="op">.</span>map_err(<span class="op">|</span>_<span class="op">|</span> <span class="bu">Error</span><span class="pp">::</span>RefundFailed)<span class="op">?;</span></span>
<span id="cb91-82"><a href="#cb91-82" aria-hidden="true" tabindex="-1"></a>            <span class="op">}</span></span>
<span id="cb91-83"><a href="#cb91-83" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb91-84"><a href="#cb91-84" aria-hidden="true" tabindex="-1"></a>            <span class="cn">Ok</span>(actual_tokens)</span>
<span id="cb91-85"><a href="#cb91-85" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb91-86"><a href="#cb91-86" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb91-87"><a href="#cb91-87" aria-hidden="true" tabindex="-1"></a>        <span class="co">/// Emergency withdrawal (owner only)</span></span>
<span id="cb91-88"><a href="#cb91-88" aria-hidden="true" tabindex="-1"></a>        <span class="at">#[</span>ink<span class="at">(</span>message<span class="at">)]</span></span>
<span id="cb91-89"><a href="#cb91-89" aria-hidden="true" tabindex="-1"></a>        <span class="kw">pub</span> <span class="kw">fn</span> emergency_withdraw(<span class="op">&amp;</span><span class="kw">mut</span> <span class="kw">self</span>) <span class="op">-&gt;</span> <span class="dt">Result</span><span class="op">&lt;</span>()<span class="op">,</span> <span class="bu">Error</span><span class="op">&gt;</span> <span class="op">{</span></span>
<span id="cb91-90"><a href="#cb91-90" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> <span class="kw">self</span><span class="op">.</span>env()<span class="op">.</span>caller() <span class="op">!=</span> <span class="kw">self</span><span class="op">.</span>owner <span class="op">{</span></span>
<span id="cb91-91"><a href="#cb91-91" aria-hidden="true" tabindex="-1"></a>                <span class="cf">return</span> <span class="cn">Err</span>(<span class="bu">Error</span><span class="pp">::</span>Unauthorized)<span class="op">;</span></span>
<span id="cb91-92"><a href="#cb91-92" aria-hidden="true" tabindex="-1"></a>            <span class="op">}</span></span>
<span id="cb91-93"><a href="#cb91-93" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb91-94"><a href="#cb91-94" aria-hidden="true" tabindex="-1"></a>            <span class="kw">let</span> contract_balance <span class="op">=</span> <span class="kw">self</span><span class="op">.</span>env()<span class="op">.</span>balance()<span class="op">;</span></span>
<span id="cb91-95"><a href="#cb91-95" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> contract_balance <span class="op">&gt;</span> <span class="dv">0</span> <span class="op">{</span></span>
<span id="cb91-96"><a href="#cb91-96" aria-hidden="true" tabindex="-1"></a>                <span class="kw">self</span><span class="op">.</span>env()<span class="op">.</span>transfer(<span class="kw">self</span><span class="op">.</span>owner<span class="op">,</span> contract_balance)</span>
<span id="cb91-97"><a href="#cb91-97" aria-hidden="true" tabindex="-1"></a>                    <span class="op">.</span>map_err(<span class="op">|</span>_<span class="op">|</span> <span class="bu">Error</span><span class="pp">::</span>TransferFailed)<span class="op">?;</span></span>
<span id="cb91-98"><a href="#cb91-98" aria-hidden="true" tabindex="-1"></a>            <span class="op">}</span></span>
<span id="cb91-99"><a href="#cb91-99" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb91-100"><a href="#cb91-100" aria-hidden="true" tabindex="-1"></a>            <span class="cn">Ok</span>(())</span>
<span id="cb91-101"><a href="#cb91-101" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb91-102"><a href="#cb91-102" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb91-103"><a href="#cb91-103" aria-hidden="true" tabindex="-1"></a>        <span class="co">/// Withdraw raised funds (owner only)</span></span>
<span id="cb91-104"><a href="#cb91-104" aria-hidden="true" tabindex="-1"></a>        <span class="at">#[</span>ink<span class="at">(</span>message<span class="at">)]</span></span>
<span id="cb91-105"><a href="#cb91-105" aria-hidden="true" tabindex="-1"></a>        <span class="kw">pub</span> <span class="kw">fn</span> withdraw_funds(<span class="op">&amp;</span><span class="kw">mut</span> <span class="kw">self</span><span class="op">,</span> amount<span class="op">:</span> Balance) <span class="op">-&gt;</span> <span class="dt">Result</span><span class="op">&lt;</span>()<span class="op">,</span> <span class="bu">Error</span><span class="op">&gt;</span> <span class="op">{</span></span>
<span id="cb91-106"><a href="#cb91-106" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> <span class="kw">self</span><span class="op">.</span>env()<span class="op">.</span>caller() <span class="op">!=</span> <span class="kw">self</span><span class="op">.</span>owner <span class="op">{</span></span>
<span id="cb91-107"><a href="#cb91-107" aria-hidden="true" tabindex="-1"></a>                <span class="cf">return</span> <span class="cn">Err</span>(<span class="bu">Error</span><span class="pp">::</span>Unauthorized)<span class="op">;</span></span>
<span id="cb91-108"><a href="#cb91-108" aria-hidden="true" tabindex="-1"></a>            <span class="op">}</span></span>
<span id="cb91-109"><a href="#cb91-109" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb91-110"><a href="#cb91-110" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> amount <span class="op">&gt;</span> <span class="kw">self</span><span class="op">.</span>total_raised <span class="op">{</span></span>
<span id="cb91-111"><a href="#cb91-111" aria-hidden="true" tabindex="-1"></a>                <span class="cf">return</span> <span class="cn">Err</span>(<span class="bu">Error</span><span class="pp">::</span>InsufficientBalance)<span class="op">;</span></span>
<span id="cb91-112"><a href="#cb91-112" aria-hidden="true" tabindex="-1"></a>            <span class="op">}</span></span>
<span id="cb91-113"><a href="#cb91-113" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb91-114"><a href="#cb91-114" aria-hidden="true" tabindex="-1"></a>            <span class="kw">self</span><span class="op">.</span>env()<span class="op">.</span>transfer(<span class="kw">self</span><span class="op">.</span>owner<span class="op">,</span> amount)</span>
<span id="cb91-115"><a href="#cb91-115" aria-hidden="true" tabindex="-1"></a>                <span class="op">.</span>map_err(<span class="op">|</span>_<span class="op">|</span> <span class="bu">Error</span><span class="pp">::</span>TransferFailed)<span class="op">?;</span></span>
<span id="cb91-116"><a href="#cb91-116" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb91-117"><a href="#cb91-117" aria-hidden="true" tabindex="-1"></a>            <span class="cn">Ok</span>(())</span>
<span id="cb91-118"><a href="#cb91-118" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb91-119"><a href="#cb91-119" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb91-120"><a href="#cb91-120" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<h3 id="advanced-payable-patterns">Advanced Payable Patterns</h3>
<div class="sourceCode" id="cb92"><pre
class="sourceCode rust"><code class="sourceCode rust"><span id="cb92-1"><a href="#cb92-1" aria-hidden="true" tabindex="-1"></a><span class="kw">impl</span> TokenSale <span class="op">{</span></span>
<span id="cb92-2"><a href="#cb92-2" aria-hidden="true" tabindex="-1"></a>    <span class="co">/// Tiered pricing based on purchase amount</span></span>
<span id="cb92-3"><a href="#cb92-3" aria-hidden="true" tabindex="-1"></a>    <span class="at">#[</span>ink<span class="at">(</span>message<span class="op">,</span> payable<span class="at">)]</span></span>
<span id="cb92-4"><a href="#cb92-4" aria-hidden="true" tabindex="-1"></a>    <span class="kw">pub</span> <span class="kw">fn</span> buy_tokens_tiered(<span class="op">&amp;</span><span class="kw">mut</span> <span class="kw">self</span>) <span class="op">-&gt;</span> <span class="dt">Result</span><span class="op">&lt;</span>Balance<span class="op">,</span> <span class="bu">Error</span><span class="op">&gt;</span> <span class="op">{</span></span>
<span id="cb92-5"><a href="#cb92-5" aria-hidden="true" tabindex="-1"></a>        <span class="kw">let</span> payment <span class="op">=</span> <span class="kw">self</span><span class="op">.</span>env()<span class="op">.</span>transferred_value()<span class="op">;</span></span>
<span id="cb92-6"><a href="#cb92-6" aria-hidden="true" tabindex="-1"></a>        <span class="kw">let</span> tokens_to_buy <span class="op">=</span> <span class="kw">self</span><span class="op">.</span>calculate_tiered_tokens(payment)<span class="op">?;</span></span>
<span id="cb92-7"><a href="#cb92-7" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb92-8"><a href="#cb92-8" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Execute purchase with calculated tokens</span></span>
<span id="cb92-9"><a href="#cb92-9" aria-hidden="true" tabindex="-1"></a>        <span class="kw">self</span><span class="op">.</span>execute_purchase(tokens_to_buy<span class="op">,</span> payment)</span>
<span id="cb92-10"><a href="#cb92-10" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb92-11"><a href="#cb92-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb92-12"><a href="#cb92-12" aria-hidden="true" tabindex="-1"></a>    <span class="co">/// Calculate tokens with tiered pricing</span></span>
<span id="cb92-13"><a href="#cb92-13" aria-hidden="true" tabindex="-1"></a>    <span class="kw">fn</span> calculate_tiered_tokens(<span class="op">&amp;</span><span class="kw">self</span><span class="op">,</span> payment<span class="op">:</span> Balance) <span class="op">-&gt;</span> <span class="dt">Result</span><span class="op">&lt;</span>Balance<span class="op">,</span> <span class="bu">Error</span><span class="op">&gt;</span> <span class="op">{</span></span>
<span id="cb92-14"><a href="#cb92-14" aria-hidden="true" tabindex="-1"></a>        <span class="kw">const</span> TIER1_THRESHOLD<span class="op">:</span> Balance <span class="op">=</span> <span class="dv">1_000_000_000_000</span><span class="op">;</span> <span class="co">// 1 token</span></span>
<span id="cb92-15"><a href="#cb92-15" aria-hidden="true" tabindex="-1"></a>        <span class="kw">const</span> TIER2_THRESHOLD<span class="op">:</span> Balance <span class="op">=</span> <span class="dv">10_000_000_000_000</span><span class="op">;</span> <span class="co">// 10 tokens</span></span>
<span id="cb92-16"><a href="#cb92-16" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb92-17"><a href="#cb92-17" aria-hidden="true" tabindex="-1"></a>        <span class="kw">let</span> discount_price <span class="op">=</span> <span class="cf">if</span> payment <span class="op">&gt;=</span> TIER2_THRESHOLD <span class="op">{</span></span>
<span id="cb92-18"><a href="#cb92-18" aria-hidden="true" tabindex="-1"></a>            <span class="kw">self</span><span class="op">.</span>token_price <span class="op">*</span> <span class="dv">80</span> <span class="op">/</span> <span class="dv">100</span> <span class="co">// 20% discount</span></span>
<span id="cb92-19"><a href="#cb92-19" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span> <span class="cf">else</span> <span class="cf">if</span> payment <span class="op">&gt;=</span> TIER1_THRESHOLD <span class="op">{</span></span>
<span id="cb92-20"><a href="#cb92-20" aria-hidden="true" tabindex="-1"></a>            <span class="kw">self</span><span class="op">.</span>token_price <span class="op">*</span> <span class="dv">90</span> <span class="op">/</span> <span class="dv">100</span> <span class="co">// 10% discount</span></span>
<span id="cb92-21"><a href="#cb92-21" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span> <span class="cf">else</span> <span class="op">{</span></span>
<span id="cb92-22"><a href="#cb92-22" aria-hidden="true" tabindex="-1"></a>            <span class="kw">self</span><span class="op">.</span>token_price</span>
<span id="cb92-23"><a href="#cb92-23" aria-hidden="true" tabindex="-1"></a>        <span class="op">};</span></span>
<span id="cb92-24"><a href="#cb92-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb92-25"><a href="#cb92-25" aria-hidden="true" tabindex="-1"></a>        <span class="cn">Ok</span>(payment <span class="op">/</span> discount_price)</span>
<span id="cb92-26"><a href="#cb92-26" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb92-27"><a href="#cb92-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb92-28"><a href="#cb92-28" aria-hidden="true" tabindex="-1"></a>    <span class="co">/// Presale with whitelist and limits</span></span>
<span id="cb92-29"><a href="#cb92-29" aria-hidden="true" tabindex="-1"></a>    <span class="at">#[</span>ink<span class="at">(</span>message<span class="op">,</span> payable<span class="at">)]</span></span>
<span id="cb92-30"><a href="#cb92-30" aria-hidden="true" tabindex="-1"></a>    <span class="kw">pub</span> <span class="kw">fn</span> presale_purchase(<span class="op">&amp;</span><span class="kw">mut</span> <span class="kw">self</span><span class="op">,</span> max_purchase<span class="op">:</span> Balance) <span class="op">-&gt;</span> <span class="dt">Result</span><span class="op">&lt;</span>Balance<span class="op">,</span> <span class="bu">Error</span><span class="op">&gt;</span> <span class="op">{</span></span>
<span id="cb92-31"><a href="#cb92-31" aria-hidden="true" tabindex="-1"></a>        <span class="kw">let</span> caller <span class="op">=</span> <span class="kw">self</span><span class="op">.</span>env()<span class="op">.</span>caller()<span class="op">;</span></span>
<span id="cb92-32"><a href="#cb92-32" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb92-33"><a href="#cb92-33" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Check whitelist (implementation depends on whitelist mechanism)</span></span>
<span id="cb92-34"><a href="#cb92-34" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="op">!</span><span class="kw">self</span><span class="op">.</span>is_whitelisted(caller) <span class="op">{</span></span>
<span id="cb92-35"><a href="#cb92-35" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> <span class="cn">Err</span>(<span class="bu">Error</span><span class="pp">::</span>NotWhitelisted)<span class="op">;</span></span>
<span id="cb92-36"><a href="#cb92-36" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb92-37"><a href="#cb92-37" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb92-38"><a href="#cb92-38" aria-hidden="true" tabindex="-1"></a>        <span class="kw">let</span> payment <span class="op">=</span> <span class="kw">self</span><span class="op">.</span>env()<span class="op">.</span>transferred_value()<span class="op">;</span></span>
<span id="cb92-39"><a href="#cb92-39" aria-hidden="true" tabindex="-1"></a>        <span class="kw">let</span> tokens_to_buy <span class="op">=</span> payment <span class="op">/</span> <span class="kw">self</span><span class="op">.</span>token_price<span class="op">;</span></span>
<span id="cb92-40"><a href="#cb92-40" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb92-41"><a href="#cb92-41" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Check individual purchase limit</span></span>
<span id="cb92-42"><a href="#cb92-42" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> tokens_to_buy <span class="op">&gt;</span> max_purchase <span class="op">{</span></span>
<span id="cb92-43"><a href="#cb92-43" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> <span class="cn">Err</span>(<span class="bu">Error</span><span class="pp">::</span>PurchaseLimitExceeded)<span class="op">;</span></span>
<span id="cb92-44"><a href="#cb92-44" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb92-45"><a href="#cb92-45" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb92-46"><a href="#cb92-46" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Check lifetime purchase limit</span></span>
<span id="cb92-47"><a href="#cb92-47" aria-hidden="true" tabindex="-1"></a>        <span class="kw">let</span> current_tokens <span class="op">=</span> <span class="kw">self</span><span class="op">.</span>purchased_tokens<span class="op">.</span>get(caller)<span class="op">.</span>unwrap_or(<span class="dv">0</span>)<span class="op">;</span></span>
<span id="cb92-48"><a href="#cb92-48" aria-hidden="true" tabindex="-1"></a>        <span class="kw">const</span> LIFETIME_LIMIT<span class="op">:</span> Balance <span class="op">=</span> <span class="dv">100_000_000_000_000</span><span class="op">;</span> <span class="co">// 100 tokens</span></span>
<span id="cb92-49"><a href="#cb92-49" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb92-50"><a href="#cb92-50" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> current_tokens <span class="op">+</span> tokens_to_buy <span class="op">&gt;</span> LIFETIME_LIMIT <span class="op">{</span></span>
<span id="cb92-51"><a href="#cb92-51" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> <span class="cn">Err</span>(<span class="bu">Error</span><span class="pp">::</span>LifetimeLimitExceeded)<span class="op">;</span></span>
<span id="cb92-52"><a href="#cb92-52" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb92-53"><a href="#cb92-53" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb92-54"><a href="#cb92-54" aria-hidden="true" tabindex="-1"></a>        <span class="kw">self</span><span class="op">.</span>execute_purchase(tokens_to_buy<span class="op">,</span> payment)</span>
<span id="cb92-55"><a href="#cb92-55" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb92-56"><a href="#cb92-56" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<h2 id="accessing-environmental-information">Accessing Environmental
Information</h2>
<p>Contract messages can access rich environmental information about the
blockchain state and transaction context.</p>
<h3 id="core-environmental-functions">Core Environmental Functions</h3>
<div class="sourceCode" id="cb93"><pre
class="sourceCode rust"><code class="sourceCode rust"><span id="cb93-1"><a href="#cb93-1" aria-hidden="true" tabindex="-1"></a><span class="at">#[</span><span class="pp">ink::</span>contract<span class="at">]</span></span>
<span id="cb93-2"><a href="#cb93-2" aria-hidden="true" tabindex="-1"></a><span class="kw">mod</span> environment_aware <span class="op">{</span></span>
<span id="cb93-3"><a href="#cb93-3" aria-hidden="true" tabindex="-1"></a>    <span class="at">#[</span>ink<span class="at">(</span>storage<span class="at">)]</span></span>
<span id="cb93-4"><a href="#cb93-4" aria-hidden="true" tabindex="-1"></a>    <span class="kw">pub</span> <span class="kw">struct</span> EnvironmentAware <span class="op">{</span></span>
<span id="cb93-5"><a href="#cb93-5" aria-hidden="true" tabindex="-1"></a>        creation_time<span class="op">:</span> <span class="dt">u64</span><span class="op">,</span></span>
<span id="cb93-6"><a href="#cb93-6" aria-hidden="true" tabindex="-1"></a>        creator<span class="op">:</span> AccountId<span class="op">,</span></span>
<span id="cb93-7"><a href="#cb93-7" aria-hidden="true" tabindex="-1"></a>        call_count<span class="op">:</span> <span class="dt">u32</span><span class="op">,</span></span>
<span id="cb93-8"><a href="#cb93-8" aria-hidden="true" tabindex="-1"></a>        last_caller<span class="op">:</span> <span class="dt">Option</span><span class="op">&lt;</span>AccountId<span class="op">&gt;,</span></span>
<span id="cb93-9"><a href="#cb93-9" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb93-10"><a href="#cb93-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb93-11"><a href="#cb93-11" aria-hidden="true" tabindex="-1"></a>    <span class="kw">impl</span> EnvironmentAware <span class="op">{</span></span>
<span id="cb93-12"><a href="#cb93-12" aria-hidden="true" tabindex="-1"></a>        <span class="at">#[</span>ink<span class="at">(</span>constructor<span class="at">)]</span></span>
<span id="cb93-13"><a href="#cb93-13" aria-hidden="true" tabindex="-1"></a>        <span class="kw">pub</span> <span class="kw">fn</span> new() <span class="op">-&gt;</span> <span class="dt">Self</span> <span class="op">{</span></span>
<span id="cb93-14"><a href="#cb93-14" aria-hidden="true" tabindex="-1"></a>            <span class="dt">Self</span> <span class="op">{</span></span>
<span id="cb93-15"><a href="#cb93-15" aria-hidden="true" tabindex="-1"></a>                creation_time<span class="op">:</span> <span class="dt">Self</span><span class="pp">::</span>env()<span class="op">.</span>block_timestamp()<span class="op">,</span></span>
<span id="cb93-16"><a href="#cb93-16" aria-hidden="true" tabindex="-1"></a>                creator<span class="op">:</span> <span class="dt">Self</span><span class="pp">::</span>env()<span class="op">.</span>caller()<span class="op">,</span></span>
<span id="cb93-17"><a href="#cb93-17" aria-hidden="true" tabindex="-1"></a>                call_count<span class="op">:</span> <span class="dv">0</span><span class="op">,</span></span>
<span id="cb93-18"><a href="#cb93-18" aria-hidden="true" tabindex="-1"></a>                last_caller<span class="op">:</span> <span class="cn">None</span><span class="op">,</span></span>
<span id="cb93-19"><a href="#cb93-19" aria-hidden="true" tabindex="-1"></a>            <span class="op">}</span></span>
<span id="cb93-20"><a href="#cb93-20" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb93-21"><a href="#cb93-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb93-22"><a href="#cb93-22" aria-hidden="true" tabindex="-1"></a>        <span class="co">/// Demonstrate environmental information access</span></span>
<span id="cb93-23"><a href="#cb93-23" aria-hidden="true" tabindex="-1"></a>        <span class="at">#[</span>ink<span class="at">(</span>message<span class="at">)]</span></span>
<span id="cb93-24"><a href="#cb93-24" aria-hidden="true" tabindex="-1"></a>        <span class="kw">pub</span> <span class="kw">fn</span> environment_info(<span class="op">&amp;</span><span class="kw">mut</span> <span class="kw">self</span>) <span class="op">-&gt;</span> EnvironmentInfo <span class="op">{</span></span>
<span id="cb93-25"><a href="#cb93-25" aria-hidden="true" tabindex="-1"></a>            <span class="kw">self</span><span class="op">.</span>call_count <span class="op">+=</span> <span class="dv">1</span><span class="op">;</span></span>
<span id="cb93-26"><a href="#cb93-26" aria-hidden="true" tabindex="-1"></a>            <span class="kw">self</span><span class="op">.</span>last_caller <span class="op">=</span> <span class="cn">Some</span>(<span class="kw">self</span><span class="op">.</span>env()<span class="op">.</span>caller())<span class="op">;</span></span>
<span id="cb93-27"><a href="#cb93-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb93-28"><a href="#cb93-28" aria-hidden="true" tabindex="-1"></a>            EnvironmentInfo <span class="op">{</span></span>
<span id="cb93-29"><a href="#cb93-29" aria-hidden="true" tabindex="-1"></a>                <span class="co">// Transaction context</span></span>
<span id="cb93-30"><a href="#cb93-30" aria-hidden="true" tabindex="-1"></a>                caller<span class="op">:</span> <span class="kw">self</span><span class="op">.</span>env()<span class="op">.</span>caller()<span class="op">,</span></span>
<span id="cb93-31"><a href="#cb93-31" aria-hidden="true" tabindex="-1"></a>                contract_address<span class="op">:</span> <span class="kw">self</span><span class="op">.</span>env()<span class="op">.</span>account_id()<span class="op">,</span></span>
<span id="cb93-32"><a href="#cb93-32" aria-hidden="true" tabindex="-1"></a>                </span>
<span id="cb93-33"><a href="#cb93-33" aria-hidden="true" tabindex="-1"></a>                <span class="co">// Value information</span></span>
<span id="cb93-34"><a href="#cb93-34" aria-hidden="true" tabindex="-1"></a>                transferred_value<span class="op">:</span> <span class="kw">self</span><span class="op">.</span>env()<span class="op">.</span>transferred_value()<span class="op">,</span></span>
<span id="cb93-35"><a href="#cb93-35" aria-hidden="true" tabindex="-1"></a>                contract_balance<span class="op">:</span> <span class="kw">self</span><span class="op">.</span>env()<span class="op">.</span>balance()<span class="op">,</span></span>
<span id="cb93-36"><a href="#cb93-36" aria-hidden="true" tabindex="-1"></a>                </span>
<span id="cb93-37"><a href="#cb93-37" aria-hidden="true" tabindex="-1"></a>                <span class="co">// Block information</span></span>
<span id="cb93-38"><a href="#cb93-38" aria-hidden="true" tabindex="-1"></a>                block_number<span class="op">:</span> <span class="kw">self</span><span class="op">.</span>env()<span class="op">.</span>block_number()<span class="op">,</span></span>
<span id="cb93-39"><a href="#cb93-39" aria-hidden="true" tabindex="-1"></a>                block_timestamp<span class="op">:</span> <span class="kw">self</span><span class="op">.</span>env()<span class="op">.</span>block_timestamp()<span class="op">,</span></span>
<span id="cb93-40"><a href="#cb93-40" aria-hidden="true" tabindex="-1"></a>                </span>
<span id="cb93-41"><a href="#cb93-41" aria-hidden="true" tabindex="-1"></a>                <span class="co">// Contract information</span></span>
<span id="cb93-42"><a href="#cb93-42" aria-hidden="true" tabindex="-1"></a>                creation_time<span class="op">:</span> <span class="kw">self</span><span class="op">.</span>creation_time<span class="op">,</span></span>
<span id="cb93-43"><a href="#cb93-43" aria-hidden="true" tabindex="-1"></a>                creator<span class="op">:</span> <span class="kw">self</span><span class="op">.</span>creator<span class="op">,</span></span>
<span id="cb93-44"><a href="#cb93-44" aria-hidden="true" tabindex="-1"></a>                call_count<span class="op">:</span> <span class="kw">self</span><span class="op">.</span>call_count<span class="op">,</span></span>
<span id="cb93-45"><a href="#cb93-45" aria-hidden="true" tabindex="-1"></a>            <span class="op">}</span></span>
<span id="cb93-46"><a href="#cb93-46" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb93-47"><a href="#cb93-47" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb93-48"><a href="#cb93-48" aria-hidden="true" tabindex="-1"></a>        <span class="co">/// Time-locked function - only callable after certain time</span></span>
<span id="cb93-49"><a href="#cb93-49" aria-hidden="true" tabindex="-1"></a>        <span class="at">#[</span>ink<span class="at">(</span>message<span class="at">)]</span></span>
<span id="cb93-50"><a href="#cb93-50" aria-hidden="true" tabindex="-1"></a>        <span class="kw">pub</span> <span class="kw">fn</span> time_locked_function(<span class="op">&amp;</span><span class="kw">self</span>) <span class="op">-&gt;</span> <span class="dt">Result</span><span class="op">&lt;</span>()<span class="op">,</span> <span class="bu">Error</span><span class="op">&gt;</span> <span class="op">{</span></span>
<span id="cb93-51"><a href="#cb93-51" aria-hidden="true" tabindex="-1"></a>            <span class="kw">const</span> LOCK_DURATION<span class="op">:</span> <span class="dt">u64</span> <span class="op">=</span> <span class="dv">86400000</span><span class="op">;</span> <span class="co">// 24 hours in milliseconds</span></span>
<span id="cb93-52"><a href="#cb93-52" aria-hidden="true" tabindex="-1"></a>            <span class="kw">let</span> unlock_time <span class="op">=</span> <span class="kw">self</span><span class="op">.</span>creation_time <span class="op">+</span> LOCK_DURATION<span class="op">;</span></span>
<span id="cb93-53"><a href="#cb93-53" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb93-54"><a href="#cb93-54" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> <span class="kw">self</span><span class="op">.</span>env()<span class="op">.</span>block_timestamp() <span class="op">&lt;</span> unlock_time <span class="op">{</span></span>
<span id="cb93-55"><a href="#cb93-55" aria-hidden="true" tabindex="-1"></a>                <span class="cf">return</span> <span class="cn">Err</span>(<span class="bu">Error</span><span class="pp">::</span>TimeLocked)<span class="op">;</span></span>
<span id="cb93-56"><a href="#cb93-56" aria-hidden="true" tabindex="-1"></a>            <span class="op">}</span></span>
<span id="cb93-57"><a href="#cb93-57" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb93-58"><a href="#cb93-58" aria-hidden="true" tabindex="-1"></a>            <span class="co">// Function logic here</span></span>
<span id="cb93-59"><a href="#cb93-59" aria-hidden="true" tabindex="-1"></a>            <span class="cn">Ok</span>(())</span>
<span id="cb93-60"><a href="#cb93-60" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb93-61"><a href="#cb93-61" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb93-62"><a href="#cb93-62" aria-hidden="true" tabindex="-1"></a>        <span class="co">/// Access control based on caller</span></span>
<span id="cb93-63"><a href="#cb93-63" aria-hidden="true" tabindex="-1"></a>        <span class="at">#[</span>ink<span class="at">(</span>message<span class="at">)]</span></span>
<span id="cb93-64"><a href="#cb93-64" aria-hidden="true" tabindex="-1"></a>        <span class="kw">pub</span> <span class="kw">fn</span> admin_function(<span class="op">&amp;</span><span class="kw">self</span>) <span class="op">-&gt;</span> <span class="dt">Result</span><span class="op">&lt;</span>()<span class="op">,</span> <span class="bu">Error</span><span class="op">&gt;</span> <span class="op">{</span></span>
<span id="cb93-65"><a href="#cb93-65" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> <span class="kw">self</span><span class="op">.</span>env()<span class="op">.</span>caller() <span class="op">!=</span> <span class="kw">self</span><span class="op">.</span>creator <span class="op">{</span></span>
<span id="cb93-66"><a href="#cb93-66" aria-hidden="true" tabindex="-1"></a>                <span class="cf">return</span> <span class="cn">Err</span>(<span class="bu">Error</span><span class="pp">::</span>Unauthorized)<span class="op">;</span></span>
<span id="cb93-67"><a href="#cb93-67" aria-hidden="true" tabindex="-1"></a>            <span class="op">}</span></span>
<span id="cb93-68"><a href="#cb93-68" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb93-69"><a href="#cb93-69" aria-hidden="true" tabindex="-1"></a>            <span class="co">// Admin logic here</span></span>
<span id="cb93-70"><a href="#cb93-70" aria-hidden="true" tabindex="-1"></a>            <span class="cn">Ok</span>(())</span>
<span id="cb93-71"><a href="#cb93-71" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb93-72"><a href="#cb93-72" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb93-73"><a href="#cb93-73" aria-hidden="true" tabindex="-1"></a>        <span class="co">/// Function that requires minimum payment</span></span>
<span id="cb93-74"><a href="#cb93-74" aria-hidden="true" tabindex="-1"></a>        <span class="at">#[</span>ink<span class="at">(</span>message<span class="op">,</span> payable<span class="at">)]</span></span>
<span id="cb93-75"><a href="#cb93-75" aria-hidden="true" tabindex="-1"></a>        <span class="kw">pub</span> <span class="kw">fn</span> paid_function(<span class="op">&amp;</span><span class="kw">self</span>) <span class="op">-&gt;</span> <span class="dt">Result</span><span class="op">&lt;</span>()<span class="op">,</span> <span class="bu">Error</span><span class="op">&gt;</span> <span class="op">{</span></span>
<span id="cb93-76"><a href="#cb93-76" aria-hidden="true" tabindex="-1"></a>            <span class="kw">const</span> MINIMUM_PAYMENT<span class="op">:</span> Balance <span class="op">=</span> <span class="dv">1_000_000_000_000</span><span class="op">;</span> <span class="co">// 0.001 token</span></span>
<span id="cb93-77"><a href="#cb93-77" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb93-78"><a href="#cb93-78" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> <span class="kw">self</span><span class="op">.</span>env()<span class="op">.</span>transferred_value() <span class="op">&lt;</span> MINIMUM_PAYMENT <span class="op">{</span></span>
<span id="cb93-79"><a href="#cb93-79" aria-hidden="true" tabindex="-1"></a>                <span class="cf">return</span> <span class="cn">Err</span>(<span class="bu">Error</span><span class="pp">::</span>InsufficientPayment)<span class="op">;</span></span>
<span id="cb93-80"><a href="#cb93-80" aria-hidden="true" tabindex="-1"></a>            <span class="op">}</span></span>
<span id="cb93-81"><a href="#cb93-81" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb93-82"><a href="#cb93-82" aria-hidden="true" tabindex="-1"></a>            <span class="co">// Paid function logic here</span></span>
<span id="cb93-83"><a href="#cb93-83" aria-hidden="true" tabindex="-1"></a>            <span class="cn">Ok</span>(())</span>
<span id="cb93-84"><a href="#cb93-84" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb93-85"><a href="#cb93-85" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb93-86"><a href="#cb93-86" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb93-87"><a href="#cb93-87" aria-hidden="true" tabindex="-1"></a>    <span class="at">#[</span>derive<span class="at">(</span><span class="pp">scale::</span>Encode<span class="op">,</span> <span class="pp">scale::</span>Decode<span class="at">)]</span></span>
<span id="cb93-88"><a href="#cb93-88" aria-hidden="true" tabindex="-1"></a>    <span class="at">#[</span>cfg_attr<span class="at">(</span>feature <span class="op">=</span> <span class="st">&quot;std&quot;</span><span class="op">,</span> derive<span class="at">(</span><span class="pp">scale_info::</span>TypeInfo<span class="at">))]</span></span>
<span id="cb93-89"><a href="#cb93-89" aria-hidden="true" tabindex="-1"></a>    <span class="kw">pub</span> <span class="kw">struct</span> EnvironmentInfo <span class="op">{</span></span>
<span id="cb93-90"><a href="#cb93-90" aria-hidden="true" tabindex="-1"></a>        <span class="kw">pub</span> caller<span class="op">:</span> AccountId<span class="op">,</span></span>
<span id="cb93-91"><a href="#cb93-91" aria-hidden="true" tabindex="-1"></a>        <span class="kw">pub</span> contract_address<span class="op">:</span> AccountId<span class="op">,</span></span>
<span id="cb93-92"><a href="#cb93-92" aria-hidden="true" tabindex="-1"></a>        <span class="kw">pub</span> transferred_value<span class="op">:</span> Balance<span class="op">,</span></span>
<span id="cb93-93"><a href="#cb93-93" aria-hidden="true" tabindex="-1"></a>        <span class="kw">pub</span> contract_balance<span class="op">:</span> Balance<span class="op">,</span></span>
<span id="cb93-94"><a href="#cb93-94" aria-hidden="true" tabindex="-1"></a>        <span class="kw">pub</span> block_number<span class="op">:</span> <span class="dt">u32</span><span class="op">,</span></span>
<span id="cb93-95"><a href="#cb93-95" aria-hidden="true" tabindex="-1"></a>        <span class="kw">pub</span> block_timestamp<span class="op">:</span> <span class="dt">u64</span><span class="op">,</span></span>
<span id="cb93-96"><a href="#cb93-96" aria-hidden="true" tabindex="-1"></a>        <span class="kw">pub</span> creation_time<span class="op">:</span> <span class="dt">u64</span><span class="op">,</span></span>
<span id="cb93-97"><a href="#cb93-97" aria-hidden="true" tabindex="-1"></a>        <span class="kw">pub</span> creator<span class="op">:</span> AccountId<span class="op">,</span></span>
<span id="cb93-98"><a href="#cb93-98" aria-hidden="true" tabindex="-1"></a>        <span class="kw">pub</span> call_count<span class="op">:</span> <span class="dt">u32</span><span class="op">,</span></span>
<span id="cb93-99"><a href="#cb93-99" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb93-100"><a href="#cb93-100" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<h3 id="advanced-environmental-patterns">Advanced Environmental
Patterns</h3>
<div class="sourceCode" id="cb94"><pre
class="sourceCode rust"><code class="sourceCode rust"><span id="cb94-1"><a href="#cb94-1" aria-hidden="true" tabindex="-1"></a><span class="kw">impl</span> EnvironmentAware <span class="op">{</span></span>
<span id="cb94-2"><a href="#cb94-2" aria-hidden="true" tabindex="-1"></a>    <span class="co">/// Rate limiting based on block timestamps</span></span>
<span id="cb94-3"><a href="#cb94-3" aria-hidden="true" tabindex="-1"></a>    <span class="at">#[</span>ink<span class="at">(</span>message<span class="at">)]</span></span>
<span id="cb94-4"><a href="#cb94-4" aria-hidden="true" tabindex="-1"></a>    <span class="kw">pub</span> <span class="kw">fn</span> rate_limited_function(<span class="op">&amp;</span><span class="kw">mut</span> <span class="kw">self</span>) <span class="op">-&gt;</span> <span class="dt">Result</span><span class="op">&lt;</span>()<span class="op">,</span> <span class="bu">Error</span><span class="op">&gt;</span> <span class="op">{</span></span>
<span id="cb94-5"><a href="#cb94-5" aria-hidden="true" tabindex="-1"></a>        <span class="kw">const</span> RATE_LIMIT_DURATION<span class="op">:</span> <span class="dt">u64</span> <span class="op">=</span> <span class="dv">60000</span><span class="op">;</span> <span class="co">// 1 minute in milliseconds</span></span>
<span id="cb94-6"><a href="#cb94-6" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb94-7"><a href="#cb94-7" aria-hidden="true" tabindex="-1"></a>        <span class="kw">let</span> caller <span class="op">=</span> <span class="kw">self</span><span class="op">.</span>env()<span class="op">.</span>caller()<span class="op">;</span></span>
<span id="cb94-8"><a href="#cb94-8" aria-hidden="true" tabindex="-1"></a>        <span class="kw">let</span> current_time <span class="op">=</span> <span class="kw">self</span><span class="op">.</span>env()<span class="op">.</span>block_timestamp()<span class="op">;</span></span>
<span id="cb94-9"><a href="#cb94-9" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb94-10"><a href="#cb94-10" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Check last call time for this caller</span></span>
<span id="cb94-11"><a href="#cb94-11" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="kw">let</span> <span class="cn">Some</span>(last_call_time) <span class="op">=</span> <span class="kw">self</span><span class="op">.</span>last_call_times<span class="op">.</span>get(caller) <span class="op">{</span></span>
<span id="cb94-12"><a href="#cb94-12" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> current_time <span class="op">-</span> last_call_time <span class="op">&lt;</span> RATE_LIMIT_DURATION <span class="op">{</span></span>
<span id="cb94-13"><a href="#cb94-13" aria-hidden="true" tabindex="-1"></a>                <span class="cf">return</span> <span class="cn">Err</span>(<span class="bu">Error</span><span class="pp">::</span>RateLimited)<span class="op">;</span></span>
<span id="cb94-14"><a href="#cb94-14" aria-hidden="true" tabindex="-1"></a>            <span class="op">}</span></span>
<span id="cb94-15"><a href="#cb94-15" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb94-16"><a href="#cb94-16" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb94-17"><a href="#cb94-17" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Update last call time</span></span>
<span id="cb94-18"><a href="#cb94-18" aria-hidden="true" tabindex="-1"></a>        <span class="kw">self</span><span class="op">.</span>last_call_times<span class="op">.</span>insert(caller<span class="op">,</span> <span class="op">&amp;</span>current_time)<span class="op">;</span></span>
<span id="cb94-19"><a href="#cb94-19" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb94-20"><a href="#cb94-20" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Function logic here</span></span>
<span id="cb94-21"><a href="#cb94-21" aria-hidden="true" tabindex="-1"></a>        <span class="cn">Ok</span>(())</span>
<span id="cb94-22"><a href="#cb94-22" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb94-23"><a href="#cb94-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb94-24"><a href="#cb94-24" aria-hidden="true" tabindex="-1"></a>    <span class="co">/// Block number based lottery</span></span>
<span id="cb94-25"><a href="#cb94-25" aria-hidden="true" tabindex="-1"></a>    <span class="at">#[</span>ink<span class="at">(</span>message<span class="at">)]</span></span>
<span id="cb94-26"><a href="#cb94-26" aria-hidden="true" tabindex="-1"></a>    <span class="kw">pub</span> <span class="kw">fn</span> block_lottery(<span class="op">&amp;</span><span class="kw">self</span>) <span class="op">-&gt;</span> <span class="dt">bool</span> <span class="op">{</span></span>
<span id="cb94-27"><a href="#cb94-27" aria-hidden="true" tabindex="-1"></a>        <span class="kw">let</span> block_number <span class="op">=</span> <span class="kw">self</span><span class="op">.</span>env()<span class="op">.</span>block_number()<span class="op">;</span></span>
<span id="cb94-28"><a href="#cb94-28" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Simple lottery: win if block number is divisible by 10</span></span>
<span id="cb94-29"><a href="#cb94-29" aria-hidden="true" tabindex="-1"></a>        block_number <span class="op">%</span> <span class="dv">10</span> <span class="op">==</span> <span class="dv">0</span></span>
<span id="cb94-30"><a href="#cb94-30" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb94-31"><a href="#cb94-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb94-32"><a href="#cb94-32" aria-hidden="true" tabindex="-1"></a>    <span class="co">/// Contract balance management</span></span>
<span id="cb94-33"><a href="#cb94-33" aria-hidden="true" tabindex="-1"></a>    <span class="at">#[</span>ink<span class="at">(</span>message<span class="at">)]</span></span>
<span id="cb94-34"><a href="#cb94-34" aria-hidden="true" tabindex="-1"></a>    <span class="kw">pub</span> <span class="kw">fn</span> balance_check(<span class="op">&amp;</span><span class="kw">self</span>) <span class="op">-&gt;</span> BalanceStatus <span class="op">{</span></span>
<span id="cb94-35"><a href="#cb94-35" aria-hidden="true" tabindex="-1"></a>        <span class="kw">let</span> balance <span class="op">=</span> <span class="kw">self</span><span class="op">.</span>env()<span class="op">.</span>balance()<span class="op">;</span></span>
<span id="cb94-36"><a href="#cb94-36" aria-hidden="true" tabindex="-1"></a>        <span class="kw">const</span> LOW_BALANCE_THRESHOLD<span class="op">:</span> Balance <span class="op">=</span> <span class="dv">1_000_000_000_000</span><span class="op">;</span> <span class="co">// 0.001 token</span></span>
<span id="cb94-37"><a href="#cb94-37" aria-hidden="true" tabindex="-1"></a>        <span class="kw">const</span> CRITICAL_BALANCE_THRESHOLD<span class="op">:</span> Balance <span class="op">=</span> <span class="dv">100_000_000_000</span><span class="op">;</span> <span class="co">// 0.0001 token</span></span>
<span id="cb94-38"><a href="#cb94-38" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb94-39"><a href="#cb94-39" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> balance <span class="op">&lt;</span> CRITICAL_BALANCE_THRESHOLD <span class="op">{</span></span>
<span id="cb94-40"><a href="#cb94-40" aria-hidden="true" tabindex="-1"></a>            <span class="pp">BalanceStatus::</span>Critical</span>
<span id="cb94-41"><a href="#cb94-41" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span> <span class="cf">else</span> <span class="cf">if</span> balance <span class="op">&lt;</span> LOW_BALANCE_THRESHOLD <span class="op">{</span></span>
<span id="cb94-42"><a href="#cb94-42" aria-hidden="true" tabindex="-1"></a>            <span class="pp">BalanceStatus::</span>Low</span>
<span id="cb94-43"><a href="#cb94-43" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span> <span class="cf">else</span> <span class="op">{</span></span>
<span id="cb94-44"><a href="#cb94-44" aria-hidden="true" tabindex="-1"></a>            <span class="pp">BalanceStatus::</span>Healthy</span>
<span id="cb94-45"><a href="#cb94-45" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb94-46"><a href="#cb94-46" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb94-47"><a href="#cb94-47" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb94-48"><a href="#cb94-48" aria-hidden="true" tabindex="-1"></a>    <span class="co">/// Emergency functions based on contract state</span></span>
<span id="cb94-49"><a href="#cb94-49" aria-hidden="true" tabindex="-1"></a>    <span class="at">#[</span>ink<span class="at">(</span>message<span class="at">)]</span></span>
<span id="cb94-50"><a href="#cb94-50" aria-hidden="true" tabindex="-1"></a>    <span class="kw">pub</span> <span class="kw">fn</span> emergency_function(<span class="op">&amp;</span><span class="kw">mut</span> <span class="kw">self</span>) <span class="op">-&gt;</span> <span class="dt">Result</span><span class="op">&lt;</span>()<span class="op">,</span> <span class="bu">Error</span><span class="op">&gt;</span> <span class="op">{</span></span>
<span id="cb94-51"><a href="#cb94-51" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Only allow if contract balance is critically low</span></span>
<span id="cb94-52"><a href="#cb94-52" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="kw">self</span><span class="op">.</span>balance_check() <span class="op">!=</span> <span class="pp">BalanceStatus::</span>Critical <span class="op">{</span></span>
<span id="cb94-53"><a href="#cb94-53" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> <span class="cn">Err</span>(<span class="bu">Error</span><span class="pp">::</span>EmergencyConditionNotMet)<span class="op">;</span></span>
<span id="cb94-54"><a href="#cb94-54" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb94-55"><a href="#cb94-55" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb94-56"><a href="#cb94-56" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Emergency logic here</span></span>
<span id="cb94-57"><a href="#cb94-57" aria-hidden="true" tabindex="-1"></a>        <span class="cn">Ok</span>(())</span>
<span id="cb94-58"><a href="#cb94-58" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb94-59"><a href="#cb94-59" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<h3 id="gas-estimation-and-optimization">Gas Estimation and
Optimization</h3>
<div class="sourceCode" id="cb95"><pre
class="sourceCode rust"><code class="sourceCode rust"><span id="cb95-1"><a href="#cb95-1" aria-hidden="true" tabindex="-1"></a><span class="kw">impl</span> EnvironmentAware <span class="op">{</span></span>
<span id="cb95-2"><a href="#cb95-2" aria-hidden="true" tabindex="-1"></a>    <span class="co">/// Gas-aware batch processing</span></span>
<span id="cb95-3"><a href="#cb95-3" aria-hidden="true" tabindex="-1"></a>    <span class="at">#[</span>ink<span class="at">(</span>message<span class="at">)]</span></span>
<span id="cb95-4"><a href="#cb95-4" aria-hidden="true" tabindex="-1"></a>    <span class="kw">pub</span> <span class="kw">fn</span> gas_aware_batch_process(<span class="op">&amp;</span><span class="kw">mut</span> <span class="kw">self</span><span class="op">,</span> items<span class="op">:</span> <span class="dt">Vec</span><span class="op">&lt;</span><span class="dt">u32</span><span class="op">&gt;</span>) <span class="op">-&gt;</span> <span class="dt">Result</span><span class="op">&lt;</span><span class="dt">u32</span><span class="op">,</span> <span class="bu">Error</span><span class="op">&gt;</span> <span class="op">{</span></span>
<span id="cb95-5"><a href="#cb95-5" aria-hidden="true" tabindex="-1"></a>        <span class="kw">const</span> GAS_LIMIT_PER_ITEM<span class="op">:</span> <span class="dt">u64</span> <span class="op">=</span> <span class="dv">1000</span><span class="op">;</span> <span class="co">// Estimated gas per item</span></span>
<span id="cb95-6"><a href="#cb95-6" aria-hidden="true" tabindex="-1"></a>        <span class="kw">const</span> MAX_GAS_BUDGET<span class="op">:</span> <span class="dt">u64</span> <span class="op">=</span> <span class="dv">50000</span><span class="op">;</span>    <span class="co">// Maximum gas budget for this function</span></span>
<span id="cb95-7"><a href="#cb95-7" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb95-8"><a href="#cb95-8" aria-hidden="true" tabindex="-1"></a>        <span class="kw">let</span> max_items <span class="op">=</span> (MAX_GAS_BUDGET <span class="op">/</span> GAS_LIMIT_PER_ITEM) <span class="kw">as</span> <span class="dt">usize</span><span class="op">;</span></span>
<span id="cb95-9"><a href="#cb95-9" aria-hidden="true" tabindex="-1"></a>        <span class="kw">let</span> items_to_process <span class="op">=</span> items<span class="op">.</span>len()<span class="op">.</span>min(max_items)<span class="op">;</span></span>
<span id="cb95-10"><a href="#cb95-10" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb95-11"><a href="#cb95-11" aria-hidden="true" tabindex="-1"></a>        <span class="kw">let</span> <span class="kw">mut</span> processed <span class="op">=</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb95-12"><a href="#cb95-12" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> item <span class="kw">in</span> items<span class="op">.</span>iter()<span class="op">.</span>take(items_to_process) <span class="op">{</span></span>
<span id="cb95-13"><a href="#cb95-13" aria-hidden="true" tabindex="-1"></a>            <span class="co">// Process item</span></span>
<span id="cb95-14"><a href="#cb95-14" aria-hidden="true" tabindex="-1"></a>            <span class="kw">self</span><span class="op">.</span>process_item(<span class="op">*</span>item)<span class="op">?;</span></span>
<span id="cb95-15"><a href="#cb95-15" aria-hidden="true" tabindex="-1"></a>            processed <span class="op">+=</span> <span class="dv">1</span><span class="op">;</span></span>
<span id="cb95-16"><a href="#cb95-16" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb95-17"><a href="#cb95-17" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb95-18"><a href="#cb95-18" aria-hidden="true" tabindex="-1"></a>        <span class="cn">Ok</span>(processed)</span>
<span id="cb95-19"><a href="#cb95-19" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb95-20"><a href="#cb95-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb95-21"><a href="#cb95-21" aria-hidden="true" tabindex="-1"></a>    <span class="co">/// Weight-based function limits</span></span>
<span id="cb95-22"><a href="#cb95-22" aria-hidden="true" tabindex="-1"></a>    <span class="at">#[</span>ink<span class="at">(</span>message<span class="at">)]</span></span>
<span id="cb95-23"><a href="#cb95-23" aria-hidden="true" tabindex="-1"></a>    <span class="kw">pub</span> <span class="kw">fn</span> complex_calculation(<span class="op">&amp;</span><span class="kw">self</span><span class="op">,</span> complexity<span class="op">:</span> <span class="dt">u32</span>) <span class="op">-&gt;</span> <span class="dt">Result</span><span class="op">&lt;</span><span class="dt">u64</span><span class="op">,</span> <span class="bu">Error</span><span class="op">&gt;</span> <span class="op">{</span></span>
<span id="cb95-24"><a href="#cb95-24" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Limit complexity to prevent gas issues</span></span>
<span id="cb95-25"><a href="#cb95-25" aria-hidden="true" tabindex="-1"></a>        <span class="kw">const</span> MAX_COMPLEXITY<span class="op">:</span> <span class="dt">u32</span> <span class="op">=</span> <span class="dv">1000</span><span class="op">;</span></span>
<span id="cb95-26"><a href="#cb95-26" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> complexity <span class="op">&gt;</span> MAX_COMPLEXITY <span class="op">{</span></span>
<span id="cb95-27"><a href="#cb95-27" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> <span class="cn">Err</span>(<span class="bu">Error</span><span class="pp">::</span>ComplexityTooHigh)<span class="op">;</span></span>
<span id="cb95-28"><a href="#cb95-28" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb95-29"><a href="#cb95-29" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb95-30"><a href="#cb95-30" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Perform calculation with known gas costs</span></span>
<span id="cb95-31"><a href="#cb95-31" aria-hidden="true" tabindex="-1"></a>        <span class="kw">let</span> <span class="kw">mut</span> result <span class="op">=</span> <span class="dv">0u64</span><span class="op">;</span></span>
<span id="cb95-32"><a href="#cb95-32" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> i <span class="kw">in</span> <span class="dv">0</span><span class="op">..</span>complexity <span class="op">{</span></span>
<span id="cb95-33"><a href="#cb95-33" aria-hidden="true" tabindex="-1"></a>            result <span class="op">=</span> result<span class="op">.</span>wrapping_add(i <span class="kw">as</span> <span class="dt">u64</span> <span class="op">*</span> <span class="dv">12345</span>)<span class="op">;</span></span>
<span id="cb95-34"><a href="#cb95-34" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb95-35"><a href="#cb95-35" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb95-36"><a href="#cb95-36" aria-hidden="true" tabindex="-1"></a>        <span class="cn">Ok</span>(result)</span>
<span id="cb95-37"><a href="#cb95-37" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb95-38"><a href="#cb95-38" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<h2 id="message-testing-patterns">Message Testing Patterns</h2>
<p>Comprehensive testing ensures your message handlers work correctly
under all conditions:</p>
<div class="sourceCode" id="cb96"><pre
class="sourceCode rust"><code class="sourceCode rust"><span id="cb96-1"><a href="#cb96-1" aria-hidden="true" tabindex="-1"></a><span class="at">#[</span>cfg<span class="at">(</span>test<span class="at">)]</span></span>
<span id="cb96-2"><a href="#cb96-2" aria-hidden="true" tabindex="-1"></a><span class="kw">mod</span> tests <span class="op">{</span></span>
<span id="cb96-3"><a href="#cb96-3" aria-hidden="true" tabindex="-1"></a>    <span class="kw">use</span> <span class="kw">super</span><span class="pp">::</span><span class="op">*;</span></span>
<span id="cb96-4"><a href="#cb96-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb96-5"><a href="#cb96-5" aria-hidden="true" tabindex="-1"></a>    <span class="at">#[</span><span class="pp">ink::</span>test<span class="at">]</span></span>
<span id="cb96-6"><a href="#cb96-6" aria-hidden="true" tabindex="-1"></a>    <span class="kw">fn</span> constructor_validation_works() <span class="op">{</span></span>
<span id="cb96-7"><a href="#cb96-7" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Test valid constructor</span></span>
<span id="cb96-8"><a href="#cb96-8" aria-hidden="true" tabindex="-1"></a>        <span class="kw">let</span> token <span class="op">=</span> <span class="pp">FlexibleToken::</span>new(</span>
<span id="cb96-9"><a href="#cb96-9" aria-hidden="true" tabindex="-1"></a>            <span class="dv">1_000_000</span><span class="op">,</span></span>
<span id="cb96-10"><a href="#cb96-10" aria-hidden="true" tabindex="-1"></a>            <span class="st">&quot;TestToken&quot;</span><span class="op">.</span>to_string()<span class="op">,</span></span>
<span id="cb96-11"><a href="#cb96-11" aria-hidden="true" tabindex="-1"></a>            <span class="st">&quot;TEST&quot;</span><span class="op">.</span>to_string()<span class="op">,</span></span>
<span id="cb96-12"><a href="#cb96-12" aria-hidden="true" tabindex="-1"></a>            <span class="dv">18</span><span class="op">,</span></span>
<span id="cb96-13"><a href="#cb96-13" aria-hidden="true" tabindex="-1"></a>        )<span class="op">;</span></span>
<span id="cb96-14"><a href="#cb96-14" aria-hidden="true" tabindex="-1"></a>        <span class="pp">assert!</span>(token<span class="op">.</span>is_ok())<span class="op">;</span></span>
<span id="cb96-15"><a href="#cb96-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb96-16"><a href="#cb96-16" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Test invalid parameters</span></span>
<span id="cb96-17"><a href="#cb96-17" aria-hidden="true" tabindex="-1"></a>        <span class="kw">let</span> invalid_token <span class="op">=</span> <span class="pp">FlexibleToken::</span>new(</span>
<span id="cb96-18"><a href="#cb96-18" aria-hidden="true" tabindex="-1"></a>            <span class="dv">0</span><span class="op">,</span> <span class="co">// Invalid total supply</span></span>
<span id="cb96-19"><a href="#cb96-19" aria-hidden="true" tabindex="-1"></a>            <span class="st">&quot;TestToken&quot;</span><span class="op">.</span>to_string()<span class="op">,</span></span>
<span id="cb96-20"><a href="#cb96-20" aria-hidden="true" tabindex="-1"></a>            <span class="st">&quot;TEST&quot;</span><span class="op">.</span>to_string()<span class="op">,</span></span>
<span id="cb96-21"><a href="#cb96-21" aria-hidden="true" tabindex="-1"></a>            <span class="dv">18</span><span class="op">,</span></span>
<span id="cb96-22"><a href="#cb96-22" aria-hidden="true" tabindex="-1"></a>        )<span class="op">;</span></span>
<span id="cb96-23"><a href="#cb96-23" aria-hidden="true" tabindex="-1"></a>        <span class="pp">assert_eq!</span>(invalid_token<span class="op">,</span> <span class="cn">Err</span>(<span class="bu">Error</span><span class="pp">::</span>InvalidParameters))<span class="op">;</span></span>
<span id="cb96-24"><a href="#cb96-24" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb96-25"><a href="#cb96-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb96-26"><a href="#cb96-26" aria-hidden="true" tabindex="-1"></a>    <span class="at">#[</span><span class="pp">ink::</span>test<span class="at">]</span></span>
<span id="cb96-27"><a href="#cb96-27" aria-hidden="true" tabindex="-1"></a>    <span class="kw">fn</span> transfer_works() <span class="op">{</span></span>
<span id="cb96-28"><a href="#cb96-28" aria-hidden="true" tabindex="-1"></a>        <span class="kw">let</span> <span class="kw">mut</span> token <span class="op">=</span> <span class="pp">FlexibleToken::</span>new_simple(<span class="dv">1000</span>)<span class="op">.</span>unwrap()<span class="op">;</span></span>
<span id="cb96-29"><a href="#cb96-29" aria-hidden="true" tabindex="-1"></a>        <span class="kw">let</span> alice <span class="op">=</span> <span class="pp">AccountId::</span>from([<span class="dv">1</span><span class="op">;</span> <span class="dv">32</span>])<span class="op">;</span></span>
<span id="cb96-30"><a href="#cb96-30" aria-hidden="true" tabindex="-1"></a>        <span class="kw">let</span> bob <span class="op">=</span> <span class="pp">AccountId::</span>from([<span class="dv">2</span><span class="op">;</span> <span class="dv">32</span>])<span class="op">;</span></span>
<span id="cb96-31"><a href="#cb96-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb96-32"><a href="#cb96-32" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Initial balance check</span></span>
<span id="cb96-33"><a href="#cb96-33" aria-hidden="true" tabindex="-1"></a>        <span class="pp">assert_eq!</span>(token<span class="op">.</span>balance_of(alice)<span class="op">,</span> <span class="dv">1000</span>)<span class="op">;</span></span>
<span id="cb96-34"><a href="#cb96-34" aria-hidden="true" tabindex="-1"></a>        <span class="pp">assert_eq!</span>(token<span class="op">.</span>balance_of(bob)<span class="op">,</span> <span class="dv">0</span>)<span class="op">;</span></span>
<span id="cb96-35"><a href="#cb96-35" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb96-36"><a href="#cb96-36" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Test transfer</span></span>
<span id="cb96-37"><a href="#cb96-37" aria-hidden="true" tabindex="-1"></a>        <span class="kw">let</span> result <span class="op">=</span> token<span class="op">.</span>transfer(bob<span class="op">,</span> <span class="dv">100</span>)<span class="op">;</span></span>
<span id="cb96-38"><a href="#cb96-38" aria-hidden="true" tabindex="-1"></a>        <span class="pp">assert!</span>(result<span class="op">.</span>is_ok())<span class="op">;</span></span>
<span id="cb96-39"><a href="#cb96-39" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb96-40"><a href="#cb96-40" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Verify balances</span></span>
<span id="cb96-41"><a href="#cb96-41" aria-hidden="true" tabindex="-1"></a>        <span class="pp">assert_eq!</span>(token<span class="op">.</span>balance_of(alice)<span class="op">,</span> <span class="dv">900</span>)<span class="op">;</span></span>
<span id="cb96-42"><a href="#cb96-42" aria-hidden="true" tabindex="-1"></a>        <span class="pp">assert_eq!</span>(token<span class="op">.</span>balance_of(bob)<span class="op">,</span> <span class="dv">100</span>)<span class="op">;</span></span>
<span id="cb96-43"><a href="#cb96-43" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb96-44"><a href="#cb96-44" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb96-45"><a href="#cb96-45" aria-hidden="true" tabindex="-1"></a>    <span class="at">#[</span><span class="pp">ink::</span>test<span class="at">]</span></span>
<span id="cb96-46"><a href="#cb96-46" aria-hidden="true" tabindex="-1"></a>    <span class="kw">fn</span> payable_message_works() <span class="op">{</span></span>
<span id="cb96-47"><a href="#cb96-47" aria-hidden="true" tabindex="-1"></a>        <span class="kw">let</span> <span class="kw">mut</span> contract <span class="op">=</span> <span class="pp">PayableContract::</span>new()<span class="op">;</span></span>
<span id="cb96-48"><a href="#cb96-48" aria-hidden="true" tabindex="-1"></a>        <span class="kw">let</span> alice <span class="op">=</span> <span class="pp">AccountId::</span>from([<span class="dv">1</span><span class="op">;</span> <span class="dv">32</span>])<span class="op">;</span></span>
<span id="cb96-49"><a href="#cb96-49" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb96-50"><a href="#cb96-50" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Simulate payable call</span></span>
<span id="cb96-51"><a href="#cb96-51" aria-hidden="true" tabindex="-1"></a>        <span class="pp">ink::env::test::set_caller::</span><span class="op">&lt;</span><span class="pp">ink::env::</span>DefaultEnvironment<span class="op">&gt;</span>(alice)<span class="op">;</span></span>
<span id="cb96-52"><a href="#cb96-52" aria-hidden="true" tabindex="-1"></a>        <span class="pp">ink::env::test::set_value_transferred::</span><span class="op">&lt;</span><span class="pp">ink::env::</span>DefaultEnvironment<span class="op">&gt;</span>(<span class="dv">1000</span>)<span class="op">;</span></span>
<span id="cb96-53"><a href="#cb96-53" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb96-54"><a href="#cb96-54" aria-hidden="true" tabindex="-1"></a>        <span class="kw">let</span> result <span class="op">=</span> contract<span class="op">.</span>deposit()<span class="op">;</span></span>
<span id="cb96-55"><a href="#cb96-55" aria-hidden="true" tabindex="-1"></a>        <span class="pp">assert!</span>(result<span class="op">.</span>is_ok())<span class="op">;</span></span>
<span id="cb96-56"><a href="#cb96-56" aria-hidden="true" tabindex="-1"></a>        <span class="pp">assert_eq!</span>(contract<span class="op">.</span>deposit_of(alice)<span class="op">,</span> <span class="dv">1000</span>)<span class="op">;</span></span>
<span id="cb96-57"><a href="#cb96-57" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb96-58"><a href="#cb96-58" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb96-59"><a href="#cb96-59" aria-hidden="true" tabindex="-1"></a>    <span class="at">#[</span><span class="pp">ink::</span>test<span class="at">]</span></span>
<span id="cb96-60"><a href="#cb96-60" aria-hidden="true" tabindex="-1"></a>    <span class="kw">fn</span> environment_access_works() <span class="op">{</span></span>
<span id="cb96-61"><a href="#cb96-61" aria-hidden="true" tabindex="-1"></a>        <span class="kw">let</span> <span class="kw">mut</span> contract <span class="op">=</span> <span class="pp">EnvironmentAware::</span>new()<span class="op">;</span></span>
<span id="cb96-62"><a href="#cb96-62" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb96-63"><a href="#cb96-63" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Test environment info</span></span>
<span id="cb96-64"><a href="#cb96-64" aria-hidden="true" tabindex="-1"></a>        <span class="kw">let</span> info <span class="op">=</span> contract<span class="op">.</span>environment_info()<span class="op">;</span></span>
<span id="cb96-65"><a href="#cb96-65" aria-hidden="true" tabindex="-1"></a>        <span class="pp">assert!</span>(info<span class="op">.</span>block_timestamp <span class="op">&gt;</span> <span class="dv">0</span>)<span class="op">;</span></span>
<span id="cb96-66"><a href="#cb96-66" aria-hidden="true" tabindex="-1"></a>        <span class="pp">assert_eq!</span>(info<span class="op">.</span>call_count<span class="op">,</span> <span class="dv">1</span>)<span class="op">;</span></span>
<span id="cb96-67"><a href="#cb96-67" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb96-68"><a href="#cb96-68" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<h2 id="summary-3">Summary</h2>
<p>In this chapter, we’ve explored the logic layer that brings your
contracts to life:</p>
<p><strong>Constructor Patterns:</strong> 1. <strong>Multiple
Constructors</strong>: Providing flexibility for different
initialization scenarios 2. <strong>Comprehensive Validation</strong>:
Ensuring contracts deploy with valid state 3. <strong>Initialization
Strategies</strong>: From minimal to fully-configured deployment
options</p>
<p><strong>Message Design:</strong> 4. <strong>Clear API
Design</strong>: Distinguishing between read-only and state-changing
operations 5. <strong>Parameter Patterns</strong>: Designing intuitive
and safe message interfaces 6. <strong>Error Handling</strong>:
Providing comprehensive, actionable error information</p>
<p><strong>Payable Messages:</strong> 7. <strong>Native Token
Integration</strong>: Handling deposits, withdrawals, and payments 8.
<strong>Token Sale Patterns</strong>: Building sophisticated purchase
mechanisms 9. <strong>Financial Logic</strong>: Implementing safe
arithmetic and refund mechanisms</p>
<p><strong>Environmental Awareness:</strong> 10. <strong>Context
Access</strong>: Leveraging blockchain state for smart contract logic
11. <strong>Time-based Logic</strong>: Implementing locks, delays, and
scheduling 12. <strong>Gas Management</strong>: Writing gas-aware
functions that scale</p>
<p><strong>Testing Strategies:</strong> 13. <strong>Comprehensive
Coverage</strong>: Testing constructors, messages, and error conditions
14. <strong>Environment Simulation</strong>: Testing payable and
environment-dependent functions</p>
<p>With solid message and constructor design patterns established,
you’re ready to explore how contracts communicate with the outside world
and each other. In the next chapter, we’ll cover events for off-chain
communication and cross-contract calls for on-chain
interoperability.</p>
<hr />
<h1
id="chapter-5-interoperability-events-and-cross-contract-calls">Chapter
5: Interoperability: Events and Cross-Contract Calls</h1>
<p>Smart contracts don’t exist in isolation—they need to communicate
with off-chain applications and interact with other contracts to create
sophisticated decentralized systems. ink! provides two primary
mechanisms for this interoperability: events for off-chain communication
and cross-contract calls for on-chain composition.</p>
<p>In this chapter, we’ll explore how to design effective event systems
for user interfaces and monitoring, implement secure cross-contract
calling patterns, and build composable contract architectures that
leverage the strengths of multiple specialized contracts.</p>
<h2 id="events-communicating-with-the-outside-world">Events:
Communicating with the Outside World</h2>
<p>Events are the primary way smart contracts communicate with off-chain
applications. They provide a lightweight, indexable mechanism for
notifying external systems about contract state changes and important
occurrences.</p>
<h3 id="basic-event-definition-and-emission">Basic Event Definition and
Emission</h3>
<p>Events in ink! are defined as structs with the
<code>#[ink(event)]</code> attribute:</p>
<div class="sourceCode" id="cb97"><pre
class="sourceCode rust"><code class="sourceCode rust"><span id="cb97-1"><a href="#cb97-1" aria-hidden="true" tabindex="-1"></a><span class="at">#[</span><span class="pp">ink::</span>contract<span class="at">]</span></span>
<span id="cb97-2"><a href="#cb97-2" aria-hidden="true" tabindex="-1"></a><span class="kw">mod</span> event_contract <span class="op">{</span></span>
<span id="cb97-3"><a href="#cb97-3" aria-hidden="true" tabindex="-1"></a>    <span class="co">/// Transfer event emitted when tokens are moved between accounts</span></span>
<span id="cb97-4"><a href="#cb97-4" aria-hidden="true" tabindex="-1"></a>    <span class="at">#[</span>ink<span class="at">(</span>event<span class="at">)]</span></span>
<span id="cb97-5"><a href="#cb97-5" aria-hidden="true" tabindex="-1"></a>    <span class="kw">pub</span> <span class="kw">struct</span> Transfer <span class="op">{</span></span>
<span id="cb97-6"><a href="#cb97-6" aria-hidden="true" tabindex="-1"></a>        <span class="at">#[</span>ink<span class="at">(</span>topic<span class="at">)]</span></span>
<span id="cb97-7"><a href="#cb97-7" aria-hidden="true" tabindex="-1"></a>        from<span class="op">:</span> <span class="dt">Option</span><span class="op">&lt;</span>AccountId<span class="op">&gt;,</span></span>
<span id="cb97-8"><a href="#cb97-8" aria-hidden="true" tabindex="-1"></a>        <span class="at">#[</span>ink<span class="at">(</span>topic<span class="at">)]</span></span>
<span id="cb97-9"><a href="#cb97-9" aria-hidden="true" tabindex="-1"></a>        to<span class="op">:</span> <span class="dt">Option</span><span class="op">&lt;</span>AccountId<span class="op">&gt;,</span></span>
<span id="cb97-10"><a href="#cb97-10" aria-hidden="true" tabindex="-1"></a>        value<span class="op">:</span> Balance<span class="op">,</span></span>
<span id="cb97-11"><a href="#cb97-11" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb97-12"><a href="#cb97-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb97-13"><a href="#cb97-13" aria-hidden="true" tabindex="-1"></a>    <span class="co">/// Approval event for allowance changes</span></span>
<span id="cb97-14"><a href="#cb97-14" aria-hidden="true" tabindex="-1"></a>    <span class="at">#[</span>ink<span class="at">(</span>event<span class="at">)]</span></span>
<span id="cb97-15"><a href="#cb97-15" aria-hidden="true" tabindex="-1"></a>    <span class="kw">pub</span> <span class="kw">struct</span> Approval <span class="op">{</span></span>
<span id="cb97-16"><a href="#cb97-16" aria-hidden="true" tabindex="-1"></a>        <span class="at">#[</span>ink<span class="at">(</span>topic<span class="at">)]</span></span>
<span id="cb97-17"><a href="#cb97-17" aria-hidden="true" tabindex="-1"></a>        owner<span class="op">:</span> AccountId<span class="op">,</span></span>
<span id="cb97-18"><a href="#cb97-18" aria-hidden="true" tabindex="-1"></a>        <span class="at">#[</span>ink<span class="at">(</span>topic<span class="at">)]</span></span>
<span id="cb97-19"><a href="#cb97-19" aria-hidden="true" tabindex="-1"></a>        spender<span class="op">:</span> AccountId<span class="op">,</span></span>
<span id="cb97-20"><a href="#cb97-20" aria-hidden="true" tabindex="-1"></a>        value<span class="op">:</span> Balance<span class="op">,</span></span>
<span id="cb97-21"><a href="#cb97-21" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb97-22"><a href="#cb97-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb97-23"><a href="#cb97-23" aria-hidden="true" tabindex="-1"></a>    <span class="co">/// Custom business event</span></span>
<span id="cb97-24"><a href="#cb97-24" aria-hidden="true" tabindex="-1"></a>    <span class="at">#[</span>ink<span class="at">(</span>event<span class="at">)]</span></span>
<span id="cb97-25"><a href="#cb97-25" aria-hidden="true" tabindex="-1"></a>    <span class="kw">pub</span> <span class="kw">struct</span> PriceUpdate <span class="op">{</span></span>
<span id="cb97-26"><a href="#cb97-26" aria-hidden="true" tabindex="-1"></a>        <span class="at">#[</span>ink<span class="at">(</span>topic<span class="at">)]</span></span>
<span id="cb97-27"><a href="#cb97-27" aria-hidden="true" tabindex="-1"></a>        token<span class="op">:</span> AccountId<span class="op">,</span></span>
<span id="cb97-28"><a href="#cb97-28" aria-hidden="true" tabindex="-1"></a>        old_price<span class="op">:</span> Balance<span class="op">,</span></span>
<span id="cb97-29"><a href="#cb97-29" aria-hidden="true" tabindex="-1"></a>        new_price<span class="op">:</span> Balance<span class="op">,</span></span>
<span id="cb97-30"><a href="#cb97-30" aria-hidden="true" tabindex="-1"></a>        timestamp<span class="op">:</span> <span class="dt">u64</span><span class="op">,</span></span>
<span id="cb97-31"><a href="#cb97-31" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb97-32"><a href="#cb97-32" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb97-33"><a href="#cb97-33" aria-hidden="true" tabindex="-1"></a>    <span class="at">#[</span>ink<span class="at">(</span>storage<span class="at">)]</span></span>
<span id="cb97-34"><a href="#cb97-34" aria-hidden="true" tabindex="-1"></a>    <span class="kw">pub</span> <span class="kw">struct</span> EventContract <span class="op">{</span></span>
<span id="cb97-35"><a href="#cb97-35" aria-hidden="true" tabindex="-1"></a>        balances<span class="op">:</span> <span class="pp">ink::storage::</span>Mapping<span class="op">&lt;</span>AccountId<span class="op">,</span> Balance<span class="op">&gt;,</span></span>
<span id="cb97-36"><a href="#cb97-36" aria-hidden="true" tabindex="-1"></a>        allowances<span class="op">:</span> <span class="pp">ink::storage::</span>Mapping<span class="op">&lt;</span>(AccountId<span class="op">,</span> AccountId)<span class="op">,</span> Balance<span class="op">&gt;,</span></span>
<span id="cb97-37"><a href="#cb97-37" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb97-38"><a href="#cb97-38" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb97-39"><a href="#cb97-39" aria-hidden="true" tabindex="-1"></a>    <span class="kw">impl</span> EventContract <span class="op">{</span></span>
<span id="cb97-40"><a href="#cb97-40" aria-hidden="true" tabindex="-1"></a>        <span class="at">#[</span>ink<span class="at">(</span>constructor<span class="at">)]</span></span>
<span id="cb97-41"><a href="#cb97-41" aria-hidden="true" tabindex="-1"></a>        <span class="kw">pub</span> <span class="kw">fn</span> new() <span class="op">-&gt;</span> <span class="dt">Self</span> <span class="op">{</span></span>
<span id="cb97-42"><a href="#cb97-42" aria-hidden="true" tabindex="-1"></a>            <span class="dt">Self</span> <span class="op">{</span></span>
<span id="cb97-43"><a href="#cb97-43" aria-hidden="true" tabindex="-1"></a>                balances<span class="op">:</span> <span class="pp">ink::storage::Mapping::</span><span class="kw">default</span>()<span class="op">,</span></span>
<span id="cb97-44"><a href="#cb97-44" aria-hidden="true" tabindex="-1"></a>                allowances<span class="op">:</span> <span class="pp">ink::storage::Mapping::</span><span class="kw">default</span>()<span class="op">,</span></span>
<span id="cb97-45"><a href="#cb97-45" aria-hidden="true" tabindex="-1"></a>            <span class="op">}</span></span>
<span id="cb97-46"><a href="#cb97-46" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb97-47"><a href="#cb97-47" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb97-48"><a href="#cb97-48" aria-hidden="true" tabindex="-1"></a>        <span class="at">#[</span>ink<span class="at">(</span>message<span class="at">)]</span></span>
<span id="cb97-49"><a href="#cb97-49" aria-hidden="true" tabindex="-1"></a>        <span class="kw">pub</span> <span class="kw">fn</span> transfer(<span class="op">&amp;</span><span class="kw">mut</span> <span class="kw">self</span><span class="op">,</span> to<span class="op">:</span> AccountId<span class="op">,</span> value<span class="op">:</span> Balance) <span class="op">-&gt;</span> <span class="dt">Result</span><span class="op">&lt;</span>()<span class="op">,</span> <span class="bu">Error</span><span class="op">&gt;</span> <span class="op">{</span></span>
<span id="cb97-50"><a href="#cb97-50" aria-hidden="true" tabindex="-1"></a>            <span class="kw">let</span> caller <span class="op">=</span> <span class="kw">self</span><span class="op">.</span>env()<span class="op">.</span>caller()<span class="op">;</span></span>
<span id="cb97-51"><a href="#cb97-51" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb97-52"><a href="#cb97-52" aria-hidden="true" tabindex="-1"></a>            <span class="co">// Perform transfer logic (abbreviated)</span></span>
<span id="cb97-53"><a href="#cb97-53" aria-hidden="true" tabindex="-1"></a>            <span class="kw">let</span> from_balance <span class="op">=</span> <span class="kw">self</span><span class="op">.</span>balances<span class="op">.</span>get(caller)<span class="op">.</span>unwrap_or(<span class="dv">0</span>)<span class="op">;</span></span>
<span id="cb97-54"><a href="#cb97-54" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> from_balance <span class="op">&lt;</span> value <span class="op">{</span></span>
<span id="cb97-55"><a href="#cb97-55" aria-hidden="true" tabindex="-1"></a>                <span class="cf">return</span> <span class="cn">Err</span>(<span class="bu">Error</span><span class="pp">::</span>InsufficientBalance)<span class="op">;</span></span>
<span id="cb97-56"><a href="#cb97-56" aria-hidden="true" tabindex="-1"></a>            <span class="op">}</span></span>
<span id="cb97-57"><a href="#cb97-57" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb97-58"><a href="#cb97-58" aria-hidden="true" tabindex="-1"></a>            <span class="kw">let</span> to_balance <span class="op">=</span> <span class="kw">self</span><span class="op">.</span>balances<span class="op">.</span>get(to)<span class="op">.</span>unwrap_or(<span class="dv">0</span>)<span class="op">;</span></span>
<span id="cb97-59"><a href="#cb97-59" aria-hidden="true" tabindex="-1"></a>            <span class="kw">self</span><span class="op">.</span>balances<span class="op">.</span>insert(caller<span class="op">,</span> <span class="op">&amp;</span>(from_balance <span class="op">-</span> value))<span class="op">;</span></span>
<span id="cb97-60"><a href="#cb97-60" aria-hidden="true" tabindex="-1"></a>            <span class="kw">self</span><span class="op">.</span>balances<span class="op">.</span>insert(to<span class="op">,</span> <span class="op">&amp;</span>(to_balance <span class="op">+</span> value))<span class="op">;</span></span>
<span id="cb97-61"><a href="#cb97-61" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb97-62"><a href="#cb97-62" aria-hidden="true" tabindex="-1"></a>            <span class="co">// Emit transfer event</span></span>
<span id="cb97-63"><a href="#cb97-63" aria-hidden="true" tabindex="-1"></a>            <span class="kw">self</span><span class="op">.</span>env()<span class="op">.</span>emit_event(Transfer <span class="op">{</span></span>
<span id="cb97-64"><a href="#cb97-64" aria-hidden="true" tabindex="-1"></a>                from<span class="op">:</span> <span class="cn">Some</span>(caller)<span class="op">,</span></span>
<span id="cb97-65"><a href="#cb97-65" aria-hidden="true" tabindex="-1"></a>                to<span class="op">:</span> <span class="cn">Some</span>(to)<span class="op">,</span></span>
<span id="cb97-66"><a href="#cb97-66" aria-hidden="true" tabindex="-1"></a>                value<span class="op">,</span></span>
<span id="cb97-67"><a href="#cb97-67" aria-hidden="true" tabindex="-1"></a>            <span class="op">}</span>)<span class="op">;</span></span>
<span id="cb97-68"><a href="#cb97-68" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb97-69"><a href="#cb97-69" aria-hidden="true" tabindex="-1"></a>            <span class="cn">Ok</span>(())</span>
<span id="cb97-70"><a href="#cb97-70" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb97-71"><a href="#cb97-71" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb97-72"><a href="#cb97-72" aria-hidden="true" tabindex="-1"></a>        <span class="at">#[</span>ink<span class="at">(</span>message<span class="at">)]</span></span>
<span id="cb97-73"><a href="#cb97-73" aria-hidden="true" tabindex="-1"></a>        <span class="kw">pub</span> <span class="kw">fn</span> mint(<span class="op">&amp;</span><span class="kw">mut</span> <span class="kw">self</span><span class="op">,</span> to<span class="op">:</span> AccountId<span class="op">,</span> value<span class="op">:</span> Balance) <span class="op">-&gt;</span> <span class="dt">Result</span><span class="op">&lt;</span>()<span class="op">,</span> <span class="bu">Error</span><span class="op">&gt;</span> <span class="op">{</span></span>
<span id="cb97-74"><a href="#cb97-74" aria-hidden="true" tabindex="-1"></a>            <span class="co">// Only owner can mint (authorization logic omitted)</span></span>
<span id="cb97-75"><a href="#cb97-75" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb97-76"><a href="#cb97-76" aria-hidden="true" tabindex="-1"></a>            <span class="kw">let</span> balance <span class="op">=</span> <span class="kw">self</span><span class="op">.</span>balances<span class="op">.</span>get(to)<span class="op">.</span>unwrap_or(<span class="dv">0</span>)<span class="op">;</span></span>
<span id="cb97-77"><a href="#cb97-77" aria-hidden="true" tabindex="-1"></a>            <span class="kw">self</span><span class="op">.</span>balances<span class="op">.</span>insert(to<span class="op">,</span> <span class="op">&amp;</span>(balance <span class="op">+</span> value))<span class="op">;</span></span>
<span id="cb97-78"><a href="#cb97-78" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb97-79"><a href="#cb97-79" aria-hidden="true" tabindex="-1"></a>            <span class="co">// Emit transfer event (minting is from None)</span></span>
<span id="cb97-80"><a href="#cb97-80" aria-hidden="true" tabindex="-1"></a>            <span class="kw">self</span><span class="op">.</span>env()<span class="op">.</span>emit_event(Transfer <span class="op">{</span></span>
<span id="cb97-81"><a href="#cb97-81" aria-hidden="true" tabindex="-1"></a>                from<span class="op">:</span> <span class="cn">None</span><span class="op">,</span> <span class="co">// None indicates minting</span></span>
<span id="cb97-82"><a href="#cb97-82" aria-hidden="true" tabindex="-1"></a>                to<span class="op">:</span> <span class="cn">Some</span>(to)<span class="op">,</span></span>
<span id="cb97-83"><a href="#cb97-83" aria-hidden="true" tabindex="-1"></a>                value<span class="op">,</span></span>
<span id="cb97-84"><a href="#cb97-84" aria-hidden="true" tabindex="-1"></a>            <span class="op">}</span>)<span class="op">;</span></span>
<span id="cb97-85"><a href="#cb97-85" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb97-86"><a href="#cb97-86" aria-hidden="true" tabindex="-1"></a>            <span class="cn">Ok</span>(())</span>
<span id="cb97-87"><a href="#cb97-87" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb97-88"><a href="#cb97-88" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb97-89"><a href="#cb97-89" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<h3 id="understanding-topics-efficient-event-filtering">Understanding
Topics: Efficient Event Filtering</h3>
<p>The <code>#[ink(topic)]</code> attribute makes event fields
indexable, enabling efficient filtering and searching:</p>
<div class="sourceCode" id="cb98"><pre
class="sourceCode rust"><code class="sourceCode rust"><span id="cb98-1"><a href="#cb98-1" aria-hidden="true" tabindex="-1"></a><span class="at">#[</span><span class="pp">ink::</span>contract<span class="at">]</span></span>
<span id="cb98-2"><a href="#cb98-2" aria-hidden="true" tabindex="-1"></a><span class="kw">mod</span> advanced_events <span class="op">{</span></span>
<span id="cb98-3"><a href="#cb98-3" aria-hidden="true" tabindex="-1"></a>    <span class="co">/// Event with multiple indexed topics for efficient filtering</span></span>
<span id="cb98-4"><a href="#cb98-4" aria-hidden="true" tabindex="-1"></a>    <span class="at">#[</span>ink<span class="at">(</span>event<span class="at">)]</span></span>
<span id="cb98-5"><a href="#cb98-5" aria-hidden="true" tabindex="-1"></a>    <span class="kw">pub</span> <span class="kw">struct</span> OrderCreated <span class="op">{</span></span>
<span id="cb98-6"><a href="#cb98-6" aria-hidden="true" tabindex="-1"></a>        <span class="at">#[</span>ink<span class="at">(</span>topic<span class="at">)]</span></span>
<span id="cb98-7"><a href="#cb98-7" aria-hidden="true" tabindex="-1"></a>        order_id<span class="op">:</span> <span class="dt">u64</span><span class="op">,</span></span>
<span id="cb98-8"><a href="#cb98-8" aria-hidden="true" tabindex="-1"></a>        <span class="at">#[</span>ink<span class="at">(</span>topic<span class="at">)]</span></span>
<span id="cb98-9"><a href="#cb98-9" aria-hidden="true" tabindex="-1"></a>        creator<span class="op">:</span> AccountId<span class="op">,</span></span>
<span id="cb98-10"><a href="#cb98-10" aria-hidden="true" tabindex="-1"></a>        <span class="at">#[</span>ink<span class="at">(</span>topic<span class="at">)]</span></span>
<span id="cb98-11"><a href="#cb98-11" aria-hidden="true" tabindex="-1"></a>        token_pair<span class="op">:</span> (AccountId<span class="op">,</span> AccountId)<span class="op">,</span> <span class="co">// Can index complex types</span></span>
<span id="cb98-12"><a href="#cb98-12" aria-hidden="true" tabindex="-1"></a>        amount<span class="op">:</span> Balance<span class="op">,</span></span>
<span id="cb98-13"><a href="#cb98-13" aria-hidden="true" tabindex="-1"></a>        price<span class="op">:</span> Balance<span class="op">,</span></span>
<span id="cb98-14"><a href="#cb98-14" aria-hidden="true" tabindex="-1"></a>        order_type<span class="op">:</span> OrderType<span class="op">,</span></span>
<span id="cb98-15"><a href="#cb98-15" aria-hidden="true" tabindex="-1"></a>        timestamp<span class="op">:</span> <span class="dt">u64</span><span class="op">,</span></span>
<span id="cb98-16"><a href="#cb98-16" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb98-17"><a href="#cb98-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb98-18"><a href="#cb98-18" aria-hidden="true" tabindex="-1"></a>    <span class="co">/// Event without topics (less efficient to filter but smaller size)</span></span>
<span id="cb98-19"><a href="#cb98-19" aria-hidden="true" tabindex="-1"></a>    <span class="at">#[</span>ink<span class="at">(</span>event<span class="at">)]</span></span>
<span id="cb98-20"><a href="#cb98-20" aria-hidden="true" tabindex="-1"></a>    <span class="kw">pub</span> <span class="kw">struct</span> SystemUpdate <span class="op">{</span></span>
<span id="cb98-21"><a href="#cb98-21" aria-hidden="true" tabindex="-1"></a>        message<span class="op">:</span> <span class="dt">Vec</span><span class="op">&lt;</span><span class="dt">u8</span><span class="op">&gt;,</span></span>
<span id="cb98-22"><a href="#cb98-22" aria-hidden="true" tabindex="-1"></a>        update_type<span class="op">:</span> UpdateType<span class="op">,</span></span>
<span id="cb98-23"><a href="#cb98-23" aria-hidden="true" tabindex="-1"></a>        data<span class="op">:</span> <span class="dt">Vec</span><span class="op">&lt;</span><span class="dt">u8</span><span class="op">&gt;,</span></span>
<span id="cb98-24"><a href="#cb98-24" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb98-25"><a href="#cb98-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb98-26"><a href="#cb98-26" aria-hidden="true" tabindex="-1"></a>    <span class="co">/// Event with selective topics for different use cases</span></span>
<span id="cb98-27"><a href="#cb98-27" aria-hidden="true" tabindex="-1"></a>    <span class="at">#[</span>ink<span class="at">(</span>event<span class="at">)]</span></span>
<span id="cb98-28"><a href="#cb98-28" aria-hidden="true" tabindex="-1"></a>    <span class="kw">pub</span> <span class="kw">struct</span> TradeExecuted <span class="op">{</span></span>
<span id="cb98-29"><a href="#cb98-29" aria-hidden="true" tabindex="-1"></a>        <span class="at">#[</span>ink<span class="at">(</span>topic<span class="at">)]</span></span>
<span id="cb98-30"><a href="#cb98-30" aria-hidden="true" tabindex="-1"></a>        order_id<span class="op">:</span> <span class="dt">u64</span><span class="op">,</span>        <span class="co">// Always indexed - primary identifier</span></span>
<span id="cb98-31"><a href="#cb98-31" aria-hidden="true" tabindex="-1"></a>        <span class="at">#[</span>ink<span class="at">(</span>topic<span class="at">)]</span></span>
<span id="cb98-32"><a href="#cb98-32" aria-hidden="true" tabindex="-1"></a>        buyer<span class="op">:</span> AccountId<span class="op">,</span>     <span class="co">// Indexed - user-specific filtering</span></span>
<span id="cb98-33"><a href="#cb98-33" aria-hidden="true" tabindex="-1"></a>        <span class="at">#[</span>ink<span class="at">(</span>topic<span class="at">)]</span></span>
<span id="cb98-34"><a href="#cb98-34" aria-hidden="true" tabindex="-1"></a>        seller<span class="op">:</span> AccountId<span class="op">,</span>    <span class="co">// Indexed - user-specific filtering</span></span>
<span id="cb98-35"><a href="#cb98-35" aria-hidden="true" tabindex="-1"></a>        token_sold<span class="op">:</span> AccountId<span class="op">,</span> <span class="co">// Not indexed - reduces event size</span></span>
<span id="cb98-36"><a href="#cb98-36" aria-hidden="true" tabindex="-1"></a>        token_bought<span class="op">:</span> AccountId<span class="op">,</span> <span class="co">// Not indexed</span></span>
<span id="cb98-37"><a href="#cb98-37" aria-hidden="true" tabindex="-1"></a>        amount_sold<span class="op">:</span> Balance<span class="op">,</span>  <span class="co">// Not indexed</span></span>
<span id="cb98-38"><a href="#cb98-38" aria-hidden="true" tabindex="-1"></a>        amount_bought<span class="op">:</span> Balance<span class="op">,</span> <span class="co">// Not indexed</span></span>
<span id="cb98-39"><a href="#cb98-39" aria-hidden="true" tabindex="-1"></a>        fee<span class="op">:</span> Balance<span class="op">,</span>         <span class="co">// Not indexed</span></span>
<span id="cb98-40"><a href="#cb98-40" aria-hidden="true" tabindex="-1"></a>        timestamp<span class="op">:</span> <span class="dt">u64</span><span class="op">,</span>       <span class="co">// Not indexed</span></span>
<span id="cb98-41"><a href="#cb98-41" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb98-42"><a href="#cb98-42" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb98-43"><a href="#cb98-43" aria-hidden="true" tabindex="-1"></a>    <span class="kw">impl</span> AdvancedEvents <span class="op">{</span></span>
<span id="cb98-44"><a href="#cb98-44" aria-hidden="true" tabindex="-1"></a>        <span class="at">#[</span>ink<span class="at">(</span>message<span class="at">)]</span></span>
<span id="cb98-45"><a href="#cb98-45" aria-hidden="true" tabindex="-1"></a>        <span class="kw">pub</span> <span class="kw">fn</span> create_order(</span>
<span id="cb98-46"><a href="#cb98-46" aria-hidden="true" tabindex="-1"></a>            <span class="op">&amp;</span><span class="kw">mut</span> <span class="kw">self</span><span class="op">,</span></span>
<span id="cb98-47"><a href="#cb98-47" aria-hidden="true" tabindex="-1"></a>            token_pair<span class="op">:</span> (AccountId<span class="op">,</span> AccountId)<span class="op">,</span></span>
<span id="cb98-48"><a href="#cb98-48" aria-hidden="true" tabindex="-1"></a>            amount<span class="op">:</span> Balance<span class="op">,</span></span>
<span id="cb98-49"><a href="#cb98-49" aria-hidden="true" tabindex="-1"></a>            price<span class="op">:</span> Balance<span class="op">,</span></span>
<span id="cb98-50"><a href="#cb98-50" aria-hidden="true" tabindex="-1"></a>            order_type<span class="op">:</span> OrderType<span class="op">,</span></span>
<span id="cb98-51"><a href="#cb98-51" aria-hidden="true" tabindex="-1"></a>        ) <span class="op">-&gt;</span> <span class="dt">Result</span><span class="op">&lt;</span><span class="dt">u64</span><span class="op">,</span> <span class="bu">Error</span><span class="op">&gt;</span> <span class="op">{</span></span>
<span id="cb98-52"><a href="#cb98-52" aria-hidden="true" tabindex="-1"></a>            <span class="kw">let</span> order_id <span class="op">=</span> <span class="kw">self</span><span class="op">.</span>next_order_id<span class="op">;</span></span>
<span id="cb98-53"><a href="#cb98-53" aria-hidden="true" tabindex="-1"></a>            <span class="kw">self</span><span class="op">.</span>next_order_id <span class="op">+=</span> <span class="dv">1</span><span class="op">;</span></span>
<span id="cb98-54"><a href="#cb98-54" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb98-55"><a href="#cb98-55" aria-hidden="true" tabindex="-1"></a>            <span class="kw">let</span> creator <span class="op">=</span> <span class="kw">self</span><span class="op">.</span>env()<span class="op">.</span>caller()<span class="op">;</span></span>
<span id="cb98-56"><a href="#cb98-56" aria-hidden="true" tabindex="-1"></a>            <span class="kw">let</span> timestamp <span class="op">=</span> <span class="kw">self</span><span class="op">.</span>env()<span class="op">.</span>block_timestamp()<span class="op">;</span></span>
<span id="cb98-57"><a href="#cb98-57" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb98-58"><a href="#cb98-58" aria-hidden="true" tabindex="-1"></a>            <span class="co">// Store order (storage operations omitted)</span></span>
<span id="cb98-59"><a href="#cb98-59" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb98-60"><a href="#cb98-60" aria-hidden="true" tabindex="-1"></a>            <span class="co">// Emit event with indexed topics</span></span>
<span id="cb98-61"><a href="#cb98-61" aria-hidden="true" tabindex="-1"></a>            <span class="kw">self</span><span class="op">.</span>env()<span class="op">.</span>emit_event(OrderCreated <span class="op">{</span></span>
<span id="cb98-62"><a href="#cb98-62" aria-hidden="true" tabindex="-1"></a>                order_id<span class="op">,</span>     <span class="co">// Indexed - can filter by specific order</span></span>
<span id="cb98-63"><a href="#cb98-63" aria-hidden="true" tabindex="-1"></a>                creator<span class="op">,</span>      <span class="co">// Indexed - can filter by creator</span></span>
<span id="cb98-64"><a href="#cb98-64" aria-hidden="true" tabindex="-1"></a>                token_pair<span class="op">,</span>   <span class="co">// Indexed - can filter by trading pair</span></span>
<span id="cb98-65"><a href="#cb98-65" aria-hidden="true" tabindex="-1"></a>                amount<span class="op">,</span>       <span class="co">// Not indexed - reduces gas cost</span></span>
<span id="cb98-66"><a href="#cb98-66" aria-hidden="true" tabindex="-1"></a>                price<span class="op">,</span>        <span class="co">// Not indexed</span></span>
<span id="cb98-67"><a href="#cb98-67" aria-hidden="true" tabindex="-1"></a>                order_type<span class="op">,</span>   <span class="co">// Not indexed</span></span>
<span id="cb98-68"><a href="#cb98-68" aria-hidden="true" tabindex="-1"></a>                timestamp<span class="op">,</span>    <span class="co">// Not indexed</span></span>
<span id="cb98-69"><a href="#cb98-69" aria-hidden="true" tabindex="-1"></a>            <span class="op">}</span>)<span class="op">;</span></span>
<span id="cb98-70"><a href="#cb98-70" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb98-71"><a href="#cb98-71" aria-hidden="true" tabindex="-1"></a>            <span class="cn">Ok</span>(order_id)</span>
<span id="cb98-72"><a href="#cb98-72" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb98-73"><a href="#cb98-73" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb98-74"><a href="#cb98-74" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<p><strong>Topic guidelines:</strong> - <strong>Index frequently
filtered fields</strong>: User addresses, IDs, status values -
<strong>Limit topic count</strong>: Each topic increases event size and
gas cost - <strong>Complex types as topics</strong>: Tuples and enums
work, but increase indexing overhead - <strong>Consider query
patterns</strong>: Index fields that UIs and services will filter by</p>
<h3 id="event-driven-architecture-patterns">Event-Driven Architecture
Patterns</h3>
<p>Design event systems that support rich off-chain applications:</p>
<div class="sourceCode" id="cb99"><pre
class="sourceCode rust"><code class="sourceCode rust"><span id="cb99-1"><a href="#cb99-1" aria-hidden="true" tabindex="-1"></a><span class="at">#[</span><span class="pp">ink::</span>contract<span class="at">]</span></span>
<span id="cb99-2"><a href="#cb99-2" aria-hidden="true" tabindex="-1"></a><span class="kw">mod</span> marketplace <span class="op">{</span></span>
<span id="cb99-3"><a href="#cb99-3" aria-hidden="true" tabindex="-1"></a>    <span class="co">/// Comprehensive event system for a marketplace</span></span>
<span id="cb99-4"><a href="#cb99-4" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb99-5"><a href="#cb99-5" aria-hidden="true" tabindex="-1"></a>    <span class="co">/// Item lifecycle events</span></span>
<span id="cb99-6"><a href="#cb99-6" aria-hidden="true" tabindex="-1"></a>    <span class="at">#[</span>ink<span class="at">(</span>event<span class="at">)]</span></span>
<span id="cb99-7"><a href="#cb99-7" aria-hidden="true" tabindex="-1"></a>    <span class="kw">pub</span> <span class="kw">struct</span> ItemListed <span class="op">{</span></span>
<span id="cb99-8"><a href="#cb99-8" aria-hidden="true" tabindex="-1"></a>        <span class="at">#[</span>ink<span class="at">(</span>topic<span class="at">)]</span></span>
<span id="cb99-9"><a href="#cb99-9" aria-hidden="true" tabindex="-1"></a>        item_id<span class="op">:</span> <span class="dt">u64</span><span class="op">,</span></span>
<span id="cb99-10"><a href="#cb99-10" aria-hidden="true" tabindex="-1"></a>        <span class="at">#[</span>ink<span class="at">(</span>topic<span class="at">)]</span></span>
<span id="cb99-11"><a href="#cb99-11" aria-hidden="true" tabindex="-1"></a>        seller<span class="op">:</span> AccountId<span class="op">,</span></span>
<span id="cb99-12"><a href="#cb99-12" aria-hidden="true" tabindex="-1"></a>        <span class="at">#[</span>ink<span class="at">(</span>topic<span class="at">)]</span></span>
<span id="cb99-13"><a href="#cb99-13" aria-hidden="true" tabindex="-1"></a>        category<span class="op">:</span> Category<span class="op">,</span></span>
<span id="cb99-14"><a href="#cb99-14" aria-hidden="true" tabindex="-1"></a>        price<span class="op">:</span> Balance<span class="op">,</span></span>
<span id="cb99-15"><a href="#cb99-15" aria-hidden="true" tabindex="-1"></a>        description<span class="op">:</span> <span class="dt">Vec</span><span class="op">&lt;</span><span class="dt">u8</span><span class="op">&gt;,</span></span>
<span id="cb99-16"><a href="#cb99-16" aria-hidden="true" tabindex="-1"></a>        timestamp<span class="op">:</span> <span class="dt">u64</span><span class="op">,</span></span>
<span id="cb99-17"><a href="#cb99-17" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb99-18"><a href="#cb99-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb99-19"><a href="#cb99-19" aria-hidden="true" tabindex="-1"></a>    <span class="at">#[</span>ink<span class="at">(</span>event<span class="at">)]</span></span>
<span id="cb99-20"><a href="#cb99-20" aria-hidden="true" tabindex="-1"></a>    <span class="kw">pub</span> <span class="kw">struct</span> ItemSold <span class="op">{</span></span>
<span id="cb99-21"><a href="#cb99-21" aria-hidden="true" tabindex="-1"></a>        <span class="at">#[</span>ink<span class="at">(</span>topic<span class="at">)]</span></span>
<span id="cb99-22"><a href="#cb99-22" aria-hidden="true" tabindex="-1"></a>        item_id<span class="op">:</span> <span class="dt">u64</span><span class="op">,</span></span>
<span id="cb99-23"><a href="#cb99-23" aria-hidden="true" tabindex="-1"></a>        <span class="at">#[</span>ink<span class="at">(</span>topic<span class="at">)]</span></span>
<span id="cb99-24"><a href="#cb99-24" aria-hidden="true" tabindex="-1"></a>        seller<span class="op">:</span> AccountId<span class="op">,</span></span>
<span id="cb99-25"><a href="#cb99-25" aria-hidden="true" tabindex="-1"></a>        <span class="at">#[</span>ink<span class="at">(</span>topic<span class="at">)]</span></span>
<span id="cb99-26"><a href="#cb99-26" aria-hidden="true" tabindex="-1"></a>        buyer<span class="op">:</span> AccountId<span class="op">,</span></span>
<span id="cb99-27"><a href="#cb99-27" aria-hidden="true" tabindex="-1"></a>        final_price<span class="op">:</span> Balance<span class="op">,</span></span>
<span id="cb99-28"><a href="#cb99-28" aria-hidden="true" tabindex="-1"></a>        timestamp<span class="op">:</span> <span class="dt">u64</span><span class="op">,</span></span>
<span id="cb99-29"><a href="#cb99-29" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb99-30"><a href="#cb99-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb99-31"><a href="#cb99-31" aria-hidden="true" tabindex="-1"></a>    <span class="at">#[</span>ink<span class="at">(</span>event<span class="at">)]</span></span>
<span id="cb99-32"><a href="#cb99-32" aria-hidden="true" tabindex="-1"></a>    <span class="kw">pub</span> <span class="kw">struct</span> ItemCancelled <span class="op">{</span></span>
<span id="cb99-33"><a href="#cb99-33" aria-hidden="true" tabindex="-1"></a>        <span class="at">#[</span>ink<span class="at">(</span>topic<span class="at">)]</span></span>
<span id="cb99-34"><a href="#cb99-34" aria-hidden="true" tabindex="-1"></a>        item_id<span class="op">:</span> <span class="dt">u64</span><span class="op">,</span></span>
<span id="cb99-35"><a href="#cb99-35" aria-hidden="true" tabindex="-1"></a>        <span class="at">#[</span>ink<span class="at">(</span>topic<span class="at">)]</span></span>
<span id="cb99-36"><a href="#cb99-36" aria-hidden="true" tabindex="-1"></a>        seller<span class="op">:</span> AccountId<span class="op">,</span></span>
<span id="cb99-37"><a href="#cb99-37" aria-hidden="true" tabindex="-1"></a>        timestamp<span class="op">:</span> <span class="dt">u64</span><span class="op">,</span></span>
<span id="cb99-38"><a href="#cb99-38" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb99-39"><a href="#cb99-39" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb99-40"><a href="#cb99-40" aria-hidden="true" tabindex="-1"></a>    <span class="co">/// Bid events for auction-style listings</span></span>
<span id="cb99-41"><a href="#cb99-41" aria-hidden="true" tabindex="-1"></a>    <span class="at">#[</span>ink<span class="at">(</span>event<span class="at">)]</span></span>
<span id="cb99-42"><a href="#cb99-42" aria-hidden="true" tabindex="-1"></a>    <span class="kw">pub</span> <span class="kw">struct</span> BidPlaced <span class="op">{</span></span>
<span id="cb99-43"><a href="#cb99-43" aria-hidden="true" tabindex="-1"></a>        <span class="at">#[</span>ink<span class="at">(</span>topic<span class="at">)]</span></span>
<span id="cb99-44"><a href="#cb99-44" aria-hidden="true" tabindex="-1"></a>        item_id<span class="op">:</span> <span class="dt">u64</span><span class="op">,</span></span>
<span id="cb99-45"><a href="#cb99-45" aria-hidden="true" tabindex="-1"></a>        <span class="at">#[</span>ink<span class="at">(</span>topic<span class="at">)]</span></span>
<span id="cb99-46"><a href="#cb99-46" aria-hidden="true" tabindex="-1"></a>        bidder<span class="op">:</span> AccountId<span class="op">,</span></span>
<span id="cb99-47"><a href="#cb99-47" aria-hidden="true" tabindex="-1"></a>        bid_amount<span class="op">:</span> Balance<span class="op">,</span></span>
<span id="cb99-48"><a href="#cb99-48" aria-hidden="true" tabindex="-1"></a>        previous_highest<span class="op">:</span> Balance<span class="op">,</span></span>
<span id="cb99-49"><a href="#cb99-49" aria-hidden="true" tabindex="-1"></a>        timestamp<span class="op">:</span> <span class="dt">u64</span><span class="op">,</span></span>
<span id="cb99-50"><a href="#cb99-50" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb99-51"><a href="#cb99-51" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb99-52"><a href="#cb99-52" aria-hidden="true" tabindex="-1"></a>    <span class="co">/// System events</span></span>
<span id="cb99-53"><a href="#cb99-53" aria-hidden="true" tabindex="-1"></a>    <span class="at">#[</span>ink<span class="at">(</span>event<span class="at">)]</span></span>
<span id="cb99-54"><a href="#cb99-54" aria-hidden="true" tabindex="-1"></a>    <span class="kw">pub</span> <span class="kw">struct</span> FeeUpdated <span class="op">{</span></span>
<span id="cb99-55"><a href="#cb99-55" aria-hidden="true" tabindex="-1"></a>        old_fee_percentage<span class="op">:</span> <span class="dt">u16</span><span class="op">,</span></span>
<span id="cb99-56"><a href="#cb99-56" aria-hidden="true" tabindex="-1"></a>        new_fee_percentage<span class="op">:</span> <span class="dt">u16</span><span class="op">,</span></span>
<span id="cb99-57"><a href="#cb99-57" aria-hidden="true" tabindex="-1"></a>        updated_by<span class="op">:</span> AccountId<span class="op">,</span></span>
<span id="cb99-58"><a href="#cb99-58" aria-hidden="true" tabindex="-1"></a>        timestamp<span class="op">:</span> <span class="dt">u64</span><span class="op">,</span></span>
<span id="cb99-59"><a href="#cb99-59" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb99-60"><a href="#cb99-60" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb99-61"><a href="#cb99-61" aria-hidden="true" tabindex="-1"></a>    <span class="at">#[</span>ink<span class="at">(</span>event<span class="at">)]</span></span>
<span id="cb99-62"><a href="#cb99-62" aria-hidden="true" tabindex="-1"></a>    <span class="kw">pub</span> <span class="kw">struct</span> UserVerified <span class="op">{</span></span>
<span id="cb99-63"><a href="#cb99-63" aria-hidden="true" tabindex="-1"></a>        <span class="at">#[</span>ink<span class="at">(</span>topic<span class="at">)]</span></span>
<span id="cb99-64"><a href="#cb99-64" aria-hidden="true" tabindex="-1"></a>        user<span class="op">:</span> AccountId<span class="op">,</span></span>
<span id="cb99-65"><a href="#cb99-65" aria-hidden="true" tabindex="-1"></a>        verification_level<span class="op">:</span> VerificationLevel<span class="op">,</span></span>
<span id="cb99-66"><a href="#cb99-66" aria-hidden="true" tabindex="-1"></a>        verified_by<span class="op">:</span> AccountId<span class="op">,</span></span>
<span id="cb99-67"><a href="#cb99-67" aria-hidden="true" tabindex="-1"></a>        timestamp<span class="op">:</span> <span class="dt">u64</span><span class="op">,</span></span>
<span id="cb99-68"><a href="#cb99-68" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb99-69"><a href="#cb99-69" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb99-70"><a href="#cb99-70" aria-hidden="true" tabindex="-1"></a>    <span class="kw">impl</span> Marketplace <span class="op">{</span></span>
<span id="cb99-71"><a href="#cb99-71" aria-hidden="true" tabindex="-1"></a>        <span class="at">#[</span>ink<span class="at">(</span>message<span class="at">)]</span></span>
<span id="cb99-72"><a href="#cb99-72" aria-hidden="true" tabindex="-1"></a>        <span class="kw">pub</span> <span class="kw">fn</span> list_item(</span>
<span id="cb99-73"><a href="#cb99-73" aria-hidden="true" tabindex="-1"></a>            <span class="op">&amp;</span><span class="kw">mut</span> <span class="kw">self</span><span class="op">,</span></span>
<span id="cb99-74"><a href="#cb99-74" aria-hidden="true" tabindex="-1"></a>            category<span class="op">:</span> Category<span class="op">,</span></span>
<span id="cb99-75"><a href="#cb99-75" aria-hidden="true" tabindex="-1"></a>            price<span class="op">:</span> Balance<span class="op">,</span></span>
<span id="cb99-76"><a href="#cb99-76" aria-hidden="true" tabindex="-1"></a>            description<span class="op">:</span> <span class="dt">Vec</span><span class="op">&lt;</span><span class="dt">u8</span><span class="op">&gt;,</span></span>
<span id="cb99-77"><a href="#cb99-77" aria-hidden="true" tabindex="-1"></a>        ) <span class="op">-&gt;</span> <span class="dt">Result</span><span class="op">&lt;</span><span class="dt">u64</span><span class="op">,</span> <span class="bu">Error</span><span class="op">&gt;</span> <span class="op">{</span></span>
<span id="cb99-78"><a href="#cb99-78" aria-hidden="true" tabindex="-1"></a>            <span class="kw">let</span> item_id <span class="op">=</span> <span class="kw">self</span><span class="op">.</span>next_item_id<span class="op">;</span></span>
<span id="cb99-79"><a href="#cb99-79" aria-hidden="true" tabindex="-1"></a>            <span class="kw">self</span><span class="op">.</span>next_item_id <span class="op">+=</span> <span class="dv">1</span><span class="op">;</span></span>
<span id="cb99-80"><a href="#cb99-80" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb99-81"><a href="#cb99-81" aria-hidden="true" tabindex="-1"></a>            <span class="kw">let</span> seller <span class="op">=</span> <span class="kw">self</span><span class="op">.</span>env()<span class="op">.</span>caller()<span class="op">;</span></span>
<span id="cb99-82"><a href="#cb99-82" aria-hidden="true" tabindex="-1"></a>            <span class="kw">let</span> timestamp <span class="op">=</span> <span class="kw">self</span><span class="op">.</span>env()<span class="op">.</span>block_timestamp()<span class="op">;</span></span>
<span id="cb99-83"><a href="#cb99-83" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb99-84"><a href="#cb99-84" aria-hidden="true" tabindex="-1"></a>            <span class="co">// Create and store item</span></span>
<span id="cb99-85"><a href="#cb99-85" aria-hidden="true" tabindex="-1"></a>            <span class="kw">let</span> item <span class="op">=</span> Item <span class="op">{</span></span>
<span id="cb99-86"><a href="#cb99-86" aria-hidden="true" tabindex="-1"></a>                id<span class="op">:</span> item_id<span class="op">,</span></span>
<span id="cb99-87"><a href="#cb99-87" aria-hidden="true" tabindex="-1"></a>                seller<span class="op">,</span></span>
<span id="cb99-88"><a href="#cb99-88" aria-hidden="true" tabindex="-1"></a>                category<span class="op">,</span></span>
<span id="cb99-89"><a href="#cb99-89" aria-hidden="true" tabindex="-1"></a>                price<span class="op">,</span></span>
<span id="cb99-90"><a href="#cb99-90" aria-hidden="true" tabindex="-1"></a>                description<span class="op">:</span> description<span class="op">.</span>clone()<span class="op">,</span></span>
<span id="cb99-91"><a href="#cb99-91" aria-hidden="true" tabindex="-1"></a>                status<span class="op">:</span> <span class="pp">ItemStatus::</span>Active<span class="op">,</span></span>
<span id="cb99-92"><a href="#cb99-92" aria-hidden="true" tabindex="-1"></a>                created_at<span class="op">:</span> timestamp<span class="op">,</span></span>
<span id="cb99-93"><a href="#cb99-93" aria-hidden="true" tabindex="-1"></a>            <span class="op">};</span></span>
<span id="cb99-94"><a href="#cb99-94" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb99-95"><a href="#cb99-95" aria-hidden="true" tabindex="-1"></a>            <span class="kw">self</span><span class="op">.</span>items<span class="op">.</span>insert(item_id<span class="op">,</span> <span class="op">&amp;</span>item)<span class="op">;</span></span>
<span id="cb99-96"><a href="#cb99-96" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb99-97"><a href="#cb99-97" aria-hidden="true" tabindex="-1"></a>            <span class="co">// Emit comprehensive event for off-chain indexing</span></span>
<span id="cb99-98"><a href="#cb99-98" aria-hidden="true" tabindex="-1"></a>            <span class="kw">self</span><span class="op">.</span>env()<span class="op">.</span>emit_event(ItemListed <span class="op">{</span></span>
<span id="cb99-99"><a href="#cb99-99" aria-hidden="true" tabindex="-1"></a>                item_id<span class="op">,</span></span>
<span id="cb99-100"><a href="#cb99-100" aria-hidden="true" tabindex="-1"></a>                seller<span class="op">,</span></span>
<span id="cb99-101"><a href="#cb99-101" aria-hidden="true" tabindex="-1"></a>                category<span class="op">,</span></span>
<span id="cb99-102"><a href="#cb99-102" aria-hidden="true" tabindex="-1"></a>                price<span class="op">,</span></span>
<span id="cb99-103"><a href="#cb99-103" aria-hidden="true" tabindex="-1"></a>                description<span class="op">,</span></span>
<span id="cb99-104"><a href="#cb99-104" aria-hidden="true" tabindex="-1"></a>                timestamp<span class="op">,</span></span>
<span id="cb99-105"><a href="#cb99-105" aria-hidden="true" tabindex="-1"></a>            <span class="op">}</span>)<span class="op">;</span></span>
<span id="cb99-106"><a href="#cb99-106" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb99-107"><a href="#cb99-107" aria-hidden="true" tabindex="-1"></a>            <span class="cn">Ok</span>(item_id)</span>
<span id="cb99-108"><a href="#cb99-108" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb99-109"><a href="#cb99-109" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb99-110"><a href="#cb99-110" aria-hidden="true" tabindex="-1"></a>        <span class="at">#[</span>ink<span class="at">(</span>message<span class="at">)]</span></span>
<span id="cb99-111"><a href="#cb99-111" aria-hidden="true" tabindex="-1"></a>        <span class="kw">pub</span> <span class="kw">fn</span> purchase_item(<span class="op">&amp;</span><span class="kw">mut</span> <span class="kw">self</span><span class="op">,</span> item_id<span class="op">:</span> <span class="dt">u64</span>) <span class="op">-&gt;</span> <span class="dt">Result</span><span class="op">&lt;</span>()<span class="op">,</span> <span class="bu">Error</span><span class="op">&gt;</span> <span class="op">{</span></span>
<span id="cb99-112"><a href="#cb99-112" aria-hidden="true" tabindex="-1"></a>            <span class="kw">let</span> buyer <span class="op">=</span> <span class="kw">self</span><span class="op">.</span>env()<span class="op">.</span>caller()<span class="op">;</span></span>
<span id="cb99-113"><a href="#cb99-113" aria-hidden="true" tabindex="-1"></a>            <span class="kw">let</span> timestamp <span class="op">=</span> <span class="kw">self</span><span class="op">.</span>env()<span class="op">.</span>block_timestamp()<span class="op">;</span></span>
<span id="cb99-114"><a href="#cb99-114" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb99-115"><a href="#cb99-115" aria-hidden="true" tabindex="-1"></a>            <span class="co">// Get and validate item</span></span>
<span id="cb99-116"><a href="#cb99-116" aria-hidden="true" tabindex="-1"></a>            <span class="kw">let</span> <span class="kw">mut</span> item <span class="op">=</span> <span class="kw">self</span><span class="op">.</span>items<span class="op">.</span>get(item_id)<span class="op">.</span>ok_or(<span class="bu">Error</span><span class="pp">::</span>ItemNotFound)<span class="op">?;</span></span>
<span id="cb99-117"><a href="#cb99-117" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb99-118"><a href="#cb99-118" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> item<span class="op">.</span>status <span class="op">!=</span> <span class="pp">ItemStatus::</span>Active <span class="op">{</span></span>
<span id="cb99-119"><a href="#cb99-119" aria-hidden="true" tabindex="-1"></a>                <span class="cf">return</span> <span class="cn">Err</span>(<span class="bu">Error</span><span class="pp">::</span>ItemNotAvailable)<span class="op">;</span></span>
<span id="cb99-120"><a href="#cb99-120" aria-hidden="true" tabindex="-1"></a>            <span class="op">}</span></span>
<span id="cb99-121"><a href="#cb99-121" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb99-122"><a href="#cb99-122" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> buyer <span class="op">==</span> item<span class="op">.</span>seller <span class="op">{</span></span>
<span id="cb99-123"><a href="#cb99-123" aria-hidden="true" tabindex="-1"></a>                <span class="cf">return</span> <span class="cn">Err</span>(<span class="bu">Error</span><span class="pp">::</span>CannotBuyOwnItem)<span class="op">;</span></span>
<span id="cb99-124"><a href="#cb99-124" aria-hidden="true" tabindex="-1"></a>            <span class="op">}</span></span>
<span id="cb99-125"><a href="#cb99-125" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb99-126"><a href="#cb99-126" aria-hidden="true" tabindex="-1"></a>            <span class="co">// Process payment (implementation omitted)</span></span>
<span id="cb99-127"><a href="#cb99-127" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb99-128"><a href="#cb99-128" aria-hidden="true" tabindex="-1"></a>            <span class="co">// Update item status</span></span>
<span id="cb99-129"><a href="#cb99-129" aria-hidden="true" tabindex="-1"></a>            item<span class="op">.</span>status <span class="op">=</span> <span class="pp">ItemStatus::</span>Sold<span class="op">;</span></span>
<span id="cb99-130"><a href="#cb99-130" aria-hidden="true" tabindex="-1"></a>            item<span class="op">.</span>sold_to <span class="op">=</span> <span class="cn">Some</span>(buyer)<span class="op">;</span></span>
<span id="cb99-131"><a href="#cb99-131" aria-hidden="true" tabindex="-1"></a>            item<span class="op">.</span>sold_at <span class="op">=</span> <span class="cn">Some</span>(timestamp)<span class="op">;</span></span>
<span id="cb99-132"><a href="#cb99-132" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb99-133"><a href="#cb99-133" aria-hidden="true" tabindex="-1"></a>            <span class="kw">self</span><span class="op">.</span>items<span class="op">.</span>insert(item_id<span class="op">,</span> <span class="op">&amp;</span>item)<span class="op">;</span></span>
<span id="cb99-134"><a href="#cb99-134" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb99-135"><a href="#cb99-135" aria-hidden="true" tabindex="-1"></a>            <span class="co">// Emit sale event</span></span>
<span id="cb99-136"><a href="#cb99-136" aria-hidden="true" tabindex="-1"></a>            <span class="kw">self</span><span class="op">.</span>env()<span class="op">.</span>emit_event(ItemSold <span class="op">{</span></span>
<span id="cb99-137"><a href="#cb99-137" aria-hidden="true" tabindex="-1"></a>                item_id<span class="op">,</span></span>
<span id="cb99-138"><a href="#cb99-138" aria-hidden="true" tabindex="-1"></a>                seller<span class="op">:</span> item<span class="op">.</span>seller<span class="op">,</span></span>
<span id="cb99-139"><a href="#cb99-139" aria-hidden="true" tabindex="-1"></a>                buyer<span class="op">,</span></span>
<span id="cb99-140"><a href="#cb99-140" aria-hidden="true" tabindex="-1"></a>                final_price<span class="op">:</span> item<span class="op">.</span>price<span class="op">,</span></span>
<span id="cb99-141"><a href="#cb99-141" aria-hidden="true" tabindex="-1"></a>                timestamp<span class="op">,</span></span>
<span id="cb99-142"><a href="#cb99-142" aria-hidden="true" tabindex="-1"></a>            <span class="op">}</span>)<span class="op">;</span></span>
<span id="cb99-143"><a href="#cb99-143" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb99-144"><a href="#cb99-144" aria-hidden="true" tabindex="-1"></a>            <span class="cn">Ok</span>(())</span>
<span id="cb99-145"><a href="#cb99-145" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb99-146"><a href="#cb99-146" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb99-147"><a href="#cb99-147" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<h3 id="event-data-optimization">Event Data Optimization</h3>
<p>Design events for efficient storage and transmission:</p>
<div class="sourceCode" id="cb100"><pre
class="sourceCode rust"><code class="sourceCode rust"><span id="cb100-1"><a href="#cb100-1" aria-hidden="true" tabindex="-1"></a><span class="at">#[</span><span class="pp">ink::</span>contract<span class="at">]</span></span>
<span id="cb100-2"><a href="#cb100-2" aria-hidden="true" tabindex="-1"></a><span class="kw">mod</span> optimized_events <span class="op">{</span></span>
<span id="cb100-3"><a href="#cb100-3" aria-hidden="true" tabindex="-1"></a>    <span class="co">/// Optimized event - only essential data</span></span>
<span id="cb100-4"><a href="#cb100-4" aria-hidden="true" tabindex="-1"></a>    <span class="at">#[</span>ink<span class="at">(</span>event<span class="at">)]</span></span>
<span id="cb100-5"><a href="#cb100-5" aria-hidden="true" tabindex="-1"></a>    <span class="kw">pub</span> <span class="kw">struct</span> TransferOptimized <span class="op">{</span></span>
<span id="cb100-6"><a href="#cb100-6" aria-hidden="true" tabindex="-1"></a>        <span class="at">#[</span>ink<span class="at">(</span>topic<span class="at">)]</span></span>
<span id="cb100-7"><a href="#cb100-7" aria-hidden="true" tabindex="-1"></a>        from<span class="op">:</span> AccountId<span class="op">,</span></span>
<span id="cb100-8"><a href="#cb100-8" aria-hidden="true" tabindex="-1"></a>        <span class="at">#[</span>ink<span class="at">(</span>topic<span class="at">)]</span></span>
<span id="cb100-9"><a href="#cb100-9" aria-hidden="true" tabindex="-1"></a>        to<span class="op">:</span> AccountId<span class="op">,</span></span>
<span id="cb100-10"><a href="#cb100-10" aria-hidden="true" tabindex="-1"></a>        amount<span class="op">:</span> Balance<span class="op">,</span> <span class="co">// u128 - fixed size</span></span>
<span id="cb100-11"><a href="#cb100-11" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb100-12"><a href="#cb100-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb100-13"><a href="#cb100-13" aria-hidden="true" tabindex="-1"></a>    <span class="co">/// Heavy event - includes extensive metadata</span></span>
<span id="cb100-14"><a href="#cb100-14" aria-hidden="true" tabindex="-1"></a>    <span class="at">#[</span>ink<span class="at">(</span>event<span class="at">)]</span></span>
<span id="cb100-15"><a href="#cb100-15" aria-hidden="true" tabindex="-1"></a>    <span class="kw">pub</span> <span class="kw">struct</span> TransferDetailed <span class="op">{</span></span>
<span id="cb100-16"><a href="#cb100-16" aria-hidden="true" tabindex="-1"></a>        <span class="at">#[</span>ink<span class="at">(</span>topic<span class="at">)]</span></span>
<span id="cb100-17"><a href="#cb100-17" aria-hidden="true" tabindex="-1"></a>        from<span class="op">:</span> AccountId<span class="op">,</span></span>
<span id="cb100-18"><a href="#cb100-18" aria-hidden="true" tabindex="-1"></a>        <span class="at">#[</span>ink<span class="at">(</span>topic<span class="at">)]</span></span>
<span id="cb100-19"><a href="#cb100-19" aria-hidden="true" tabindex="-1"></a>        to<span class="op">:</span> AccountId<span class="op">,</span></span>
<span id="cb100-20"><a href="#cb100-20" aria-hidden="true" tabindex="-1"></a>        amount<span class="op">:</span> Balance<span class="op">,</span></span>
<span id="cb100-21"><a href="#cb100-21" aria-hidden="true" tabindex="-1"></a>        fee<span class="op">:</span> Balance<span class="op">,</span></span>
<span id="cb100-22"><a href="#cb100-22" aria-hidden="true" tabindex="-1"></a>        exchange_rate<span class="op">:</span> <span class="dt">Option</span><span class="op">&lt;</span>Balance<span class="op">&gt;,</span></span>
<span id="cb100-23"><a href="#cb100-23" aria-hidden="true" tabindex="-1"></a>        memo<span class="op">:</span> <span class="dt">Vec</span><span class="op">&lt;</span><span class="dt">u8</span><span class="op">&gt;,</span>                    <span class="co">// Variable size - expensive</span></span>
<span id="cb100-24"><a href="#cb100-24" aria-hidden="true" tabindex="-1"></a>        transaction_metadata<span class="op">:</span> Metadata<span class="op">,</span>   <span class="co">// Complex struct - expensive</span></span>
<span id="cb100-25"><a href="#cb100-25" aria-hidden="true" tabindex="-1"></a>        timestamp<span class="op">:</span> <span class="dt">u64</span><span class="op">,</span></span>
<span id="cb100-26"><a href="#cb100-26" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb100-27"><a href="#cb100-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb100-28"><a href="#cb100-28" aria-hidden="true" tabindex="-1"></a>    <span class="co">/// Efficient pattern: Multiple focused events instead of one heavy event</span></span>
<span id="cb100-29"><a href="#cb100-29" aria-hidden="true" tabindex="-1"></a>    <span class="at">#[</span>ink<span class="at">(</span>event<span class="at">)]</span></span>
<span id="cb100-30"><a href="#cb100-30" aria-hidden="true" tabindex="-1"></a>    <span class="kw">pub</span> <span class="kw">struct</span> Transfer <span class="op">{</span></span>
<span id="cb100-31"><a href="#cb100-31" aria-hidden="true" tabindex="-1"></a>        <span class="at">#[</span>ink<span class="at">(</span>topic<span class="at">)]</span></span>
<span id="cb100-32"><a href="#cb100-32" aria-hidden="true" tabindex="-1"></a>        from<span class="op">:</span> AccountId<span class="op">,</span></span>
<span id="cb100-33"><a href="#cb100-33" aria-hidden="true" tabindex="-1"></a>        <span class="at">#[</span>ink<span class="at">(</span>topic<span class="at">)]</span></span>
<span id="cb100-34"><a href="#cb100-34" aria-hidden="true" tabindex="-1"></a>        to<span class="op">:</span> AccountId<span class="op">,</span></span>
<span id="cb100-35"><a href="#cb100-35" aria-hidden="true" tabindex="-1"></a>        amount<span class="op">:</span> Balance<span class="op">,</span></span>
<span id="cb100-36"><a href="#cb100-36" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb100-37"><a href="#cb100-37" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb100-38"><a href="#cb100-38" aria-hidden="true" tabindex="-1"></a>    <span class="at">#[</span>ink<span class="at">(</span>event<span class="at">)]</span></span>
<span id="cb100-39"><a href="#cb100-39" aria-hidden="true" tabindex="-1"></a>    <span class="kw">pub</span> <span class="kw">struct</span> TransferMetadata <span class="op">{</span></span>
<span id="cb100-40"><a href="#cb100-40" aria-hidden="true" tabindex="-1"></a>        <span class="at">#[</span>ink<span class="at">(</span>topic<span class="at">)]</span></span>
<span id="cb100-41"><a href="#cb100-41" aria-hidden="true" tabindex="-1"></a>        transaction_id<span class="op">:</span> <span class="dt">u64</span><span class="op">,</span> <span class="co">// Links to main transfer</span></span>
<span id="cb100-42"><a href="#cb100-42" aria-hidden="true" tabindex="-1"></a>        memo<span class="op">:</span> <span class="dt">Vec</span><span class="op">&lt;</span><span class="dt">u8</span><span class="op">&gt;,</span></span>
<span id="cb100-43"><a href="#cb100-43" aria-hidden="true" tabindex="-1"></a>        metadata<span class="op">:</span> Metadata<span class="op">,</span></span>
<span id="cb100-44"><a href="#cb100-44" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb100-45"><a href="#cb100-45" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb100-46"><a href="#cb100-46" aria-hidden="true" tabindex="-1"></a>    <span class="kw">impl</span> OptimizedEvents <span class="op">{</span></span>
<span id="cb100-47"><a href="#cb100-47" aria-hidden="true" tabindex="-1"></a>        <span class="at">#[</span>ink<span class="at">(</span>message<span class="at">)]</span></span>
<span id="cb100-48"><a href="#cb100-48" aria-hidden="true" tabindex="-1"></a>        <span class="kw">pub</span> <span class="kw">fn</span> transfer_with_metadata(</span>
<span id="cb100-49"><a href="#cb100-49" aria-hidden="true" tabindex="-1"></a>            <span class="op">&amp;</span><span class="kw">mut</span> <span class="kw">self</span><span class="op">,</span></span>
<span id="cb100-50"><a href="#cb100-50" aria-hidden="true" tabindex="-1"></a>            to<span class="op">:</span> AccountId<span class="op">,</span></span>
<span id="cb100-51"><a href="#cb100-51" aria-hidden="true" tabindex="-1"></a>            amount<span class="op">:</span> Balance<span class="op">,</span></span>
<span id="cb100-52"><a href="#cb100-52" aria-hidden="true" tabindex="-1"></a>            memo<span class="op">:</span> <span class="dt">Option</span><span class="op">&lt;</span><span class="dt">Vec</span><span class="op">&lt;</span><span class="dt">u8</span><span class="op">&gt;&gt;,</span></span>
<span id="cb100-53"><a href="#cb100-53" aria-hidden="true" tabindex="-1"></a>            metadata<span class="op">:</span> <span class="dt">Option</span><span class="op">&lt;</span>Metadata<span class="op">&gt;,</span></span>
<span id="cb100-54"><a href="#cb100-54" aria-hidden="true" tabindex="-1"></a>        ) <span class="op">-&gt;</span> <span class="dt">Result</span><span class="op">&lt;</span>()<span class="op">,</span> <span class="bu">Error</span><span class="op">&gt;</span> <span class="op">{</span></span>
<span id="cb100-55"><a href="#cb100-55" aria-hidden="true" tabindex="-1"></a>            <span class="kw">let</span> from <span class="op">=</span> <span class="kw">self</span><span class="op">.</span>env()<span class="op">.</span>caller()<span class="op">;</span></span>
<span id="cb100-56"><a href="#cb100-56" aria-hidden="true" tabindex="-1"></a>            <span class="kw">let</span> transaction_id <span class="op">=</span> <span class="kw">self</span><span class="op">.</span>get_next_transaction_id()<span class="op">;</span></span>
<span id="cb100-57"><a href="#cb100-57" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb100-58"><a href="#cb100-58" aria-hidden="true" tabindex="-1"></a>            <span class="co">// Perform transfer</span></span>
<span id="cb100-59"><a href="#cb100-59" aria-hidden="true" tabindex="-1"></a>            <span class="kw">self</span><span class="op">.</span>execute_transfer(from<span class="op">,</span> to<span class="op">,</span> amount)<span class="op">?;</span></span>
<span id="cb100-60"><a href="#cb100-60" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb100-61"><a href="#cb100-61" aria-hidden="true" tabindex="-1"></a>            <span class="co">// Always emit core transfer event</span></span>
<span id="cb100-62"><a href="#cb100-62" aria-hidden="true" tabindex="-1"></a>            <span class="kw">self</span><span class="op">.</span>env()<span class="op">.</span>emit_event(Transfer <span class="op">{</span> from<span class="op">,</span> to<span class="op">,</span> amount <span class="op">}</span>)<span class="op">;</span></span>
<span id="cb100-63"><a href="#cb100-63" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb100-64"><a href="#cb100-64" aria-hidden="true" tabindex="-1"></a>            <span class="co">// Conditionally emit metadata event only if needed</span></span>
<span id="cb100-65"><a href="#cb100-65" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> memo<span class="op">.</span>is_some() <span class="op">||</span> metadata<span class="op">.</span>is_some() <span class="op">{</span></span>
<span id="cb100-66"><a href="#cb100-66" aria-hidden="true" tabindex="-1"></a>                <span class="kw">self</span><span class="op">.</span>env()<span class="op">.</span>emit_event(TransferMetadata <span class="op">{</span></span>
<span id="cb100-67"><a href="#cb100-67" aria-hidden="true" tabindex="-1"></a>                    transaction_id<span class="op">,</span></span>
<span id="cb100-68"><a href="#cb100-68" aria-hidden="true" tabindex="-1"></a>                    memo<span class="op">:</span> memo<span class="op">.</span>unwrap_or_default()<span class="op">,</span></span>
<span id="cb100-69"><a href="#cb100-69" aria-hidden="true" tabindex="-1"></a>                    metadata<span class="op">:</span> metadata<span class="op">.</span>unwrap_or_default()<span class="op">,</span></span>
<span id="cb100-70"><a href="#cb100-70" aria-hidden="true" tabindex="-1"></a>                <span class="op">}</span>)<span class="op">;</span></span>
<span id="cb100-71"><a href="#cb100-71" aria-hidden="true" tabindex="-1"></a>            <span class="op">}</span></span>
<span id="cb100-72"><a href="#cb100-72" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb100-73"><a href="#cb100-73" aria-hidden="true" tabindex="-1"></a>            <span class="cn">Ok</span>(())</span>
<span id="cb100-74"><a href="#cb100-74" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb100-75"><a href="#cb100-75" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb100-76"><a href="#cb100-76" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<h2 id="cross-contract-calls-building-composable-systems">Cross-Contract
Calls: Building Composable Systems</h2>
<p>Cross-contract calls enable contracts to interact with each other,
creating composable systems where specialized contracts work together to
provide complex functionality.</p>
<h3 id="basic-cross-contract-call-pattern">Basic Cross-Contract Call
Pattern</h3>
<div class="sourceCode" id="cb101"><pre
class="sourceCode rust"><code class="sourceCode rust"><span id="cb101-1"><a href="#cb101-1" aria-hidden="true" tabindex="-1"></a><span class="co">// Define the interface for the contract we want to call</span></span>
<span id="cb101-2"><a href="#cb101-2" aria-hidden="true" tabindex="-1"></a><span class="at">#[</span><span class="pp">ink::</span>trait_definition<span class="at">]</span></span>
<span id="cb101-3"><a href="#cb101-3" aria-hidden="true" tabindex="-1"></a><span class="kw">pub</span> <span class="kw">trait</span> ERC20 <span class="op">{</span></span>
<span id="cb101-4"><a href="#cb101-4" aria-hidden="true" tabindex="-1"></a>    <span class="at">#[</span>ink<span class="at">(</span>message<span class="at">)]</span></span>
<span id="cb101-5"><a href="#cb101-5" aria-hidden="true" tabindex="-1"></a>    <span class="kw">fn</span> transfer(<span class="op">&amp;</span><span class="kw">mut</span> <span class="kw">self</span><span class="op">,</span> to<span class="op">:</span> AccountId<span class="op">,</span> value<span class="op">:</span> Balance) <span class="op">-&gt;</span> <span class="dt">Result</span><span class="op">&lt;</span>()<span class="op">,</span> <span class="bu">Error</span><span class="op">&gt;;</span></span>
<span id="cb101-6"><a href="#cb101-6" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb101-7"><a href="#cb101-7" aria-hidden="true" tabindex="-1"></a>    <span class="at">#[</span>ink<span class="at">(</span>message<span class="at">)]</span></span>
<span id="cb101-8"><a href="#cb101-8" aria-hidden="true" tabindex="-1"></a>    <span class="kw">fn</span> balance_of(<span class="op">&amp;</span><span class="kw">self</span><span class="op">,</span> owner<span class="op">:</span> AccountId) <span class="op">-&gt;</span> Balance<span class="op">;</span></span>
<span id="cb101-9"><a href="#cb101-9" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb101-10"><a href="#cb101-10" aria-hidden="true" tabindex="-1"></a>    <span class="at">#[</span>ink<span class="at">(</span>message<span class="at">)]</span></span>
<span id="cb101-11"><a href="#cb101-11" aria-hidden="true" tabindex="-1"></a>    <span class="kw">fn</span> total_supply(<span class="op">&amp;</span><span class="kw">self</span>) <span class="op">-&gt;</span> Balance<span class="op">;</span></span>
<span id="cb101-12"><a href="#cb101-12" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb101-13"><a href="#cb101-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb101-14"><a href="#cb101-14" aria-hidden="true" tabindex="-1"></a><span class="at">#[</span><span class="pp">ink::</span>contract<span class="at">]</span></span>
<span id="cb101-15"><a href="#cb101-15" aria-hidden="true" tabindex="-1"></a><span class="kw">mod</span> cross_contract_caller <span class="op">{</span></span>
<span id="cb101-16"><a href="#cb101-16" aria-hidden="true" tabindex="-1"></a>    <span class="kw">use</span> <span class="kw">super</span><span class="pp">::</span>ERC20<span class="op">;</span></span>
<span id="cb101-17"><a href="#cb101-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb101-18"><a href="#cb101-18" aria-hidden="true" tabindex="-1"></a>    <span class="at">#[</span>ink<span class="at">(</span>storage<span class="at">)]</span></span>
<span id="cb101-19"><a href="#cb101-19" aria-hidden="true" tabindex="-1"></a>    <span class="kw">pub</span> <span class="kw">struct</span> CrossContractCaller <span class="op">{</span></span>
<span id="cb101-20"><a href="#cb101-20" aria-hidden="true" tabindex="-1"></a>        erc20_contract<span class="op">:</span> AccountId<span class="op">,</span></span>
<span id="cb101-21"><a href="#cb101-21" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb101-22"><a href="#cb101-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb101-23"><a href="#cb101-23" aria-hidden="true" tabindex="-1"></a>    <span class="kw">impl</span> CrossContractCaller <span class="op">{</span></span>
<span id="cb101-24"><a href="#cb101-24" aria-hidden="true" tabindex="-1"></a>        <span class="at">#[</span>ink<span class="at">(</span>constructor<span class="at">)]</span></span>
<span id="cb101-25"><a href="#cb101-25" aria-hidden="true" tabindex="-1"></a>        <span class="kw">pub</span> <span class="kw">fn</span> new(erc20_contract<span class="op">:</span> AccountId) <span class="op">-&gt;</span> <span class="dt">Self</span> <span class="op">{</span></span>
<span id="cb101-26"><a href="#cb101-26" aria-hidden="true" tabindex="-1"></a>            <span class="dt">Self</span> <span class="op">{</span> erc20_contract <span class="op">}</span></span>
<span id="cb101-27"><a href="#cb101-27" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb101-28"><a href="#cb101-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb101-29"><a href="#cb101-29" aria-hidden="true" tabindex="-1"></a>        <span class="co">/// Call another contract&#39;s method</span></span>
<span id="cb101-30"><a href="#cb101-30" aria-hidden="true" tabindex="-1"></a>        <span class="at">#[</span>ink<span class="at">(</span>message<span class="at">)]</span></span>
<span id="cb101-31"><a href="#cb101-31" aria-hidden="true" tabindex="-1"></a>        <span class="kw">pub</span> <span class="kw">fn</span> get_token_balance(<span class="op">&amp;</span><span class="kw">self</span><span class="op">,</span> account<span class="op">:</span> AccountId) <span class="op">-&gt;</span> Balance <span class="op">{</span></span>
<span id="cb101-32"><a href="#cb101-32" aria-hidden="true" tabindex="-1"></a>            <span class="co">// Build cross-contract call</span></span>
<span id="cb101-33"><a href="#cb101-33" aria-hidden="true" tabindex="-1"></a>            <span class="kw">let</span> balance <span class="op">=</span> <span class="pp">ink::env::call::build_call::</span><span class="op">&lt;</span><span class="pp">ink::env::</span>DefaultEnvironment<span class="op">&gt;</span>()</span>
<span id="cb101-34"><a href="#cb101-34" aria-hidden="true" tabindex="-1"></a>                <span class="op">.</span>call(<span class="kw">self</span><span class="op">.</span>erc20_contract)</span>
<span id="cb101-35"><a href="#cb101-35" aria-hidden="true" tabindex="-1"></a>                <span class="op">.</span>gas_limit(<span class="dv">5000</span>)</span>
<span id="cb101-36"><a href="#cb101-36" aria-hidden="true" tabindex="-1"></a>                <span class="op">.</span>transferred_value(<span class="dv">0</span>)</span>
<span id="cb101-37"><a href="#cb101-37" aria-hidden="true" tabindex="-1"></a>                <span class="op">.</span>exec_input(</span>
<span id="cb101-38"><a href="#cb101-38" aria-hidden="true" tabindex="-1"></a>                    <span class="pp">ink::env::call::ExecutionInput::</span>new(</span>
<span id="cb101-39"><a href="#cb101-39" aria-hidden="true" tabindex="-1"></a>                        <span class="pp">ink::env::call::Selector::</span>new([<span class="dv">0x56</span><span class="op">,</span> <span class="dv">0xe9</span><span class="op">,</span> <span class="dv">0x31</span><span class="op">,</span> <span class="dv">0xb8</span>]) <span class="co">// balance_of selector</span></span>
<span id="cb101-40"><a href="#cb101-40" aria-hidden="true" tabindex="-1"></a>                    )<span class="op">.</span>push_arg(account)</span>
<span id="cb101-41"><a href="#cb101-41" aria-hidden="true" tabindex="-1"></a>                )</span>
<span id="cb101-42"><a href="#cb101-42" aria-hidden="true" tabindex="-1"></a>                <span class="op">.</span><span class="pp">returns::</span><span class="op">&lt;</span>Balance<span class="op">&gt;</span>()</span>
<span id="cb101-43"><a href="#cb101-43" aria-hidden="true" tabindex="-1"></a>                <span class="op">.</span>invoke()<span class="op">;</span></span>
<span id="cb101-44"><a href="#cb101-44" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb101-45"><a href="#cb101-45" aria-hidden="true" tabindex="-1"></a>            balance</span>
<span id="cb101-46"><a href="#cb101-46" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb101-47"><a href="#cb101-47" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb101-48"><a href="#cb101-48" aria-hidden="true" tabindex="-1"></a>        <span class="co">/// More ergonomic cross-contract call using trait</span></span>
<span id="cb101-49"><a href="#cb101-49" aria-hidden="true" tabindex="-1"></a>        <span class="at">#[</span>ink<span class="at">(</span>message<span class="at">)]</span></span>
<span id="cb101-50"><a href="#cb101-50" aria-hidden="true" tabindex="-1"></a>        <span class="kw">pub</span> <span class="kw">fn</span> transfer_tokens(</span>
<span id="cb101-51"><a href="#cb101-51" aria-hidden="true" tabindex="-1"></a>            <span class="op">&amp;</span><span class="kw">mut</span> <span class="kw">self</span><span class="op">,</span></span>
<span id="cb101-52"><a href="#cb101-52" aria-hidden="true" tabindex="-1"></a>            to<span class="op">:</span> AccountId<span class="op">,</span></span>
<span id="cb101-53"><a href="#cb101-53" aria-hidden="true" tabindex="-1"></a>            amount<span class="op">:</span> Balance<span class="op">,</span></span>
<span id="cb101-54"><a href="#cb101-54" aria-hidden="true" tabindex="-1"></a>        ) <span class="op">-&gt;</span> <span class="dt">Result</span><span class="op">&lt;</span>()<span class="op">,</span> <span class="bu">Error</span><span class="op">&gt;</span> <span class="op">{</span></span>
<span id="cb101-55"><a href="#cb101-55" aria-hidden="true" tabindex="-1"></a>            <span class="co">// Create contract reference</span></span>
<span id="cb101-56"><a href="#cb101-56" aria-hidden="true" tabindex="-1"></a>            <span class="kw">let</span> <span class="kw">mut</span> erc20<span class="op">:</span> <span class="pp">ink::contract_ref!</span>(ERC20) <span class="op">=</span> <span class="kw">self</span><span class="op">.</span>erc20_contract<span class="op">.</span>into()<span class="op">;</span></span>
<span id="cb101-57"><a href="#cb101-57" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb101-58"><a href="#cb101-58" aria-hidden="true" tabindex="-1"></a>            <span class="co">// Call the contract method directly</span></span>
<span id="cb101-59"><a href="#cb101-59" aria-hidden="true" tabindex="-1"></a>            erc20<span class="op">.</span>transfer(to<span class="op">,</span> amount)<span class="op">.</span>map_err(<span class="op">|</span>_<span class="op">|</span> <span class="bu">Error</span><span class="pp">::</span>CrossContractCallFailed)</span>
<span id="cb101-60"><a href="#cb101-60" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb101-61"><a href="#cb101-61" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb101-62"><a href="#cb101-62" aria-hidden="true" tabindex="-1"></a>        <span class="co">/// Cross-contract call with error handling</span></span>
<span id="cb101-63"><a href="#cb101-63" aria-hidden="true" tabindex="-1"></a>        <span class="at">#[</span>ink<span class="at">(</span>message<span class="at">)]</span></span>
<span id="cb101-64"><a href="#cb101-64" aria-hidden="true" tabindex="-1"></a>        <span class="kw">pub</span> <span class="kw">fn</span> safe_token_transfer(</span>
<span id="cb101-65"><a href="#cb101-65" aria-hidden="true" tabindex="-1"></a>            <span class="op">&amp;</span><span class="kw">mut</span> <span class="kw">self</span><span class="op">,</span></span>
<span id="cb101-66"><a href="#cb101-66" aria-hidden="true" tabindex="-1"></a>            to<span class="op">:</span> AccountId<span class="op">,</span></span>
<span id="cb101-67"><a href="#cb101-67" aria-hidden="true" tabindex="-1"></a>            amount<span class="op">:</span> Balance<span class="op">,</span></span>
<span id="cb101-68"><a href="#cb101-68" aria-hidden="true" tabindex="-1"></a>        ) <span class="op">-&gt;</span> <span class="dt">Result</span><span class="op">&lt;</span>()<span class="op">,</span> <span class="bu">Error</span><span class="op">&gt;</span> <span class="op">{</span></span>
<span id="cb101-69"><a href="#cb101-69" aria-hidden="true" tabindex="-1"></a>            <span class="co">// Check contract balance first</span></span>
<span id="cb101-70"><a href="#cb101-70" aria-hidden="true" tabindex="-1"></a>            <span class="kw">let</span> erc20<span class="op">:</span> <span class="pp">ink::contract_ref!</span>(ERC20) <span class="op">=</span> <span class="kw">self</span><span class="op">.</span>erc20_contract<span class="op">.</span>into()<span class="op">;</span></span>
<span id="cb101-71"><a href="#cb101-71" aria-hidden="true" tabindex="-1"></a>            <span class="kw">let</span> contract_balance <span class="op">=</span> erc20<span class="op">.</span>balance_of(<span class="kw">self</span><span class="op">.</span>env()<span class="op">.</span>account_id())<span class="op">;</span></span>
<span id="cb101-72"><a href="#cb101-72" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb101-73"><a href="#cb101-73" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> contract_balance <span class="op">&lt;</span> amount <span class="op">{</span></span>
<span id="cb101-74"><a href="#cb101-74" aria-hidden="true" tabindex="-1"></a>                <span class="cf">return</span> <span class="cn">Err</span>(<span class="bu">Error</span><span class="pp">::</span>InsufficientBalance)<span class="op">;</span></span>
<span id="cb101-75"><a href="#cb101-75" aria-hidden="true" tabindex="-1"></a>            <span class="op">}</span></span>
<span id="cb101-76"><a href="#cb101-76" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb101-77"><a href="#cb101-77" aria-hidden="true" tabindex="-1"></a>            <span class="co">// Perform transfer</span></span>
<span id="cb101-78"><a href="#cb101-78" aria-hidden="true" tabindex="-1"></a>            <span class="kw">let</span> <span class="kw">mut</span> erc20_mut<span class="op">:</span> <span class="pp">ink::contract_ref!</span>(ERC20) <span class="op">=</span> <span class="kw">self</span><span class="op">.</span>erc20_contract<span class="op">.</span>into()<span class="op">;</span></span>
<span id="cb101-79"><a href="#cb101-79" aria-hidden="true" tabindex="-1"></a>            erc20_mut<span class="op">.</span>transfer(to<span class="op">,</span> amount)</span>
<span id="cb101-80"><a href="#cb101-80" aria-hidden="true" tabindex="-1"></a>                <span class="op">.</span>map_err(<span class="op">|</span>_<span class="op">|</span> <span class="bu">Error</span><span class="pp">::</span>TransferFailed)<span class="op">?;</span></span>
<span id="cb101-81"><a href="#cb101-81" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb101-82"><a href="#cb101-82" aria-hidden="true" tabindex="-1"></a>            <span class="cn">Ok</span>(())</span>
<span id="cb101-83"><a href="#cb101-83" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb101-84"><a href="#cb101-84" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb101-85"><a href="#cb101-85" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<h3 id="advanced-cross-contract-patterns">Advanced Cross-Contract
Patterns</h3>
<h4 id="factory-pattern-with-cross-contract-calls">Factory Pattern with
Cross-Contract Calls</h4>
<div class="sourceCode" id="cb102"><pre
class="sourceCode rust"><code class="sourceCode rust"><span id="cb102-1"><a href="#cb102-1" aria-hidden="true" tabindex="-1"></a><span class="at">#[</span><span class="pp">ink::</span>trait_definition<span class="at">]</span></span>
<span id="cb102-2"><a href="#cb102-2" aria-hidden="true" tabindex="-1"></a><span class="kw">pub</span> <span class="kw">trait</span> TokenFactory <span class="op">{</span></span>
<span id="cb102-3"><a href="#cb102-3" aria-hidden="true" tabindex="-1"></a>    <span class="at">#[</span>ink<span class="at">(</span>message<span class="at">)]</span></span>
<span id="cb102-4"><a href="#cb102-4" aria-hidden="true" tabindex="-1"></a>    <span class="kw">fn</span> create_token(<span class="op">&amp;</span><span class="kw">mut</span> <span class="kw">self</span><span class="op">,</span> name<span class="op">:</span> <span class="dt">String</span><span class="op">,</span> symbol<span class="op">:</span> <span class="dt">String</span><span class="op">,</span> total_supply<span class="op">:</span> Balance) <span class="op">-&gt;</span> AccountId<span class="op">;</span></span>
<span id="cb102-5"><a href="#cb102-5" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb102-6"><a href="#cb102-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb102-7"><a href="#cb102-7" aria-hidden="true" tabindex="-1"></a><span class="at">#[</span><span class="pp">ink::</span>trait_definition<span class="at">]</span></span>
<span id="cb102-8"><a href="#cb102-8" aria-hidden="true" tabindex="-1"></a><span class="kw">pub</span> <span class="kw">trait</span> Token <span class="op">{</span></span>
<span id="cb102-9"><a href="#cb102-9" aria-hidden="true" tabindex="-1"></a>    <span class="at">#[</span>ink<span class="at">(</span>message<span class="at">)]</span></span>
<span id="cb102-10"><a href="#cb102-10" aria-hidden="true" tabindex="-1"></a>    <span class="kw">fn</span> mint(<span class="op">&amp;</span><span class="kw">mut</span> <span class="kw">self</span><span class="op">,</span> to<span class="op">:</span> AccountId<span class="op">,</span> amount<span class="op">:</span> Balance) <span class="op">-&gt;</span> <span class="dt">Result</span><span class="op">&lt;</span>()<span class="op">,</span> <span class="bu">Error</span><span class="op">&gt;;</span></span>
<span id="cb102-11"><a href="#cb102-11" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb102-12"><a href="#cb102-12" aria-hidden="true" tabindex="-1"></a>    <span class="at">#[</span>ink<span class="at">(</span>message<span class="at">)]</span></span>
<span id="cb102-13"><a href="#cb102-13" aria-hidden="true" tabindex="-1"></a>    <span class="kw">fn</span> transfer(<span class="op">&amp;</span><span class="kw">mut</span> <span class="kw">self</span><span class="op">,</span> to<span class="op">:</span> AccountId<span class="op">,</span> amount<span class="op">:</span> Balance) <span class="op">-&gt;</span> <span class="dt">Result</span><span class="op">&lt;</span>()<span class="op">,</span> <span class="bu">Error</span><span class="op">&gt;;</span></span>
<span id="cb102-14"><a href="#cb102-14" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb102-15"><a href="#cb102-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb102-16"><a href="#cb102-16" aria-hidden="true" tabindex="-1"></a><span class="at">#[</span><span class="pp">ink::</span>contract<span class="at">]</span></span>
<span id="cb102-17"><a href="#cb102-17" aria-hidden="true" tabindex="-1"></a><span class="kw">mod</span> token_manager <span class="op">{</span></span>
<span id="cb102-18"><a href="#cb102-18" aria-hidden="true" tabindex="-1"></a>    <span class="kw">use</span> <span class="kw">super</span><span class="pp">::</span><span class="op">{</span>TokenFactory<span class="op">,</span> Token<span class="op">};</span></span>
<span id="cb102-19"><a href="#cb102-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb102-20"><a href="#cb102-20" aria-hidden="true" tabindex="-1"></a>    <span class="at">#[</span>ink<span class="at">(</span>storage<span class="at">)]</span></span>
<span id="cb102-21"><a href="#cb102-21" aria-hidden="true" tabindex="-1"></a>    <span class="kw">pub</span> <span class="kw">struct</span> TokenManager <span class="op">{</span></span>
<span id="cb102-22"><a href="#cb102-22" aria-hidden="true" tabindex="-1"></a>        factory<span class="op">:</span> AccountId<span class="op">,</span></span>
<span id="cb102-23"><a href="#cb102-23" aria-hidden="true" tabindex="-1"></a>        created_tokens<span class="op">:</span> <span class="dt">Vec</span><span class="op">&lt;</span>AccountId<span class="op">&gt;,</span></span>
<span id="cb102-24"><a href="#cb102-24" aria-hidden="true" tabindex="-1"></a>        token_owners<span class="op">:</span> <span class="pp">ink::storage::</span>Mapping<span class="op">&lt;</span>AccountId<span class="op">,</span> AccountId<span class="op">&gt;,</span> <span class="co">// token -&gt; owner</span></span>
<span id="cb102-25"><a href="#cb102-25" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb102-26"><a href="#cb102-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb102-27"><a href="#cb102-27" aria-hidden="true" tabindex="-1"></a>    <span class="kw">impl</span> TokenManager <span class="op">{</span></span>
<span id="cb102-28"><a href="#cb102-28" aria-hidden="true" tabindex="-1"></a>        <span class="at">#[</span>ink<span class="at">(</span>constructor<span class="at">)]</span></span>
<span id="cb102-29"><a href="#cb102-29" aria-hidden="true" tabindex="-1"></a>        <span class="kw">pub</span> <span class="kw">fn</span> new(factory<span class="op">:</span> AccountId) <span class="op">-&gt;</span> <span class="dt">Self</span> <span class="op">{</span></span>
<span id="cb102-30"><a href="#cb102-30" aria-hidden="true" tabindex="-1"></a>            <span class="dt">Self</span> <span class="op">{</span></span>
<span id="cb102-31"><a href="#cb102-31" aria-hidden="true" tabindex="-1"></a>                factory<span class="op">,</span></span>
<span id="cb102-32"><a href="#cb102-32" aria-hidden="true" tabindex="-1"></a>                created_tokens<span class="op">:</span> <span class="dt">Vec</span><span class="pp">::</span>new()<span class="op">,</span></span>
<span id="cb102-33"><a href="#cb102-33" aria-hidden="true" tabindex="-1"></a>                token_owners<span class="op">:</span> <span class="pp">ink::storage::Mapping::</span><span class="kw">default</span>()<span class="op">,</span></span>
<span id="cb102-34"><a href="#cb102-34" aria-hidden="true" tabindex="-1"></a>            <span class="op">}</span></span>
<span id="cb102-35"><a href="#cb102-35" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb102-36"><a href="#cb102-36" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb102-37"><a href="#cb102-37" aria-hidden="true" tabindex="-1"></a>        <span class="co">/// Create a new token through the factory</span></span>
<span id="cb102-38"><a href="#cb102-38" aria-hidden="true" tabindex="-1"></a>        <span class="at">#[</span>ink<span class="at">(</span>message<span class="at">)]</span></span>
<span id="cb102-39"><a href="#cb102-39" aria-hidden="true" tabindex="-1"></a>        <span class="kw">pub</span> <span class="kw">fn</span> create_managed_token(</span>
<span id="cb102-40"><a href="#cb102-40" aria-hidden="true" tabindex="-1"></a>            <span class="op">&amp;</span><span class="kw">mut</span> <span class="kw">self</span><span class="op">,</span></span>
<span id="cb102-41"><a href="#cb102-41" aria-hidden="true" tabindex="-1"></a>            name<span class="op">:</span> <span class="dt">String</span><span class="op">,</span></span>
<span id="cb102-42"><a href="#cb102-42" aria-hidden="true" tabindex="-1"></a>            symbol<span class="op">:</span> <span class="dt">String</span><span class="op">,</span></span>
<span id="cb102-43"><a href="#cb102-43" aria-hidden="true" tabindex="-1"></a>            total_supply<span class="op">:</span> Balance<span class="op">,</span></span>
<span id="cb102-44"><a href="#cb102-44" aria-hidden="true" tabindex="-1"></a>        ) <span class="op">-&gt;</span> <span class="dt">Result</span><span class="op">&lt;</span>AccountId<span class="op">,</span> <span class="bu">Error</span><span class="op">&gt;</span> <span class="op">{</span></span>
<span id="cb102-45"><a href="#cb102-45" aria-hidden="true" tabindex="-1"></a>            <span class="kw">let</span> caller <span class="op">=</span> <span class="kw">self</span><span class="op">.</span>env()<span class="op">.</span>caller()<span class="op">;</span></span>
<span id="cb102-46"><a href="#cb102-46" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb102-47"><a href="#cb102-47" aria-hidden="true" tabindex="-1"></a>            <span class="co">// Call factory to create token</span></span>
<span id="cb102-48"><a href="#cb102-48" aria-hidden="true" tabindex="-1"></a>            <span class="kw">let</span> <span class="kw">mut</span> factory<span class="op">:</span> <span class="pp">ink::contract_ref!</span>(TokenFactory) <span class="op">=</span> <span class="kw">self</span><span class="op">.</span>factory<span class="op">.</span>into()<span class="op">;</span></span>
<span id="cb102-49"><a href="#cb102-49" aria-hidden="true" tabindex="-1"></a>            <span class="kw">let</span> token_address <span class="op">=</span> factory<span class="op">.</span>create_token(name<span class="op">,</span> symbol<span class="op">,</span> total_supply)<span class="op">;</span></span>
<span id="cb102-50"><a href="#cb102-50" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb102-51"><a href="#cb102-51" aria-hidden="true" tabindex="-1"></a>            <span class="co">// Register the token</span></span>
<span id="cb102-52"><a href="#cb102-52" aria-hidden="true" tabindex="-1"></a>            <span class="kw">self</span><span class="op">.</span>created_tokens<span class="op">.</span>push(token_address)<span class="op">;</span></span>
<span id="cb102-53"><a href="#cb102-53" aria-hidden="true" tabindex="-1"></a>            <span class="kw">self</span><span class="op">.</span>token_owners<span class="op">.</span>insert(token_address<span class="op">,</span> <span class="op">&amp;</span>caller)<span class="op">;</span></span>
<span id="cb102-54"><a href="#cb102-54" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb102-55"><a href="#cb102-55" aria-hidden="true" tabindex="-1"></a>            <span class="cn">Ok</span>(token_address)</span>
<span id="cb102-56"><a href="#cb102-56" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb102-57"><a href="#cb102-57" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb102-58"><a href="#cb102-58" aria-hidden="true" tabindex="-1"></a>        <span class="co">/// Manage token on behalf of owner</span></span>
<span id="cb102-59"><a href="#cb102-59" aria-hidden="true" tabindex="-1"></a>        <span class="at">#[</span>ink<span class="at">(</span>message<span class="at">)]</span></span>
<span id="cb102-60"><a href="#cb102-60" aria-hidden="true" tabindex="-1"></a>        <span class="kw">pub</span> <span class="kw">fn</span> mint_tokens(</span>
<span id="cb102-61"><a href="#cb102-61" aria-hidden="true" tabindex="-1"></a>            <span class="op">&amp;</span><span class="kw">mut</span> <span class="kw">self</span><span class="op">,</span></span>
<span id="cb102-62"><a href="#cb102-62" aria-hidden="true" tabindex="-1"></a>            token<span class="op">:</span> AccountId<span class="op">,</span></span>
<span id="cb102-63"><a href="#cb102-63" aria-hidden="true" tabindex="-1"></a>            to<span class="op">:</span> AccountId<span class="op">,</span></span>
<span id="cb102-64"><a href="#cb102-64" aria-hidden="true" tabindex="-1"></a>            amount<span class="op">:</span> Balance<span class="op">,</span></span>
<span id="cb102-65"><a href="#cb102-65" aria-hidden="true" tabindex="-1"></a>        ) <span class="op">-&gt;</span> <span class="dt">Result</span><span class="op">&lt;</span>()<span class="op">,</span> <span class="bu">Error</span><span class="op">&gt;</span> <span class="op">{</span></span>
<span id="cb102-66"><a href="#cb102-66" aria-hidden="true" tabindex="-1"></a>            <span class="kw">let</span> caller <span class="op">=</span> <span class="kw">self</span><span class="op">.</span>env()<span class="op">.</span>caller()<span class="op">;</span></span>
<span id="cb102-67"><a href="#cb102-67" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb102-68"><a href="#cb102-68" aria-hidden="true" tabindex="-1"></a>            <span class="co">// Verify ownership</span></span>
<span id="cb102-69"><a href="#cb102-69" aria-hidden="true" tabindex="-1"></a>            <span class="kw">let</span> owner <span class="op">=</span> <span class="kw">self</span><span class="op">.</span>token_owners<span class="op">.</span>get(token)<span class="op">.</span>ok_or(<span class="bu">Error</span><span class="pp">::</span>TokenNotFound)<span class="op">?;</span></span>
<span id="cb102-70"><a href="#cb102-70" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> caller <span class="op">!=</span> owner <span class="op">{</span></span>
<span id="cb102-71"><a href="#cb102-71" aria-hidden="true" tabindex="-1"></a>                <span class="cf">return</span> <span class="cn">Err</span>(<span class="bu">Error</span><span class="pp">::</span>Unauthorized)<span class="op">;</span></span>
<span id="cb102-72"><a href="#cb102-72" aria-hidden="true" tabindex="-1"></a>            <span class="op">}</span></span>
<span id="cb102-73"><a href="#cb102-73" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb102-74"><a href="#cb102-74" aria-hidden="true" tabindex="-1"></a>            <span class="co">// Call token mint function</span></span>
<span id="cb102-75"><a href="#cb102-75" aria-hidden="true" tabindex="-1"></a>            <span class="kw">let</span> <span class="kw">mut</span> token_contract<span class="op">:</span> <span class="pp">ink::contract_ref!</span>(Token) <span class="op">=</span> token<span class="op">.</span>into()<span class="op">;</span></span>
<span id="cb102-76"><a href="#cb102-76" aria-hidden="true" tabindex="-1"></a>            token_contract<span class="op">.</span>mint(to<span class="op">,</span> amount)</span>
<span id="cb102-77"><a href="#cb102-77" aria-hidden="true" tabindex="-1"></a>                <span class="op">.</span>map_err(<span class="op">|</span>_<span class="op">|</span> <span class="bu">Error</span><span class="pp">::</span>MintFailed)<span class="op">?;</span></span>
<span id="cb102-78"><a href="#cb102-78" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb102-79"><a href="#cb102-79" aria-hidden="true" tabindex="-1"></a>            <span class="cn">Ok</span>(())</span>
<span id="cb102-80"><a href="#cb102-80" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb102-81"><a href="#cb102-81" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb102-82"><a href="#cb102-82" aria-hidden="true" tabindex="-1"></a>        <span class="co">/// Batch operations across multiple tokens</span></span>
<span id="cb102-83"><a href="#cb102-83" aria-hidden="true" tabindex="-1"></a>        <span class="at">#[</span>ink<span class="at">(</span>message<span class="at">)]</span></span>
<span id="cb102-84"><a href="#cb102-84" aria-hidden="true" tabindex="-1"></a>        <span class="kw">pub</span> <span class="kw">fn</span> batch_transfer(</span>
<span id="cb102-85"><a href="#cb102-85" aria-hidden="true" tabindex="-1"></a>            <span class="op">&amp;</span><span class="kw">mut</span> <span class="kw">self</span><span class="op">,</span></span>
<span id="cb102-86"><a href="#cb102-86" aria-hidden="true" tabindex="-1"></a>            operations<span class="op">:</span> <span class="dt">Vec</span><span class="op">&lt;</span>(AccountId<span class="op">,</span> AccountId<span class="op">,</span> Balance)<span class="op">&gt;,</span> <span class="co">// (token, to, amount)</span></span>
<span id="cb102-87"><a href="#cb102-87" aria-hidden="true" tabindex="-1"></a>        ) <span class="op">-&gt;</span> <span class="dt">Result</span><span class="op">&lt;</span><span class="dt">u32</span><span class="op">,</span> <span class="bu">Error</span><span class="op">&gt;</span> <span class="op">{</span></span>
<span id="cb102-88"><a href="#cb102-88" aria-hidden="true" tabindex="-1"></a>            <span class="kw">let</span> caller <span class="op">=</span> <span class="kw">self</span><span class="op">.</span>env()<span class="op">.</span>caller()<span class="op">;</span></span>
<span id="cb102-89"><a href="#cb102-89" aria-hidden="true" tabindex="-1"></a>            <span class="kw">let</span> <span class="kw">mut</span> successful <span class="op">=</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb102-90"><a href="#cb102-90" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb102-91"><a href="#cb102-91" aria-hidden="true" tabindex="-1"></a>            <span class="cf">for</span> (token<span class="op">,</span> to<span class="op">,</span> amount) <span class="kw">in</span> operations <span class="op">{</span></span>
<span id="cb102-92"><a href="#cb102-92" aria-hidden="true" tabindex="-1"></a>                <span class="co">// Verify ownership</span></span>
<span id="cb102-93"><a href="#cb102-93" aria-hidden="true" tabindex="-1"></a>                <span class="cf">if</span> <span class="kw">let</span> <span class="cn">Some</span>(owner) <span class="op">=</span> <span class="kw">self</span><span class="op">.</span>token_owners<span class="op">.</span>get(token) <span class="op">{</span></span>
<span id="cb102-94"><a href="#cb102-94" aria-hidden="true" tabindex="-1"></a>                    <span class="cf">if</span> caller <span class="op">==</span> owner <span class="op">{</span></span>
<span id="cb102-95"><a href="#cb102-95" aria-hidden="true" tabindex="-1"></a>                        <span class="co">// Attempt transfer</span></span>
<span id="cb102-96"><a href="#cb102-96" aria-hidden="true" tabindex="-1"></a>                        <span class="kw">let</span> <span class="kw">mut</span> token_contract<span class="op">:</span> <span class="pp">ink::contract_ref!</span>(Token) <span class="op">=</span> token<span class="op">.</span>into()<span class="op">;</span></span>
<span id="cb102-97"><a href="#cb102-97" aria-hidden="true" tabindex="-1"></a>                        <span class="cf">if</span> token_contract<span class="op">.</span>transfer(to<span class="op">,</span> amount)<span class="op">.</span>is_ok() <span class="op">{</span></span>
<span id="cb102-98"><a href="#cb102-98" aria-hidden="true" tabindex="-1"></a>                            successful <span class="op">+=</span> <span class="dv">1</span><span class="op">;</span></span>
<span id="cb102-99"><a href="#cb102-99" aria-hidden="true" tabindex="-1"></a>                        <span class="op">}</span></span>
<span id="cb102-100"><a href="#cb102-100" aria-hidden="true" tabindex="-1"></a>                    <span class="op">}</span></span>
<span id="cb102-101"><a href="#cb102-101" aria-hidden="true" tabindex="-1"></a>                <span class="op">}</span></span>
<span id="cb102-102"><a href="#cb102-102" aria-hidden="true" tabindex="-1"></a>            <span class="op">}</span></span>
<span id="cb102-103"><a href="#cb102-103" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb102-104"><a href="#cb102-104" aria-hidden="true" tabindex="-1"></a>            <span class="cn">Ok</span>(successful)</span>
<span id="cb102-105"><a href="#cb102-105" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb102-106"><a href="#cb102-106" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb102-107"><a href="#cb102-107" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<h4 id="proxy-pattern-for-upgradeable-contracts">Proxy Pattern for
Upgradeable Contracts</h4>
<div class="sourceCode" id="cb103"><pre
class="sourceCode rust"><code class="sourceCode rust"><span id="cb103-1"><a href="#cb103-1" aria-hidden="true" tabindex="-1"></a><span class="at">#[</span><span class="pp">ink::</span>trait_definition<span class="at">]</span></span>
<span id="cb103-2"><a href="#cb103-2" aria-hidden="true" tabindex="-1"></a><span class="kw">pub</span> <span class="kw">trait</span> Upgradeable <span class="op">{</span></span>
<span id="cb103-3"><a href="#cb103-3" aria-hidden="true" tabindex="-1"></a>    <span class="at">#[</span>ink<span class="at">(</span>message<span class="at">)]</span></span>
<span id="cb103-4"><a href="#cb103-4" aria-hidden="true" tabindex="-1"></a>    <span class="kw">fn</span> version(<span class="op">&amp;</span><span class="kw">self</span>) <span class="op">-&gt;</span> <span class="dt">u32</span><span class="op">;</span></span>
<span id="cb103-5"><a href="#cb103-5" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb103-6"><a href="#cb103-6" aria-hidden="true" tabindex="-1"></a>    <span class="at">#[</span>ink<span class="at">(</span>message<span class="at">)]</span></span>
<span id="cb103-7"><a href="#cb103-7" aria-hidden="true" tabindex="-1"></a>    <span class="kw">fn</span> upgrade(<span class="op">&amp;</span><span class="kw">mut</span> <span class="kw">self</span><span class="op">,</span> new_implementation<span class="op">:</span> AccountId) <span class="op">-&gt;</span> <span class="dt">Result</span><span class="op">&lt;</span>()<span class="op">,</span> <span class="bu">Error</span><span class="op">&gt;;</span></span>
<span id="cb103-8"><a href="#cb103-8" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb103-9"><a href="#cb103-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb103-10"><a href="#cb103-10" aria-hidden="true" tabindex="-1"></a><span class="at">#[</span><span class="pp">ink::</span>contract<span class="at">]</span></span>
<span id="cb103-11"><a href="#cb103-11" aria-hidden="true" tabindex="-1"></a><span class="kw">mod</span> proxy_contract <span class="op">{</span></span>
<span id="cb103-12"><a href="#cb103-12" aria-hidden="true" tabindex="-1"></a>    <span class="kw">use</span> <span class="kw">super</span><span class="pp">::</span>Upgradeable<span class="op">;</span></span>
<span id="cb103-13"><a href="#cb103-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb103-14"><a href="#cb103-14" aria-hidden="true" tabindex="-1"></a>    <span class="at">#[</span>ink<span class="at">(</span>storage<span class="at">)]</span></span>
<span id="cb103-15"><a href="#cb103-15" aria-hidden="true" tabindex="-1"></a>    <span class="kw">pub</span> <span class="kw">struct</span> ProxyContract <span class="op">{</span></span>
<span id="cb103-16"><a href="#cb103-16" aria-hidden="true" tabindex="-1"></a>        implementation<span class="op">:</span> AccountId<span class="op">,</span></span>
<span id="cb103-17"><a href="#cb103-17" aria-hidden="true" tabindex="-1"></a>        admin<span class="op">:</span> AccountId<span class="op">,</span></span>
<span id="cb103-18"><a href="#cb103-18" aria-hidden="true" tabindex="-1"></a>        version<span class="op">:</span> <span class="dt">u32</span><span class="op">,</span></span>
<span id="cb103-19"><a href="#cb103-19" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb103-20"><a href="#cb103-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb103-21"><a href="#cb103-21" aria-hidden="true" tabindex="-1"></a>    <span class="kw">impl</span> ProxyContract <span class="op">{</span></span>
<span id="cb103-22"><a href="#cb103-22" aria-hidden="true" tabindex="-1"></a>        <span class="at">#[</span>ink<span class="at">(</span>constructor<span class="at">)]</span></span>
<span id="cb103-23"><a href="#cb103-23" aria-hidden="true" tabindex="-1"></a>        <span class="kw">pub</span> <span class="kw">fn</span> new(implementation<span class="op">:</span> AccountId) <span class="op">-&gt;</span> <span class="dt">Self</span> <span class="op">{</span></span>
<span id="cb103-24"><a href="#cb103-24" aria-hidden="true" tabindex="-1"></a>            <span class="dt">Self</span> <span class="op">{</span></span>
<span id="cb103-25"><a href="#cb103-25" aria-hidden="true" tabindex="-1"></a>                implementation<span class="op">,</span></span>
<span id="cb103-26"><a href="#cb103-26" aria-hidden="true" tabindex="-1"></a>                admin<span class="op">:</span> <span class="dt">Self</span><span class="pp">::</span>env()<span class="op">.</span>caller()<span class="op">,</span></span>
<span id="cb103-27"><a href="#cb103-27" aria-hidden="true" tabindex="-1"></a>                version<span class="op">:</span> <span class="dv">1</span><span class="op">,</span></span>
<span id="cb103-28"><a href="#cb103-28" aria-hidden="true" tabindex="-1"></a>            <span class="op">}</span></span>
<span id="cb103-29"><a href="#cb103-29" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb103-30"><a href="#cb103-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb103-31"><a href="#cb103-31" aria-hidden="true" tabindex="-1"></a>        <span class="co">/// Delegate call to current implementation</span></span>
<span id="cb103-32"><a href="#cb103-32" aria-hidden="true" tabindex="-1"></a>        <span class="at">#[</span>ink<span class="at">(</span>message<span class="at">)]</span></span>
<span id="cb103-33"><a href="#cb103-33" aria-hidden="true" tabindex="-1"></a>        <span class="kw">pub</span> <span class="kw">fn</span> delegate_call(<span class="op">&amp;</span><span class="kw">self</span><span class="op">,</span> selector<span class="op">:</span> [<span class="dt">u8</span><span class="op">;</span> <span class="dv">4</span>]<span class="op">,</span> input<span class="op">:</span> <span class="dt">Vec</span><span class="op">&lt;</span><span class="dt">u8</span><span class="op">&gt;</span>) <span class="op">-&gt;</span> <span class="dt">Vec</span><span class="op">&lt;</span><span class="dt">u8</span><span class="op">&gt;</span> <span class="op">{</span></span>
<span id="cb103-34"><a href="#cb103-34" aria-hidden="true" tabindex="-1"></a>            <span class="co">// Build delegate call to implementation</span></span>
<span id="cb103-35"><a href="#cb103-35" aria-hidden="true" tabindex="-1"></a>            <span class="kw">let</span> result <span class="op">=</span> <span class="pp">ink::env::call::build_call::</span><span class="op">&lt;</span><span class="pp">ink::env::</span>DefaultEnvironment<span class="op">&gt;</span>()</span>
<span id="cb103-36"><a href="#cb103-36" aria-hidden="true" tabindex="-1"></a>                <span class="op">.</span>call(<span class="kw">self</span><span class="op">.</span>implementation)</span>
<span id="cb103-37"><a href="#cb103-37" aria-hidden="true" tabindex="-1"></a>                <span class="op">.</span>gas_limit(<span class="dv">0</span>) <span class="co">// Use all available gas</span></span>
<span id="cb103-38"><a href="#cb103-38" aria-hidden="true" tabindex="-1"></a>                <span class="op">.</span>transferred_value(<span class="dv">0</span>)</span>
<span id="cb103-39"><a href="#cb103-39" aria-hidden="true" tabindex="-1"></a>                <span class="op">.</span>exec_input(</span>
<span id="cb103-40"><a href="#cb103-40" aria-hidden="true" tabindex="-1"></a>                    <span class="pp">ink::env::call::ExecutionInput::</span>new(</span>
<span id="cb103-41"><a href="#cb103-41" aria-hidden="true" tabindex="-1"></a>                        <span class="pp">ink::env::call::Selector::</span>new(selector)</span>
<span id="cb103-42"><a href="#cb103-42" aria-hidden="true" tabindex="-1"></a>                    )<span class="op">.</span>push_arg(input)</span>
<span id="cb103-43"><a href="#cb103-43" aria-hidden="true" tabindex="-1"></a>                )</span>
<span id="cb103-44"><a href="#cb103-44" aria-hidden="true" tabindex="-1"></a>                <span class="op">.</span><span class="pp">returns::</span><span class="op">&lt;</span><span class="dt">Vec</span><span class="op">&lt;</span><span class="dt">u8</span><span class="op">&gt;&gt;</span>()</span>
<span id="cb103-45"><a href="#cb103-45" aria-hidden="true" tabindex="-1"></a>                <span class="op">.</span>invoke()<span class="op">;</span></span>
<span id="cb103-46"><a href="#cb103-46" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb103-47"><a href="#cb103-47" aria-hidden="true" tabindex="-1"></a>            result</span>
<span id="cb103-48"><a href="#cb103-48" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb103-49"><a href="#cb103-49" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb103-50"><a href="#cb103-50" aria-hidden="true" tabindex="-1"></a>        <span class="co">/// Upgrade to new implementation (admin only)</span></span>
<span id="cb103-51"><a href="#cb103-51" aria-hidden="true" tabindex="-1"></a>        <span class="at">#[</span>ink<span class="at">(</span>message<span class="at">)]</span></span>
<span id="cb103-52"><a href="#cb103-52" aria-hidden="true" tabindex="-1"></a>        <span class="kw">pub</span> <span class="kw">fn</span> upgrade_implementation(<span class="op">&amp;</span><span class="kw">mut</span> <span class="kw">self</span><span class="op">,</span> new_implementation<span class="op">:</span> AccountId) <span class="op">-&gt;</span> <span class="dt">Result</span><span class="op">&lt;</span>()<span class="op">,</span> <span class="bu">Error</span><span class="op">&gt;</span> <span class="op">{</span></span>
<span id="cb103-53"><a href="#cb103-53" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> <span class="kw">self</span><span class="op">.</span>env()<span class="op">.</span>caller() <span class="op">!=</span> <span class="kw">self</span><span class="op">.</span>admin <span class="op">{</span></span>
<span id="cb103-54"><a href="#cb103-54" aria-hidden="true" tabindex="-1"></a>                <span class="cf">return</span> <span class="cn">Err</span>(<span class="bu">Error</span><span class="pp">::</span>Unauthorized)<span class="op">;</span></span>
<span id="cb103-55"><a href="#cb103-55" aria-hidden="true" tabindex="-1"></a>            <span class="op">}</span></span>
<span id="cb103-56"><a href="#cb103-56" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb103-57"><a href="#cb103-57" aria-hidden="true" tabindex="-1"></a>            <span class="co">// Verify new implementation is compatible</span></span>
<span id="cb103-58"><a href="#cb103-58" aria-hidden="true" tabindex="-1"></a>            <span class="kw">let</span> new_impl<span class="op">:</span> <span class="pp">ink::contract_ref!</span>(Upgradeable) <span class="op">=</span> new_implementation<span class="op">.</span>into()<span class="op">;</span></span>
<span id="cb103-59"><a href="#cb103-59" aria-hidden="true" tabindex="-1"></a>            <span class="kw">let</span> new_version <span class="op">=</span> new_impl<span class="op">.</span>version()<span class="op">;</span></span>
<span id="cb103-60"><a href="#cb103-60" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb103-61"><a href="#cb103-61" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> new_version <span class="op">&lt;=</span> <span class="kw">self</span><span class="op">.</span>version <span class="op">{</span></span>
<span id="cb103-62"><a href="#cb103-62" aria-hidden="true" tabindex="-1"></a>                <span class="cf">return</span> <span class="cn">Err</span>(<span class="bu">Error</span><span class="pp">::</span>InvalidVersion)<span class="op">;</span></span>
<span id="cb103-63"><a href="#cb103-63" aria-hidden="true" tabindex="-1"></a>            <span class="op">}</span></span>
<span id="cb103-64"><a href="#cb103-64" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb103-65"><a href="#cb103-65" aria-hidden="true" tabindex="-1"></a>            <span class="co">// Update implementation</span></span>
<span id="cb103-66"><a href="#cb103-66" aria-hidden="true" tabindex="-1"></a>            <span class="kw">self</span><span class="op">.</span>implementation <span class="op">=</span> new_implementation<span class="op">;</span></span>
<span id="cb103-67"><a href="#cb103-67" aria-hidden="true" tabindex="-1"></a>            <span class="kw">self</span><span class="op">.</span>version <span class="op">=</span> new_version<span class="op">;</span></span>
<span id="cb103-68"><a href="#cb103-68" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb103-69"><a href="#cb103-69" aria-hidden="true" tabindex="-1"></a>            <span class="cn">Ok</span>(())</span>
<span id="cb103-70"><a href="#cb103-70" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb103-71"><a href="#cb103-71" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb103-72"><a href="#cb103-72" aria-hidden="true" tabindex="-1"></a>        <span class="co">/// Fallback function for unknown calls</span></span>
<span id="cb103-73"><a href="#cb103-73" aria-hidden="true" tabindex="-1"></a>        <span class="at">#[</span>ink<span class="at">(</span>message<span class="at">)]</span></span>
<span id="cb103-74"><a href="#cb103-74" aria-hidden="true" tabindex="-1"></a>        <span class="kw">pub</span> <span class="kw">fn</span> fallback(<span class="op">&amp;</span><span class="kw">self</span>) <span class="op">-&gt;</span> <span class="op">!</span> <span class="op">{</span></span>
<span id="cb103-75"><a href="#cb103-75" aria-hidden="true" tabindex="-1"></a>            <span class="co">// In a real implementation, this would delegate all unknown calls</span></span>
<span id="cb103-76"><a href="#cb103-76" aria-hidden="true" tabindex="-1"></a>            <span class="co">// to the implementation contract</span></span>
<span id="cb103-77"><a href="#cb103-77" aria-hidden="true" tabindex="-1"></a>            <span class="pp">panic!</span>(<span class="st">&quot;Fallback not implemented in this example&quot;</span>)<span class="op">;</span></span>
<span id="cb103-78"><a href="#cb103-78" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb103-79"><a href="#cb103-79" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb103-80"><a href="#cb103-80" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<h3 id="security-considerations-for-cross-contract-calls">Security
Considerations for Cross-Contract Calls</h3>
<p>Cross-contract calls introduce security risks that must be carefully
managed:</p>
<div class="sourceCode" id="cb104"><pre
class="sourceCode rust"><code class="sourceCode rust"><span id="cb104-1"><a href="#cb104-1" aria-hidden="true" tabindex="-1"></a><span class="at">#[</span><span class="pp">ink::</span>contract<span class="at">]</span></span>
<span id="cb104-2"><a href="#cb104-2" aria-hidden="true" tabindex="-1"></a><span class="kw">mod</span> secure_cross_contract <span class="op">{</span></span>
<span id="cb104-3"><a href="#cb104-3" aria-hidden="true" tabindex="-1"></a>    <span class="kw">use</span> <span class="pp">ink::storage::</span>Mapping<span class="op">;</span></span>
<span id="cb104-4"><a href="#cb104-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb104-5"><a href="#cb104-5" aria-hidden="true" tabindex="-1"></a>    <span class="at">#[</span>ink<span class="at">(</span>storage<span class="at">)]</span></span>
<span id="cb104-6"><a href="#cb104-6" aria-hidden="true" tabindex="-1"></a>    <span class="kw">pub</span> <span class="kw">struct</span> SecureCrossContract <span class="op">{</span></span>
<span id="cb104-7"><a href="#cb104-7" aria-hidden="true" tabindex="-1"></a>        trusted_contracts<span class="op">:</span> Mapping<span class="op">&lt;</span>AccountId<span class="op">,</span> <span class="dt">bool</span><span class="op">&gt;,</span></span>
<span id="cb104-8"><a href="#cb104-8" aria-hidden="true" tabindex="-1"></a>        reentrancy_guard<span class="op">:</span> <span class="dt">bool</span><span class="op">,</span></span>
<span id="cb104-9"><a href="#cb104-9" aria-hidden="true" tabindex="-1"></a>        call_depth<span class="op">:</span> <span class="dt">u32</span><span class="op">,</span></span>
<span id="cb104-10"><a href="#cb104-10" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb104-11"><a href="#cb104-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb104-12"><a href="#cb104-12" aria-hidden="true" tabindex="-1"></a>    <span class="kw">impl</span> SecureCrossContract <span class="op">{</span></span>
<span id="cb104-13"><a href="#cb104-13" aria-hidden="true" tabindex="-1"></a>        <span class="at">#[</span>ink<span class="at">(</span>constructor<span class="at">)]</span></span>
<span id="cb104-14"><a href="#cb104-14" aria-hidden="true" tabindex="-1"></a>        <span class="kw">pub</span> <span class="kw">fn</span> new() <span class="op">-&gt;</span> <span class="dt">Self</span> <span class="op">{</span></span>
<span id="cb104-15"><a href="#cb104-15" aria-hidden="true" tabindex="-1"></a>            <span class="dt">Self</span> <span class="op">{</span></span>
<span id="cb104-16"><a href="#cb104-16" aria-hidden="true" tabindex="-1"></a>                trusted_contracts<span class="op">:</span> <span class="pp">Mapping::</span><span class="kw">default</span>()<span class="op">,</span></span>
<span id="cb104-17"><a href="#cb104-17" aria-hidden="true" tabindex="-1"></a>                reentrancy_guard<span class="op">:</span> <span class="cn">false</span><span class="op">,</span></span>
<span id="cb104-18"><a href="#cb104-18" aria-hidden="true" tabindex="-1"></a>                call_depth<span class="op">:</span> <span class="dv">0</span><span class="op">,</span></span>
<span id="cb104-19"><a href="#cb104-19" aria-hidden="true" tabindex="-1"></a>            <span class="op">}</span></span>
<span id="cb104-20"><a href="#cb104-20" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb104-21"><a href="#cb104-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb104-22"><a href="#cb104-22" aria-hidden="true" tabindex="-1"></a>        <span class="co">/// Reentrancy protection modifier</span></span>
<span id="cb104-23"><a href="#cb104-23" aria-hidden="true" tabindex="-1"></a>        <span class="kw">fn</span> non_reentrant(<span class="op">&amp;</span><span class="kw">mut</span> <span class="kw">self</span>) <span class="op">-&gt;</span> <span class="dt">Result</span><span class="op">&lt;</span>()<span class="op">,</span> <span class="bu">Error</span><span class="op">&gt;</span> <span class="op">{</span></span>
<span id="cb104-24"><a href="#cb104-24" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> <span class="kw">self</span><span class="op">.</span>reentrancy_guard <span class="op">{</span></span>
<span id="cb104-25"><a href="#cb104-25" aria-hidden="true" tabindex="-1"></a>                <span class="cf">return</span> <span class="cn">Err</span>(<span class="bu">Error</span><span class="pp">::</span>ReentrancyDetected)<span class="op">;</span></span>
<span id="cb104-26"><a href="#cb104-26" aria-hidden="true" tabindex="-1"></a>            <span class="op">}</span></span>
<span id="cb104-27"><a href="#cb104-27" aria-hidden="true" tabindex="-1"></a>            <span class="kw">self</span><span class="op">.</span>reentrancy_guard <span class="op">=</span> <span class="cn">true</span><span class="op">;</span></span>
<span id="cb104-28"><a href="#cb104-28" aria-hidden="true" tabindex="-1"></a>            <span class="cn">Ok</span>(())</span>
<span id="cb104-29"><a href="#cb104-29" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb104-30"><a href="#cb104-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb104-31"><a href="#cb104-31" aria-hidden="true" tabindex="-1"></a>        <span class="kw">fn</span> end_non_reentrant(<span class="op">&amp;</span><span class="kw">mut</span> <span class="kw">self</span>) <span class="op">{</span></span>
<span id="cb104-32"><a href="#cb104-32" aria-hidden="true" tabindex="-1"></a>            <span class="kw">self</span><span class="op">.</span>reentrancy_guard <span class="op">=</span> <span class="cn">false</span><span class="op">;</span></span>
<span id="cb104-33"><a href="#cb104-33" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb104-34"><a href="#cb104-34" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb104-35"><a href="#cb104-35" aria-hidden="true" tabindex="-1"></a>        <span class="co">/// Safe cross-contract call with reentrancy protection</span></span>
<span id="cb104-36"><a href="#cb104-36" aria-hidden="true" tabindex="-1"></a>        <span class="at">#[</span>ink<span class="at">(</span>message<span class="at">)]</span></span>
<span id="cb104-37"><a href="#cb104-37" aria-hidden="true" tabindex="-1"></a>        <span class="kw">pub</span> <span class="kw">fn</span> safe_external_call(</span>
<span id="cb104-38"><a href="#cb104-38" aria-hidden="true" tabindex="-1"></a>            <span class="op">&amp;</span><span class="kw">mut</span> <span class="kw">self</span><span class="op">,</span></span>
<span id="cb104-39"><a href="#cb104-39" aria-hidden="true" tabindex="-1"></a>            target<span class="op">:</span> AccountId<span class="op">,</span></span>
<span id="cb104-40"><a href="#cb104-40" aria-hidden="true" tabindex="-1"></a>            selector<span class="op">:</span> [<span class="dt">u8</span><span class="op">;</span> <span class="dv">4</span>]<span class="op">,</span></span>
<span id="cb104-41"><a href="#cb104-41" aria-hidden="true" tabindex="-1"></a>            input<span class="op">:</span> <span class="dt">Vec</span><span class="op">&lt;</span><span class="dt">u8</span><span class="op">&gt;,</span></span>
<span id="cb104-42"><a href="#cb104-42" aria-hidden="true" tabindex="-1"></a>        ) <span class="op">-&gt;</span> <span class="dt">Result</span><span class="op">&lt;</span><span class="dt">Vec</span><span class="op">&lt;</span><span class="dt">u8</span><span class="op">&gt;,</span> <span class="bu">Error</span><span class="op">&gt;</span> <span class="op">{</span></span>
<span id="cb104-43"><a href="#cb104-43" aria-hidden="true" tabindex="-1"></a>            <span class="co">// Reentrancy protection</span></span>
<span id="cb104-44"><a href="#cb104-44" aria-hidden="true" tabindex="-1"></a>            <span class="kw">self</span><span class="op">.</span>non_reentrant()<span class="op">?;</span></span>
<span id="cb104-45"><a href="#cb104-45" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb104-46"><a href="#cb104-46" aria-hidden="true" tabindex="-1"></a>            <span class="co">// Depth protection</span></span>
<span id="cb104-47"><a href="#cb104-47" aria-hidden="true" tabindex="-1"></a>            <span class="kw">const</span> MAX_CALL_DEPTH<span class="op">:</span> <span class="dt">u32</span> <span class="op">=</span> <span class="dv">10</span><span class="op">;</span></span>
<span id="cb104-48"><a href="#cb104-48" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> <span class="kw">self</span><span class="op">.</span>call_depth <span class="op">&gt;=</span> MAX_CALL_DEPTH <span class="op">{</span></span>
<span id="cb104-49"><a href="#cb104-49" aria-hidden="true" tabindex="-1"></a>                <span class="kw">self</span><span class="op">.</span>end_non_reentrant()<span class="op">;</span></span>
<span id="cb104-50"><a href="#cb104-50" aria-hidden="true" tabindex="-1"></a>                <span class="cf">return</span> <span class="cn">Err</span>(<span class="bu">Error</span><span class="pp">::</span>CallDepthExceeded)<span class="op">;</span></span>
<span id="cb104-51"><a href="#cb104-51" aria-hidden="true" tabindex="-1"></a>            <span class="op">}</span></span>
<span id="cb104-52"><a href="#cb104-52" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb104-53"><a href="#cb104-53" aria-hidden="true" tabindex="-1"></a>            <span class="co">// Trust verification</span></span>
<span id="cb104-54"><a href="#cb104-54" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> <span class="op">!</span><span class="kw">self</span><span class="op">.</span>trusted_contracts<span class="op">.</span>get(target)<span class="op">.</span>unwrap_or(<span class="cn">false</span>) <span class="op">{</span></span>
<span id="cb104-55"><a href="#cb104-55" aria-hidden="true" tabindex="-1"></a>                <span class="kw">self</span><span class="op">.</span>end_non_reentrant()<span class="op">;</span></span>
<span id="cb104-56"><a href="#cb104-56" aria-hidden="true" tabindex="-1"></a>                <span class="cf">return</span> <span class="cn">Err</span>(<span class="bu">Error</span><span class="pp">::</span>UntrustedContract)<span class="op">;</span></span>
<span id="cb104-57"><a href="#cb104-57" aria-hidden="true" tabindex="-1"></a>            <span class="op">}</span></span>
<span id="cb104-58"><a href="#cb104-58" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb104-59"><a href="#cb104-59" aria-hidden="true" tabindex="-1"></a>            <span class="kw">self</span><span class="op">.</span>call_depth <span class="op">+=</span> <span class="dv">1</span><span class="op">;</span></span>
<span id="cb104-60"><a href="#cb104-60" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb104-61"><a href="#cb104-61" aria-hidden="true" tabindex="-1"></a>            <span class="co">// Perform the call with gas limit</span></span>
<span id="cb104-62"><a href="#cb104-62" aria-hidden="true" tabindex="-1"></a>            <span class="kw">let</span> result <span class="op">=</span> <span class="pp">ink::env::call::build_call::</span><span class="op">&lt;</span><span class="pp">ink::env::</span>DefaultEnvironment<span class="op">&gt;</span>()</span>
<span id="cb104-63"><a href="#cb104-63" aria-hidden="true" tabindex="-1"></a>                <span class="op">.</span>call(target)</span>
<span id="cb104-64"><a href="#cb104-64" aria-hidden="true" tabindex="-1"></a>                <span class="op">.</span>gas_limit(<span class="dv">100_000</span>) <span class="co">// Limited gas to prevent issues</span></span>
<span id="cb104-65"><a href="#cb104-65" aria-hidden="true" tabindex="-1"></a>                <span class="op">.</span>transferred_value(<span class="dv">0</span>)</span>
<span id="cb104-66"><a href="#cb104-66" aria-hidden="true" tabindex="-1"></a>                <span class="op">.</span>exec_input(</span>
<span id="cb104-67"><a href="#cb104-67" aria-hidden="true" tabindex="-1"></a>                    <span class="pp">ink::env::call::ExecutionInput::</span>new(</span>
<span id="cb104-68"><a href="#cb104-68" aria-hidden="true" tabindex="-1"></a>                        <span class="pp">ink::env::call::Selector::</span>new(selector)</span>
<span id="cb104-69"><a href="#cb104-69" aria-hidden="true" tabindex="-1"></a>                    )<span class="op">.</span>push_arg(input)</span>
<span id="cb104-70"><a href="#cb104-70" aria-hidden="true" tabindex="-1"></a>                )</span>
<span id="cb104-71"><a href="#cb104-71" aria-hidden="true" tabindex="-1"></a>                <span class="op">.</span><span class="pp">returns::</span><span class="op">&lt;</span><span class="dt">Vec</span><span class="op">&lt;</span><span class="dt">u8</span><span class="op">&gt;&gt;</span>()</span>
<span id="cb104-72"><a href="#cb104-72" aria-hidden="true" tabindex="-1"></a>                <span class="op">.</span>try_invoke()<span class="op">;</span></span>
<span id="cb104-73"><a href="#cb104-73" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb104-74"><a href="#cb104-74" aria-hidden="true" tabindex="-1"></a>            <span class="kw">self</span><span class="op">.</span>call_depth <span class="op">-=</span> <span class="dv">1</span><span class="op">;</span></span>
<span id="cb104-75"><a href="#cb104-75" aria-hidden="true" tabindex="-1"></a>            <span class="kw">self</span><span class="op">.</span>end_non_reentrant()<span class="op">;</span></span>
<span id="cb104-76"><a href="#cb104-76" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb104-77"><a href="#cb104-77" aria-hidden="true" tabindex="-1"></a>            <span class="cf">match</span> result <span class="op">{</span></span>
<span id="cb104-78"><a href="#cb104-78" aria-hidden="true" tabindex="-1"></a>                <span class="cn">Ok</span>(<span class="cn">Ok</span>(data)) <span class="op">=&gt;</span> <span class="cn">Ok</span>(data)<span class="op">,</span></span>
<span id="cb104-79"><a href="#cb104-79" aria-hidden="true" tabindex="-1"></a>                <span class="cn">Ok</span>(<span class="cn">Err</span>(_)) <span class="op">=&gt;</span> <span class="cn">Err</span>(<span class="bu">Error</span><span class="pp">::</span>CallReverted)<span class="op">,</span></span>
<span id="cb104-80"><a href="#cb104-80" aria-hidden="true" tabindex="-1"></a>                <span class="cn">Err</span>(_) <span class="op">=&gt;</span> <span class="cn">Err</span>(<span class="bu">Error</span><span class="pp">::</span>CallFailed)<span class="op">,</span></span>
<span id="cb104-81"><a href="#cb104-81" aria-hidden="true" tabindex="-1"></a>            <span class="op">}</span></span>
<span id="cb104-82"><a href="#cb104-82" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb104-83"><a href="#cb104-83" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb104-84"><a href="#cb104-84" aria-hidden="true" tabindex="-1"></a>        <span class="co">/// Add trusted contract (admin only)</span></span>
<span id="cb104-85"><a href="#cb104-85" aria-hidden="true" tabindex="-1"></a>        <span class="at">#[</span>ink<span class="at">(</span>message<span class="at">)]</span></span>
<span id="cb104-86"><a href="#cb104-86" aria-hidden="true" tabindex="-1"></a>        <span class="kw">pub</span> <span class="kw">fn</span> add_trusted_contract(<span class="op">&amp;</span><span class="kw">mut</span> <span class="kw">self</span><span class="op">,</span> contract<span class="op">:</span> AccountId) <span class="op">-&gt;</span> <span class="dt">Result</span><span class="op">&lt;</span>()<span class="op">,</span> <span class="bu">Error</span><span class="op">&gt;</span> <span class="op">{</span></span>
<span id="cb104-87"><a href="#cb104-87" aria-hidden="true" tabindex="-1"></a>            <span class="co">// Admin check omitted for brevity</span></span>
<span id="cb104-88"><a href="#cb104-88" aria-hidden="true" tabindex="-1"></a>            <span class="kw">self</span><span class="op">.</span>trusted_contracts<span class="op">.</span>insert(contract<span class="op">,</span> <span class="op">&amp;</span><span class="cn">true</span>)<span class="op">;</span></span>
<span id="cb104-89"><a href="#cb104-89" aria-hidden="true" tabindex="-1"></a>            <span class="cn">Ok</span>(())</span>
<span id="cb104-90"><a href="#cb104-90" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb104-91"><a href="#cb104-91" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb104-92"><a href="#cb104-92" aria-hidden="true" tabindex="-1"></a>        <span class="co">/// Circuit breaker pattern</span></span>
<span id="cb104-93"><a href="#cb104-93" aria-hidden="true" tabindex="-1"></a>        <span class="at">#[</span>ink<span class="at">(</span>message<span class="at">)]</span></span>
<span id="cb104-94"><a href="#cb104-94" aria-hidden="true" tabindex="-1"></a>        <span class="kw">pub</span> <span class="kw">fn</span> emergency_stop(<span class="op">&amp;</span><span class="kw">mut</span> <span class="kw">self</span>) <span class="op">-&gt;</span> <span class="dt">Result</span><span class="op">&lt;</span>()<span class="op">,</span> <span class="bu">Error</span><span class="op">&gt;</span> <span class="op">{</span></span>
<span id="cb104-95"><a href="#cb104-95" aria-hidden="true" tabindex="-1"></a>            <span class="co">// Admin check omitted for brevity</span></span>
<span id="cb104-96"><a href="#cb104-96" aria-hidden="true" tabindex="-1"></a>            <span class="co">// In emergency, disable all cross-contract calls</span></span>
<span id="cb104-97"><a href="#cb104-97" aria-hidden="true" tabindex="-1"></a>            <span class="co">// Implementation would set a global flag</span></span>
<span id="cb104-98"><a href="#cb104-98" aria-hidden="true" tabindex="-1"></a>            <span class="cn">Ok</span>(())</span>
<span id="cb104-99"><a href="#cb104-99" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb104-100"><a href="#cb104-100" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb104-101"><a href="#cb104-101" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<h3 id="cross-contract-call-patterns-for-defi">Cross-Contract Call
Patterns for DeFi</h3>
<p>Implement common DeFi patterns using cross-contract composition:</p>
<div class="sourceCode" id="cb105"><pre
class="sourceCode rust"><code class="sourceCode rust"><span id="cb105-1"><a href="#cb105-1" aria-hidden="true" tabindex="-1"></a><span class="at">#[</span><span class="pp">ink::</span>trait_definition<span class="at">]</span></span>
<span id="cb105-2"><a href="#cb105-2" aria-hidden="true" tabindex="-1"></a><span class="kw">pub</span> <span class="kw">trait</span> PriceOracle <span class="op">{</span></span>
<span id="cb105-3"><a href="#cb105-3" aria-hidden="true" tabindex="-1"></a>    <span class="at">#[</span>ink<span class="at">(</span>message<span class="at">)]</span></span>
<span id="cb105-4"><a href="#cb105-4" aria-hidden="true" tabindex="-1"></a>    <span class="kw">fn</span> get_price(<span class="op">&amp;</span><span class="kw">self</span><span class="op">,</span> token<span class="op">:</span> AccountId) <span class="op">-&gt;</span> <span class="dt">Result</span><span class="op">&lt;</span>Balance<span class="op">,</span> <span class="bu">Error</span><span class="op">&gt;;</span></span>
<span id="cb105-5"><a href="#cb105-5" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb105-6"><a href="#cb105-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb105-7"><a href="#cb105-7" aria-hidden="true" tabindex="-1"></a><span class="at">#[</span><span class="pp">ink::</span>trait_definition<span class="at">]</span></span>
<span id="cb105-8"><a href="#cb105-8" aria-hidden="true" tabindex="-1"></a><span class="kw">pub</span> <span class="kw">trait</span> LiquidityPool <span class="op">{</span></span>
<span id="cb105-9"><a href="#cb105-9" aria-hidden="true" tabindex="-1"></a>    <span class="at">#[</span>ink<span class="at">(</span>message<span class="at">)]</span></span>
<span id="cb105-10"><a href="#cb105-10" aria-hidden="true" tabindex="-1"></a>    <span class="kw">fn</span> swap(<span class="op">&amp;</span><span class="kw">mut</span> <span class="kw">self</span><span class="op">,</span> token_in<span class="op">:</span> AccountId<span class="op">,</span> token_out<span class="op">:</span> AccountId<span class="op">,</span> amount_in<span class="op">:</span> Balance) <span class="op">-&gt;</span> <span class="dt">Result</span><span class="op">&lt;</span>Balance<span class="op">,</span> <span class="bu">Error</span><span class="op">&gt;;</span></span>
<span id="cb105-11"><a href="#cb105-11" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb105-12"><a href="#cb105-12" aria-hidden="true" tabindex="-1"></a>    <span class="at">#[</span>ink<span class="at">(</span>message<span class="at">)]</span></span>
<span id="cb105-13"><a href="#cb105-13" aria-hidden="true" tabindex="-1"></a>    <span class="kw">fn</span> add_liquidity(<span class="op">&amp;</span><span class="kw">mut</span> <span class="kw">self</span><span class="op">,</span> token_a<span class="op">:</span> AccountId<span class="op">,</span> token_b<span class="op">:</span> AccountId<span class="op">,</span> amount_a<span class="op">:</span> Balance<span class="op">,</span> amount_b<span class="op">:</span> Balance) <span class="op">-&gt;</span> <span class="dt">Result</span><span class="op">&lt;</span>()<span class="op">,</span> <span class="bu">Error</span><span class="op">&gt;;</span></span>
<span id="cb105-14"><a href="#cb105-14" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb105-15"><a href="#cb105-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb105-16"><a href="#cb105-16" aria-hidden="true" tabindex="-1"></a><span class="at">#[</span><span class="pp">ink::</span>contract<span class="at">]</span></span>
<span id="cb105-17"><a href="#cb105-17" aria-hidden="true" tabindex="-1"></a><span class="kw">mod</span> defi_aggregator <span class="op">{</span></span>
<span id="cb105-18"><a href="#cb105-18" aria-hidden="true" tabindex="-1"></a>    <span class="kw">use</span> <span class="kw">super</span><span class="pp">::</span><span class="op">{</span>PriceOracle<span class="op">,</span> LiquidityPool<span class="op">,</span> Token<span class="op">};</span></span>
<span id="cb105-19"><a href="#cb105-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb105-20"><a href="#cb105-20" aria-hidden="true" tabindex="-1"></a>    <span class="at">#[</span>ink<span class="at">(</span>storage<span class="at">)]</span></span>
<span id="cb105-21"><a href="#cb105-21" aria-hidden="true" tabindex="-1"></a>    <span class="kw">pub</span> <span class="kw">struct</span> DeFiAggregator <span class="op">{</span></span>
<span id="cb105-22"><a href="#cb105-22" aria-hidden="true" tabindex="-1"></a>        price_oracle<span class="op">:</span> AccountId<span class="op">,</span></span>
<span id="cb105-23"><a href="#cb105-23" aria-hidden="true" tabindex="-1"></a>        liquidity_pools<span class="op">:</span> <span class="dt">Vec</span><span class="op">&lt;</span>AccountId<span class="op">&gt;,</span></span>
<span id="cb105-24"><a href="#cb105-24" aria-hidden="true" tabindex="-1"></a>        supported_tokens<span class="op">:</span> <span class="pp">ink::storage::</span>Mapping<span class="op">&lt;</span>AccountId<span class="op">,</span> <span class="dt">bool</span><span class="op">&gt;,</span></span>
<span id="cb105-25"><a href="#cb105-25" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb105-26"><a href="#cb105-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb105-27"><a href="#cb105-27" aria-hidden="true" tabindex="-1"></a>    <span class="kw">impl</span> DeFiAggregator <span class="op">{</span></span>
<span id="cb105-28"><a href="#cb105-28" aria-hidden="true" tabindex="-1"></a>        <span class="at">#[</span>ink<span class="at">(</span>constructor<span class="at">)]</span></span>
<span id="cb105-29"><a href="#cb105-29" aria-hidden="true" tabindex="-1"></a>        <span class="kw">pub</span> <span class="kw">fn</span> new(price_oracle<span class="op">:</span> AccountId) <span class="op">-&gt;</span> <span class="dt">Self</span> <span class="op">{</span></span>
<span id="cb105-30"><a href="#cb105-30" aria-hidden="true" tabindex="-1"></a>            <span class="dt">Self</span> <span class="op">{</span></span>
<span id="cb105-31"><a href="#cb105-31" aria-hidden="true" tabindex="-1"></a>                price_oracle<span class="op">,</span></span>
<span id="cb105-32"><a href="#cb105-32" aria-hidden="true" tabindex="-1"></a>                liquidity_pools<span class="op">:</span> <span class="dt">Vec</span><span class="pp">::</span>new()<span class="op">,</span></span>
<span id="cb105-33"><a href="#cb105-33" aria-hidden="true" tabindex="-1"></a>                supported_tokens<span class="op">:</span> <span class="pp">ink::storage::Mapping::</span><span class="kw">default</span>()<span class="op">,</span></span>
<span id="cb105-34"><a href="#cb105-34" aria-hidden="true" tabindex="-1"></a>            <span class="op">}</span></span>
<span id="cb105-35"><a href="#cb105-35" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb105-36"><a href="#cb105-36" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb105-37"><a href="#cb105-37" aria-hidden="true" tabindex="-1"></a>        <span class="co">/// Find best swap rate across multiple pools</span></span>
<span id="cb105-38"><a href="#cb105-38" aria-hidden="true" tabindex="-1"></a>        <span class="at">#[</span>ink<span class="at">(</span>message<span class="at">)]</span></span>
<span id="cb105-39"><a href="#cb105-39" aria-hidden="true" tabindex="-1"></a>        <span class="kw">pub</span> <span class="kw">fn</span> find_best_swap(</span>
<span id="cb105-40"><a href="#cb105-40" aria-hidden="true" tabindex="-1"></a>            <span class="op">&amp;</span><span class="kw">self</span><span class="op">,</span></span>
<span id="cb105-41"><a href="#cb105-41" aria-hidden="true" tabindex="-1"></a>            token_in<span class="op">:</span> AccountId<span class="op">,</span></span>
<span id="cb105-42"><a href="#cb105-42" aria-hidden="true" tabindex="-1"></a>            token_out<span class="op">:</span> AccountId<span class="op">,</span></span>
<span id="cb105-43"><a href="#cb105-43" aria-hidden="true" tabindex="-1"></a>            amount_in<span class="op">:</span> Balance<span class="op">,</span></span>
<span id="cb105-44"><a href="#cb105-44" aria-hidden="true" tabindex="-1"></a>        ) <span class="op">-&gt;</span> <span class="dt">Result</span><span class="op">&lt;</span>(AccountId<span class="op">,</span> Balance)<span class="op">,</span> <span class="bu">Error</span><span class="op">&gt;</span> <span class="op">{</span></span>
<span id="cb105-45"><a href="#cb105-45" aria-hidden="true" tabindex="-1"></a>            <span class="kw">let</span> <span class="kw">mut</span> best_pool <span class="op">=</span> <span class="pp">AccountId::</span>from([<span class="dv">0</span><span class="op">;</span> <span class="dv">32</span>])<span class="op">;</span></span>
<span id="cb105-46"><a href="#cb105-46" aria-hidden="true" tabindex="-1"></a>            <span class="kw">let</span> <span class="kw">mut</span> best_output <span class="op">=</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb105-47"><a href="#cb105-47" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb105-48"><a href="#cb105-48" aria-hidden="true" tabindex="-1"></a>            <span class="co">// Check each pool for best rate</span></span>
<span id="cb105-49"><a href="#cb105-49" aria-hidden="true" tabindex="-1"></a>            <span class="cf">for</span> pool_address <span class="kw">in</span> <span class="op">&amp;</span><span class="kw">self</span><span class="op">.</span>liquidity_pools <span class="op">{</span></span>
<span id="cb105-50"><a href="#cb105-50" aria-hidden="true" tabindex="-1"></a>                <span class="co">// Simulate swap to get output amount</span></span>
<span id="cb105-51"><a href="#cb105-51" aria-hidden="true" tabindex="-1"></a>                <span class="kw">let</span> pool<span class="op">:</span> <span class="pp">ink::contract_ref!</span>(LiquidityPool) <span class="op">=</span> (<span class="op">*</span>pool_address)<span class="op">.</span>into()<span class="op">;</span></span>
<span id="cb105-52"><a href="#cb105-52" aria-hidden="true" tabindex="-1"></a>                </span>
<span id="cb105-53"><a href="#cb105-53" aria-hidden="true" tabindex="-1"></a>                <span class="co">// In a real implementation, you&#39;d call a view function</span></span>
<span id="cb105-54"><a href="#cb105-54" aria-hidden="true" tabindex="-1"></a>                <span class="co">// that simulates the swap without executing it</span></span>
<span id="cb105-55"><a href="#cb105-55" aria-hidden="true" tabindex="-1"></a>                <span class="cf">if</span> <span class="kw">let</span> <span class="cn">Ok</span>(output) <span class="op">=</span> <span class="kw">self</span><span class="op">.</span>simulate_swap(pool_address<span class="op">,</span> token_in<span class="op">,</span> token_out<span class="op">,</span> amount_in) <span class="op">{</span></span>
<span id="cb105-56"><a href="#cb105-56" aria-hidden="true" tabindex="-1"></a>                    <span class="cf">if</span> output <span class="op">&gt;</span> best_output <span class="op">{</span></span>
<span id="cb105-57"><a href="#cb105-57" aria-hidden="true" tabindex="-1"></a>                        best_output <span class="op">=</span> output<span class="op">;</span></span>
<span id="cb105-58"><a href="#cb105-58" aria-hidden="true" tabindex="-1"></a>                        best_pool <span class="op">=</span> <span class="op">*</span>pool_address<span class="op">;</span></span>
<span id="cb105-59"><a href="#cb105-59" aria-hidden="true" tabindex="-1"></a>                    <span class="op">}</span></span>
<span id="cb105-60"><a href="#cb105-60" aria-hidden="true" tabindex="-1"></a>                <span class="op">}</span></span>
<span id="cb105-61"><a href="#cb105-61" aria-hidden="true" tabindex="-1"></a>            <span class="op">}</span></span>
<span id="cb105-62"><a href="#cb105-62" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb105-63"><a href="#cb105-63" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> best_output <span class="op">==</span> <span class="dv">0</span> <span class="op">{</span></span>
<span id="cb105-64"><a href="#cb105-64" aria-hidden="true" tabindex="-1"></a>                <span class="cf">return</span> <span class="cn">Err</span>(<span class="bu">Error</span><span class="pp">::</span>NoLiquidityFound)<span class="op">;</span></span>
<span id="cb105-65"><a href="#cb105-65" aria-hidden="true" tabindex="-1"></a>            <span class="op">}</span></span>
<span id="cb105-66"><a href="#cb105-66" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb105-67"><a href="#cb105-67" aria-hidden="true" tabindex="-1"></a>            <span class="cn">Ok</span>((best_pool<span class="op">,</span> best_output))</span>
<span id="cb105-68"><a href="#cb105-68" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb105-69"><a href="#cb105-69" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb105-70"><a href="#cb105-70" aria-hidden="true" tabindex="-1"></a>        <span class="co">/// Execute optimal swap</span></span>
<span id="cb105-71"><a href="#cb105-71" aria-hidden="true" tabindex="-1"></a>        <span class="at">#[</span>ink<span class="at">(</span>message<span class="at">)]</span></span>
<span id="cb105-72"><a href="#cb105-72" aria-hidden="true" tabindex="-1"></a>        <span class="kw">pub</span> <span class="kw">fn</span> optimal_swap(</span>
<span id="cb105-73"><a href="#cb105-73" aria-hidden="true" tabindex="-1"></a>            <span class="op">&amp;</span><span class="kw">mut</span> <span class="kw">self</span><span class="op">,</span></span>
<span id="cb105-74"><a href="#cb105-74" aria-hidden="true" tabindex="-1"></a>            token_in<span class="op">:</span> AccountId<span class="op">,</span></span>
<span id="cb105-75"><a href="#cb105-75" aria-hidden="true" tabindex="-1"></a>            token_out<span class="op">:</span> AccountId<span class="op">,</span></span>
<span id="cb105-76"><a href="#cb105-76" aria-hidden="true" tabindex="-1"></a>            amount_in<span class="op">:</span> Balance<span class="op">,</span></span>
<span id="cb105-77"><a href="#cb105-77" aria-hidden="true" tabindex="-1"></a>            min_amount_out<span class="op">:</span> Balance<span class="op">,</span></span>
<span id="cb105-78"><a href="#cb105-78" aria-hidden="true" tabindex="-1"></a>        ) <span class="op">-&gt;</span> <span class="dt">Result</span><span class="op">&lt;</span>Balance<span class="op">,</span> <span class="bu">Error</span><span class="op">&gt;</span> <span class="op">{</span></span>
<span id="cb105-79"><a href="#cb105-79" aria-hidden="true" tabindex="-1"></a>            <span class="co">// Find best pool</span></span>
<span id="cb105-80"><a href="#cb105-80" aria-hidden="true" tabindex="-1"></a>            <span class="kw">let</span> (best_pool<span class="op">,</span> expected_output) <span class="op">=</span> <span class="kw">self</span><span class="op">.</span>find_best_swap(token_in<span class="op">,</span> token_out<span class="op">,</span> amount_in)<span class="op">?;</span></span>
<span id="cb105-81"><a href="#cb105-81" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb105-82"><a href="#cb105-82" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> expected_output <span class="op">&lt;</span> min_amount_out <span class="op">{</span></span>
<span id="cb105-83"><a href="#cb105-83" aria-hidden="true" tabindex="-1"></a>                <span class="cf">return</span> <span class="cn">Err</span>(<span class="bu">Error</span><span class="pp">::</span>SlippageTooHigh)<span class="op">;</span></span>
<span id="cb105-84"><a href="#cb105-84" aria-hidden="true" tabindex="-1"></a>            <span class="op">}</span></span>
<span id="cb105-85"><a href="#cb105-85" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb105-86"><a href="#cb105-86" aria-hidden="true" tabindex="-1"></a>            <span class="co">// Transfer tokens from user to this contract</span></span>
<span id="cb105-87"><a href="#cb105-87" aria-hidden="true" tabindex="-1"></a>            <span class="kw">let</span> <span class="kw">mut</span> token_contract<span class="op">:</span> <span class="pp">ink::contract_ref!</span>(Token) <span class="op">=</span> token_in<span class="op">.</span>into()<span class="op">;</span></span>
<span id="cb105-88"><a href="#cb105-88" aria-hidden="true" tabindex="-1"></a>            token_contract<span class="op">.</span>transfer(<span class="kw">self</span><span class="op">.</span>env()<span class="op">.</span>account_id()<span class="op">,</span> amount_in)</span>
<span id="cb105-89"><a href="#cb105-89" aria-hidden="true" tabindex="-1"></a>                <span class="op">.</span>map_err(<span class="op">|</span>_<span class="op">|</span> <span class="bu">Error</span><span class="pp">::</span>TransferFailed)<span class="op">?;</span></span>
<span id="cb105-90"><a href="#cb105-90" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb105-91"><a href="#cb105-91" aria-hidden="true" tabindex="-1"></a>            <span class="co">// Execute swap through best pool</span></span>
<span id="cb105-92"><a href="#cb105-92" aria-hidden="true" tabindex="-1"></a>            <span class="kw">let</span> <span class="kw">mut</span> pool<span class="op">:</span> <span class="pp">ink::contract_ref!</span>(LiquidityPool) <span class="op">=</span> best_pool<span class="op">.</span>into()<span class="op">;</span></span>
<span id="cb105-93"><a href="#cb105-93" aria-hidden="true" tabindex="-1"></a>            <span class="kw">let</span> actual_output <span class="op">=</span> pool<span class="op">.</span>swap(token_in<span class="op">,</span> token_out<span class="op">,</span> amount_in)</span>
<span id="cb105-94"><a href="#cb105-94" aria-hidden="true" tabindex="-1"></a>                <span class="op">.</span>map_err(<span class="op">|</span>_<span class="op">|</span> <span class="bu">Error</span><span class="pp">::</span>SwapFailed)<span class="op">?;</span></span>
<span id="cb105-95"><a href="#cb105-95" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb105-96"><a href="#cb105-96" aria-hidden="true" tabindex="-1"></a>            <span class="co">// Transfer output tokens to user</span></span>
<span id="cb105-97"><a href="#cb105-97" aria-hidden="true" tabindex="-1"></a>            <span class="kw">let</span> <span class="kw">mut</span> output_token<span class="op">:</span> <span class="pp">ink::contract_ref!</span>(Token) <span class="op">=</span> token_out<span class="op">.</span>into()<span class="op">;</span></span>
<span id="cb105-98"><a href="#cb105-98" aria-hidden="true" tabindex="-1"></a>            output_token<span class="op">.</span>transfer(<span class="kw">self</span><span class="op">.</span>env()<span class="op">.</span>caller()<span class="op">,</span> actual_output)</span>
<span id="cb105-99"><a href="#cb105-99" aria-hidden="true" tabindex="-1"></a>                <span class="op">.</span>map_err(<span class="op">|</span>_<span class="op">|</span> <span class="bu">Error</span><span class="pp">::</span>TransferFailed)<span class="op">?;</span></span>
<span id="cb105-100"><a href="#cb105-100" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb105-101"><a href="#cb105-101" aria-hidden="true" tabindex="-1"></a>            <span class="cn">Ok</span>(actual_output)</span>
<span id="cb105-102"><a href="#cb105-102" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb105-103"><a href="#cb105-103" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb105-104"><a href="#cb105-104" aria-hidden="true" tabindex="-1"></a>        <span class="co">/// Price-aware arbitrage execution</span></span>
<span id="cb105-105"><a href="#cb105-105" aria-hidden="true" tabindex="-1"></a>        <span class="at">#[</span>ink<span class="at">(</span>message<span class="at">)]</span></span>
<span id="cb105-106"><a href="#cb105-106" aria-hidden="true" tabindex="-1"></a>        <span class="kw">pub</span> <span class="kw">fn</span> execute_arbitrage(</span>
<span id="cb105-107"><a href="#cb105-107" aria-hidden="true" tabindex="-1"></a>            <span class="op">&amp;</span><span class="kw">mut</span> <span class="kw">self</span><span class="op">,</span></span>
<span id="cb105-108"><a href="#cb105-108" aria-hidden="true" tabindex="-1"></a>            token_a<span class="op">:</span> AccountId<span class="op">,</span></span>
<span id="cb105-109"><a href="#cb105-109" aria-hidden="true" tabindex="-1"></a>            token_b<span class="op">:</span> AccountId<span class="op">,</span></span>
<span id="cb105-110"><a href="#cb105-110" aria-hidden="true" tabindex="-1"></a>            amount<span class="op">:</span> Balance<span class="op">,</span></span>
<span id="cb105-111"><a href="#cb105-111" aria-hidden="true" tabindex="-1"></a>        ) <span class="op">-&gt;</span> <span class="dt">Result</span><span class="op">&lt;</span>Balance<span class="op">,</span> <span class="bu">Error</span><span class="op">&gt;</span> <span class="op">{</span></span>
<span id="cb105-112"><a href="#cb105-112" aria-hidden="true" tabindex="-1"></a>            <span class="co">// Get oracle price</span></span>
<span id="cb105-113"><a href="#cb105-113" aria-hidden="true" tabindex="-1"></a>            <span class="kw">let</span> oracle<span class="op">:</span> <span class="pp">ink::contract_ref!</span>(PriceOracle) <span class="op">=</span> <span class="kw">self</span><span class="op">.</span>price_oracle<span class="op">.</span>into()<span class="op">;</span></span>
<span id="cb105-114"><a href="#cb105-114" aria-hidden="true" tabindex="-1"></a>            <span class="kw">let</span> oracle_price <span class="op">=</span> oracle<span class="op">.</span>get_price(token_a)<span class="op">?;</span></span>
<span id="cb105-115"><a href="#cb105-115" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb105-116"><a href="#cb105-116" aria-hidden="true" tabindex="-1"></a>            <span class="co">// Find pools with price deviation</span></span>
<span id="cb105-117"><a href="#cb105-117" aria-hidden="true" tabindex="-1"></a>            <span class="kw">let</span> <span class="kw">mut</span> profitable_pools <span class="op">=</span> <span class="dt">Vec</span><span class="pp">::</span>new()<span class="op">;</span></span>
<span id="cb105-118"><a href="#cb105-118" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb105-119"><a href="#cb105-119" aria-hidden="true" tabindex="-1"></a>            <span class="cf">for</span> pool <span class="kw">in</span> <span class="op">&amp;</span><span class="kw">self</span><span class="op">.</span>liquidity_pools <span class="op">{</span></span>
<span id="cb105-120"><a href="#cb105-120" aria-hidden="true" tabindex="-1"></a>                <span class="cf">if</span> <span class="kw">let</span> <span class="cn">Ok</span>(pool_price) <span class="op">=</span> <span class="kw">self</span><span class="op">.</span>get_pool_price(<span class="op">*</span>pool<span class="op">,</span> token_a<span class="op">,</span> token_b) <span class="op">{</span></span>
<span id="cb105-121"><a href="#cb105-121" aria-hidden="true" tabindex="-1"></a>                    <span class="kw">let</span> price_diff <span class="op">=</span> <span class="cf">if</span> pool_price <span class="op">&gt;</span> oracle_price <span class="op">{</span></span>
<span id="cb105-122"><a href="#cb105-122" aria-hidden="true" tabindex="-1"></a>                        pool_price <span class="op">-</span> oracle_price</span>
<span id="cb105-123"><a href="#cb105-123" aria-hidden="true" tabindex="-1"></a>                    <span class="op">}</span> <span class="cf">else</span> <span class="op">{</span></span>
<span id="cb105-124"><a href="#cb105-124" aria-hidden="true" tabindex="-1"></a>                        oracle_price <span class="op">-</span> pool_price</span>
<span id="cb105-125"><a href="#cb105-125" aria-hidden="true" tabindex="-1"></a>                    <span class="op">};</span></span>
<span id="cb105-126"><a href="#cb105-126" aria-hidden="true" tabindex="-1"></a>                    </span>
<span id="cb105-127"><a href="#cb105-127" aria-hidden="true" tabindex="-1"></a>                    <span class="co">// 1% threshold for profitability</span></span>
<span id="cb105-128"><a href="#cb105-128" aria-hidden="true" tabindex="-1"></a>                    <span class="cf">if</span> price_diff <span class="op">&gt;</span> oracle_price <span class="op">/</span> <span class="dv">100</span> <span class="op">{</span></span>
<span id="cb105-129"><a href="#cb105-129" aria-hidden="true" tabindex="-1"></a>                        profitable_pools<span class="op">.</span>push((<span class="op">*</span>pool<span class="op">,</span> pool_price))<span class="op">;</span></span>
<span id="cb105-130"><a href="#cb105-130" aria-hidden="true" tabindex="-1"></a>                    <span class="op">}</span></span>
<span id="cb105-131"><a href="#cb105-131" aria-hidden="true" tabindex="-1"></a>                <span class="op">}</span></span>
<span id="cb105-132"><a href="#cb105-132" aria-hidden="true" tabindex="-1"></a>            <span class="op">}</span></span>
<span id="cb105-133"><a href="#cb105-133" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb105-134"><a href="#cb105-134" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> profitable_pools<span class="op">.</span>is_empty() <span class="op">{</span></span>
<span id="cb105-135"><a href="#cb105-135" aria-hidden="true" tabindex="-1"></a>                <span class="cf">return</span> <span class="cn">Err</span>(<span class="bu">Error</span><span class="pp">::</span>NoArbitrageOpportunity)<span class="op">;</span></span>
<span id="cb105-136"><a href="#cb105-136" aria-hidden="true" tabindex="-1"></a>            <span class="op">}</span></span>
<span id="cb105-137"><a href="#cb105-137" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb105-138"><a href="#cb105-138" aria-hidden="true" tabindex="-1"></a>            <span class="co">// Execute arbitrage (simplified)</span></span>
<span id="cb105-139"><a href="#cb105-139" aria-hidden="true" tabindex="-1"></a>            <span class="co">// In practice, this would involve complex multi-step swaps</span></span>
<span id="cb105-140"><a href="#cb105-140" aria-hidden="true" tabindex="-1"></a>            <span class="cn">Ok</span>(<span class="dv">0</span>) <span class="co">// Placeholder return</span></span>
<span id="cb105-141"><a href="#cb105-141" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb105-142"><a href="#cb105-142" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb105-143"><a href="#cb105-143" aria-hidden="true" tabindex="-1"></a>        <span class="co">/// Helper function to simulate swap without execution</span></span>
<span id="cb105-144"><a href="#cb105-144" aria-hidden="true" tabindex="-1"></a>        <span class="kw">fn</span> simulate_swap(</span>
<span id="cb105-145"><a href="#cb105-145" aria-hidden="true" tabindex="-1"></a>            <span class="op">&amp;</span><span class="kw">self</span><span class="op">,</span></span>
<span id="cb105-146"><a href="#cb105-146" aria-hidden="true" tabindex="-1"></a>            pool<span class="op">:</span> <span class="op">&amp;</span>AccountId<span class="op">,</span></span>
<span id="cb105-147"><a href="#cb105-147" aria-hidden="true" tabindex="-1"></a>            token_in<span class="op">:</span> AccountId<span class="op">,</span></span>
<span id="cb105-148"><a href="#cb105-148" aria-hidden="true" tabindex="-1"></a>            token_out<span class="op">:</span> AccountId<span class="op">,</span></span>
<span id="cb105-149"><a href="#cb105-149" aria-hidden="true" tabindex="-1"></a>            amount_in<span class="op">:</span> Balance<span class="op">,</span></span>
<span id="cb105-150"><a href="#cb105-150" aria-hidden="true" tabindex="-1"></a>        ) <span class="op">-&gt;</span> <span class="dt">Result</span><span class="op">&lt;</span>Balance<span class="op">,</span> <span class="bu">Error</span><span class="op">&gt;</span> <span class="op">{</span></span>
<span id="cb105-151"><a href="#cb105-151" aria-hidden="true" tabindex="-1"></a>            <span class="co">// In practice, this would call a view function on the pool</span></span>
<span id="cb105-152"><a href="#cb105-152" aria-hidden="true" tabindex="-1"></a>            <span class="co">// that calculates output without state changes</span></span>
<span id="cb105-153"><a href="#cb105-153" aria-hidden="true" tabindex="-1"></a>            <span class="cn">Ok</span>(<span class="dv">0</span>) <span class="co">// Placeholder</span></span>
<span id="cb105-154"><a href="#cb105-154" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb105-155"><a href="#cb105-155" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb105-156"><a href="#cb105-156" aria-hidden="true" tabindex="-1"></a>        <span class="kw">fn</span> get_pool_price(</span>
<span id="cb105-157"><a href="#cb105-157" aria-hidden="true" tabindex="-1"></a>            <span class="op">&amp;</span><span class="kw">self</span><span class="op">,</span></span>
<span id="cb105-158"><a href="#cb105-158" aria-hidden="true" tabindex="-1"></a>            pool<span class="op">:</span> AccountId<span class="op">,</span></span>
<span id="cb105-159"><a href="#cb105-159" aria-hidden="true" tabindex="-1"></a>            token_a<span class="op">:</span> AccountId<span class="op">,</span></span>
<span id="cb105-160"><a href="#cb105-160" aria-hidden="true" tabindex="-1"></a>            token_b<span class="op">:</span> AccountId<span class="op">,</span></span>
<span id="cb105-161"><a href="#cb105-161" aria-hidden="true" tabindex="-1"></a>        ) <span class="op">-&gt;</span> <span class="dt">Result</span><span class="op">&lt;</span>Balance<span class="op">,</span> <span class="bu">Error</span><span class="op">&gt;</span> <span class="op">{</span></span>
<span id="cb105-162"><a href="#cb105-162" aria-hidden="true" tabindex="-1"></a>            <span class="co">// Get current pool price for token pair</span></span>
<span id="cb105-163"><a href="#cb105-163" aria-hidden="true" tabindex="-1"></a>            <span class="cn">Ok</span>(<span class="dv">0</span>) <span class="co">// Placeholder</span></span>
<span id="cb105-164"><a href="#cb105-164" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb105-165"><a href="#cb105-165" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb105-166"><a href="#cb105-166" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<h2 id="testing-interoperability">Testing Interoperability</h2>
<p>Comprehensive testing for events and cross-contract calls:</p>
<div class="sourceCode" id="cb106"><pre
class="sourceCode rust"><code class="sourceCode rust"><span id="cb106-1"><a href="#cb106-1" aria-hidden="true" tabindex="-1"></a><span class="at">#[</span>cfg<span class="at">(</span>test<span class="at">)]</span></span>
<span id="cb106-2"><a href="#cb106-2" aria-hidden="true" tabindex="-1"></a><span class="kw">mod</span> tests <span class="op">{</span></span>
<span id="cb106-3"><a href="#cb106-3" aria-hidden="true" tabindex="-1"></a>    <span class="kw">use</span> <span class="kw">super</span><span class="pp">::</span><span class="op">*;</span></span>
<span id="cb106-4"><a href="#cb106-4" aria-hidden="true" tabindex="-1"></a>    <span class="kw">use</span> <span class="pp">ink::env::</span>test<span class="op">;</span></span>
<span id="cb106-5"><a href="#cb106-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-6"><a href="#cb106-6" aria-hidden="true" tabindex="-1"></a>    <span class="at">#[</span><span class="pp">ink::</span>test<span class="at">]</span></span>
<span id="cb106-7"><a href="#cb106-7" aria-hidden="true" tabindex="-1"></a>    <span class="kw">fn</span> event_emission_works() <span class="op">{</span></span>
<span id="cb106-8"><a href="#cb106-8" aria-hidden="true" tabindex="-1"></a>        <span class="kw">let</span> <span class="kw">mut</span> contract <span class="op">=</span> <span class="pp">EventContract::</span>new()<span class="op">;</span></span>
<span id="cb106-9"><a href="#cb106-9" aria-hidden="true" tabindex="-1"></a>        <span class="kw">let</span> alice <span class="op">=</span> <span class="pp">AccountId::</span>from([<span class="dv">1</span><span class="op">;</span> <span class="dv">32</span>])<span class="op">;</span></span>
<span id="cb106-10"><a href="#cb106-10" aria-hidden="true" tabindex="-1"></a>        <span class="kw">let</span> bob <span class="op">=</span> <span class="pp">AccountId::</span>from([<span class="dv">2</span><span class="op">;</span> <span class="dv">32</span>])<span class="op">;</span></span>
<span id="cb106-11"><a href="#cb106-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-12"><a href="#cb106-12" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Set up initial balance</span></span>
<span id="cb106-13"><a href="#cb106-13" aria-hidden="true" tabindex="-1"></a>        contract<span class="op">.</span>balances<span class="op">.</span>insert(alice<span class="op">,</span> <span class="op">&amp;</span><span class="dv">1000</span>)<span class="op">;</span></span>
<span id="cb106-14"><a href="#cb106-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-15"><a href="#cb106-15" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Capture emitted events</span></span>
<span id="cb106-16"><a href="#cb106-16" aria-hidden="true" tabindex="-1"></a>        <span class="kw">let</span> emitted_events <span class="op">=</span> <span class="pp">test::</span>recorded_events()<span class="op">.</span><span class="pp">collect::</span><span class="op">&lt;</span><span class="dt">Vec</span><span class="op">&lt;</span>_<span class="op">&gt;&gt;</span>()<span class="op">;</span></span>
<span id="cb106-17"><a href="#cb106-17" aria-hidden="true" tabindex="-1"></a>        <span class="kw">let</span> events_before <span class="op">=</span> emitted_events<span class="op">.</span>len()<span class="op">;</span></span>
<span id="cb106-18"><a href="#cb106-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-19"><a href="#cb106-19" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Execute transfer</span></span>
<span id="cb106-20"><a href="#cb106-20" aria-hidden="true" tabindex="-1"></a>        <span class="pp">assert!</span>(contract<span class="op">.</span>transfer(bob<span class="op">,</span> <span class="dv">100</span>)<span class="op">.</span>is_ok())<span class="op">;</span></span>
<span id="cb106-21"><a href="#cb106-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-22"><a href="#cb106-22" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Check event emission</span></span>
<span id="cb106-23"><a href="#cb106-23" aria-hidden="true" tabindex="-1"></a>        <span class="kw">let</span> emitted_events <span class="op">=</span> <span class="pp">test::</span>recorded_events()<span class="op">.</span><span class="pp">collect::</span><span class="op">&lt;</span><span class="dt">Vec</span><span class="op">&lt;</span>_<span class="op">&gt;&gt;</span>()<span class="op">;</span></span>
<span id="cb106-24"><a href="#cb106-24" aria-hidden="true" tabindex="-1"></a>        <span class="pp">assert_eq!</span>(emitted_events<span class="op">.</span>len()<span class="op">,</span> events_before <span class="op">+</span> <span class="dv">1</span>)<span class="op">;</span></span>
<span id="cb106-25"><a href="#cb106-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-26"><a href="#cb106-26" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Decode and verify event</span></span>
<span id="cb106-27"><a href="#cb106-27" aria-hidden="true" tabindex="-1"></a>        <span class="kw">let</span> event <span class="op">=</span> <span class="op">&amp;</span>emitted_events[events_before]<span class="op">;</span></span>
<span id="cb106-28"><a href="#cb106-28" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Event verification logic would go here</span></span>
<span id="cb106-29"><a href="#cb106-29" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb106-30"><a href="#cb106-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-31"><a href="#cb106-31" aria-hidden="true" tabindex="-1"></a>    <span class="at">#[</span><span class="pp">ink::</span>test<span class="at">]</span></span>
<span id="cb106-32"><a href="#cb106-32" aria-hidden="true" tabindex="-1"></a>    <span class="kw">fn</span> cross_contract_call_simulation() <span class="op">{</span></span>
<span id="cb106-33"><a href="#cb106-33" aria-hidden="true" tabindex="-1"></a>        <span class="co">// This would typically require a more complex test setup</span></span>
<span id="cb106-34"><a href="#cb106-34" aria-hidden="true" tabindex="-1"></a>        <span class="co">// with multiple contract instances</span></span>
<span id="cb106-35"><a href="#cb106-35" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb106-36"><a href="#cb106-36" aria-hidden="true" tabindex="-1"></a>        <span class="kw">let</span> caller <span class="op">=</span> <span class="pp">CrossContractCaller::</span>new(<span class="pp">AccountId::</span>from([<span class="dv">1</span><span class="op">;</span> <span class="dv">32</span>]))<span class="op">;</span></span>
<span id="cb106-37"><a href="#cb106-37" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb106-38"><a href="#cb106-38" aria-hidden="true" tabindex="-1"></a>        <span class="co">// In practice, you&#39;d deploy a mock ERC20 contract</span></span>
<span id="cb106-39"><a href="#cb106-39" aria-hidden="true" tabindex="-1"></a>        <span class="co">// and test actual cross-contract calls</span></span>
<span id="cb106-40"><a href="#cb106-40" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb106-41"><a href="#cb106-41" aria-hidden="true" tabindex="-1"></a>        <span class="co">// For now, we can test the construction and basic logic</span></span>
<span id="cb106-42"><a href="#cb106-42" aria-hidden="true" tabindex="-1"></a>        <span class="pp">assert_eq!</span>(caller<span class="op">.</span>erc20_contract<span class="op">,</span> <span class="pp">AccountId::</span>from([<span class="dv">1</span><span class="op">;</span> <span class="dv">32</span>]))<span class="op">;</span></span>
<span id="cb106-43"><a href="#cb106-43" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb106-44"><a href="#cb106-44" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb106-45"><a href="#cb106-45" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-46"><a href="#cb106-46" aria-hidden="true" tabindex="-1"></a><span class="co">/// End-to-end tests for cross-contract calls</span></span>
<span id="cb106-47"><a href="#cb106-47" aria-hidden="true" tabindex="-1"></a><span class="at">#[</span>cfg<span class="at">(</span>all<span class="at">(</span>test<span class="op">,</span> feature <span class="op">=</span> <span class="st">&quot;e2e-tests&quot;</span><span class="at">))]</span></span>
<span id="cb106-48"><a href="#cb106-48" aria-hidden="true" tabindex="-1"></a><span class="kw">mod</span> e2e_tests <span class="op">{</span></span>
<span id="cb106-49"><a href="#cb106-49" aria-hidden="true" tabindex="-1"></a>    <span class="kw">use</span> <span class="kw">super</span><span class="pp">::</span><span class="op">*;</span></span>
<span id="cb106-50"><a href="#cb106-50" aria-hidden="true" tabindex="-1"></a>    <span class="kw">use</span> <span class="pp">ink_e2e::</span>build_message<span class="op">;</span></span>
<span id="cb106-51"><a href="#cb106-51" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-52"><a href="#cb106-52" aria-hidden="true" tabindex="-1"></a>    <span class="at">#[</span><span class="pp">ink_e2e::</span>test<span class="at">]</span></span>
<span id="cb106-53"><a href="#cb106-53" aria-hidden="true" tabindex="-1"></a>    <span class="kw">async</span> <span class="kw">fn</span> cross_contract_integration_works(<span class="kw">mut</span> client<span class="op">:</span> <span class="pp">ink_e2e::</span>Client<span class="op">&lt;</span>C<span class="op">,</span> E<span class="op">&gt;</span>) <span class="op">-&gt;</span> E2EResult<span class="op">&lt;</span>()<span class="op">&gt;</span> <span class="op">{</span></span>
<span id="cb106-54"><a href="#cb106-54" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Deploy ERC20 contract</span></span>
<span id="cb106-55"><a href="#cb106-55" aria-hidden="true" tabindex="-1"></a>        <span class="kw">let</span> erc20_constructor <span class="op">=</span> <span class="pp">Erc20Ref::</span>new(<span class="dv">1000</span><span class="op">,</span> <span class="st">&quot;Test&quot;</span><span class="op">.</span>to_string()<span class="op">,</span> <span class="st">&quot;TST&quot;</span><span class="op">.</span>to_string()<span class="op">,</span> <span class="dv">18</span>)<span class="op">;</span></span>
<span id="cb106-56"><a href="#cb106-56" aria-hidden="true" tabindex="-1"></a>        <span class="kw">let</span> erc20_acc_id <span class="op">=</span> client</span>
<span id="cb106-57"><a href="#cb106-57" aria-hidden="true" tabindex="-1"></a>            <span class="op">.</span>instantiate(<span class="st">&quot;erc20&quot;</span><span class="op">,</span> <span class="op">&amp;</span><span class="pp">ink_e2e::</span>alice()<span class="op">,</span> erc20_constructor<span class="op">,</span> <span class="dv">0</span><span class="op">,</span> <span class="cn">None</span>)</span>
<span id="cb106-58"><a href="#cb106-58" aria-hidden="true" tabindex="-1"></a>            <span class="op">.</span><span class="kw">await</span></span>
<span id="cb106-59"><a href="#cb106-59" aria-hidden="true" tabindex="-1"></a>            <span class="op">.</span>expect(<span class="st">&quot;ERC20 instantiate failed&quot;</span>)</span>
<span id="cb106-60"><a href="#cb106-60" aria-hidden="true" tabindex="-1"></a>            <span class="op">.</span>account_id<span class="op">;</span></span>
<span id="cb106-61"><a href="#cb106-61" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-62"><a href="#cb106-62" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Deploy cross-contract caller</span></span>
<span id="cb106-63"><a href="#cb106-63" aria-hidden="true" tabindex="-1"></a>        <span class="kw">let</span> caller_constructor <span class="op">=</span> <span class="pp">CrossContractCallerRef::</span>new(erc20_acc_id)<span class="op">;</span></span>
<span id="cb106-64"><a href="#cb106-64" aria-hidden="true" tabindex="-1"></a>        <span class="kw">let</span> caller_acc_id <span class="op">=</span> client</span>
<span id="cb106-65"><a href="#cb106-65" aria-hidden="true" tabindex="-1"></a>            <span class="op">.</span>instantiate(<span class="st">&quot;cross_contract_caller&quot;</span><span class="op">,</span> <span class="op">&amp;</span><span class="pp">ink_e2e::</span>alice()<span class="op">,</span> caller_constructor<span class="op">,</span> <span class="dv">0</span><span class="op">,</span> <span class="cn">None</span>)</span>
<span id="cb106-66"><a href="#cb106-66" aria-hidden="true" tabindex="-1"></a>            <span class="op">.</span><span class="kw">await</span></span>
<span id="cb106-67"><a href="#cb106-67" aria-hidden="true" tabindex="-1"></a>            <span class="op">.</span>expect(<span class="st">&quot;Caller instantiate failed&quot;</span>)</span>
<span id="cb106-68"><a href="#cb106-68" aria-hidden="true" tabindex="-1"></a>            <span class="op">.</span>account_id<span class="op">;</span></span>
<span id="cb106-69"><a href="#cb106-69" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-70"><a href="#cb106-70" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Test cross-contract call</span></span>
<span id="cb106-71"><a href="#cb106-71" aria-hidden="true" tabindex="-1"></a>        <span class="kw">let</span> get_balance <span class="op">=</span> <span class="pp">build_message::</span><span class="op">&lt;</span>CrossContractCallerRef<span class="op">&gt;</span>(caller_acc_id<span class="op">.</span>clone())</span>
<span id="cb106-72"><a href="#cb106-72" aria-hidden="true" tabindex="-1"></a>            <span class="op">.</span>call(<span class="op">|</span>caller<span class="op">|</span> caller<span class="op">.</span>get_token_balance(<span class="pp">ink_e2e::</span>alice()<span class="op">.</span>account_id()))<span class="op">;</span></span>
<span id="cb106-73"><a href="#cb106-73" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb106-74"><a href="#cb106-74" aria-hidden="true" tabindex="-1"></a>        <span class="kw">let</span> balance_result <span class="op">=</span> client<span class="op">.</span>call_dry_run(<span class="op">&amp;</span><span class="pp">ink_e2e::</span>alice()<span class="op">,</span> <span class="op">&amp;</span>get_balance<span class="op">,</span> <span class="dv">0</span><span class="op">,</span> <span class="cn">None</span>)<span class="op">.</span><span class="kw">await</span><span class="op">;</span></span>
<span id="cb106-75"><a href="#cb106-75" aria-hidden="true" tabindex="-1"></a>        <span class="pp">assert_eq!</span>(balance_result<span class="op">.</span>return_value()<span class="op">,</span> <span class="dv">1000</span>)<span class="op">;</span></span>
<span id="cb106-76"><a href="#cb106-76" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb106-77"><a href="#cb106-77" aria-hidden="true" tabindex="-1"></a>        <span class="cn">Ok</span>(())</span>
<span id="cb106-78"><a href="#cb106-78" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb106-79"><a href="#cb106-79" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<h2 id="summary-4">Summary</h2>
<p>In this chapter, we’ve explored the powerful interoperability
features that make ink! contracts part of larger ecosystems:</p>
<p><strong>Event Systems:</strong> 1. <strong>Event Definition</strong>:
Creating structured events with <code>#[ink(event)]</code> and topic
indexing 2. <strong>Efficient Filtering</strong>: Using
<code>#[ink(topic)]</code> for off-chain query optimization 3.
<strong>Event Architecture</strong>: Designing event systems that
support rich user interfaces 4. <strong>Data Optimization</strong>:
Balancing event richness with gas efficiency</p>
<p><strong>Cross-Contract Calls:</strong> 5. <strong>Basic
Patterns</strong>: Using trait definitions and contract references for
type-safe calls 6. <strong>Advanced Patterns</strong>: Factory patterns,
proxy patterns, and upgradeable architectures 7. <strong>Security
Considerations</strong>: Reentrancy protection, call depth limits, and
trust management 8. <strong>DeFi Composition</strong>: Building complex
financial applications through contract composition</p>
<p><strong>Testing Strategies:</strong> 9. <strong>Event
Testing</strong>: Verifying event emission and data correctness 10.
<strong>Integration Testing</strong>: End-to-end testing of
cross-contract interactions</p>
<p><strong>Key Takeaways:</strong> - Events provide efficient
communication with off-chain applications - Cross-contract calls enable
powerful composability patterns - Security must be carefully considered
when calling external contracts - Proper testing ensures reliable
interoperability</p>
<p>With solid interoperability foundations established, you’re ready to
explore advanced ink! patterns and techniques. In the next chapter,
we’ll cover sophisticated design patterns, error handling strategies,
and architectural approaches for building robust, production-ready smart
contracts.</p>
<hr />
<h1 id="chapter-6-advanced-ink-patterns-and-techniques">Chapter 6:
Advanced ink! Patterns and Techniques</h1>
<p>As your ink! contracts grow in complexity, you’ll need sophisticated
patterns and techniques to manage code organization, error handling,
access control, and upgradability. This chapter explores advanced
patterns that separate hobbyist contracts from production-ready systems
used in critical applications.</p>
<p>We’ll cover comprehensive error handling strategies, trait-based
contract architectures, access control patterns, and contract
upgradability techniques. These patterns form the foundation for
building maintainable, secure, and scalable smart contract systems.</p>
<h2 id="comprehensive-error-handling">Comprehensive Error Handling</h2>
<p>Robust error handling is crucial for production contracts. Users need
clear feedback about what went wrong, and systems need to handle
failures gracefully.</p>
<h3 id="structured-error-types">Structured Error Types</h3>
<p>Design error enums that provide clear, actionable information:</p>
<div class="sourceCode" id="cb107"><pre
class="sourceCode rust"><code class="sourceCode rust"><span id="cb107-1"><a href="#cb107-1" aria-hidden="true" tabindex="-1"></a><span class="at">#[</span>derive<span class="at">(</span><span class="bu">Debug</span><span class="op">,</span> <span class="bu">PartialEq</span><span class="op">,</span> <span class="bu">Eq</span><span class="op">,</span> <span class="pp">scale::</span>Encode<span class="op">,</span> <span class="pp">scale::</span>Decode<span class="at">)]</span></span>
<span id="cb107-2"><a href="#cb107-2" aria-hidden="true" tabindex="-1"></a><span class="at">#[</span>cfg_attr<span class="at">(</span>feature <span class="op">=</span> <span class="st">&quot;std&quot;</span><span class="op">,</span> derive<span class="at">(</span><span class="pp">scale_info::</span>TypeInfo<span class="at">))]</span></span>
<span id="cb107-3"><a href="#cb107-3" aria-hidden="true" tabindex="-1"></a><span class="kw">pub</span> <span class="kw">enum</span> <span class="bu">Error</span> <span class="op">{</span></span>
<span id="cb107-4"><a href="#cb107-4" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Arithmetic errors</span></span>
<span id="cb107-5"><a href="#cb107-5" aria-hidden="true" tabindex="-1"></a>    ArithmeticOverflow<span class="op">,</span></span>
<span id="cb107-6"><a href="#cb107-6" aria-hidden="true" tabindex="-1"></a>    ArithmeticUnderflow<span class="op">,</span></span>
<span id="cb107-7"><a href="#cb107-7" aria-hidden="true" tabindex="-1"></a>    DivisionByZero<span class="op">,</span></span>
<span id="cb107-8"><a href="#cb107-8" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb107-9"><a href="#cb107-9" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Balance and transfer errors</span></span>
<span id="cb107-10"><a href="#cb107-10" aria-hidden="true" tabindex="-1"></a>    InsufficientBalance<span class="op">,</span></span>
<span id="cb107-11"><a href="#cb107-11" aria-hidden="true" tabindex="-1"></a>    InsufficientAllowance<span class="op">,</span></span>
<span id="cb107-12"><a href="#cb107-12" aria-hidden="true" tabindex="-1"></a>    TransferToSelf<span class="op">,</span></span>
<span id="cb107-13"><a href="#cb107-13" aria-hidden="true" tabindex="-1"></a>    TransferAmountZero<span class="op">,</span></span>
<span id="cb107-14"><a href="#cb107-14" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb107-15"><a href="#cb107-15" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Authorization errors</span></span>
<span id="cb107-16"><a href="#cb107-16" aria-hidden="true" tabindex="-1"></a>    Unauthorized<span class="op">,</span></span>
<span id="cb107-17"><a href="#cb107-17" aria-hidden="true" tabindex="-1"></a>    NotOwner<span class="op">,</span></span>
<span id="cb107-18"><a href="#cb107-18" aria-hidden="true" tabindex="-1"></a>    NotApproved<span class="op">,</span></span>
<span id="cb107-19"><a href="#cb107-19" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb107-20"><a href="#cb107-20" aria-hidden="true" tabindex="-1"></a>    <span class="co">// State errors</span></span>
<span id="cb107-21"><a href="#cb107-21" aria-hidden="true" tabindex="-1"></a>    ContractPaused<span class="op">,</span></span>
<span id="cb107-22"><a href="#cb107-22" aria-hidden="true" tabindex="-1"></a>    ContractFinalized<span class="op">,</span></span>
<span id="cb107-23"><a href="#cb107-23" aria-hidden="true" tabindex="-1"></a>    InvalidState<span class="op">,</span></span>
<span id="cb107-24"><a href="#cb107-24" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb107-25"><a href="#cb107-25" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Parameter validation errors</span></span>
<span id="cb107-26"><a href="#cb107-26" aria-hidden="true" tabindex="-1"></a>    InvalidAddress<span class="op">,</span></span>
<span id="cb107-27"><a href="#cb107-27" aria-hidden="true" tabindex="-1"></a>    InvalidAmount<span class="op">,</span></span>
<span id="cb107-28"><a href="#cb107-28" aria-hidden="true" tabindex="-1"></a>    InvalidParameters<span class="op">,</span></span>
<span id="cb107-29"><a href="#cb107-29" aria-hidden="true" tabindex="-1"></a>    ArrayLengthMismatch<span class="op">,</span></span>
<span id="cb107-30"><a href="#cb107-30" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb107-31"><a href="#cb107-31" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Business logic errors</span></span>
<span id="cb107-32"><a href="#cb107-32" aria-hidden="true" tabindex="-1"></a>    DeadlineExpired<span class="op">,</span></span>
<span id="cb107-33"><a href="#cb107-33" aria-hidden="true" tabindex="-1"></a>    QuotaExceeded<span class="op">,</span></span>
<span id="cb107-34"><a href="#cb107-34" aria-hidden="true" tabindex="-1"></a>    RequirementNotMet<span class="op">,</span></span>
<span id="cb107-35"><a href="#cb107-35" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb107-36"><a href="#cb107-36" aria-hidden="true" tabindex="-1"></a>    <span class="co">// System errors</span></span>
<span id="cb107-37"><a href="#cb107-37" aria-hidden="true" tabindex="-1"></a>    CrossContractCallFailed<span class="op">,</span></span>
<span id="cb107-38"><a href="#cb107-38" aria-hidden="true" tabindex="-1"></a>    StorageCorrupted<span class="op">,</span></span>
<span id="cb107-39"><a href="#cb107-39" aria-hidden="true" tabindex="-1"></a>    ExternalCallFailed<span class="op">,</span></span>
<span id="cb107-40"><a href="#cb107-40" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb107-41"><a href="#cb107-41" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb107-42"><a href="#cb107-42" aria-hidden="true" tabindex="-1"></a><span class="kw">impl</span> <span class="bu">Error</span> <span class="op">{</span></span>
<span id="cb107-43"><a href="#cb107-43" aria-hidden="true" tabindex="-1"></a>    <span class="co">/// Get user-friendly error message</span></span>
<span id="cb107-44"><a href="#cb107-44" aria-hidden="true" tabindex="-1"></a>    <span class="kw">pub</span> <span class="kw">fn</span> message(<span class="op">&amp;</span><span class="kw">self</span>) <span class="op">-&gt;</span> <span class="op">&amp;</span><span class="ot">&#39;static</span> <span class="dt">str</span> <span class="op">{</span></span>
<span id="cb107-45"><a href="#cb107-45" aria-hidden="true" tabindex="-1"></a>        <span class="cf">match</span> <span class="kw">self</span> <span class="op">{</span></span>
<span id="cb107-46"><a href="#cb107-46" aria-hidden="true" tabindex="-1"></a>            <span class="bu">Error</span><span class="pp">::</span>ArithmeticOverflow <span class="op">=&gt;</span> <span class="st">&quot;Arithmetic operation would overflow&quot;</span><span class="op">,</span></span>
<span id="cb107-47"><a href="#cb107-47" aria-hidden="true" tabindex="-1"></a>            <span class="bu">Error</span><span class="pp">::</span>ArithmeticUnderflow <span class="op">=&gt;</span> <span class="st">&quot;Arithmetic operation would underflow&quot;</span><span class="op">,</span></span>
<span id="cb107-48"><a href="#cb107-48" aria-hidden="true" tabindex="-1"></a>            <span class="bu">Error</span><span class="pp">::</span>InsufficientBalance <span class="op">=&gt;</span> <span class="st">&quot;Account balance is insufficient for this operation&quot;</span><span class="op">,</span></span>
<span id="cb107-49"><a href="#cb107-49" aria-hidden="true" tabindex="-1"></a>            <span class="bu">Error</span><span class="pp">::</span>Unauthorized <span class="op">=&gt;</span> <span class="st">&quot;Account is not authorized to perform this action&quot;</span><span class="op">,</span></span>
<span id="cb107-50"><a href="#cb107-50" aria-hidden="true" tabindex="-1"></a>            <span class="bu">Error</span><span class="pp">::</span>ContractPaused <span class="op">=&gt;</span> <span class="st">&quot;Contract is currently paused&quot;</span><span class="op">,</span></span>
<span id="cb107-51"><a href="#cb107-51" aria-hidden="true" tabindex="-1"></a>            <span class="bu">Error</span><span class="pp">::</span>InvalidAmount <span class="op">=&gt;</span> <span class="st">&quot;Amount must be greater than zero&quot;</span><span class="op">,</span></span>
<span id="cb107-52"><a href="#cb107-52" aria-hidden="true" tabindex="-1"></a>            <span class="bu">Error</span><span class="pp">::</span>DeadlineExpired <span class="op">=&gt;</span> <span class="st">&quot;Operation deadline has passed&quot;</span><span class="op">,</span></span>
<span id="cb107-53"><a href="#cb107-53" aria-hidden="true" tabindex="-1"></a>            <span class="co">// ... other error messages</span></span>
<span id="cb107-54"><a href="#cb107-54" aria-hidden="true" tabindex="-1"></a>            _ <span class="op">=&gt;</span> <span class="st">&quot;Unknown error occurred&quot;</span><span class="op">,</span></span>
<span id="cb107-55"><a href="#cb107-55" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb107-56"><a href="#cb107-56" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb107-57"><a href="#cb107-57" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb107-58"><a href="#cb107-58" aria-hidden="true" tabindex="-1"></a>    <span class="co">/// Get error category for logging and monitoring</span></span>
<span id="cb107-59"><a href="#cb107-59" aria-hidden="true" tabindex="-1"></a>    <span class="kw">pub</span> <span class="kw">fn</span> category(<span class="op">&amp;</span><span class="kw">self</span>) <span class="op">-&gt;</span> ErrorCategory <span class="op">{</span></span>
<span id="cb107-60"><a href="#cb107-60" aria-hidden="true" tabindex="-1"></a>        <span class="cf">match</span> <span class="kw">self</span> <span class="op">{</span></span>
<span id="cb107-61"><a href="#cb107-61" aria-hidden="true" tabindex="-1"></a>            <span class="bu">Error</span><span class="pp">::</span>ArithmeticOverflow <span class="op">|</span> <span class="bu">Error</span><span class="pp">::</span>ArithmeticUnderflow <span class="op">|</span> <span class="bu">Error</span><span class="pp">::</span>DivisionByZero <span class="op">=&gt;</span> <span class="op">{</span></span>
<span id="cb107-62"><a href="#cb107-62" aria-hidden="true" tabindex="-1"></a>                <span class="pp">ErrorCategory::</span>Arithmetic</span>
<span id="cb107-63"><a href="#cb107-63" aria-hidden="true" tabindex="-1"></a>            <span class="op">}</span></span>
<span id="cb107-64"><a href="#cb107-64" aria-hidden="true" tabindex="-1"></a>            <span class="bu">Error</span><span class="pp">::</span>InsufficientBalance <span class="op">|</span> <span class="bu">Error</span><span class="pp">::</span>TransferAmountZero <span class="op">=&gt;</span> <span class="op">{</span></span>
<span id="cb107-65"><a href="#cb107-65" aria-hidden="true" tabindex="-1"></a>                <span class="pp">ErrorCategory::</span>Balance</span>
<span id="cb107-66"><a href="#cb107-66" aria-hidden="true" tabindex="-1"></a>            <span class="op">}</span></span>
<span id="cb107-67"><a href="#cb107-67" aria-hidden="true" tabindex="-1"></a>            <span class="bu">Error</span><span class="pp">::</span>Unauthorized <span class="op">|</span> <span class="bu">Error</span><span class="pp">::</span>NotOwner <span class="op">|</span> <span class="bu">Error</span><span class="pp">::</span>NotApproved <span class="op">=&gt;</span> <span class="op">{</span></span>
<span id="cb107-68"><a href="#cb107-68" aria-hidden="true" tabindex="-1"></a>                <span class="pp">ErrorCategory::</span>Authorization</span>
<span id="cb107-69"><a href="#cb107-69" aria-hidden="true" tabindex="-1"></a>            <span class="op">}</span></span>
<span id="cb107-70"><a href="#cb107-70" aria-hidden="true" tabindex="-1"></a>            <span class="bu">Error</span><span class="pp">::</span>ContractPaused <span class="op">|</span> <span class="bu">Error</span><span class="pp">::</span>InvalidState <span class="op">=&gt;</span> <span class="op">{</span></span>
<span id="cb107-71"><a href="#cb107-71" aria-hidden="true" tabindex="-1"></a>                <span class="pp">ErrorCategory::</span>State</span>
<span id="cb107-72"><a href="#cb107-72" aria-hidden="true" tabindex="-1"></a>            <span class="op">}</span></span>
<span id="cb107-73"><a href="#cb107-73" aria-hidden="true" tabindex="-1"></a>            _ <span class="op">=&gt;</span> <span class="pp">ErrorCategory::</span>General<span class="op">,</span></span>
<span id="cb107-74"><a href="#cb107-74" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb107-75"><a href="#cb107-75" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb107-76"><a href="#cb107-76" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb107-77"><a href="#cb107-77" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb107-78"><a href="#cb107-78" aria-hidden="true" tabindex="-1"></a><span class="at">#[</span>derive<span class="at">(</span><span class="bu">Debug</span><span class="op">,</span> <span class="bu">PartialEq</span><span class="op">,</span> <span class="bu">Eq</span><span class="at">)]</span></span>
<span id="cb107-79"><a href="#cb107-79" aria-hidden="true" tabindex="-1"></a><span class="kw">pub</span> <span class="kw">enum</span> ErrorCategory <span class="op">{</span></span>
<span id="cb107-80"><a href="#cb107-80" aria-hidden="true" tabindex="-1"></a>    Arithmetic<span class="op">,</span></span>
<span id="cb107-81"><a href="#cb107-81" aria-hidden="true" tabindex="-1"></a>    Balance<span class="op">,</span></span>
<span id="cb107-82"><a href="#cb107-82" aria-hidden="true" tabindex="-1"></a>    Authorization<span class="op">,</span></span>
<span id="cb107-83"><a href="#cb107-83" aria-hidden="true" tabindex="-1"></a>    State<span class="op">,</span></span>
<span id="cb107-84"><a href="#cb107-84" aria-hidden="true" tabindex="-1"></a>    Validation<span class="op">,</span></span>
<span id="cb107-85"><a href="#cb107-85" aria-hidden="true" tabindex="-1"></a>    System<span class="op">,</span></span>
<span id="cb107-86"><a href="#cb107-86" aria-hidden="true" tabindex="-1"></a>    General<span class="op">,</span></span>
<span id="cb107-87"><a href="#cb107-87" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<h3 id="error-context-and-propagation">Error Context and
Propagation</h3>
<p>Implement error context to provide debugging information:</p>
<div class="sourceCode" id="cb108"><pre
class="sourceCode rust"><code class="sourceCode rust"><span id="cb108-1"><a href="#cb108-1" aria-hidden="true" tabindex="-1"></a><span class="at">#[</span><span class="pp">ink::</span>contract<span class="at">]</span></span>
<span id="cb108-2"><a href="#cb108-2" aria-hidden="true" tabindex="-1"></a><span class="kw">mod</span> advanced_error_handling <span class="op">{</span></span>
<span id="cb108-3"><a href="#cb108-3" aria-hidden="true" tabindex="-1"></a>    <span class="kw">use</span> <span class="kw">super</span><span class="pp">::</span><span class="op">*;</span></span>
<span id="cb108-4"><a href="#cb108-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb108-5"><a href="#cb108-5" aria-hidden="true" tabindex="-1"></a>    <span class="at">#[</span>ink<span class="at">(</span>storage<span class="at">)]</span></span>
<span id="cb108-6"><a href="#cb108-6" aria-hidden="true" tabindex="-1"></a>    <span class="kw">pub</span> <span class="kw">struct</span> AdvancedContract <span class="op">{</span></span>
<span id="cb108-7"><a href="#cb108-7" aria-hidden="true" tabindex="-1"></a>        balances<span class="op">:</span> <span class="pp">ink::storage::</span>Mapping<span class="op">&lt;</span>AccountId<span class="op">,</span> Balance<span class="op">&gt;,</span></span>
<span id="cb108-8"><a href="#cb108-8" aria-hidden="true" tabindex="-1"></a>        paused<span class="op">:</span> <span class="dt">bool</span><span class="op">,</span></span>
<span id="cb108-9"><a href="#cb108-9" aria-hidden="true" tabindex="-1"></a>        owner<span class="op">:</span> AccountId<span class="op">,</span></span>
<span id="cb108-10"><a href="#cb108-10" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb108-11"><a href="#cb108-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb108-12"><a href="#cb108-12" aria-hidden="true" tabindex="-1"></a>    <span class="kw">impl</span> AdvancedContract <span class="op">{</span></span>
<span id="cb108-13"><a href="#cb108-13" aria-hidden="true" tabindex="-1"></a>        <span class="at">#[</span>ink<span class="at">(</span>constructor<span class="at">)]</span></span>
<span id="cb108-14"><a href="#cb108-14" aria-hidden="true" tabindex="-1"></a>        <span class="kw">pub</span> <span class="kw">fn</span> new() <span class="op">-&gt;</span> <span class="dt">Self</span> <span class="op">{</span></span>
<span id="cb108-15"><a href="#cb108-15" aria-hidden="true" tabindex="-1"></a>            <span class="dt">Self</span> <span class="op">{</span></span>
<span id="cb108-16"><a href="#cb108-16" aria-hidden="true" tabindex="-1"></a>                balances<span class="op">:</span> <span class="pp">ink::storage::Mapping::</span><span class="kw">default</span>()<span class="op">,</span></span>
<span id="cb108-17"><a href="#cb108-17" aria-hidden="true" tabindex="-1"></a>                paused<span class="op">:</span> <span class="cn">false</span><span class="op">,</span></span>
<span id="cb108-18"><a href="#cb108-18" aria-hidden="true" tabindex="-1"></a>                owner<span class="op">:</span> <span class="dt">Self</span><span class="pp">::</span>env()<span class="op">.</span>caller()<span class="op">,</span></span>
<span id="cb108-19"><a href="#cb108-19" aria-hidden="true" tabindex="-1"></a>            <span class="op">}</span></span>
<span id="cb108-20"><a href="#cb108-20" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb108-21"><a href="#cb108-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb108-22"><a href="#cb108-22" aria-hidden="true" tabindex="-1"></a>        <span class="co">/// Transfer with comprehensive error handling</span></span>
<span id="cb108-23"><a href="#cb108-23" aria-hidden="true" tabindex="-1"></a>        <span class="at">#[</span>ink<span class="at">(</span>message<span class="at">)]</span></span>
<span id="cb108-24"><a href="#cb108-24" aria-hidden="true" tabindex="-1"></a>        <span class="kw">pub</span> <span class="kw">fn</span> transfer(<span class="op">&amp;</span><span class="kw">mut</span> <span class="kw">self</span><span class="op">,</span> to<span class="op">:</span> AccountId<span class="op">,</span> amount<span class="op">:</span> Balance) <span class="op">-&gt;</span> <span class="dt">Result</span><span class="op">&lt;</span>()<span class="op">,</span> <span class="bu">Error</span><span class="op">&gt;</span> <span class="op">{</span></span>
<span id="cb108-25"><a href="#cb108-25" aria-hidden="true" tabindex="-1"></a>            <span class="co">// Pre-condition checks with specific errors</span></span>
<span id="cb108-26"><a href="#cb108-26" aria-hidden="true" tabindex="-1"></a>            <span class="kw">self</span><span class="op">.</span>ensure_not_paused()<span class="op">?;</span></span>
<span id="cb108-27"><a href="#cb108-27" aria-hidden="true" tabindex="-1"></a>            <span class="kw">self</span><span class="op">.</span>validate_transfer_params(to<span class="op">,</span> amount)<span class="op">?;</span></span>
<span id="cb108-28"><a href="#cb108-28" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb108-29"><a href="#cb108-29" aria-hidden="true" tabindex="-1"></a>            <span class="kw">let</span> from <span class="op">=</span> <span class="kw">self</span><span class="op">.</span>env()<span class="op">.</span>caller()<span class="op">;</span></span>
<span id="cb108-30"><a href="#cb108-30" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb108-31"><a href="#cb108-31" aria-hidden="true" tabindex="-1"></a>            <span class="co">// Execute transfer with detailed error context</span></span>
<span id="cb108-32"><a href="#cb108-32" aria-hidden="true" tabindex="-1"></a>            <span class="kw">self</span><span class="op">.</span>execute_transfer(from<span class="op">,</span> to<span class="op">,</span> amount)</span>
<span id="cb108-33"><a href="#cb108-33" aria-hidden="true" tabindex="-1"></a>                <span class="op">.</span>map_err(<span class="op">|</span>e<span class="op">|</span> <span class="kw">self</span><span class="op">.</span>add_context(e<span class="op">,</span> <span class="st">&quot;transfer&quot;</span><span class="op">,</span> <span class="op">&amp;</span>[(<span class="st">&quot;from&quot;</span><span class="op">,</span> <span class="op">&amp;</span>from)<span class="op">,</span> (<span class="st">&quot;to&quot;</span><span class="op">,</span> <span class="op">&amp;</span>to)<span class="op">,</span> (<span class="st">&quot;amount&quot;</span><span class="op">,</span> <span class="op">&amp;</span>amount)]))</span>
<span id="cb108-34"><a href="#cb108-34" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb108-35"><a href="#cb108-35" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb108-36"><a href="#cb108-36" aria-hidden="true" tabindex="-1"></a>        <span class="co">/// Batch transfer with partial success handling</span></span>
<span id="cb108-37"><a href="#cb108-37" aria-hidden="true" tabindex="-1"></a>        <span class="at">#[</span>ink<span class="at">(</span>message<span class="at">)]</span></span>
<span id="cb108-38"><a href="#cb108-38" aria-hidden="true" tabindex="-1"></a>        <span class="kw">pub</span> <span class="kw">fn</span> batch_transfer(</span>
<span id="cb108-39"><a href="#cb108-39" aria-hidden="true" tabindex="-1"></a>            <span class="op">&amp;</span><span class="kw">mut</span> <span class="kw">self</span><span class="op">,</span></span>
<span id="cb108-40"><a href="#cb108-40" aria-hidden="true" tabindex="-1"></a>            recipients<span class="op">:</span> <span class="dt">Vec</span><span class="op">&lt;</span>(AccountId<span class="op">,</span> Balance)<span class="op">&gt;,</span></span>
<span id="cb108-41"><a href="#cb108-41" aria-hidden="true" tabindex="-1"></a>        ) <span class="op">-&gt;</span> <span class="dt">Result</span><span class="op">&lt;</span>BatchResult<span class="op">,</span> <span class="bu">Error</span><span class="op">&gt;</span> <span class="op">{</span></span>
<span id="cb108-42"><a href="#cb108-42" aria-hidden="true" tabindex="-1"></a>            <span class="kw">self</span><span class="op">.</span>ensure_not_paused()<span class="op">?;</span></span>
<span id="cb108-43"><a href="#cb108-43" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb108-44"><a href="#cb108-44" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> recipients<span class="op">.</span>len() <span class="op">&gt;</span> <span class="dv">100</span> <span class="op">{</span></span>
<span id="cb108-45"><a href="#cb108-45" aria-hidden="true" tabindex="-1"></a>                <span class="cf">return</span> <span class="cn">Err</span>(<span class="bu">Error</span><span class="pp">::</span>InvalidParameters)<span class="op">;</span></span>
<span id="cb108-46"><a href="#cb108-46" aria-hidden="true" tabindex="-1"></a>            <span class="op">}</span></span>
<span id="cb108-47"><a href="#cb108-47" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb108-48"><a href="#cb108-48" aria-hidden="true" tabindex="-1"></a>            <span class="kw">let</span> <span class="kw">mut</span> results <span class="op">=</span> <span class="dt">Vec</span><span class="pp">::</span>new()<span class="op">;</span></span>
<span id="cb108-49"><a href="#cb108-49" aria-hidden="true" tabindex="-1"></a>            <span class="kw">let</span> <span class="kw">mut</span> total_successful <span class="op">=</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb108-50"><a href="#cb108-50" aria-hidden="true" tabindex="-1"></a>            <span class="kw">let</span> from <span class="op">=</span> <span class="kw">self</span><span class="op">.</span>env()<span class="op">.</span>caller()<span class="op">;</span></span>
<span id="cb108-51"><a href="#cb108-51" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb108-52"><a href="#cb108-52" aria-hidden="true" tabindex="-1"></a>            <span class="cf">for</span> (i<span class="op">,</span> (to<span class="op">,</span> amount)) <span class="kw">in</span> recipients<span class="op">.</span>iter()<span class="op">.</span>enumerate() <span class="op">{</span></span>
<span id="cb108-53"><a href="#cb108-53" aria-hidden="true" tabindex="-1"></a>                <span class="cf">match</span> <span class="kw">self</span><span class="op">.</span>execute_transfer(from<span class="op">,</span> <span class="op">*</span>to<span class="op">,</span> <span class="op">*</span>amount) <span class="op">{</span></span>
<span id="cb108-54"><a href="#cb108-54" aria-hidden="true" tabindex="-1"></a>                    <span class="cn">Ok</span>(()) <span class="op">=&gt;</span> <span class="op">{</span></span>
<span id="cb108-55"><a href="#cb108-55" aria-hidden="true" tabindex="-1"></a>                        results<span class="op">.</span>push(<span class="pp">TransferResult::</span><span class="cn">Success</span>)<span class="op">;</span></span>
<span id="cb108-56"><a href="#cb108-56" aria-hidden="true" tabindex="-1"></a>                        total_successful <span class="op">+=</span> <span class="dv">1</span><span class="op">;</span></span>
<span id="cb108-57"><a href="#cb108-57" aria-hidden="true" tabindex="-1"></a>                    <span class="op">}</span></span>
<span id="cb108-58"><a href="#cb108-58" aria-hidden="true" tabindex="-1"></a>                    <span class="cn">Err</span>(e) <span class="op">=&gt;</span> <span class="op">{</span></span>
<span id="cb108-59"><a href="#cb108-59" aria-hidden="true" tabindex="-1"></a>                        results<span class="op">.</span>push(<span class="pp">TransferResult::</span>Failed(e))<span class="op">;</span></span>
<span id="cb108-60"><a href="#cb108-60" aria-hidden="true" tabindex="-1"></a>                        <span class="co">// Continue with remaining transfers</span></span>
<span id="cb108-61"><a href="#cb108-61" aria-hidden="true" tabindex="-1"></a>                    <span class="op">}</span></span>
<span id="cb108-62"><a href="#cb108-62" aria-hidden="true" tabindex="-1"></a>                <span class="op">}</span></span>
<span id="cb108-63"><a href="#cb108-63" aria-hidden="true" tabindex="-1"></a>            <span class="op">}</span></span>
<span id="cb108-64"><a href="#cb108-64" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb108-65"><a href="#cb108-65" aria-hidden="true" tabindex="-1"></a>            <span class="cn">Ok</span>(BatchResult <span class="op">{</span></span>
<span id="cb108-66"><a href="#cb108-66" aria-hidden="true" tabindex="-1"></a>                total_attempted<span class="op">:</span> recipients<span class="op">.</span>len() <span class="kw">as</span> <span class="dt">u32</span><span class="op">,</span></span>
<span id="cb108-67"><a href="#cb108-67" aria-hidden="true" tabindex="-1"></a>                total_successful<span class="op">,</span></span>
<span id="cb108-68"><a href="#cb108-68" aria-hidden="true" tabindex="-1"></a>                individual_results<span class="op">:</span> results<span class="op">,</span></span>
<span id="cb108-69"><a href="#cb108-69" aria-hidden="true" tabindex="-1"></a>            <span class="op">}</span>)</span>
<span id="cb108-70"><a href="#cb108-70" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb108-71"><a href="#cb108-71" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb108-72"><a href="#cb108-72" aria-hidden="true" tabindex="-1"></a>        <span class="co">/// Internal transfer with detailed error tracking</span></span>
<span id="cb108-73"><a href="#cb108-73" aria-hidden="true" tabindex="-1"></a>        <span class="kw">fn</span> execute_transfer(</span>
<span id="cb108-74"><a href="#cb108-74" aria-hidden="true" tabindex="-1"></a>            <span class="op">&amp;</span><span class="kw">mut</span> <span class="kw">self</span><span class="op">,</span></span>
<span id="cb108-75"><a href="#cb108-75" aria-hidden="true" tabindex="-1"></a>            from<span class="op">:</span> AccountId<span class="op">,</span></span>
<span id="cb108-76"><a href="#cb108-76" aria-hidden="true" tabindex="-1"></a>            to<span class="op">:</span> AccountId<span class="op">,</span></span>
<span id="cb108-77"><a href="#cb108-77" aria-hidden="true" tabindex="-1"></a>            amount<span class="op">:</span> Balance<span class="op">,</span></span>
<span id="cb108-78"><a href="#cb108-78" aria-hidden="true" tabindex="-1"></a>        ) <span class="op">-&gt;</span> <span class="dt">Result</span><span class="op">&lt;</span>()<span class="op">,</span> <span class="bu">Error</span><span class="op">&gt;</span> <span class="op">{</span></span>
<span id="cb108-79"><a href="#cb108-79" aria-hidden="true" tabindex="-1"></a>            <span class="co">// Get balances with error context</span></span>
<span id="cb108-80"><a href="#cb108-80" aria-hidden="true" tabindex="-1"></a>            <span class="kw">let</span> from_balance <span class="op">=</span> <span class="kw">self</span><span class="op">.</span>balances<span class="op">.</span>get(from)<span class="op">.</span>unwrap_or(<span class="dv">0</span>)<span class="op">;</span></span>
<span id="cb108-81"><a href="#cb108-81" aria-hidden="true" tabindex="-1"></a>            <span class="kw">let</span> to_balance <span class="op">=</span> <span class="kw">self</span><span class="op">.</span>balances<span class="op">.</span>get(to)<span class="op">.</span>unwrap_or(<span class="dv">0</span>)<span class="op">;</span></span>
<span id="cb108-82"><a href="#cb108-82" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb108-83"><a href="#cb108-83" aria-hidden="true" tabindex="-1"></a>            <span class="co">// Validate sufficient balance</span></span>
<span id="cb108-84"><a href="#cb108-84" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> from_balance <span class="op">&lt;</span> amount <span class="op">{</span></span>
<span id="cb108-85"><a href="#cb108-85" aria-hidden="true" tabindex="-1"></a>                <span class="cf">return</span> <span class="cn">Err</span>(<span class="bu">Error</span><span class="pp">::</span>InsufficientBalance)<span class="op">;</span></span>
<span id="cb108-86"><a href="#cb108-86" aria-hidden="true" tabindex="-1"></a>            <span class="op">}</span></span>
<span id="cb108-87"><a href="#cb108-87" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb108-88"><a href="#cb108-88" aria-hidden="true" tabindex="-1"></a>            <span class="co">// Safe arithmetic with overflow protection</span></span>
<span id="cb108-89"><a href="#cb108-89" aria-hidden="true" tabindex="-1"></a>            <span class="kw">let</span> new_from_balance <span class="op">=</span> from_balance</span>
<span id="cb108-90"><a href="#cb108-90" aria-hidden="true" tabindex="-1"></a>                <span class="op">.</span>checked_sub(amount)</span>
<span id="cb108-91"><a href="#cb108-91" aria-hidden="true" tabindex="-1"></a>                <span class="op">.</span>ok_or(<span class="bu">Error</span><span class="pp">::</span>ArithmeticUnderflow)<span class="op">?;</span></span>
<span id="cb108-92"><a href="#cb108-92" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb108-93"><a href="#cb108-93" aria-hidden="true" tabindex="-1"></a>            <span class="kw">let</span> new_to_balance <span class="op">=</span> to_balance</span>
<span id="cb108-94"><a href="#cb108-94" aria-hidden="true" tabindex="-1"></a>                <span class="op">.</span>checked_add(amount)</span>
<span id="cb108-95"><a href="#cb108-95" aria-hidden="true" tabindex="-1"></a>                <span class="op">.</span>ok_or(<span class="bu">Error</span><span class="pp">::</span>ArithmeticOverflow)<span class="op">?;</span></span>
<span id="cb108-96"><a href="#cb108-96" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb108-97"><a href="#cb108-97" aria-hidden="true" tabindex="-1"></a>            <span class="co">// Update balances</span></span>
<span id="cb108-98"><a href="#cb108-98" aria-hidden="true" tabindex="-1"></a>            <span class="kw">self</span><span class="op">.</span>balances<span class="op">.</span>insert(from<span class="op">,</span> <span class="op">&amp;</span>new_from_balance)<span class="op">;</span></span>
<span id="cb108-99"><a href="#cb108-99" aria-hidden="true" tabindex="-1"></a>            <span class="kw">self</span><span class="op">.</span>balances<span class="op">.</span>insert(to<span class="op">,</span> <span class="op">&amp;</span>new_to_balance)<span class="op">;</span></span>
<span id="cb108-100"><a href="#cb108-100" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb108-101"><a href="#cb108-101" aria-hidden="true" tabindex="-1"></a>            <span class="co">// Emit success event</span></span>
<span id="cb108-102"><a href="#cb108-102" aria-hidden="true" tabindex="-1"></a>            <span class="kw">self</span><span class="op">.</span>env()<span class="op">.</span>emit_event(Transfer <span class="op">{</span></span>
<span id="cb108-103"><a href="#cb108-103" aria-hidden="true" tabindex="-1"></a>                from<span class="op">:</span> <span class="cn">Some</span>(from)<span class="op">,</span></span>
<span id="cb108-104"><a href="#cb108-104" aria-hidden="true" tabindex="-1"></a>                to<span class="op">:</span> <span class="cn">Some</span>(to)<span class="op">,</span></span>
<span id="cb108-105"><a href="#cb108-105" aria-hidden="true" tabindex="-1"></a>                value<span class="op">:</span> amount<span class="op">,</span></span>
<span id="cb108-106"><a href="#cb108-106" aria-hidden="true" tabindex="-1"></a>            <span class="op">}</span>)<span class="op">;</span></span>
<span id="cb108-107"><a href="#cb108-107" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb108-108"><a href="#cb108-108" aria-hidden="true" tabindex="-1"></a>            <span class="cn">Ok</span>(())</span>
<span id="cb108-109"><a href="#cb108-109" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb108-110"><a href="#cb108-110" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb108-111"><a href="#cb108-111" aria-hidden="true" tabindex="-1"></a>        <span class="co">/// Validation helpers with specific error types</span></span>
<span id="cb108-112"><a href="#cb108-112" aria-hidden="true" tabindex="-1"></a>        <span class="kw">fn</span> ensure_not_paused(<span class="op">&amp;</span><span class="kw">self</span>) <span class="op">-&gt;</span> <span class="dt">Result</span><span class="op">&lt;</span>()<span class="op">,</span> <span class="bu">Error</span><span class="op">&gt;</span> <span class="op">{</span></span>
<span id="cb108-113"><a href="#cb108-113" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> <span class="kw">self</span><span class="op">.</span>paused <span class="op">{</span></span>
<span id="cb108-114"><a href="#cb108-114" aria-hidden="true" tabindex="-1"></a>                <span class="cn">Err</span>(<span class="bu">Error</span><span class="pp">::</span>ContractPaused)</span>
<span id="cb108-115"><a href="#cb108-115" aria-hidden="true" tabindex="-1"></a>            <span class="op">}</span> <span class="cf">else</span> <span class="op">{</span></span>
<span id="cb108-116"><a href="#cb108-116" aria-hidden="true" tabindex="-1"></a>                <span class="cn">Ok</span>(())</span>
<span id="cb108-117"><a href="#cb108-117" aria-hidden="true" tabindex="-1"></a>            <span class="op">}</span></span>
<span id="cb108-118"><a href="#cb108-118" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb108-119"><a href="#cb108-119" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb108-120"><a href="#cb108-120" aria-hidden="true" tabindex="-1"></a>        <span class="kw">fn</span> validate_transfer_params(<span class="op">&amp;</span><span class="kw">self</span><span class="op">,</span> to<span class="op">:</span> AccountId<span class="op">,</span> amount<span class="op">:</span> Balance) <span class="op">-&gt;</span> <span class="dt">Result</span><span class="op">&lt;</span>()<span class="op">,</span> <span class="bu">Error</span><span class="op">&gt;</span> <span class="op">{</span></span>
<span id="cb108-121"><a href="#cb108-121" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> amount <span class="op">==</span> <span class="dv">0</span> <span class="op">{</span></span>
<span id="cb108-122"><a href="#cb108-122" aria-hidden="true" tabindex="-1"></a>                <span class="cf">return</span> <span class="cn">Err</span>(<span class="bu">Error</span><span class="pp">::</span>TransferAmountZero)<span class="op">;</span></span>
<span id="cb108-123"><a href="#cb108-123" aria-hidden="true" tabindex="-1"></a>            <span class="op">}</span></span>
<span id="cb108-124"><a href="#cb108-124" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb108-125"><a href="#cb108-125" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> to <span class="op">==</span> <span class="pp">AccountId::</span>from([<span class="dv">0</span><span class="op">;</span> <span class="dv">32</span>]) <span class="op">{</span></span>
<span id="cb108-126"><a href="#cb108-126" aria-hidden="true" tabindex="-1"></a>                <span class="cf">return</span> <span class="cn">Err</span>(<span class="bu">Error</span><span class="pp">::</span>InvalidAddress)<span class="op">;</span></span>
<span id="cb108-127"><a href="#cb108-127" aria-hidden="true" tabindex="-1"></a>            <span class="op">}</span></span>
<span id="cb108-128"><a href="#cb108-128" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb108-129"><a href="#cb108-129" aria-hidden="true" tabindex="-1"></a>            <span class="kw">let</span> from <span class="op">=</span> <span class="kw">self</span><span class="op">.</span>env()<span class="op">.</span>caller()<span class="op">;</span></span>
<span id="cb108-130"><a href="#cb108-130" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> from <span class="op">==</span> to <span class="op">{</span></span>
<span id="cb108-131"><a href="#cb108-131" aria-hidden="true" tabindex="-1"></a>                <span class="cf">return</span> <span class="cn">Err</span>(<span class="bu">Error</span><span class="pp">::</span>TransferToSelf)<span class="op">;</span></span>
<span id="cb108-132"><a href="#cb108-132" aria-hidden="true" tabindex="-1"></a>            <span class="op">}</span></span>
<span id="cb108-133"><a href="#cb108-133" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb108-134"><a href="#cb108-134" aria-hidden="true" tabindex="-1"></a>            <span class="cn">Ok</span>(())</span>
<span id="cb108-135"><a href="#cb108-135" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb108-136"><a href="#cb108-136" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb108-137"><a href="#cb108-137" aria-hidden="true" tabindex="-1"></a>        <span class="co">/// Add context information to errors (for debugging)</span></span>
<span id="cb108-138"><a href="#cb108-138" aria-hidden="true" tabindex="-1"></a>        <span class="kw">fn</span> add_context(</span>
<span id="cb108-139"><a href="#cb108-139" aria-hidden="true" tabindex="-1"></a>            <span class="op">&amp;</span><span class="kw">self</span><span class="op">,</span></span>
<span id="cb108-140"><a href="#cb108-140" aria-hidden="true" tabindex="-1"></a>            error<span class="op">:</span> <span class="bu">Error</span><span class="op">,</span></span>
<span id="cb108-141"><a href="#cb108-141" aria-hidden="true" tabindex="-1"></a>            operation<span class="op">:</span> <span class="op">&amp;</span><span class="dt">str</span><span class="op">,</span></span>
<span id="cb108-142"><a href="#cb108-142" aria-hidden="true" tabindex="-1"></a>            params<span class="op">:</span> <span class="op">&amp;</span>[(<span class="op">&amp;</span><span class="dt">str</span><span class="op">,</span> <span class="op">&amp;</span><span class="kw">dyn</span> <span class="pp">core::fmt::</span><span class="bu">Debug</span>)]<span class="op">,</span></span>
<span id="cb108-143"><a href="#cb108-143" aria-hidden="true" tabindex="-1"></a>        ) <span class="op">-&gt;</span> <span class="bu">Error</span> <span class="op">{</span></span>
<span id="cb108-144"><a href="#cb108-144" aria-hidden="true" tabindex="-1"></a>            <span class="co">// In production, you might log this information</span></span>
<span id="cb108-145"><a href="#cb108-145" aria-hidden="true" tabindex="-1"></a>            <span class="co">// For now, we just return the original error</span></span>
<span id="cb108-146"><a href="#cb108-146" aria-hidden="true" tabindex="-1"></a>            error</span>
<span id="cb108-147"><a href="#cb108-147" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb108-148"><a href="#cb108-148" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb108-149"><a href="#cb108-149" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb108-150"><a href="#cb108-150" aria-hidden="true" tabindex="-1"></a>    <span class="co">/// Result types for complex operations</span></span>
<span id="cb108-151"><a href="#cb108-151" aria-hidden="true" tabindex="-1"></a>    <span class="at">#[</span>derive<span class="at">(</span><span class="bu">Debug</span><span class="op">,</span> <span class="bu">PartialEq</span><span class="op">,</span> <span class="bu">Eq</span><span class="op">,</span> <span class="pp">scale::</span>Encode<span class="op">,</span> <span class="pp">scale::</span>Decode<span class="at">)]</span></span>
<span id="cb108-152"><a href="#cb108-152" aria-hidden="true" tabindex="-1"></a>    <span class="at">#[</span>cfg_attr<span class="at">(</span>feature <span class="op">=</span> <span class="st">&quot;std&quot;</span><span class="op">,</span> derive<span class="at">(</span><span class="pp">scale_info::</span>TypeInfo<span class="at">))]</span></span>
<span id="cb108-153"><a href="#cb108-153" aria-hidden="true" tabindex="-1"></a>    <span class="kw">pub</span> <span class="kw">struct</span> BatchResult <span class="op">{</span></span>
<span id="cb108-154"><a href="#cb108-154" aria-hidden="true" tabindex="-1"></a>        <span class="kw">pub</span> total_attempted<span class="op">:</span> <span class="dt">u32</span><span class="op">,</span></span>
<span id="cb108-155"><a href="#cb108-155" aria-hidden="true" tabindex="-1"></a>        <span class="kw">pub</span> total_successful<span class="op">:</span> <span class="dt">u32</span><span class="op">,</span></span>
<span id="cb108-156"><a href="#cb108-156" aria-hidden="true" tabindex="-1"></a>        <span class="kw">pub</span> individual_results<span class="op">:</span> <span class="dt">Vec</span><span class="op">&lt;</span>TransferResult<span class="op">&gt;,</span></span>
<span id="cb108-157"><a href="#cb108-157" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb108-158"><a href="#cb108-158" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb108-159"><a href="#cb108-159" aria-hidden="true" tabindex="-1"></a>    <span class="at">#[</span>derive<span class="at">(</span><span class="bu">Debug</span><span class="op">,</span> <span class="bu">PartialEq</span><span class="op">,</span> <span class="bu">Eq</span><span class="op">,</span> <span class="pp">scale::</span>Encode<span class="op">,</span> <span class="pp">scale::</span>Decode<span class="at">)]</span></span>
<span id="cb108-160"><a href="#cb108-160" aria-hidden="true" tabindex="-1"></a>    <span class="at">#[</span>cfg_attr<span class="at">(</span>feature <span class="op">=</span> <span class="st">&quot;std&quot;</span><span class="op">,</span> derive<span class="at">(</span><span class="pp">scale_info::</span>TypeInfo<span class="at">))]</span></span>
<span id="cb108-161"><a href="#cb108-161" aria-hidden="true" tabindex="-1"></a>    <span class="kw">pub</span> <span class="kw">enum</span> TransferResult <span class="op">{</span></span>
<span id="cb108-162"><a href="#cb108-162" aria-hidden="true" tabindex="-1"></a>        <span class="cn">Success</span><span class="op">,</span></span>
<span id="cb108-163"><a href="#cb108-163" aria-hidden="true" tabindex="-1"></a>        Failed(<span class="bu">Error</span>)<span class="op">,</span></span>
<span id="cb108-164"><a href="#cb108-164" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb108-165"><a href="#cb108-165" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<h3 id="recovery-and-fallback-mechanisms">Recovery and Fallback
Mechanisms</h3>
<p>Implement recovery patterns for handling failures gracefully:</p>
<div class="sourceCode" id="cb109"><pre
class="sourceCode rust"><code class="sourceCode rust"><span id="cb109-1"><a href="#cb109-1" aria-hidden="true" tabindex="-1"></a><span class="kw">impl</span> AdvancedContract <span class="op">{</span></span>
<span id="cb109-2"><a href="#cb109-2" aria-hidden="true" tabindex="-1"></a>    <span class="co">/// Emergency pause mechanism</span></span>
<span id="cb109-3"><a href="#cb109-3" aria-hidden="true" tabindex="-1"></a>    <span class="at">#[</span>ink<span class="at">(</span>message<span class="at">)]</span></span>
<span id="cb109-4"><a href="#cb109-4" aria-hidden="true" tabindex="-1"></a>    <span class="kw">pub</span> <span class="kw">fn</span> emergency_pause(<span class="op">&amp;</span><span class="kw">mut</span> <span class="kw">self</span>) <span class="op">-&gt;</span> <span class="dt">Result</span><span class="op">&lt;</span>()<span class="op">,</span> <span class="bu">Error</span><span class="op">&gt;</span> <span class="op">{</span></span>
<span id="cb109-5"><a href="#cb109-5" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="kw">self</span><span class="op">.</span>env()<span class="op">.</span>caller() <span class="op">!=</span> <span class="kw">self</span><span class="op">.</span>owner <span class="op">{</span></span>
<span id="cb109-6"><a href="#cb109-6" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> <span class="cn">Err</span>(<span class="bu">Error</span><span class="pp">::</span>NotOwner)<span class="op">;</span></span>
<span id="cb109-7"><a href="#cb109-7" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb109-8"><a href="#cb109-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb109-9"><a href="#cb109-9" aria-hidden="true" tabindex="-1"></a>        <span class="kw">self</span><span class="op">.</span>paused <span class="op">=</span> <span class="cn">true</span><span class="op">;</span></span>
<span id="cb109-10"><a href="#cb109-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb109-11"><a href="#cb109-11" aria-hidden="true" tabindex="-1"></a>        <span class="kw">self</span><span class="op">.</span>env()<span class="op">.</span>emit_event(EmergencyPause <span class="op">{</span></span>
<span id="cb109-12"><a href="#cb109-12" aria-hidden="true" tabindex="-1"></a>            triggered_by<span class="op">:</span> <span class="kw">self</span><span class="op">.</span>env()<span class="op">.</span>caller()<span class="op">,</span></span>
<span id="cb109-13"><a href="#cb109-13" aria-hidden="true" tabindex="-1"></a>            timestamp<span class="op">:</span> <span class="kw">self</span><span class="op">.</span>env()<span class="op">.</span>block_timestamp()<span class="op">,</span></span>
<span id="cb109-14"><a href="#cb109-14" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span>)<span class="op">;</span></span>
<span id="cb109-15"><a href="#cb109-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb109-16"><a href="#cb109-16" aria-hidden="true" tabindex="-1"></a>        <span class="cn">Ok</span>(())</span>
<span id="cb109-17"><a href="#cb109-17" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb109-18"><a href="#cb109-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb109-19"><a href="#cb109-19" aria-hidden="true" tabindex="-1"></a>    <span class="co">/// Recovery function with validation</span></span>
<span id="cb109-20"><a href="#cb109-20" aria-hidden="true" tabindex="-1"></a>    <span class="at">#[</span>ink<span class="at">(</span>message<span class="at">)]</span></span>
<span id="cb109-21"><a href="#cb109-21" aria-hidden="true" tabindex="-1"></a>    <span class="kw">pub</span> <span class="kw">fn</span> recover_from_emergency(<span class="op">&amp;</span><span class="kw">mut</span> <span class="kw">self</span>) <span class="op">-&gt;</span> <span class="dt">Result</span><span class="op">&lt;</span>()<span class="op">,</span> <span class="bu">Error</span><span class="op">&gt;</span> <span class="op">{</span></span>
<span id="cb109-22"><a href="#cb109-22" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="kw">self</span><span class="op">.</span>env()<span class="op">.</span>caller() <span class="op">!=</span> <span class="kw">self</span><span class="op">.</span>owner <span class="op">{</span></span>
<span id="cb109-23"><a href="#cb109-23" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> <span class="cn">Err</span>(<span class="bu">Error</span><span class="pp">::</span>NotOwner)<span class="op">;</span></span>
<span id="cb109-24"><a href="#cb109-24" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb109-25"><a href="#cb109-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb109-26"><a href="#cb109-26" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="op">!</span><span class="kw">self</span><span class="op">.</span>paused <span class="op">{</span></span>
<span id="cb109-27"><a href="#cb109-27" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> <span class="cn">Err</span>(<span class="bu">Error</span><span class="pp">::</span>InvalidState)<span class="op">;</span></span>
<span id="cb109-28"><a href="#cb109-28" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb109-29"><a href="#cb109-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb109-30"><a href="#cb109-30" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Perform recovery validations</span></span>
<span id="cb109-31"><a href="#cb109-31" aria-hidden="true" tabindex="-1"></a>        <span class="kw">self</span><span class="op">.</span>validate_contract_state()<span class="op">?;</span></span>
<span id="cb109-32"><a href="#cb109-32" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb109-33"><a href="#cb109-33" aria-hidden="true" tabindex="-1"></a>        <span class="kw">self</span><span class="op">.</span>paused <span class="op">=</span> <span class="cn">false</span><span class="op">;</span></span>
<span id="cb109-34"><a href="#cb109-34" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb109-35"><a href="#cb109-35" aria-hidden="true" tabindex="-1"></a>        <span class="kw">self</span><span class="op">.</span>env()<span class="op">.</span>emit_event(EmergencyRecovery <span class="op">{</span></span>
<span id="cb109-36"><a href="#cb109-36" aria-hidden="true" tabindex="-1"></a>            executed_by<span class="op">:</span> <span class="kw">self</span><span class="op">.</span>env()<span class="op">.</span>caller()<span class="op">,</span></span>
<span id="cb109-37"><a href="#cb109-37" aria-hidden="true" tabindex="-1"></a>            timestamp<span class="op">:</span> <span class="kw">self</span><span class="op">.</span>env()<span class="op">.</span>block_timestamp()<span class="op">,</span></span>
<span id="cb109-38"><a href="#cb109-38" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span>)<span class="op">;</span></span>
<span id="cb109-39"><a href="#cb109-39" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb109-40"><a href="#cb109-40" aria-hidden="true" tabindex="-1"></a>        <span class="cn">Ok</span>(())</span>
<span id="cb109-41"><a href="#cb109-41" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb109-42"><a href="#cb109-42" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb109-43"><a href="#cb109-43" aria-hidden="true" tabindex="-1"></a>    <span class="co">/// Validate contract invariants</span></span>
<span id="cb109-44"><a href="#cb109-44" aria-hidden="true" tabindex="-1"></a>    <span class="kw">fn</span> validate_contract_state(<span class="op">&amp;</span><span class="kw">self</span>) <span class="op">-&gt;</span> <span class="dt">Result</span><span class="op">&lt;</span>()<span class="op">,</span> <span class="bu">Error</span><span class="op">&gt;</span> <span class="op">{</span></span>
<span id="cb109-45"><a href="#cb109-45" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Implement contract-specific validation logic</span></span>
<span id="cb109-46"><a href="#cb109-46" aria-hidden="true" tabindex="-1"></a>        <span class="co">// For example, check that total balances don&#39;t exceed total supply</span></span>
<span id="cb109-47"><a href="#cb109-47" aria-hidden="true" tabindex="-1"></a>        <span class="cn">Ok</span>(())</span>
<span id="cb109-48"><a href="#cb109-48" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb109-49"><a href="#cb109-49" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb109-50"><a href="#cb109-50" aria-hidden="true" tabindex="-1"></a>    <span class="co">/// Graceful degradation - limited functionality during issues</span></span>
<span id="cb109-51"><a href="#cb109-51" aria-hidden="true" tabindex="-1"></a>    <span class="at">#[</span>ink<span class="at">(</span>message<span class="at">)]</span></span>
<span id="cb109-52"><a href="#cb109-52" aria-hidden="true" tabindex="-1"></a>    <span class="kw">pub</span> <span class="kw">fn</span> safe_mode_transfer(<span class="op">&amp;</span><span class="kw">mut</span> <span class="kw">self</span><span class="op">,</span> to<span class="op">:</span> AccountId<span class="op">,</span> amount<span class="op">:</span> Balance) <span class="op">-&gt;</span> <span class="dt">Result</span><span class="op">&lt;</span>()<span class="op">,</span> <span class="bu">Error</span><span class="op">&gt;</span> <span class="op">{</span></span>
<span id="cb109-53"><a href="#cb109-53" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Only allow small transfers in safe mode</span></span>
<span id="cb109-54"><a href="#cb109-54" aria-hidden="true" tabindex="-1"></a>        <span class="kw">const</span> SAFE_MODE_LIMIT<span class="op">:</span> Balance <span class="op">=</span> <span class="dv">1000</span><span class="op">;</span></span>
<span id="cb109-55"><a href="#cb109-55" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb109-56"><a href="#cb109-56" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> amount <span class="op">&gt;</span> SAFE_MODE_LIMIT <span class="op">{</span></span>
<span id="cb109-57"><a href="#cb109-57" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> <span class="cn">Err</span>(<span class="bu">Error</span><span class="pp">::</span>QuotaExceeded)<span class="op">;</span></span>
<span id="cb109-58"><a href="#cb109-58" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb109-59"><a href="#cb109-59" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb109-60"><a href="#cb109-60" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Use more conservative validation</span></span>
<span id="cb109-61"><a href="#cb109-61" aria-hidden="true" tabindex="-1"></a>        <span class="kw">self</span><span class="op">.</span>validate_transfer_params(to<span class="op">,</span> amount)<span class="op">?;</span></span>
<span id="cb109-62"><a href="#cb109-62" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb109-63"><a href="#cb109-63" aria-hidden="true" tabindex="-1"></a>        <span class="kw">let</span> from <span class="op">=</span> <span class="kw">self</span><span class="op">.</span>env()<span class="op">.</span>caller()<span class="op">;</span></span>
<span id="cb109-64"><a href="#cb109-64" aria-hidden="true" tabindex="-1"></a>        <span class="kw">let</span> from_balance <span class="op">=</span> <span class="kw">self</span><span class="op">.</span>balances<span class="op">.</span>get(from)<span class="op">.</span>unwrap_or(<span class="dv">0</span>)<span class="op">;</span></span>
<span id="cb109-65"><a href="#cb109-65" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb109-66"><a href="#cb109-66" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> from_balance <span class="op">&lt;</span> amount <span class="op">{</span></span>
<span id="cb109-67"><a href="#cb109-67" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> <span class="cn">Err</span>(<span class="bu">Error</span><span class="pp">::</span>InsufficientBalance)<span class="op">;</span></span>
<span id="cb109-68"><a href="#cb109-68" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb109-69"><a href="#cb109-69" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb109-70"><a href="#cb109-70" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Execute with extra safety checks</span></span>
<span id="cb109-71"><a href="#cb109-71" aria-hidden="true" tabindex="-1"></a>        <span class="kw">self</span><span class="op">.</span>execute_transfer(from<span class="op">,</span> to<span class="op">,</span> amount)</span>
<span id="cb109-72"><a href="#cb109-72" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb109-73"><a href="#cb109-73" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<h2 id="trait-based-contract-architecture">Trait-Based Contract
Architecture</h2>
<p>Use Rust traits to create modular, reusable contract interfaces and
implementations.</p>
<h3 id="standard-interface-definitions">Standard Interface
Definitions</h3>
<p>Define common interfaces as traits:</p>
<div class="sourceCode" id="cb110"><pre
class="sourceCode rust"><code class="sourceCode rust"><span id="cb110-1"><a href="#cb110-1" aria-hidden="true" tabindex="-1"></a><span class="co">/// Standard token interface</span></span>
<span id="cb110-2"><a href="#cb110-2" aria-hidden="true" tabindex="-1"></a><span class="at">#[</span><span class="pp">ink::</span>trait_definition<span class="at">]</span></span>
<span id="cb110-3"><a href="#cb110-3" aria-hidden="true" tabindex="-1"></a><span class="kw">pub</span> <span class="kw">trait</span> PSP22 <span class="op">{</span></span>
<span id="cb110-4"><a href="#cb110-4" aria-hidden="true" tabindex="-1"></a>    <span class="co">/// Returns the total token supply.</span></span>
<span id="cb110-5"><a href="#cb110-5" aria-hidden="true" tabindex="-1"></a>    <span class="at">#[</span>ink<span class="at">(</span>message<span class="at">)]</span></span>
<span id="cb110-6"><a href="#cb110-6" aria-hidden="true" tabindex="-1"></a>    <span class="kw">fn</span> total_supply(<span class="op">&amp;</span><span class="kw">self</span>) <span class="op">-&gt;</span> Balance<span class="op">;</span></span>
<span id="cb110-7"><a href="#cb110-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb110-8"><a href="#cb110-8" aria-hidden="true" tabindex="-1"></a>    <span class="co">/// Returns the account balance for the specified `owner`.</span></span>
<span id="cb110-9"><a href="#cb110-9" aria-hidden="true" tabindex="-1"></a>    <span class="at">#[</span>ink<span class="at">(</span>message<span class="at">)]</span></span>
<span id="cb110-10"><a href="#cb110-10" aria-hidden="true" tabindex="-1"></a>    <span class="kw">fn</span> balance_of(<span class="op">&amp;</span><span class="kw">self</span><span class="op">,</span> owner<span class="op">:</span> AccountId) <span class="op">-&gt;</span> Balance<span class="op">;</span></span>
<span id="cb110-11"><a href="#cb110-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb110-12"><a href="#cb110-12" aria-hidden="true" tabindex="-1"></a>    <span class="co">/// Returns the amount which `spender` is still allowed to withdraw from `owner`.</span></span>
<span id="cb110-13"><a href="#cb110-13" aria-hidden="true" tabindex="-1"></a>    <span class="at">#[</span>ink<span class="at">(</span>message<span class="at">)]</span></span>
<span id="cb110-14"><a href="#cb110-14" aria-hidden="true" tabindex="-1"></a>    <span class="kw">fn</span> allowance(<span class="op">&amp;</span><span class="kw">self</span><span class="op">,</span> owner<span class="op">:</span> AccountId<span class="op">,</span> spender<span class="op">:</span> AccountId) <span class="op">-&gt;</span> Balance<span class="op">;</span></span>
<span id="cb110-15"><a href="#cb110-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb110-16"><a href="#cb110-16" aria-hidden="true" tabindex="-1"></a>    <span class="co">/// Transfers `value` amount of tokens from the caller&#39;s account to account `to`.</span></span>
<span id="cb110-17"><a href="#cb110-17" aria-hidden="true" tabindex="-1"></a>    <span class="at">#[</span>ink<span class="at">(</span>message<span class="at">)]</span></span>
<span id="cb110-18"><a href="#cb110-18" aria-hidden="true" tabindex="-1"></a>    <span class="kw">fn</span> transfer(<span class="op">&amp;</span><span class="kw">mut</span> <span class="kw">self</span><span class="op">,</span> to<span class="op">:</span> AccountId<span class="op">,</span> value<span class="op">:</span> Balance) <span class="op">-&gt;</span> <span class="dt">Result</span><span class="op">&lt;</span>()<span class="op">,</span> PSP22Error<span class="op">&gt;;</span></span>
<span id="cb110-19"><a href="#cb110-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb110-20"><a href="#cb110-20" aria-hidden="true" tabindex="-1"></a>    <span class="co">/// Allows `spender` to withdraw from the caller&#39;s account multiple times.</span></span>
<span id="cb110-21"><a href="#cb110-21" aria-hidden="true" tabindex="-1"></a>    <span class="at">#[</span>ink<span class="at">(</span>message<span class="at">)]</span></span>
<span id="cb110-22"><a href="#cb110-22" aria-hidden="true" tabindex="-1"></a>    <span class="kw">fn</span> approve(<span class="op">&amp;</span><span class="kw">mut</span> <span class="kw">self</span><span class="op">,</span> spender<span class="op">:</span> AccountId<span class="op">,</span> value<span class="op">:</span> Balance) <span class="op">-&gt;</span> <span class="dt">Result</span><span class="op">&lt;</span>()<span class="op">,</span> PSP22Error<span class="op">&gt;;</span></span>
<span id="cb110-23"><a href="#cb110-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb110-24"><a href="#cb110-24" aria-hidden="true" tabindex="-1"></a>    <span class="co">/// Transfers `value` tokens on behalf of `from` to the account `to`.</span></span>
<span id="cb110-25"><a href="#cb110-25" aria-hidden="true" tabindex="-1"></a>    <span class="at">#[</span>ink<span class="at">(</span>message<span class="at">)]</span></span>
<span id="cb110-26"><a href="#cb110-26" aria-hidden="true" tabindex="-1"></a>    <span class="kw">fn</span> transfer_from(<span class="op">&amp;</span><span class="kw">mut</span> <span class="kw">self</span><span class="op">,</span> from<span class="op">:</span> AccountId<span class="op">,</span> to<span class="op">:</span> AccountId<span class="op">,</span> value<span class="op">:</span> Balance) <span class="op">-&gt;</span> <span class="dt">Result</span><span class="op">&lt;</span>()<span class="op">,</span> PSP22Error<span class="op">&gt;;</span></span>
<span id="cb110-27"><a href="#cb110-27" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb110-28"><a href="#cb110-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb110-29"><a href="#cb110-29" aria-hidden="true" tabindex="-1"></a><span class="co">/// Access control interface</span></span>
<span id="cb110-30"><a href="#cb110-30" aria-hidden="true" tabindex="-1"></a><span class="at">#[</span><span class="pp">ink::</span>trait_definition<span class="at">]</span></span>
<span id="cb110-31"><a href="#cb110-31" aria-hidden="true" tabindex="-1"></a><span class="kw">pub</span> <span class="kw">trait</span> AccessControl <span class="op">{</span></span>
<span id="cb110-32"><a href="#cb110-32" aria-hidden="true" tabindex="-1"></a>    <span class="co">/// Returns `true` if `account` has been granted `role`.</span></span>
<span id="cb110-33"><a href="#cb110-33" aria-hidden="true" tabindex="-1"></a>    <span class="at">#[</span>ink<span class="at">(</span>message<span class="at">)]</span></span>
<span id="cb110-34"><a href="#cb110-34" aria-hidden="true" tabindex="-1"></a>    <span class="kw">fn</span> has_role(<span class="op">&amp;</span><span class="kw">self</span><span class="op">,</span> role<span class="op">:</span> RoleType<span class="op">,</span> account<span class="op">:</span> AccountId) <span class="op">-&gt;</span> <span class="dt">bool</span><span class="op">;</span></span>
<span id="cb110-35"><a href="#cb110-35" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb110-36"><a href="#cb110-36" aria-hidden="true" tabindex="-1"></a>    <span class="co">/// Grants `role` to `account`.</span></span>
<span id="cb110-37"><a href="#cb110-37" aria-hidden="true" tabindex="-1"></a>    <span class="at">#[</span>ink<span class="at">(</span>message<span class="at">)]</span></span>
<span id="cb110-38"><a href="#cb110-38" aria-hidden="true" tabindex="-1"></a>    <span class="kw">fn</span> grant_role(<span class="op">&amp;</span><span class="kw">mut</span> <span class="kw">self</span><span class="op">,</span> role<span class="op">:</span> RoleType<span class="op">,</span> account<span class="op">:</span> AccountId) <span class="op">-&gt;</span> <span class="dt">Result</span><span class="op">&lt;</span>()<span class="op">,</span> AccessControlError<span class="op">&gt;;</span></span>
<span id="cb110-39"><a href="#cb110-39" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb110-40"><a href="#cb110-40" aria-hidden="true" tabindex="-1"></a>    <span class="co">/// Revokes `role` from `account`.</span></span>
<span id="cb110-41"><a href="#cb110-41" aria-hidden="true" tabindex="-1"></a>    <span class="at">#[</span>ink<span class="at">(</span>message<span class="at">)]</span></span>
<span id="cb110-42"><a href="#cb110-42" aria-hidden="true" tabindex="-1"></a>    <span class="kw">fn</span> revoke_role(<span class="op">&amp;</span><span class="kw">mut</span> <span class="kw">self</span><span class="op">,</span> role<span class="op">:</span> RoleType<span class="op">,</span> account<span class="op">:</span> AccountId) <span class="op">-&gt;</span> <span class="dt">Result</span><span class="op">&lt;</span>()<span class="op">,</span> AccessControlError<span class="op">&gt;;</span></span>
<span id="cb110-43"><a href="#cb110-43" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb110-44"><a href="#cb110-44" aria-hidden="true" tabindex="-1"></a>    <span class="co">/// Returns the admin role that controls `role`.</span></span>
<span id="cb110-45"><a href="#cb110-45" aria-hidden="true" tabindex="-1"></a>    <span class="at">#[</span>ink<span class="at">(</span>message<span class="at">)]</span></span>
<span id="cb110-46"><a href="#cb110-46" aria-hidden="true" tabindex="-1"></a>    <span class="kw">fn</span> get_role_admin(<span class="op">&amp;</span><span class="kw">self</span><span class="op">,</span> role<span class="op">:</span> RoleType) <span class="op">-&gt;</span> RoleType<span class="op">;</span></span>
<span id="cb110-47"><a href="#cb110-47" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb110-48"><a href="#cb110-48" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb110-49"><a href="#cb110-49" aria-hidden="true" tabindex="-1"></a><span class="co">/// Pausable contract interface</span></span>
<span id="cb110-50"><a href="#cb110-50" aria-hidden="true" tabindex="-1"></a><span class="at">#[</span><span class="pp">ink::</span>trait_definition<span class="at">]</span></span>
<span id="cb110-51"><a href="#cb110-51" aria-hidden="true" tabindex="-1"></a><span class="kw">pub</span> <span class="kw">trait</span> Pausable <span class="op">{</span></span>
<span id="cb110-52"><a href="#cb110-52" aria-hidden="true" tabindex="-1"></a>    <span class="co">/// Returns `true` if the contract is paused.</span></span>
<span id="cb110-53"><a href="#cb110-53" aria-hidden="true" tabindex="-1"></a>    <span class="at">#[</span>ink<span class="at">(</span>message<span class="at">)]</span></span>
<span id="cb110-54"><a href="#cb110-54" aria-hidden="true" tabindex="-1"></a>    <span class="kw">fn</span> paused(<span class="op">&amp;</span><span class="kw">self</span>) <span class="op">-&gt;</span> <span class="dt">bool</span><span class="op">;</span></span>
<span id="cb110-55"><a href="#cb110-55" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb110-56"><a href="#cb110-56" aria-hidden="true" tabindex="-1"></a>    <span class="co">/// Pauses all contract operations.</span></span>
<span id="cb110-57"><a href="#cb110-57" aria-hidden="true" tabindex="-1"></a>    <span class="at">#[</span>ink<span class="at">(</span>message<span class="at">)]</span></span>
<span id="cb110-58"><a href="#cb110-58" aria-hidden="true" tabindex="-1"></a>    <span class="kw">fn</span> pause(<span class="op">&amp;</span><span class="kw">mut</span> <span class="kw">self</span>) <span class="op">-&gt;</span> <span class="dt">Result</span><span class="op">&lt;</span>()<span class="op">,</span> PausableError<span class="op">&gt;;</span></span>
<span id="cb110-59"><a href="#cb110-59" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb110-60"><a href="#cb110-60" aria-hidden="true" tabindex="-1"></a>    <span class="co">/// Unpauses all contract operations.</span></span>
<span id="cb110-61"><a href="#cb110-61" aria-hidden="true" tabindex="-1"></a>    <span class="at">#[</span>ink<span class="at">(</span>message<span class="at">)]</span></span>
<span id="cb110-62"><a href="#cb110-62" aria-hidden="true" tabindex="-1"></a>    <span class="kw">fn</span> unpause(<span class="op">&amp;</span><span class="kw">mut</span> <span class="kw">self</span>) <span class="op">-&gt;</span> <span class="dt">Result</span><span class="op">&lt;</span>()<span class="op">,</span> PausableError<span class="op">&gt;;</span></span>
<span id="cb110-63"><a href="#cb110-63" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<h3 id="modular-contract-implementation">Modular Contract
Implementation</h3>
<p>Implement contracts using composition of traits:</p>
<div class="sourceCode" id="cb111"><pre
class="sourceCode rust"><code class="sourceCode rust"><span id="cb111-1"><a href="#cb111-1" aria-hidden="true" tabindex="-1"></a><span class="at">#[</span><span class="pp">ink::</span>contract<span class="at">]</span></span>
<span id="cb111-2"><a href="#cb111-2" aria-hidden="true" tabindex="-1"></a><span class="kw">mod</span> modular_token <span class="op">{</span></span>
<span id="cb111-3"><a href="#cb111-3" aria-hidden="true" tabindex="-1"></a>    <span class="kw">use</span> <span class="kw">super</span><span class="pp">::</span><span class="op">*;</span></span>
<span id="cb111-4"><a href="#cb111-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb111-5"><a href="#cb111-5" aria-hidden="true" tabindex="-1"></a>    <span class="at">#[</span>ink<span class="at">(</span>storage<span class="at">)]</span></span>
<span id="cb111-6"><a href="#cb111-6" aria-hidden="true" tabindex="-1"></a>    <span class="kw">pub</span> <span class="kw">struct</span> ModularToken <span class="op">{</span></span>
<span id="cb111-7"><a href="#cb111-7" aria-hidden="true" tabindex="-1"></a>        <span class="co">// PSP22 data</span></span>
<span id="cb111-8"><a href="#cb111-8" aria-hidden="true" tabindex="-1"></a>        total_supply<span class="op">:</span> Balance<span class="op">,</span></span>
<span id="cb111-9"><a href="#cb111-9" aria-hidden="true" tabindex="-1"></a>        balances<span class="op">:</span> <span class="pp">ink::storage::</span>Mapping<span class="op">&lt;</span>AccountId<span class="op">,</span> Balance<span class="op">&gt;,</span></span>
<span id="cb111-10"><a href="#cb111-10" aria-hidden="true" tabindex="-1"></a>        allowances<span class="op">:</span> <span class="pp">ink::storage::</span>Mapping<span class="op">&lt;</span>(AccountId<span class="op">,</span> AccountId)<span class="op">,</span> Balance<span class="op">&gt;,</span></span>
<span id="cb111-11"><a href="#cb111-11" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb111-12"><a href="#cb111-12" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Access control data</span></span>
<span id="cb111-13"><a href="#cb111-13" aria-hidden="true" tabindex="-1"></a>        roles<span class="op">:</span> <span class="pp">ink::storage::</span>Mapping<span class="op">&lt;</span>(RoleType<span class="op">,</span> AccountId)<span class="op">,</span> ()<span class="op">&gt;,</span></span>
<span id="cb111-14"><a href="#cb111-14" aria-hidden="true" tabindex="-1"></a>        role_admins<span class="op">:</span> <span class="pp">ink::storage::</span>Mapping<span class="op">&lt;</span>RoleType<span class="op">,</span> RoleType<span class="op">&gt;,</span></span>
<span id="cb111-15"><a href="#cb111-15" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb111-16"><a href="#cb111-16" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Pausable data</span></span>
<span id="cb111-17"><a href="#cb111-17" aria-hidden="true" tabindex="-1"></a>        paused<span class="op">:</span> <span class="dt">bool</span><span class="op">,</span></span>
<span id="cb111-18"><a href="#cb111-18" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb111-19"><a href="#cb111-19" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Token metadata</span></span>
<span id="cb111-20"><a href="#cb111-20" aria-hidden="true" tabindex="-1"></a>        name<span class="op">:</span> <span class="dt">String</span><span class="op">,</span></span>
<span id="cb111-21"><a href="#cb111-21" aria-hidden="true" tabindex="-1"></a>        symbol<span class="op">:</span> <span class="dt">String</span><span class="op">,</span></span>
<span id="cb111-22"><a href="#cb111-22" aria-hidden="true" tabindex="-1"></a>        decimals<span class="op">:</span> <span class="dt">u8</span><span class="op">,</span></span>
<span id="cb111-23"><a href="#cb111-23" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb111-24"><a href="#cb111-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb111-25"><a href="#cb111-25" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Role definitions</span></span>
<span id="cb111-26"><a href="#cb111-26" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> DEFAULT_ADMIN_ROLE<span class="op">:</span> RoleType <span class="op">=</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb111-27"><a href="#cb111-27" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> MINTER_ROLE<span class="op">:</span> RoleType <span class="op">=</span> <span class="dv">1</span><span class="op">;</span></span>
<span id="cb111-28"><a href="#cb111-28" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> PAUSER_ROLE<span class="op">:</span> RoleType <span class="op">=</span> <span class="dv">2</span><span class="op">;</span></span>
<span id="cb111-29"><a href="#cb111-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb111-30"><a href="#cb111-30" aria-hidden="true" tabindex="-1"></a>    <span class="kw">impl</span> ModularToken <span class="op">{</span></span>
<span id="cb111-31"><a href="#cb111-31" aria-hidden="true" tabindex="-1"></a>        <span class="at">#[</span>ink<span class="at">(</span>constructor<span class="at">)]</span></span>
<span id="cb111-32"><a href="#cb111-32" aria-hidden="true" tabindex="-1"></a>        <span class="kw">pub</span> <span class="kw">fn</span> new(</span>
<span id="cb111-33"><a href="#cb111-33" aria-hidden="true" tabindex="-1"></a>            total_supply<span class="op">:</span> Balance<span class="op">,</span></span>
<span id="cb111-34"><a href="#cb111-34" aria-hidden="true" tabindex="-1"></a>            name<span class="op">:</span> <span class="dt">String</span><span class="op">,</span></span>
<span id="cb111-35"><a href="#cb111-35" aria-hidden="true" tabindex="-1"></a>            symbol<span class="op">:</span> <span class="dt">String</span><span class="op">,</span></span>
<span id="cb111-36"><a href="#cb111-36" aria-hidden="true" tabindex="-1"></a>            decimals<span class="op">:</span> <span class="dt">u8</span><span class="op">,</span></span>
<span id="cb111-37"><a href="#cb111-37" aria-hidden="true" tabindex="-1"></a>        ) <span class="op">-&gt;</span> <span class="dt">Self</span> <span class="op">{</span></span>
<span id="cb111-38"><a href="#cb111-38" aria-hidden="true" tabindex="-1"></a>            <span class="kw">let</span> caller <span class="op">=</span> <span class="dt">Self</span><span class="pp">::</span>env()<span class="op">.</span>caller()<span class="op">;</span></span>
<span id="cb111-39"><a href="#cb111-39" aria-hidden="true" tabindex="-1"></a>            <span class="kw">let</span> <span class="kw">mut</span> instance <span class="op">=</span> <span class="dt">Self</span> <span class="op">{</span></span>
<span id="cb111-40"><a href="#cb111-40" aria-hidden="true" tabindex="-1"></a>                total_supply<span class="op">,</span></span>
<span id="cb111-41"><a href="#cb111-41" aria-hidden="true" tabindex="-1"></a>                balances<span class="op">:</span> <span class="pp">ink::storage::Mapping::</span><span class="kw">default</span>()<span class="op">,</span></span>
<span id="cb111-42"><a href="#cb111-42" aria-hidden="true" tabindex="-1"></a>                allowances<span class="op">:</span> <span class="pp">ink::storage::Mapping::</span><span class="kw">default</span>()<span class="op">,</span></span>
<span id="cb111-43"><a href="#cb111-43" aria-hidden="true" tabindex="-1"></a>                roles<span class="op">:</span> <span class="pp">ink::storage::Mapping::</span><span class="kw">default</span>()<span class="op">,</span></span>
<span id="cb111-44"><a href="#cb111-44" aria-hidden="true" tabindex="-1"></a>                role_admins<span class="op">:</span> <span class="pp">ink::storage::Mapping::</span><span class="kw">default</span>()<span class="op">,</span></span>
<span id="cb111-45"><a href="#cb111-45" aria-hidden="true" tabindex="-1"></a>                paused<span class="op">:</span> <span class="cn">false</span><span class="op">,</span></span>
<span id="cb111-46"><a href="#cb111-46" aria-hidden="true" tabindex="-1"></a>                name<span class="op">,</span></span>
<span id="cb111-47"><a href="#cb111-47" aria-hidden="true" tabindex="-1"></a>                symbol<span class="op">,</span></span>
<span id="cb111-48"><a href="#cb111-48" aria-hidden="true" tabindex="-1"></a>                decimals<span class="op">,</span></span>
<span id="cb111-49"><a href="#cb111-49" aria-hidden="true" tabindex="-1"></a>            <span class="op">};</span></span>
<span id="cb111-50"><a href="#cb111-50" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb111-51"><a href="#cb111-51" aria-hidden="true" tabindex="-1"></a>            <span class="co">// Set up initial balance</span></span>
<span id="cb111-52"><a href="#cb111-52" aria-hidden="true" tabindex="-1"></a>            instance<span class="op">.</span>balances<span class="op">.</span>insert(caller<span class="op">,</span> <span class="op">&amp;</span>total_supply)<span class="op">;</span></span>
<span id="cb111-53"><a href="#cb111-53" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb111-54"><a href="#cb111-54" aria-hidden="true" tabindex="-1"></a>            <span class="co">// Set up default admin role</span></span>
<span id="cb111-55"><a href="#cb111-55" aria-hidden="true" tabindex="-1"></a>            instance<span class="op">.</span>roles<span class="op">.</span>insert((DEFAULT_ADMIN_ROLE<span class="op">,</span> caller)<span class="op">,</span> <span class="op">&amp;</span>())<span class="op">;</span></span>
<span id="cb111-56"><a href="#cb111-56" aria-hidden="true" tabindex="-1"></a>            instance<span class="op">.</span>role_admins<span class="op">.</span>insert(MINTER_ROLE<span class="op">,</span> <span class="op">&amp;</span>DEFAULT_ADMIN_ROLE)<span class="op">;</span></span>
<span id="cb111-57"><a href="#cb111-57" aria-hidden="true" tabindex="-1"></a>            instance<span class="op">.</span>role_admins<span class="op">.</span>insert(PAUSER_ROLE<span class="op">,</span> <span class="op">&amp;</span>DEFAULT_ADMIN_ROLE)<span class="op">;</span></span>
<span id="cb111-58"><a href="#cb111-58" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb111-59"><a href="#cb111-59" aria-hidden="true" tabindex="-1"></a>            instance</span>
<span id="cb111-60"><a href="#cb111-60" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb111-61"><a href="#cb111-61" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb111-62"><a href="#cb111-62" aria-hidden="true" tabindex="-1"></a>        <span class="co">/// Mint tokens (requires MINTER_ROLE)</span></span>
<span id="cb111-63"><a href="#cb111-63" aria-hidden="true" tabindex="-1"></a>        <span class="at">#[</span>ink<span class="at">(</span>message<span class="at">)]</span></span>
<span id="cb111-64"><a href="#cb111-64" aria-hidden="true" tabindex="-1"></a>        <span class="kw">pub</span> <span class="kw">fn</span> mint(<span class="op">&amp;</span><span class="kw">mut</span> <span class="kw">self</span><span class="op">,</span> to<span class="op">:</span> AccountId<span class="op">,</span> amount<span class="op">:</span> Balance) <span class="op">-&gt;</span> <span class="dt">Result</span><span class="op">&lt;</span>()<span class="op">,</span> <span class="bu">Error</span><span class="op">&gt;</span> <span class="op">{</span></span>
<span id="cb111-65"><a href="#cb111-65" aria-hidden="true" tabindex="-1"></a>            <span class="kw">let</span> caller <span class="op">=</span> <span class="kw">self</span><span class="op">.</span>env()<span class="op">.</span>caller()<span class="op">;</span></span>
<span id="cb111-66"><a href="#cb111-66" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb111-67"><a href="#cb111-67" aria-hidden="true" tabindex="-1"></a>            <span class="co">// Check permissions</span></span>
<span id="cb111-68"><a href="#cb111-68" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> <span class="op">!</span><span class="kw">self</span><span class="op">.</span>has_role(MINTER_ROLE<span class="op">,</span> caller) <span class="op">{</span></span>
<span id="cb111-69"><a href="#cb111-69" aria-hidden="true" tabindex="-1"></a>                <span class="cf">return</span> <span class="cn">Err</span>(<span class="bu">Error</span><span class="pp">::</span>Unauthorized)<span class="op">;</span></span>
<span id="cb111-70"><a href="#cb111-70" aria-hidden="true" tabindex="-1"></a>            <span class="op">}</span></span>
<span id="cb111-71"><a href="#cb111-71" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb111-72"><a href="#cb111-72" aria-hidden="true" tabindex="-1"></a>            <span class="co">// Check if paused</span></span>
<span id="cb111-73"><a href="#cb111-73" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> <span class="kw">self</span><span class="op">.</span>paused() <span class="op">{</span></span>
<span id="cb111-74"><a href="#cb111-74" aria-hidden="true" tabindex="-1"></a>                <span class="cf">return</span> <span class="cn">Err</span>(<span class="bu">Error</span><span class="pp">::</span>ContractPaused)<span class="op">;</span></span>
<span id="cb111-75"><a href="#cb111-75" aria-hidden="true" tabindex="-1"></a>            <span class="op">}</span></span>
<span id="cb111-76"><a href="#cb111-76" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb111-77"><a href="#cb111-77" aria-hidden="true" tabindex="-1"></a>            <span class="co">// Mint logic</span></span>
<span id="cb111-78"><a href="#cb111-78" aria-hidden="true" tabindex="-1"></a>            <span class="kw">let</span> to_balance <span class="op">=</span> <span class="kw">self</span><span class="op">.</span>balances<span class="op">.</span>get(to)<span class="op">.</span>unwrap_or(<span class="dv">0</span>)<span class="op">;</span></span>
<span id="cb111-79"><a href="#cb111-79" aria-hidden="true" tabindex="-1"></a>            <span class="kw">let</span> new_balance <span class="op">=</span> to_balance<span class="op">.</span>checked_add(amount)</span>
<span id="cb111-80"><a href="#cb111-80" aria-hidden="true" tabindex="-1"></a>                <span class="op">.</span>ok_or(<span class="bu">Error</span><span class="pp">::</span>ArithmeticOverflow)<span class="op">?;</span></span>
<span id="cb111-81"><a href="#cb111-81" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb111-82"><a href="#cb111-82" aria-hidden="true" tabindex="-1"></a>            <span class="kw">self</span><span class="op">.</span>balances<span class="op">.</span>insert(to<span class="op">,</span> <span class="op">&amp;</span>new_balance)<span class="op">;</span></span>
<span id="cb111-83"><a href="#cb111-83" aria-hidden="true" tabindex="-1"></a>            <span class="kw">self</span><span class="op">.</span>total_supply <span class="op">=</span> <span class="kw">self</span><span class="op">.</span>total_supply<span class="op">.</span>checked_add(amount)</span>
<span id="cb111-84"><a href="#cb111-84" aria-hidden="true" tabindex="-1"></a>                <span class="op">.</span>ok_or(<span class="bu">Error</span><span class="pp">::</span>ArithmeticOverflow)<span class="op">?;</span></span>
<span id="cb111-85"><a href="#cb111-85" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb111-86"><a href="#cb111-86" aria-hidden="true" tabindex="-1"></a>            <span class="co">// Emit transfer event (from None = mint)</span></span>
<span id="cb111-87"><a href="#cb111-87" aria-hidden="true" tabindex="-1"></a>            <span class="kw">self</span><span class="op">.</span>env()<span class="op">.</span>emit_event(Transfer <span class="op">{</span></span>
<span id="cb111-88"><a href="#cb111-88" aria-hidden="true" tabindex="-1"></a>                from<span class="op">:</span> <span class="cn">None</span><span class="op">,</span></span>
<span id="cb111-89"><a href="#cb111-89" aria-hidden="true" tabindex="-1"></a>                to<span class="op">:</span> <span class="cn">Some</span>(to)<span class="op">,</span></span>
<span id="cb111-90"><a href="#cb111-90" aria-hidden="true" tabindex="-1"></a>                value<span class="op">:</span> amount<span class="op">,</span></span>
<span id="cb111-91"><a href="#cb111-91" aria-hidden="true" tabindex="-1"></a>            <span class="op">}</span>)<span class="op">;</span></span>
<span id="cb111-92"><a href="#cb111-92" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb111-93"><a href="#cb111-93" aria-hidden="true" tabindex="-1"></a>            <span class="cn">Ok</span>(())</span>
<span id="cb111-94"><a href="#cb111-94" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb111-95"><a href="#cb111-95" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb111-96"><a href="#cb111-96" aria-hidden="true" tabindex="-1"></a>        <span class="co">/// Burn tokens from caller&#39;s account</span></span>
<span id="cb111-97"><a href="#cb111-97" aria-hidden="true" tabindex="-1"></a>        <span class="at">#[</span>ink<span class="at">(</span>message<span class="at">)]</span></span>
<span id="cb111-98"><a href="#cb111-98" aria-hidden="true" tabindex="-1"></a>        <span class="kw">pub</span> <span class="kw">fn</span> burn(<span class="op">&amp;</span><span class="kw">mut</span> <span class="kw">self</span><span class="op">,</span> amount<span class="op">:</span> Balance) <span class="op">-&gt;</span> <span class="dt">Result</span><span class="op">&lt;</span>()<span class="op">,</span> <span class="bu">Error</span><span class="op">&gt;</span> <span class="op">{</span></span>
<span id="cb111-99"><a href="#cb111-99" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> <span class="kw">self</span><span class="op">.</span>paused() <span class="op">{</span></span>
<span id="cb111-100"><a href="#cb111-100" aria-hidden="true" tabindex="-1"></a>                <span class="cf">return</span> <span class="cn">Err</span>(<span class="bu">Error</span><span class="pp">::</span>ContractPaused)<span class="op">;</span></span>
<span id="cb111-101"><a href="#cb111-101" aria-hidden="true" tabindex="-1"></a>            <span class="op">}</span></span>
<span id="cb111-102"><a href="#cb111-102" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb111-103"><a href="#cb111-103" aria-hidden="true" tabindex="-1"></a>            <span class="kw">let</span> caller <span class="op">=</span> <span class="kw">self</span><span class="op">.</span>env()<span class="op">.</span>caller()<span class="op">;</span></span>
<span id="cb111-104"><a href="#cb111-104" aria-hidden="true" tabindex="-1"></a>            <span class="kw">let</span> caller_balance <span class="op">=</span> <span class="kw">self</span><span class="op">.</span>balances<span class="op">.</span>get(caller)<span class="op">.</span>unwrap_or(<span class="dv">0</span>)<span class="op">;</span></span>
<span id="cb111-105"><a href="#cb111-105" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb111-106"><a href="#cb111-106" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> caller_balance <span class="op">&lt;</span> amount <span class="op">{</span></span>
<span id="cb111-107"><a href="#cb111-107" aria-hidden="true" tabindex="-1"></a>                <span class="cf">return</span> <span class="cn">Err</span>(<span class="bu">Error</span><span class="pp">::</span>InsufficientBalance)<span class="op">;</span></span>
<span id="cb111-108"><a href="#cb111-108" aria-hidden="true" tabindex="-1"></a>            <span class="op">}</span></span>
<span id="cb111-109"><a href="#cb111-109" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb111-110"><a href="#cb111-110" aria-hidden="true" tabindex="-1"></a>            <span class="kw">let</span> new_balance <span class="op">=</span> caller_balance <span class="op">-</span> amount<span class="op">;</span></span>
<span id="cb111-111"><a href="#cb111-111" aria-hidden="true" tabindex="-1"></a>            <span class="kw">self</span><span class="op">.</span>balances<span class="op">.</span>insert(caller<span class="op">,</span> <span class="op">&amp;</span>new_balance)<span class="op">;</span></span>
<span id="cb111-112"><a href="#cb111-112" aria-hidden="true" tabindex="-1"></a>            <span class="kw">self</span><span class="op">.</span>total_supply <span class="op">-=</span> amount<span class="op">;</span></span>
<span id="cb111-113"><a href="#cb111-113" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb111-114"><a href="#cb111-114" aria-hidden="true" tabindex="-1"></a>            <span class="co">// Emit transfer event (to None = burn)</span></span>
<span id="cb111-115"><a href="#cb111-115" aria-hidden="true" tabindex="-1"></a>            <span class="kw">self</span><span class="op">.</span>env()<span class="op">.</span>emit_event(Transfer <span class="op">{</span></span>
<span id="cb111-116"><a href="#cb111-116" aria-hidden="true" tabindex="-1"></a>                from<span class="op">:</span> <span class="cn">Some</span>(caller)<span class="op">,</span></span>
<span id="cb111-117"><a href="#cb111-117" aria-hidden="true" tabindex="-1"></a>                to<span class="op">:</span> <span class="cn">None</span><span class="op">,</span></span>
<span id="cb111-118"><a href="#cb111-118" aria-hidden="true" tabindex="-1"></a>                value<span class="op">:</span> amount<span class="op">,</span></span>
<span id="cb111-119"><a href="#cb111-119" aria-hidden="true" tabindex="-1"></a>            <span class="op">}</span>)<span class="op">;</span></span>
<span id="cb111-120"><a href="#cb111-120" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb111-121"><a href="#cb111-121" aria-hidden="true" tabindex="-1"></a>            <span class="cn">Ok</span>(())</span>
<span id="cb111-122"><a href="#cb111-122" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb111-123"><a href="#cb111-123" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb111-124"><a href="#cb111-124" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb111-125"><a href="#cb111-125" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Implement PSP22 trait</span></span>
<span id="cb111-126"><a href="#cb111-126" aria-hidden="true" tabindex="-1"></a>    <span class="kw">impl</span> PSP22 <span class="cf">for</span> ModularToken <span class="op">{</span></span>
<span id="cb111-127"><a href="#cb111-127" aria-hidden="true" tabindex="-1"></a>        <span class="at">#[</span>ink<span class="at">(</span>message<span class="at">)]</span></span>
<span id="cb111-128"><a href="#cb111-128" aria-hidden="true" tabindex="-1"></a>        <span class="kw">fn</span> total_supply(<span class="op">&amp;</span><span class="kw">self</span>) <span class="op">-&gt;</span> Balance <span class="op">{</span></span>
<span id="cb111-129"><a href="#cb111-129" aria-hidden="true" tabindex="-1"></a>            <span class="kw">self</span><span class="op">.</span>total_supply</span>
<span id="cb111-130"><a href="#cb111-130" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb111-131"><a href="#cb111-131" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb111-132"><a href="#cb111-132" aria-hidden="true" tabindex="-1"></a>        <span class="at">#[</span>ink<span class="at">(</span>message<span class="at">)]</span></span>
<span id="cb111-133"><a href="#cb111-133" aria-hidden="true" tabindex="-1"></a>        <span class="kw">fn</span> balance_of(<span class="op">&amp;</span><span class="kw">self</span><span class="op">,</span> owner<span class="op">:</span> AccountId) <span class="op">-&gt;</span> Balance <span class="op">{</span></span>
<span id="cb111-134"><a href="#cb111-134" aria-hidden="true" tabindex="-1"></a>            <span class="kw">self</span><span class="op">.</span>balances<span class="op">.</span>get(owner)<span class="op">.</span>unwrap_or(<span class="dv">0</span>)</span>
<span id="cb111-135"><a href="#cb111-135" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb111-136"><a href="#cb111-136" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb111-137"><a href="#cb111-137" aria-hidden="true" tabindex="-1"></a>        <span class="at">#[</span>ink<span class="at">(</span>message<span class="at">)]</span></span>
<span id="cb111-138"><a href="#cb111-138" aria-hidden="true" tabindex="-1"></a>        <span class="kw">fn</span> allowance(<span class="op">&amp;</span><span class="kw">self</span><span class="op">,</span> owner<span class="op">:</span> AccountId<span class="op">,</span> spender<span class="op">:</span> AccountId) <span class="op">-&gt;</span> Balance <span class="op">{</span></span>
<span id="cb111-139"><a href="#cb111-139" aria-hidden="true" tabindex="-1"></a>            <span class="kw">self</span><span class="op">.</span>allowances<span class="op">.</span>get((owner<span class="op">,</span> spender))<span class="op">.</span>unwrap_or(<span class="dv">0</span>)</span>
<span id="cb111-140"><a href="#cb111-140" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb111-141"><a href="#cb111-141" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb111-142"><a href="#cb111-142" aria-hidden="true" tabindex="-1"></a>        <span class="at">#[</span>ink<span class="at">(</span>message<span class="at">)]</span></span>
<span id="cb111-143"><a href="#cb111-143" aria-hidden="true" tabindex="-1"></a>        <span class="kw">fn</span> transfer(<span class="op">&amp;</span><span class="kw">mut</span> <span class="kw">self</span><span class="op">,</span> to<span class="op">:</span> AccountId<span class="op">,</span> value<span class="op">:</span> Balance) <span class="op">-&gt;</span> <span class="dt">Result</span><span class="op">&lt;</span>()<span class="op">,</span> PSP22Error<span class="op">&gt;</span> <span class="op">{</span></span>
<span id="cb111-144"><a href="#cb111-144" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> <span class="kw">self</span><span class="op">.</span>paused() <span class="op">{</span></span>
<span id="cb111-145"><a href="#cb111-145" aria-hidden="true" tabindex="-1"></a>                <span class="cf">return</span> <span class="cn">Err</span>(<span class="pp">PSP22Error::</span>Custom(<span class="st">&quot;Contract is paused&quot;</span><span class="op">.</span>into()))<span class="op">;</span></span>
<span id="cb111-146"><a href="#cb111-146" aria-hidden="true" tabindex="-1"></a>            <span class="op">}</span></span>
<span id="cb111-147"><a href="#cb111-147" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb111-148"><a href="#cb111-148" aria-hidden="true" tabindex="-1"></a>            <span class="kw">let</span> from <span class="op">=</span> <span class="kw">self</span><span class="op">.</span>env()<span class="op">.</span>caller()<span class="op">;</span></span>
<span id="cb111-149"><a href="#cb111-149" aria-hidden="true" tabindex="-1"></a>            <span class="kw">self</span><span class="op">.</span>internal_transfer(from<span class="op">,</span> to<span class="op">,</span> value)</span>
<span id="cb111-150"><a href="#cb111-150" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb111-151"><a href="#cb111-151" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb111-152"><a href="#cb111-152" aria-hidden="true" tabindex="-1"></a>        <span class="at">#[</span>ink<span class="at">(</span>message<span class="at">)]</span></span>
<span id="cb111-153"><a href="#cb111-153" aria-hidden="true" tabindex="-1"></a>        <span class="kw">fn</span> approve(<span class="op">&amp;</span><span class="kw">mut</span> <span class="kw">self</span><span class="op">,</span> spender<span class="op">:</span> AccountId<span class="op">,</span> value<span class="op">:</span> Balance) <span class="op">-&gt;</span> <span class="dt">Result</span><span class="op">&lt;</span>()<span class="op">,</span> PSP22Error<span class="op">&gt;</span> <span class="op">{</span></span>
<span id="cb111-154"><a href="#cb111-154" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> <span class="kw">self</span><span class="op">.</span>paused() <span class="op">{</span></span>
<span id="cb111-155"><a href="#cb111-155" aria-hidden="true" tabindex="-1"></a>                <span class="cf">return</span> <span class="cn">Err</span>(<span class="pp">PSP22Error::</span>Custom(<span class="st">&quot;Contract is paused&quot;</span><span class="op">.</span>into()))<span class="op">;</span></span>
<span id="cb111-156"><a href="#cb111-156" aria-hidden="true" tabindex="-1"></a>            <span class="op">}</span></span>
<span id="cb111-157"><a href="#cb111-157" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb111-158"><a href="#cb111-158" aria-hidden="true" tabindex="-1"></a>            <span class="kw">let</span> owner <span class="op">=</span> <span class="kw">self</span><span class="op">.</span>env()<span class="op">.</span>caller()<span class="op">;</span></span>
<span id="cb111-159"><a href="#cb111-159" aria-hidden="true" tabindex="-1"></a>            <span class="kw">self</span><span class="op">.</span>allowances<span class="op">.</span>insert((owner<span class="op">,</span> spender)<span class="op">,</span> <span class="op">&amp;</span>value)<span class="op">;</span></span>
<span id="cb111-160"><a href="#cb111-160" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb111-161"><a href="#cb111-161" aria-hidden="true" tabindex="-1"></a>            <span class="kw">self</span><span class="op">.</span>env()<span class="op">.</span>emit_event(Approval <span class="op">{</span></span>
<span id="cb111-162"><a href="#cb111-162" aria-hidden="true" tabindex="-1"></a>                owner<span class="op">,</span></span>
<span id="cb111-163"><a href="#cb111-163" aria-hidden="true" tabindex="-1"></a>                spender<span class="op">,</span></span>
<span id="cb111-164"><a href="#cb111-164" aria-hidden="true" tabindex="-1"></a>                value<span class="op">,</span></span>
<span id="cb111-165"><a href="#cb111-165" aria-hidden="true" tabindex="-1"></a>            <span class="op">}</span>)<span class="op">;</span></span>
<span id="cb111-166"><a href="#cb111-166" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb111-167"><a href="#cb111-167" aria-hidden="true" tabindex="-1"></a>            <span class="cn">Ok</span>(())</span>
<span id="cb111-168"><a href="#cb111-168" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb111-169"><a href="#cb111-169" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb111-170"><a href="#cb111-170" aria-hidden="true" tabindex="-1"></a>        <span class="at">#[</span>ink<span class="at">(</span>message<span class="at">)]</span></span>
<span id="cb111-171"><a href="#cb111-171" aria-hidden="true" tabindex="-1"></a>        <span class="kw">fn</span> transfer_from(</span>
<span id="cb111-172"><a href="#cb111-172" aria-hidden="true" tabindex="-1"></a>            <span class="op">&amp;</span><span class="kw">mut</span> <span class="kw">self</span><span class="op">,</span></span>
<span id="cb111-173"><a href="#cb111-173" aria-hidden="true" tabindex="-1"></a>            from<span class="op">:</span> AccountId<span class="op">,</span></span>
<span id="cb111-174"><a href="#cb111-174" aria-hidden="true" tabindex="-1"></a>            to<span class="op">:</span> AccountId<span class="op">,</span></span>
<span id="cb111-175"><a href="#cb111-175" aria-hidden="true" tabindex="-1"></a>            value<span class="op">:</span> Balance<span class="op">,</span></span>
<span id="cb111-176"><a href="#cb111-176" aria-hidden="true" tabindex="-1"></a>        ) <span class="op">-&gt;</span> <span class="dt">Result</span><span class="op">&lt;</span>()<span class="op">,</span> PSP22Error<span class="op">&gt;</span> <span class="op">{</span></span>
<span id="cb111-177"><a href="#cb111-177" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> <span class="kw">self</span><span class="op">.</span>paused() <span class="op">{</span></span>
<span id="cb111-178"><a href="#cb111-178" aria-hidden="true" tabindex="-1"></a>                <span class="cf">return</span> <span class="cn">Err</span>(<span class="pp">PSP22Error::</span>Custom(<span class="st">&quot;Contract is paused&quot;</span><span class="op">.</span>into()))<span class="op">;</span></span>
<span id="cb111-179"><a href="#cb111-179" aria-hidden="true" tabindex="-1"></a>            <span class="op">}</span></span>
<span id="cb111-180"><a href="#cb111-180" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb111-181"><a href="#cb111-181" aria-hidden="true" tabindex="-1"></a>            <span class="kw">let</span> caller <span class="op">=</span> <span class="kw">self</span><span class="op">.</span>env()<span class="op">.</span>caller()<span class="op">;</span></span>
<span id="cb111-182"><a href="#cb111-182" aria-hidden="true" tabindex="-1"></a>            <span class="kw">let</span> allowance <span class="op">=</span> <span class="kw">self</span><span class="op">.</span>allowance(from<span class="op">,</span> caller)<span class="op">;</span></span>
<span id="cb111-183"><a href="#cb111-183" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb111-184"><a href="#cb111-184" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> allowance <span class="op">&lt;</span> value <span class="op">{</span></span>
<span id="cb111-185"><a href="#cb111-185" aria-hidden="true" tabindex="-1"></a>                <span class="cf">return</span> <span class="cn">Err</span>(<span class="pp">PSP22Error::</span>InsufficientAllowance)<span class="op">;</span></span>
<span id="cb111-186"><a href="#cb111-186" aria-hidden="true" tabindex="-1"></a>            <span class="op">}</span></span>
<span id="cb111-187"><a href="#cb111-187" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb111-188"><a href="#cb111-188" aria-hidden="true" tabindex="-1"></a>            <span class="co">// Update allowance</span></span>
<span id="cb111-189"><a href="#cb111-189" aria-hidden="true" tabindex="-1"></a>            <span class="kw">self</span><span class="op">.</span>allowances<span class="op">.</span>insert((from<span class="op">,</span> caller)<span class="op">,</span> <span class="op">&amp;</span>(allowance <span class="op">-</span> value))<span class="op">;</span></span>
<span id="cb111-190"><a href="#cb111-190" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb111-191"><a href="#cb111-191" aria-hidden="true" tabindex="-1"></a>            <span class="co">// Execute transfer</span></span>
<span id="cb111-192"><a href="#cb111-192" aria-hidden="true" tabindex="-1"></a>            <span class="kw">self</span><span class="op">.</span>internal_transfer(from<span class="op">,</span> to<span class="op">,</span> value)</span>
<span id="cb111-193"><a href="#cb111-193" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb111-194"><a href="#cb111-194" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb111-195"><a href="#cb111-195" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb111-196"><a href="#cb111-196" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Implement AccessControl trait</span></span>
<span id="cb111-197"><a href="#cb111-197" aria-hidden="true" tabindex="-1"></a>    <span class="kw">impl</span> AccessControl <span class="cf">for</span> ModularToken <span class="op">{</span></span>
<span id="cb111-198"><a href="#cb111-198" aria-hidden="true" tabindex="-1"></a>        <span class="at">#[</span>ink<span class="at">(</span>message<span class="at">)]</span></span>
<span id="cb111-199"><a href="#cb111-199" aria-hidden="true" tabindex="-1"></a>        <span class="kw">fn</span> has_role(<span class="op">&amp;</span><span class="kw">self</span><span class="op">,</span> role<span class="op">:</span> RoleType<span class="op">,</span> account<span class="op">:</span> AccountId) <span class="op">-&gt;</span> <span class="dt">bool</span> <span class="op">{</span></span>
<span id="cb111-200"><a href="#cb111-200" aria-hidden="true" tabindex="-1"></a>            <span class="kw">self</span><span class="op">.</span>roles<span class="op">.</span>contains((role<span class="op">,</span> account))</span>
<span id="cb111-201"><a href="#cb111-201" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb111-202"><a href="#cb111-202" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb111-203"><a href="#cb111-203" aria-hidden="true" tabindex="-1"></a>        <span class="at">#[</span>ink<span class="at">(</span>message<span class="at">)]</span></span>
<span id="cb111-204"><a href="#cb111-204" aria-hidden="true" tabindex="-1"></a>        <span class="kw">fn</span> grant_role(<span class="op">&amp;</span><span class="kw">mut</span> <span class="kw">self</span><span class="op">,</span> role<span class="op">:</span> RoleType<span class="op">,</span> account<span class="op">:</span> AccountId) <span class="op">-&gt;</span> <span class="dt">Result</span><span class="op">&lt;</span>()<span class="op">,</span> AccessControlError<span class="op">&gt;</span> <span class="op">{</span></span>
<span id="cb111-205"><a href="#cb111-205" aria-hidden="true" tabindex="-1"></a>            <span class="kw">let</span> caller <span class="op">=</span> <span class="kw">self</span><span class="op">.</span>env()<span class="op">.</span>caller()<span class="op">;</span></span>
<span id="cb111-206"><a href="#cb111-206" aria-hidden="true" tabindex="-1"></a>            <span class="kw">let</span> admin_role <span class="op">=</span> <span class="kw">self</span><span class="op">.</span>get_role_admin(role)<span class="op">;</span></span>
<span id="cb111-207"><a href="#cb111-207" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb111-208"><a href="#cb111-208" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> <span class="op">!</span><span class="kw">self</span><span class="op">.</span>has_role(admin_role<span class="op">,</span> caller) <span class="op">{</span></span>
<span id="cb111-209"><a href="#cb111-209" aria-hidden="true" tabindex="-1"></a>                <span class="cf">return</span> <span class="cn">Err</span>(<span class="pp">AccessControlError::</span>MissingRole)<span class="op">;</span></span>
<span id="cb111-210"><a href="#cb111-210" aria-hidden="true" tabindex="-1"></a>            <span class="op">}</span></span>
<span id="cb111-211"><a href="#cb111-211" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb111-212"><a href="#cb111-212" aria-hidden="true" tabindex="-1"></a>            <span class="kw">self</span><span class="op">.</span>roles<span class="op">.</span>insert((role<span class="op">,</span> account)<span class="op">,</span> <span class="op">&amp;</span>())<span class="op">;</span></span>
<span id="cb111-213"><a href="#cb111-213" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb111-214"><a href="#cb111-214" aria-hidden="true" tabindex="-1"></a>            <span class="kw">self</span><span class="op">.</span>env()<span class="op">.</span>emit_event(RoleGranted <span class="op">{</span></span>
<span id="cb111-215"><a href="#cb111-215" aria-hidden="true" tabindex="-1"></a>                role<span class="op">,</span></span>
<span id="cb111-216"><a href="#cb111-216" aria-hidden="true" tabindex="-1"></a>                account<span class="op">,</span></span>
<span id="cb111-217"><a href="#cb111-217" aria-hidden="true" tabindex="-1"></a>                sender<span class="op">:</span> caller<span class="op">,</span></span>
<span id="cb111-218"><a href="#cb111-218" aria-hidden="true" tabindex="-1"></a>            <span class="op">}</span>)<span class="op">;</span></span>
<span id="cb111-219"><a href="#cb111-219" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb111-220"><a href="#cb111-220" aria-hidden="true" tabindex="-1"></a>            <span class="cn">Ok</span>(())</span>
<span id="cb111-221"><a href="#cb111-221" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb111-222"><a href="#cb111-222" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb111-223"><a href="#cb111-223" aria-hidden="true" tabindex="-1"></a>        <span class="at">#[</span>ink<span class="at">(</span>message<span class="at">)]</span></span>
<span id="cb111-224"><a href="#cb111-224" aria-hidden="true" tabindex="-1"></a>        <span class="kw">fn</span> revoke_role(<span class="op">&amp;</span><span class="kw">mut</span> <span class="kw">self</span><span class="op">,</span> role<span class="op">:</span> RoleType<span class="op">,</span> account<span class="op">:</span> AccountId) <span class="op">-&gt;</span> <span class="dt">Result</span><span class="op">&lt;</span>()<span class="op">,</span> AccessControlError<span class="op">&gt;</span> <span class="op">{</span></span>
<span id="cb111-225"><a href="#cb111-225" aria-hidden="true" tabindex="-1"></a>            <span class="kw">let</span> caller <span class="op">=</span> <span class="kw">self</span><span class="op">.</span>env()<span class="op">.</span>caller()<span class="op">;</span></span>
<span id="cb111-226"><a href="#cb111-226" aria-hidden="true" tabindex="-1"></a>            <span class="kw">let</span> admin_role <span class="op">=</span> <span class="kw">self</span><span class="op">.</span>get_role_admin(role)<span class="op">;</span></span>
<span id="cb111-227"><a href="#cb111-227" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb111-228"><a href="#cb111-228" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> <span class="op">!</span><span class="kw">self</span><span class="op">.</span>has_role(admin_role<span class="op">,</span> caller) <span class="op">{</span></span>
<span id="cb111-229"><a href="#cb111-229" aria-hidden="true" tabindex="-1"></a>                <span class="cf">return</span> <span class="cn">Err</span>(<span class="pp">AccessControlError::</span>MissingRole)<span class="op">;</span></span>
<span id="cb111-230"><a href="#cb111-230" aria-hidden="true" tabindex="-1"></a>            <span class="op">}</span></span>
<span id="cb111-231"><a href="#cb111-231" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb111-232"><a href="#cb111-232" aria-hidden="true" tabindex="-1"></a>            <span class="kw">self</span><span class="op">.</span>roles<span class="op">.</span>remove((role<span class="op">,</span> account))<span class="op">;</span></span>
<span id="cb111-233"><a href="#cb111-233" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb111-234"><a href="#cb111-234" aria-hidden="true" tabindex="-1"></a>            <span class="kw">self</span><span class="op">.</span>env()<span class="op">.</span>emit_event(RoleRevoked <span class="op">{</span></span>
<span id="cb111-235"><a href="#cb111-235" aria-hidden="true" tabindex="-1"></a>                role<span class="op">,</span></span>
<span id="cb111-236"><a href="#cb111-236" aria-hidden="true" tabindex="-1"></a>                account<span class="op">,</span></span>
<span id="cb111-237"><a href="#cb111-237" aria-hidden="true" tabindex="-1"></a>                sender<span class="op">:</span> caller<span class="op">,</span></span>
<span id="cb111-238"><a href="#cb111-238" aria-hidden="true" tabindex="-1"></a>            <span class="op">}</span>)<span class="op">;</span></span>
<span id="cb111-239"><a href="#cb111-239" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb111-240"><a href="#cb111-240" aria-hidden="true" tabindex="-1"></a>            <span class="cn">Ok</span>(())</span>
<span id="cb111-241"><a href="#cb111-241" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb111-242"><a href="#cb111-242" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb111-243"><a href="#cb111-243" aria-hidden="true" tabindex="-1"></a>        <span class="at">#[</span>ink<span class="at">(</span>message<span class="at">)]</span></span>
<span id="cb111-244"><a href="#cb111-244" aria-hidden="true" tabindex="-1"></a>        <span class="kw">fn</span> get_role_admin(<span class="op">&amp;</span><span class="kw">self</span><span class="op">,</span> role<span class="op">:</span> RoleType) <span class="op">-&gt;</span> RoleType <span class="op">{</span></span>
<span id="cb111-245"><a href="#cb111-245" aria-hidden="true" tabindex="-1"></a>            <span class="kw">self</span><span class="op">.</span>role_admins<span class="op">.</span>get(role)<span class="op">.</span>unwrap_or(DEFAULT_ADMIN_ROLE)</span>
<span id="cb111-246"><a href="#cb111-246" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb111-247"><a href="#cb111-247" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb111-248"><a href="#cb111-248" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb111-249"><a href="#cb111-249" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Implement Pausable trait</span></span>
<span id="cb111-250"><a href="#cb111-250" aria-hidden="true" tabindex="-1"></a>    <span class="kw">impl</span> Pausable <span class="cf">for</span> ModularToken <span class="op">{</span></span>
<span id="cb111-251"><a href="#cb111-251" aria-hidden="true" tabindex="-1"></a>        <span class="at">#[</span>ink<span class="at">(</span>message<span class="at">)]</span></span>
<span id="cb111-252"><a href="#cb111-252" aria-hidden="true" tabindex="-1"></a>        <span class="kw">fn</span> paused(<span class="op">&amp;</span><span class="kw">self</span>) <span class="op">-&gt;</span> <span class="dt">bool</span> <span class="op">{</span></span>
<span id="cb111-253"><a href="#cb111-253" aria-hidden="true" tabindex="-1"></a>            <span class="kw">self</span><span class="op">.</span>paused</span>
<span id="cb111-254"><a href="#cb111-254" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb111-255"><a href="#cb111-255" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb111-256"><a href="#cb111-256" aria-hidden="true" tabindex="-1"></a>        <span class="at">#[</span>ink<span class="at">(</span>message<span class="at">)]</span></span>
<span id="cb111-257"><a href="#cb111-257" aria-hidden="true" tabindex="-1"></a>        <span class="kw">fn</span> pause(<span class="op">&amp;</span><span class="kw">mut</span> <span class="kw">self</span>) <span class="op">-&gt;</span> <span class="dt">Result</span><span class="op">&lt;</span>()<span class="op">,</span> PausableError<span class="op">&gt;</span> <span class="op">{</span></span>
<span id="cb111-258"><a href="#cb111-258" aria-hidden="true" tabindex="-1"></a>            <span class="kw">let</span> caller <span class="op">=</span> <span class="kw">self</span><span class="op">.</span>env()<span class="op">.</span>caller()<span class="op">;</span></span>
<span id="cb111-259"><a href="#cb111-259" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb111-260"><a href="#cb111-260" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> <span class="op">!</span><span class="kw">self</span><span class="op">.</span>has_role(PAUSER_ROLE<span class="op">,</span> caller) <span class="op">{</span></span>
<span id="cb111-261"><a href="#cb111-261" aria-hidden="true" tabindex="-1"></a>                <span class="cf">return</span> <span class="cn">Err</span>(<span class="pp">PausableError::</span>CallerNotPauser)<span class="op">;</span></span>
<span id="cb111-262"><a href="#cb111-262" aria-hidden="true" tabindex="-1"></a>            <span class="op">}</span></span>
<span id="cb111-263"><a href="#cb111-263" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb111-264"><a href="#cb111-264" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> <span class="kw">self</span><span class="op">.</span>paused <span class="op">{</span></span>
<span id="cb111-265"><a href="#cb111-265" aria-hidden="true" tabindex="-1"></a>                <span class="cf">return</span> <span class="cn">Err</span>(<span class="pp">PausableError::</span>AlreadyPaused)<span class="op">;</span></span>
<span id="cb111-266"><a href="#cb111-266" aria-hidden="true" tabindex="-1"></a>            <span class="op">}</span></span>
<span id="cb111-267"><a href="#cb111-267" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb111-268"><a href="#cb111-268" aria-hidden="true" tabindex="-1"></a>            <span class="kw">self</span><span class="op">.</span>paused <span class="op">=</span> <span class="cn">true</span><span class="op">;</span></span>
<span id="cb111-269"><a href="#cb111-269" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb111-270"><a href="#cb111-270" aria-hidden="true" tabindex="-1"></a>            <span class="kw">self</span><span class="op">.</span>env()<span class="op">.</span>emit_event(Paused <span class="op">{</span> account<span class="op">:</span> caller <span class="op">}</span>)<span class="op">;</span></span>
<span id="cb111-271"><a href="#cb111-271" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb111-272"><a href="#cb111-272" aria-hidden="true" tabindex="-1"></a>            <span class="cn">Ok</span>(())</span>
<span id="cb111-273"><a href="#cb111-273" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb111-274"><a href="#cb111-274" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb111-275"><a href="#cb111-275" aria-hidden="true" tabindex="-1"></a>        <span class="at">#[</span>ink<span class="at">(</span>message<span class="at">)]</span></span>
<span id="cb111-276"><a href="#cb111-276" aria-hidden="true" tabindex="-1"></a>        <span class="kw">fn</span> unpause(<span class="op">&amp;</span><span class="kw">mut</span> <span class="kw">self</span>) <span class="op">-&gt;</span> <span class="dt">Result</span><span class="op">&lt;</span>()<span class="op">,</span> PausableError<span class="op">&gt;</span> <span class="op">{</span></span>
<span id="cb111-277"><a href="#cb111-277" aria-hidden="true" tabindex="-1"></a>            <span class="kw">let</span> caller <span class="op">=</span> <span class="kw">self</span><span class="op">.</span>env()<span class="op">.</span>caller()<span class="op">;</span></span>
<span id="cb111-278"><a href="#cb111-278" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb111-279"><a href="#cb111-279" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> <span class="op">!</span><span class="kw">self</span><span class="op">.</span>has_role(PAUSER_ROLE<span class="op">,</span> caller) <span class="op">{</span></span>
<span id="cb111-280"><a href="#cb111-280" aria-hidden="true" tabindex="-1"></a>                <span class="cf">return</span> <span class="cn">Err</span>(<span class="pp">PausableError::</span>CallerNotPauser)<span class="op">;</span></span>
<span id="cb111-281"><a href="#cb111-281" aria-hidden="true" tabindex="-1"></a>            <span class="op">}</span></span>
<span id="cb111-282"><a href="#cb111-282" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb111-283"><a href="#cb111-283" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> <span class="op">!</span><span class="kw">self</span><span class="op">.</span>paused <span class="op">{</span></span>
<span id="cb111-284"><a href="#cb111-284" aria-hidden="true" tabindex="-1"></a>                <span class="cf">return</span> <span class="cn">Err</span>(<span class="pp">PausableError::</span>NotPaused)<span class="op">;</span></span>
<span id="cb111-285"><a href="#cb111-285" aria-hidden="true" tabindex="-1"></a>            <span class="op">}</span></span>
<span id="cb111-286"><a href="#cb111-286" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb111-287"><a href="#cb111-287" aria-hidden="true" tabindex="-1"></a>            <span class="kw">self</span><span class="op">.</span>paused <span class="op">=</span> <span class="cn">false</span><span class="op">;</span></span>
<span id="cb111-288"><a href="#cb111-288" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb111-289"><a href="#cb111-289" aria-hidden="true" tabindex="-1"></a>            <span class="kw">self</span><span class="op">.</span>env()<span class="op">.</span>emit_event(Unpaused <span class="op">{</span> account<span class="op">:</span> caller <span class="op">}</span>)<span class="op">;</span></span>
<span id="cb111-290"><a href="#cb111-290" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb111-291"><a href="#cb111-291" aria-hidden="true" tabindex="-1"></a>            <span class="cn">Ok</span>(())</span>
<span id="cb111-292"><a href="#cb111-292" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb111-293"><a href="#cb111-293" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb111-294"><a href="#cb111-294" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb111-295"><a href="#cb111-295" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Internal helper functions</span></span>
<span id="cb111-296"><a href="#cb111-296" aria-hidden="true" tabindex="-1"></a>    <span class="kw">impl</span> ModularToken <span class="op">{</span></span>
<span id="cb111-297"><a href="#cb111-297" aria-hidden="true" tabindex="-1"></a>        <span class="kw">fn</span> internal_transfer(</span>
<span id="cb111-298"><a href="#cb111-298" aria-hidden="true" tabindex="-1"></a>            <span class="op">&amp;</span><span class="kw">mut</span> <span class="kw">self</span><span class="op">,</span></span>
<span id="cb111-299"><a href="#cb111-299" aria-hidden="true" tabindex="-1"></a>            from<span class="op">:</span> AccountId<span class="op">,</span></span>
<span id="cb111-300"><a href="#cb111-300" aria-hidden="true" tabindex="-1"></a>            to<span class="op">:</span> AccountId<span class="op">,</span></span>
<span id="cb111-301"><a href="#cb111-301" aria-hidden="true" tabindex="-1"></a>            value<span class="op">:</span> Balance<span class="op">,</span></span>
<span id="cb111-302"><a href="#cb111-302" aria-hidden="true" tabindex="-1"></a>        ) <span class="op">-&gt;</span> <span class="dt">Result</span><span class="op">&lt;</span>()<span class="op">,</span> PSP22Error<span class="op">&gt;</span> <span class="op">{</span></span>
<span id="cb111-303"><a href="#cb111-303" aria-hidden="true" tabindex="-1"></a>            <span class="kw">let</span> from_balance <span class="op">=</span> <span class="kw">self</span><span class="op">.</span>balance_of(from)<span class="op">;</span></span>
<span id="cb111-304"><a href="#cb111-304" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb111-305"><a href="#cb111-305" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> from_balance <span class="op">&lt;</span> value <span class="op">{</span></span>
<span id="cb111-306"><a href="#cb111-306" aria-hidden="true" tabindex="-1"></a>                <span class="cf">return</span> <span class="cn">Err</span>(<span class="pp">PSP22Error::</span>InsufficientBalance)<span class="op">;</span></span>
<span id="cb111-307"><a href="#cb111-307" aria-hidden="true" tabindex="-1"></a>            <span class="op">}</span></span>
<span id="cb111-308"><a href="#cb111-308" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb111-309"><a href="#cb111-309" aria-hidden="true" tabindex="-1"></a>            <span class="kw">let</span> to_balance <span class="op">=</span> <span class="kw">self</span><span class="op">.</span>balance_of(to)<span class="op">;</span></span>
<span id="cb111-310"><a href="#cb111-310" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb111-311"><a href="#cb111-311" aria-hidden="true" tabindex="-1"></a>            <span class="kw">self</span><span class="op">.</span>balances<span class="op">.</span>insert(from<span class="op">,</span> <span class="op">&amp;</span>(from_balance <span class="op">-</span> value))<span class="op">;</span></span>
<span id="cb111-312"><a href="#cb111-312" aria-hidden="true" tabindex="-1"></a>            <span class="kw">self</span><span class="op">.</span>balances<span class="op">.</span>insert(to<span class="op">,</span> <span class="op">&amp;</span>(to_balance <span class="op">+</span> value))<span class="op">;</span></span>
<span id="cb111-313"><a href="#cb111-313" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb111-314"><a href="#cb111-314" aria-hidden="true" tabindex="-1"></a>            <span class="kw">self</span><span class="op">.</span>env()<span class="op">.</span>emit_event(Transfer <span class="op">{</span></span>
<span id="cb111-315"><a href="#cb111-315" aria-hidden="true" tabindex="-1"></a>                from<span class="op">:</span> <span class="cn">Some</span>(from)<span class="op">,</span></span>
<span id="cb111-316"><a href="#cb111-316" aria-hidden="true" tabindex="-1"></a>                to<span class="op">:</span> <span class="cn">Some</span>(to)<span class="op">,</span></span>
<span id="cb111-317"><a href="#cb111-317" aria-hidden="true" tabindex="-1"></a>                value<span class="op">,</span></span>
<span id="cb111-318"><a href="#cb111-318" aria-hidden="true" tabindex="-1"></a>            <span class="op">}</span>)<span class="op">;</span></span>
<span id="cb111-319"><a href="#cb111-319" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb111-320"><a href="#cb111-320" aria-hidden="true" tabindex="-1"></a>            <span class="cn">Ok</span>(())</span>
<span id="cb111-321"><a href="#cb111-321" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb111-322"><a href="#cb111-322" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb111-323"><a href="#cb111-323" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<h3 id="extensible-architecture-with-hooks">Extensible Architecture with
Hooks</h3>
<p>Implement hook patterns for extensible contracts:</p>
<div class="sourceCode" id="cb112"><pre
class="sourceCode rust"><code class="sourceCode rust"><span id="cb112-1"><a href="#cb112-1" aria-hidden="true" tabindex="-1"></a><span class="at">#[</span><span class="pp">ink::</span>contract<span class="at">]</span></span>
<span id="cb112-2"><a href="#cb112-2" aria-hidden="true" tabindex="-1"></a><span class="kw">mod</span> extensible_contract <span class="op">{</span></span>
<span id="cb112-3"><a href="#cb112-3" aria-hidden="true" tabindex="-1"></a>    <span class="at">#[</span>ink<span class="at">(</span>storage<span class="at">)]</span></span>
<span id="cb112-4"><a href="#cb112-4" aria-hidden="true" tabindex="-1"></a>    <span class="kw">pub</span> <span class="kw">struct</span> ExtensibleContract <span class="op">{</span></span>
<span id="cb112-5"><a href="#cb112-5" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Core state</span></span>
<span id="cb112-6"><a href="#cb112-6" aria-hidden="true" tabindex="-1"></a>        balances<span class="op">:</span> <span class="pp">ink::storage::</span>Mapping<span class="op">&lt;</span>AccountId<span class="op">,</span> Balance<span class="op">&gt;,</span></span>
<span id="cb112-7"><a href="#cb112-7" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb112-8"><a href="#cb112-8" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Hook configurations</span></span>
<span id="cb112-9"><a href="#cb112-9" aria-hidden="true" tabindex="-1"></a>        transfer_hooks<span class="op">:</span> <span class="dt">Vec</span><span class="op">&lt;</span>AccountId<span class="op">&gt;,</span> <span class="co">// Contracts to call on transfers</span></span>
<span id="cb112-10"><a href="#cb112-10" aria-hidden="true" tabindex="-1"></a>        mint_hooks<span class="op">:</span> <span class="dt">Vec</span><span class="op">&lt;</span>AccountId<span class="op">&gt;,</span>     <span class="co">// Contracts to call on mints</span></span>
<span id="cb112-11"><a href="#cb112-11" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb112-12"><a href="#cb112-12" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Hook settings</span></span>
<span id="cb112-13"><a href="#cb112-13" aria-hidden="true" tabindex="-1"></a>        max_hooks<span class="op">:</span> <span class="dt">u8</span><span class="op">,</span></span>
<span id="cb112-14"><a href="#cb112-14" aria-hidden="true" tabindex="-1"></a>        hook_gas_limit<span class="op">:</span> <span class="dt">u64</span><span class="op">,</span></span>
<span id="cb112-15"><a href="#cb112-15" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb112-16"><a href="#cb112-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb112-17"><a href="#cb112-17" aria-hidden="true" tabindex="-1"></a>    <span class="kw">impl</span> ExtensibleContract <span class="op">{</span></span>
<span id="cb112-18"><a href="#cb112-18" aria-hidden="true" tabindex="-1"></a>        <span class="at">#[</span>ink<span class="at">(</span>constructor<span class="at">)]</span></span>
<span id="cb112-19"><a href="#cb112-19" aria-hidden="true" tabindex="-1"></a>        <span class="kw">pub</span> <span class="kw">fn</span> new() <span class="op">-&gt;</span> <span class="dt">Self</span> <span class="op">{</span></span>
<span id="cb112-20"><a href="#cb112-20" aria-hidden="true" tabindex="-1"></a>            <span class="dt">Self</span> <span class="op">{</span></span>
<span id="cb112-21"><a href="#cb112-21" aria-hidden="true" tabindex="-1"></a>                balances<span class="op">:</span> <span class="pp">ink::storage::Mapping::</span><span class="kw">default</span>()<span class="op">,</span></span>
<span id="cb112-22"><a href="#cb112-22" aria-hidden="true" tabindex="-1"></a>                transfer_hooks<span class="op">:</span> <span class="dt">Vec</span><span class="pp">::</span>new()<span class="op">,</span></span>
<span id="cb112-23"><a href="#cb112-23" aria-hidden="true" tabindex="-1"></a>                mint_hooks<span class="op">:</span> <span class="dt">Vec</span><span class="pp">::</span>new()<span class="op">,</span></span>
<span id="cb112-24"><a href="#cb112-24" aria-hidden="true" tabindex="-1"></a>                max_hooks<span class="op">:</span> <span class="dv">10</span><span class="op">,</span></span>
<span id="cb112-25"><a href="#cb112-25" aria-hidden="true" tabindex="-1"></a>                hook_gas_limit<span class="op">:</span> <span class="dv">10_000</span><span class="op">,</span></span>
<span id="cb112-26"><a href="#cb112-26" aria-hidden="true" tabindex="-1"></a>            <span class="op">}</span></span>
<span id="cb112-27"><a href="#cb112-27" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb112-28"><a href="#cb112-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb112-29"><a href="#cb112-29" aria-hidden="true" tabindex="-1"></a>        <span class="co">/// Transfer with hooks</span></span>
<span id="cb112-30"><a href="#cb112-30" aria-hidden="true" tabindex="-1"></a>        <span class="at">#[</span>ink<span class="at">(</span>message<span class="at">)]</span></span>
<span id="cb112-31"><a href="#cb112-31" aria-hidden="true" tabindex="-1"></a>        <span class="kw">pub</span> <span class="kw">fn</span> transfer(<span class="op">&amp;</span><span class="kw">mut</span> <span class="kw">self</span><span class="op">,</span> to<span class="op">:</span> AccountId<span class="op">,</span> amount<span class="op">:</span> Balance) <span class="op">-&gt;</span> <span class="dt">Result</span><span class="op">&lt;</span>()<span class="op">,</span> <span class="bu">Error</span><span class="op">&gt;</span> <span class="op">{</span></span>
<span id="cb112-32"><a href="#cb112-32" aria-hidden="true" tabindex="-1"></a>            <span class="kw">let</span> from <span class="op">=</span> <span class="kw">self</span><span class="op">.</span>env()<span class="op">.</span>caller()<span class="op">;</span></span>
<span id="cb112-33"><a href="#cb112-33" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb112-34"><a href="#cb112-34" aria-hidden="true" tabindex="-1"></a>            <span class="co">// Execute pre-transfer hooks</span></span>
<span id="cb112-35"><a href="#cb112-35" aria-hidden="true" tabindex="-1"></a>            <span class="kw">self</span><span class="op">.</span>execute_transfer_hooks(<span class="pp">HookType::</span>PreTransfer<span class="op">,</span> from<span class="op">,</span> to<span class="op">,</span> amount)<span class="op">?;</span></span>
<span id="cb112-36"><a href="#cb112-36" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb112-37"><a href="#cb112-37" aria-hidden="true" tabindex="-1"></a>            <span class="co">// Perform the actual transfer</span></span>
<span id="cb112-38"><a href="#cb112-38" aria-hidden="true" tabindex="-1"></a>            <span class="kw">self</span><span class="op">.</span>internal_transfer(from<span class="op">,</span> to<span class="op">,</span> amount)<span class="op">?;</span></span>
<span id="cb112-39"><a href="#cb112-39" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb112-40"><a href="#cb112-40" aria-hidden="true" tabindex="-1"></a>            <span class="co">// Execute post-transfer hooks</span></span>
<span id="cb112-41"><a href="#cb112-41" aria-hidden="true" tabindex="-1"></a>            <span class="kw">self</span><span class="op">.</span>execute_transfer_hooks(<span class="pp">HookType::</span>PostTransfer<span class="op">,</span> from<span class="op">,</span> to<span class="op">,</span> amount)<span class="op">?;</span></span>
<span id="cb112-42"><a href="#cb112-42" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb112-43"><a href="#cb112-43" aria-hidden="true" tabindex="-1"></a>            <span class="cn">Ok</span>(())</span>
<span id="cb112-44"><a href="#cb112-44" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb112-45"><a href="#cb112-45" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb112-46"><a href="#cb112-46" aria-hidden="true" tabindex="-1"></a>        <span class="co">/// Add a transfer hook contract</span></span>
<span id="cb112-47"><a href="#cb112-47" aria-hidden="true" tabindex="-1"></a>        <span class="at">#[</span>ink<span class="at">(</span>message<span class="at">)]</span></span>
<span id="cb112-48"><a href="#cb112-48" aria-hidden="true" tabindex="-1"></a>        <span class="kw">pub</span> <span class="kw">fn</span> add_transfer_hook(<span class="op">&amp;</span><span class="kw">mut</span> <span class="kw">self</span><span class="op">,</span> hook_contract<span class="op">:</span> AccountId) <span class="op">-&gt;</span> <span class="dt">Result</span><span class="op">&lt;</span>()<span class="op">,</span> <span class="bu">Error</span><span class="op">&gt;</span> <span class="op">{</span></span>
<span id="cb112-49"><a href="#cb112-49" aria-hidden="true" tabindex="-1"></a>            <span class="co">// Only owner can add hooks (authorization check omitted)</span></span>
<span id="cb112-50"><a href="#cb112-50" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb112-51"><a href="#cb112-51" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> <span class="kw">self</span><span class="op">.</span>transfer_hooks<span class="op">.</span>len() <span class="op">&gt;=</span> <span class="kw">self</span><span class="op">.</span>max_hooks <span class="kw">as</span> <span class="dt">usize</span> <span class="op">{</span></span>
<span id="cb112-52"><a href="#cb112-52" aria-hidden="true" tabindex="-1"></a>                <span class="cf">return</span> <span class="cn">Err</span>(<span class="bu">Error</span><span class="pp">::</span>QuotaExceeded)<span class="op">;</span></span>
<span id="cb112-53"><a href="#cb112-53" aria-hidden="true" tabindex="-1"></a>            <span class="op">}</span></span>
<span id="cb112-54"><a href="#cb112-54" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb112-55"><a href="#cb112-55" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> <span class="kw">self</span><span class="op">.</span>transfer_hooks<span class="op">.</span>contains(<span class="op">&amp;</span>hook_contract) <span class="op">{</span></span>
<span id="cb112-56"><a href="#cb112-56" aria-hidden="true" tabindex="-1"></a>                <span class="cf">return</span> <span class="cn">Err</span>(<span class="bu">Error</span><span class="pp">::</span>InvalidParameters)<span class="op">;</span></span>
<span id="cb112-57"><a href="#cb112-57" aria-hidden="true" tabindex="-1"></a>            <span class="op">}</span></span>
<span id="cb112-58"><a href="#cb112-58" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb112-59"><a href="#cb112-59" aria-hidden="true" tabindex="-1"></a>            <span class="kw">self</span><span class="op">.</span>transfer_hooks<span class="op">.</span>push(hook_contract)<span class="op">;</span></span>
<span id="cb112-60"><a href="#cb112-60" aria-hidden="true" tabindex="-1"></a>            <span class="cn">Ok</span>(())</span>
<span id="cb112-61"><a href="#cb112-61" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb112-62"><a href="#cb112-62" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb112-63"><a href="#cb112-63" aria-hidden="true" tabindex="-1"></a>        <span class="co">/// Execute transfer hooks safely</span></span>
<span id="cb112-64"><a href="#cb112-64" aria-hidden="true" tabindex="-1"></a>        <span class="kw">fn</span> execute_transfer_hooks(</span>
<span id="cb112-65"><a href="#cb112-65" aria-hidden="true" tabindex="-1"></a>            <span class="op">&amp;</span><span class="kw">self</span><span class="op">,</span></span>
<span id="cb112-66"><a href="#cb112-66" aria-hidden="true" tabindex="-1"></a>            hook_type<span class="op">:</span> HookType<span class="op">,</span></span>
<span id="cb112-67"><a href="#cb112-67" aria-hidden="true" tabindex="-1"></a>            from<span class="op">:</span> AccountId<span class="op">,</span></span>
<span id="cb112-68"><a href="#cb112-68" aria-hidden="true" tabindex="-1"></a>            to<span class="op">:</span> AccountId<span class="op">,</span></span>
<span id="cb112-69"><a href="#cb112-69" aria-hidden="true" tabindex="-1"></a>            amount<span class="op">:</span> Balance<span class="op">,</span></span>
<span id="cb112-70"><a href="#cb112-70" aria-hidden="true" tabindex="-1"></a>        ) <span class="op">-&gt;</span> <span class="dt">Result</span><span class="op">&lt;</span>()<span class="op">,</span> <span class="bu">Error</span><span class="op">&gt;</span> <span class="op">{</span></span>
<span id="cb112-71"><a href="#cb112-71" aria-hidden="true" tabindex="-1"></a>            <span class="cf">for</span> hook_contract <span class="kw">in</span> <span class="op">&amp;</span><span class="kw">self</span><span class="op">.</span>transfer_hooks <span class="op">{</span></span>
<span id="cb112-72"><a href="#cb112-72" aria-hidden="true" tabindex="-1"></a>                <span class="co">// Call hook with limited gas and error isolation</span></span>
<span id="cb112-73"><a href="#cb112-73" aria-hidden="true" tabindex="-1"></a>                <span class="kw">let</span> result <span class="op">=</span> <span class="kw">self</span><span class="op">.</span>call_transfer_hook(<span class="op">*</span>hook_contract<span class="op">,</span> hook_type<span class="op">,</span> from<span class="op">,</span> to<span class="op">,</span> amount)<span class="op">;</span></span>
<span id="cb112-74"><a href="#cb112-74" aria-hidden="true" tabindex="-1"></a>                </span>
<span id="cb112-75"><a href="#cb112-75" aria-hidden="true" tabindex="-1"></a>                <span class="co">// Log hook failures but don&#39;t fail the transaction</span></span>
<span id="cb112-76"><a href="#cb112-76" aria-hidden="true" tabindex="-1"></a>                <span class="cf">if</span> result<span class="op">.</span>is_err() <span class="op">{</span></span>
<span id="cb112-77"><a href="#cb112-77" aria-hidden="true" tabindex="-1"></a>                    <span class="kw">self</span><span class="op">.</span>env()<span class="op">.</span>emit_event(HookFailed <span class="op">{</span></span>
<span id="cb112-78"><a href="#cb112-78" aria-hidden="true" tabindex="-1"></a>                        hook_contract<span class="op">:</span> <span class="op">*</span>hook_contract<span class="op">,</span></span>
<span id="cb112-79"><a href="#cb112-79" aria-hidden="true" tabindex="-1"></a>                        hook_type<span class="op">,</span></span>
<span id="cb112-80"><a href="#cb112-80" aria-hidden="true" tabindex="-1"></a>                        reason<span class="op">:</span> <span class="st">&quot;Hook execution failed&quot;</span><span class="op">.</span>into()<span class="op">,</span></span>
<span id="cb112-81"><a href="#cb112-81" aria-hidden="true" tabindex="-1"></a>                    <span class="op">}</span>)<span class="op">;</span></span>
<span id="cb112-82"><a href="#cb112-82" aria-hidden="true" tabindex="-1"></a>                <span class="op">}</span></span>
<span id="cb112-83"><a href="#cb112-83" aria-hidden="true" tabindex="-1"></a>            <span class="op">}</span></span>
<span id="cb112-84"><a href="#cb112-84" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb112-85"><a href="#cb112-85" aria-hidden="true" tabindex="-1"></a>            <span class="cn">Ok</span>(())</span>
<span id="cb112-86"><a href="#cb112-86" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb112-87"><a href="#cb112-87" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb112-88"><a href="#cb112-88" aria-hidden="true" tabindex="-1"></a>        <span class="co">/// Safe hook call with gas limits</span></span>
<span id="cb112-89"><a href="#cb112-89" aria-hidden="true" tabindex="-1"></a>        <span class="kw">fn</span> call_transfer_hook(</span>
<span id="cb112-90"><a href="#cb112-90" aria-hidden="true" tabindex="-1"></a>            <span class="op">&amp;</span><span class="kw">self</span><span class="op">,</span></span>
<span id="cb112-91"><a href="#cb112-91" aria-hidden="true" tabindex="-1"></a>            hook_contract<span class="op">:</span> AccountId<span class="op">,</span></span>
<span id="cb112-92"><a href="#cb112-92" aria-hidden="true" tabindex="-1"></a>            hook_type<span class="op">:</span> HookType<span class="op">,</span></span>
<span id="cb112-93"><a href="#cb112-93" aria-hidden="true" tabindex="-1"></a>            from<span class="op">:</span> AccountId<span class="op">,</span></span>
<span id="cb112-94"><a href="#cb112-94" aria-hidden="true" tabindex="-1"></a>            to<span class="op">:</span> AccountId<span class="op">,</span></span>
<span id="cb112-95"><a href="#cb112-95" aria-hidden="true" tabindex="-1"></a>            amount<span class="op">:</span> Balance<span class="op">,</span></span>
<span id="cb112-96"><a href="#cb112-96" aria-hidden="true" tabindex="-1"></a>        ) <span class="op">-&gt;</span> <span class="dt">Result</span><span class="op">&lt;</span>()<span class="op">,</span> <span class="bu">Error</span><span class="op">&gt;</span> <span class="op">{</span></span>
<span id="cb112-97"><a href="#cb112-97" aria-hidden="true" tabindex="-1"></a>            <span class="co">// Build cross-contract call with limited gas</span></span>
<span id="cb112-98"><a href="#cb112-98" aria-hidden="true" tabindex="-1"></a>            <span class="kw">let</span> _result <span class="op">=</span> <span class="pp">ink::env::call::build_call::</span><span class="op">&lt;</span><span class="pp">ink::env::</span>DefaultEnvironment<span class="op">&gt;</span>()</span>
<span id="cb112-99"><a href="#cb112-99" aria-hidden="true" tabindex="-1"></a>                <span class="op">.</span>call(hook_contract)</span>
<span id="cb112-100"><a href="#cb112-100" aria-hidden="true" tabindex="-1"></a>                <span class="op">.</span>gas_limit(<span class="kw">self</span><span class="op">.</span>hook_gas_limit)</span>
<span id="cb112-101"><a href="#cb112-101" aria-hidden="true" tabindex="-1"></a>                <span class="op">.</span>transferred_value(<span class="dv">0</span>)</span>
<span id="cb112-102"><a href="#cb112-102" aria-hidden="true" tabindex="-1"></a>                <span class="op">.</span>exec_input(</span>
<span id="cb112-103"><a href="#cb112-103" aria-hidden="true" tabindex="-1"></a>                    <span class="pp">ink::env::call::ExecutionInput::</span>new(</span>
<span id="cb112-104"><a href="#cb112-104" aria-hidden="true" tabindex="-1"></a>                        <span class="co">// Hook interface selector (simplified)</span></span>
<span id="cb112-105"><a href="#cb112-105" aria-hidden="true" tabindex="-1"></a>                        <span class="pp">ink::env::call::Selector::</span>new([<span class="dv">0x12</span><span class="op">,</span> <span class="dv">0x34</span><span class="op">,</span> <span class="dv">0x56</span><span class="op">,</span> <span class="dv">0x78</span>])</span>
<span id="cb112-106"><a href="#cb112-106" aria-hidden="true" tabindex="-1"></a>                    )</span>
<span id="cb112-107"><a href="#cb112-107" aria-hidden="true" tabindex="-1"></a>                    <span class="op">.</span>push_arg(hook_type)</span>
<span id="cb112-108"><a href="#cb112-108" aria-hidden="true" tabindex="-1"></a>                    <span class="op">.</span>push_arg(from)</span>
<span id="cb112-109"><a href="#cb112-109" aria-hidden="true" tabindex="-1"></a>                    <span class="op">.</span>push_arg(to)</span>
<span id="cb112-110"><a href="#cb112-110" aria-hidden="true" tabindex="-1"></a>                    <span class="op">.</span>push_arg(amount)</span>
<span id="cb112-111"><a href="#cb112-111" aria-hidden="true" tabindex="-1"></a>                )</span>
<span id="cb112-112"><a href="#cb112-112" aria-hidden="true" tabindex="-1"></a>                <span class="op">.</span><span class="pp">returns::</span><span class="op">&lt;</span>()<span class="op">&gt;</span>()</span>
<span id="cb112-113"><a href="#cb112-113" aria-hidden="true" tabindex="-1"></a>                <span class="op">.</span>try_invoke()<span class="op">;</span></span>
<span id="cb112-114"><a href="#cb112-114" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb112-115"><a href="#cb112-115" aria-hidden="true" tabindex="-1"></a>            <span class="co">// Handle result appropriately</span></span>
<span id="cb112-116"><a href="#cb112-116" aria-hidden="true" tabindex="-1"></a>            <span class="cn">Ok</span>(())</span>
<span id="cb112-117"><a href="#cb112-117" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb112-118"><a href="#cb112-118" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb112-119"><a href="#cb112-119" aria-hidden="true" tabindex="-1"></a>        <span class="kw">fn</span> internal_transfer(<span class="op">&amp;</span><span class="kw">mut</span> <span class="kw">self</span><span class="op">,</span> from<span class="op">:</span> AccountId<span class="op">,</span> to<span class="op">:</span> AccountId<span class="op">,</span> amount<span class="op">:</span> Balance) <span class="op">-&gt;</span> <span class="dt">Result</span><span class="op">&lt;</span>()<span class="op">,</span> <span class="bu">Error</span><span class="op">&gt;</span> <span class="op">{</span></span>
<span id="cb112-120"><a href="#cb112-120" aria-hidden="true" tabindex="-1"></a>            <span class="kw">let</span> from_balance <span class="op">=</span> <span class="kw">self</span><span class="op">.</span>balances<span class="op">.</span>get(from)<span class="op">.</span>unwrap_or(<span class="dv">0</span>)<span class="op">;</span></span>
<span id="cb112-121"><a href="#cb112-121" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb112-122"><a href="#cb112-122" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> from_balance <span class="op">&lt;</span> amount <span class="op">{</span></span>
<span id="cb112-123"><a href="#cb112-123" aria-hidden="true" tabindex="-1"></a>                <span class="cf">return</span> <span class="cn">Err</span>(<span class="bu">Error</span><span class="pp">::</span>InsufficientBalance)<span class="op">;</span></span>
<span id="cb112-124"><a href="#cb112-124" aria-hidden="true" tabindex="-1"></a>            <span class="op">}</span></span>
<span id="cb112-125"><a href="#cb112-125" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb112-126"><a href="#cb112-126" aria-hidden="true" tabindex="-1"></a>            <span class="kw">let</span> to_balance <span class="op">=</span> <span class="kw">self</span><span class="op">.</span>balances<span class="op">.</span>get(to)<span class="op">.</span>unwrap_or(<span class="dv">0</span>)<span class="op">;</span></span>
<span id="cb112-127"><a href="#cb112-127" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb112-128"><a href="#cb112-128" aria-hidden="true" tabindex="-1"></a>            <span class="kw">self</span><span class="op">.</span>balances<span class="op">.</span>insert(from<span class="op">,</span> <span class="op">&amp;</span>(from_balance <span class="op">-</span> amount))<span class="op">;</span></span>
<span id="cb112-129"><a href="#cb112-129" aria-hidden="true" tabindex="-1"></a>            <span class="kw">self</span><span class="op">.</span>balances<span class="op">.</span>insert(to<span class="op">,</span> <span class="op">&amp;</span>(to_balance <span class="op">+</span> amount))<span class="op">;</span></span>
<span id="cb112-130"><a href="#cb112-130" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb112-131"><a href="#cb112-131" aria-hidden="true" tabindex="-1"></a>            <span class="cn">Ok</span>(())</span>
<span id="cb112-132"><a href="#cb112-132" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb112-133"><a href="#cb112-133" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb112-134"><a href="#cb112-134" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb112-135"><a href="#cb112-135" aria-hidden="true" tabindex="-1"></a>    <span class="at">#[</span>derive<span class="at">(</span><span class="bu">Debug</span><span class="op">,</span> <span class="bu">PartialEq</span><span class="op">,</span> <span class="bu">Eq</span><span class="op">,</span> <span class="pp">scale::</span>Encode<span class="op">,</span> <span class="pp">scale::</span>Decode<span class="at">)]</span></span>
<span id="cb112-136"><a href="#cb112-136" aria-hidden="true" tabindex="-1"></a>    <span class="at">#[</span>cfg_attr<span class="at">(</span>feature <span class="op">=</span> <span class="st">&quot;std&quot;</span><span class="op">,</span> derive<span class="at">(</span><span class="pp">scale_info::</span>TypeInfo<span class="at">))]</span></span>
<span id="cb112-137"><a href="#cb112-137" aria-hidden="true" tabindex="-1"></a>    <span class="kw">pub</span> <span class="kw">enum</span> HookType <span class="op">{</span></span>
<span id="cb112-138"><a href="#cb112-138" aria-hidden="true" tabindex="-1"></a>        PreTransfer<span class="op">,</span></span>
<span id="cb112-139"><a href="#cb112-139" aria-hidden="true" tabindex="-1"></a>        PostTransfer<span class="op">,</span></span>
<span id="cb112-140"><a href="#cb112-140" aria-hidden="true" tabindex="-1"></a>        PreMint<span class="op">,</span></span>
<span id="cb112-141"><a href="#cb112-141" aria-hidden="true" tabindex="-1"></a>        PostMint<span class="op">,</span></span>
<span id="cb112-142"><a href="#cb112-142" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb112-143"><a href="#cb112-143" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<h2 id="standard-library-usage-in-no_std">Standard Library Usage in
no_std</h2>
<p>Learn to effectively use Rust’s core libraries in the constrained
no_std environment:</p>
<div class="sourceCode" id="cb113"><pre
class="sourceCode rust"><code class="sourceCode rust"><span id="cb113-1"><a href="#cb113-1" aria-hidden="true" tabindex="-1"></a><span class="at">#[</span><span class="pp">ink::</span>contract<span class="at">]</span></span>
<span id="cb113-2"><a href="#cb113-2" aria-hidden="true" tabindex="-1"></a><span class="kw">mod</span> stdlib_usage <span class="op">{</span></span>
<span id="cb113-3"><a href="#cb113-3" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Import commonly used collections</span></span>
<span id="cb113-4"><a href="#cb113-4" aria-hidden="true" tabindex="-1"></a>    <span class="kw">use</span> <span class="pp">ink::prelude::</span><span class="op">{</span></span>
<span id="cb113-5"><a href="#cb113-5" aria-hidden="true" tabindex="-1"></a>        <span class="pp">vec::</span><span class="dt">Vec</span><span class="op">,</span></span>
<span id="cb113-6"><a href="#cb113-6" aria-hidden="true" tabindex="-1"></a>        <span class="pp">collections::</span><span class="op">{</span>BTreeMap<span class="op">,</span> BTreeSet<span class="op">},</span></span>
<span id="cb113-7"><a href="#cb113-7" aria-hidden="true" tabindex="-1"></a>        <span class="pp">string::</span><span class="dt">String</span><span class="op">,</span></span>
<span id="cb113-8"><a href="#cb113-8" aria-hidden="true" tabindex="-1"></a>    <span class="op">};</span></span>
<span id="cb113-9"><a href="#cb113-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb113-10"><a href="#cb113-10" aria-hidden="true" tabindex="-1"></a>    <span class="at">#[</span>ink<span class="at">(</span>storage<span class="at">)]</span></span>
<span id="cb113-11"><a href="#cb113-11" aria-hidden="true" tabindex="-1"></a>    <span class="kw">pub</span> <span class="kw">struct</span> StdLibContract <span class="op">{</span></span>
<span id="cb113-12"><a href="#cb113-12" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Vector for ordered data</span></span>
<span id="cb113-13"><a href="#cb113-13" aria-hidden="true" tabindex="-1"></a>        transaction_history<span class="op">:</span> <span class="dt">Vec</span><span class="op">&lt;</span>Transaction<span class="op">&gt;,</span></span>
<span id="cb113-14"><a href="#cb113-14" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb113-15"><a href="#cb113-15" aria-hidden="true" tabindex="-1"></a>        <span class="co">// BTreeMap for sorted key-value pairs</span></span>
<span id="cb113-16"><a href="#cb113-16" aria-hidden="true" tabindex="-1"></a>        user_scores<span class="op">:</span> BTreeMap<span class="op">&lt;</span>AccountId<span class="op">,</span> <span class="dt">u64</span><span class="op">&gt;,</span></span>
<span id="cb113-17"><a href="#cb113-17" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb113-18"><a href="#cb113-18" aria-hidden="true" tabindex="-1"></a>        <span class="co">// BTreeSet for unique collections</span></span>
<span id="cb113-19"><a href="#cb113-19" aria-hidden="true" tabindex="-1"></a>        verified_users<span class="op">:</span> BTreeSet<span class="op">&lt;</span>AccountId<span class="op">&gt;,</span></span>
<span id="cb113-20"><a href="#cb113-20" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb113-21"><a href="#cb113-21" aria-hidden="true" tabindex="-1"></a>        <span class="co">// String for text data</span></span>
<span id="cb113-22"><a href="#cb113-22" aria-hidden="true" tabindex="-1"></a>        contract_metadata<span class="op">:</span> <span class="dt">String</span><span class="op">,</span></span>
<span id="cb113-23"><a href="#cb113-23" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb113-24"><a href="#cb113-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb113-25"><a href="#cb113-25" aria-hidden="true" tabindex="-1"></a>    <span class="at">#[</span>derive<span class="at">(</span><span class="bu">Debug</span><span class="op">,</span> <span class="bu">Clone</span><span class="op">,</span> <span class="bu">PartialEq</span><span class="op">,</span> <span class="bu">Eq</span><span class="op">,</span> <span class="pp">scale::</span>Encode<span class="op">,</span> <span class="pp">scale::</span>Decode<span class="at">)]</span></span>
<span id="cb113-26"><a href="#cb113-26" aria-hidden="true" tabindex="-1"></a>    <span class="at">#[</span>cfg_attr<span class="at">(</span>feature <span class="op">=</span> <span class="st">&quot;std&quot;</span><span class="op">,</span> derive<span class="at">(</span><span class="pp">scale_info::</span>TypeInfo<span class="at">))]</span></span>
<span id="cb113-27"><a href="#cb113-27" aria-hidden="true" tabindex="-1"></a>    <span class="kw">pub</span> <span class="kw">struct</span> Transaction <span class="op">{</span></span>
<span id="cb113-28"><a href="#cb113-28" aria-hidden="true" tabindex="-1"></a>        <span class="kw">pub</span> from<span class="op">:</span> AccountId<span class="op">,</span></span>
<span id="cb113-29"><a href="#cb113-29" aria-hidden="true" tabindex="-1"></a>        <span class="kw">pub</span> to<span class="op">:</span> AccountId<span class="op">,</span></span>
<span id="cb113-30"><a href="#cb113-30" aria-hidden="true" tabindex="-1"></a>        <span class="kw">pub</span> amount<span class="op">:</span> Balance<span class="op">,</span></span>
<span id="cb113-31"><a href="#cb113-31" aria-hidden="true" tabindex="-1"></a>        <span class="kw">pub</span> timestamp<span class="op">:</span> <span class="dt">u64</span><span class="op">,</span></span>
<span id="cb113-32"><a href="#cb113-32" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb113-33"><a href="#cb113-33" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb113-34"><a href="#cb113-34" aria-hidden="true" tabindex="-1"></a>    <span class="kw">impl</span> StdLibContract <span class="op">{</span></span>
<span id="cb113-35"><a href="#cb113-35" aria-hidden="true" tabindex="-1"></a>        <span class="at">#[</span>ink<span class="at">(</span>constructor<span class="at">)]</span></span>
<span id="cb113-36"><a href="#cb113-36" aria-hidden="true" tabindex="-1"></a>        <span class="kw">pub</span> <span class="kw">fn</span> new(metadata<span class="op">:</span> <span class="dt">String</span>) <span class="op">-&gt;</span> <span class="dt">Self</span> <span class="op">{</span></span>
<span id="cb113-37"><a href="#cb113-37" aria-hidden="true" tabindex="-1"></a>            <span class="dt">Self</span> <span class="op">{</span></span>
<span id="cb113-38"><a href="#cb113-38" aria-hidden="true" tabindex="-1"></a>                transaction_history<span class="op">:</span> <span class="dt">Vec</span><span class="pp">::</span>new()<span class="op">,</span></span>
<span id="cb113-39"><a href="#cb113-39" aria-hidden="true" tabindex="-1"></a>                user_scores<span class="op">:</span> <span class="pp">BTreeMap::</span>new()<span class="op">,</span></span>
<span id="cb113-40"><a href="#cb113-40" aria-hidden="true" tabindex="-1"></a>                verified_users<span class="op">:</span> <span class="pp">BTreeSet::</span>new()<span class="op">,</span></span>
<span id="cb113-41"><a href="#cb113-41" aria-hidden="true" tabindex="-1"></a>                contract_metadata<span class="op">:</span> metadata<span class="op">,</span></span>
<span id="cb113-42"><a href="#cb113-42" aria-hidden="true" tabindex="-1"></a>            <span class="op">}</span></span>
<span id="cb113-43"><a href="#cb113-43" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb113-44"><a href="#cb113-44" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb113-45"><a href="#cb113-45" aria-hidden="true" tabindex="-1"></a>        <span class="co">/// Demonstrate Vec usage for transaction history</span></span>
<span id="cb113-46"><a href="#cb113-46" aria-hidden="true" tabindex="-1"></a>        <span class="at">#[</span>ink<span class="at">(</span>message<span class="at">)]</span></span>
<span id="cb113-47"><a href="#cb113-47" aria-hidden="true" tabindex="-1"></a>        <span class="kw">pub</span> <span class="kw">fn</span> record_transaction(<span class="op">&amp;</span><span class="kw">mut</span> <span class="kw">self</span><span class="op">,</span> to<span class="op">:</span> AccountId<span class="op">,</span> amount<span class="op">:</span> Balance) <span class="op">-&gt;</span> <span class="dt">Result</span><span class="op">&lt;</span>()<span class="op">,</span> <span class="bu">Error</span><span class="op">&gt;</span> <span class="op">{</span></span>
<span id="cb113-48"><a href="#cb113-48" aria-hidden="true" tabindex="-1"></a>            <span class="kw">let</span> from <span class="op">=</span> <span class="kw">self</span><span class="op">.</span>env()<span class="op">.</span>caller()<span class="op">;</span></span>
<span id="cb113-49"><a href="#cb113-49" aria-hidden="true" tabindex="-1"></a>            <span class="kw">let</span> timestamp <span class="op">=</span> <span class="kw">self</span><span class="op">.</span>env()<span class="op">.</span>block_timestamp()<span class="op">;</span></span>
<span id="cb113-50"><a href="#cb113-50" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb113-51"><a href="#cb113-51" aria-hidden="true" tabindex="-1"></a>            <span class="kw">let</span> transaction <span class="op">=</span> Transaction <span class="op">{</span></span>
<span id="cb113-52"><a href="#cb113-52" aria-hidden="true" tabindex="-1"></a>                from<span class="op">,</span></span>
<span id="cb113-53"><a href="#cb113-53" aria-hidden="true" tabindex="-1"></a>                to<span class="op">,</span></span>
<span id="cb113-54"><a href="#cb113-54" aria-hidden="true" tabindex="-1"></a>                amount<span class="op">,</span></span>
<span id="cb113-55"><a href="#cb113-55" aria-hidden="true" tabindex="-1"></a>                timestamp<span class="op">,</span></span>
<span id="cb113-56"><a href="#cb113-56" aria-hidden="true" tabindex="-1"></a>            <span class="op">};</span></span>
<span id="cb113-57"><a href="#cb113-57" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb113-58"><a href="#cb113-58" aria-hidden="true" tabindex="-1"></a>            <span class="co">// Add to history (be careful with size in production)</span></span>
<span id="cb113-59"><a href="#cb113-59" aria-hidden="true" tabindex="-1"></a>            <span class="kw">self</span><span class="op">.</span>transaction_history<span class="op">.</span>push(transaction)<span class="op">;</span></span>
<span id="cb113-60"><a href="#cb113-60" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb113-61"><a href="#cb113-61" aria-hidden="true" tabindex="-1"></a>            <span class="co">// Limit history size to prevent storage bloat</span></span>
<span id="cb113-62"><a href="#cb113-62" aria-hidden="true" tabindex="-1"></a>            <span class="kw">const</span> MAX_HISTORY<span class="op">:</span> <span class="dt">usize</span> <span class="op">=</span> <span class="dv">1000</span><span class="op">;</span></span>
<span id="cb113-63"><a href="#cb113-63" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> <span class="kw">self</span><span class="op">.</span>transaction_history<span class="op">.</span>len() <span class="op">&gt;</span> MAX_HISTORY <span class="op">{</span></span>
<span id="cb113-64"><a href="#cb113-64" aria-hidden="true" tabindex="-1"></a>                <span class="kw">self</span><span class="op">.</span>transaction_history<span class="op">.</span>remove(<span class="dv">0</span>)<span class="op">;</span> <span class="co">// Remove oldest</span></span>
<span id="cb113-65"><a href="#cb113-65" aria-hidden="true" tabindex="-1"></a>            <span class="op">}</span></span>
<span id="cb113-66"><a href="#cb113-66" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb113-67"><a href="#cb113-67" aria-hidden="true" tabindex="-1"></a>            <span class="cn">Ok</span>(())</span>
<span id="cb113-68"><a href="#cb113-68" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb113-69"><a href="#cb113-69" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb113-70"><a href="#cb113-70" aria-hidden="true" tabindex="-1"></a>        <span class="co">/// Get recent transactions with pagination</span></span>
<span id="cb113-71"><a href="#cb113-71" aria-hidden="true" tabindex="-1"></a>        <span class="at">#[</span>ink<span class="at">(</span>message<span class="at">)]</span></span>
<span id="cb113-72"><a href="#cb113-72" aria-hidden="true" tabindex="-1"></a>        <span class="kw">pub</span> <span class="kw">fn</span> get_recent_transactions(<span class="op">&amp;</span><span class="kw">self</span><span class="op">,</span> count<span class="op">:</span> <span class="dt">u32</span>) <span class="op">-&gt;</span> <span class="dt">Vec</span><span class="op">&lt;</span>Transaction<span class="op">&gt;</span> <span class="op">{</span></span>
<span id="cb113-73"><a href="#cb113-73" aria-hidden="true" tabindex="-1"></a>            <span class="kw">let</span> count <span class="op">=</span> count<span class="op">.</span>min(<span class="dv">100</span>) <span class="kw">as</span> <span class="dt">usize</span><span class="op">;</span> <span class="co">// Limit response size</span></span>
<span id="cb113-74"><a href="#cb113-74" aria-hidden="true" tabindex="-1"></a>            <span class="kw">let</span> len <span class="op">=</span> <span class="kw">self</span><span class="op">.</span>transaction_history<span class="op">.</span>len()<span class="op">;</span></span>
<span id="cb113-75"><a href="#cb113-75" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb113-76"><a href="#cb113-76" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> len <span class="op">&lt;=</span> count <span class="op">{</span></span>
<span id="cb113-77"><a href="#cb113-77" aria-hidden="true" tabindex="-1"></a>                <span class="kw">self</span><span class="op">.</span>transaction_history<span class="op">.</span>clone()</span>
<span id="cb113-78"><a href="#cb113-78" aria-hidden="true" tabindex="-1"></a>            <span class="op">}</span> <span class="cf">else</span> <span class="op">{</span></span>
<span id="cb113-79"><a href="#cb113-79" aria-hidden="true" tabindex="-1"></a>                <span class="kw">self</span><span class="op">.</span>transaction_history[len <span class="op">-</span> count<span class="op">..</span>]<span class="op">.</span>to_vec()</span>
<span id="cb113-80"><a href="#cb113-80" aria-hidden="true" tabindex="-1"></a>            <span class="op">}</span></span>
<span id="cb113-81"><a href="#cb113-81" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb113-82"><a href="#cb113-82" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb113-83"><a href="#cb113-83" aria-hidden="true" tabindex="-1"></a>        <span class="co">/// Demonstrate BTreeMap usage for scoring</span></span>
<span id="cb113-84"><a href="#cb113-84" aria-hidden="true" tabindex="-1"></a>        <span class="at">#[</span>ink<span class="at">(</span>message<span class="at">)]</span></span>
<span id="cb113-85"><a href="#cb113-85" aria-hidden="true" tabindex="-1"></a>        <span class="kw">pub</span> <span class="kw">fn</span> update_user_score(<span class="op">&amp;</span><span class="kw">mut</span> <span class="kw">self</span><span class="op">,</span> user<span class="op">:</span> AccountId<span class="op">,</span> score<span class="op">:</span> <span class="dt">u64</span>) <span class="op">-&gt;</span> <span class="dt">Result</span><span class="op">&lt;</span>()<span class="op">,</span> <span class="bu">Error</span><span class="op">&gt;</span> <span class="op">{</span></span>
<span id="cb113-86"><a href="#cb113-86" aria-hidden="true" tabindex="-1"></a>            <span class="kw">self</span><span class="op">.</span>user_scores<span class="op">.</span>insert(user<span class="op">,</span> score)<span class="op">;</span></span>
<span id="cb113-87"><a href="#cb113-87" aria-hidden="true" tabindex="-1"></a>            <span class="cn">Ok</span>(())</span>
<span id="cb113-88"><a href="#cb113-88" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb113-89"><a href="#cb113-89" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb113-90"><a href="#cb113-90" aria-hidden="true" tabindex="-1"></a>        <span class="co">/// Get top scorers using BTreeMap iteration</span></span>
<span id="cb113-91"><a href="#cb113-91" aria-hidden="true" tabindex="-1"></a>        <span class="at">#[</span>ink<span class="at">(</span>message<span class="at">)]</span></span>
<span id="cb113-92"><a href="#cb113-92" aria-hidden="true" tabindex="-1"></a>        <span class="kw">pub</span> <span class="kw">fn</span> get_top_scorers(<span class="op">&amp;</span><span class="kw">self</span><span class="op">,</span> count<span class="op">:</span> <span class="dt">u32</span>) <span class="op">-&gt;</span> <span class="dt">Vec</span><span class="op">&lt;</span>(AccountId<span class="op">,</span> <span class="dt">u64</span>)<span class="op">&gt;</span> <span class="op">{</span></span>
<span id="cb113-93"><a href="#cb113-93" aria-hidden="true" tabindex="-1"></a>            <span class="kw">let</span> count <span class="op">=</span> count<span class="op">.</span>min(<span class="dv">50</span>) <span class="kw">as</span> <span class="dt">usize</span><span class="op">;</span></span>
<span id="cb113-94"><a href="#cb113-94" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb113-95"><a href="#cb113-95" aria-hidden="true" tabindex="-1"></a>            <span class="co">// BTreeMap keeps entries sorted by key, but we want sorted by value</span></span>
<span id="cb113-96"><a href="#cb113-96" aria-hidden="true" tabindex="-1"></a>            <span class="kw">let</span> <span class="kw">mut</span> scores<span class="op">:</span> <span class="dt">Vec</span><span class="op">&lt;</span>_<span class="op">&gt;</span> <span class="op">=</span> <span class="kw">self</span><span class="op">.</span>user_scores<span class="op">.</span>iter()<span class="op">.</span>collect()<span class="op">;</span></span>
<span id="cb113-97"><a href="#cb113-97" aria-hidden="true" tabindex="-1"></a>            scores<span class="op">.</span>sort_by(<span class="op">|</span>a<span class="op">,</span> b<span class="op">|</span> b<span class="op">.</span><span class="dv">1</span><span class="op">.</span>cmp(a<span class="op">.</span><span class="dv">1</span>))<span class="op">;</span> <span class="co">// Sort by score descending</span></span>
<span id="cb113-98"><a href="#cb113-98" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb113-99"><a href="#cb113-99" aria-hidden="true" tabindex="-1"></a>            scores<span class="op">.</span>into_iter()</span>
<span id="cb113-100"><a href="#cb113-100" aria-hidden="true" tabindex="-1"></a>                <span class="op">.</span>take(count)</span>
<span id="cb113-101"><a href="#cb113-101" aria-hidden="true" tabindex="-1"></a>                <span class="op">.</span>map(<span class="op">|</span>(account<span class="op">,</span> score)<span class="op">|</span> (<span class="op">*</span>account<span class="op">,</span> <span class="op">*</span>score))</span>
<span id="cb113-102"><a href="#cb113-102" aria-hidden="true" tabindex="-1"></a>                <span class="op">.</span>collect()</span>
<span id="cb113-103"><a href="#cb113-103" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb113-104"><a href="#cb113-104" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb113-105"><a href="#cb113-105" aria-hidden="true" tabindex="-1"></a>        <span class="co">/// Demonstrate BTreeSet usage for verification</span></span>
<span id="cb113-106"><a href="#cb113-106" aria-hidden="true" tabindex="-1"></a>        <span class="at">#[</span>ink<span class="at">(</span>message<span class="at">)]</span></span>
<span id="cb113-107"><a href="#cb113-107" aria-hidden="true" tabindex="-1"></a>        <span class="kw">pub</span> <span class="kw">fn</span> verify_user(<span class="op">&amp;</span><span class="kw">mut</span> <span class="kw">self</span><span class="op">,</span> user<span class="op">:</span> AccountId) <span class="op">-&gt;</span> <span class="dt">Result</span><span class="op">&lt;</span>()<span class="op">,</span> <span class="bu">Error</span><span class="op">&gt;</span> <span class="op">{</span></span>
<span id="cb113-108"><a href="#cb113-108" aria-hidden="true" tabindex="-1"></a>            <span class="co">// Only admin can verify (check omitted)</span></span>
<span id="cb113-109"><a href="#cb113-109" aria-hidden="true" tabindex="-1"></a>            <span class="kw">self</span><span class="op">.</span>verified_users<span class="op">.</span>insert(user)<span class="op">;</span></span>
<span id="cb113-110"><a href="#cb113-110" aria-hidden="true" tabindex="-1"></a>            <span class="cn">Ok</span>(())</span>
<span id="cb113-111"><a href="#cb113-111" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb113-112"><a href="#cb113-112" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb113-113"><a href="#cb113-113" aria-hidden="true" tabindex="-1"></a>        <span class="at">#[</span>ink<span class="at">(</span>message<span class="at">)]</span></span>
<span id="cb113-114"><a href="#cb113-114" aria-hidden="true" tabindex="-1"></a>        <span class="kw">pub</span> <span class="kw">fn</span> is_verified(<span class="op">&amp;</span><span class="kw">self</span><span class="op">,</span> user<span class="op">:</span> AccountId) <span class="op">-&gt;</span> <span class="dt">bool</span> <span class="op">{</span></span>
<span id="cb113-115"><a href="#cb113-115" aria-hidden="true" tabindex="-1"></a>            <span class="kw">self</span><span class="op">.</span>verified_users<span class="op">.</span>contains(<span class="op">&amp;</span>user)</span>
<span id="cb113-116"><a href="#cb113-116" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb113-117"><a href="#cb113-117" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb113-118"><a href="#cb113-118" aria-hidden="true" tabindex="-1"></a>        <span class="co">/// Get all verified users</span></span>
<span id="cb113-119"><a href="#cb113-119" aria-hidden="true" tabindex="-1"></a>        <span class="at">#[</span>ink<span class="at">(</span>message<span class="at">)]</span></span>
<span id="cb113-120"><a href="#cb113-120" aria-hidden="true" tabindex="-1"></a>        <span class="kw">pub</span> <span class="kw">fn</span> get_verified_users(<span class="op">&amp;</span><span class="kw">self</span>) <span class="op">-&gt;</span> <span class="dt">Vec</span><span class="op">&lt;</span>AccountId<span class="op">&gt;</span> <span class="op">{</span></span>
<span id="cb113-121"><a href="#cb113-121" aria-hidden="true" tabindex="-1"></a>            <span class="kw">self</span><span class="op">.</span>verified_users<span class="op">.</span>iter()<span class="op">.</span>cloned()<span class="op">.</span>collect()</span>
<span id="cb113-122"><a href="#cb113-122" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb113-123"><a href="#cb113-123" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb113-124"><a href="#cb113-124" aria-hidden="true" tabindex="-1"></a>        <span class="co">/// String manipulation examples</span></span>
<span id="cb113-125"><a href="#cb113-125" aria-hidden="true" tabindex="-1"></a>        <span class="at">#[</span>ink<span class="at">(</span>message<span class="at">)]</span></span>
<span id="cb113-126"><a href="#cb113-126" aria-hidden="true" tabindex="-1"></a>        <span class="kw">pub</span> <span class="kw">fn</span> update_metadata(<span class="op">&amp;</span><span class="kw">mut</span> <span class="kw">self</span><span class="op">,</span> new_metadata<span class="op">:</span> <span class="dt">String</span>) <span class="op">-&gt;</span> <span class="dt">Result</span><span class="op">&lt;</span>()<span class="op">,</span> <span class="bu">Error</span><span class="op">&gt;</span> <span class="op">{</span></span>
<span id="cb113-127"><a href="#cb113-127" aria-hidden="true" tabindex="-1"></a>            <span class="co">// Validate metadata size</span></span>
<span id="cb113-128"><a href="#cb113-128" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> new_metadata<span class="op">.</span>len() <span class="op">&gt;</span> <span class="dv">1000</span> <span class="op">{</span></span>
<span id="cb113-129"><a href="#cb113-129" aria-hidden="true" tabindex="-1"></a>                <span class="cf">return</span> <span class="cn">Err</span>(<span class="bu">Error</span><span class="pp">::</span>InvalidParameters)<span class="op">;</span></span>
<span id="cb113-130"><a href="#cb113-130" aria-hidden="true" tabindex="-1"></a>            <span class="op">}</span></span>
<span id="cb113-131"><a href="#cb113-131" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb113-132"><a href="#cb113-132" aria-hidden="true" tabindex="-1"></a>            <span class="co">// String operations work in no_std</span></span>
<span id="cb113-133"><a href="#cb113-133" aria-hidden="true" tabindex="-1"></a>            <span class="kw">let</span> <span class="kw">mut</span> combined <span class="op">=</span> <span class="kw">self</span><span class="op">.</span>contract_metadata<span class="op">.</span>clone()<span class="op">;</span></span>
<span id="cb113-134"><a href="#cb113-134" aria-hidden="true" tabindex="-1"></a>            combined<span class="op">.</span>push_str(<span class="st">&quot; | &quot;</span>)<span class="op">;</span></span>
<span id="cb113-135"><a href="#cb113-135" aria-hidden="true" tabindex="-1"></a>            combined<span class="op">.</span>push_str(<span class="op">&amp;</span>new_metadata)<span class="op">;</span></span>
<span id="cb113-136"><a href="#cb113-136" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb113-137"><a href="#cb113-137" aria-hidden="true" tabindex="-1"></a>            <span class="kw">self</span><span class="op">.</span>contract_metadata <span class="op">=</span> combined<span class="op">;</span></span>
<span id="cb113-138"><a href="#cb113-138" aria-hidden="true" tabindex="-1"></a>            <span class="cn">Ok</span>(())</span>
<span id="cb113-139"><a href="#cb113-139" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb113-140"><a href="#cb113-140" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb113-141"><a href="#cb113-141" aria-hidden="true" tabindex="-1"></a>        <span class="co">/// Advanced collection operations</span></span>
<span id="cb113-142"><a href="#cb113-142" aria-hidden="true" tabindex="-1"></a>        <span class="at">#[</span>ink<span class="at">(</span>message<span class="at">)]</span></span>
<span id="cb113-143"><a href="#cb113-143" aria-hidden="true" tabindex="-1"></a>        <span class="kw">pub</span> <span class="kw">fn</span> get_user_stats(<span class="op">&amp;</span><span class="kw">self</span><span class="op">,</span> user<span class="op">:</span> AccountId) <span class="op">-&gt;</span> UserStats <span class="op">{</span></span>
<span id="cb113-144"><a href="#cb113-144" aria-hidden="true" tabindex="-1"></a>            <span class="kw">let</span> score <span class="op">=</span> <span class="kw">self</span><span class="op">.</span>user_scores<span class="op">.</span>get(<span class="op">&amp;</span>user)<span class="op">.</span>copied()<span class="op">.</span>unwrap_or(<span class="dv">0</span>)<span class="op">;</span></span>
<span id="cb113-145"><a href="#cb113-145" aria-hidden="true" tabindex="-1"></a>            <span class="kw">let</span> is_verified <span class="op">=</span> <span class="kw">self</span><span class="op">.</span>verified_users<span class="op">.</span>contains(<span class="op">&amp;</span>user)<span class="op">;</span></span>
<span id="cb113-146"><a href="#cb113-146" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb113-147"><a href="#cb113-147" aria-hidden="true" tabindex="-1"></a>            <span class="co">// Count user&#39;s transactions</span></span>
<span id="cb113-148"><a href="#cb113-148" aria-hidden="true" tabindex="-1"></a>            <span class="kw">let</span> transaction_count <span class="op">=</span> <span class="kw">self</span><span class="op">.</span>transaction_history</span>
<span id="cb113-149"><a href="#cb113-149" aria-hidden="true" tabindex="-1"></a>                <span class="op">.</span>iter()</span>
<span id="cb113-150"><a href="#cb113-150" aria-hidden="true" tabindex="-1"></a>                <span class="op">.</span>filter(<span class="op">|</span>tx<span class="op">|</span> tx<span class="op">.</span>from <span class="op">==</span> user <span class="op">||</span> tx<span class="op">.</span>to <span class="op">==</span> user)</span>
<span id="cb113-151"><a href="#cb113-151" aria-hidden="true" tabindex="-1"></a>                <span class="op">.</span>count() <span class="kw">as</span> <span class="dt">u32</span><span class="op">;</span></span>
<span id="cb113-152"><a href="#cb113-152" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb113-153"><a href="#cb113-153" aria-hidden="true" tabindex="-1"></a>            UserStats <span class="op">{</span></span>
<span id="cb113-154"><a href="#cb113-154" aria-hidden="true" tabindex="-1"></a>                score<span class="op">,</span></span>
<span id="cb113-155"><a href="#cb113-155" aria-hidden="true" tabindex="-1"></a>                is_verified<span class="op">,</span></span>
<span id="cb113-156"><a href="#cb113-156" aria-hidden="true" tabindex="-1"></a>                transaction_count<span class="op">,</span></span>
<span id="cb113-157"><a href="#cb113-157" aria-hidden="true" tabindex="-1"></a>            <span class="op">}</span></span>
<span id="cb113-158"><a href="#cb113-158" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb113-159"><a href="#cb113-159" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb113-160"><a href="#cb113-160" aria-hidden="true" tabindex="-1"></a>        <span class="co">/// Batch operations with iterators</span></span>
<span id="cb113-161"><a href="#cb113-161" aria-hidden="true" tabindex="-1"></a>        <span class="at">#[</span>ink<span class="at">(</span>message<span class="at">)]</span></span>
<span id="cb113-162"><a href="#cb113-162" aria-hidden="true" tabindex="-1"></a>        <span class="kw">pub</span> <span class="kw">fn</span> batch_verify_users(<span class="op">&amp;</span><span class="kw">mut</span> <span class="kw">self</span><span class="op">,</span> users<span class="op">:</span> <span class="dt">Vec</span><span class="op">&lt;</span>AccountId<span class="op">&gt;</span>) <span class="op">-&gt;</span> <span class="dt">Result</span><span class="op">&lt;</span><span class="dt">u32</span><span class="op">,</span> <span class="bu">Error</span><span class="op">&gt;</span> <span class="op">{</span></span>
<span id="cb113-163"><a href="#cb113-163" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> users<span class="op">.</span>len() <span class="op">&gt;</span> <span class="dv">100</span> <span class="op">{</span></span>
<span id="cb113-164"><a href="#cb113-164" aria-hidden="true" tabindex="-1"></a>                <span class="cf">return</span> <span class="cn">Err</span>(<span class="bu">Error</span><span class="pp">::</span>InvalidParameters)<span class="op">;</span></span>
<span id="cb113-165"><a href="#cb113-165" aria-hidden="true" tabindex="-1"></a>            <span class="op">}</span></span>
<span id="cb113-166"><a href="#cb113-166" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb113-167"><a href="#cb113-167" aria-hidden="true" tabindex="-1"></a>            <span class="kw">let</span> <span class="kw">mut</span> verified_count <span class="op">=</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb113-168"><a href="#cb113-168" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb113-169"><a href="#cb113-169" aria-hidden="true" tabindex="-1"></a>            <span class="cf">for</span> user <span class="kw">in</span> users <span class="op">{</span></span>
<span id="cb113-170"><a href="#cb113-170" aria-hidden="true" tabindex="-1"></a>                <span class="cf">if</span> <span class="kw">self</span><span class="op">.</span>verified_users<span class="op">.</span>insert(user) <span class="op">{</span></span>
<span id="cb113-171"><a href="#cb113-171" aria-hidden="true" tabindex="-1"></a>                    verified_count <span class="op">+=</span> <span class="dv">1</span><span class="op">;</span> <span class="co">// insert returns true if newly inserted</span></span>
<span id="cb113-172"><a href="#cb113-172" aria-hidden="true" tabindex="-1"></a>                <span class="op">}</span></span>
<span id="cb113-173"><a href="#cb113-173" aria-hidden="true" tabindex="-1"></a>            <span class="op">}</span></span>
<span id="cb113-174"><a href="#cb113-174" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb113-175"><a href="#cb113-175" aria-hidden="true" tabindex="-1"></a>            <span class="cn">Ok</span>(verified_count)</span>
<span id="cb113-176"><a href="#cb113-176" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb113-177"><a href="#cb113-177" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb113-178"><a href="#cb113-178" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb113-179"><a href="#cb113-179" aria-hidden="true" tabindex="-1"></a>    <span class="at">#[</span>derive<span class="at">(</span><span class="bu">Debug</span><span class="op">,</span> <span class="bu">PartialEq</span><span class="op">,</span> <span class="bu">Eq</span><span class="op">,</span> <span class="pp">scale::</span>Encode<span class="op">,</span> <span class="pp">scale::</span>Decode<span class="at">)]</span></span>
<span id="cb113-180"><a href="#cb113-180" aria-hidden="true" tabindex="-1"></a>    <span class="at">#[</span>cfg_attr<span class="at">(</span>feature <span class="op">=</span> <span class="st">&quot;std&quot;</span><span class="op">,</span> derive<span class="at">(</span><span class="pp">scale_info::</span>TypeInfo<span class="at">))]</span></span>
<span id="cb113-181"><a href="#cb113-181" aria-hidden="true" tabindex="-1"></a>    <span class="kw">pub</span> <span class="kw">struct</span> UserStats <span class="op">{</span></span>
<span id="cb113-182"><a href="#cb113-182" aria-hidden="true" tabindex="-1"></a>        <span class="kw">pub</span> score<span class="op">:</span> <span class="dt">u64</span><span class="op">,</span></span>
<span id="cb113-183"><a href="#cb113-183" aria-hidden="true" tabindex="-1"></a>        <span class="kw">pub</span> is_verified<span class="op">:</span> <span class="dt">bool</span><span class="op">,</span></span>
<span id="cb113-184"><a href="#cb113-184" aria-hidden="true" tabindex="-1"></a>        <span class="kw">pub</span> transaction_count<span class="op">:</span> <span class="dt">u32</span><span class="op">,</span></span>
<span id="cb113-185"><a href="#cb113-185" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb113-186"><a href="#cb113-186" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<h2 id="contract-upgradability">Contract Upgradability</h2>
<p>Implement upgradeable contract patterns while maintaining security
and data integrity:</p>
<h3 id="proxy-pattern-implementation">Proxy Pattern Implementation</h3>
<div class="sourceCode" id="cb114"><pre
class="sourceCode rust"><code class="sourceCode rust"><span id="cb114-1"><a href="#cb114-1" aria-hidden="true" tabindex="-1"></a><span class="co">/// Implementation contract interface</span></span>
<span id="cb114-2"><a href="#cb114-2" aria-hidden="true" tabindex="-1"></a><span class="at">#[</span><span class="pp">ink::</span>trait_definition<span class="at">]</span></span>
<span id="cb114-3"><a href="#cb114-3" aria-hidden="true" tabindex="-1"></a><span class="kw">pub</span> <span class="kw">trait</span> Implementation <span class="op">{</span></span>
<span id="cb114-4"><a href="#cb114-4" aria-hidden="true" tabindex="-1"></a>    <span class="at">#[</span>ink<span class="at">(</span>message<span class="at">)]</span></span>
<span id="cb114-5"><a href="#cb114-5" aria-hidden="true" tabindex="-1"></a>    <span class="kw">fn</span> version(<span class="op">&amp;</span><span class="kw">self</span>) <span class="op">-&gt;</span> <span class="dt">u32</span><span class="op">;</span></span>
<span id="cb114-6"><a href="#cb114-6" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb114-7"><a href="#cb114-7" aria-hidden="true" tabindex="-1"></a>    <span class="at">#[</span>ink<span class="at">(</span>message<span class="at">)]</span></span>
<span id="cb114-8"><a href="#cb114-8" aria-hidden="true" tabindex="-1"></a>    <span class="kw">fn</span> initialize(<span class="op">&amp;</span><span class="kw">mut</span> <span class="kw">self</span><span class="op">,</span> data<span class="op">:</span> <span class="dt">Vec</span><span class="op">&lt;</span><span class="dt">u8</span><span class="op">&gt;</span>) <span class="op">-&gt;</span> <span class="dt">Result</span><span class="op">&lt;</span>()<span class="op">,</span> <span class="bu">Error</span><span class="op">&gt;;</span></span>
<span id="cb114-9"><a href="#cb114-9" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb114-10"><a href="#cb114-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb114-11"><a href="#cb114-11" aria-hidden="true" tabindex="-1"></a><span class="at">#[</span><span class="pp">ink::</span>contract<span class="at">]</span></span>
<span id="cb114-12"><a href="#cb114-12" aria-hidden="true" tabindex="-1"></a><span class="kw">mod</span> upgradeable_proxy <span class="op">{</span></span>
<span id="cb114-13"><a href="#cb114-13" aria-hidden="true" tabindex="-1"></a>    <span class="kw">use</span> <span class="kw">super</span><span class="pp">::</span>Implementation<span class="op">;</span></span>
<span id="cb114-14"><a href="#cb114-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb114-15"><a href="#cb114-15" aria-hidden="true" tabindex="-1"></a>    <span class="at">#[</span>ink<span class="at">(</span>storage<span class="at">)]</span></span>
<span id="cb114-16"><a href="#cb114-16" aria-hidden="true" tabindex="-1"></a>    <span class="kw">pub</span> <span class="kw">struct</span> UpgradeableProxy <span class="op">{</span></span>
<span id="cb114-17"><a href="#cb114-17" aria-hidden="true" tabindex="-1"></a>        <span class="co">/// Current implementation contract address</span></span>
<span id="cb114-18"><a href="#cb114-18" aria-hidden="true" tabindex="-1"></a>        implementation<span class="op">:</span> AccountId<span class="op">,</span></span>
<span id="cb114-19"><a href="#cb114-19" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb114-20"><a href="#cb114-20" aria-hidden="true" tabindex="-1"></a>        <span class="co">/// Contract admin who can upgrade</span></span>
<span id="cb114-21"><a href="#cb114-21" aria-hidden="true" tabindex="-1"></a>        admin<span class="op">:</span> AccountId<span class="op">,</span></span>
<span id="cb114-22"><a href="#cb114-22" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb114-23"><a href="#cb114-23" aria-hidden="true" tabindex="-1"></a>        <span class="co">/// Current version for tracking</span></span>
<span id="cb114-24"><a href="#cb114-24" aria-hidden="true" tabindex="-1"></a>        version<span class="op">:</span> <span class="dt">u32</span><span class="op">,</span></span>
<span id="cb114-25"><a href="#cb114-25" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb114-26"><a href="#cb114-26" aria-hidden="true" tabindex="-1"></a>        <span class="co">/// Upgrade history for auditing</span></span>
<span id="cb114-27"><a href="#cb114-27" aria-hidden="true" tabindex="-1"></a>        upgrade_history<span class="op">:</span> <span class="dt">Vec</span><span class="op">&lt;</span>UpgradeRecord<span class="op">&gt;,</span></span>
<span id="cb114-28"><a href="#cb114-28" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb114-29"><a href="#cb114-29" aria-hidden="true" tabindex="-1"></a>        <span class="co">/// Emergency controls</span></span>
<span id="cb114-30"><a href="#cb114-30" aria-hidden="true" tabindex="-1"></a>        upgrade_delay<span class="op">:</span> <span class="dt">u64</span><span class="op">,</span>  <span class="co">// Minimum delay between upgrades</span></span>
<span id="cb114-31"><a href="#cb114-31" aria-hidden="true" tabindex="-1"></a>        last_upgrade<span class="op">:</span> <span class="dt">u64</span><span class="op">,</span>   <span class="co">// Timestamp of last upgrade</span></span>
<span id="cb114-32"><a href="#cb114-32" aria-hidden="true" tabindex="-1"></a>        emergency_pause<span class="op">:</span> <span class="dt">bool</span><span class="op">,</span></span>
<span id="cb114-33"><a href="#cb114-33" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb114-34"><a href="#cb114-34" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb114-35"><a href="#cb114-35" aria-hidden="true" tabindex="-1"></a>    <span class="at">#[</span>derive<span class="at">(</span><span class="bu">Debug</span><span class="op">,</span> <span class="bu">Clone</span><span class="op">,</span> <span class="bu">PartialEq</span><span class="op">,</span> <span class="bu">Eq</span><span class="op">,</span> <span class="pp">scale::</span>Encode<span class="op">,</span> <span class="pp">scale::</span>Decode<span class="at">)]</span></span>
<span id="cb114-36"><a href="#cb114-36" aria-hidden="true" tabindex="-1"></a>    <span class="at">#[</span>cfg_attr<span class="at">(</span>feature <span class="op">=</span> <span class="st">&quot;std&quot;</span><span class="op">,</span> derive<span class="at">(</span><span class="pp">scale_info::</span>TypeInfo<span class="at">))]</span></span>
<span id="cb114-37"><a href="#cb114-37" aria-hidden="true" tabindex="-1"></a>    <span class="kw">pub</span> <span class="kw">struct</span> UpgradeRecord <span class="op">{</span></span>
<span id="cb114-38"><a href="#cb114-38" aria-hidden="true" tabindex="-1"></a>        <span class="kw">pub</span> from_implementation<span class="op">:</span> AccountId<span class="op">,</span></span>
<span id="cb114-39"><a href="#cb114-39" aria-hidden="true" tabindex="-1"></a>        <span class="kw">pub</span> to_implementation<span class="op">:</span> AccountId<span class="op">,</span></span>
<span id="cb114-40"><a href="#cb114-40" aria-hidden="true" tabindex="-1"></a>        <span class="kw">pub</span> timestamp<span class="op">:</span> <span class="dt">u64</span><span class="op">,</span></span>
<span id="cb114-41"><a href="#cb114-41" aria-hidden="true" tabindex="-1"></a>        <span class="kw">pub</span> version<span class="op">:</span> <span class="dt">u32</span><span class="op">,</span></span>
<span id="cb114-42"><a href="#cb114-42" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb114-43"><a href="#cb114-43" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb114-44"><a href="#cb114-44" aria-hidden="true" tabindex="-1"></a>    <span class="kw">impl</span> UpgradeableProxy <span class="op">{</span></span>
<span id="cb114-45"><a href="#cb114-45" aria-hidden="true" tabindex="-1"></a>        <span class="at">#[</span>ink<span class="at">(</span>constructor<span class="at">)]</span></span>
<span id="cb114-46"><a href="#cb114-46" aria-hidden="true" tabindex="-1"></a>        <span class="kw">pub</span> <span class="kw">fn</span> new(implementation<span class="op">:</span> AccountId<span class="op">,</span> admin<span class="op">:</span> AccountId) <span class="op">-&gt;</span> <span class="dt">Self</span> <span class="op">{</span></span>
<span id="cb114-47"><a href="#cb114-47" aria-hidden="true" tabindex="-1"></a>            <span class="dt">Self</span> <span class="op">{</span></span>
<span id="cb114-48"><a href="#cb114-48" aria-hidden="true" tabindex="-1"></a>                implementation<span class="op">,</span></span>
<span id="cb114-49"><a href="#cb114-49" aria-hidden="true" tabindex="-1"></a>                admin<span class="op">,</span></span>
<span id="cb114-50"><a href="#cb114-50" aria-hidden="true" tabindex="-1"></a>                version<span class="op">:</span> <span class="dv">1</span><span class="op">,</span></span>
<span id="cb114-51"><a href="#cb114-51" aria-hidden="true" tabindex="-1"></a>                upgrade_history<span class="op">:</span> <span class="dt">Vec</span><span class="pp">::</span>new()<span class="op">,</span></span>
<span id="cb114-52"><a href="#cb114-52" aria-hidden="true" tabindex="-1"></a>                upgrade_delay<span class="op">:</span> <span class="dv">86400000</span><span class="op">,</span> <span class="co">// 24 hours in milliseconds</span></span>
<span id="cb114-53"><a href="#cb114-53" aria-hidden="true" tabindex="-1"></a>                last_upgrade<span class="op">:</span> <span class="dv">0</span><span class="op">,</span></span>
<span id="cb114-54"><a href="#cb114-54" aria-hidden="true" tabindex="-1"></a>                emergency_pause<span class="op">:</span> <span class="cn">false</span><span class="op">,</span></span>
<span id="cb114-55"><a href="#cb114-55" aria-hidden="true" tabindex="-1"></a>            <span class="op">}</span></span>
<span id="cb114-56"><a href="#cb114-56" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb114-57"><a href="#cb114-57" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb114-58"><a href="#cb114-58" aria-hidden="true" tabindex="-1"></a>        <span class="co">/// Propose an upgrade (with timelock)</span></span>
<span id="cb114-59"><a href="#cb114-59" aria-hidden="true" tabindex="-1"></a>        <span class="at">#[</span>ink<span class="at">(</span>message<span class="at">)]</span></span>
<span id="cb114-60"><a href="#cb114-60" aria-hidden="true" tabindex="-1"></a>        <span class="kw">pub</span> <span class="kw">fn</span> propose_upgrade(<span class="op">&amp;</span><span class="kw">mut</span> <span class="kw">self</span><span class="op">,</span> new_implementation<span class="op">:</span> AccountId) <span class="op">-&gt;</span> <span class="dt">Result</span><span class="op">&lt;</span>()<span class="op">,</span> <span class="bu">Error</span><span class="op">&gt;</span> <span class="op">{</span></span>
<span id="cb114-61"><a href="#cb114-61" aria-hidden="true" tabindex="-1"></a>            <span class="kw">self</span><span class="op">.</span>ensure_admin()<span class="op">?;</span></span>
<span id="cb114-62"><a href="#cb114-62" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb114-63"><a href="#cb114-63" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> <span class="kw">self</span><span class="op">.</span>emergency_pause <span class="op">{</span></span>
<span id="cb114-64"><a href="#cb114-64" aria-hidden="true" tabindex="-1"></a>                <span class="cf">return</span> <span class="cn">Err</span>(<span class="bu">Error</span><span class="pp">::</span>ContractPaused)<span class="op">;</span></span>
<span id="cb114-65"><a href="#cb114-65" aria-hidden="true" tabindex="-1"></a>            <span class="op">}</span></span>
<span id="cb114-66"><a href="#cb114-66" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb114-67"><a href="#cb114-67" aria-hidden="true" tabindex="-1"></a>            <span class="co">// Validate new implementation</span></span>
<span id="cb114-68"><a href="#cb114-68" aria-hidden="true" tabindex="-1"></a>            <span class="kw">let</span> new_impl<span class="op">:</span> <span class="pp">ink::contract_ref!</span>(Implementation) <span class="op">=</span> new_implementation<span class="op">.</span>into()<span class="op">;</span></span>
<span id="cb114-69"><a href="#cb114-69" aria-hidden="true" tabindex="-1"></a>            <span class="kw">let</span> new_version <span class="op">=</span> new_impl<span class="op">.</span>version()<span class="op">;</span></span>
<span id="cb114-70"><a href="#cb114-70" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb114-71"><a href="#cb114-71" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> new_version <span class="op">&lt;=</span> <span class="kw">self</span><span class="op">.</span>version <span class="op">{</span></span>
<span id="cb114-72"><a href="#cb114-72" aria-hidden="true" tabindex="-1"></a>                <span class="cf">return</span> <span class="cn">Err</span>(<span class="bu">Error</span><span class="pp">::</span>InvalidVersion)<span class="op">;</span></span>
<span id="cb114-73"><a href="#cb114-73" aria-hidden="true" tabindex="-1"></a>            <span class="op">}</span></span>
<span id="cb114-74"><a href="#cb114-74" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb114-75"><a href="#cb114-75" aria-hidden="true" tabindex="-1"></a>            <span class="co">// Check upgrade delay</span></span>
<span id="cb114-76"><a href="#cb114-76" aria-hidden="true" tabindex="-1"></a>            <span class="kw">let</span> current_time <span class="op">=</span> <span class="kw">self</span><span class="op">.</span>env()<span class="op">.</span>block_timestamp()<span class="op">;</span></span>
<span id="cb114-77"><a href="#cb114-77" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> current_time <span class="op">-</span> <span class="kw">self</span><span class="op">.</span>last_upgrade <span class="op">&lt;</span> <span class="kw">self</span><span class="op">.</span>upgrade_delay <span class="op">{</span></span>
<span id="cb114-78"><a href="#cb114-78" aria-hidden="true" tabindex="-1"></a>                <span class="cf">return</span> <span class="cn">Err</span>(<span class="bu">Error</span><span class="pp">::</span>UpgradeTooSoon)<span class="op">;</span></span>
<span id="cb114-79"><a href="#cb114-79" aria-hidden="true" tabindex="-1"></a>            <span class="op">}</span></span>
<span id="cb114-80"><a href="#cb114-80" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb114-81"><a href="#cb114-81" aria-hidden="true" tabindex="-1"></a>            <span class="co">// Record the upgrade</span></span>
<span id="cb114-82"><a href="#cb114-82" aria-hidden="true" tabindex="-1"></a>            <span class="kw">let</span> upgrade_record <span class="op">=</span> UpgradeRecord <span class="op">{</span></span>
<span id="cb114-83"><a href="#cb114-83" aria-hidden="true" tabindex="-1"></a>                from_implementation<span class="op">:</span> <span class="kw">self</span><span class="op">.</span>implementation<span class="op">,</span></span>
<span id="cb114-84"><a href="#cb114-84" aria-hidden="true" tabindex="-1"></a>                to_implementation<span class="op">:</span> new_implementation<span class="op">,</span></span>
<span id="cb114-85"><a href="#cb114-85" aria-hidden="true" tabindex="-1"></a>                timestamp<span class="op">:</span> current_time<span class="op">,</span></span>
<span id="cb114-86"><a href="#cb114-86" aria-hidden="true" tabindex="-1"></a>                version<span class="op">:</span> new_version<span class="op">,</span></span>
<span id="cb114-87"><a href="#cb114-87" aria-hidden="true" tabindex="-1"></a>            <span class="op">};</span></span>
<span id="cb114-88"><a href="#cb114-88" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb114-89"><a href="#cb114-89" aria-hidden="true" tabindex="-1"></a>            <span class="kw">self</span><span class="op">.</span>upgrade_history<span class="op">.</span>push(upgrade_record)<span class="op">;</span></span>
<span id="cb114-90"><a href="#cb114-90" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb114-91"><a href="#cb114-91" aria-hidden="true" tabindex="-1"></a>            <span class="co">// Update implementation</span></span>
<span id="cb114-92"><a href="#cb114-92" aria-hidden="true" tabindex="-1"></a>            <span class="kw">self</span><span class="op">.</span>implementation <span class="op">=</span> new_implementation<span class="op">;</span></span>
<span id="cb114-93"><a href="#cb114-93" aria-hidden="true" tabindex="-1"></a>            <span class="kw">self</span><span class="op">.</span>version <span class="op">=</span> new_version<span class="op">;</span></span>
<span id="cb114-94"><a href="#cb114-94" aria-hidden="true" tabindex="-1"></a>            <span class="kw">self</span><span class="op">.</span>last_upgrade <span class="op">=</span> current_time<span class="op">;</span></span>
<span id="cb114-95"><a href="#cb114-95" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb114-96"><a href="#cb114-96" aria-hidden="true" tabindex="-1"></a>            <span class="kw">self</span><span class="op">.</span>env()<span class="op">.</span>emit_event(UpgradeProposed <span class="op">{</span></span>
<span id="cb114-97"><a href="#cb114-97" aria-hidden="true" tabindex="-1"></a>                old_implementation<span class="op">:</span> <span class="kw">self</span><span class="op">.</span>implementation<span class="op">,</span></span>
<span id="cb114-98"><a href="#cb114-98" aria-hidden="true" tabindex="-1"></a>                new_implementation<span class="op">,</span></span>
<span id="cb114-99"><a href="#cb114-99" aria-hidden="true" tabindex="-1"></a>                new_version<span class="op">,</span></span>
<span id="cb114-100"><a href="#cb114-100" aria-hidden="true" tabindex="-1"></a>                timestamp<span class="op">:</span> current_time<span class="op">,</span></span>
<span id="cb114-101"><a href="#cb114-101" aria-hidden="true" tabindex="-1"></a>            <span class="op">}</span>)<span class="op">;</span></span>
<span id="cb114-102"><a href="#cb114-102" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb114-103"><a href="#cb114-103" aria-hidden="true" tabindex="-1"></a>            <span class="cn">Ok</span>(())</span>
<span id="cb114-104"><a href="#cb114-104" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb114-105"><a href="#cb114-105" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb114-106"><a href="#cb114-106" aria-hidden="true" tabindex="-1"></a>        <span class="co">/// Emergency upgrade (bypasses timelock)</span></span>
<span id="cb114-107"><a href="#cb114-107" aria-hidden="true" tabindex="-1"></a>        <span class="at">#[</span>ink<span class="at">(</span>message<span class="at">)]</span></span>
<span id="cb114-108"><a href="#cb114-108" aria-hidden="true" tabindex="-1"></a>        <span class="kw">pub</span> <span class="kw">fn</span> emergency_upgrade(<span class="op">&amp;</span><span class="kw">mut</span> <span class="kw">self</span><span class="op">,</span> new_implementation<span class="op">:</span> AccountId) <span class="op">-&gt;</span> <span class="dt">Result</span><span class="op">&lt;</span>()<span class="op">,</span> <span class="bu">Error</span><span class="op">&gt;</span> <span class="op">{</span></span>
<span id="cb114-109"><a href="#cb114-109" aria-hidden="true" tabindex="-1"></a>            <span class="kw">self</span><span class="op">.</span>ensure_admin()<span class="op">?;</span></span>
<span id="cb114-110"><a href="#cb114-110" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb114-111"><a href="#cb114-111" aria-hidden="true" tabindex="-1"></a>            <span class="co">// Validate emergency conditions</span></span>
<span id="cb114-112"><a href="#cb114-112" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> <span class="op">!</span><span class="kw">self</span><span class="op">.</span>emergency_pause <span class="op">{</span></span>
<span id="cb114-113"><a href="#cb114-113" aria-hidden="true" tabindex="-1"></a>                <span class="cf">return</span> <span class="cn">Err</span>(<span class="bu">Error</span><span class="pp">::</span>NotInEmergency)<span class="op">;</span></span>
<span id="cb114-114"><a href="#cb114-114" aria-hidden="true" tabindex="-1"></a>            <span class="op">}</span></span>
<span id="cb114-115"><a href="#cb114-115" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb114-116"><a href="#cb114-116" aria-hidden="true" tabindex="-1"></a>            <span class="co">// Validate new implementation</span></span>
<span id="cb114-117"><a href="#cb114-117" aria-hidden="true" tabindex="-1"></a>            <span class="kw">let</span> new_impl<span class="op">:</span> <span class="pp">ink::contract_ref!</span>(Implementation) <span class="op">=</span> new_implementation<span class="op">.</span>into()<span class="op">;</span></span>
<span id="cb114-118"><a href="#cb114-118" aria-hidden="true" tabindex="-1"></a>            <span class="kw">let</span> new_version <span class="op">=</span> new_impl<span class="op">.</span>version()<span class="op">;</span></span>
<span id="cb114-119"><a href="#cb114-119" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb114-120"><a href="#cb114-120" aria-hidden="true" tabindex="-1"></a>            <span class="co">// Emergency upgrades can be to any version (including downgrades)</span></span>
<span id="cb114-121"><a href="#cb114-121" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb114-122"><a href="#cb114-122" aria-hidden="true" tabindex="-1"></a>            <span class="co">// Update implementation immediately</span></span>
<span id="cb114-123"><a href="#cb114-123" aria-hidden="true" tabindex="-1"></a>            <span class="kw">let</span> old_implementation <span class="op">=</span> <span class="kw">self</span><span class="op">.</span>implementation<span class="op">;</span></span>
<span id="cb114-124"><a href="#cb114-124" aria-hidden="true" tabindex="-1"></a>            <span class="kw">self</span><span class="op">.</span>implementation <span class="op">=</span> new_implementation<span class="op">;</span></span>
<span id="cb114-125"><a href="#cb114-125" aria-hidden="true" tabindex="-1"></a>            <span class="kw">self</span><span class="op">.</span>version <span class="op">=</span> new_version<span class="op">;</span></span>
<span id="cb114-126"><a href="#cb114-126" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb114-127"><a href="#cb114-127" aria-hidden="true" tabindex="-1"></a>            <span class="kw">self</span><span class="op">.</span>env()<span class="op">.</span>emit_event(EmergencyUpgrade <span class="op">{</span></span>
<span id="cb114-128"><a href="#cb114-128" aria-hidden="true" tabindex="-1"></a>                old_implementation<span class="op">,</span></span>
<span id="cb114-129"><a href="#cb114-129" aria-hidden="true" tabindex="-1"></a>                new_implementation<span class="op">,</span></span>
<span id="cb114-130"><a href="#cb114-130" aria-hidden="true" tabindex="-1"></a>                new_version<span class="op">,</span></span>
<span id="cb114-131"><a href="#cb114-131" aria-hidden="true" tabindex="-1"></a>                timestamp<span class="op">:</span> <span class="kw">self</span><span class="op">.</span>env()<span class="op">.</span>block_timestamp()<span class="op">,</span></span>
<span id="cb114-132"><a href="#cb114-132" aria-hidden="true" tabindex="-1"></a>            <span class="op">}</span>)<span class="op">;</span></span>
<span id="cb114-133"><a href="#cb114-133" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb114-134"><a href="#cb114-134" aria-hidden="true" tabindex="-1"></a>            <span class="cn">Ok</span>(())</span>
<span id="cb114-135"><a href="#cb114-135" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb114-136"><a href="#cb114-136" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb114-137"><a href="#cb114-137" aria-hidden="true" tabindex="-1"></a>        <span class="co">/// Delegate calls to current implementation</span></span>
<span id="cb114-138"><a href="#cb114-138" aria-hidden="true" tabindex="-1"></a>        <span class="at">#[</span>ink<span class="at">(</span>message<span class="at">)]</span></span>
<span id="cb114-139"><a href="#cb114-139" aria-hidden="true" tabindex="-1"></a>        <span class="kw">pub</span> <span class="kw">fn</span> delegate_call(<span class="op">&amp;</span><span class="kw">self</span><span class="op">,</span> selector<span class="op">:</span> [<span class="dt">u8</span><span class="op">;</span> <span class="dv">4</span>]<span class="op">,</span> input<span class="op">:</span> <span class="dt">Vec</span><span class="op">&lt;</span><span class="dt">u8</span><span class="op">&gt;</span>) <span class="op">-&gt;</span> <span class="dt">Result</span><span class="op">&lt;</span><span class="dt">Vec</span><span class="op">&lt;</span><span class="dt">u8</span><span class="op">&gt;,</span> <span class="bu">Error</span><span class="op">&gt;</span> <span class="op">{</span></span>
<span id="cb114-140"><a href="#cb114-140" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> <span class="kw">self</span><span class="op">.</span>emergency_pause <span class="op">{</span></span>
<span id="cb114-141"><a href="#cb114-141" aria-hidden="true" tabindex="-1"></a>                <span class="cf">return</span> <span class="cn">Err</span>(<span class="bu">Error</span><span class="pp">::</span>ContractPaused)<span class="op">;</span></span>
<span id="cb114-142"><a href="#cb114-142" aria-hidden="true" tabindex="-1"></a>            <span class="op">}</span></span>
<span id="cb114-143"><a href="#cb114-143" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb114-144"><a href="#cb114-144" aria-hidden="true" tabindex="-1"></a>            <span class="kw">let</span> result <span class="op">=</span> <span class="pp">ink::env::call::build_call::</span><span class="op">&lt;</span><span class="pp">ink::env::</span>DefaultEnvironment<span class="op">&gt;</span>()</span>
<span id="cb114-145"><a href="#cb114-145" aria-hidden="true" tabindex="-1"></a>                <span class="op">.</span>call(<span class="kw">self</span><span class="op">.</span>implementation)</span>
<span id="cb114-146"><a href="#cb114-146" aria-hidden="true" tabindex="-1"></a>                <span class="op">.</span>gas_limit(<span class="dv">0</span>) <span class="co">// Use remaining gas</span></span>
<span id="cb114-147"><a href="#cb114-147" aria-hidden="true" tabindex="-1"></a>                <span class="op">.</span>transferred_value(<span class="kw">self</span><span class="op">.</span>env()<span class="op">.</span>transferred_value())</span>
<span id="cb114-148"><a href="#cb114-148" aria-hidden="true" tabindex="-1"></a>                <span class="op">.</span>exec_input(</span>
<span id="cb114-149"><a href="#cb114-149" aria-hidden="true" tabindex="-1"></a>                    <span class="pp">ink::env::call::ExecutionInput::</span>new(</span>
<span id="cb114-150"><a href="#cb114-150" aria-hidden="true" tabindex="-1"></a>                        <span class="pp">ink::env::call::Selector::</span>new(selector)</span>
<span id="cb114-151"><a href="#cb114-151" aria-hidden="true" tabindex="-1"></a>                    )<span class="op">.</span>push_arg(input)</span>
<span id="cb114-152"><a href="#cb114-152" aria-hidden="true" tabindex="-1"></a>                )</span>
<span id="cb114-153"><a href="#cb114-153" aria-hidden="true" tabindex="-1"></a>                <span class="op">.</span><span class="pp">returns::</span><span class="op">&lt;</span><span class="dt">Vec</span><span class="op">&lt;</span><span class="dt">u8</span><span class="op">&gt;&gt;</span>()</span>
<span id="cb114-154"><a href="#cb114-154" aria-hidden="true" tabindex="-1"></a>                <span class="op">.</span>try_invoke()<span class="op">;</span></span>
<span id="cb114-155"><a href="#cb114-155" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb114-156"><a href="#cb114-156" aria-hidden="true" tabindex="-1"></a>            <span class="cf">match</span> result <span class="op">{</span></span>
<span id="cb114-157"><a href="#cb114-157" aria-hidden="true" tabindex="-1"></a>                <span class="cn">Ok</span>(<span class="cn">Ok</span>(data)) <span class="op">=&gt;</span> <span class="cn">Ok</span>(data)<span class="op">,</span></span>
<span id="cb114-158"><a href="#cb114-158" aria-hidden="true" tabindex="-1"></a>                <span class="cn">Ok</span>(<span class="cn">Err</span>(_)) <span class="op">=&gt;</span> <span class="cn">Err</span>(<span class="bu">Error</span><span class="pp">::</span>CallReverted)<span class="op">,</span></span>
<span id="cb114-159"><a href="#cb114-159" aria-hidden="true" tabindex="-1"></a>                <span class="cn">Err</span>(_) <span class="op">=&gt;</span> <span class="cn">Err</span>(<span class="bu">Error</span><span class="pp">::</span>CallFailed)<span class="op">,</span></span>
<span id="cb114-160"><a href="#cb114-160" aria-hidden="true" tabindex="-1"></a>            <span class="op">}</span></span>
<span id="cb114-161"><a href="#cb114-161" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb114-162"><a href="#cb114-162" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb114-163"><a href="#cb114-163" aria-hidden="true" tabindex="-1"></a>        <span class="co">/// Admin controls</span></span>
<span id="cb114-164"><a href="#cb114-164" aria-hidden="true" tabindex="-1"></a>        <span class="at">#[</span>ink<span class="at">(</span>message<span class="at">)]</span></span>
<span id="cb114-165"><a href="#cb114-165" aria-hidden="true" tabindex="-1"></a>        <span class="kw">pub</span> <span class="kw">fn</span> transfer_admin(<span class="op">&amp;</span><span class="kw">mut</span> <span class="kw">self</span><span class="op">,</span> new_admin<span class="op">:</span> AccountId) <span class="op">-&gt;</span> <span class="dt">Result</span><span class="op">&lt;</span>()<span class="op">,</span> <span class="bu">Error</span><span class="op">&gt;</span> <span class="op">{</span></span>
<span id="cb114-166"><a href="#cb114-166" aria-hidden="true" tabindex="-1"></a>            <span class="kw">self</span><span class="op">.</span>ensure_admin()<span class="op">?;</span></span>
<span id="cb114-167"><a href="#cb114-167" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb114-168"><a href="#cb114-168" aria-hidden="true" tabindex="-1"></a>            <span class="kw">self</span><span class="op">.</span>admin <span class="op">=</span> new_admin<span class="op">;</span></span>
<span id="cb114-169"><a href="#cb114-169" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb114-170"><a href="#cb114-170" aria-hidden="true" tabindex="-1"></a>            <span class="kw">self</span><span class="op">.</span>env()<span class="op">.</span>emit_event(AdminTransferred <span class="op">{</span></span>
<span id="cb114-171"><a href="#cb114-171" aria-hidden="true" tabindex="-1"></a>                old_admin<span class="op">:</span> <span class="kw">self</span><span class="op">.</span>env()<span class="op">.</span>caller()<span class="op">,</span></span>
<span id="cb114-172"><a href="#cb114-172" aria-hidden="true" tabindex="-1"></a>                new_admin<span class="op">,</span></span>
<span id="cb114-173"><a href="#cb114-173" aria-hidden="true" tabindex="-1"></a>                timestamp<span class="op">:</span> <span class="kw">self</span><span class="op">.</span>env()<span class="op">.</span>block_timestamp()<span class="op">,</span></span>
<span id="cb114-174"><a href="#cb114-174" aria-hidden="true" tabindex="-1"></a>            <span class="op">}</span>)<span class="op">;</span></span>
<span id="cb114-175"><a href="#cb114-175" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb114-176"><a href="#cb114-176" aria-hidden="true" tabindex="-1"></a>            <span class="cn">Ok</span>(())</span>
<span id="cb114-177"><a href="#cb114-177" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb114-178"><a href="#cb114-178" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb114-179"><a href="#cb114-179" aria-hidden="true" tabindex="-1"></a>        <span class="at">#[</span>ink<span class="at">(</span>message<span class="at">)]</span></span>
<span id="cb114-180"><a href="#cb114-180" aria-hidden="true" tabindex="-1"></a>        <span class="kw">pub</span> <span class="kw">fn</span> set_upgrade_delay(<span class="op">&amp;</span><span class="kw">mut</span> <span class="kw">self</span><span class="op">,</span> new_delay<span class="op">:</span> <span class="dt">u64</span>) <span class="op">-&gt;</span> <span class="dt">Result</span><span class="op">&lt;</span>()<span class="op">,</span> <span class="bu">Error</span><span class="op">&gt;</span> <span class="op">{</span></span>
<span id="cb114-181"><a href="#cb114-181" aria-hidden="true" tabindex="-1"></a>            <span class="kw">self</span><span class="op">.</span>ensure_admin()<span class="op">?;</span></span>
<span id="cb114-182"><a href="#cb114-182" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb114-183"><a href="#cb114-183" aria-hidden="true" tabindex="-1"></a>            <span class="co">// Reasonable bounds on upgrade delay</span></span>
<span id="cb114-184"><a href="#cb114-184" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> new_delay <span class="op">&lt;</span> <span class="dv">3600000</span> <span class="op">||</span> new_delay <span class="op">&gt;</span> <span class="dv">2592000000</span> <span class="op">{</span> <span class="co">// 1 hour to 30 days</span></span>
<span id="cb114-185"><a href="#cb114-185" aria-hidden="true" tabindex="-1"></a>                <span class="cf">return</span> <span class="cn">Err</span>(<span class="bu">Error</span><span class="pp">::</span>InvalidParameters)<span class="op">;</span></span>
<span id="cb114-186"><a href="#cb114-186" aria-hidden="true" tabindex="-1"></a>            <span class="op">}</span></span>
<span id="cb114-187"><a href="#cb114-187" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb114-188"><a href="#cb114-188" aria-hidden="true" tabindex="-1"></a>            <span class="kw">self</span><span class="op">.</span>upgrade_delay <span class="op">=</span> new_delay<span class="op">;</span></span>
<span id="cb114-189"><a href="#cb114-189" aria-hidden="true" tabindex="-1"></a>            <span class="cn">Ok</span>(())</span>
<span id="cb114-190"><a href="#cb114-190" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb114-191"><a href="#cb114-191" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb114-192"><a href="#cb114-192" aria-hidden="true" tabindex="-1"></a>        <span class="at">#[</span>ink<span class="at">(</span>message<span class="at">)]</span></span>
<span id="cb114-193"><a href="#cb114-193" aria-hidden="true" tabindex="-1"></a>        <span class="kw">pub</span> <span class="kw">fn</span> emergency_pause(<span class="op">&amp;</span><span class="kw">mut</span> <span class="kw">self</span>) <span class="op">-&gt;</span> <span class="dt">Result</span><span class="op">&lt;</span>()<span class="op">,</span> <span class="bu">Error</span><span class="op">&gt;</span> <span class="op">{</span></span>
<span id="cb114-194"><a href="#cb114-194" aria-hidden="true" tabindex="-1"></a>            <span class="kw">self</span><span class="op">.</span>ensure_admin()<span class="op">?;</span></span>
<span id="cb114-195"><a href="#cb114-195" aria-hidden="true" tabindex="-1"></a>            <span class="kw">self</span><span class="op">.</span>emergency_pause <span class="op">=</span> <span class="cn">true</span><span class="op">;</span></span>
<span id="cb114-196"><a href="#cb114-196" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb114-197"><a href="#cb114-197" aria-hidden="true" tabindex="-1"></a>            <span class="kw">self</span><span class="op">.</span>env()<span class="op">.</span>emit_event(EmergencyPaused <span class="op">{</span></span>
<span id="cb114-198"><a href="#cb114-198" aria-hidden="true" tabindex="-1"></a>                timestamp<span class="op">:</span> <span class="kw">self</span><span class="op">.</span>env()<span class="op">.</span>block_timestamp()<span class="op">,</span></span>
<span id="cb114-199"><a href="#cb114-199" aria-hidden="true" tabindex="-1"></a>            <span class="op">}</span>)<span class="op">;</span></span>
<span id="cb114-200"><a href="#cb114-200" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb114-201"><a href="#cb114-201" aria-hidden="true" tabindex="-1"></a>            <span class="cn">Ok</span>(())</span>
<span id="cb114-202"><a href="#cb114-202" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb114-203"><a href="#cb114-203" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb114-204"><a href="#cb114-204" aria-hidden="true" tabindex="-1"></a>        <span class="at">#[</span>ink<span class="at">(</span>message<span class="at">)]</span></span>
<span id="cb114-205"><a href="#cb114-205" aria-hidden="true" tabindex="-1"></a>        <span class="kw">pub</span> <span class="kw">fn</span> emergency_unpause(<span class="op">&amp;</span><span class="kw">mut</span> <span class="kw">self</span>) <span class="op">-&gt;</span> <span class="dt">Result</span><span class="op">&lt;</span>()<span class="op">,</span> <span class="bu">Error</span><span class="op">&gt;</span> <span class="op">{</span></span>
<span id="cb114-206"><a href="#cb114-206" aria-hidden="true" tabindex="-1"></a>            <span class="kw">self</span><span class="op">.</span>ensure_admin()<span class="op">?;</span></span>
<span id="cb114-207"><a href="#cb114-207" aria-hidden="true" tabindex="-1"></a>            <span class="kw">self</span><span class="op">.</span>emergency_pause <span class="op">=</span> <span class="cn">false</span><span class="op">;</span></span>
<span id="cb114-208"><a href="#cb114-208" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb114-209"><a href="#cb114-209" aria-hidden="true" tabindex="-1"></a>            <span class="kw">self</span><span class="op">.</span>env()<span class="op">.</span>emit_event(EmergencyUnpaused <span class="op">{</span></span>
<span id="cb114-210"><a href="#cb114-210" aria-hidden="true" tabindex="-1"></a>                timestamp<span class="op">:</span> <span class="kw">self</span><span class="op">.</span>env()<span class="op">.</span>block_timestamp()<span class="op">,</span></span>
<span id="cb114-211"><a href="#cb114-211" aria-hidden="true" tabindex="-1"></a>            <span class="op">}</span>)<span class="op">;</span></span>
<span id="cb114-212"><a href="#cb114-212" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb114-213"><a href="#cb114-213" aria-hidden="true" tabindex="-1"></a>            <span class="cn">Ok</span>(())</span>
<span id="cb114-214"><a href="#cb114-214" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb114-215"><a href="#cb114-215" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb114-216"><a href="#cb114-216" aria-hidden="true" tabindex="-1"></a>        <span class="co">/// View functions</span></span>
<span id="cb114-217"><a href="#cb114-217" aria-hidden="true" tabindex="-1"></a>        <span class="at">#[</span>ink<span class="at">(</span>message<span class="at">)]</span></span>
<span id="cb114-218"><a href="#cb114-218" aria-hidden="true" tabindex="-1"></a>        <span class="kw">pub</span> <span class="kw">fn</span> get_implementation(<span class="op">&amp;</span><span class="kw">self</span>) <span class="op">-&gt;</span> AccountId <span class="op">{</span></span>
<span id="cb114-219"><a href="#cb114-219" aria-hidden="true" tabindex="-1"></a>            <span class="kw">self</span><span class="op">.</span>implementation</span>
<span id="cb114-220"><a href="#cb114-220" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb114-221"><a href="#cb114-221" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb114-222"><a href="#cb114-222" aria-hidden="true" tabindex="-1"></a>        <span class="at">#[</span>ink<span class="at">(</span>message<span class="at">)]</span></span>
<span id="cb114-223"><a href="#cb114-223" aria-hidden="true" tabindex="-1"></a>        <span class="kw">pub</span> <span class="kw">fn</span> get_admin(<span class="op">&amp;</span><span class="kw">self</span>) <span class="op">-&gt;</span> AccountId <span class="op">{</span></span>
<span id="cb114-224"><a href="#cb114-224" aria-hidden="true" tabindex="-1"></a>            <span class="kw">self</span><span class="op">.</span>admin</span>
<span id="cb114-225"><a href="#cb114-225" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb114-226"><a href="#cb114-226" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb114-227"><a href="#cb114-227" aria-hidden="true" tabindex="-1"></a>        <span class="at">#[</span>ink<span class="at">(</span>message<span class="at">)]</span></span>
<span id="cb114-228"><a href="#cb114-228" aria-hidden="true" tabindex="-1"></a>        <span class="kw">pub</span> <span class="kw">fn</span> get_version(<span class="op">&amp;</span><span class="kw">self</span>) <span class="op">-&gt;</span> <span class="dt">u32</span> <span class="op">{</span></span>
<span id="cb114-229"><a href="#cb114-229" aria-hidden="true" tabindex="-1"></a>            <span class="kw">self</span><span class="op">.</span>version</span>
<span id="cb114-230"><a href="#cb114-230" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb114-231"><a href="#cb114-231" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb114-232"><a href="#cb114-232" aria-hidden="true" tabindex="-1"></a>        <span class="at">#[</span>ink<span class="at">(</span>message<span class="at">)]</span></span>
<span id="cb114-233"><a href="#cb114-233" aria-hidden="true" tabindex="-1"></a>        <span class="kw">pub</span> <span class="kw">fn</span> get_upgrade_history(<span class="op">&amp;</span><span class="kw">self</span>) <span class="op">-&gt;</span> <span class="dt">Vec</span><span class="op">&lt;</span>UpgradeRecord<span class="op">&gt;</span> <span class="op">{</span></span>
<span id="cb114-234"><a href="#cb114-234" aria-hidden="true" tabindex="-1"></a>            <span class="kw">self</span><span class="op">.</span>upgrade_history<span class="op">.</span>clone()</span>
<span id="cb114-235"><a href="#cb114-235" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb114-236"><a href="#cb114-236" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb114-237"><a href="#cb114-237" aria-hidden="true" tabindex="-1"></a>        <span class="co">/// Helper functions</span></span>
<span id="cb114-238"><a href="#cb114-238" aria-hidden="true" tabindex="-1"></a>        <span class="kw">fn</span> ensure_admin(<span class="op">&amp;</span><span class="kw">self</span>) <span class="op">-&gt;</span> <span class="dt">Result</span><span class="op">&lt;</span>()<span class="op">,</span> <span class="bu">Error</span><span class="op">&gt;</span> <span class="op">{</span></span>
<span id="cb114-239"><a href="#cb114-239" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> <span class="kw">self</span><span class="op">.</span>env()<span class="op">.</span>caller() <span class="op">!=</span> <span class="kw">self</span><span class="op">.</span>admin <span class="op">{</span></span>
<span id="cb114-240"><a href="#cb114-240" aria-hidden="true" tabindex="-1"></a>                <span class="cn">Err</span>(<span class="bu">Error</span><span class="pp">::</span>Unauthorized)</span>
<span id="cb114-241"><a href="#cb114-241" aria-hidden="true" tabindex="-1"></a>            <span class="op">}</span> <span class="cf">else</span> <span class="op">{</span></span>
<span id="cb114-242"><a href="#cb114-242" aria-hidden="true" tabindex="-1"></a>                <span class="cn">Ok</span>(())</span>
<span id="cb114-243"><a href="#cb114-243" aria-hidden="true" tabindex="-1"></a>            <span class="op">}</span></span>
<span id="cb114-244"><a href="#cb114-244" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb114-245"><a href="#cb114-245" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb114-246"><a href="#cb114-246" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb114-247"><a href="#cb114-247" aria-hidden="true" tabindex="-1"></a>    <span class="co">/// Events for upgrade tracking</span></span>
<span id="cb114-248"><a href="#cb114-248" aria-hidden="true" tabindex="-1"></a>    <span class="at">#[</span>ink<span class="at">(</span>event<span class="at">)]</span></span>
<span id="cb114-249"><a href="#cb114-249" aria-hidden="true" tabindex="-1"></a>    <span class="kw">pub</span> <span class="kw">struct</span> UpgradeProposed <span class="op">{</span></span>
<span id="cb114-250"><a href="#cb114-250" aria-hidden="true" tabindex="-1"></a>        <span class="at">#[</span>ink<span class="at">(</span>topic<span class="at">)]</span></span>
<span id="cb114-251"><a href="#cb114-251" aria-hidden="true" tabindex="-1"></a>        old_implementation<span class="op">:</span> AccountId<span class="op">,</span></span>
<span id="cb114-252"><a href="#cb114-252" aria-hidden="true" tabindex="-1"></a>        <span class="at">#[</span>ink<span class="at">(</span>topic<span class="at">)]</span></span>
<span id="cb114-253"><a href="#cb114-253" aria-hidden="true" tabindex="-1"></a>        new_implementation<span class="op">:</span> AccountId<span class="op">,</span></span>
<span id="cb114-254"><a href="#cb114-254" aria-hidden="true" tabindex="-1"></a>        new_version<span class="op">:</span> <span class="dt">u32</span><span class="op">,</span></span>
<span id="cb114-255"><a href="#cb114-255" aria-hidden="true" tabindex="-1"></a>        timestamp<span class="op">:</span> <span class="dt">u64</span><span class="op">,</span></span>
<span id="cb114-256"><a href="#cb114-256" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb114-257"><a href="#cb114-257" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb114-258"><a href="#cb114-258" aria-hidden="true" tabindex="-1"></a>    <span class="at">#[</span>ink<span class="at">(</span>event<span class="at">)]</span></span>
<span id="cb114-259"><a href="#cb114-259" aria-hidden="true" tabindex="-1"></a>    <span class="kw">pub</span> <span class="kw">struct</span> EmergencyUpgrade <span class="op">{</span></span>
<span id="cb114-260"><a href="#cb114-260" aria-hidden="true" tabindex="-1"></a>        <span class="at">#[</span>ink<span class="at">(</span>topic<span class="at">)]</span></span>
<span id="cb114-261"><a href="#cb114-261" aria-hidden="true" tabindex="-1"></a>        old_implementation<span class="op">:</span> AccountId<span class="op">,</span></span>
<span id="cb114-262"><a href="#cb114-262" aria-hidden="true" tabindex="-1"></a>        <span class="at">#[</span>ink<span class="at">(</span>topic<span class="at">)]</span></span>
<span id="cb114-263"><a href="#cb114-263" aria-hidden="true" tabindex="-1"></a>        new_implementation<span class="op">:</span> AccountId<span class="op">,</span></span>
<span id="cb114-264"><a href="#cb114-264" aria-hidden="true" tabindex="-1"></a>        new_version<span class="op">:</span> <span class="dt">u32</span><span class="op">,</span></span>
<span id="cb114-265"><a href="#cb114-265" aria-hidden="true" tabindex="-1"></a>        timestamp<span class="op">:</span> <span class="dt">u64</span><span class="op">,</span></span>
<span id="cb114-266"><a href="#cb114-266" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb114-267"><a href="#cb114-267" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb114-268"><a href="#cb114-268" aria-hidden="true" tabindex="-1"></a>    <span class="at">#[</span>ink<span class="at">(</span>event<span class="at">)]</span></span>
<span id="cb114-269"><a href="#cb114-269" aria-hidden="true" tabindex="-1"></a>    <span class="kw">pub</span> <span class="kw">struct</span> AdminTransferred <span class="op">{</span></span>
<span id="cb114-270"><a href="#cb114-270" aria-hidden="true" tabindex="-1"></a>        <span class="at">#[</span>ink<span class="at">(</span>topic<span class="at">)]</span></span>
<span id="cb114-271"><a href="#cb114-271" aria-hidden="true" tabindex="-1"></a>        old_admin<span class="op">:</span> AccountId<span class="op">,</span></span>
<span id="cb114-272"><a href="#cb114-272" aria-hidden="true" tabindex="-1"></a>        <span class="at">#[</span>ink<span class="at">(</span>topic<span class="at">)]</span></span>
<span id="cb114-273"><a href="#cb114-273" aria-hidden="true" tabindex="-1"></a>        new_admin<span class="op">:</span> AccountId<span class="op">,</span></span>
<span id="cb114-274"><a href="#cb114-274" aria-hidden="true" tabindex="-1"></a>        timestamp<span class="op">:</span> <span class="dt">u64</span><span class="op">,</span></span>
<span id="cb114-275"><a href="#cb114-275" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb114-276"><a href="#cb114-276" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<h3 id="data-migration-strategies">Data Migration Strategies</h3>
<div class="sourceCode" id="cb115"><pre
class="sourceCode rust"><code class="sourceCode rust"><span id="cb115-1"><a href="#cb115-1" aria-hidden="true" tabindex="-1"></a><span class="at">#[</span><span class="pp">ink::</span>contract<span class="at">]</span></span>
<span id="cb115-2"><a href="#cb115-2" aria-hidden="true" tabindex="-1"></a><span class="kw">mod</span> migrateable_storage <span class="op">{</span></span>
<span id="cb115-3"><a href="#cb115-3" aria-hidden="true" tabindex="-1"></a>    <span class="at">#[</span>ink<span class="at">(</span>storage<span class="at">)]</span></span>
<span id="cb115-4"><a href="#cb115-4" aria-hidden="true" tabindex="-1"></a>    <span class="kw">pub</span> <span class="kw">struct</span> MigrateableStorage <span class="op">{</span></span>
<span id="cb115-5"><a href="#cb115-5" aria-hidden="true" tabindex="-1"></a>        <span class="co">/// Version of the storage layout</span></span>
<span id="cb115-6"><a href="#cb115-6" aria-hidden="true" tabindex="-1"></a>        storage_version<span class="op">:</span> <span class="dt">u32</span><span class="op">,</span></span>
<span id="cb115-7"><a href="#cb115-7" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb115-8"><a href="#cb115-8" aria-hidden="true" tabindex="-1"></a>        <span class="co">/// Data that might need migration</span></span>
<span id="cb115-9"><a href="#cb115-9" aria-hidden="true" tabindex="-1"></a>        user_data<span class="op">:</span> <span class="pp">ink::storage::</span>Mapping<span class="op">&lt;</span>AccountId<span class="op">,</span> UserDataV2<span class="op">&gt;,</span></span>
<span id="cb115-10"><a href="#cb115-10" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb115-11"><a href="#cb115-11" aria-hidden="true" tabindex="-1"></a>        <span class="co">/// Migration state tracking</span></span>
<span id="cb115-12"><a href="#cb115-12" aria-hidden="true" tabindex="-1"></a>        migration_status<span class="op">:</span> MigrationStatus<span class="op">,</span></span>
<span id="cb115-13"><a href="#cb115-13" aria-hidden="true" tabindex="-1"></a>        migration_progress<span class="op">:</span> <span class="dt">u32</span><span class="op">,</span></span>
<span id="cb115-14"><a href="#cb115-14" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb115-15"><a href="#cb115-15" aria-hidden="true" tabindex="-1"></a>        <span class="co">/// Fallback storage for emergency recovery</span></span>
<span id="cb115-16"><a href="#cb115-16" aria-hidden="true" tabindex="-1"></a>        backup_data<span class="op">:</span> <span class="pp">ink::storage::</span>Lazy<span class="op">&lt;</span><span class="dt">Vec</span><span class="op">&lt;</span><span class="dt">u8</span><span class="op">&gt;&gt;,</span></span>
<span id="cb115-17"><a href="#cb115-17" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb115-18"><a href="#cb115-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb115-19"><a href="#cb115-19" aria-hidden="true" tabindex="-1"></a>    <span class="at">#[</span>derive<span class="at">(</span><span class="bu">Debug</span><span class="op">,</span> <span class="bu">Clone</span><span class="op">,</span> <span class="bu">PartialEq</span><span class="op">,</span> <span class="bu">Eq</span><span class="op">,</span> <span class="pp">scale::</span>Encode<span class="op">,</span> <span class="pp">scale::</span>Decode<span class="at">)]</span></span>
<span id="cb115-20"><a href="#cb115-20" aria-hidden="true" tabindex="-1"></a>    <span class="at">#[</span>cfg_attr<span class="at">(</span>feature <span class="op">=</span> <span class="st">&quot;std&quot;</span><span class="op">,</span> derive<span class="at">(</span><span class="pp">scale_info::</span>TypeInfo<span class="at">))]</span></span>
<span id="cb115-21"><a href="#cb115-21" aria-hidden="true" tabindex="-1"></a>    <span class="kw">pub</span> <span class="kw">enum</span> MigrationStatus <span class="op">{</span></span>
<span id="cb115-22"><a href="#cb115-22" aria-hidden="true" tabindex="-1"></a>        NotRequired<span class="op">,</span></span>
<span id="cb115-23"><a href="#cb115-23" aria-hidden="true" tabindex="-1"></a>        Required<span class="op">,</span></span>
<span id="cb115-24"><a href="#cb115-24" aria-hidden="true" tabindex="-1"></a>        InProgress<span class="op">,</span></span>
<span id="cb115-25"><a href="#cb115-25" aria-hidden="true" tabindex="-1"></a>        Completed<span class="op">,</span></span>
<span id="cb115-26"><a href="#cb115-26" aria-hidden="true" tabindex="-1"></a>        Failed<span class="op">,</span></span>
<span id="cb115-27"><a href="#cb115-27" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb115-28"><a href="#cb115-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb115-29"><a href="#cb115-29" aria-hidden="true" tabindex="-1"></a>    <span class="co">/// Version 1 of user data (legacy)</span></span>
<span id="cb115-30"><a href="#cb115-30" aria-hidden="true" tabindex="-1"></a>    <span class="at">#[</span>derive<span class="at">(</span><span class="bu">Debug</span><span class="op">,</span> <span class="bu">Clone</span><span class="op">,</span> <span class="bu">PartialEq</span><span class="op">,</span> <span class="bu">Eq</span><span class="op">,</span> <span class="pp">scale::</span>Encode<span class="op">,</span> <span class="pp">scale::</span>Decode<span class="at">)]</span></span>
<span id="cb115-31"><a href="#cb115-31" aria-hidden="true" tabindex="-1"></a>    <span class="at">#[</span>cfg_attr<span class="at">(</span>feature <span class="op">=</span> <span class="st">&quot;std&quot;</span><span class="op">,</span> derive<span class="at">(</span><span class="pp">scale_info::</span>TypeInfo<span class="at">))]</span></span>
<span id="cb115-32"><a href="#cb115-32" aria-hidden="true" tabindex="-1"></a>    <span class="kw">pub</span> <span class="kw">struct</span> UserDataV1 <span class="op">{</span></span>
<span id="cb115-33"><a href="#cb115-33" aria-hidden="true" tabindex="-1"></a>        <span class="kw">pub</span> balance<span class="op">:</span> Balance<span class="op">,</span></span>
<span id="cb115-34"><a href="#cb115-34" aria-hidden="true" tabindex="-1"></a>        <span class="kw">pub</span> last_activity<span class="op">:</span> <span class="dt">u64</span><span class="op">,</span></span>
<span id="cb115-35"><a href="#cb115-35" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb115-36"><a href="#cb115-36" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb115-37"><a href="#cb115-37" aria-hidden="true" tabindex="-1"></a>    <span class="co">/// Version 2 of user data (current)</span></span>
<span id="cb115-38"><a href="#cb115-38" aria-hidden="true" tabindex="-1"></a>    <span class="at">#[</span>derive<span class="at">(</span><span class="bu">Debug</span><span class="op">,</span> <span class="bu">Clone</span><span class="op">,</span> <span class="bu">PartialEq</span><span class="op">,</span> <span class="bu">Eq</span><span class="op">,</span> <span class="pp">scale::</span>Encode<span class="op">,</span> <span class="pp">scale::</span>Decode<span class="at">)]</span></span>
<span id="cb115-39"><a href="#cb115-39" aria-hidden="true" tabindex="-1"></a>    <span class="at">#[</span>cfg_attr<span class="at">(</span>feature <span class="op">=</span> <span class="st">&quot;std&quot;</span><span class="op">,</span> derive<span class="at">(</span><span class="pp">scale_info::</span>TypeInfo<span class="at">))]</span></span>
<span id="cb115-40"><a href="#cb115-40" aria-hidden="true" tabindex="-1"></a>    <span class="kw">pub</span> <span class="kw">struct</span> UserDataV2 <span class="op">{</span></span>
<span id="cb115-41"><a href="#cb115-41" aria-hidden="true" tabindex="-1"></a>        <span class="kw">pub</span> balance<span class="op">:</span> Balance<span class="op">,</span></span>
<span id="cb115-42"><a href="#cb115-42" aria-hidden="true" tabindex="-1"></a>        <span class="kw">pub</span> last_activity<span class="op">:</span> <span class="dt">u64</span><span class="op">,</span></span>
<span id="cb115-43"><a href="#cb115-43" aria-hidden="true" tabindex="-1"></a>        <span class="kw">pub</span> verification_level<span class="op">:</span> <span class="dt">u8</span><span class="op">,</span></span>
<span id="cb115-44"><a href="#cb115-44" aria-hidden="true" tabindex="-1"></a>        <span class="kw">pub</span> metadata<span class="op">:</span> <span class="dt">Vec</span><span class="op">&lt;</span><span class="dt">u8</span><span class="op">&gt;,</span></span>
<span id="cb115-45"><a href="#cb115-45" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb115-46"><a href="#cb115-46" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb115-47"><a href="#cb115-47" aria-hidden="true" tabindex="-1"></a>    <span class="kw">impl</span> MigrateableStorage <span class="op">{</span></span>
<span id="cb115-48"><a href="#cb115-48" aria-hidden="true" tabindex="-1"></a>        <span class="at">#[</span>ink<span class="at">(</span>constructor<span class="at">)]</span></span>
<span id="cb115-49"><a href="#cb115-49" aria-hidden="true" tabindex="-1"></a>        <span class="kw">pub</span> <span class="kw">fn</span> new() <span class="op">-&gt;</span> <span class="dt">Self</span> <span class="op">{</span></span>
<span id="cb115-50"><a href="#cb115-50" aria-hidden="true" tabindex="-1"></a>            <span class="dt">Self</span> <span class="op">{</span></span>
<span id="cb115-51"><a href="#cb115-51" aria-hidden="true" tabindex="-1"></a>                storage_version<span class="op">:</span> <span class="dv">2</span><span class="op">,</span> <span class="co">// Current version</span></span>
<span id="cb115-52"><a href="#cb115-52" aria-hidden="true" tabindex="-1"></a>                user_data<span class="op">:</span> <span class="pp">ink::storage::Mapping::</span><span class="kw">default</span>()<span class="op">,</span></span>
<span id="cb115-53"><a href="#cb115-53" aria-hidden="true" tabindex="-1"></a>                migration_status<span class="op">:</span> <span class="pp">MigrationStatus::</span>NotRequired<span class="op">,</span></span>
<span id="cb115-54"><a href="#cb115-54" aria-hidden="true" tabindex="-1"></a>                migration_progress<span class="op">:</span> <span class="dv">0</span><span class="op">,</span></span>
<span id="cb115-55"><a href="#cb115-55" aria-hidden="true" tabindex="-1"></a>                backup_data<span class="op">:</span> <span class="pp">ink::storage::Lazy::</span>new()<span class="op">,</span></span>
<span id="cb115-56"><a href="#cb115-56" aria-hidden="true" tabindex="-1"></a>            <span class="op">}</span></span>
<span id="cb115-57"><a href="#cb115-57" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb115-58"><a href="#cb115-58" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb115-59"><a href="#cb115-59" aria-hidden="true" tabindex="-1"></a>        <span class="co">/// Check if migration is needed</span></span>
<span id="cb115-60"><a href="#cb115-60" aria-hidden="true" tabindex="-1"></a>        <span class="at">#[</span>ink<span class="at">(</span>message<span class="at">)]</span></span>
<span id="cb115-61"><a href="#cb115-61" aria-hidden="true" tabindex="-1"></a>        <span class="kw">pub</span> <span class="kw">fn</span> check_migration_needed(<span class="op">&amp;</span><span class="kw">mut</span> <span class="kw">self</span>) <span class="op">-&gt;</span> MigrationStatus <span class="op">{</span></span>
<span id="cb115-62"><a href="#cb115-62" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> <span class="kw">self</span><span class="op">.</span>storage_version <span class="op">&lt;</span> <span class="dv">2</span> <span class="op">{</span></span>
<span id="cb115-63"><a href="#cb115-63" aria-hidden="true" tabindex="-1"></a>                <span class="kw">self</span><span class="op">.</span>migration_status <span class="op">=</span> <span class="pp">MigrationStatus::</span>Required<span class="op">;</span></span>
<span id="cb115-64"><a href="#cb115-64" aria-hidden="true" tabindex="-1"></a>            <span class="op">}</span></span>
<span id="cb115-65"><a href="#cb115-65" aria-hidden="true" tabindex="-1"></a>            <span class="kw">self</span><span class="op">.</span>migration_status<span class="op">.</span>clone()</span>
<span id="cb115-66"><a href="#cb115-66" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb115-67"><a href="#cb115-67" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb115-68"><a href="#cb115-68" aria-hidden="true" tabindex="-1"></a>        <span class="co">/// Start data migration process</span></span>
<span id="cb115-69"><a href="#cb115-69" aria-hidden="true" tabindex="-1"></a>        <span class="at">#[</span>ink<span class="at">(</span>message<span class="at">)]</span></span>
<span id="cb115-70"><a href="#cb115-70" aria-hidden="true" tabindex="-1"></a>        <span class="kw">pub</span> <span class="kw">fn</span> start_migration(<span class="op">&amp;</span><span class="kw">mut</span> <span class="kw">self</span>) <span class="op">-&gt;</span> <span class="dt">Result</span><span class="op">&lt;</span>()<span class="op">,</span> <span class="bu">Error</span><span class="op">&gt;</span> <span class="op">{</span></span>
<span id="cb115-71"><a href="#cb115-71" aria-hidden="true" tabindex="-1"></a>            <span class="co">// Only admin can start migration</span></span>
<span id="cb115-72"><a href="#cb115-72" aria-hidden="true" tabindex="-1"></a>            <span class="kw">self</span><span class="op">.</span>ensure_admin()<span class="op">?;</span></span>
<span id="cb115-73"><a href="#cb115-73" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb115-74"><a href="#cb115-74" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> <span class="kw">self</span><span class="op">.</span>migration_status <span class="op">!=</span> <span class="pp">MigrationStatus::</span>Required <span class="op">{</span></span>
<span id="cb115-75"><a href="#cb115-75" aria-hidden="true" tabindex="-1"></a>                <span class="cf">return</span> <span class="cn">Err</span>(<span class="bu">Error</span><span class="pp">::</span>MigrationNotNeeded)<span class="op">;</span></span>
<span id="cb115-76"><a href="#cb115-76" aria-hidden="true" tabindex="-1"></a>            <span class="op">}</span></span>
<span id="cb115-77"><a href="#cb115-77" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb115-78"><a href="#cb115-78" aria-hidden="true" tabindex="-1"></a>            <span class="co">// Create backup before migration</span></span>
<span id="cb115-79"><a href="#cb115-79" aria-hidden="true" tabindex="-1"></a>            <span class="kw">self</span><span class="op">.</span>create_backup()<span class="op">?;</span></span>
<span id="cb115-80"><a href="#cb115-80" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb115-81"><a href="#cb115-81" aria-hidden="true" tabindex="-1"></a>            <span class="kw">self</span><span class="op">.</span>migration_status <span class="op">=</span> <span class="pp">MigrationStatus::</span>InProgress<span class="op">;</span></span>
<span id="cb115-82"><a href="#cb115-82" aria-hidden="true" tabindex="-1"></a>            <span class="kw">self</span><span class="op">.</span>migration_progress <span class="op">=</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb115-83"><a href="#cb115-83" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb115-84"><a href="#cb115-84" aria-hidden="true" tabindex="-1"></a>            <span class="kw">self</span><span class="op">.</span>env()<span class="op">.</span>emit_event(MigrationStarted <span class="op">{</span></span>
<span id="cb115-85"><a href="#cb115-85" aria-hidden="true" tabindex="-1"></a>                from_version<span class="op">:</span> <span class="kw">self</span><span class="op">.</span>storage_version<span class="op">,</span></span>
<span id="cb115-86"><a href="#cb115-86" aria-hidden="true" tabindex="-1"></a>                to_version<span class="op">:</span> <span class="dv">2</span><span class="op">,</span></span>
<span id="cb115-87"><a href="#cb115-87" aria-hidden="true" tabindex="-1"></a>                timestamp<span class="op">:</span> <span class="kw">self</span><span class="op">.</span>env()<span class="op">.</span>block_timestamp()<span class="op">,</span></span>
<span id="cb115-88"><a href="#cb115-88" aria-hidden="true" tabindex="-1"></a>            <span class="op">}</span>)<span class="op">;</span></span>
<span id="cb115-89"><a href="#cb115-89" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb115-90"><a href="#cb115-90" aria-hidden="true" tabindex="-1"></a>            <span class="cn">Ok</span>(())</span>
<span id="cb115-91"><a href="#cb115-91" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb115-92"><a href="#cb115-92" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb115-93"><a href="#cb115-93" aria-hidden="true" tabindex="-1"></a>        <span class="co">/// Migrate user data in batches</span></span>
<span id="cb115-94"><a href="#cb115-94" aria-hidden="true" tabindex="-1"></a>        <span class="at">#[</span>ink<span class="at">(</span>message<span class="at">)]</span></span>
<span id="cb115-95"><a href="#cb115-95" aria-hidden="true" tabindex="-1"></a>        <span class="kw">pub</span> <span class="kw">fn</span> migrate_batch(<span class="op">&amp;</span><span class="kw">mut</span> <span class="kw">self</span><span class="op">,</span> user_accounts<span class="op">:</span> <span class="dt">Vec</span><span class="op">&lt;</span>AccountId<span class="op">&gt;</span>) <span class="op">-&gt;</span> <span class="dt">Result</span><span class="op">&lt;</span><span class="dt">u32</span><span class="op">,</span> <span class="bu">Error</span><span class="op">&gt;</span> <span class="op">{</span></span>
<span id="cb115-96"><a href="#cb115-96" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> <span class="kw">self</span><span class="op">.</span>migration_status <span class="op">!=</span> <span class="pp">MigrationStatus::</span>InProgress <span class="op">{</span></span>
<span id="cb115-97"><a href="#cb115-97" aria-hidden="true" tabindex="-1"></a>                <span class="cf">return</span> <span class="cn">Err</span>(<span class="bu">Error</span><span class="pp">::</span>MigrationNotInProgress)<span class="op">;</span></span>
<span id="cb115-98"><a href="#cb115-98" aria-hidden="true" tabindex="-1"></a>            <span class="op">}</span></span>
<span id="cb115-99"><a href="#cb115-99" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb115-100"><a href="#cb115-100" aria-hidden="true" tabindex="-1"></a>            <span class="kw">let</span> <span class="kw">mut</span> migrated_count <span class="op">=</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb115-101"><a href="#cb115-101" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb115-102"><a href="#cb115-102" aria-hidden="true" tabindex="-1"></a>            <span class="cf">for</span> account <span class="kw">in</span> user_accounts<span class="op">.</span>iter()<span class="op">.</span>take(<span class="dv">50</span>) <span class="op">{</span> <span class="co">// Limit batch size</span></span>
<span id="cb115-103"><a href="#cb115-103" aria-hidden="true" tabindex="-1"></a>                <span class="cf">if</span> <span class="kw">let</span> <span class="cn">Some</span>(old_data) <span class="op">=</span> <span class="kw">self</span><span class="op">.</span>get_legacy_user_data(<span class="op">*</span>account) <span class="op">{</span></span>
<span id="cb115-104"><a href="#cb115-104" aria-hidden="true" tabindex="-1"></a>                    <span class="kw">let</span> new_data <span class="op">=</span> <span class="kw">self</span><span class="op">.</span>migrate_user_data_v1_to_v2(old_data)<span class="op">;</span></span>
<span id="cb115-105"><a href="#cb115-105" aria-hidden="true" tabindex="-1"></a>                    <span class="kw">self</span><span class="op">.</span>user_data<span class="op">.</span>insert(<span class="op">*</span>account<span class="op">,</span> <span class="op">&amp;</span>new_data)<span class="op">;</span></span>
<span id="cb115-106"><a href="#cb115-106" aria-hidden="true" tabindex="-1"></a>                    migrated_count <span class="op">+=</span> <span class="dv">1</span><span class="op">;</span></span>
<span id="cb115-107"><a href="#cb115-107" aria-hidden="true" tabindex="-1"></a>                <span class="op">}</span></span>
<span id="cb115-108"><a href="#cb115-108" aria-hidden="true" tabindex="-1"></a>            <span class="op">}</span></span>
<span id="cb115-109"><a href="#cb115-109" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb115-110"><a href="#cb115-110" aria-hidden="true" tabindex="-1"></a>            <span class="kw">self</span><span class="op">.</span>migration_progress <span class="op">+=</span> migrated_count<span class="op">;</span></span>
<span id="cb115-111"><a href="#cb115-111" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb115-112"><a href="#cb115-112" aria-hidden="true" tabindex="-1"></a>            <span class="cn">Ok</span>(migrated_count)</span>
<span id="cb115-113"><a href="#cb115-113" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb115-114"><a href="#cb115-114" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb115-115"><a href="#cb115-115" aria-hidden="true" tabindex="-1"></a>        <span class="co">/// Complete migration</span></span>
<span id="cb115-116"><a href="#cb115-116" aria-hidden="true" tabindex="-1"></a>        <span class="at">#[</span>ink<span class="at">(</span>message<span class="at">)]</span></span>
<span id="cb115-117"><a href="#cb115-117" aria-hidden="true" tabindex="-1"></a>        <span class="kw">pub</span> <span class="kw">fn</span> complete_migration(<span class="op">&amp;</span><span class="kw">mut</span> <span class="kw">self</span>) <span class="op">-&gt;</span> <span class="dt">Result</span><span class="op">&lt;</span>()<span class="op">,</span> <span class="bu">Error</span><span class="op">&gt;</span> <span class="op">{</span></span>
<span id="cb115-118"><a href="#cb115-118" aria-hidden="true" tabindex="-1"></a>            <span class="kw">self</span><span class="op">.</span>ensure_admin()<span class="op">?;</span></span>
<span id="cb115-119"><a href="#cb115-119" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb115-120"><a href="#cb115-120" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> <span class="kw">self</span><span class="op">.</span>migration_status <span class="op">!=</span> <span class="pp">MigrationStatus::</span>InProgress <span class="op">{</span></span>
<span id="cb115-121"><a href="#cb115-121" aria-hidden="true" tabindex="-1"></a>                <span class="cf">return</span> <span class="cn">Err</span>(<span class="bu">Error</span><span class="pp">::</span>MigrationNotInProgress)<span class="op">;</span></span>
<span id="cb115-122"><a href="#cb115-122" aria-hidden="true" tabindex="-1"></a>            <span class="op">}</span></span>
<span id="cb115-123"><a href="#cb115-123" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb115-124"><a href="#cb115-124" aria-hidden="true" tabindex="-1"></a>            <span class="co">// Update storage version</span></span>
<span id="cb115-125"><a href="#cb115-125" aria-hidden="true" tabindex="-1"></a>            <span class="kw">self</span><span class="op">.</span>storage_version <span class="op">=</span> <span class="dv">2</span><span class="op">;</span></span>
<span id="cb115-126"><a href="#cb115-126" aria-hidden="true" tabindex="-1"></a>            <span class="kw">self</span><span class="op">.</span>migration_status <span class="op">=</span> <span class="pp">MigrationStatus::</span>Completed<span class="op">;</span></span>
<span id="cb115-127"><a href="#cb115-127" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb115-128"><a href="#cb115-128" aria-hidden="true" tabindex="-1"></a>            <span class="kw">self</span><span class="op">.</span>env()<span class="op">.</span>emit_event(MigrationCompleted <span class="op">{</span></span>
<span id="cb115-129"><a href="#cb115-129" aria-hidden="true" tabindex="-1"></a>                migrated_records<span class="op">:</span> <span class="kw">self</span><span class="op">.</span>migration_progress<span class="op">,</span></span>
<span id="cb115-130"><a href="#cb115-130" aria-hidden="true" tabindex="-1"></a>                timestamp<span class="op">:</span> <span class="kw">self</span><span class="op">.</span>env()<span class="op">.</span>block_timestamp()<span class="op">,</span></span>
<span id="cb115-131"><a href="#cb115-131" aria-hidden="true" tabindex="-1"></a>            <span class="op">}</span>)<span class="op">;</span></span>
<span id="cb115-132"><a href="#cb115-132" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb115-133"><a href="#cb115-133" aria-hidden="true" tabindex="-1"></a>            <span class="cn">Ok</span>(())</span>
<span id="cb115-134"><a href="#cb115-134" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb115-135"><a href="#cb115-135" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb115-136"><a href="#cb115-136" aria-hidden="true" tabindex="-1"></a>        <span class="co">/// Emergency rollback</span></span>
<span id="cb115-137"><a href="#cb115-137" aria-hidden="true" tabindex="-1"></a>        <span class="at">#[</span>ink<span class="at">(</span>message<span class="at">)]</span></span>
<span id="cb115-138"><a href="#cb115-138" aria-hidden="true" tabindex="-1"></a>        <span class="kw">pub</span> <span class="kw">fn</span> emergency_rollback(<span class="op">&amp;</span><span class="kw">mut</span> <span class="kw">self</span>) <span class="op">-&gt;</span> <span class="dt">Result</span><span class="op">&lt;</span>()<span class="op">,</span> <span class="bu">Error</span><span class="op">&gt;</span> <span class="op">{</span></span>
<span id="cb115-139"><a href="#cb115-139" aria-hidden="true" tabindex="-1"></a>            <span class="kw">self</span><span class="op">.</span>ensure_admin()<span class="op">?;</span></span>
<span id="cb115-140"><a href="#cb115-140" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb115-141"><a href="#cb115-141" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> <span class="kw">self</span><span class="op">.</span>migration_status <span class="op">==</span> <span class="pp">MigrationStatus::</span>Failed <span class="op">{</span></span>
<span id="cb115-142"><a href="#cb115-142" aria-hidden="true" tabindex="-1"></a>                <span class="co">// Restore from backup</span></span>
<span id="cb115-143"><a href="#cb115-143" aria-hidden="true" tabindex="-1"></a>                <span class="cf">if</span> <span class="kw">let</span> <span class="cn">Some</span>(backup) <span class="op">=</span> <span class="kw">self</span><span class="op">.</span>backup_data<span class="op">.</span>get() <span class="op">{</span></span>
<span id="cb115-144"><a href="#cb115-144" aria-hidden="true" tabindex="-1"></a>                    <span class="kw">self</span><span class="op">.</span>restore_from_backup(backup)<span class="op">?;</span></span>
<span id="cb115-145"><a href="#cb115-145" aria-hidden="true" tabindex="-1"></a>                <span class="op">}</span></span>
<span id="cb115-146"><a href="#cb115-146" aria-hidden="true" tabindex="-1"></a>                </span>
<span id="cb115-147"><a href="#cb115-147" aria-hidden="true" tabindex="-1"></a>                <span class="kw">self</span><span class="op">.</span>migration_status <span class="op">=</span> <span class="pp">MigrationStatus::</span>NotRequired<span class="op">;</span></span>
<span id="cb115-148"><a href="#cb115-148" aria-hidden="true" tabindex="-1"></a>            <span class="op">}</span></span>
<span id="cb115-149"><a href="#cb115-149" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb115-150"><a href="#cb115-150" aria-hidden="true" tabindex="-1"></a>            <span class="cn">Ok</span>(())</span>
<span id="cb115-151"><a href="#cb115-151" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb115-152"><a href="#cb115-152" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb115-153"><a href="#cb115-153" aria-hidden="true" tabindex="-1"></a>        <span class="co">/// Helper functions for migration</span></span>
<span id="cb115-154"><a href="#cb115-154" aria-hidden="true" tabindex="-1"></a>        <span class="kw">fn</span> migrate_user_data_v1_to_v2(<span class="op">&amp;</span><span class="kw">self</span><span class="op">,</span> v1_data<span class="op">:</span> UserDataV1) <span class="op">-&gt;</span> UserDataV2 <span class="op">{</span></span>
<span id="cb115-155"><a href="#cb115-155" aria-hidden="true" tabindex="-1"></a>            UserDataV2 <span class="op">{</span></span>
<span id="cb115-156"><a href="#cb115-156" aria-hidden="true" tabindex="-1"></a>                balance<span class="op">:</span> v1_data<span class="op">.</span>balance<span class="op">,</span></span>
<span id="cb115-157"><a href="#cb115-157" aria-hidden="true" tabindex="-1"></a>                last_activity<span class="op">:</span> v1_data<span class="op">.</span>last_activity<span class="op">,</span></span>
<span id="cb115-158"><a href="#cb115-158" aria-hidden="true" tabindex="-1"></a>                verification_level<span class="op">:</span> <span class="dv">0</span><span class="op">,</span> <span class="co">// Default for migrated users</span></span>
<span id="cb115-159"><a href="#cb115-159" aria-hidden="true" tabindex="-1"></a>                metadata<span class="op">:</span> <span class="dt">Vec</span><span class="pp">::</span>new()<span class="op">,</span>  <span class="co">// Empty metadata for migrated users</span></span>
<span id="cb115-160"><a href="#cb115-160" aria-hidden="true" tabindex="-1"></a>            <span class="op">}</span></span>
<span id="cb115-161"><a href="#cb115-161" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb115-162"><a href="#cb115-162" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb115-163"><a href="#cb115-163" aria-hidden="true" tabindex="-1"></a>        <span class="kw">fn</span> get_legacy_user_data(<span class="op">&amp;</span><span class="kw">self</span><span class="op">,</span> _account<span class="op">:</span> AccountId) <span class="op">-&gt;</span> <span class="dt">Option</span><span class="op">&lt;</span>UserDataV1<span class="op">&gt;</span> <span class="op">{</span></span>
<span id="cb115-164"><a href="#cb115-164" aria-hidden="true" tabindex="-1"></a>            <span class="co">// In practice, this would read from legacy storage format</span></span>
<span id="cb115-165"><a href="#cb115-165" aria-hidden="true" tabindex="-1"></a>            <span class="cn">None</span></span>
<span id="cb115-166"><a href="#cb115-166" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb115-167"><a href="#cb115-167" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb115-168"><a href="#cb115-168" aria-hidden="true" tabindex="-1"></a>        <span class="kw">fn</span> create_backup(<span class="op">&amp;</span><span class="kw">mut</span> <span class="kw">self</span>) <span class="op">-&gt;</span> <span class="dt">Result</span><span class="op">&lt;</span>()<span class="op">,</span> <span class="bu">Error</span><span class="op">&gt;</span> <span class="op">{</span></span>
<span id="cb115-169"><a href="#cb115-169" aria-hidden="true" tabindex="-1"></a>            <span class="co">// Create backup of current state</span></span>
<span id="cb115-170"><a href="#cb115-170" aria-hidden="true" tabindex="-1"></a>            <span class="kw">let</span> backup_data <span class="op">=</span> <span class="kw">self</span><span class="op">.</span>serialize_current_state()<span class="op">;</span></span>
<span id="cb115-171"><a href="#cb115-171" aria-hidden="true" tabindex="-1"></a>            <span class="kw">self</span><span class="op">.</span>backup_data<span class="op">.</span>set(<span class="op">&amp;</span>backup_data)<span class="op">;</span></span>
<span id="cb115-172"><a href="#cb115-172" aria-hidden="true" tabindex="-1"></a>            <span class="cn">Ok</span>(())</span>
<span id="cb115-173"><a href="#cb115-173" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb115-174"><a href="#cb115-174" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb115-175"><a href="#cb115-175" aria-hidden="true" tabindex="-1"></a>        <span class="kw">fn</span> serialize_current_state(<span class="op">&amp;</span><span class="kw">self</span>) <span class="op">-&gt;</span> <span class="dt">Vec</span><span class="op">&lt;</span><span class="dt">u8</span><span class="op">&gt;</span> <span class="op">{</span></span>
<span id="cb115-176"><a href="#cb115-176" aria-hidden="true" tabindex="-1"></a>            <span class="co">// Serialize critical state for backup</span></span>
<span id="cb115-177"><a href="#cb115-177" aria-hidden="true" tabindex="-1"></a>            <span class="dt">Vec</span><span class="pp">::</span>new() <span class="co">// Placeholder</span></span>
<span id="cb115-178"><a href="#cb115-178" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb115-179"><a href="#cb115-179" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb115-180"><a href="#cb115-180" aria-hidden="true" tabindex="-1"></a>        <span class="kw">fn</span> restore_from_backup(<span class="op">&amp;</span><span class="kw">mut</span> <span class="kw">self</span><span class="op">,</span> _backup<span class="op">:</span> <span class="dt">Vec</span><span class="op">&lt;</span><span class="dt">u8</span><span class="op">&gt;</span>) <span class="op">-&gt;</span> <span class="dt">Result</span><span class="op">&lt;</span>()<span class="op">,</span> <span class="bu">Error</span><span class="op">&gt;</span> <span class="op">{</span></span>
<span id="cb115-181"><a href="#cb115-181" aria-hidden="true" tabindex="-1"></a>            <span class="co">// Restore state from backup</span></span>
<span id="cb115-182"><a href="#cb115-182" aria-hidden="true" tabindex="-1"></a>            <span class="cn">Ok</span>(())</span>
<span id="cb115-183"><a href="#cb115-183" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb115-184"><a href="#cb115-184" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb115-185"><a href="#cb115-185" aria-hidden="true" tabindex="-1"></a>        <span class="kw">fn</span> ensure_admin(<span class="op">&amp;</span><span class="kw">self</span>) <span class="op">-&gt;</span> <span class="dt">Result</span><span class="op">&lt;</span>()<span class="op">,</span> <span class="bu">Error</span><span class="op">&gt;</span> <span class="op">{</span></span>
<span id="cb115-186"><a href="#cb115-186" aria-hidden="true" tabindex="-1"></a>            <span class="co">// Admin check implementation</span></span>
<span id="cb115-187"><a href="#cb115-187" aria-hidden="true" tabindex="-1"></a>            <span class="cn">Ok</span>(())</span>
<span id="cb115-188"><a href="#cb115-188" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb115-189"><a href="#cb115-189" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb115-190"><a href="#cb115-190" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<h2 id="summary-5">Summary</h2>
<p>In this chapter, we’ve explored advanced patterns that elevate ink!
contracts to production quality:</p>
<p><strong>Comprehensive Error Handling:</strong> 1. <strong>Structured
Error Types</strong>: Clear, categorized errors with user-friendly
messages 2. <strong>Error Context</strong>: Adding debugging information
and propagation strategies 3. <strong>Recovery Mechanisms</strong>:
Emergency controls and graceful degradation patterns</p>
<p><strong>Trait-Based Architecture:</strong> 4. <strong>Standard
Interfaces</strong>: Defining reusable contract interfaces with traits
5. <strong>Modular Implementation</strong>: Composing complex contracts
from trait implementations 6. <strong>Extensible Patterns</strong>: Hook
systems for pluggable functionality</p>
<p><strong>Standard Library Usage:</strong> 7. <strong>Collections in
no_std</strong>: Effective use of Vec, BTreeMap, and BTreeSet 8.
<strong>String Handling</strong>: Text processing in constrained
environments 9. <strong>Iterator Patterns</strong>: Efficient data
processing techniques</p>
<p><strong>Contract Upgradability:</strong> 10. <strong>Proxy
Patterns</strong>: Safe contract upgrades with timelock and emergency
controls 11. <strong>Data Migration</strong>: Strategies for evolving
storage layouts 12. <strong>Version Management</strong>: Tracking and
auditing contract upgrades</p>
<p><strong>Key Principles:</strong> - <strong>Safety First</strong>:
Multiple layers of validation and protection -
<strong>Modularity</strong>: Composable components that can be tested
independently - <strong>Auditability</strong>: Clear upgrade paths and
historical tracking - <strong>Graceful Degradation</strong>: Systems
that continue operating under adverse conditions</p>
<p>These advanced patterns provide the foundation for building
enterprise-grade smart contracts that can evolve, scale, and operate
reliably in production environments. In the next chapter, we’ll explore
comprehensive testing strategies to ensure these sophisticated contracts
work correctly under all conditions.</p>
<hr />
<h1
id="chapter-7-bulletproof-your-logic-comprehensive-contract-testing">Chapter
7: Bulletproof Your Logic: Comprehensive Contract Testing</h1>
<p>Testing is what separates experimental code from production-ready
smart contracts. Unlike traditional software, smart contract bugs can
result in permanent loss of funds, making comprehensive testing not just
best practice—it’s essential for survival. ink! provides a sophisticated
testing framework that supports everything from isolated unit tests to
full end-to-end integration testing.</p>
<p>In this chapter, we’ll explore the complete testing ecosystem: unit
testing for logic validation, integration testing for contract
interactions, property-based testing for edge case discovery, and
security testing for vulnerability detection. We’ll also cover testing
patterns specific to blockchain development, including gas testing,
state transition validation, and cross-contract interaction testing.</p>
<h2 id="the-testing-pyramid-for-smart-contracts">The Testing Pyramid for
Smart Contracts</h2>
<p>Smart contract testing follows a modified testing pyramid that
accounts for blockchain-specific concerns:</p>
<pre><code>           /\
          /  \
         / E2E\     ← End-to-End Tests (Expensive, Real blockchain)
        / Tests\
       /________\
      /          \
     /Integration \ ← Integration Tests (Medium cost, Simulated environment)
    /   Tests      \
   /________________\
  /                  \
 /   Unit Tests       \ ← Unit Tests (Fast, Isolated logic)
/______________________\</code></pre>
<h3 id="testing-strategy-overview">Testing Strategy Overview</h3>
<p><strong>Unit Tests (70% of test suite):</strong> - Test individual
functions in isolation - Mock external dependencies - Fast execution,
high coverage - Focus on business logic and edge cases</p>
<p><strong>Integration Tests (20% of test suite):</strong> - Test
contract interactions - Cross-contract calls - Event emission validation
- State transition testing</p>
<p><strong>End-to-End Tests (10% of test suite):</strong> - Full
deployment and interaction cycle - Real blockchain environment testing -
Gas consumption validation - User journey testing</p>
<h2 id="unit-testing-the-foundation">Unit Testing: The Foundation</h2>
<p>Unit tests form the foundation of your testing strategy. They’re
fast, deterministic, and enable rapid development cycles.</p>
<h3 id="basic-unit-test-structure">Basic Unit Test Structure</h3>
<div class="sourceCode" id="cb117"><pre
class="sourceCode rust"><code class="sourceCode rust"><span id="cb117-1"><a href="#cb117-1" aria-hidden="true" tabindex="-1"></a><span class="at">#[</span><span class="pp">ink::</span>contract<span class="at">]</span></span>
<span id="cb117-2"><a href="#cb117-2" aria-hidden="true" tabindex="-1"></a><span class="kw">mod</span> testable_token <span class="op">{</span></span>
<span id="cb117-3"><a href="#cb117-3" aria-hidden="true" tabindex="-1"></a>    <span class="kw">use</span> <span class="pp">ink::storage::</span>Mapping<span class="op">;</span></span>
<span id="cb117-4"><a href="#cb117-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb117-5"><a href="#cb117-5" aria-hidden="true" tabindex="-1"></a>    <span class="at">#[</span>ink<span class="at">(</span>storage<span class="at">)]</span></span>
<span id="cb117-6"><a href="#cb117-6" aria-hidden="true" tabindex="-1"></a>    <span class="kw">pub</span> <span class="kw">struct</span> TestableToken <span class="op">{</span></span>
<span id="cb117-7"><a href="#cb117-7" aria-hidden="true" tabindex="-1"></a>        total_supply<span class="op">:</span> Balance<span class="op">,</span></span>
<span id="cb117-8"><a href="#cb117-8" aria-hidden="true" tabindex="-1"></a>        balances<span class="op">:</span> Mapping<span class="op">&lt;</span>AccountId<span class="op">,</span> Balance<span class="op">&gt;,</span></span>
<span id="cb117-9"><a href="#cb117-9" aria-hidden="true" tabindex="-1"></a>        allowances<span class="op">:</span> Mapping<span class="op">&lt;</span>(AccountId<span class="op">,</span> AccountId)<span class="op">,</span> Balance<span class="op">&gt;,</span></span>
<span id="cb117-10"><a href="#cb117-10" aria-hidden="true" tabindex="-1"></a>        owner<span class="op">:</span> AccountId<span class="op">,</span></span>
<span id="cb117-11"><a href="#cb117-11" aria-hidden="true" tabindex="-1"></a>        paused<span class="op">:</span> <span class="dt">bool</span><span class="op">,</span></span>
<span id="cb117-12"><a href="#cb117-12" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb117-13"><a href="#cb117-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb117-14"><a href="#cb117-14" aria-hidden="true" tabindex="-1"></a>    <span class="at">#[</span>derive<span class="at">(</span><span class="bu">Debug</span><span class="op">,</span> <span class="bu">PartialEq</span><span class="op">,</span> <span class="bu">Eq</span><span class="op">,</span> <span class="pp">scale::</span>Encode<span class="op">,</span> <span class="pp">scale::</span>Decode<span class="at">)]</span></span>
<span id="cb117-15"><a href="#cb117-15" aria-hidden="true" tabindex="-1"></a>    <span class="at">#[</span>cfg_attr<span class="at">(</span>feature <span class="op">=</span> <span class="st">&quot;std&quot;</span><span class="op">,</span> derive<span class="at">(</span><span class="pp">scale_info::</span>TypeInfo<span class="at">))]</span></span>
<span id="cb117-16"><a href="#cb117-16" aria-hidden="true" tabindex="-1"></a>    <span class="kw">pub</span> <span class="kw">enum</span> <span class="bu">Error</span> <span class="op">{</span></span>
<span id="cb117-17"><a href="#cb117-17" aria-hidden="true" tabindex="-1"></a>        InsufficientBalance<span class="op">,</span></span>
<span id="cb117-18"><a href="#cb117-18" aria-hidden="true" tabindex="-1"></a>        InsufficientAllowance<span class="op">,</span></span>
<span id="cb117-19"><a href="#cb117-19" aria-hidden="true" tabindex="-1"></a>        Unauthorized<span class="op">,</span></span>
<span id="cb117-20"><a href="#cb117-20" aria-hidden="true" tabindex="-1"></a>        ContractPaused<span class="op">,</span></span>
<span id="cb117-21"><a href="#cb117-21" aria-hidden="true" tabindex="-1"></a>        InvalidAmount<span class="op">,</span></span>
<span id="cb117-22"><a href="#cb117-22" aria-hidden="true" tabindex="-1"></a>        SelfTransfer<span class="op">,</span></span>
<span id="cb117-23"><a href="#cb117-23" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb117-24"><a href="#cb117-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb117-25"><a href="#cb117-25" aria-hidden="true" tabindex="-1"></a>    <span class="kw">impl</span> TestableToken <span class="op">{</span></span>
<span id="cb117-26"><a href="#cb117-26" aria-hidden="true" tabindex="-1"></a>        <span class="at">#[</span>ink<span class="at">(</span>constructor<span class="at">)]</span></span>
<span id="cb117-27"><a href="#cb117-27" aria-hidden="true" tabindex="-1"></a>        <span class="kw">pub</span> <span class="kw">fn</span> new(total_supply<span class="op">:</span> Balance) <span class="op">-&gt;</span> <span class="dt">Self</span> <span class="op">{</span></span>
<span id="cb117-28"><a href="#cb117-28" aria-hidden="true" tabindex="-1"></a>            <span class="kw">let</span> caller <span class="op">=</span> <span class="dt">Self</span><span class="pp">::</span>env()<span class="op">.</span>caller()<span class="op">;</span></span>
<span id="cb117-29"><a href="#cb117-29" aria-hidden="true" tabindex="-1"></a>            <span class="kw">let</span> <span class="kw">mut</span> balances <span class="op">=</span> <span class="pp">Mapping::</span><span class="kw">default</span>()<span class="op">;</span></span>
<span id="cb117-30"><a href="#cb117-30" aria-hidden="true" tabindex="-1"></a>            balances<span class="op">.</span>insert(caller<span class="op">,</span> <span class="op">&amp;</span>total_supply)<span class="op">;</span></span>
<span id="cb117-31"><a href="#cb117-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb117-32"><a href="#cb117-32" aria-hidden="true" tabindex="-1"></a>            <span class="dt">Self</span> <span class="op">{</span></span>
<span id="cb117-33"><a href="#cb117-33" aria-hidden="true" tabindex="-1"></a>                total_supply<span class="op">,</span></span>
<span id="cb117-34"><a href="#cb117-34" aria-hidden="true" tabindex="-1"></a>                balances<span class="op">,</span></span>
<span id="cb117-35"><a href="#cb117-35" aria-hidden="true" tabindex="-1"></a>                allowances<span class="op">:</span> <span class="pp">Mapping::</span><span class="kw">default</span>()<span class="op">,</span></span>
<span id="cb117-36"><a href="#cb117-36" aria-hidden="true" tabindex="-1"></a>                owner<span class="op">:</span> caller<span class="op">,</span></span>
<span id="cb117-37"><a href="#cb117-37" aria-hidden="true" tabindex="-1"></a>                paused<span class="op">:</span> <span class="cn">false</span><span class="op">,</span></span>
<span id="cb117-38"><a href="#cb117-38" aria-hidden="true" tabindex="-1"></a>            <span class="op">}</span></span>
<span id="cb117-39"><a href="#cb117-39" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb117-40"><a href="#cb117-40" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb117-41"><a href="#cb117-41" aria-hidden="true" tabindex="-1"></a>        <span class="at">#[</span>ink<span class="at">(</span>message<span class="at">)]</span></span>
<span id="cb117-42"><a href="#cb117-42" aria-hidden="true" tabindex="-1"></a>        <span class="kw">pub</span> <span class="kw">fn</span> transfer(<span class="op">&amp;</span><span class="kw">mut</span> <span class="kw">self</span><span class="op">,</span> to<span class="op">:</span> AccountId<span class="op">,</span> value<span class="op">:</span> Balance) <span class="op">-&gt;</span> <span class="dt">Result</span><span class="op">&lt;</span>()<span class="op">,</span> <span class="bu">Error</span><span class="op">&gt;</span> <span class="op">{</span></span>
<span id="cb117-43"><a href="#cb117-43" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> <span class="kw">self</span><span class="op">.</span>paused <span class="op">{</span></span>
<span id="cb117-44"><a href="#cb117-44" aria-hidden="true" tabindex="-1"></a>                <span class="cf">return</span> <span class="cn">Err</span>(<span class="bu">Error</span><span class="pp">::</span>ContractPaused)<span class="op">;</span></span>
<span id="cb117-45"><a href="#cb117-45" aria-hidden="true" tabindex="-1"></a>            <span class="op">}</span></span>
<span id="cb117-46"><a href="#cb117-46" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb117-47"><a href="#cb117-47" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> value <span class="op">==</span> <span class="dv">0</span> <span class="op">{</span></span>
<span id="cb117-48"><a href="#cb117-48" aria-hidden="true" tabindex="-1"></a>                <span class="cf">return</span> <span class="cn">Err</span>(<span class="bu">Error</span><span class="pp">::</span>InvalidAmount)<span class="op">;</span></span>
<span id="cb117-49"><a href="#cb117-49" aria-hidden="true" tabindex="-1"></a>            <span class="op">}</span></span>
<span id="cb117-50"><a href="#cb117-50" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb117-51"><a href="#cb117-51" aria-hidden="true" tabindex="-1"></a>            <span class="kw">let</span> from <span class="op">=</span> <span class="kw">self</span><span class="op">.</span>env()<span class="op">.</span>caller()<span class="op">;</span></span>
<span id="cb117-52"><a href="#cb117-52" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> from <span class="op">==</span> to <span class="op">{</span></span>
<span id="cb117-53"><a href="#cb117-53" aria-hidden="true" tabindex="-1"></a>                <span class="cf">return</span> <span class="cn">Err</span>(<span class="bu">Error</span><span class="pp">::</span>SelfTransfer)<span class="op">;</span></span>
<span id="cb117-54"><a href="#cb117-54" aria-hidden="true" tabindex="-1"></a>            <span class="op">}</span></span>
<span id="cb117-55"><a href="#cb117-55" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb117-56"><a href="#cb117-56" aria-hidden="true" tabindex="-1"></a>            <span class="kw">self</span><span class="op">.</span>transfer_from_to(from<span class="op">,</span> to<span class="op">,</span> value)</span>
<span id="cb117-57"><a href="#cb117-57" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb117-58"><a href="#cb117-58" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb117-59"><a href="#cb117-59" aria-hidden="true" tabindex="-1"></a>        <span class="at">#[</span>ink<span class="at">(</span>message<span class="at">)]</span></span>
<span id="cb117-60"><a href="#cb117-60" aria-hidden="true" tabindex="-1"></a>        <span class="kw">pub</span> <span class="kw">fn</span> approve(<span class="op">&amp;</span><span class="kw">mut</span> <span class="kw">self</span><span class="op">,</span> spender<span class="op">:</span> AccountId<span class="op">,</span> value<span class="op">:</span> Balance) <span class="op">-&gt;</span> <span class="dt">Result</span><span class="op">&lt;</span>()<span class="op">,</span> <span class="bu">Error</span><span class="op">&gt;</span> <span class="op">{</span></span>
<span id="cb117-61"><a href="#cb117-61" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> <span class="kw">self</span><span class="op">.</span>paused <span class="op">{</span></span>
<span id="cb117-62"><a href="#cb117-62" aria-hidden="true" tabindex="-1"></a>                <span class="cf">return</span> <span class="cn">Err</span>(<span class="bu">Error</span><span class="pp">::</span>ContractPaused)<span class="op">;</span></span>
<span id="cb117-63"><a href="#cb117-63" aria-hidden="true" tabindex="-1"></a>            <span class="op">}</span></span>
<span id="cb117-64"><a href="#cb117-64" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb117-65"><a href="#cb117-65" aria-hidden="true" tabindex="-1"></a>            <span class="kw">let</span> owner <span class="op">=</span> <span class="kw">self</span><span class="op">.</span>env()<span class="op">.</span>caller()<span class="op">;</span></span>
<span id="cb117-66"><a href="#cb117-66" aria-hidden="true" tabindex="-1"></a>            <span class="kw">self</span><span class="op">.</span>allowances<span class="op">.</span>insert((owner<span class="op">,</span> spender)<span class="op">,</span> <span class="op">&amp;</span>value)<span class="op">;</span></span>
<span id="cb117-67"><a href="#cb117-67" aria-hidden="true" tabindex="-1"></a>            <span class="cn">Ok</span>(())</span>
<span id="cb117-68"><a href="#cb117-68" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb117-69"><a href="#cb117-69" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb117-70"><a href="#cb117-70" aria-hidden="true" tabindex="-1"></a>        <span class="at">#[</span>ink<span class="at">(</span>message<span class="at">)]</span></span>
<span id="cb117-71"><a href="#cb117-71" aria-hidden="true" tabindex="-1"></a>        <span class="kw">pub</span> <span class="kw">fn</span> transfer_from(</span>
<span id="cb117-72"><a href="#cb117-72" aria-hidden="true" tabindex="-1"></a>            <span class="op">&amp;</span><span class="kw">mut</span> <span class="kw">self</span><span class="op">,</span></span>
<span id="cb117-73"><a href="#cb117-73" aria-hidden="true" tabindex="-1"></a>            from<span class="op">:</span> AccountId<span class="op">,</span></span>
<span id="cb117-74"><a href="#cb117-74" aria-hidden="true" tabindex="-1"></a>            to<span class="op">:</span> AccountId<span class="op">,</span></span>
<span id="cb117-75"><a href="#cb117-75" aria-hidden="true" tabindex="-1"></a>            value<span class="op">:</span> Balance<span class="op">,</span></span>
<span id="cb117-76"><a href="#cb117-76" aria-hidden="true" tabindex="-1"></a>        ) <span class="op">-&gt;</span> <span class="dt">Result</span><span class="op">&lt;</span>()<span class="op">,</span> <span class="bu">Error</span><span class="op">&gt;</span> <span class="op">{</span></span>
<span id="cb117-77"><a href="#cb117-77" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> <span class="kw">self</span><span class="op">.</span>paused <span class="op">{</span></span>
<span id="cb117-78"><a href="#cb117-78" aria-hidden="true" tabindex="-1"></a>                <span class="cf">return</span> <span class="cn">Err</span>(<span class="bu">Error</span><span class="pp">::</span>ContractPaused)<span class="op">;</span></span>
<span id="cb117-79"><a href="#cb117-79" aria-hidden="true" tabindex="-1"></a>            <span class="op">}</span></span>
<span id="cb117-80"><a href="#cb117-80" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb117-81"><a href="#cb117-81" aria-hidden="true" tabindex="-1"></a>            <span class="kw">let</span> caller <span class="op">=</span> <span class="kw">self</span><span class="op">.</span>env()<span class="op">.</span>caller()<span class="op">;</span></span>
<span id="cb117-82"><a href="#cb117-82" aria-hidden="true" tabindex="-1"></a>            <span class="kw">let</span> allowance <span class="op">=</span> <span class="kw">self</span><span class="op">.</span>allowances<span class="op">.</span>get((from<span class="op">,</span> caller))<span class="op">.</span>unwrap_or(<span class="dv">0</span>)<span class="op">;</span></span>
<span id="cb117-83"><a href="#cb117-83" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb117-84"><a href="#cb117-84" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> allowance <span class="op">&lt;</span> value <span class="op">{</span></span>
<span id="cb117-85"><a href="#cb117-85" aria-hidden="true" tabindex="-1"></a>                <span class="cf">return</span> <span class="cn">Err</span>(<span class="bu">Error</span><span class="pp">::</span>InsufficientAllowance)<span class="op">;</span></span>
<span id="cb117-86"><a href="#cb117-86" aria-hidden="true" tabindex="-1"></a>            <span class="op">}</span></span>
<span id="cb117-87"><a href="#cb117-87" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb117-88"><a href="#cb117-88" aria-hidden="true" tabindex="-1"></a>            <span class="kw">self</span><span class="op">.</span>allowances<span class="op">.</span>insert((from<span class="op">,</span> caller)<span class="op">,</span> <span class="op">&amp;</span>(allowance <span class="op">-</span> value))<span class="op">;</span></span>
<span id="cb117-89"><a href="#cb117-89" aria-hidden="true" tabindex="-1"></a>            <span class="kw">self</span><span class="op">.</span>transfer_from_to(from<span class="op">,</span> to<span class="op">,</span> value)</span>
<span id="cb117-90"><a href="#cb117-90" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb117-91"><a href="#cb117-91" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb117-92"><a href="#cb117-92" aria-hidden="true" tabindex="-1"></a>        <span class="at">#[</span>ink<span class="at">(</span>message<span class="at">)]</span></span>
<span id="cb117-93"><a href="#cb117-93" aria-hidden="true" tabindex="-1"></a>        <span class="kw">pub</span> <span class="kw">fn</span> balance_of(<span class="op">&amp;</span><span class="kw">self</span><span class="op">,</span> owner<span class="op">:</span> AccountId) <span class="op">-&gt;</span> Balance <span class="op">{</span></span>
<span id="cb117-94"><a href="#cb117-94" aria-hidden="true" tabindex="-1"></a>            <span class="kw">self</span><span class="op">.</span>balances<span class="op">.</span>get(owner)<span class="op">.</span>unwrap_or(<span class="dv">0</span>)</span>
<span id="cb117-95"><a href="#cb117-95" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb117-96"><a href="#cb117-96" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb117-97"><a href="#cb117-97" aria-hidden="true" tabindex="-1"></a>        <span class="at">#[</span>ink<span class="at">(</span>message<span class="at">)]</span></span>
<span id="cb117-98"><a href="#cb117-98" aria-hidden="true" tabindex="-1"></a>        <span class="kw">pub</span> <span class="kw">fn</span> allowance(<span class="op">&amp;</span><span class="kw">self</span><span class="op">,</span> owner<span class="op">:</span> AccountId<span class="op">,</span> spender<span class="op">:</span> AccountId) <span class="op">-&gt;</span> Balance <span class="op">{</span></span>
<span id="cb117-99"><a href="#cb117-99" aria-hidden="true" tabindex="-1"></a>            <span class="kw">self</span><span class="op">.</span>allowances<span class="op">.</span>get((owner<span class="op">,</span> spender))<span class="op">.</span>unwrap_or(<span class="dv">0</span>)</span>
<span id="cb117-100"><a href="#cb117-100" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb117-101"><a href="#cb117-101" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb117-102"><a href="#cb117-102" aria-hidden="true" tabindex="-1"></a>        <span class="at">#[</span>ink<span class="at">(</span>message<span class="at">)]</span></span>
<span id="cb117-103"><a href="#cb117-103" aria-hidden="true" tabindex="-1"></a>        <span class="kw">pub</span> <span class="kw">fn</span> pause(<span class="op">&amp;</span><span class="kw">mut</span> <span class="kw">self</span>) <span class="op">-&gt;</span> <span class="dt">Result</span><span class="op">&lt;</span>()<span class="op">,</span> <span class="bu">Error</span><span class="op">&gt;</span> <span class="op">{</span></span>
<span id="cb117-104"><a href="#cb117-104" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> <span class="kw">self</span><span class="op">.</span>env()<span class="op">.</span>caller() <span class="op">!=</span> <span class="kw">self</span><span class="op">.</span>owner <span class="op">{</span></span>
<span id="cb117-105"><a href="#cb117-105" aria-hidden="true" tabindex="-1"></a>                <span class="cf">return</span> <span class="cn">Err</span>(<span class="bu">Error</span><span class="pp">::</span>Unauthorized)<span class="op">;</span></span>
<span id="cb117-106"><a href="#cb117-106" aria-hidden="true" tabindex="-1"></a>            <span class="op">}</span></span>
<span id="cb117-107"><a href="#cb117-107" aria-hidden="true" tabindex="-1"></a>            <span class="kw">self</span><span class="op">.</span>paused <span class="op">=</span> <span class="cn">true</span><span class="op">;</span></span>
<span id="cb117-108"><a href="#cb117-108" aria-hidden="true" tabindex="-1"></a>            <span class="cn">Ok</span>(())</span>
<span id="cb117-109"><a href="#cb117-109" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb117-110"><a href="#cb117-110" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb117-111"><a href="#cb117-111" aria-hidden="true" tabindex="-1"></a>        <span class="kw">fn</span> transfer_from_to(<span class="op">&amp;</span><span class="kw">mut</span> <span class="kw">self</span><span class="op">,</span> from<span class="op">:</span> AccountId<span class="op">,</span> to<span class="op">:</span> AccountId<span class="op">,</span> value<span class="op">:</span> Balance) <span class="op">-&gt;</span> <span class="dt">Result</span><span class="op">&lt;</span>()<span class="op">,</span> <span class="bu">Error</span><span class="op">&gt;</span> <span class="op">{</span></span>
<span id="cb117-112"><a href="#cb117-112" aria-hidden="true" tabindex="-1"></a>            <span class="kw">let</span> from_balance <span class="op">=</span> <span class="kw">self</span><span class="op">.</span>balance_of(from)<span class="op">;</span></span>
<span id="cb117-113"><a href="#cb117-113" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> from_balance <span class="op">&lt;</span> value <span class="op">{</span></span>
<span id="cb117-114"><a href="#cb117-114" aria-hidden="true" tabindex="-1"></a>                <span class="cf">return</span> <span class="cn">Err</span>(<span class="bu">Error</span><span class="pp">::</span>InsufficientBalance)<span class="op">;</span></span>
<span id="cb117-115"><a href="#cb117-115" aria-hidden="true" tabindex="-1"></a>            <span class="op">}</span></span>
<span id="cb117-116"><a href="#cb117-116" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb117-117"><a href="#cb117-117" aria-hidden="true" tabindex="-1"></a>            <span class="kw">let</span> to_balance <span class="op">=</span> <span class="kw">self</span><span class="op">.</span>balance_of(to)<span class="op">;</span></span>
<span id="cb117-118"><a href="#cb117-118" aria-hidden="true" tabindex="-1"></a>            <span class="kw">self</span><span class="op">.</span>balances<span class="op">.</span>insert(from<span class="op">,</span> <span class="op">&amp;</span>(from_balance <span class="op">-</span> value))<span class="op">;</span></span>
<span id="cb117-119"><a href="#cb117-119" aria-hidden="true" tabindex="-1"></a>            <span class="kw">self</span><span class="op">.</span>balances<span class="op">.</span>insert(to<span class="op">,</span> <span class="op">&amp;</span>(to_balance <span class="op">+</span> value))<span class="op">;</span></span>
<span id="cb117-120"><a href="#cb117-120" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb117-121"><a href="#cb117-121" aria-hidden="true" tabindex="-1"></a>            <span class="cn">Ok</span>(())</span>
<span id="cb117-122"><a href="#cb117-122" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb117-123"><a href="#cb117-123" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb117-124"><a href="#cb117-124" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb117-125"><a href="#cb117-125" aria-hidden="true" tabindex="-1"></a>    <span class="co">/// Comprehensive unit test suite</span></span>
<span id="cb117-126"><a href="#cb117-126" aria-hidden="true" tabindex="-1"></a>    <span class="at">#[</span>cfg<span class="at">(</span>test<span class="at">)]</span></span>
<span id="cb117-127"><a href="#cb117-127" aria-hidden="true" tabindex="-1"></a>    <span class="kw">mod</span> tests <span class="op">{</span></span>
<span id="cb117-128"><a href="#cb117-128" aria-hidden="true" tabindex="-1"></a>        <span class="kw">use</span> <span class="kw">super</span><span class="pp">::</span><span class="op">*;</span></span>
<span id="cb117-129"><a href="#cb117-129" aria-hidden="true" tabindex="-1"></a>        <span class="kw">use</span> <span class="pp">ink::env::</span>test<span class="op">;</span></span>
<span id="cb117-130"><a href="#cb117-130" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb117-131"><a href="#cb117-131" aria-hidden="true" tabindex="-1"></a>        <span class="co">/// Helper function to create test accounts</span></span>
<span id="cb117-132"><a href="#cb117-132" aria-hidden="true" tabindex="-1"></a>        <span class="kw">fn</span> accounts() <span class="op">-&gt;</span> <span class="pp">ink::env::test::</span>DefaultAccounts<span class="op">&lt;</span><span class="pp">ink::env::</span>DefaultEnvironment<span class="op">&gt;</span> <span class="op">{</span></span>
<span id="cb117-133"><a href="#cb117-133" aria-hidden="true" tabindex="-1"></a>            <span class="pp">ink::env::test::default_accounts::</span><span class="op">&lt;</span><span class="pp">ink::env::</span>DefaultEnvironment<span class="op">&gt;</span>()</span>
<span id="cb117-134"><a href="#cb117-134" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb117-135"><a href="#cb117-135" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb117-136"><a href="#cb117-136" aria-hidden="true" tabindex="-1"></a>        <span class="co">/// Helper function to set up test environment</span></span>
<span id="cb117-137"><a href="#cb117-137" aria-hidden="true" tabindex="-1"></a>        <span class="kw">fn</span> setup_contract(total_supply<span class="op">:</span> Balance) <span class="op">-&gt;</span> TestableToken <span class="op">{</span></span>
<span id="cb117-138"><a href="#cb117-138" aria-hidden="true" tabindex="-1"></a>            <span class="kw">let</span> accounts <span class="op">=</span> accounts()<span class="op">;</span></span>
<span id="cb117-139"><a href="#cb117-139" aria-hidden="true" tabindex="-1"></a>            <span class="pp">test::set_caller::</span><span class="op">&lt;</span><span class="pp">ink::env::</span>DefaultEnvironment<span class="op">&gt;</span>(accounts<span class="op">.</span>alice)<span class="op">;</span></span>
<span id="cb117-140"><a href="#cb117-140" aria-hidden="true" tabindex="-1"></a>            <span class="pp">TestableToken::</span>new(total_supply)</span>
<span id="cb117-141"><a href="#cb117-141" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb117-142"><a href="#cb117-142" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb117-143"><a href="#cb117-143" aria-hidden="true" tabindex="-1"></a>        <span class="at">#[</span><span class="pp">ink::</span>test<span class="at">]</span></span>
<span id="cb117-144"><a href="#cb117-144" aria-hidden="true" tabindex="-1"></a>        <span class="kw">fn</span> constructor_works() <span class="op">{</span></span>
<span id="cb117-145"><a href="#cb117-145" aria-hidden="true" tabindex="-1"></a>            <span class="kw">let</span> total_supply <span class="op">=</span> <span class="dv">1000</span><span class="op">;</span></span>
<span id="cb117-146"><a href="#cb117-146" aria-hidden="true" tabindex="-1"></a>            <span class="kw">let</span> token <span class="op">=</span> setup_contract(total_supply)<span class="op">;</span></span>
<span id="cb117-147"><a href="#cb117-147" aria-hidden="true" tabindex="-1"></a>            <span class="kw">let</span> accounts <span class="op">=</span> accounts()<span class="op">;</span></span>
<span id="cb117-148"><a href="#cb117-148" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb117-149"><a href="#cb117-149" aria-hidden="true" tabindex="-1"></a>            <span class="pp">assert_eq!</span>(token<span class="op">.</span>total_supply<span class="op">,</span> total_supply)<span class="op">;</span></span>
<span id="cb117-150"><a href="#cb117-150" aria-hidden="true" tabindex="-1"></a>            <span class="pp">assert_eq!</span>(token<span class="op">.</span>balance_of(accounts<span class="op">.</span>alice)<span class="op">,</span> total_supply)<span class="op">;</span></span>
<span id="cb117-151"><a href="#cb117-151" aria-hidden="true" tabindex="-1"></a>            <span class="pp">assert_eq!</span>(token<span class="op">.</span>balance_of(accounts<span class="op">.</span>bob)<span class="op">,</span> <span class="dv">0</span>)<span class="op">;</span></span>
<span id="cb117-152"><a href="#cb117-152" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb117-153"><a href="#cb117-153" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb117-154"><a href="#cb117-154" aria-hidden="true" tabindex="-1"></a>        <span class="at">#[</span><span class="pp">ink::</span>test<span class="at">]</span></span>
<span id="cb117-155"><a href="#cb117-155" aria-hidden="true" tabindex="-1"></a>        <span class="kw">fn</span> transfer_works() <span class="op">{</span></span>
<span id="cb117-156"><a href="#cb117-156" aria-hidden="true" tabindex="-1"></a>            <span class="kw">let</span> <span class="kw">mut</span> token <span class="op">=</span> setup_contract(<span class="dv">1000</span>)<span class="op">;</span></span>
<span id="cb117-157"><a href="#cb117-157" aria-hidden="true" tabindex="-1"></a>            <span class="kw">let</span> accounts <span class="op">=</span> accounts()<span class="op">;</span></span>
<span id="cb117-158"><a href="#cb117-158" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb117-159"><a href="#cb117-159" aria-hidden="true" tabindex="-1"></a>            <span class="co">// Test successful transfer</span></span>
<span id="cb117-160"><a href="#cb117-160" aria-hidden="true" tabindex="-1"></a>            <span class="pp">assert_eq!</span>(token<span class="op">.</span>transfer(accounts<span class="op">.</span>bob<span class="op">,</span> <span class="dv">100</span>)<span class="op">,</span> <span class="cn">Ok</span>(()))<span class="op">;</span></span>
<span id="cb117-161"><a href="#cb117-161" aria-hidden="true" tabindex="-1"></a>            <span class="pp">assert_eq!</span>(token<span class="op">.</span>balance_of(accounts<span class="op">.</span>alice)<span class="op">,</span> <span class="dv">900</span>)<span class="op">;</span></span>
<span id="cb117-162"><a href="#cb117-162" aria-hidden="true" tabindex="-1"></a>            <span class="pp">assert_eq!</span>(token<span class="op">.</span>balance_of(accounts<span class="op">.</span>bob)<span class="op">,</span> <span class="dv">100</span>)<span class="op">;</span></span>
<span id="cb117-163"><a href="#cb117-163" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb117-164"><a href="#cb117-164" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb117-165"><a href="#cb117-165" aria-hidden="true" tabindex="-1"></a>        <span class="at">#[</span><span class="pp">ink::</span>test<span class="at">]</span></span>
<span id="cb117-166"><a href="#cb117-166" aria-hidden="true" tabindex="-1"></a>        <span class="kw">fn</span> transfer_insufficient_balance_fails() <span class="op">{</span></span>
<span id="cb117-167"><a href="#cb117-167" aria-hidden="true" tabindex="-1"></a>            <span class="kw">let</span> <span class="kw">mut</span> token <span class="op">=</span> setup_contract(<span class="dv">100</span>)<span class="op">;</span></span>
<span id="cb117-168"><a href="#cb117-168" aria-hidden="true" tabindex="-1"></a>            <span class="kw">let</span> accounts <span class="op">=</span> accounts()<span class="op">;</span></span>
<span id="cb117-169"><a href="#cb117-169" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb117-170"><a href="#cb117-170" aria-hidden="true" tabindex="-1"></a>            <span class="co">// Try to transfer more than balance</span></span>
<span id="cb117-171"><a href="#cb117-171" aria-hidden="true" tabindex="-1"></a>            <span class="pp">assert_eq!</span>(token<span class="op">.</span>transfer(accounts<span class="op">.</span>bob<span class="op">,</span> <span class="dv">200</span>)<span class="op">,</span> <span class="cn">Err</span>(<span class="bu">Error</span><span class="pp">::</span>InsufficientBalance))<span class="op">;</span></span>
<span id="cb117-172"><a href="#cb117-172" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb117-173"><a href="#cb117-173" aria-hidden="true" tabindex="-1"></a>            <span class="co">// Balances should remain unchanged</span></span>
<span id="cb117-174"><a href="#cb117-174" aria-hidden="true" tabindex="-1"></a>            <span class="pp">assert_eq!</span>(token<span class="op">.</span>balance_of(accounts<span class="op">.</span>alice)<span class="op">,</span> <span class="dv">100</span>)<span class="op">;</span></span>
<span id="cb117-175"><a href="#cb117-175" aria-hidden="true" tabindex="-1"></a>            <span class="pp">assert_eq!</span>(token<span class="op">.</span>balance_of(accounts<span class="op">.</span>bob)<span class="op">,</span> <span class="dv">0</span>)<span class="op">;</span></span>
<span id="cb117-176"><a href="#cb117-176" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb117-177"><a href="#cb117-177" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb117-178"><a href="#cb117-178" aria-hidden="true" tabindex="-1"></a>        <span class="at">#[</span><span class="pp">ink::</span>test<span class="at">]</span></span>
<span id="cb117-179"><a href="#cb117-179" aria-hidden="true" tabindex="-1"></a>        <span class="kw">fn</span> transfer_zero_amount_fails() <span class="op">{</span></span>
<span id="cb117-180"><a href="#cb117-180" aria-hidden="true" tabindex="-1"></a>            <span class="kw">let</span> <span class="kw">mut</span> token <span class="op">=</span> setup_contract(<span class="dv">1000</span>)<span class="op">;</span></span>
<span id="cb117-181"><a href="#cb117-181" aria-hidden="true" tabindex="-1"></a>            <span class="kw">let</span> accounts <span class="op">=</span> accounts()<span class="op">;</span></span>
<span id="cb117-182"><a href="#cb117-182" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb117-183"><a href="#cb117-183" aria-hidden="true" tabindex="-1"></a>            <span class="pp">assert_eq!</span>(token<span class="op">.</span>transfer(accounts<span class="op">.</span>bob<span class="op">,</span> <span class="dv">0</span>)<span class="op">,</span> <span class="cn">Err</span>(<span class="bu">Error</span><span class="pp">::</span>InvalidAmount))<span class="op">;</span></span>
<span id="cb117-184"><a href="#cb117-184" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb117-185"><a href="#cb117-185" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb117-186"><a href="#cb117-186" aria-hidden="true" tabindex="-1"></a>        <span class="at">#[</span><span class="pp">ink::</span>test<span class="at">]</span></span>
<span id="cb117-187"><a href="#cb117-187" aria-hidden="true" tabindex="-1"></a>        <span class="kw">fn</span> self_transfer_fails() <span class="op">{</span></span>
<span id="cb117-188"><a href="#cb117-188" aria-hidden="true" tabindex="-1"></a>            <span class="kw">let</span> <span class="kw">mut</span> token <span class="op">=</span> setup_contract(<span class="dv">1000</span>)<span class="op">;</span></span>
<span id="cb117-189"><a href="#cb117-189" aria-hidden="true" tabindex="-1"></a>            <span class="kw">let</span> accounts <span class="op">=</span> accounts()<span class="op">;</span></span>
<span id="cb117-190"><a href="#cb117-190" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb117-191"><a href="#cb117-191" aria-hidden="true" tabindex="-1"></a>            <span class="pp">assert_eq!</span>(token<span class="op">.</span>transfer(accounts<span class="op">.</span>alice<span class="op">,</span> <span class="dv">100</span>)<span class="op">,</span> <span class="cn">Err</span>(<span class="bu">Error</span><span class="pp">::</span>SelfTransfer))<span class="op">;</span></span>
<span id="cb117-192"><a href="#cb117-192" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb117-193"><a href="#cb117-193" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb117-194"><a href="#cb117-194" aria-hidden="true" tabindex="-1"></a>        <span class="at">#[</span><span class="pp">ink::</span>test<span class="at">]</span></span>
<span id="cb117-195"><a href="#cb117-195" aria-hidden="true" tabindex="-1"></a>        <span class="kw">fn</span> approve_works() <span class="op">{</span></span>
<span id="cb117-196"><a href="#cb117-196" aria-hidden="true" tabindex="-1"></a>            <span class="kw">let</span> <span class="kw">mut</span> token <span class="op">=</span> setup_contract(<span class="dv">1000</span>)<span class="op">;</span></span>
<span id="cb117-197"><a href="#cb117-197" aria-hidden="true" tabindex="-1"></a>            <span class="kw">let</span> accounts <span class="op">=</span> accounts()<span class="op">;</span></span>
<span id="cb117-198"><a href="#cb117-198" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb117-199"><a href="#cb117-199" aria-hidden="true" tabindex="-1"></a>            <span class="pp">assert_eq!</span>(token<span class="op">.</span>approve(accounts<span class="op">.</span>bob<span class="op">,</span> <span class="dv">500</span>)<span class="op">,</span> <span class="cn">Ok</span>(()))<span class="op">;</span></span>
<span id="cb117-200"><a href="#cb117-200" aria-hidden="true" tabindex="-1"></a>            <span class="pp">assert_eq!</span>(token<span class="op">.</span>allowance(accounts<span class="op">.</span>alice<span class="op">,</span> accounts<span class="op">.</span>bob)<span class="op">,</span> <span class="dv">500</span>)<span class="op">;</span></span>
<span id="cb117-201"><a href="#cb117-201" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb117-202"><a href="#cb117-202" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb117-203"><a href="#cb117-203" aria-hidden="true" tabindex="-1"></a>        <span class="at">#[</span><span class="pp">ink::</span>test<span class="at">]</span></span>
<span id="cb117-204"><a href="#cb117-204" aria-hidden="true" tabindex="-1"></a>        <span class="kw">fn</span> transfer_from_works() <span class="op">{</span></span>
<span id="cb117-205"><a href="#cb117-205" aria-hidden="true" tabindex="-1"></a>            <span class="kw">let</span> <span class="kw">mut</span> token <span class="op">=</span> setup_contract(<span class="dv">1000</span>)<span class="op">;</span></span>
<span id="cb117-206"><a href="#cb117-206" aria-hidden="true" tabindex="-1"></a>            <span class="kw">let</span> accounts <span class="op">=</span> accounts()<span class="op">;</span></span>
<span id="cb117-207"><a href="#cb117-207" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb117-208"><a href="#cb117-208" aria-hidden="true" tabindex="-1"></a>            <span class="co">// Alice approves Bob to spend 500 tokens</span></span>
<span id="cb117-209"><a href="#cb117-209" aria-hidden="true" tabindex="-1"></a>            <span class="pp">assert_eq!</span>(token<span class="op">.</span>approve(accounts<span class="op">.</span>bob<span class="op">,</span> <span class="dv">500</span>)<span class="op">,</span> <span class="cn">Ok</span>(()))<span class="op">;</span></span>
<span id="cb117-210"><a href="#cb117-210" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb117-211"><a href="#cb117-211" aria-hidden="true" tabindex="-1"></a>            <span class="co">// Switch to Bob&#39;s account</span></span>
<span id="cb117-212"><a href="#cb117-212" aria-hidden="true" tabindex="-1"></a>            <span class="pp">test::set_caller::</span><span class="op">&lt;</span><span class="pp">ink::env::</span>DefaultEnvironment<span class="op">&gt;</span>(accounts<span class="op">.</span>bob)<span class="op">;</span></span>
<span id="cb117-213"><a href="#cb117-213" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb117-214"><a href="#cb117-214" aria-hidden="true" tabindex="-1"></a>            <span class="co">// Bob transfers 100 tokens from Alice to Charlie</span></span>
<span id="cb117-215"><a href="#cb117-215" aria-hidden="true" tabindex="-1"></a>            <span class="pp">assert_eq!</span>(token<span class="op">.</span>transfer_from(accounts<span class="op">.</span>alice<span class="op">,</span> accounts<span class="op">.</span>charlie<span class="op">,</span> <span class="dv">100</span>)<span class="op">,</span> <span class="cn">Ok</span>(()))<span class="op">;</span></span>
<span id="cb117-216"><a href="#cb117-216" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb117-217"><a href="#cb117-217" aria-hidden="true" tabindex="-1"></a>            <span class="co">// Check balances</span></span>
<span id="cb117-218"><a href="#cb117-218" aria-hidden="true" tabindex="-1"></a>            <span class="pp">assert_eq!</span>(token<span class="op">.</span>balance_of(accounts<span class="op">.</span>alice)<span class="op">,</span> <span class="dv">900</span>)<span class="op">;</span></span>
<span id="cb117-219"><a href="#cb117-219" aria-hidden="true" tabindex="-1"></a>            <span class="pp">assert_eq!</span>(token<span class="op">.</span>balance_of(accounts<span class="op">.</span>charlie)<span class="op">,</span> <span class="dv">100</span>)<span class="op">;</span></span>
<span id="cb117-220"><a href="#cb117-220" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb117-221"><a href="#cb117-221" aria-hidden="true" tabindex="-1"></a>            <span class="co">// Check remaining allowance</span></span>
<span id="cb117-222"><a href="#cb117-222" aria-hidden="true" tabindex="-1"></a>            <span class="pp">assert_eq!</span>(token<span class="op">.</span>allowance(accounts<span class="op">.</span>alice<span class="op">,</span> accounts<span class="op">.</span>bob)<span class="op">,</span> <span class="dv">400</span>)<span class="op">;</span></span>
<span id="cb117-223"><a href="#cb117-223" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb117-224"><a href="#cb117-224" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb117-225"><a href="#cb117-225" aria-hidden="true" tabindex="-1"></a>        <span class="at">#[</span><span class="pp">ink::</span>test<span class="at">]</span></span>
<span id="cb117-226"><a href="#cb117-226" aria-hidden="true" tabindex="-1"></a>        <span class="kw">fn</span> transfer_from_insufficient_allowance_fails() <span class="op">{</span></span>
<span id="cb117-227"><a href="#cb117-227" aria-hidden="true" tabindex="-1"></a>            <span class="kw">let</span> <span class="kw">mut</span> token <span class="op">=</span> setup_contract(<span class="dv">1000</span>)<span class="op">;</span></span>
<span id="cb117-228"><a href="#cb117-228" aria-hidden="true" tabindex="-1"></a>            <span class="kw">let</span> accounts <span class="op">=</span> accounts()<span class="op">;</span></span>
<span id="cb117-229"><a href="#cb117-229" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb117-230"><a href="#cb117-230" aria-hidden="true" tabindex="-1"></a>            <span class="co">// Alice approves Bob to spend 100 tokens</span></span>
<span id="cb117-231"><a href="#cb117-231" aria-hidden="true" tabindex="-1"></a>            <span class="pp">assert_eq!</span>(token<span class="op">.</span>approve(accounts<span class="op">.</span>bob<span class="op">,</span> <span class="dv">100</span>)<span class="op">,</span> <span class="cn">Ok</span>(()))<span class="op">;</span></span>
<span id="cb117-232"><a href="#cb117-232" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb117-233"><a href="#cb117-233" aria-hidden="true" tabindex="-1"></a>            <span class="co">// Switch to Bob&#39;s account</span></span>
<span id="cb117-234"><a href="#cb117-234" aria-hidden="true" tabindex="-1"></a>            <span class="pp">test::set_caller::</span><span class="op">&lt;</span><span class="pp">ink::env::</span>DefaultEnvironment<span class="op">&gt;</span>(accounts<span class="op">.</span>bob)<span class="op">;</span></span>
<span id="cb117-235"><a href="#cb117-235" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb117-236"><a href="#cb117-236" aria-hidden="true" tabindex="-1"></a>            <span class="co">// Bob tries to transfer 200 tokens (more than allowance)</span></span>
<span id="cb117-237"><a href="#cb117-237" aria-hidden="true" tabindex="-1"></a>            <span class="pp">assert_eq!</span>(</span>
<span id="cb117-238"><a href="#cb117-238" aria-hidden="true" tabindex="-1"></a>                token<span class="op">.</span>transfer_from(accounts<span class="op">.</span>alice<span class="op">,</span> accounts<span class="op">.</span>charlie<span class="op">,</span> <span class="dv">200</span>)<span class="op">,</span></span>
<span id="cb117-239"><a href="#cb117-239" aria-hidden="true" tabindex="-1"></a>                <span class="cn">Err</span>(<span class="bu">Error</span><span class="pp">::</span>InsufficientAllowance)</span>
<span id="cb117-240"><a href="#cb117-240" aria-hidden="true" tabindex="-1"></a>            )<span class="op">;</span></span>
<span id="cb117-241"><a href="#cb117-241" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb117-242"><a href="#cb117-242" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb117-243"><a href="#cb117-243" aria-hidden="true" tabindex="-1"></a>        <span class="at">#[</span><span class="pp">ink::</span>test<span class="at">]</span></span>
<span id="cb117-244"><a href="#cb117-244" aria-hidden="true" tabindex="-1"></a>        <span class="kw">fn</span> pause_functionality_works() <span class="op">{</span></span>
<span id="cb117-245"><a href="#cb117-245" aria-hidden="true" tabindex="-1"></a>            <span class="kw">let</span> <span class="kw">mut</span> token <span class="op">=</span> setup_contract(<span class="dv">1000</span>)<span class="op">;</span></span>
<span id="cb117-246"><a href="#cb117-246" aria-hidden="true" tabindex="-1"></a>            <span class="kw">let</span> accounts <span class="op">=</span> accounts()<span class="op">;</span></span>
<span id="cb117-247"><a href="#cb117-247" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb117-248"><a href="#cb117-248" aria-hidden="true" tabindex="-1"></a>            <span class="co">// Pause the contract</span></span>
<span id="cb117-249"><a href="#cb117-249" aria-hidden="true" tabindex="-1"></a>            <span class="pp">assert_eq!</span>(token<span class="op">.</span>pause()<span class="op">,</span> <span class="cn">Ok</span>(()))<span class="op">;</span></span>
<span id="cb117-250"><a href="#cb117-250" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb117-251"><a href="#cb117-251" aria-hidden="true" tabindex="-1"></a>            <span class="co">// Transfers should fail when paused</span></span>
<span id="cb117-252"><a href="#cb117-252" aria-hidden="true" tabindex="-1"></a>            <span class="pp">assert_eq!</span>(token<span class="op">.</span>transfer(accounts<span class="op">.</span>bob<span class="op">,</span> <span class="dv">100</span>)<span class="op">,</span> <span class="cn">Err</span>(<span class="bu">Error</span><span class="pp">::</span>ContractPaused))<span class="op">;</span></span>
<span id="cb117-253"><a href="#cb117-253" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb117-254"><a href="#cb117-254" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb117-255"><a href="#cb117-255" aria-hidden="true" tabindex="-1"></a>        <span class="at">#[</span><span class="pp">ink::</span>test<span class="at">]</span></span>
<span id="cb117-256"><a href="#cb117-256" aria-hidden="true" tabindex="-1"></a>        <span class="kw">fn</span> pause_unauthorized_fails() <span class="op">{</span></span>
<span id="cb117-257"><a href="#cb117-257" aria-hidden="true" tabindex="-1"></a>            <span class="kw">let</span> <span class="kw">mut</span> token <span class="op">=</span> setup_contract(<span class="dv">1000</span>)<span class="op">;</span></span>
<span id="cb117-258"><a href="#cb117-258" aria-hidden="true" tabindex="-1"></a>            <span class="kw">let</span> accounts <span class="op">=</span> accounts()<span class="op">;</span></span>
<span id="cb117-259"><a href="#cb117-259" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb117-260"><a href="#cb117-260" aria-hidden="true" tabindex="-1"></a>            <span class="co">// Switch to non-owner account</span></span>
<span id="cb117-261"><a href="#cb117-261" aria-hidden="true" tabindex="-1"></a>            <span class="pp">test::set_caller::</span><span class="op">&lt;</span><span class="pp">ink::env::</span>DefaultEnvironment<span class="op">&gt;</span>(accounts<span class="op">.</span>bob)<span class="op">;</span></span>
<span id="cb117-262"><a href="#cb117-262" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb117-263"><a href="#cb117-263" aria-hidden="true" tabindex="-1"></a>            <span class="co">// Non-owner cannot pause</span></span>
<span id="cb117-264"><a href="#cb117-264" aria-hidden="true" tabindex="-1"></a>            <span class="pp">assert_eq!</span>(token<span class="op">.</span>pause()<span class="op">,</span> <span class="cn">Err</span>(<span class="bu">Error</span><span class="pp">::</span>Unauthorized))<span class="op">;</span></span>
<span id="cb117-265"><a href="#cb117-265" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb117-266"><a href="#cb117-266" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb117-267"><a href="#cb117-267" aria-hidden="true" tabindex="-1"></a>        <span class="at">#[</span><span class="pp">ink::</span>test<span class="at">]</span></span>
<span id="cb117-268"><a href="#cb117-268" aria-hidden="true" tabindex="-1"></a>        <span class="kw">fn</span> edge_case_max_balance() <span class="op">{</span></span>
<span id="cb117-269"><a href="#cb117-269" aria-hidden="true" tabindex="-1"></a>            <span class="kw">let</span> max_supply <span class="op">=</span> <span class="pp">Balance::</span><span class="cn">MAX</span><span class="op">;</span></span>
<span id="cb117-270"><a href="#cb117-270" aria-hidden="true" tabindex="-1"></a>            <span class="kw">let</span> <span class="kw">mut</span> token <span class="op">=</span> setup_contract(max_supply)<span class="op">;</span></span>
<span id="cb117-271"><a href="#cb117-271" aria-hidden="true" tabindex="-1"></a>            <span class="kw">let</span> accounts <span class="op">=</span> accounts()<span class="op">;</span></span>
<span id="cb117-272"><a href="#cb117-272" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb117-273"><a href="#cb117-273" aria-hidden="true" tabindex="-1"></a>            <span class="co">// Should be able to transfer max balance</span></span>
<span id="cb117-274"><a href="#cb117-274" aria-hidden="true" tabindex="-1"></a>            <span class="pp">assert_eq!</span>(token<span class="op">.</span>transfer(accounts<span class="op">.</span>bob<span class="op">,</span> max_supply)<span class="op">,</span> <span class="cn">Ok</span>(()))<span class="op">;</span></span>
<span id="cb117-275"><a href="#cb117-275" aria-hidden="true" tabindex="-1"></a>            <span class="pp">assert_eq!</span>(token<span class="op">.</span>balance_of(accounts<span class="op">.</span>alice)<span class="op">,</span> <span class="dv">0</span>)<span class="op">;</span></span>
<span id="cb117-276"><a href="#cb117-276" aria-hidden="true" tabindex="-1"></a>            <span class="pp">assert_eq!</span>(token<span class="op">.</span>balance_of(accounts<span class="op">.</span>bob)<span class="op">,</span> max_supply)<span class="op">;</span></span>
<span id="cb117-277"><a href="#cb117-277" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb117-278"><a href="#cb117-278" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb117-279"><a href="#cb117-279" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<h3 id="advanced-unit-testing-patterns">Advanced Unit Testing
Patterns</h3>
<h4 id="testing-with-mock-environments">Testing with Mock
Environments</h4>
<div class="sourceCode" id="cb118"><pre
class="sourceCode rust"><code class="sourceCode rust"><span id="cb118-1"><a href="#cb118-1" aria-hidden="true" tabindex="-1"></a><span class="at">#[</span>cfg<span class="at">(</span>test<span class="at">)]</span></span>
<span id="cb118-2"><a href="#cb118-2" aria-hidden="true" tabindex="-1"></a><span class="kw">mod</span> advanced_tests <span class="op">{</span></span>
<span id="cb118-3"><a href="#cb118-3" aria-hidden="true" tabindex="-1"></a>    <span class="kw">use</span> <span class="kw">super</span><span class="pp">::</span><span class="op">*;</span></span>
<span id="cb118-4"><a href="#cb118-4" aria-hidden="true" tabindex="-1"></a>    <span class="kw">use</span> <span class="pp">ink::env::</span>test<span class="op">;</span></span>
<span id="cb118-5"><a href="#cb118-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb118-6"><a href="#cb118-6" aria-hidden="true" tabindex="-1"></a>    <span class="co">/// Test time-dependent functionality</span></span>
<span id="cb118-7"><a href="#cb118-7" aria-hidden="true" tabindex="-1"></a>    <span class="at">#[</span><span class="pp">ink::</span>test<span class="at">]</span></span>
<span id="cb118-8"><a href="#cb118-8" aria-hidden="true" tabindex="-1"></a>    <span class="kw">fn</span> time_locked_function_works() <span class="op">{</span></span>
<span id="cb118-9"><a href="#cb118-9" aria-hidden="true" tabindex="-1"></a>        <span class="kw">let</span> <span class="kw">mut</span> contract <span class="op">=</span> setup_time_locked_contract()<span class="op">;</span></span>
<span id="cb118-10"><a href="#cb118-10" aria-hidden="true" tabindex="-1"></a>        <span class="kw">let</span> accounts <span class="op">=</span> accounts()<span class="op">;</span></span>
<span id="cb118-11"><a href="#cb118-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb118-12"><a href="#cb118-12" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Function should fail before time lock expires</span></span>
<span id="cb118-13"><a href="#cb118-13" aria-hidden="true" tabindex="-1"></a>        <span class="pp">assert_eq!</span>(contract<span class="op">.</span>time_locked_function()<span class="op">,</span> <span class="cn">Err</span>(<span class="bu">Error</span><span class="pp">::</span>TimeLocked))<span class="op">;</span></span>
<span id="cb118-14"><a href="#cb118-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb118-15"><a href="#cb118-15" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Advance time past the lock period</span></span>
<span id="cb118-16"><a href="#cb118-16" aria-hidden="true" tabindex="-1"></a>        <span class="kw">let</span> current_time <span class="op">=</span> <span class="pp">test::get_block_timestamp::</span><span class="op">&lt;</span><span class="pp">ink::env::</span>DefaultEnvironment<span class="op">&gt;</span>()<span class="op">;</span></span>
<span id="cb118-17"><a href="#cb118-17" aria-hidden="true" tabindex="-1"></a>        <span class="pp">test::set_block_timestamp::</span><span class="op">&lt;</span><span class="pp">ink::env::</span>DefaultEnvironment<span class="op">&gt;</span>(current_time <span class="op">+</span> <span class="dv">86400000</span>)<span class="op">;</span> <span class="co">// +24 hours</span></span>
<span id="cb118-18"><a href="#cb118-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb118-19"><a href="#cb118-19" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Function should now work</span></span>
<span id="cb118-20"><a href="#cb118-20" aria-hidden="true" tabindex="-1"></a>        <span class="pp">assert_eq!</span>(contract<span class="op">.</span>time_locked_function()<span class="op">,</span> <span class="cn">Ok</span>(()))<span class="op">;</span></span>
<span id="cb118-21"><a href="#cb118-21" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb118-22"><a href="#cb118-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb118-23"><a href="#cb118-23" aria-hidden="true" tabindex="-1"></a>    <span class="co">/// Test block number dependent functionality</span></span>
<span id="cb118-24"><a href="#cb118-24" aria-hidden="true" tabindex="-1"></a>    <span class="at">#[</span><span class="pp">ink::</span>test<span class="at">]</span></span>
<span id="cb118-25"><a href="#cb118-25" aria-hidden="true" tabindex="-1"></a>    <span class="kw">fn</span> block_dependent_logic_works() <span class="op">{</span></span>
<span id="cb118-26"><a href="#cb118-26" aria-hidden="true" tabindex="-1"></a>        <span class="kw">let</span> <span class="kw">mut</span> contract <span class="op">=</span> <span class="pp">TestableToken::</span>new(<span class="dv">1000</span>)<span class="op">;</span></span>
<span id="cb118-27"><a href="#cb118-27" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb118-28"><a href="#cb118-28" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Set specific block number</span></span>
<span id="cb118-29"><a href="#cb118-29" aria-hidden="true" tabindex="-1"></a>        <span class="pp">test::set_block_number::</span><span class="op">&lt;</span><span class="pp">ink::env::</span>DefaultEnvironment<span class="op">&gt;</span>(<span class="dv">100</span>)<span class="op">;</span></span>
<span id="cb118-30"><a href="#cb118-30" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb118-31"><a href="#cb118-31" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Test logic that depends on block number</span></span>
<span id="cb118-32"><a href="#cb118-32" aria-hidden="true" tabindex="-1"></a>        <span class="pp">assert_eq!</span>(contract<span class="op">.</span>block_dependent_function()<span class="op">,</span> <span class="cn">Ok</span>(<span class="dv">100</span>))<span class="op">;</span></span>
<span id="cb118-33"><a href="#cb118-33" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb118-34"><a href="#cb118-34" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb118-35"><a href="#cb118-35" aria-hidden="true" tabindex="-1"></a>    <span class="co">/// Test caller-dependent functionality</span></span>
<span id="cb118-36"><a href="#cb118-36" aria-hidden="true" tabindex="-1"></a>    <span class="at">#[</span><span class="pp">ink::</span>test<span class="at">]</span></span>
<span id="cb118-37"><a href="#cb118-37" aria-hidden="true" tabindex="-1"></a>    <span class="kw">fn</span> multi_caller_scenario() <span class="op">{</span></span>
<span id="cb118-38"><a href="#cb118-38" aria-hidden="true" tabindex="-1"></a>        <span class="kw">let</span> <span class="kw">mut</span> token <span class="op">=</span> setup_contract(<span class="dv">1000</span>)<span class="op">;</span></span>
<span id="cb118-39"><a href="#cb118-39" aria-hidden="true" tabindex="-1"></a>        <span class="kw">let</span> accounts <span class="op">=</span> accounts()<span class="op">;</span></span>
<span id="cb118-40"><a href="#cb118-40" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb118-41"><a href="#cb118-41" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Alice (owner) performs initial setup</span></span>
<span id="cb118-42"><a href="#cb118-42" aria-hidden="true" tabindex="-1"></a>        <span class="pp">test::set_caller::</span><span class="op">&lt;</span><span class="pp">ink::env::</span>DefaultEnvironment<span class="op">&gt;</span>(accounts<span class="op">.</span>alice)<span class="op">;</span></span>
<span id="cb118-43"><a href="#cb118-43" aria-hidden="true" tabindex="-1"></a>        <span class="pp">assert_eq!</span>(token<span class="op">.</span>approve(accounts<span class="op">.</span>bob<span class="op">,</span> <span class="dv">500</span>)<span class="op">,</span> <span class="cn">Ok</span>(()))<span class="op">;</span></span>
<span id="cb118-44"><a href="#cb118-44" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb118-45"><a href="#cb118-45" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Bob performs allowance-based transfer</span></span>
<span id="cb118-46"><a href="#cb118-46" aria-hidden="true" tabindex="-1"></a>        <span class="pp">test::set_caller::</span><span class="op">&lt;</span><span class="pp">ink::env::</span>DefaultEnvironment<span class="op">&gt;</span>(accounts<span class="op">.</span>bob)<span class="op">;</span></span>
<span id="cb118-47"><a href="#cb118-47" aria-hidden="true" tabindex="-1"></a>        <span class="pp">assert_eq!</span>(token<span class="op">.</span>transfer_from(accounts<span class="op">.</span>alice<span class="op">,</span> accounts<span class="op">.</span>charlie<span class="op">,</span> <span class="dv">100</span>)<span class="op">,</span> <span class="cn">Ok</span>(()))<span class="op">;</span></span>
<span id="cb118-48"><a href="#cb118-48" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb118-49"><a href="#cb118-49" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Charlie checks their balance</span></span>
<span id="cb118-50"><a href="#cb118-50" aria-hidden="true" tabindex="-1"></a>        <span class="pp">test::set_caller::</span><span class="op">&lt;</span><span class="pp">ink::env::</span>DefaultEnvironment<span class="op">&gt;</span>(accounts<span class="op">.</span>charlie)<span class="op">;</span></span>
<span id="cb118-51"><a href="#cb118-51" aria-hidden="true" tabindex="-1"></a>        <span class="pp">assert_eq!</span>(token<span class="op">.</span>balance_of(accounts<span class="op">.</span>charlie)<span class="op">,</span> <span class="dv">100</span>)<span class="op">;</span></span>
<span id="cb118-52"><a href="#cb118-52" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb118-53"><a href="#cb118-53" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb118-54"><a href="#cb118-54" aria-hidden="true" tabindex="-1"></a>    <span class="co">/// Test error propagation chains</span></span>
<span id="cb118-55"><a href="#cb118-55" aria-hidden="true" tabindex="-1"></a>    <span class="at">#[</span><span class="pp">ink::</span>test<span class="at">]</span></span>
<span id="cb118-56"><a href="#cb118-56" aria-hidden="true" tabindex="-1"></a>    <span class="kw">fn</span> error_propagation_works() <span class="op">{</span></span>
<span id="cb118-57"><a href="#cb118-57" aria-hidden="true" tabindex="-1"></a>        <span class="kw">let</span> <span class="kw">mut</span> token <span class="op">=</span> setup_contract(<span class="dv">1000</span>)<span class="op">;</span></span>
<span id="cb118-58"><a href="#cb118-58" aria-hidden="true" tabindex="-1"></a>        <span class="kw">let</span> accounts <span class="op">=</span> accounts()<span class="op">;</span></span>
<span id="cb118-59"><a href="#cb118-59" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb118-60"><a href="#cb118-60" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Create a chain of operations that should fail at different points</span></span>
<span id="cb118-61"><a href="#cb118-61" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb118-62"><a href="#cb118-62" aria-hidden="true" tabindex="-1"></a>        <span class="co">// First, pause the contract</span></span>
<span id="cb118-63"><a href="#cb118-63" aria-hidden="true" tabindex="-1"></a>        <span class="pp">assert_eq!</span>(token<span class="op">.</span>pause()<span class="op">,</span> <span class="cn">Ok</span>(()))<span class="op">;</span></span>
<span id="cb118-64"><a href="#cb118-64" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb118-65"><a href="#cb118-65" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Now all operations should fail with ContractPaused</span></span>
<span id="cb118-66"><a href="#cb118-66" aria-hidden="true" tabindex="-1"></a>        <span class="pp">assert_eq!</span>(token<span class="op">.</span>transfer(accounts<span class="op">.</span>bob<span class="op">,</span> <span class="dv">100</span>)<span class="op">,</span> <span class="cn">Err</span>(<span class="bu">Error</span><span class="pp">::</span>ContractPaused))<span class="op">;</span></span>
<span id="cb118-67"><a href="#cb118-67" aria-hidden="true" tabindex="-1"></a>        <span class="pp">assert_eq!</span>(token<span class="op">.</span>approve(accounts<span class="op">.</span>bob<span class="op">,</span> <span class="dv">500</span>)<span class="op">,</span> <span class="cn">Err</span>(<span class="bu">Error</span><span class="pp">::</span>ContractPaused))<span class="op">;</span></span>
<span id="cb118-68"><a href="#cb118-68" aria-hidden="true" tabindex="-1"></a>        <span class="pp">assert_eq!</span>(</span>
<span id="cb118-69"><a href="#cb118-69" aria-hidden="true" tabindex="-1"></a>            token<span class="op">.</span>transfer_from(accounts<span class="op">.</span>alice<span class="op">,</span> accounts<span class="op">.</span>bob<span class="op">,</span> <span class="dv">100</span>)<span class="op">,</span></span>
<span id="cb118-70"><a href="#cb118-70" aria-hidden="true" tabindex="-1"></a>            <span class="cn">Err</span>(<span class="bu">Error</span><span class="pp">::</span>ContractPaused)</span>
<span id="cb118-71"><a href="#cb118-71" aria-hidden="true" tabindex="-1"></a>        )<span class="op">;</span></span>
<span id="cb118-72"><a href="#cb118-72" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb118-73"><a href="#cb118-73" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb118-74"><a href="#cb118-74" aria-hidden="true" tabindex="-1"></a>    <span class="kw">fn</span> setup_time_locked_contract() <span class="op">-&gt;</span> TestableToken <span class="op">{</span></span>
<span id="cb118-75"><a href="#cb118-75" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Setup contract with time lock</span></span>
<span id="cb118-76"><a href="#cb118-76" aria-hidden="true" tabindex="-1"></a>        setup_contract(<span class="dv">1000</span>)</span>
<span id="cb118-77"><a href="#cb118-77" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb118-78"><a href="#cb118-78" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<h4 id="property-based-testing">Property-Based Testing</h4>
<p>Property-based testing discovers edge cases by generating random
inputs and verifying invariants:</p>
<div class="sourceCode" id="cb119"><pre
class="sourceCode rust"><code class="sourceCode rust"><span id="cb119-1"><a href="#cb119-1" aria-hidden="true" tabindex="-1"></a><span class="at">#[</span>cfg<span class="at">(</span>test<span class="at">)]</span></span>
<span id="cb119-2"><a href="#cb119-2" aria-hidden="true" tabindex="-1"></a><span class="kw">mod</span> property_tests <span class="op">{</span></span>
<span id="cb119-3"><a href="#cb119-3" aria-hidden="true" tabindex="-1"></a>    <span class="kw">use</span> <span class="kw">super</span><span class="pp">::</span><span class="op">*;</span></span>
<span id="cb119-4"><a href="#cb119-4" aria-hidden="true" tabindex="-1"></a>    <span class="kw">use</span> <span class="pp">quickcheck::</span><span class="op">{</span>quickcheck<span class="op">,</span> TestResult<span class="op">};</span></span>
<span id="cb119-5"><a href="#cb119-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb119-6"><a href="#cb119-6" aria-hidden="true" tabindex="-1"></a>    <span class="co">/// Property: Total supply should remain constant (except minting/burning)</span></span>
<span id="cb119-7"><a href="#cb119-7" aria-hidden="true" tabindex="-1"></a>    <span class="kw">fn</span> prop_total_supply_conservation(transfers<span class="op">:</span> <span class="dt">Vec</span><span class="op">&lt;</span>(<span class="dt">u8</span><span class="op">,</span> <span class="dt">u8</span><span class="op">,</span> <span class="dt">u64</span>)<span class="op">&gt;</span>) <span class="op">-&gt;</span> TestResult <span class="op">{</span></span>
<span id="cb119-8"><a href="#cb119-8" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> transfers<span class="op">.</span>len() <span class="op">&gt;</span> <span class="dv">20</span> <span class="op">{</span></span>
<span id="cb119-9"><a href="#cb119-9" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> <span class="pp">TestResult::</span>discard()<span class="op">;</span> <span class="co">// Limit test size</span></span>
<span id="cb119-10"><a href="#cb119-10" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb119-11"><a href="#cb119-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb119-12"><a href="#cb119-12" aria-hidden="true" tabindex="-1"></a>        <span class="kw">let</span> <span class="kw">mut</span> token <span class="op">=</span> setup_contract(<span class="dv">1_000_000</span>)<span class="op">;</span></span>
<span id="cb119-13"><a href="#cb119-13" aria-hidden="true" tabindex="-1"></a>        <span class="kw">let</span> accounts <span class="op">=</span> accounts()<span class="op">;</span></span>
<span id="cb119-14"><a href="#cb119-14" aria-hidden="true" tabindex="-1"></a>        <span class="kw">let</span> test_accounts <span class="op">=</span> [accounts<span class="op">.</span>alice<span class="op">,</span> accounts<span class="op">.</span>bob<span class="op">,</span> accounts<span class="op">.</span>charlie<span class="op">,</span> accounts<span class="op">.</span>django]<span class="op">;</span></span>
<span id="cb119-15"><a href="#cb119-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb119-16"><a href="#cb119-16" aria-hidden="true" tabindex="-1"></a>        <span class="kw">let</span> initial_total <span class="op">=</span> test_accounts<span class="op">.</span>iter()</span>
<span id="cb119-17"><a href="#cb119-17" aria-hidden="true" tabindex="-1"></a>            <span class="op">.</span>map(<span class="op">|&amp;</span>acc<span class="op">|</span> token<span class="op">.</span>balance_of(acc))</span>
<span id="cb119-18"><a href="#cb119-18" aria-hidden="true" tabindex="-1"></a>            <span class="op">.</span><span class="pp">sum::</span><span class="op">&lt;</span>Balance<span class="op">&gt;</span>()<span class="op">;</span></span>
<span id="cb119-19"><a href="#cb119-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb119-20"><a href="#cb119-20" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> (from_idx<span class="op">,</span> to_idx<span class="op">,</span> amount) <span class="kw">in</span> transfers <span class="op">{</span></span>
<span id="cb119-21"><a href="#cb119-21" aria-hidden="true" tabindex="-1"></a>            <span class="kw">let</span> from_idx <span class="op">=</span> (from_idx <span class="op">%</span> <span class="dv">4</span>) <span class="kw">as</span> <span class="dt">usize</span><span class="op">;</span></span>
<span id="cb119-22"><a href="#cb119-22" aria-hidden="true" tabindex="-1"></a>            <span class="kw">let</span> to_idx <span class="op">=</span> (to_idx <span class="op">%</span> <span class="dv">4</span>) <span class="kw">as</span> <span class="dt">usize</span><span class="op">;</span></span>
<span id="cb119-23"><a href="#cb119-23" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb119-24"><a href="#cb119-24" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> from_idx <span class="op">==</span> to_idx <span class="op">{</span></span>
<span id="cb119-25"><a href="#cb119-25" aria-hidden="true" tabindex="-1"></a>                <span class="cf">continue</span><span class="op">;</span> <span class="co">// Skip self-transfers</span></span>
<span id="cb119-26"><a href="#cb119-26" aria-hidden="true" tabindex="-1"></a>            <span class="op">}</span></span>
<span id="cb119-27"><a href="#cb119-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb119-28"><a href="#cb119-28" aria-hidden="true" tabindex="-1"></a>            <span class="kw">let</span> from <span class="op">=</span> test_accounts[from_idx]<span class="op">;</span></span>
<span id="cb119-29"><a href="#cb119-29" aria-hidden="true" tabindex="-1"></a>            <span class="kw">let</span> to <span class="op">=</span> test_accounts[to_idx]<span class="op">;</span></span>
<span id="cb119-30"><a href="#cb119-30" aria-hidden="true" tabindex="-1"></a>            <span class="kw">let</span> amount <span class="op">=</span> amount <span class="op">%</span> <span class="dv">10000</span><span class="op">;</span> <span class="co">// Reasonable transfer amounts</span></span>
<span id="cb119-31"><a href="#cb119-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb119-32"><a href="#cb119-32" aria-hidden="true" tabindex="-1"></a>            <span class="pp">test::set_caller::</span><span class="op">&lt;</span><span class="pp">ink::env::</span>DefaultEnvironment<span class="op">&gt;</span>(from)<span class="op">;</span></span>
<span id="cb119-33"><a href="#cb119-33" aria-hidden="true" tabindex="-1"></a>            <span class="kw">let</span> _ <span class="op">=</span> token<span class="op">.</span>transfer(to<span class="op">,</span> amount)<span class="op">;</span> <span class="co">// Ignore failures</span></span>
<span id="cb119-34"><a href="#cb119-34" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb119-35"><a href="#cb119-35" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb119-36"><a href="#cb119-36" aria-hidden="true" tabindex="-1"></a>        <span class="kw">let</span> final_total <span class="op">=</span> test_accounts<span class="op">.</span>iter()</span>
<span id="cb119-37"><a href="#cb119-37" aria-hidden="true" tabindex="-1"></a>            <span class="op">.</span>map(<span class="op">|&amp;</span>acc<span class="op">|</span> token<span class="op">.</span>balance_of(acc))</span>
<span id="cb119-38"><a href="#cb119-38" aria-hidden="true" tabindex="-1"></a>            <span class="op">.</span><span class="pp">sum::</span><span class="op">&lt;</span>Balance<span class="op">&gt;</span>()<span class="op">;</span></span>
<span id="cb119-39"><a href="#cb119-39" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb119-40"><a href="#cb119-40" aria-hidden="true" tabindex="-1"></a>        <span class="pp">TestResult::</span>from_bool(initial_total <span class="op">==</span> final_total)</span>
<span id="cb119-41"><a href="#cb119-41" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb119-42"><a href="#cb119-42" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb119-43"><a href="#cb119-43" aria-hidden="true" tabindex="-1"></a>    <span class="co">/// Property: Approve/transfer_from should respect allowances</span></span>
<span id="cb119-44"><a href="#cb119-44" aria-hidden="true" tabindex="-1"></a>    <span class="kw">fn</span> prop_allowance_respected(approvals<span class="op">:</span> <span class="dt">Vec</span><span class="op">&lt;</span>(<span class="dt">u8</span><span class="op">,</span> <span class="dt">u8</span><span class="op">,</span> <span class="dt">u64</span>)<span class="op">&gt;,</span> transfers<span class="op">:</span> <span class="dt">Vec</span><span class="op">&lt;</span>(<span class="dt">u8</span><span class="op">,</span> <span class="dt">u8</span><span class="op">,</span> <span class="dt">u64</span>)<span class="op">&gt;</span>) <span class="op">-&gt;</span> TestResult <span class="op">{</span></span>
<span id="cb119-45"><a href="#cb119-45" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> approvals<span class="op">.</span>len() <span class="op">&gt;</span> <span class="dv">10</span> <span class="op">||</span> transfers<span class="op">.</span>len() <span class="op">&gt;</span> <span class="dv">10</span> <span class="op">{</span></span>
<span id="cb119-46"><a href="#cb119-46" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> <span class="pp">TestResult::</span>discard()<span class="op">;</span></span>
<span id="cb119-47"><a href="#cb119-47" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb119-48"><a href="#cb119-48" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb119-49"><a href="#cb119-49" aria-hidden="true" tabindex="-1"></a>        <span class="kw">let</span> <span class="kw">mut</span> token <span class="op">=</span> setup_contract(<span class="dv">1_000_000</span>)<span class="op">;</span></span>
<span id="cb119-50"><a href="#cb119-50" aria-hidden="true" tabindex="-1"></a>        <span class="kw">let</span> accounts <span class="op">=</span> accounts()<span class="op">;</span></span>
<span id="cb119-51"><a href="#cb119-51" aria-hidden="true" tabindex="-1"></a>        <span class="kw">let</span> test_accounts <span class="op">=</span> [accounts<span class="op">.</span>alice<span class="op">,</span> accounts<span class="op">.</span>bob<span class="op">,</span> accounts<span class="op">.</span>charlie<span class="op">,</span> accounts<span class="op">.</span>django]<span class="op">;</span></span>
<span id="cb119-52"><a href="#cb119-52" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb119-53"><a href="#cb119-53" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Set up approvals</span></span>
<span id="cb119-54"><a href="#cb119-54" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> (owner_idx<span class="op">,</span> spender_idx<span class="op">,</span> amount) <span class="kw">in</span> approvals <span class="op">{</span></span>
<span id="cb119-55"><a href="#cb119-55" aria-hidden="true" tabindex="-1"></a>            <span class="kw">let</span> owner_idx <span class="op">=</span> (owner_idx <span class="op">%</span> <span class="dv">4</span>) <span class="kw">as</span> <span class="dt">usize</span><span class="op">;</span></span>
<span id="cb119-56"><a href="#cb119-56" aria-hidden="true" tabindex="-1"></a>            <span class="kw">let</span> spender_idx <span class="op">=</span> (spender_idx <span class="op">%</span> <span class="dv">4</span>) <span class="kw">as</span> <span class="dt">usize</span><span class="op">;</span></span>
<span id="cb119-57"><a href="#cb119-57" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb119-58"><a href="#cb119-58" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> owner_idx <span class="op">==</span> spender_idx <span class="op">{</span></span>
<span id="cb119-59"><a href="#cb119-59" aria-hidden="true" tabindex="-1"></a>                <span class="cf">continue</span><span class="op">;</span></span>
<span id="cb119-60"><a href="#cb119-60" aria-hidden="true" tabindex="-1"></a>            <span class="op">}</span></span>
<span id="cb119-61"><a href="#cb119-61" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb119-62"><a href="#cb119-62" aria-hidden="true" tabindex="-1"></a>            <span class="kw">let</span> owner <span class="op">=</span> test_accounts[owner_idx]<span class="op">;</span></span>
<span id="cb119-63"><a href="#cb119-63" aria-hidden="true" tabindex="-1"></a>            <span class="kw">let</span> spender <span class="op">=</span> test_accounts[spender_idx]<span class="op">;</span></span>
<span id="cb119-64"><a href="#cb119-64" aria-hidden="true" tabindex="-1"></a>            <span class="kw">let</span> amount <span class="op">=</span> amount <span class="op">%</span> <span class="dv">1000</span><span class="op">;</span></span>
<span id="cb119-65"><a href="#cb119-65" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb119-66"><a href="#cb119-66" aria-hidden="true" tabindex="-1"></a>            <span class="pp">test::set_caller::</span><span class="op">&lt;</span><span class="pp">ink::env::</span>DefaultEnvironment<span class="op">&gt;</span>(owner)<span class="op">;</span></span>
<span id="cb119-67"><a href="#cb119-67" aria-hidden="true" tabindex="-1"></a>            <span class="kw">let</span> _ <span class="op">=</span> token<span class="op">.</span>approve(spender<span class="op">,</span> amount)<span class="op">;</span></span>
<span id="cb119-68"><a href="#cb119-68" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb119-69"><a href="#cb119-69" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb119-70"><a href="#cb119-70" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Test transfers</span></span>
<span id="cb119-71"><a href="#cb119-71" aria-hidden="true" tabindex="-1"></a>        <span class="kw">let</span> <span class="kw">mut</span> all_transfers_valid <span class="op">=</span> <span class="cn">true</span><span class="op">;</span></span>
<span id="cb119-72"><a href="#cb119-72" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb119-73"><a href="#cb119-73" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> (spender_idx<span class="op">,</span> to_idx<span class="op">,</span> amount) <span class="kw">in</span> transfers <span class="op">{</span></span>
<span id="cb119-74"><a href="#cb119-74" aria-hidden="true" tabindex="-1"></a>            <span class="kw">let</span> spender_idx <span class="op">=</span> (spender_idx <span class="op">%</span> <span class="dv">4</span>) <span class="kw">as</span> <span class="dt">usize</span><span class="op">;</span></span>
<span id="cb119-75"><a href="#cb119-75" aria-hidden="true" tabindex="-1"></a>            <span class="kw">let</span> to_idx <span class="op">=</span> (to_idx <span class="op">%</span> <span class="dv">4</span>) <span class="kw">as</span> <span class="dt">usize</span><span class="op">;</span></span>
<span id="cb119-76"><a href="#cb119-76" aria-hidden="true" tabindex="-1"></a>            <span class="kw">let</span> amount <span class="op">=</span> amount <span class="op">%</span> <span class="dv">1000</span><span class="op">;</span></span>
<span id="cb119-77"><a href="#cb119-77" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb119-78"><a href="#cb119-78" aria-hidden="true" tabindex="-1"></a>            <span class="kw">let</span> spender <span class="op">=</span> test_accounts[spender_idx]<span class="op">;</span></span>
<span id="cb119-79"><a href="#cb119-79" aria-hidden="true" tabindex="-1"></a>            <span class="kw">let</span> to <span class="op">=</span> test_accounts[to_idx]<span class="op">;</span></span>
<span id="cb119-80"><a href="#cb119-80" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb119-81"><a href="#cb119-81" aria-hidden="true" tabindex="-1"></a>            <span class="co">// Try transfer from each potential owner</span></span>
<span id="cb119-82"><a href="#cb119-82" aria-hidden="true" tabindex="-1"></a>            <span class="cf">for</span> owner <span class="kw">in</span> <span class="op">&amp;</span>test_accounts <span class="op">{</span></span>
<span id="cb119-83"><a href="#cb119-83" aria-hidden="true" tabindex="-1"></a>                <span class="cf">if</span> <span class="op">*</span>owner <span class="op">==</span> spender <span class="op">{</span></span>
<span id="cb119-84"><a href="#cb119-84" aria-hidden="true" tabindex="-1"></a>                    <span class="cf">continue</span><span class="op">;</span></span>
<span id="cb119-85"><a href="#cb119-85" aria-hidden="true" tabindex="-1"></a>                <span class="op">}</span></span>
<span id="cb119-86"><a href="#cb119-86" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb119-87"><a href="#cb119-87" aria-hidden="true" tabindex="-1"></a>                <span class="pp">test::set_caller::</span><span class="op">&lt;</span><span class="pp">ink::env::</span>DefaultEnvironment<span class="op">&gt;</span>(spender)<span class="op">;</span></span>
<span id="cb119-88"><a href="#cb119-88" aria-hidden="true" tabindex="-1"></a>                <span class="kw">let</span> allowance <span class="op">=</span> token<span class="op">.</span>allowance(<span class="op">*</span>owner<span class="op">,</span> spender)<span class="op">;</span></span>
<span id="cb119-89"><a href="#cb119-89" aria-hidden="true" tabindex="-1"></a>                <span class="kw">let</span> owner_balance <span class="op">=</span> token<span class="op">.</span>balance_of(<span class="op">*</span>owner)<span class="op">;</span></span>
<span id="cb119-90"><a href="#cb119-90" aria-hidden="true" tabindex="-1"></a>                </span>
<span id="cb119-91"><a href="#cb119-91" aria-hidden="true" tabindex="-1"></a>                <span class="kw">let</span> result <span class="op">=</span> token<span class="op">.</span>transfer_from(<span class="op">*</span>owner<span class="op">,</span> to<span class="op">,</span> amount)<span class="op">;</span></span>
<span id="cb119-92"><a href="#cb119-92" aria-hidden="true" tabindex="-1"></a>                </span>
<span id="cb119-93"><a href="#cb119-93" aria-hidden="true" tabindex="-1"></a>                <span class="co">// Transfer should succeed only if allowance and balance are sufficient</span></span>
<span id="cb119-94"><a href="#cb119-94" aria-hidden="true" tabindex="-1"></a>                <span class="kw">let</span> should_succeed <span class="op">=</span> allowance <span class="op">&gt;=</span> amount <span class="op">&amp;&amp;</span> owner_balance <span class="op">&gt;=</span> amount<span class="op">;</span></span>
<span id="cb119-95"><a href="#cb119-95" aria-hidden="true" tabindex="-1"></a>                <span class="kw">let</span> actually_succeeded <span class="op">=</span> result<span class="op">.</span>is_ok()<span class="op">;</span></span>
<span id="cb119-96"><a href="#cb119-96" aria-hidden="true" tabindex="-1"></a>                </span>
<span id="cb119-97"><a href="#cb119-97" aria-hidden="true" tabindex="-1"></a>                <span class="cf">if</span> should_succeed <span class="op">!=</span> actually_succeeded <span class="op">{</span></span>
<span id="cb119-98"><a href="#cb119-98" aria-hidden="true" tabindex="-1"></a>                    all_transfers_valid <span class="op">=</span> <span class="cn">false</span><span class="op">;</span></span>
<span id="cb119-99"><a href="#cb119-99" aria-hidden="true" tabindex="-1"></a>                    <span class="cf">break</span><span class="op">;</span></span>
<span id="cb119-100"><a href="#cb119-100" aria-hidden="true" tabindex="-1"></a>                <span class="op">}</span></span>
<span id="cb119-101"><a href="#cb119-101" aria-hidden="true" tabindex="-1"></a>            <span class="op">}</span></span>
<span id="cb119-102"><a href="#cb119-102" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb119-103"><a href="#cb119-103" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb119-104"><a href="#cb119-104" aria-hidden="true" tabindex="-1"></a>        <span class="pp">TestResult::</span>from_bool(all_transfers_valid)</span>
<span id="cb119-105"><a href="#cb119-105" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb119-106"><a href="#cb119-106" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb119-107"><a href="#cb119-107" aria-hidden="true" tabindex="-1"></a>    <span class="at">#[</span>test<span class="at">]</span></span>
<span id="cb119-108"><a href="#cb119-108" aria-hidden="true" tabindex="-1"></a>    <span class="kw">fn</span> run_property_tests() <span class="op">{</span></span>
<span id="cb119-109"><a href="#cb119-109" aria-hidden="true" tabindex="-1"></a>        quickcheck(prop_total_supply_conservation <span class="kw">as</span> <span class="kw">fn</span>(<span class="dt">Vec</span><span class="op">&lt;</span>(<span class="dt">u8</span><span class="op">,</span> <span class="dt">u8</span><span class="op">,</span> <span class="dt">u64</span>)<span class="op">&gt;</span>) <span class="op">-&gt;</span> TestResult)<span class="op">;</span></span>
<span id="cb119-110"><a href="#cb119-110" aria-hidden="true" tabindex="-1"></a>        quickcheck(prop_allowance_respected <span class="kw">as</span> <span class="kw">fn</span>(<span class="dt">Vec</span><span class="op">&lt;</span>(<span class="dt">u8</span><span class="op">,</span> <span class="dt">u8</span><span class="op">,</span> <span class="dt">u64</span>)<span class="op">&gt;,</span> <span class="dt">Vec</span><span class="op">&lt;</span>(<span class="dt">u8</span><span class="op">,</span> <span class="dt">u8</span><span class="op">,</span> <span class="dt">u64</span>)<span class="op">&gt;</span>) <span class="op">-&gt;</span> TestResult)<span class="op">;</span></span>
<span id="cb119-111"><a href="#cb119-111" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb119-112"><a href="#cb119-112" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<h2 id="integration-testing-contract-interactions">Integration Testing:
Contract Interactions</h2>
<p>Integration tests verify that different parts of your system work
together correctly, including cross-contract calls and event
emission.</p>
<h3 id="testing-event-emission">Testing Event Emission</h3>
<div class="sourceCode" id="cb120"><pre
class="sourceCode rust"><code class="sourceCode rust"><span id="cb120-1"><a href="#cb120-1" aria-hidden="true" tabindex="-1"></a><span class="at">#[</span>cfg<span class="at">(</span>test<span class="at">)]</span></span>
<span id="cb120-2"><a href="#cb120-2" aria-hidden="true" tabindex="-1"></a><span class="kw">mod</span> integration_tests <span class="op">{</span></span>
<span id="cb120-3"><a href="#cb120-3" aria-hidden="true" tabindex="-1"></a>    <span class="kw">use</span> <span class="kw">super</span><span class="pp">::</span><span class="op">*;</span></span>
<span id="cb120-4"><a href="#cb120-4" aria-hidden="true" tabindex="-1"></a>    <span class="kw">use</span> <span class="pp">ink::env::</span>test<span class="op">;</span></span>
<span id="cb120-5"><a href="#cb120-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb120-6"><a href="#cb120-6" aria-hidden="true" tabindex="-1"></a>    <span class="at">#[</span><span class="pp">ink::</span>test<span class="at">]</span></span>
<span id="cb120-7"><a href="#cb120-7" aria-hidden="true" tabindex="-1"></a>    <span class="kw">fn</span> events_are_emitted_correctly() <span class="op">{</span></span>
<span id="cb120-8"><a href="#cb120-8" aria-hidden="true" tabindex="-1"></a>        <span class="kw">let</span> <span class="kw">mut</span> token <span class="op">=</span> setup_contract(<span class="dv">1000</span>)<span class="op">;</span></span>
<span id="cb120-9"><a href="#cb120-9" aria-hidden="true" tabindex="-1"></a>        <span class="kw">let</span> accounts <span class="op">=</span> accounts()<span class="op">;</span></span>
<span id="cb120-10"><a href="#cb120-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb120-11"><a href="#cb120-11" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Clear any existing events</span></span>
<span id="cb120-12"><a href="#cb120-12" aria-hidden="true" tabindex="-1"></a>        <span class="kw">let</span> _ <span class="op">=</span> <span class="pp">test::</span>recorded_events()<span class="op">.</span><span class="pp">collect::</span><span class="op">&lt;</span><span class="dt">Vec</span><span class="op">&lt;</span>_<span class="op">&gt;&gt;</span>()<span class="op">;</span></span>
<span id="cb120-13"><a href="#cb120-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb120-14"><a href="#cb120-14" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Perform transfer</span></span>
<span id="cb120-15"><a href="#cb120-15" aria-hidden="true" tabindex="-1"></a>        <span class="pp">assert_eq!</span>(token<span class="op">.</span>transfer(accounts<span class="op">.</span>bob<span class="op">,</span> <span class="dv">100</span>)<span class="op">,</span> <span class="cn">Ok</span>(()))<span class="op">;</span></span>
<span id="cb120-16"><a href="#cb120-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb120-17"><a href="#cb120-17" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Check that transfer event was emitted</span></span>
<span id="cb120-18"><a href="#cb120-18" aria-hidden="true" tabindex="-1"></a>        <span class="kw">let</span> recorded_events <span class="op">=</span> <span class="pp">test::</span>recorded_events()<span class="op">.</span><span class="pp">collect::</span><span class="op">&lt;</span><span class="dt">Vec</span><span class="op">&lt;</span>_<span class="op">&gt;&gt;</span>()<span class="op">;</span></span>
<span id="cb120-19"><a href="#cb120-19" aria-hidden="true" tabindex="-1"></a>        <span class="pp">assert_eq!</span>(recorded_events<span class="op">.</span>len()<span class="op">,</span> <span class="dv">1</span>)<span class="op">;</span></span>
<span id="cb120-20"><a href="#cb120-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb120-21"><a href="#cb120-21" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Decode and verify event data</span></span>
<span id="cb120-22"><a href="#cb120-22" aria-hidden="true" tabindex="-1"></a>        <span class="kw">let</span> event <span class="op">=</span> <span class="op">&amp;</span>recorded_events[<span class="dv">0</span>]<span class="op">;</span></span>
<span id="cb120-23"><a href="#cb120-23" aria-hidden="true" tabindex="-1"></a>        <span class="pp">assert!</span>(event<span class="op">.</span>topics<span class="op">.</span>len() <span class="op">&gt;=</span> <span class="dv">1</span>)<span class="op">;</span> <span class="co">// Should have at least the event selector</span></span>
<span id="cb120-24"><a href="#cb120-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb120-25"><a href="#cb120-25" aria-hidden="true" tabindex="-1"></a>        <span class="co">// In a real implementation, you would decode the event data</span></span>
<span id="cb120-26"><a href="#cb120-26" aria-hidden="true" tabindex="-1"></a>        <span class="co">// and verify the from, to, and amount fields</span></span>
<span id="cb120-27"><a href="#cb120-27" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb120-28"><a href="#cb120-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb120-29"><a href="#cb120-29" aria-hidden="true" tabindex="-1"></a>    <span class="at">#[</span><span class="pp">ink::</span>test<span class="at">]</span></span>
<span id="cb120-30"><a href="#cb120-30" aria-hidden="true" tabindex="-1"></a>    <span class="kw">fn</span> multiple_events_in_sequence() <span class="op">{</span></span>
<span id="cb120-31"><a href="#cb120-31" aria-hidden="true" tabindex="-1"></a>        <span class="kw">let</span> <span class="kw">mut</span> token <span class="op">=</span> setup_contract(<span class="dv">1000</span>)<span class="op">;</span></span>
<span id="cb120-32"><a href="#cb120-32" aria-hidden="true" tabindex="-1"></a>        <span class="kw">let</span> accounts <span class="op">=</span> accounts()<span class="op">;</span></span>
<span id="cb120-33"><a href="#cb120-33" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb120-34"><a href="#cb120-34" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Clear events</span></span>
<span id="cb120-35"><a href="#cb120-35" aria-hidden="true" tabindex="-1"></a>        <span class="kw">let</span> _ <span class="op">=</span> <span class="pp">test::</span>recorded_events()<span class="op">.</span><span class="pp">collect::</span><span class="op">&lt;</span><span class="dt">Vec</span><span class="op">&lt;</span>_<span class="op">&gt;&gt;</span>()<span class="op">;</span></span>
<span id="cb120-36"><a href="#cb120-36" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb120-37"><a href="#cb120-37" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Perform multiple operations</span></span>
<span id="cb120-38"><a href="#cb120-38" aria-hidden="true" tabindex="-1"></a>        <span class="pp">assert_eq!</span>(token<span class="op">.</span>approve(accounts<span class="op">.</span>bob<span class="op">,</span> <span class="dv">500</span>)<span class="op">,</span> <span class="cn">Ok</span>(()))<span class="op">;</span></span>
<span id="cb120-39"><a href="#cb120-39" aria-hidden="true" tabindex="-1"></a>        <span class="pp">assert_eq!</span>(token<span class="op">.</span>transfer(accounts<span class="op">.</span>charlie<span class="op">,</span> <span class="dv">100</span>)<span class="op">,</span> <span class="cn">Ok</span>(()))<span class="op">;</span></span>
<span id="cb120-40"><a href="#cb120-40" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb120-41"><a href="#cb120-41" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Should have emitted approval and transfer events</span></span>
<span id="cb120-42"><a href="#cb120-42" aria-hidden="true" tabindex="-1"></a>        <span class="kw">let</span> recorded_events <span class="op">=</span> <span class="pp">test::</span>recorded_events()<span class="op">.</span><span class="pp">collect::</span><span class="op">&lt;</span><span class="dt">Vec</span><span class="op">&lt;</span>_<span class="op">&gt;&gt;</span>()<span class="op">;</span></span>
<span id="cb120-43"><a href="#cb120-43" aria-hidden="true" tabindex="-1"></a>        <span class="pp">assert_eq!</span>(recorded_events<span class="op">.</span>len()<span class="op">,</span> <span class="dv">2</span>)<span class="op">;</span></span>
<span id="cb120-44"><a href="#cb120-44" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb120-45"><a href="#cb120-45" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<h3 id="testing-cross-contract-interactions">Testing Cross-Contract
Interactions</h3>
<div class="sourceCode" id="cb121"><pre
class="sourceCode rust"><code class="sourceCode rust"><span id="cb121-1"><a href="#cb121-1" aria-hidden="true" tabindex="-1"></a><span class="co">/// Mock external contract for testing</span></span>
<span id="cb121-2"><a href="#cb121-2" aria-hidden="true" tabindex="-1"></a><span class="at">#[</span><span class="pp">ink::</span>contract<span class="at">]</span></span>
<span id="cb121-3"><a href="#cb121-3" aria-hidden="true" tabindex="-1"></a><span class="kw">mod</span> mock_external_contract <span class="op">{</span></span>
<span id="cb121-4"><a href="#cb121-4" aria-hidden="true" tabindex="-1"></a>    <span class="at">#[</span>ink<span class="at">(</span>storage<span class="at">)]</span></span>
<span id="cb121-5"><a href="#cb121-5" aria-hidden="true" tabindex="-1"></a>    <span class="kw">pub</span> <span class="kw">struct</span> MockExternal <span class="op">{</span></span>
<span id="cb121-6"><a href="#cb121-6" aria-hidden="true" tabindex="-1"></a>        call_count<span class="op">:</span> <span class="dt">u32</span><span class="op">,</span></span>
<span id="cb121-7"><a href="#cb121-7" aria-hidden="true" tabindex="-1"></a>        last_caller<span class="op">:</span> <span class="dt">Option</span><span class="op">&lt;</span>AccountId<span class="op">&gt;,</span></span>
<span id="cb121-8"><a href="#cb121-8" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb121-9"><a href="#cb121-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb121-10"><a href="#cb121-10" aria-hidden="true" tabindex="-1"></a>    <span class="kw">impl</span> MockExternal <span class="op">{</span></span>
<span id="cb121-11"><a href="#cb121-11" aria-hidden="true" tabindex="-1"></a>        <span class="at">#[</span>ink<span class="at">(</span>constructor<span class="at">)]</span></span>
<span id="cb121-12"><a href="#cb121-12" aria-hidden="true" tabindex="-1"></a>        <span class="kw">pub</span> <span class="kw">fn</span> new() <span class="op">-&gt;</span> <span class="dt">Self</span> <span class="op">{</span></span>
<span id="cb121-13"><a href="#cb121-13" aria-hidden="true" tabindex="-1"></a>            <span class="dt">Self</span> <span class="op">{</span></span>
<span id="cb121-14"><a href="#cb121-14" aria-hidden="true" tabindex="-1"></a>                call_count<span class="op">:</span> <span class="dv">0</span><span class="op">,</span></span>
<span id="cb121-15"><a href="#cb121-15" aria-hidden="true" tabindex="-1"></a>                last_caller<span class="op">:</span> <span class="cn">None</span><span class="op">,</span></span>
<span id="cb121-16"><a href="#cb121-16" aria-hidden="true" tabindex="-1"></a>            <span class="op">}</span></span>
<span id="cb121-17"><a href="#cb121-17" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb121-18"><a href="#cb121-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb121-19"><a href="#cb121-19" aria-hidden="true" tabindex="-1"></a>        <span class="at">#[</span>ink<span class="at">(</span>message<span class="at">)]</span></span>
<span id="cb121-20"><a href="#cb121-20" aria-hidden="true" tabindex="-1"></a>        <span class="kw">pub</span> <span class="kw">fn</span> external_function(<span class="op">&amp;</span><span class="kw">mut</span> <span class="kw">self</span><span class="op">,</span> data<span class="op">:</span> <span class="dt">u32</span>) <span class="op">-&gt;</span> <span class="dt">Result</span><span class="op">&lt;</span><span class="dt">u32</span><span class="op">,</span> ()<span class="op">&gt;</span> <span class="op">{</span></span>
<span id="cb121-21"><a href="#cb121-21" aria-hidden="true" tabindex="-1"></a>            <span class="kw">self</span><span class="op">.</span>call_count <span class="op">+=</span> <span class="dv">1</span><span class="op">;</span></span>
<span id="cb121-22"><a href="#cb121-22" aria-hidden="true" tabindex="-1"></a>            <span class="kw">self</span><span class="op">.</span>last_caller <span class="op">=</span> <span class="cn">Some</span>(<span class="kw">self</span><span class="op">.</span>env()<span class="op">.</span>caller())<span class="op">;</span></span>
<span id="cb121-23"><a href="#cb121-23" aria-hidden="true" tabindex="-1"></a>            <span class="cn">Ok</span>(data <span class="op">*</span> <span class="dv">2</span>)</span>
<span id="cb121-24"><a href="#cb121-24" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb121-25"><a href="#cb121-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb121-26"><a href="#cb121-26" aria-hidden="true" tabindex="-1"></a>        <span class="at">#[</span>ink<span class="at">(</span>message<span class="at">)]</span></span>
<span id="cb121-27"><a href="#cb121-27" aria-hidden="true" tabindex="-1"></a>        <span class="kw">pub</span> <span class="kw">fn</span> get_call_count(<span class="op">&amp;</span><span class="kw">self</span>) <span class="op">-&gt;</span> <span class="dt">u32</span> <span class="op">{</span></span>
<span id="cb121-28"><a href="#cb121-28" aria-hidden="true" tabindex="-1"></a>            <span class="kw">self</span><span class="op">.</span>call_count</span>
<span id="cb121-29"><a href="#cb121-29" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb121-30"><a href="#cb121-30" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb121-31"><a href="#cb121-31" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb121-32"><a href="#cb121-32" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb121-33"><a href="#cb121-33" aria-hidden="true" tabindex="-1"></a><span class="co">/// Contract that makes cross-contract calls</span></span>
<span id="cb121-34"><a href="#cb121-34" aria-hidden="true" tabindex="-1"></a><span class="at">#[</span><span class="pp">ink::</span>contract<span class="at">]</span></span>
<span id="cb121-35"><a href="#cb121-35" aria-hidden="true" tabindex="-1"></a><span class="kw">mod</span> cross_contract_caller <span class="op">{</span></span>
<span id="cb121-36"><a href="#cb121-36" aria-hidden="true" tabindex="-1"></a>    <span class="at">#[</span>ink<span class="at">(</span>storage<span class="at">)]</span></span>
<span id="cb121-37"><a href="#cb121-37" aria-hidden="true" tabindex="-1"></a>    <span class="kw">pub</span> <span class="kw">struct</span> CrossContractCaller <span class="op">{</span></span>
<span id="cb121-38"><a href="#cb121-38" aria-hidden="true" tabindex="-1"></a>        external_contract<span class="op">:</span> AccountId<span class="op">,</span></span>
<span id="cb121-39"><a href="#cb121-39" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb121-40"><a href="#cb121-40" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb121-41"><a href="#cb121-41" aria-hidden="true" tabindex="-1"></a>    <span class="kw">impl</span> CrossContractCaller <span class="op">{</span></span>
<span id="cb121-42"><a href="#cb121-42" aria-hidden="true" tabindex="-1"></a>        <span class="at">#[</span>ink<span class="at">(</span>constructor<span class="at">)]</span></span>
<span id="cb121-43"><a href="#cb121-43" aria-hidden="true" tabindex="-1"></a>        <span class="kw">pub</span> <span class="kw">fn</span> new(external_contract<span class="op">:</span> AccountId) <span class="op">-&gt;</span> <span class="dt">Self</span> <span class="op">{</span></span>
<span id="cb121-44"><a href="#cb121-44" aria-hidden="true" tabindex="-1"></a>            <span class="dt">Self</span> <span class="op">{</span> external_contract <span class="op">}</span></span>
<span id="cb121-45"><a href="#cb121-45" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb121-46"><a href="#cb121-46" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb121-47"><a href="#cb121-47" aria-hidden="true" tabindex="-1"></a>        <span class="at">#[</span>ink<span class="at">(</span>message<span class="at">)]</span></span>
<span id="cb121-48"><a href="#cb121-48" aria-hidden="true" tabindex="-1"></a>        <span class="kw">pub</span> <span class="kw">fn</span> call_external(<span class="op">&amp;</span><span class="kw">mut</span> <span class="kw">self</span><span class="op">,</span> data<span class="op">:</span> <span class="dt">u32</span>) <span class="op">-&gt;</span> <span class="dt">Result</span><span class="op">&lt;</span><span class="dt">u32</span><span class="op">,</span> <span class="bu">Error</span><span class="op">&gt;</span> <span class="op">{</span></span>
<span id="cb121-49"><a href="#cb121-49" aria-hidden="true" tabindex="-1"></a>            <span class="co">// Make cross-contract call</span></span>
<span id="cb121-50"><a href="#cb121-50" aria-hidden="true" tabindex="-1"></a>            <span class="kw">let</span> result <span class="op">=</span> <span class="pp">ink::env::call::build_call::</span><span class="op">&lt;</span><span class="pp">ink::env::</span>DefaultEnvironment<span class="op">&gt;</span>()</span>
<span id="cb121-51"><a href="#cb121-51" aria-hidden="true" tabindex="-1"></a>                <span class="op">.</span>call(<span class="kw">self</span><span class="op">.</span>external_contract)</span>
<span id="cb121-52"><a href="#cb121-52" aria-hidden="true" tabindex="-1"></a>                <span class="op">.</span>gas_limit(<span class="dv">5000</span>)</span>
<span id="cb121-53"><a href="#cb121-53" aria-hidden="true" tabindex="-1"></a>                <span class="op">.</span>transferred_value(<span class="dv">0</span>)</span>
<span id="cb121-54"><a href="#cb121-54" aria-hidden="true" tabindex="-1"></a>                <span class="op">.</span>exec_input(</span>
<span id="cb121-55"><a href="#cb121-55" aria-hidden="true" tabindex="-1"></a>                    <span class="pp">ink::env::call::ExecutionInput::</span>new(</span>
<span id="cb121-56"><a href="#cb121-56" aria-hidden="true" tabindex="-1"></a>                        <span class="pp">ink::env::call::Selector::</span>new([<span class="dv">0x12</span><span class="op">,</span> <span class="dv">0x34</span><span class="op">,</span> <span class="dv">0x56</span><span class="op">,</span> <span class="dv">0x78</span>]) <span class="co">// external_function selector</span></span>
<span id="cb121-57"><a href="#cb121-57" aria-hidden="true" tabindex="-1"></a>                    )<span class="op">.</span>push_arg(data)</span>
<span id="cb121-58"><a href="#cb121-58" aria-hidden="true" tabindex="-1"></a>                )</span>
<span id="cb121-59"><a href="#cb121-59" aria-hidden="true" tabindex="-1"></a>                <span class="op">.</span><span class="pp">returns::</span><span class="op">&lt;</span><span class="dt">Result</span><span class="op">&lt;</span><span class="dt">u32</span><span class="op">,</span> ()<span class="op">&gt;&gt;</span>()</span>
<span id="cb121-60"><a href="#cb121-60" aria-hidden="true" tabindex="-1"></a>                <span class="op">.</span>invoke()<span class="op">;</span></span>
<span id="cb121-61"><a href="#cb121-61" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb121-62"><a href="#cb121-62" aria-hidden="true" tabindex="-1"></a>            result<span class="op">.</span>map_err(<span class="op">|</span>_<span class="op">|</span> <span class="bu">Error</span><span class="pp">::</span>ExternalCallFailed)</span>
<span id="cb121-63"><a href="#cb121-63" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb121-64"><a href="#cb121-64" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb121-65"><a href="#cb121-65" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb121-66"><a href="#cb121-66" aria-hidden="true" tabindex="-1"></a>    <span class="at">#[</span>derive<span class="at">(</span><span class="bu">Debug</span><span class="op">,</span> <span class="bu">PartialEq</span><span class="op">,</span> <span class="bu">Eq</span><span class="op">,</span> <span class="pp">scale::</span>Encode<span class="op">,</span> <span class="pp">scale::</span>Decode<span class="at">)]</span></span>
<span id="cb121-67"><a href="#cb121-67" aria-hidden="true" tabindex="-1"></a>    <span class="at">#[</span>cfg_attr<span class="at">(</span>feature <span class="op">=</span> <span class="st">&quot;std&quot;</span><span class="op">,</span> derive<span class="at">(</span><span class="pp">scale_info::</span>TypeInfo<span class="at">))]</span></span>
<span id="cb121-68"><a href="#cb121-68" aria-hidden="true" tabindex="-1"></a>    <span class="kw">pub</span> <span class="kw">enum</span> <span class="bu">Error</span> <span class="op">{</span></span>
<span id="cb121-69"><a href="#cb121-69" aria-hidden="true" tabindex="-1"></a>        ExternalCallFailed<span class="op">,</span></span>
<span id="cb121-70"><a href="#cb121-70" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb121-71"><a href="#cb121-71" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb121-72"><a href="#cb121-72" aria-hidden="true" tabindex="-1"></a>    <span class="at">#[</span>cfg<span class="at">(</span>test<span class="at">)]</span></span>
<span id="cb121-73"><a href="#cb121-73" aria-hidden="true" tabindex="-1"></a>    <span class="kw">mod</span> tests <span class="op">{</span></span>
<span id="cb121-74"><a href="#cb121-74" aria-hidden="true" tabindex="-1"></a>        <span class="kw">use</span> <span class="kw">super</span><span class="pp">::</span><span class="op">*;</span></span>
<span id="cb121-75"><a href="#cb121-75" aria-hidden="true" tabindex="-1"></a>        <span class="kw">use</span> <span class="kw">super</span><span class="pp">::mock_external_contract::</span>MockExternal<span class="op">;</span></span>
<span id="cb121-76"><a href="#cb121-76" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb121-77"><a href="#cb121-77" aria-hidden="true" tabindex="-1"></a>        <span class="at">#[</span><span class="pp">ink::</span>test<span class="at">]</span></span>
<span id="cb121-78"><a href="#cb121-78" aria-hidden="true" tabindex="-1"></a>        <span class="kw">fn</span> cross_contract_call_works() <span class="op">{</span></span>
<span id="cb121-79"><a href="#cb121-79" aria-hidden="true" tabindex="-1"></a>            <span class="co">// Deploy mock external contract</span></span>
<span id="cb121-80"><a href="#cb121-80" aria-hidden="true" tabindex="-1"></a>            <span class="kw">let</span> <span class="kw">mut</span> external <span class="op">=</span> <span class="pp">MockExternal::</span>new()<span class="op">;</span></span>
<span id="cb121-81"><a href="#cb121-81" aria-hidden="true" tabindex="-1"></a>            <span class="kw">let</span> external_address <span class="op">=</span> <span class="pp">AccountId::</span>from([<span class="dv">1</span><span class="op">;</span> <span class="dv">32</span>])<span class="op">;</span></span>
<span id="cb121-82"><a href="#cb121-82" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb121-83"><a href="#cb121-83" aria-hidden="true" tabindex="-1"></a>            <span class="co">// Deploy caller contract</span></span>
<span id="cb121-84"><a href="#cb121-84" aria-hidden="true" tabindex="-1"></a>            <span class="kw">let</span> <span class="kw">mut</span> caller <span class="op">=</span> <span class="pp">CrossContractCaller::</span>new(external_address)<span class="op">;</span></span>
<span id="cb121-85"><a href="#cb121-85" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb121-86"><a href="#cb121-86" aria-hidden="true" tabindex="-1"></a>            <span class="co">// In a real test, you would need to properly set up the cross-contract call</span></span>
<span id="cb121-87"><a href="#cb121-87" aria-hidden="true" tabindex="-1"></a>            <span class="co">// This is a simplified example showing the testing structure</span></span>
<span id="cb121-88"><a href="#cb121-88" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb121-89"><a href="#cb121-89" aria-hidden="true" tabindex="-1"></a>            <span class="co">// Test direct call to external contract</span></span>
<span id="cb121-90"><a href="#cb121-90" aria-hidden="true" tabindex="-1"></a>            <span class="pp">assert_eq!</span>(external<span class="op">.</span>external_function(<span class="dv">5</span>)<span class="op">,</span> <span class="cn">Ok</span>(<span class="dv">10</span>))<span class="op">;</span></span>
<span id="cb121-91"><a href="#cb121-91" aria-hidden="true" tabindex="-1"></a>            <span class="pp">assert_eq!</span>(external<span class="op">.</span>get_call_count()<span class="op">,</span> <span class="dv">1</span>)<span class="op">;</span></span>
<span id="cb121-92"><a href="#cb121-92" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb121-93"><a href="#cb121-93" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb121-94"><a href="#cb121-94" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<h2 id="end-to-end-testing-real-blockchain-interaction">End-to-End
Testing: Real Blockchain Interaction</h2>
<p>End-to-end tests deploy contracts to a real test network and validate
complete user journeys.</p>
<h3 id="e2e-test-structure">E2E Test Structure</h3>
<div class="sourceCode" id="cb122"><pre
class="sourceCode rust"><code class="sourceCode rust"><span id="cb122-1"><a href="#cb122-1" aria-hidden="true" tabindex="-1"></a><span class="at">#[</span>cfg<span class="at">(</span>all<span class="at">(</span>test<span class="op">,</span> feature <span class="op">=</span> <span class="st">&quot;e2e-tests&quot;</span><span class="at">))]</span></span>
<span id="cb122-2"><a href="#cb122-2" aria-hidden="true" tabindex="-1"></a><span class="kw">mod</span> e2e_tests <span class="op">{</span></span>
<span id="cb122-3"><a href="#cb122-3" aria-hidden="true" tabindex="-1"></a>    <span class="kw">use</span> <span class="kw">super</span><span class="pp">::</span><span class="op">*;</span></span>
<span id="cb122-4"><a href="#cb122-4" aria-hidden="true" tabindex="-1"></a>    <span class="kw">use</span> <span class="pp">ink_e2e::</span>build_message<span class="op">;</span></span>
<span id="cb122-5"><a href="#cb122-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb122-6"><a href="#cb122-6" aria-hidden="true" tabindex="-1"></a>    <span class="kw">type</span> E2EResult<span class="op">&lt;</span>T<span class="op">&gt;</span> <span class="op">=</span> <span class="pp">std::result::</span><span class="dt">Result</span><span class="op">&lt;</span>T<span class="op">,</span> <span class="dt">Box</span><span class="op">&lt;</span><span class="kw">dyn</span> <span class="pp">std::error::</span><span class="bu">Error</span><span class="op">&gt;&gt;;</span></span>
<span id="cb122-7"><a href="#cb122-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb122-8"><a href="#cb122-8" aria-hidden="true" tabindex="-1"></a>    <span class="at">#[</span><span class="pp">ink_e2e::</span>test<span class="at">]</span></span>
<span id="cb122-9"><a href="#cb122-9" aria-hidden="true" tabindex="-1"></a>    <span class="kw">async</span> <span class="kw">fn</span> e2e_transfer_works(<span class="kw">mut</span> client<span class="op">:</span> <span class="pp">ink_e2e::</span>Client<span class="op">&lt;</span>C<span class="op">,</span> E<span class="op">&gt;</span>) <span class="op">-&gt;</span> E2EResult<span class="op">&lt;</span>()<span class="op">&gt;</span> <span class="op">{</span></span>
<span id="cb122-10"><a href="#cb122-10" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Deploy the contract</span></span>
<span id="cb122-11"><a href="#cb122-11" aria-hidden="true" tabindex="-1"></a>        <span class="kw">let</span> constructor <span class="op">=</span> <span class="pp">TestableTokenRef::</span>new(<span class="dv">1000</span>)<span class="op">;</span></span>
<span id="cb122-12"><a href="#cb122-12" aria-hidden="true" tabindex="-1"></a>        <span class="kw">let</span> contract_account_id <span class="op">=</span> client</span>
<span id="cb122-13"><a href="#cb122-13" aria-hidden="true" tabindex="-1"></a>            <span class="op">.</span>instantiate(<span class="st">&quot;testable_token&quot;</span><span class="op">,</span> <span class="op">&amp;</span><span class="pp">ink_e2e::</span>alice()<span class="op">,</span> constructor<span class="op">,</span> <span class="dv">0</span><span class="op">,</span> <span class="cn">None</span>)</span>
<span id="cb122-14"><a href="#cb122-14" aria-hidden="true" tabindex="-1"></a>            <span class="op">.</span><span class="kw">await</span></span>
<span id="cb122-15"><a href="#cb122-15" aria-hidden="true" tabindex="-1"></a>            <span class="op">.</span>expect(<span class="st">&quot;instantiate failed&quot;</span>)</span>
<span id="cb122-16"><a href="#cb122-16" aria-hidden="true" tabindex="-1"></a>            <span class="op">.</span>account_id<span class="op">;</span></span>
<span id="cb122-17"><a href="#cb122-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb122-18"><a href="#cb122-18" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Check initial balance</span></span>
<span id="cb122-19"><a href="#cb122-19" aria-hidden="true" tabindex="-1"></a>        <span class="kw">let</span> get_balance <span class="op">=</span> <span class="pp">build_message::</span><span class="op">&lt;</span>TestableTokenRef<span class="op">&gt;</span>(contract_account_id<span class="op">.</span>clone())</span>
<span id="cb122-20"><a href="#cb122-20" aria-hidden="true" tabindex="-1"></a>            <span class="op">.</span>call(<span class="op">|</span>token<span class="op">|</span> token<span class="op">.</span>balance_of(<span class="pp">ink_e2e::</span>alice()<span class="op">.</span>account_id()))<span class="op">;</span></span>
<span id="cb122-21"><a href="#cb122-21" aria-hidden="true" tabindex="-1"></a>        <span class="kw">let</span> balance_result <span class="op">=</span> client<span class="op">.</span>call_dry_run(<span class="op">&amp;</span><span class="pp">ink_e2e::</span>alice()<span class="op">,</span> <span class="op">&amp;</span>get_balance<span class="op">,</span> <span class="dv">0</span><span class="op">,</span> <span class="cn">None</span>)<span class="op">.</span><span class="kw">await</span><span class="op">;</span></span>
<span id="cb122-22"><a href="#cb122-22" aria-hidden="true" tabindex="-1"></a>        <span class="pp">assert_eq!</span>(balance_result<span class="op">.</span>return_value()<span class="op">,</span> <span class="dv">1000</span>)<span class="op">;</span></span>
<span id="cb122-23"><a href="#cb122-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb122-24"><a href="#cb122-24" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Perform transfer</span></span>
<span id="cb122-25"><a href="#cb122-25" aria-hidden="true" tabindex="-1"></a>        <span class="kw">let</span> transfer <span class="op">=</span> <span class="pp">build_message::</span><span class="op">&lt;</span>TestableTokenRef<span class="op">&gt;</span>(contract_account_id<span class="op">.</span>clone())</span>
<span id="cb122-26"><a href="#cb122-26" aria-hidden="true" tabindex="-1"></a>            <span class="op">.</span>call(<span class="op">|</span>token<span class="op">|</span> token<span class="op">.</span>transfer(<span class="pp">ink_e2e::</span>bob()<span class="op">.</span>account_id()<span class="op">,</span> <span class="dv">100</span>))<span class="op">;</span></span>
<span id="cb122-27"><a href="#cb122-27" aria-hidden="true" tabindex="-1"></a>        <span class="kw">let</span> transfer_result <span class="op">=</span> client</span>
<span id="cb122-28"><a href="#cb122-28" aria-hidden="true" tabindex="-1"></a>            <span class="op">.</span>call(<span class="op">&amp;</span><span class="pp">ink_e2e::</span>alice()<span class="op">,</span> transfer<span class="op">,</span> <span class="dv">0</span><span class="op">,</span> <span class="cn">None</span>)</span>
<span id="cb122-29"><a href="#cb122-29" aria-hidden="true" tabindex="-1"></a>            <span class="op">.</span><span class="kw">await</span></span>
<span id="cb122-30"><a href="#cb122-30" aria-hidden="true" tabindex="-1"></a>            <span class="op">.</span>expect(<span class="st">&quot;transfer failed&quot;</span>)<span class="op">;</span></span>
<span id="cb122-31"><a href="#cb122-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb122-32"><a href="#cb122-32" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Verify the transfer succeeded</span></span>
<span id="cb122-33"><a href="#cb122-33" aria-hidden="true" tabindex="-1"></a>        <span class="pp">assert!</span>(transfer_result<span class="op">.</span>return_value()<span class="op">.</span>is_ok())<span class="op">;</span></span>
<span id="cb122-34"><a href="#cb122-34" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb122-35"><a href="#cb122-35" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Check final balances</span></span>
<span id="cb122-36"><a href="#cb122-36" aria-hidden="true" tabindex="-1"></a>        <span class="kw">let</span> alice_balance <span class="op">=</span> <span class="pp">build_message::</span><span class="op">&lt;</span>TestableTokenRef<span class="op">&gt;</span>(contract_account_id<span class="op">.</span>clone())</span>
<span id="cb122-37"><a href="#cb122-37" aria-hidden="true" tabindex="-1"></a>            <span class="op">.</span>call(<span class="op">|</span>token<span class="op">|</span> token<span class="op">.</span>balance_of(<span class="pp">ink_e2e::</span>alice()<span class="op">.</span>account_id()))<span class="op">;</span></span>
<span id="cb122-38"><a href="#cb122-38" aria-hidden="true" tabindex="-1"></a>        <span class="kw">let</span> alice_result <span class="op">=</span> client<span class="op">.</span>call_dry_run(<span class="op">&amp;</span><span class="pp">ink_e2e::</span>alice()<span class="op">,</span> <span class="op">&amp;</span>alice_balance<span class="op">,</span> <span class="dv">0</span><span class="op">,</span> <span class="cn">None</span>)<span class="op">.</span><span class="kw">await</span><span class="op">;</span></span>
<span id="cb122-39"><a href="#cb122-39" aria-hidden="true" tabindex="-1"></a>        <span class="pp">assert_eq!</span>(alice_result<span class="op">.</span>return_value()<span class="op">,</span> <span class="dv">900</span>)<span class="op">;</span></span>
<span id="cb122-40"><a href="#cb122-40" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb122-41"><a href="#cb122-41" aria-hidden="true" tabindex="-1"></a>        <span class="kw">let</span> bob_balance <span class="op">=</span> <span class="pp">build_message::</span><span class="op">&lt;</span>TestableTokenRef<span class="op">&gt;</span>(contract_account_id<span class="op">.</span>clone())</span>
<span id="cb122-42"><a href="#cb122-42" aria-hidden="true" tabindex="-1"></a>            <span class="op">.</span>call(<span class="op">|</span>token<span class="op">|</span> token<span class="op">.</span>balance_of(<span class="pp">ink_e2e::</span>bob()<span class="op">.</span>account_id()))<span class="op">;</span></span>
<span id="cb122-43"><a href="#cb122-43" aria-hidden="true" tabindex="-1"></a>        <span class="kw">let</span> bob_result <span class="op">=</span> client<span class="op">.</span>call_dry_run(<span class="op">&amp;</span><span class="pp">ink_e2e::</span>alice()<span class="op">,</span> <span class="op">&amp;</span>bob_balance<span class="op">,</span> <span class="dv">0</span><span class="op">,</span> <span class="cn">None</span>)<span class="op">.</span><span class="kw">await</span><span class="op">;</span></span>
<span id="cb122-44"><a href="#cb122-44" aria-hidden="true" tabindex="-1"></a>        <span class="pp">assert_eq!</span>(bob_result<span class="op">.</span>return_value()<span class="op">,</span> <span class="dv">100</span>)<span class="op">;</span></span>
<span id="cb122-45"><a href="#cb122-45" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb122-46"><a href="#cb122-46" aria-hidden="true" tabindex="-1"></a>        <span class="cn">Ok</span>(())</span>
<span id="cb122-47"><a href="#cb122-47" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb122-48"><a href="#cb122-48" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb122-49"><a href="#cb122-49" aria-hidden="true" tabindex="-1"></a>    <span class="at">#[</span><span class="pp">ink_e2e::</span>test<span class="at">]</span></span>
<span id="cb122-50"><a href="#cb122-50" aria-hidden="true" tabindex="-1"></a>    <span class="kw">async</span> <span class="kw">fn</span> e2e_approval_workflow(<span class="kw">mut</span> client<span class="op">:</span> <span class="pp">ink_e2e::</span>Client<span class="op">&lt;</span>C<span class="op">,</span> E<span class="op">&gt;</span>) <span class="op">-&gt;</span> E2EResult<span class="op">&lt;</span>()<span class="op">&gt;</span> <span class="op">{</span></span>
<span id="cb122-51"><a href="#cb122-51" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Deploy contract</span></span>
<span id="cb122-52"><a href="#cb122-52" aria-hidden="true" tabindex="-1"></a>        <span class="kw">let</span> constructor <span class="op">=</span> <span class="pp">TestableTokenRef::</span>new(<span class="dv">1000</span>)<span class="op">;</span></span>
<span id="cb122-53"><a href="#cb122-53" aria-hidden="true" tabindex="-1"></a>        <span class="kw">let</span> contract_account_id <span class="op">=</span> client</span>
<span id="cb122-54"><a href="#cb122-54" aria-hidden="true" tabindex="-1"></a>            <span class="op">.</span>instantiate(<span class="st">&quot;testable_token&quot;</span><span class="op">,</span> <span class="op">&amp;</span><span class="pp">ink_e2e::</span>alice()<span class="op">,</span> constructor<span class="op">,</span> <span class="dv">0</span><span class="op">,</span> <span class="cn">None</span>)</span>
<span id="cb122-55"><a href="#cb122-55" aria-hidden="true" tabindex="-1"></a>            <span class="op">.</span><span class="kw">await</span></span>
<span id="cb122-56"><a href="#cb122-56" aria-hidden="true" tabindex="-1"></a>            <span class="op">.</span>expect(<span class="st">&quot;instantiate failed&quot;</span>)</span>
<span id="cb122-57"><a href="#cb122-57" aria-hidden="true" tabindex="-1"></a>            <span class="op">.</span>account_id<span class="op">;</span></span>
<span id="cb122-58"><a href="#cb122-58" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb122-59"><a href="#cb122-59" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Alice approves Bob to spend 500 tokens</span></span>
<span id="cb122-60"><a href="#cb122-60" aria-hidden="true" tabindex="-1"></a>        <span class="kw">let</span> approve <span class="op">=</span> <span class="pp">build_message::</span><span class="op">&lt;</span>TestableTokenRef<span class="op">&gt;</span>(contract_account_id<span class="op">.</span>clone())</span>
<span id="cb122-61"><a href="#cb122-61" aria-hidden="true" tabindex="-1"></a>            <span class="op">.</span>call(<span class="op">|</span>token<span class="op">|</span> token<span class="op">.</span>approve(<span class="pp">ink_e2e::</span>bob()<span class="op">.</span>account_id()<span class="op">,</span> <span class="dv">500</span>))<span class="op">;</span></span>
<span id="cb122-62"><a href="#cb122-62" aria-hidden="true" tabindex="-1"></a>        <span class="kw">let</span> approve_result <span class="op">=</span> client</span>
<span id="cb122-63"><a href="#cb122-63" aria-hidden="true" tabindex="-1"></a>            <span class="op">.</span>call(<span class="op">&amp;</span><span class="pp">ink_e2e::</span>alice()<span class="op">,</span> approve<span class="op">,</span> <span class="dv">0</span><span class="op">,</span> <span class="cn">None</span>)</span>
<span id="cb122-64"><a href="#cb122-64" aria-hidden="true" tabindex="-1"></a>            <span class="op">.</span><span class="kw">await</span></span>
<span id="cb122-65"><a href="#cb122-65" aria-hidden="true" tabindex="-1"></a>            <span class="op">.</span>expect(<span class="st">&quot;approve failed&quot;</span>)<span class="op">;</span></span>
<span id="cb122-66"><a href="#cb122-66" aria-hidden="true" tabindex="-1"></a>        <span class="pp">assert!</span>(approve_result<span class="op">.</span>return_value()<span class="op">.</span>is_ok())<span class="op">;</span></span>
<span id="cb122-67"><a href="#cb122-67" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb122-68"><a href="#cb122-68" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Check allowance</span></span>
<span id="cb122-69"><a href="#cb122-69" aria-hidden="true" tabindex="-1"></a>        <span class="kw">let</span> get_allowance <span class="op">=</span> <span class="pp">build_message::</span><span class="op">&lt;</span>TestableTokenRef<span class="op">&gt;</span>(contract_account_id<span class="op">.</span>clone())</span>
<span id="cb122-70"><a href="#cb122-70" aria-hidden="true" tabindex="-1"></a>            <span class="op">.</span>call(<span class="op">|</span>token<span class="op">|</span> token<span class="op">.</span>allowance(<span class="pp">ink_e2e::</span>alice()<span class="op">.</span>account_id()<span class="op">,</span> <span class="pp">ink_e2e::</span>bob()<span class="op">.</span>account_id()))<span class="op">;</span></span>
<span id="cb122-71"><a href="#cb122-71" aria-hidden="true" tabindex="-1"></a>        <span class="kw">let</span> allowance_result <span class="op">=</span> client<span class="op">.</span>call_dry_run(<span class="op">&amp;</span><span class="pp">ink_e2e::</span>alice()<span class="op">,</span> <span class="op">&amp;</span>get_allowance<span class="op">,</span> <span class="dv">0</span><span class="op">,</span> <span class="cn">None</span>)<span class="op">.</span><span class="kw">await</span><span class="op">;</span></span>
<span id="cb122-72"><a href="#cb122-72" aria-hidden="true" tabindex="-1"></a>        <span class="pp">assert_eq!</span>(allowance_result<span class="op">.</span>return_value()<span class="op">,</span> <span class="dv">500</span>)<span class="op">;</span></span>
<span id="cb122-73"><a href="#cb122-73" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb122-74"><a href="#cb122-74" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Bob transfers 100 tokens from Alice to Charlie</span></span>
<span id="cb122-75"><a href="#cb122-75" aria-hidden="true" tabindex="-1"></a>        <span class="kw">let</span> transfer_from <span class="op">=</span> <span class="pp">build_message::</span><span class="op">&lt;</span>TestableTokenRef<span class="op">&gt;</span>(contract_account_id<span class="op">.</span>clone())</span>
<span id="cb122-76"><a href="#cb122-76" aria-hidden="true" tabindex="-1"></a>            <span class="op">.</span>call(<span class="op">|</span>token<span class="op">|</span> token<span class="op">.</span>transfer_from(</span>
<span id="cb122-77"><a href="#cb122-77" aria-hidden="true" tabindex="-1"></a>                <span class="pp">ink_e2e::</span>alice()<span class="op">.</span>account_id()<span class="op">,</span></span>
<span id="cb122-78"><a href="#cb122-78" aria-hidden="true" tabindex="-1"></a>                <span class="pp">ink_e2e::</span>charlie()<span class="op">.</span>account_id()<span class="op">,</span></span>
<span id="cb122-79"><a href="#cb122-79" aria-hidden="true" tabindex="-1"></a>                <span class="dv">100</span></span>
<span id="cb122-80"><a href="#cb122-80" aria-hidden="true" tabindex="-1"></a>            ))<span class="op">;</span></span>
<span id="cb122-81"><a href="#cb122-81" aria-hidden="true" tabindex="-1"></a>        <span class="kw">let</span> transfer_result <span class="op">=</span> client</span>
<span id="cb122-82"><a href="#cb122-82" aria-hidden="true" tabindex="-1"></a>            <span class="op">.</span>call(<span class="op">&amp;</span><span class="pp">ink_e2e::</span>bob()<span class="op">,</span> transfer_from<span class="op">,</span> <span class="dv">0</span><span class="op">,</span> <span class="cn">None</span>)</span>
<span id="cb122-83"><a href="#cb122-83" aria-hidden="true" tabindex="-1"></a>            <span class="op">.</span><span class="kw">await</span></span>
<span id="cb122-84"><a href="#cb122-84" aria-hidden="true" tabindex="-1"></a>            <span class="op">.</span>expect(<span class="st">&quot;transfer_from failed&quot;</span>)<span class="op">;</span></span>
<span id="cb122-85"><a href="#cb122-85" aria-hidden="true" tabindex="-1"></a>        <span class="pp">assert!</span>(transfer_result<span class="op">.</span>return_value()<span class="op">.</span>is_ok())<span class="op">;</span></span>
<span id="cb122-86"><a href="#cb122-86" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb122-87"><a href="#cb122-87" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Verify final state</span></span>
<span id="cb122-88"><a href="#cb122-88" aria-hidden="true" tabindex="-1"></a>        <span class="kw">let</span> charlie_balance <span class="op">=</span> <span class="pp">build_message::</span><span class="op">&lt;</span>TestableTokenRef<span class="op">&gt;</span>(contract_account_id<span class="op">.</span>clone())</span>
<span id="cb122-89"><a href="#cb122-89" aria-hidden="true" tabindex="-1"></a>            <span class="op">.</span>call(<span class="op">|</span>token<span class="op">|</span> token<span class="op">.</span>balance_of(<span class="pp">ink_e2e::</span>charlie()<span class="op">.</span>account_id()))<span class="op">;</span></span>
<span id="cb122-90"><a href="#cb122-90" aria-hidden="true" tabindex="-1"></a>        <span class="kw">let</span> charlie_result <span class="op">=</span> client<span class="op">.</span>call_dry_run(<span class="op">&amp;</span><span class="pp">ink_e2e::</span>alice()<span class="op">,</span> <span class="op">&amp;</span>charlie_balance<span class="op">,</span> <span class="dv">0</span><span class="op">,</span> <span class="cn">None</span>)<span class="op">.</span><span class="kw">await</span><span class="op">;</span></span>
<span id="cb122-91"><a href="#cb122-91" aria-hidden="true" tabindex="-1"></a>        <span class="pp">assert_eq!</span>(charlie_result<span class="op">.</span>return_value()<span class="op">,</span> <span class="dv">100</span>)<span class="op">;</span></span>
<span id="cb122-92"><a href="#cb122-92" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb122-93"><a href="#cb122-93" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Check remaining allowance</span></span>
<span id="cb122-94"><a href="#cb122-94" aria-hidden="true" tabindex="-1"></a>        <span class="kw">let</span> final_allowance <span class="op">=</span> <span class="pp">build_message::</span><span class="op">&lt;</span>TestableTokenRef<span class="op">&gt;</span>(contract_account_id<span class="op">.</span>clone())</span>
<span id="cb122-95"><a href="#cb122-95" aria-hidden="true" tabindex="-1"></a>            <span class="op">.</span>call(<span class="op">|</span>token<span class="op">|</span> token<span class="op">.</span>allowance(<span class="pp">ink_e2e::</span>alice()<span class="op">.</span>account_id()<span class="op">,</span> <span class="pp">ink_e2e::</span>bob()<span class="op">.</span>account_id()))<span class="op">;</span></span>
<span id="cb122-96"><a href="#cb122-96" aria-hidden="true" tabindex="-1"></a>        <span class="kw">let</span> final_allowance_result <span class="op">=</span> client<span class="op">.</span>call_dry_run(<span class="op">&amp;</span><span class="pp">ink_e2e::</span>alice()<span class="op">,</span> <span class="op">&amp;</span>final_allowance<span class="op">,</span> <span class="dv">0</span><span class="op">,</span> <span class="cn">None</span>)<span class="op">.</span><span class="kw">await</span><span class="op">;</span></span>
<span id="cb122-97"><a href="#cb122-97" aria-hidden="true" tabindex="-1"></a>        <span class="pp">assert_eq!</span>(final_allowance_result<span class="op">.</span>return_value()<span class="op">,</span> <span class="dv">400</span>)<span class="op">;</span></span>
<span id="cb122-98"><a href="#cb122-98" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb122-99"><a href="#cb122-99" aria-hidden="true" tabindex="-1"></a>        <span class="cn">Ok</span>(())</span>
<span id="cb122-100"><a href="#cb122-100" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb122-101"><a href="#cb122-101" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb122-102"><a href="#cb122-102" aria-hidden="true" tabindex="-1"></a>    <span class="at">#[</span><span class="pp">ink_e2e::</span>test<span class="at">]</span></span>
<span id="cb122-103"><a href="#cb122-103" aria-hidden="true" tabindex="-1"></a>    <span class="kw">async</span> <span class="kw">fn</span> e2e_gas_consumption_test(<span class="kw">mut</span> client<span class="op">:</span> <span class="pp">ink_e2e::</span>Client<span class="op">&lt;</span>C<span class="op">,</span> E<span class="op">&gt;</span>) <span class="op">-&gt;</span> E2EResult<span class="op">&lt;</span>()<span class="op">&gt;</span> <span class="op">{</span></span>
<span id="cb122-104"><a href="#cb122-104" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Deploy contract</span></span>
<span id="cb122-105"><a href="#cb122-105" aria-hidden="true" tabindex="-1"></a>        <span class="kw">let</span> constructor <span class="op">=</span> <span class="pp">TestableTokenRef::</span>new(<span class="dv">1000000</span>)<span class="op">;</span></span>
<span id="cb122-106"><a href="#cb122-106" aria-hidden="true" tabindex="-1"></a>        <span class="kw">let</span> contract_account_id <span class="op">=</span> client</span>
<span id="cb122-107"><a href="#cb122-107" aria-hidden="true" tabindex="-1"></a>            <span class="op">.</span>instantiate(<span class="st">&quot;testable_token&quot;</span><span class="op">,</span> <span class="op">&amp;</span><span class="pp">ink_e2e::</span>alice()<span class="op">,</span> constructor<span class="op">,</span> <span class="dv">0</span><span class="op">,</span> <span class="cn">None</span>)</span>
<span id="cb122-108"><a href="#cb122-108" aria-hidden="true" tabindex="-1"></a>            <span class="op">.</span><span class="kw">await</span></span>
<span id="cb122-109"><a href="#cb122-109" aria-hidden="true" tabindex="-1"></a>            <span class="op">.</span>expect(<span class="st">&quot;instantiate failed&quot;</span>)</span>
<span id="cb122-110"><a href="#cb122-110" aria-hidden="true" tabindex="-1"></a>            <span class="op">.</span>account_id<span class="op">;</span></span>
<span id="cb122-111"><a href="#cb122-111" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb122-112"><a href="#cb122-112" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Test gas consumption for different operations</span></span>
<span id="cb122-113"><a href="#cb122-113" aria-hidden="true" tabindex="-1"></a>        <span class="kw">let</span> transfer <span class="op">=</span> <span class="pp">build_message::</span><span class="op">&lt;</span>TestableTokenRef<span class="op">&gt;</span>(contract_account_id<span class="op">.</span>clone())</span>
<span id="cb122-114"><a href="#cb122-114" aria-hidden="true" tabindex="-1"></a>            <span class="op">.</span>call(<span class="op">|</span>token<span class="op">|</span> token<span class="op">.</span>transfer(<span class="pp">ink_e2e::</span>bob()<span class="op">.</span>account_id()<span class="op">,</span> <span class="dv">1000</span>))<span class="op">;</span></span>
<span id="cb122-115"><a href="#cb122-115" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb122-116"><a href="#cb122-116" aria-hidden="true" tabindex="-1"></a>        <span class="kw">let</span> transfer_result <span class="op">=</span> client</span>
<span id="cb122-117"><a href="#cb122-117" aria-hidden="true" tabindex="-1"></a>            <span class="op">.</span>call(<span class="op">&amp;</span><span class="pp">ink_e2e::</span>alice()<span class="op">,</span> transfer<span class="op">,</span> <span class="dv">0</span><span class="op">,</span> <span class="cn">None</span>)</span>
<span id="cb122-118"><a href="#cb122-118" aria-hidden="true" tabindex="-1"></a>            <span class="op">.</span><span class="kw">await</span></span>
<span id="cb122-119"><a href="#cb122-119" aria-hidden="true" tabindex="-1"></a>            <span class="op">.</span>expect(<span class="st">&quot;transfer failed&quot;</span>)<span class="op">;</span></span>
<span id="cb122-120"><a href="#cb122-120" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb122-121"><a href="#cb122-121" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Verify gas consumption is within expected bounds</span></span>
<span id="cb122-122"><a href="#cb122-122" aria-hidden="true" tabindex="-1"></a>        <span class="kw">let</span> gas_consumed <span class="op">=</span> transfer_result<span class="op">.</span>gas_consumed<span class="op">;</span></span>
<span id="cb122-123"><a href="#cb122-123" aria-hidden="true" tabindex="-1"></a>        <span class="pp">assert!</span>(gas_consumed<span class="op">.</span>ref_time() <span class="op">&lt;</span> <span class="dv">1_000_000_000</span>)<span class="op">;</span> <span class="co">// Less than 1 billion gas units</span></span>
<span id="cb122-124"><a href="#cb122-124" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb122-125"><a href="#cb122-125" aria-hidden="true" tabindex="-1"></a>        <span class="pp">println!</span>(<span class="st">&quot;Transfer gas consumed: {}&quot;</span><span class="op">,</span> gas_consumed<span class="op">.</span>ref_time())<span class="op">;</span></span>
<span id="cb122-126"><a href="#cb122-126" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb122-127"><a href="#cb122-127" aria-hidden="true" tabindex="-1"></a>        <span class="cn">Ok</span>(())</span>
<span id="cb122-128"><a href="#cb122-128" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb122-129"><a href="#cb122-129" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<h2 id="security-testing-finding-vulnerabilities">Security Testing:
Finding Vulnerabilities</h2>
<p>Security testing focuses on discovering vulnerabilities that could be
exploited by malicious actors.</p>
<h3 id="testing-access-controls">Testing Access Controls</h3>
<div class="sourceCode" id="cb123"><pre
class="sourceCode rust"><code class="sourceCode rust"><span id="cb123-1"><a href="#cb123-1" aria-hidden="true" tabindex="-1"></a><span class="at">#[</span>cfg<span class="at">(</span>test<span class="at">)]</span></span>
<span id="cb123-2"><a href="#cb123-2" aria-hidden="true" tabindex="-1"></a><span class="kw">mod</span> security_tests <span class="op">{</span></span>
<span id="cb123-3"><a href="#cb123-3" aria-hidden="true" tabindex="-1"></a>    <span class="kw">use</span> <span class="kw">super</span><span class="pp">::</span><span class="op">*;</span></span>
<span id="cb123-4"><a href="#cb123-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb123-5"><a href="#cb123-5" aria-hidden="true" tabindex="-1"></a>    <span class="at">#[</span><span class="pp">ink::</span>test<span class="at">]</span></span>
<span id="cb123-6"><a href="#cb123-6" aria-hidden="true" tabindex="-1"></a>    <span class="kw">fn</span> unauthorized_access_blocked() <span class="op">{</span></span>
<span id="cb123-7"><a href="#cb123-7" aria-hidden="true" tabindex="-1"></a>        <span class="kw">let</span> <span class="kw">mut</span> token <span class="op">=</span> setup_contract(<span class="dv">1000</span>)<span class="op">;</span></span>
<span id="cb123-8"><a href="#cb123-8" aria-hidden="true" tabindex="-1"></a>        <span class="kw">let</span> accounts <span class="op">=</span> accounts()<span class="op">;</span></span>
<span id="cb123-9"><a href="#cb123-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb123-10"><a href="#cb123-10" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Switch to non-owner account</span></span>
<span id="cb123-11"><a href="#cb123-11" aria-hidden="true" tabindex="-1"></a>        <span class="pp">test::set_caller::</span><span class="op">&lt;</span><span class="pp">ink::env::</span>DefaultEnvironment<span class="op">&gt;</span>(accounts<span class="op">.</span>bob)<span class="op">;</span></span>
<span id="cb123-12"><a href="#cb123-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb123-13"><a href="#cb123-13" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Attempt unauthorized operation</span></span>
<span id="cb123-14"><a href="#cb123-14" aria-hidden="true" tabindex="-1"></a>        <span class="pp">assert_eq!</span>(token<span class="op">.</span>pause()<span class="op">,</span> <span class="cn">Err</span>(<span class="bu">Error</span><span class="pp">::</span>Unauthorized))<span class="op">;</span></span>
<span id="cb123-15"><a href="#cb123-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb123-16"><a href="#cb123-16" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Verify state didn&#39;t change</span></span>
<span id="cb123-17"><a href="#cb123-17" aria-hidden="true" tabindex="-1"></a>        <span class="pp">assert!</span>(<span class="op">!</span>token<span class="op">.</span>paused)<span class="op">;</span></span>
<span id="cb123-18"><a href="#cb123-18" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb123-19"><a href="#cb123-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb123-20"><a href="#cb123-20" aria-hidden="true" tabindex="-1"></a>    <span class="at">#[</span><span class="pp">ink::</span>test<span class="at">]</span></span>
<span id="cb123-21"><a href="#cb123-21" aria-hidden="true" tabindex="-1"></a>    <span class="kw">fn</span> reentrancy_protection() <span class="op">{</span></span>
<span id="cb123-22"><a href="#cb123-22" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Test that the contract properly prevents reentrancy attacks</span></span>
<span id="cb123-23"><a href="#cb123-23" aria-hidden="true" tabindex="-1"></a>        <span class="co">// This would typically involve cross-contract calls that attempt</span></span>
<span id="cb123-24"><a href="#cb123-24" aria-hidden="true" tabindex="-1"></a>        <span class="co">// to call back into the original contract</span></span>
<span id="cb123-25"><a href="#cb123-25" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb123-26"><a href="#cb123-26" aria-hidden="true" tabindex="-1"></a>        <span class="kw">let</span> <span class="kw">mut</span> token <span class="op">=</span> setup_contract(<span class="dv">1000</span>)<span class="op">;</span></span>
<span id="cb123-27"><a href="#cb123-27" aria-hidden="true" tabindex="-1"></a>        <span class="kw">let</span> accounts <span class="op">=</span> accounts()<span class="op">;</span></span>
<span id="cb123-28"><a href="#cb123-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb123-29"><a href="#cb123-29" aria-hidden="true" tabindex="-1"></a>        <span class="co">// In a real test, you would set up a malicious contract</span></span>
<span id="cb123-30"><a href="#cb123-30" aria-hidden="true" tabindex="-1"></a>        <span class="co">// that attempts reentrancy and verify it&#39;s blocked</span></span>
<span id="cb123-31"><a href="#cb123-31" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb123-32"><a href="#cb123-32" aria-hidden="true" tabindex="-1"></a>        <span class="co">// For now, test basic transfer functionality</span></span>
<span id="cb123-33"><a href="#cb123-33" aria-hidden="true" tabindex="-1"></a>        <span class="pp">assert_eq!</span>(token<span class="op">.</span>transfer(accounts<span class="op">.</span>bob<span class="op">,</span> <span class="dv">100</span>)<span class="op">,</span> <span class="cn">Ok</span>(()))<span class="op">;</span></span>
<span id="cb123-34"><a href="#cb123-34" aria-hidden="true" tabindex="-1"></a>        <span class="pp">assert_eq!</span>(token<span class="op">.</span>balance_of(accounts<span class="op">.</span>alice)<span class="op">,</span> <span class="dv">900</span>)<span class="op">;</span></span>
<span id="cb123-35"><a href="#cb123-35" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb123-36"><a href="#cb123-36" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb123-37"><a href="#cb123-37" aria-hidden="true" tabindex="-1"></a>    <span class="at">#[</span><span class="pp">ink::</span>test<span class="at">]</span></span>
<span id="cb123-38"><a href="#cb123-38" aria-hidden="true" tabindex="-1"></a>    <span class="kw">fn</span> integer_overflow_protection() <span class="op">{</span></span>
<span id="cb123-39"><a href="#cb123-39" aria-hidden="true" tabindex="-1"></a>        <span class="kw">let</span> max_supply <span class="op">=</span> <span class="pp">Balance::</span><span class="cn">MAX</span><span class="op">;</span></span>
<span id="cb123-40"><a href="#cb123-40" aria-hidden="true" tabindex="-1"></a>        <span class="kw">let</span> <span class="kw">mut</span> token <span class="op">=</span> setup_contract(max_supply)<span class="op">;</span></span>
<span id="cb123-41"><a href="#cb123-41" aria-hidden="true" tabindex="-1"></a>        <span class="kw">let</span> accounts <span class="op">=</span> accounts()<span class="op">;</span></span>
<span id="cb123-42"><a href="#cb123-42" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb123-43"><a href="#cb123-43" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Transfer all tokens to Bob</span></span>
<span id="cb123-44"><a href="#cb123-44" aria-hidden="true" tabindex="-1"></a>        <span class="pp">assert_eq!</span>(token<span class="op">.</span>transfer(accounts<span class="op">.</span>bob<span class="op">,</span> max_supply)<span class="op">,</span> <span class="cn">Ok</span>(()))<span class="op">;</span></span>
<span id="cb123-45"><a href="#cb123-45" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb123-46"><a href="#cb123-46" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Switch to Bob&#39;s account</span></span>
<span id="cb123-47"><a href="#cb123-47" aria-hidden="true" tabindex="-1"></a>        <span class="pp">test::set_caller::</span><span class="op">&lt;</span><span class="pp">ink::env::</span>DefaultEnvironment<span class="op">&gt;</span>(accounts<span class="op">.</span>bob)<span class="op">;</span></span>
<span id="cb123-48"><a href="#cb123-48" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb123-49"><a href="#cb123-49" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Attempt to cause overflow by transferring to an account with MAX balance</span></span>
<span id="cb123-50"><a href="#cb123-50" aria-hidden="true" tabindex="-1"></a>        <span class="co">// This should be prevented by proper overflow checks</span></span>
<span id="cb123-51"><a href="#cb123-51" aria-hidden="true" tabindex="-1"></a>        <span class="pp">test::set_caller::</span><span class="op">&lt;</span><span class="pp">ink::env::</span>DefaultEnvironment<span class="op">&gt;</span>(accounts<span class="op">.</span>alice)<span class="op">;</span></span>
<span id="cb123-52"><a href="#cb123-52" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb123-53"><a href="#cb123-53" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Create a scenario that could cause overflow</span></span>
<span id="cb123-54"><a href="#cb123-54" aria-hidden="true" tabindex="-1"></a>        <span class="kw">let</span> large_amount <span class="op">=</span> <span class="pp">Balance::</span><span class="cn">MAX</span> <span class="op">/</span> <span class="dv">2</span><span class="op">;</span></span>
<span id="cb123-55"><a href="#cb123-55" aria-hidden="true" tabindex="-1"></a>        <span class="kw">let</span> <span class="kw">mut</span> balances <span class="op">=</span> <span class="pp">std::collections::HashMap::</span>new()<span class="op">;</span></span>
<span id="cb123-56"><a href="#cb123-56" aria-hidden="true" tabindex="-1"></a>        balances<span class="op">.</span>insert(accounts<span class="op">.</span>alice<span class="op">,</span> large_amount)<span class="op">;</span></span>
<span id="cb123-57"><a href="#cb123-57" aria-hidden="true" tabindex="-1"></a>        balances<span class="op">.</span>insert(accounts<span class="op">.</span>bob<span class="op">,</span> large_amount)<span class="op">;</span></span>
<span id="cb123-58"><a href="#cb123-58" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb123-59"><a href="#cb123-59" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Verify that transfers prevent overflow</span></span>
<span id="cb123-60"><a href="#cb123-60" aria-hidden="true" tabindex="-1"></a>        <span class="co">// (Implementation would depend on specific overflow protection mechanisms)</span></span>
<span id="cb123-61"><a href="#cb123-61" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb123-62"><a href="#cb123-62" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb123-63"><a href="#cb123-63" aria-hidden="true" tabindex="-1"></a>    <span class="at">#[</span><span class="pp">ink::</span>test<span class="at">]</span></span>
<span id="cb123-64"><a href="#cb123-64" aria-hidden="true" tabindex="-1"></a>    <span class="kw">fn</span> front_running_resistance() <span class="op">{</span></span>
<span id="cb123-65"><a href="#cb123-65" aria-hidden="true" tabindex="-1"></a>        <span class="kw">let</span> <span class="kw">mut</span> token <span class="op">=</span> setup_contract(<span class="dv">1000</span>)<span class="op">;</span></span>
<span id="cb123-66"><a href="#cb123-66" aria-hidden="true" tabindex="-1"></a>        <span class="kw">let</span> accounts <span class="op">=</span> accounts()<span class="op">;</span></span>
<span id="cb123-67"><a href="#cb123-67" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb123-68"><a href="#cb123-68" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Test that the contract is resistant to front-running attacks</span></span>
<span id="cb123-69"><a href="#cb123-69" aria-hidden="true" tabindex="-1"></a>        <span class="co">// This might involve testing timestamp-dependent operations</span></span>
<span id="cb123-70"><a href="#cb123-70" aria-hidden="true" tabindex="-1"></a>        <span class="co">// or operations that should be atomic</span></span>
<span id="cb123-71"><a href="#cb123-71" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb123-72"><a href="#cb123-72" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Set up initial approval</span></span>
<span id="cb123-73"><a href="#cb123-73" aria-hidden="true" tabindex="-1"></a>        <span class="pp">assert_eq!</span>(token<span class="op">.</span>approve(accounts<span class="op">.</span>bob<span class="op">,</span> <span class="dv">500</span>)<span class="op">,</span> <span class="cn">Ok</span>(()))<span class="op">;</span></span>
<span id="cb123-74"><a href="#cb123-74" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb123-75"><a href="#cb123-75" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Simulate a scenario where Alice tries to change approval</span></span>
<span id="cb123-76"><a href="#cb123-76" aria-hidden="true" tabindex="-1"></a>        <span class="co">// while Bob tries to use the existing approval</span></span>
<span id="cb123-77"><a href="#cb123-77" aria-hidden="true" tabindex="-1"></a>        <span class="pp">assert_eq!</span>(token<span class="op">.</span>approve(accounts<span class="op">.</span>bob<span class="op">,</span> <span class="dv">100</span>)<span class="op">,</span> <span class="cn">Ok</span>(()))<span class="op">;</span></span>
<span id="cb123-78"><a href="#cb123-78" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb123-79"><a href="#cb123-79" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Switch to Bob and try to use old allowance</span></span>
<span id="cb123-80"><a href="#cb123-80" aria-hidden="true" tabindex="-1"></a>        <span class="pp">test::set_caller::</span><span class="op">&lt;</span><span class="pp">ink::env::</span>DefaultEnvironment<span class="op">&gt;</span>(accounts<span class="op">.</span>bob)<span class="op">;</span></span>
<span id="cb123-81"><a href="#cb123-81" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb123-82"><a href="#cb123-82" aria-hidden="true" tabindex="-1"></a>        <span class="co">// This should use the new allowance amount, not the old one</span></span>
<span id="cb123-83"><a href="#cb123-83" aria-hidden="true" tabindex="-1"></a>        <span class="pp">assert_eq!</span>(</span>
<span id="cb123-84"><a href="#cb123-84" aria-hidden="true" tabindex="-1"></a>            token<span class="op">.</span>transfer_from(accounts<span class="op">.</span>alice<span class="op">,</span> accounts<span class="op">.</span>charlie<span class="op">,</span> <span class="dv">200</span>)<span class="op">,</span></span>
<span id="cb123-85"><a href="#cb123-85" aria-hidden="true" tabindex="-1"></a>            <span class="cn">Err</span>(<span class="bu">Error</span><span class="pp">::</span>InsufficientAllowance)</span>
<span id="cb123-86"><a href="#cb123-86" aria-hidden="true" tabindex="-1"></a>        )<span class="op">;</span></span>
<span id="cb123-87"><a href="#cb123-87" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb123-88"><a href="#cb123-88" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb123-89"><a href="#cb123-89" aria-hidden="true" tabindex="-1"></a>    <span class="at">#[</span><span class="pp">ink::</span>test<span class="at">]</span></span>
<span id="cb123-90"><a href="#cb123-90" aria-hidden="true" tabindex="-1"></a>    <span class="kw">fn</span> denial_of_service_resistance() <span class="op">{</span></span>
<span id="cb123-91"><a href="#cb123-91" aria-hidden="true" tabindex="-1"></a>        <span class="kw">let</span> <span class="kw">mut</span> token <span class="op">=</span> setup_contract(<span class="dv">1000</span>)<span class="op">;</span></span>
<span id="cb123-92"><a href="#cb123-92" aria-hidden="true" tabindex="-1"></a>        <span class="kw">let</span> accounts <span class="op">=</span> accounts()<span class="op">;</span></span>
<span id="cb123-93"><a href="#cb123-93" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb123-94"><a href="#cb123-94" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Test that the contract handles resource exhaustion gracefully</span></span>
<span id="cb123-95"><a href="#cb123-95" aria-hidden="true" tabindex="-1"></a>        <span class="co">// For example, operations with large arrays or loops</span></span>
<span id="cb123-96"><a href="#cb123-96" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb123-97"><a href="#cb123-97" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Simulate many small operations</span></span>
<span id="cb123-98"><a href="#cb123-98" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> i <span class="kw">in</span> <span class="dv">1</span><span class="op">..</span><span class="dv">100</span> <span class="op">{</span></span>
<span id="cb123-99"><a href="#cb123-99" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> i <span class="op">%</span> <span class="dv">2</span> <span class="op">==</span> <span class="dv">0</span> <span class="op">{</span></span>
<span id="cb123-100"><a href="#cb123-100" aria-hidden="true" tabindex="-1"></a>                <span class="pp">test::set_caller::</span><span class="op">&lt;</span><span class="pp">ink::env::</span>DefaultEnvironment<span class="op">&gt;</span>(accounts<span class="op">.</span>alice)<span class="op">;</span></span>
<span id="cb123-101"><a href="#cb123-101" aria-hidden="true" tabindex="-1"></a>                <span class="kw">let</span> _ <span class="op">=</span> token<span class="op">.</span>transfer(accounts<span class="op">.</span>bob<span class="op">,</span> <span class="dv">1</span>)<span class="op">;</span></span>
<span id="cb123-102"><a href="#cb123-102" aria-hidden="true" tabindex="-1"></a>            <span class="op">}</span> <span class="cf">else</span> <span class="op">{</span></span>
<span id="cb123-103"><a href="#cb123-103" aria-hidden="true" tabindex="-1"></a>                <span class="pp">test::set_caller::</span><span class="op">&lt;</span><span class="pp">ink::env::</span>DefaultEnvironment<span class="op">&gt;</span>(accounts<span class="op">.</span>bob)<span class="op">;</span></span>
<span id="cb123-104"><a href="#cb123-104" aria-hidden="true" tabindex="-1"></a>                <span class="kw">let</span> _ <span class="op">=</span> token<span class="op">.</span>transfer(accounts<span class="op">.</span>alice<span class="op">,</span> <span class="dv">1</span>)<span class="op">;</span></span>
<span id="cb123-105"><a href="#cb123-105" aria-hidden="true" tabindex="-1"></a>            <span class="op">}</span></span>
<span id="cb123-106"><a href="#cb123-106" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb123-107"><a href="#cb123-107" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb123-108"><a href="#cb123-108" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Contract should still be functional</span></span>
<span id="cb123-109"><a href="#cb123-109" aria-hidden="true" tabindex="-1"></a>        <span class="pp">test::set_caller::</span><span class="op">&lt;</span><span class="pp">ink::env::</span>DefaultEnvironment<span class="op">&gt;</span>(accounts<span class="op">.</span>alice)<span class="op">;</span></span>
<span id="cb123-110"><a href="#cb123-110" aria-hidden="true" tabindex="-1"></a>        <span class="pp">assert_eq!</span>(token<span class="op">.</span>transfer(accounts<span class="op">.</span>charlie<span class="op">,</span> <span class="dv">10</span>)<span class="op">,</span> <span class="cn">Ok</span>(()))<span class="op">;</span></span>
<span id="cb123-111"><a href="#cb123-111" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb123-112"><a href="#cb123-112" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<h3 id="fuzz-testing">Fuzz Testing</h3>
<div class="sourceCode" id="cb124"><pre
class="sourceCode rust"><code class="sourceCode rust"><span id="cb124-1"><a href="#cb124-1" aria-hidden="true" tabindex="-1"></a><span class="at">#[</span>cfg<span class="at">(</span>test<span class="at">)]</span></span>
<span id="cb124-2"><a href="#cb124-2" aria-hidden="true" tabindex="-1"></a><span class="kw">mod</span> fuzz_tests <span class="op">{</span></span>
<span id="cb124-3"><a href="#cb124-3" aria-hidden="true" tabindex="-1"></a>    <span class="kw">use</span> <span class="kw">super</span><span class="pp">::</span><span class="op">*;</span></span>
<span id="cb124-4"><a href="#cb124-4" aria-hidden="true" tabindex="-1"></a>    <span class="kw">use</span> <span class="pp">arbitrary::</span><span class="op">{</span>Arbitrary<span class="op">,</span> Unstructured<span class="op">};</span></span>
<span id="cb124-5"><a href="#cb124-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb124-6"><a href="#cb124-6" aria-hidden="true" tabindex="-1"></a>    <span class="at">#[</span>derive<span class="at">(</span><span class="bu">Debug</span><span class="op">,</span> <span class="bu">Clone</span><span class="op">,</span> Arbitrary<span class="at">)]</span></span>
<span id="cb124-7"><a href="#cb124-7" aria-hidden="true" tabindex="-1"></a>    <span class="kw">enum</span> Action <span class="op">{</span></span>
<span id="cb124-8"><a href="#cb124-8" aria-hidden="true" tabindex="-1"></a>        Transfer <span class="op">{</span> to<span class="op">:</span> <span class="dt">u8</span><span class="op">,</span> amount<span class="op">:</span> <span class="dt">u64</span> <span class="op">},</span></span>
<span id="cb124-9"><a href="#cb124-9" aria-hidden="true" tabindex="-1"></a>        Approve <span class="op">{</span> spender<span class="op">:</span> <span class="dt">u8</span><span class="op">,</span> amount<span class="op">:</span> <span class="dt">u64</span> <span class="op">},</span></span>
<span id="cb124-10"><a href="#cb124-10" aria-hidden="true" tabindex="-1"></a>        TransferFrom <span class="op">{</span> from<span class="op">:</span> <span class="dt">u8</span><span class="op">,</span> to<span class="op">:</span> <span class="dt">u8</span><span class="op">,</span> amount<span class="op">:</span> <span class="dt">u64</span> <span class="op">},</span></span>
<span id="cb124-11"><a href="#cb124-11" aria-hidden="true" tabindex="-1"></a>        Pause<span class="op">,</span></span>
<span id="cb124-12"><a href="#cb124-12" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb124-13"><a href="#cb124-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb124-14"><a href="#cb124-14" aria-hidden="true" tabindex="-1"></a>    <span class="at">#[</span>derive<span class="at">(</span><span class="bu">Debug</span><span class="op">,</span> <span class="bu">Clone</span><span class="op">,</span> Arbitrary<span class="at">)]</span></span>
<span id="cb124-15"><a href="#cb124-15" aria-hidden="true" tabindex="-1"></a>    <span class="kw">struct</span> TestScenario <span class="op">{</span></span>
<span id="cb124-16"><a href="#cb124-16" aria-hidden="true" tabindex="-1"></a>        initial_supply<span class="op">:</span> <span class="dt">u64</span><span class="op">,</span></span>
<span id="cb124-17"><a href="#cb124-17" aria-hidden="true" tabindex="-1"></a>        actions<span class="op">:</span> <span class="dt">Vec</span><span class="op">&lt;</span>Action<span class="op">&gt;,</span></span>
<span id="cb124-18"><a href="#cb124-18" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb124-19"><a href="#cb124-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb124-20"><a href="#cb124-20" aria-hidden="true" tabindex="-1"></a>    <span class="kw">fn</span> run_fuzz_test(scenario<span class="op">:</span> TestScenario) <span class="op">-&gt;</span> <span class="dt">bool</span> <span class="op">{</span></span>
<span id="cb124-21"><a href="#cb124-21" aria-hidden="true" tabindex="-1"></a>        <span class="kw">let</span> initial_supply <span class="op">=</span> scenario<span class="op">.</span>initial_supply <span class="op">%</span> <span class="dv">1_000_000</span><span class="op">;</span> <span class="co">// Reasonable bounds</span></span>
<span id="cb124-22"><a href="#cb124-22" aria-hidden="true" tabindex="-1"></a>        <span class="kw">let</span> <span class="kw">mut</span> token <span class="op">=</span> setup_contract(initial_supply)<span class="op">;</span></span>
<span id="cb124-23"><a href="#cb124-23" aria-hidden="true" tabindex="-1"></a>        <span class="kw">let</span> accounts <span class="op">=</span> accounts()<span class="op">;</span></span>
<span id="cb124-24"><a href="#cb124-24" aria-hidden="true" tabindex="-1"></a>        <span class="kw">let</span> test_accounts <span class="op">=</span> [accounts<span class="op">.</span>alice<span class="op">,</span> accounts<span class="op">.</span>bob<span class="op">,</span> accounts<span class="op">.</span>charlie<span class="op">,</span> accounts<span class="op">.</span>django]<span class="op">;</span></span>
<span id="cb124-25"><a href="#cb124-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb124-26"><a href="#cb124-26" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> action <span class="kw">in</span> scenario<span class="op">.</span>actions<span class="op">.</span>iter()<span class="op">.</span>take(<span class="dv">50</span>) <span class="op">{</span> <span class="co">// Limit action count</span></span>
<span id="cb124-27"><a href="#cb124-27" aria-hidden="true" tabindex="-1"></a>            <span class="cf">match</span> action <span class="op">{</span></span>
<span id="cb124-28"><a href="#cb124-28" aria-hidden="true" tabindex="-1"></a>                <span class="pp">Action::</span>Transfer <span class="op">{</span> to<span class="op">,</span> amount <span class="op">}</span> <span class="op">=&gt;</span> <span class="op">{</span></span>
<span id="cb124-29"><a href="#cb124-29" aria-hidden="true" tabindex="-1"></a>                    <span class="kw">let</span> to_idx <span class="op">=</span> (<span class="op">*</span>to <span class="op">%</span> <span class="dv">4</span>) <span class="kw">as</span> <span class="dt">usize</span><span class="op">;</span></span>
<span id="cb124-30"><a href="#cb124-30" aria-hidden="true" tabindex="-1"></a>                    <span class="kw">let</span> to_account <span class="op">=</span> test_accounts[to_idx]<span class="op">;</span></span>
<span id="cb124-31"><a href="#cb124-31" aria-hidden="true" tabindex="-1"></a>                    <span class="kw">let</span> amount <span class="op">=</span> amount <span class="op">%</span> <span class="dv">10000</span><span class="op">;</span> <span class="co">// Reasonable amount</span></span>
<span id="cb124-32"><a href="#cb124-32" aria-hidden="true" tabindex="-1"></a>                    </span>
<span id="cb124-33"><a href="#cb124-33" aria-hidden="true" tabindex="-1"></a>                    <span class="kw">let</span> _ <span class="op">=</span> token<span class="op">.</span>transfer(to_account<span class="op">,</span> amount)<span class="op">;</span></span>
<span id="cb124-34"><a href="#cb124-34" aria-hidden="true" tabindex="-1"></a>                <span class="op">}</span></span>
<span id="cb124-35"><a href="#cb124-35" aria-hidden="true" tabindex="-1"></a>                <span class="pp">Action::</span>Approve <span class="op">{</span> spender<span class="op">,</span> amount <span class="op">}</span> <span class="op">=&gt;</span> <span class="op">{</span></span>
<span id="cb124-36"><a href="#cb124-36" aria-hidden="true" tabindex="-1"></a>                    <span class="kw">let</span> spender_idx <span class="op">=</span> (<span class="op">*</span>spender <span class="op">%</span> <span class="dv">4</span>) <span class="kw">as</span> <span class="dt">usize</span><span class="op">;</span></span>
<span id="cb124-37"><a href="#cb124-37" aria-hidden="true" tabindex="-1"></a>                    <span class="kw">let</span> spender_account <span class="op">=</span> test_accounts[spender_idx]<span class="op">;</span></span>
<span id="cb124-38"><a href="#cb124-38" aria-hidden="true" tabindex="-1"></a>                    <span class="kw">let</span> amount <span class="op">=</span> amount <span class="op">%</span> <span class="dv">10000</span><span class="op">;</span></span>
<span id="cb124-39"><a href="#cb124-39" aria-hidden="true" tabindex="-1"></a>                    </span>
<span id="cb124-40"><a href="#cb124-40" aria-hidden="true" tabindex="-1"></a>                    <span class="kw">let</span> _ <span class="op">=</span> token<span class="op">.</span>approve(spender_account<span class="op">,</span> amount)<span class="op">;</span></span>
<span id="cb124-41"><a href="#cb124-41" aria-hidden="true" tabindex="-1"></a>                <span class="op">}</span></span>
<span id="cb124-42"><a href="#cb124-42" aria-hidden="true" tabindex="-1"></a>                <span class="pp">Action::</span>TransferFrom <span class="op">{</span> from<span class="op">,</span> to<span class="op">,</span> amount <span class="op">}</span> <span class="op">=&gt;</span> <span class="op">{</span></span>
<span id="cb124-43"><a href="#cb124-43" aria-hidden="true" tabindex="-1"></a>                    <span class="kw">let</span> from_idx <span class="op">=</span> (<span class="op">*</span>from <span class="op">%</span> <span class="dv">4</span>) <span class="kw">as</span> <span class="dt">usize</span><span class="op">;</span></span>
<span id="cb124-44"><a href="#cb124-44" aria-hidden="true" tabindex="-1"></a>                    <span class="kw">let</span> to_idx <span class="op">=</span> (<span class="op">*</span>to <span class="op">%</span> <span class="dv">4</span>) <span class="kw">as</span> <span class="dt">usize</span><span class="op">;</span></span>
<span id="cb124-45"><a href="#cb124-45" aria-hidden="true" tabindex="-1"></a>                    <span class="kw">let</span> from_account <span class="op">=</span> test_accounts[from_idx]<span class="op">;</span></span>
<span id="cb124-46"><a href="#cb124-46" aria-hidden="true" tabindex="-1"></a>                    <span class="kw">let</span> to_account <span class="op">=</span> test_accounts[to_idx]<span class="op">;</span></span>
<span id="cb124-47"><a href="#cb124-47" aria-hidden="true" tabindex="-1"></a>                    <span class="kw">let</span> amount <span class="op">=</span> amount <span class="op">%</span> <span class="dv">10000</span><span class="op">;</span></span>
<span id="cb124-48"><a href="#cb124-48" aria-hidden="true" tabindex="-1"></a>                    </span>
<span id="cb124-49"><a href="#cb124-49" aria-hidden="true" tabindex="-1"></a>                    <span class="kw">let</span> _ <span class="op">=</span> token<span class="op">.</span>transfer_from(from_account<span class="op">,</span> to_account<span class="op">,</span> amount)<span class="op">;</span></span>
<span id="cb124-50"><a href="#cb124-50" aria-hidden="true" tabindex="-1"></a>                <span class="op">}</span></span>
<span id="cb124-51"><a href="#cb124-51" aria-hidden="true" tabindex="-1"></a>                <span class="pp">Action::</span>Pause <span class="op">=&gt;</span> <span class="op">{</span></span>
<span id="cb124-52"><a href="#cb124-52" aria-hidden="true" tabindex="-1"></a>                    <span class="co">// Only Alice (owner) can pause</span></span>
<span id="cb124-53"><a href="#cb124-53" aria-hidden="true" tabindex="-1"></a>                    <span class="pp">test::set_caller::</span><span class="op">&lt;</span><span class="pp">ink::env::</span>DefaultEnvironment<span class="op">&gt;</span>(accounts<span class="op">.</span>alice)<span class="op">;</span></span>
<span id="cb124-54"><a href="#cb124-54" aria-hidden="true" tabindex="-1"></a>                    <span class="kw">let</span> _ <span class="op">=</span> token<span class="op">.</span>pause()<span class="op">;</span></span>
<span id="cb124-55"><a href="#cb124-55" aria-hidden="true" tabindex="-1"></a>                <span class="op">}</span></span>
<span id="cb124-56"><a href="#cb124-56" aria-hidden="true" tabindex="-1"></a>            <span class="op">}</span></span>
<span id="cb124-57"><a href="#cb124-57" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb124-58"><a href="#cb124-58" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb124-59"><a href="#cb124-59" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Check invariants</span></span>
<span id="cb124-60"><a href="#cb124-60" aria-hidden="true" tabindex="-1"></a>        <span class="kw">let</span> total_balance<span class="op">:</span> Balance <span class="op">=</span> test_accounts<span class="op">.</span>iter()</span>
<span id="cb124-61"><a href="#cb124-61" aria-hidden="true" tabindex="-1"></a>            <span class="op">.</span>map(<span class="op">|&amp;</span>acc<span class="op">|</span> token<span class="op">.</span>balance_of(acc))</span>
<span id="cb124-62"><a href="#cb124-62" aria-hidden="true" tabindex="-1"></a>            <span class="op">.</span>sum()<span class="op">;</span></span>
<span id="cb124-63"><a href="#cb124-63" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb124-64"><a href="#cb124-64" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Total balance should not exceed initial supply</span></span>
<span id="cb124-65"><a href="#cb124-65" aria-hidden="true" tabindex="-1"></a>        total_balance <span class="op">&lt;=</span> initial_supply</span>
<span id="cb124-66"><a href="#cb124-66" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb124-67"><a href="#cb124-67" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb124-68"><a href="#cb124-68" aria-hidden="true" tabindex="-1"></a>    <span class="at">#[</span>test<span class="at">]</span></span>
<span id="cb124-69"><a href="#cb124-69" aria-hidden="true" tabindex="-1"></a>    <span class="kw">fn</span> fuzz_test_invariants() <span class="op">{</span></span>
<span id="cb124-70"><a href="#cb124-70" aria-hidden="true" tabindex="-1"></a>        <span class="co">// In a real implementation, you would use a proper fuzzing framework</span></span>
<span id="cb124-71"><a href="#cb124-71" aria-hidden="true" tabindex="-1"></a>        <span class="co">// like `cargo fuzz` or integrate with `proptest`</span></span>
<span id="cb124-72"><a href="#cb124-72" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb124-73"><a href="#cb124-73" aria-hidden="true" tabindex="-1"></a>        <span class="kw">let</span> test_scenarios <span class="op">=</span> <span class="pp">vec!</span>[</span>
<span id="cb124-74"><a href="#cb124-74" aria-hidden="true" tabindex="-1"></a>            TestScenario <span class="op">{</span></span>
<span id="cb124-75"><a href="#cb124-75" aria-hidden="true" tabindex="-1"></a>                initial_supply<span class="op">:</span> <span class="dv">1000</span><span class="op">,</span></span>
<span id="cb124-76"><a href="#cb124-76" aria-hidden="true" tabindex="-1"></a>                actions<span class="op">:</span> <span class="pp">vec!</span>[</span>
<span id="cb124-77"><a href="#cb124-77" aria-hidden="true" tabindex="-1"></a>                    <span class="pp">Action::</span>Transfer <span class="op">{</span> to<span class="op">:</span> <span class="dv">1</span><span class="op">,</span> amount<span class="op">:</span> <span class="dv">100</span> <span class="op">},</span></span>
<span id="cb124-78"><a href="#cb124-78" aria-hidden="true" tabindex="-1"></a>                    <span class="pp">Action::</span>Approve <span class="op">{</span> spender<span class="op">:</span> <span class="dv">1</span><span class="op">,</span> amount<span class="op">:</span> <span class="dv">500</span> <span class="op">},</span></span>
<span id="cb124-79"><a href="#cb124-79" aria-hidden="true" tabindex="-1"></a>                    <span class="pp">Action::</span>TransferFrom <span class="op">{</span> from<span class="op">:</span> <span class="dv">0</span><span class="op">,</span> to<span class="op">:</span> <span class="dv">2</span><span class="op">,</span> amount<span class="op">:</span> <span class="dv">50</span> <span class="op">},</span></span>
<span id="cb124-80"><a href="#cb124-80" aria-hidden="true" tabindex="-1"></a>                ]<span class="op">,</span></span>
<span id="cb124-81"><a href="#cb124-81" aria-hidden="true" tabindex="-1"></a>            <span class="op">},</span></span>
<span id="cb124-82"><a href="#cb124-82" aria-hidden="true" tabindex="-1"></a>            <span class="co">// Add more test scenarios...</span></span>
<span id="cb124-83"><a href="#cb124-83" aria-hidden="true" tabindex="-1"></a>        ]<span class="op">;</span></span>
<span id="cb124-84"><a href="#cb124-84" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb124-85"><a href="#cb124-85" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> scenario <span class="kw">in</span> test_scenarios <span class="op">{</span></span>
<span id="cb124-86"><a href="#cb124-86" aria-hidden="true" tabindex="-1"></a>            <span class="pp">assert!</span>(run_fuzz_test(scenario)<span class="op">,</span> <span class="st">&quot;Fuzz test failed - invariant violated&quot;</span>)<span class="op">;</span></span>
<span id="cb124-87"><a href="#cb124-87" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb124-88"><a href="#cb124-88" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb124-89"><a href="#cb124-89" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<h2 id="performance-and-gas-testing">Performance and Gas Testing</h2>
<h3 id="gas-consumption-testing">Gas Consumption Testing</h3>
<div class="sourceCode" id="cb125"><pre
class="sourceCode rust"><code class="sourceCode rust"><span id="cb125-1"><a href="#cb125-1" aria-hidden="true" tabindex="-1"></a><span class="at">#[</span>cfg<span class="at">(</span>test<span class="at">)]</span></span>
<span id="cb125-2"><a href="#cb125-2" aria-hidden="true" tabindex="-1"></a><span class="kw">mod</span> performance_tests <span class="op">{</span></span>
<span id="cb125-3"><a href="#cb125-3" aria-hidden="true" tabindex="-1"></a>    <span class="kw">use</span> <span class="kw">super</span><span class="pp">::</span><span class="op">*;</span></span>
<span id="cb125-4"><a href="#cb125-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb125-5"><a href="#cb125-5" aria-hidden="true" tabindex="-1"></a>    <span class="at">#[</span><span class="pp">ink::</span>test<span class="at">]</span></span>
<span id="cb125-6"><a href="#cb125-6" aria-hidden="true" tabindex="-1"></a>    <span class="kw">fn</span> gas_consumption_benchmarks() <span class="op">{</span></span>
<span id="cb125-7"><a href="#cb125-7" aria-hidden="true" tabindex="-1"></a>        <span class="kw">let</span> <span class="kw">mut</span> token <span class="op">=</span> setup_contract(<span class="dv">1_000_000</span>)<span class="op">;</span></span>
<span id="cb125-8"><a href="#cb125-8" aria-hidden="true" tabindex="-1"></a>        <span class="kw">let</span> accounts <span class="op">=</span> accounts()<span class="op">;</span></span>
<span id="cb125-9"><a href="#cb125-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb125-10"><a href="#cb125-10" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Benchmark different operations</span></span>
<span id="cb125-11"><a href="#cb125-11" aria-hidden="true" tabindex="-1"></a>        <span class="kw">let</span> operations <span class="op">=</span> <span class="pp">vec!</span>[</span>
<span id="cb125-12"><a href="#cb125-12" aria-hidden="true" tabindex="-1"></a>            (<span class="st">&quot;balance_of&quot;</span><span class="op">,</span> <span class="op">||</span> <span class="op">{</span> token<span class="op">.</span>balance_of(accounts<span class="op">.</span>alice)<span class="op">;</span> <span class="op">}</span>)<span class="op">,</span></span>
<span id="cb125-13"><a href="#cb125-13" aria-hidden="true" tabindex="-1"></a>            (<span class="st">&quot;transfer&quot;</span><span class="op">,</span> <span class="op">||</span> <span class="op">{</span> <span class="kw">let</span> _ <span class="op">=</span> token<span class="op">.</span>transfer(accounts<span class="op">.</span>bob<span class="op">,</span> <span class="dv">100</span>)<span class="op">;</span> <span class="op">}</span>)<span class="op">,</span></span>
<span id="cb125-14"><a href="#cb125-14" aria-hidden="true" tabindex="-1"></a>            (<span class="st">&quot;approve&quot;</span><span class="op">,</span> <span class="op">||</span> <span class="op">{</span> <span class="kw">let</span> _ <span class="op">=</span> token<span class="op">.</span>approve(accounts<span class="op">.</span>bob<span class="op">,</span> <span class="dv">1000</span>)<span class="op">;</span> <span class="op">}</span>)<span class="op">,</span></span>
<span id="cb125-15"><a href="#cb125-15" aria-hidden="true" tabindex="-1"></a>        ]<span class="op">;</span></span>
<span id="cb125-16"><a href="#cb125-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb125-17"><a href="#cb125-17" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> (name<span class="op">,</span> operation) <span class="kw">in</span> operations <span class="op">{</span></span>
<span id="cb125-18"><a href="#cb125-18" aria-hidden="true" tabindex="-1"></a>            <span class="co">// In a real implementation, you would measure gas consumption</span></span>
<span id="cb125-19"><a href="#cb125-19" aria-hidden="true" tabindex="-1"></a>            <span class="co">// This might involve running the operation multiple times</span></span>
<span id="cb125-20"><a href="#cb125-20" aria-hidden="true" tabindex="-1"></a>            <span class="co">// and averaging the results</span></span>
<span id="cb125-21"><a href="#cb125-21" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb125-22"><a href="#cb125-22" aria-hidden="true" tabindex="-1"></a>            operation()<span class="op">;</span></span>
<span id="cb125-23"><a href="#cb125-23" aria-hidden="true" tabindex="-1"></a>            <span class="pp">println!</span>(<span class="st">&quot;Operation &#39;{}&#39; completed&quot;</span><span class="op">,</span> name)<span class="op">;</span></span>
<span id="cb125-24"><a href="#cb125-24" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb125-25"><a href="#cb125-25" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb125-26"><a href="#cb125-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb125-27"><a href="#cb125-27" aria-hidden="true" tabindex="-1"></a>    <span class="at">#[</span><span class="pp">ink::</span>test<span class="at">]</span></span>
<span id="cb125-28"><a href="#cb125-28" aria-hidden="true" tabindex="-1"></a>    <span class="kw">fn</span> storage_efficiency_test() <span class="op">{</span></span>
<span id="cb125-29"><a href="#cb125-29" aria-hidden="true" tabindex="-1"></a>        <span class="kw">let</span> <span class="kw">mut</span> token <span class="op">=</span> setup_contract(<span class="dv">1000</span>)<span class="op">;</span></span>
<span id="cb125-30"><a href="#cb125-30" aria-hidden="true" tabindex="-1"></a>        <span class="kw">let</span> accounts <span class="op">=</span> accounts()<span class="op">;</span></span>
<span id="cb125-31"><a href="#cb125-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb125-32"><a href="#cb125-32" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Test storage efficiency by performing many operations</span></span>
<span id="cb125-33"><a href="#cb125-33" aria-hidden="true" tabindex="-1"></a>        <span class="co">// and ensuring storage doesn&#39;t grow excessively</span></span>
<span id="cb125-34"><a href="#cb125-34" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb125-35"><a href="#cb125-35" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> i <span class="kw">in</span> <span class="dv">0</span><span class="op">..</span><span class="dv">100</span> <span class="op">{</span></span>
<span id="cb125-36"><a href="#cb125-36" aria-hidden="true" tabindex="-1"></a>            <span class="kw">let</span> amount <span class="op">=</span> i <span class="op">%</span> <span class="dv">10</span> <span class="op">+</span> <span class="dv">1</span><span class="op">;</span></span>
<span id="cb125-37"><a href="#cb125-37" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> i <span class="op">%</span> <span class="dv">2</span> <span class="op">==</span> <span class="dv">0</span> <span class="op">{</span></span>
<span id="cb125-38"><a href="#cb125-38" aria-hidden="true" tabindex="-1"></a>                <span class="kw">let</span> _ <span class="op">=</span> token<span class="op">.</span>transfer(accounts<span class="op">.</span>bob<span class="op">,</span> amount)<span class="op">;</span></span>
<span id="cb125-39"><a href="#cb125-39" aria-hidden="true" tabindex="-1"></a>            <span class="op">}</span> <span class="cf">else</span> <span class="op">{</span></span>
<span id="cb125-40"><a href="#cb125-40" aria-hidden="true" tabindex="-1"></a>                <span class="pp">test::set_caller::</span><span class="op">&lt;</span><span class="pp">ink::env::</span>DefaultEnvironment<span class="op">&gt;</span>(accounts<span class="op">.</span>bob)<span class="op">;</span></span>
<span id="cb125-41"><a href="#cb125-41" aria-hidden="true" tabindex="-1"></a>                <span class="kw">let</span> _ <span class="op">=</span> token<span class="op">.</span>transfer(accounts<span class="op">.</span>alice<span class="op">,</span> amount)<span class="op">;</span></span>
<span id="cb125-42"><a href="#cb125-42" aria-hidden="true" tabindex="-1"></a>                <span class="pp">test::set_caller::</span><span class="op">&lt;</span><span class="pp">ink::env::</span>DefaultEnvironment<span class="op">&gt;</span>(accounts<span class="op">.</span>alice)<span class="op">;</span></span>
<span id="cb125-43"><a href="#cb125-43" aria-hidden="true" tabindex="-1"></a>            <span class="op">}</span></span>
<span id="cb125-44"><a href="#cb125-44" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb125-45"><a href="#cb125-45" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb125-46"><a href="#cb125-46" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Verify contract state is still consistent</span></span>
<span id="cb125-47"><a href="#cb125-47" aria-hidden="true" tabindex="-1"></a>        <span class="pp">assert!</span>(token<span class="op">.</span>balance_of(accounts<span class="op">.</span>alice) <span class="op">+</span> token<span class="op">.</span>balance_of(accounts<span class="op">.</span>bob) <span class="op">&lt;=</span> <span class="dv">1000</span>)<span class="op">;</span></span>
<span id="cb125-48"><a href="#cb125-48" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb125-49"><a href="#cb125-49" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb125-50"><a href="#cb125-50" aria-hidden="true" tabindex="-1"></a>    <span class="at">#[</span><span class="pp">ink::</span>test<span class="at">]</span></span>
<span id="cb125-51"><a href="#cb125-51" aria-hidden="true" tabindex="-1"></a>    <span class="kw">fn</span> batch_operation_efficiency() <span class="op">{</span></span>
<span id="cb125-52"><a href="#cb125-52" aria-hidden="true" tabindex="-1"></a>        <span class="kw">let</span> <span class="kw">mut</span> token <span class="op">=</span> setup_contract(<span class="dv">1_000_000</span>)<span class="op">;</span></span>
<span id="cb125-53"><a href="#cb125-53" aria-hidden="true" tabindex="-1"></a>        <span class="kw">let</span> accounts <span class="op">=</span> accounts()<span class="op">;</span></span>
<span id="cb125-54"><a href="#cb125-54" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb125-55"><a href="#cb125-55" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Test efficiency of batch operations vs individual operations</span></span>
<span id="cb125-56"><a href="#cb125-56" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb125-57"><a href="#cb125-57" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Individual transfers</span></span>
<span id="cb125-58"><a href="#cb125-58" aria-hidden="true" tabindex="-1"></a>        <span class="kw">let</span> start_time <span class="op">=</span> <span class="pp">std::time::Instant::</span>now()<span class="op">;</span></span>
<span id="cb125-59"><a href="#cb125-59" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> i <span class="kw">in</span> <span class="dv">0</span><span class="op">..</span><span class="dv">100</span> <span class="op">{</span></span>
<span id="cb125-60"><a href="#cb125-60" aria-hidden="true" tabindex="-1"></a>            <span class="kw">let</span> _ <span class="op">=</span> token<span class="op">.</span>transfer(accounts<span class="op">.</span>bob<span class="op">,</span> <span class="dv">100</span>)<span class="op">;</span></span>
<span id="cb125-61"><a href="#cb125-61" aria-hidden="true" tabindex="-1"></a>            <span class="pp">test::set_caller::</span><span class="op">&lt;</span><span class="pp">ink::env::</span>DefaultEnvironment<span class="op">&gt;</span>(accounts<span class="op">.</span>bob)<span class="op">;</span></span>
<span id="cb125-62"><a href="#cb125-62" aria-hidden="true" tabindex="-1"></a>            <span class="kw">let</span> _ <span class="op">=</span> token<span class="op">.</span>transfer(accounts<span class="op">.</span>alice<span class="op">,</span> <span class="dv">100</span>)<span class="op">;</span></span>
<span id="cb125-63"><a href="#cb125-63" aria-hidden="true" tabindex="-1"></a>            <span class="pp">test::set_caller::</span><span class="op">&lt;</span><span class="pp">ink::env::</span>DefaultEnvironment<span class="op">&gt;</span>(accounts<span class="op">.</span>alice)<span class="op">;</span></span>
<span id="cb125-64"><a href="#cb125-64" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb125-65"><a href="#cb125-65" aria-hidden="true" tabindex="-1"></a>        <span class="kw">let</span> individual_duration <span class="op">=</span> start_time<span class="op">.</span>elapsed()<span class="op">;</span></span>
<span id="cb125-66"><a href="#cb125-66" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb125-67"><a href="#cb125-67" aria-hidden="true" tabindex="-1"></a>        <span class="co">// In a real implementation, you might compare this with</span></span>
<span id="cb125-68"><a href="#cb125-68" aria-hidden="true" tabindex="-1"></a>        <span class="co">// a batch transfer function if available</span></span>
<span id="cb125-69"><a href="#cb125-69" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb125-70"><a href="#cb125-70" aria-hidden="true" tabindex="-1"></a>        <span class="pp">println!</span>(<span class="st">&quot;Individual operations took: {:?}&quot;</span><span class="op">,</span> individual_duration)<span class="op">;</span></span>
<span id="cb125-71"><a href="#cb125-71" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb125-72"><a href="#cb125-72" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<h2 id="test-organization-and-cicd">Test Organization and CI/CD</h2>
<h3 id="test-configuration">Test Configuration</h3>
<div class="sourceCode" id="cb126"><pre
class="sourceCode toml"><code class="sourceCode toml"><span id="cb126-1"><a href="#cb126-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Cargo.toml test configuration</span></span>
<span id="cb126-2"><a href="#cb126-2" aria-hidden="true" tabindex="-1"></a><span class="kw">[features]</span></span>
<span id="cb126-3"><a href="#cb126-3" aria-hidden="true" tabindex="-1"></a><span class="dt">default</span> <span class="op">=</span> <span class="op">[</span><span class="st">&quot;std&quot;</span><span class="op">]</span></span>
<span id="cb126-4"><a href="#cb126-4" aria-hidden="true" tabindex="-1"></a><span class="dt">std</span> <span class="op">=</span> <span class="op">[</span></span>
<span id="cb126-5"><a href="#cb126-5" aria-hidden="true" tabindex="-1"></a>    <span class="st">&quot;ink/std&quot;</span><span class="op">,</span></span>
<span id="cb126-6"><a href="#cb126-6" aria-hidden="true" tabindex="-1"></a>    <span class="st">&quot;scale/std&quot;</span><span class="op">,</span></span>
<span id="cb126-7"><a href="#cb126-7" aria-hidden="true" tabindex="-1"></a>    <span class="st">&quot;scale-info/std&quot;</span><span class="op">,</span></span>
<span id="cb126-8"><a href="#cb126-8" aria-hidden="true" tabindex="-1"></a><span class="op">]</span></span>
<span id="cb126-9"><a href="#cb126-9" aria-hidden="true" tabindex="-1"></a><span class="dt">e2e-tests</span> <span class="op">=</span> <span class="op">[]</span></span>
<span id="cb126-10"><a href="#cb126-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb126-11"><a href="#cb126-11" aria-hidden="true" tabindex="-1"></a><span class="kw">[dev-dependencies]</span></span>
<span id="cb126-12"><a href="#cb126-12" aria-hidden="true" tabindex="-1"></a><span class="dt">ink_e2e</span> <span class="op">=</span> <span class="st">&quot;4.3&quot;</span></span>
<span id="cb126-13"><a href="#cb126-13" aria-hidden="true" tabindex="-1"></a><span class="dt">quickcheck</span> <span class="op">=</span> <span class="st">&quot;1.0&quot;</span></span>
<span id="cb126-14"><a href="#cb126-14" aria-hidden="true" tabindex="-1"></a><span class="dt">arbitrary</span> <span class="op">=</span> <span class="st">&quot;1.0&quot;</span></span></code></pre></div>
<h3 id="cicd-pipeline">CI/CD Pipeline</h3>
<div class="sourceCode" id="cb127"><pre
class="sourceCode yaml"><code class="sourceCode yaml"><span id="cb127-1"><a href="#cb127-1" aria-hidden="true" tabindex="-1"></a><span class="co"># .github/workflows/test.yml</span></span>
<span id="cb127-2"><a href="#cb127-2" aria-hidden="true" tabindex="-1"></a><span class="fu">name</span><span class="kw">:</span><span class="at"> Test</span></span>
<span id="cb127-3"><a href="#cb127-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb127-4"><a href="#cb127-4" aria-hidden="true" tabindex="-1"></a><span class="fu">on</span><span class="kw">:</span></span>
<span id="cb127-5"><a href="#cb127-5" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">push</span><span class="kw">:</span></span>
<span id="cb127-6"><a href="#cb127-6" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">branches</span><span class="kw">:</span><span class="at"> </span><span class="kw">[</span><span class="at"> main </span><span class="kw">]</span></span>
<span id="cb127-7"><a href="#cb127-7" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">pull_request</span><span class="kw">:</span></span>
<span id="cb127-8"><a href="#cb127-8" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">branches</span><span class="kw">:</span><span class="at"> </span><span class="kw">[</span><span class="at"> main </span><span class="kw">]</span></span>
<span id="cb127-9"><a href="#cb127-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb127-10"><a href="#cb127-10" aria-hidden="true" tabindex="-1"></a><span class="fu">jobs</span><span class="kw">:</span></span>
<span id="cb127-11"><a href="#cb127-11" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">unit-tests</span><span class="kw">:</span></span>
<span id="cb127-12"><a href="#cb127-12" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">runs-on</span><span class="kw">:</span><span class="at"> ubuntu-latest</span></span>
<span id="cb127-13"><a href="#cb127-13" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">steps</span><span class="kw">:</span></span>
<span id="cb127-14"><a href="#cb127-14" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="kw">-</span><span class="at"> </span><span class="fu">uses</span><span class="kw">:</span><span class="at"> actions/checkout@v3</span></span>
<span id="cb127-15"><a href="#cb127-15" aria-hidden="true" tabindex="-1"></a><span class="at">    </span></span>
<span id="cb127-16"><a href="#cb127-16" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="kw">-</span><span class="at"> </span><span class="fu">name</span><span class="kw">:</span><span class="at"> Install Rust</span></span>
<span id="cb127-17"><a href="#cb127-17" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="fu">uses</span><span class="kw">:</span><span class="at"> actions-rs/toolchain@v1</span></span>
<span id="cb127-18"><a href="#cb127-18" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="fu">with</span><span class="kw">:</span></span>
<span id="cb127-19"><a href="#cb127-19" aria-hidden="true" tabindex="-1"></a><span class="at">        </span><span class="fu">toolchain</span><span class="kw">:</span><span class="at"> stable</span></span>
<span id="cb127-20"><a href="#cb127-20" aria-hidden="true" tabindex="-1"></a><span class="at">        </span><span class="fu">target</span><span class="kw">:</span><span class="at"> wasm32-unknown-unknown</span></span>
<span id="cb127-21"><a href="#cb127-21" aria-hidden="true" tabindex="-1"></a><span class="at">        </span><span class="fu">components</span><span class="kw">:</span><span class="at"> rustfmt, clippy</span></span>
<span id="cb127-22"><a href="#cb127-22" aria-hidden="true" tabindex="-1"></a><span class="at">    </span></span>
<span id="cb127-23"><a href="#cb127-23" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="kw">-</span><span class="at"> </span><span class="fu">name</span><span class="kw">:</span><span class="at"> Install cargo-contract</span></span>
<span id="cb127-24"><a href="#cb127-24" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="fu">run</span><span class="kw">:</span><span class="at"> cargo install cargo-contract --force</span></span>
<span id="cb127-25"><a href="#cb127-25" aria-hidden="true" tabindex="-1"></a><span class="at">    </span></span>
<span id="cb127-26"><a href="#cb127-26" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="kw">-</span><span class="at"> </span><span class="fu">name</span><span class="kw">:</span><span class="at"> Run unit tests</span></span>
<span id="cb127-27"><a href="#cb127-27" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="fu">run</span><span class="kw">:</span><span class="at"> cargo test</span></span>
<span id="cb127-28"><a href="#cb127-28" aria-hidden="true" tabindex="-1"></a><span class="at">    </span></span>
<span id="cb127-29"><a href="#cb127-29" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="kw">-</span><span class="at"> </span><span class="fu">name</span><span class="kw">:</span><span class="at"> Run clippy</span></span>
<span id="cb127-30"><a href="#cb127-30" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="fu">run</span><span class="kw">:</span><span class="at"> cargo clippy -- -D warnings</span></span>
<span id="cb127-31"><a href="#cb127-31" aria-hidden="true" tabindex="-1"></a><span class="at">    </span></span>
<span id="cb127-32"><a href="#cb127-32" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="kw">-</span><span class="at"> </span><span class="fu">name</span><span class="kw">:</span><span class="at"> Check formatting</span></span>
<span id="cb127-33"><a href="#cb127-33" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="fu">run</span><span class="kw">:</span><span class="at"> cargo fmt -- --check</span></span>
<span id="cb127-34"><a href="#cb127-34" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb127-35"><a href="#cb127-35" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">integration-tests</span><span class="kw">:</span></span>
<span id="cb127-36"><a href="#cb127-36" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">runs-on</span><span class="kw">:</span><span class="at"> ubuntu-latest</span></span>
<span id="cb127-37"><a href="#cb127-37" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">steps</span><span class="kw">:</span></span>
<span id="cb127-38"><a href="#cb127-38" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="kw">-</span><span class="at"> </span><span class="fu">uses</span><span class="kw">:</span><span class="at"> actions/checkout@v3</span></span>
<span id="cb127-39"><a href="#cb127-39" aria-hidden="true" tabindex="-1"></a><span class="at">    </span></span>
<span id="cb127-40"><a href="#cb127-40" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="kw">-</span><span class="at"> </span><span class="fu">name</span><span class="kw">:</span><span class="at"> Install dependencies</span></span>
<span id="cb127-41"><a href="#cb127-41" aria-hidden="true" tabindex="-1"></a><span class="fu">      run</span><span class="kw">: </span><span class="ch">|</span></span>
<span id="cb127-42"><a href="#cb127-42" aria-hidden="true" tabindex="-1"></a>        cargo install cargo-contract --force</span>
<span id="cb127-43"><a href="#cb127-43" aria-hidden="true" tabindex="-1"></a>        cargo install contracts-node --git https://github.com/paritytech/substrate-contracts-node.git</span>
<span id="cb127-44"><a href="#cb127-44" aria-hidden="true" tabindex="-1"></a><span class="at">    </span></span>
<span id="cb127-45"><a href="#cb127-45" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="kw">-</span><span class="at"> </span><span class="fu">name</span><span class="kw">:</span><span class="at"> Run substrate node</span></span>
<span id="cb127-46"><a href="#cb127-46" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="fu">run</span><span class="kw">:</span><span class="at"> substrate-contracts-node --dev --tmp &amp;</span></span>
<span id="cb127-47"><a href="#cb127-47" aria-hidden="true" tabindex="-1"></a><span class="at">      </span></span>
<span id="cb127-48"><a href="#cb127-48" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="kw">-</span><span class="at"> </span><span class="fu">name</span><span class="kw">:</span><span class="at"> Wait for node</span></span>
<span id="cb127-49"><a href="#cb127-49" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="fu">run</span><span class="kw">:</span><span class="at"> sleep 10</span></span>
<span id="cb127-50"><a href="#cb127-50" aria-hidden="true" tabindex="-1"></a><span class="at">    </span></span>
<span id="cb127-51"><a href="#cb127-51" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="kw">-</span><span class="at"> </span><span class="fu">name</span><span class="kw">:</span><span class="at"> Run E2E tests</span></span>
<span id="cb127-52"><a href="#cb127-52" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="fu">run</span><span class="kw">:</span><span class="at"> cargo test --features e2e-tests</span></span>
<span id="cb127-53"><a href="#cb127-53" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb127-54"><a href="#cb127-54" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">security-tests</span><span class="kw">:</span></span>
<span id="cb127-55"><a href="#cb127-55" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">runs-on</span><span class="kw">:</span><span class="at"> ubuntu-latest</span></span>
<span id="cb127-56"><a href="#cb127-56" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">steps</span><span class="kw">:</span></span>
<span id="cb127-57"><a href="#cb127-57" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="kw">-</span><span class="at"> </span><span class="fu">uses</span><span class="kw">:</span><span class="at"> actions/checkout@v3</span></span>
<span id="cb127-58"><a href="#cb127-58" aria-hidden="true" tabindex="-1"></a><span class="at">    </span></span>
<span id="cb127-59"><a href="#cb127-59" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="kw">-</span><span class="at"> </span><span class="fu">name</span><span class="kw">:</span><span class="at"> Install cargo-audit</span></span>
<span id="cb127-60"><a href="#cb127-60" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="fu">run</span><span class="kw">:</span><span class="at"> cargo install cargo-audit</span></span>
<span id="cb127-61"><a href="#cb127-61" aria-hidden="true" tabindex="-1"></a><span class="at">    </span></span>
<span id="cb127-62"><a href="#cb127-62" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="kw">-</span><span class="at"> </span><span class="fu">name</span><span class="kw">:</span><span class="at"> Security audit</span></span>
<span id="cb127-63"><a href="#cb127-63" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="fu">run</span><span class="kw">:</span><span class="at"> cargo audit</span></span>
<span id="cb127-64"><a href="#cb127-64" aria-hidden="true" tabindex="-1"></a><span class="at">    </span></span>
<span id="cb127-65"><a href="#cb127-65" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="kw">-</span><span class="at"> </span><span class="fu">name</span><span class="kw">:</span><span class="at"> Run security-focused tests</span></span>
<span id="cb127-66"><a href="#cb127-66" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="fu">run</span><span class="kw">:</span><span class="at"> cargo test security_tests</span></span></code></pre></div>
<h2 id="summary-6">Summary</h2>
<p>In this chapter, we’ve built a comprehensive testing framework for
ink! contracts:</p>
<p><strong>Testing Foundation:</strong> 1. <strong>Unit Tests</strong>:
Fast, isolated testing of individual functions with comprehensive edge
case coverage 2. <strong>Integration Tests</strong>: Testing contract
interactions, event emission, and state transitions 3.
<strong>End-to-End Tests</strong>: Full deployment and interaction
testing on real blockchain networks</p>
<p><strong>Advanced Testing Techniques:</strong> 4.
<strong>Property-Based Testing</strong>: Discovering edge cases through
randomized input generation 5. <strong>Fuzz Testing</strong>: Finding
vulnerabilities through systematic input variation 6. <strong>Security
Testing</strong>: Focused testing for access controls, overflow
protection, and attack resistance</p>
<p><strong>Specialized Testing:</strong> 7. <strong>Cross-Contract
Testing</strong>: Validating interactions between multiple contracts 8.
<strong>Gas Testing</strong>: Ensuring operations remain within
reasonable gas limits 9. <strong>Performance Testing</strong>:
Benchmarking and optimizing contract operations</p>
<p><strong>Testing Infrastructure:</strong> 10. <strong>CI/CD
Integration</strong>: Automated testing pipelines for continuous
validation 11. <strong>Test Organization</strong>: Proper test structure
and configuration management</p>
<p><strong>Key Principles:</strong> - <strong>Comprehensive
Coverage</strong>: Test happy paths, edge cases, and failure scenarios -
<strong>Realistic Testing</strong>: Use real blockchain environments for
final validation - <strong>Security Focus</strong>: Actively search for
vulnerabilities and attack vectors - <strong>Performance
Awareness</strong>: Monitor gas consumption and optimization
opportunities</p>
<p>With a robust testing strategy in place, you can deploy contracts
with confidence, knowing they’ve been thoroughly validated under all
conditions. In the next chapter, we’ll explore debugging and
optimization techniques to fine-tune your contracts for production
deployment.</p>
<hr />
<h1 id="chapter-8-debugging-and-optimization">Chapter 8: Debugging and
Optimization</h1>
<p>Production ink! contracts require efficient debugging workflows and
optimized performance. This chapter covers debugging techniques, gas
optimization strategies, and performance monitoring for smart
contracts.</p>
<h2 id="debugging-techniques">Debugging Techniques</h2>
<h3 id="using-debug_println-for-development">Using debug_println! for
Development</h3>
<div class="sourceCode" id="cb128"><pre
class="sourceCode rust"><code class="sourceCode rust"><span id="cb128-1"><a href="#cb128-1" aria-hidden="true" tabindex="-1"></a><span class="at">#[</span><span class="pp">ink::</span>contract<span class="at">]</span></span>
<span id="cb128-2"><a href="#cb128-2" aria-hidden="true" tabindex="-1"></a><span class="kw">mod</span> debuggable_contract <span class="op">{</span></span>
<span id="cb128-3"><a href="#cb128-3" aria-hidden="true" tabindex="-1"></a>    <span class="at">#[</span>ink<span class="at">(</span>storage<span class="at">)]</span></span>
<span id="cb128-4"><a href="#cb128-4" aria-hidden="true" tabindex="-1"></a>    <span class="kw">pub</span> <span class="kw">struct</span> DebuggableContract <span class="op">{</span></span>
<span id="cb128-5"><a href="#cb128-5" aria-hidden="true" tabindex="-1"></a>        value<span class="op">:</span> <span class="dt">u32</span><span class="op">,</span></span>
<span id="cb128-6"><a href="#cb128-6" aria-hidden="true" tabindex="-1"></a>        operations<span class="op">:</span> <span class="dt">u32</span><span class="op">,</span></span>
<span id="cb128-7"><a href="#cb128-7" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb128-8"><a href="#cb128-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb128-9"><a href="#cb128-9" aria-hidden="true" tabindex="-1"></a>    <span class="kw">impl</span> DebuggableContract <span class="op">{</span></span>
<span id="cb128-10"><a href="#cb128-10" aria-hidden="true" tabindex="-1"></a>        <span class="at">#[</span>ink<span class="at">(</span>constructor<span class="at">)]</span></span>
<span id="cb128-11"><a href="#cb128-11" aria-hidden="true" tabindex="-1"></a>        <span class="kw">pub</span> <span class="kw">fn</span> new(initial_value<span class="op">:</span> <span class="dt">u32</span>) <span class="op">-&gt;</span> <span class="dt">Self</span> <span class="op">{</span></span>
<span id="cb128-12"><a href="#cb128-12" aria-hidden="true" tabindex="-1"></a>            <span class="pp">ink::env::debug_println!</span>(<span class="st">&quot;Creating contract with value: {}&quot;</span><span class="op">,</span> initial_value)<span class="op">;</span></span>
<span id="cb128-13"><a href="#cb128-13" aria-hidden="true" tabindex="-1"></a>            <span class="dt">Self</span> <span class="op">{</span></span>
<span id="cb128-14"><a href="#cb128-14" aria-hidden="true" tabindex="-1"></a>                value<span class="op">:</span> initial_value<span class="op">,</span></span>
<span id="cb128-15"><a href="#cb128-15" aria-hidden="true" tabindex="-1"></a>                operations<span class="op">:</span> <span class="dv">0</span><span class="op">,</span></span>
<span id="cb128-16"><a href="#cb128-16" aria-hidden="true" tabindex="-1"></a>            <span class="op">}</span></span>
<span id="cb128-17"><a href="#cb128-17" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb128-18"><a href="#cb128-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb128-19"><a href="#cb128-19" aria-hidden="true" tabindex="-1"></a>        <span class="at">#[</span>ink<span class="at">(</span>message<span class="at">)]</span></span>
<span id="cb128-20"><a href="#cb128-20" aria-hidden="true" tabindex="-1"></a>        <span class="kw">pub</span> <span class="kw">fn</span> add(<span class="op">&amp;</span><span class="kw">mut</span> <span class="kw">self</span><span class="op">,</span> amount<span class="op">:</span> <span class="dt">u32</span>) <span class="op">-&gt;</span> <span class="dt">Result</span><span class="op">&lt;</span>()<span class="op">,</span> <span class="bu">Error</span><span class="op">&gt;</span> <span class="op">{</span></span>
<span id="cb128-21"><a href="#cb128-21" aria-hidden="true" tabindex="-1"></a>            <span class="pp">ink::env::debug_println!</span>(<span class="st">&quot;Adding {} to current value {}&quot;</span><span class="op">,</span> amount<span class="op">,</span> <span class="kw">self</span><span class="op">.</span>value)<span class="op">;</span></span>
<span id="cb128-22"><a href="#cb128-22" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb128-23"><a href="#cb128-23" aria-hidden="true" tabindex="-1"></a>            <span class="kw">let</span> new_value <span class="op">=</span> <span class="kw">self</span><span class="op">.</span>value<span class="op">.</span>checked_add(amount)</span>
<span id="cb128-24"><a href="#cb128-24" aria-hidden="true" tabindex="-1"></a>                <span class="op">.</span>ok_or(<span class="bu">Error</span><span class="pp">::</span>ArithmeticOverflow)<span class="op">?;</span></span>
<span id="cb128-25"><a href="#cb128-25" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb128-26"><a href="#cb128-26" aria-hidden="true" tabindex="-1"></a>            <span class="kw">self</span><span class="op">.</span>value <span class="op">=</span> new_value<span class="op">;</span></span>
<span id="cb128-27"><a href="#cb128-27" aria-hidden="true" tabindex="-1"></a>            <span class="kw">self</span><span class="op">.</span>operations <span class="op">+=</span> <span class="dv">1</span><span class="op">;</span></span>
<span id="cb128-28"><a href="#cb128-28" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb128-29"><a href="#cb128-29" aria-hidden="true" tabindex="-1"></a>            <span class="pp">ink::env::debug_println!</span>(<span class="st">&quot;New value: {}, operations: {}&quot;</span><span class="op">,</span> <span class="kw">self</span><span class="op">.</span>value<span class="op">,</span> <span class="kw">self</span><span class="op">.</span>operations)<span class="op">;</span></span>
<span id="cb128-30"><a href="#cb128-30" aria-hidden="true" tabindex="-1"></a>            <span class="cn">Ok</span>(())</span>
<span id="cb128-31"><a href="#cb128-31" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb128-32"><a href="#cb128-32" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb128-33"><a href="#cb128-33" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<h3 id="gas-analysis-and-optimization">Gas Analysis and
Optimization</h3>
<div class="sourceCode" id="cb129"><pre
class="sourceCode rust"><code class="sourceCode rust"><span id="cb129-1"><a href="#cb129-1" aria-hidden="true" tabindex="-1"></a><span class="kw">impl</span> DebuggableContract <span class="op">{</span></span>
<span id="cb129-2"><a href="#cb129-2" aria-hidden="true" tabindex="-1"></a>    <span class="co">/// Gas-optimized version</span></span>
<span id="cb129-3"><a href="#cb129-3" aria-hidden="true" tabindex="-1"></a>    <span class="at">#[</span>ink<span class="at">(</span>message<span class="at">)]</span></span>
<span id="cb129-4"><a href="#cb129-4" aria-hidden="true" tabindex="-1"></a>    <span class="kw">pub</span> <span class="kw">fn</span> batch_add_optimized(<span class="op">&amp;</span><span class="kw">mut</span> <span class="kw">self</span><span class="op">,</span> amounts<span class="op">:</span> <span class="dt">Vec</span><span class="op">&lt;</span><span class="dt">u32</span><span class="op">&gt;</span>) <span class="op">-&gt;</span> <span class="dt">Result</span><span class="op">&lt;</span><span class="dt">u32</span><span class="op">,</span> <span class="bu">Error</span><span class="op">&gt;</span> <span class="op">{</span></span>
<span id="cb129-5"><a href="#cb129-5" aria-hidden="true" tabindex="-1"></a>        <span class="kw">let</span> <span class="kw">mut</span> total <span class="op">=</span> <span class="dv">0u32</span><span class="op">;</span></span>
<span id="cb129-6"><a href="#cb129-6" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb129-7"><a href="#cb129-7" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Single overflow check for total</span></span>
<span id="cb129-8"><a href="#cb129-8" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> amount <span class="kw">in</span> <span class="op">&amp;</span>amounts <span class="op">{</span></span>
<span id="cb129-9"><a href="#cb129-9" aria-hidden="true" tabindex="-1"></a>            total <span class="op">=</span> total<span class="op">.</span>checked_add(<span class="op">*</span>amount)</span>
<span id="cb129-10"><a href="#cb129-10" aria-hidden="true" tabindex="-1"></a>                <span class="op">.</span>ok_or(<span class="bu">Error</span><span class="pp">::</span>ArithmeticOverflow)<span class="op">?;</span></span>
<span id="cb129-11"><a href="#cb129-11" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb129-12"><a href="#cb129-12" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb129-13"><a href="#cb129-13" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Single final update</span></span>
<span id="cb129-14"><a href="#cb129-14" aria-hidden="true" tabindex="-1"></a>        <span class="kw">self</span><span class="op">.</span>value <span class="op">=</span> <span class="kw">self</span><span class="op">.</span>value<span class="op">.</span>checked_add(total)</span>
<span id="cb129-15"><a href="#cb129-15" aria-hidden="true" tabindex="-1"></a>            <span class="op">.</span>ok_or(<span class="bu">Error</span><span class="pp">::</span>ArithmeticOverflow)<span class="op">?;</span></span>
<span id="cb129-16"><a href="#cb129-16" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb129-17"><a href="#cb129-17" aria-hidden="true" tabindex="-1"></a>        <span class="kw">self</span><span class="op">.</span>operations <span class="op">+=</span> amounts<span class="op">.</span>len() <span class="kw">as</span> <span class="dt">u32</span><span class="op">;</span></span>
<span id="cb129-18"><a href="#cb129-18" aria-hidden="true" tabindex="-1"></a>        <span class="cn">Ok</span>(amounts<span class="op">.</span>len() <span class="kw">as</span> <span class="dt">u32</span>)</span>
<span id="cb129-19"><a href="#cb129-19" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb129-20"><a href="#cb129-20" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<h2 id="performance-optimization">Performance Optimization</h2>
<h3 id="storage-access-patterns">Storage Access Patterns</h3>
<div class="sourceCode" id="cb130"><pre
class="sourceCode rust"><code class="sourceCode rust"><span id="cb130-1"><a href="#cb130-1" aria-hidden="true" tabindex="-1"></a><span class="co">// ❌ Inefficient: Multiple storage reads</span></span>
<span id="cb130-2"><a href="#cb130-2" aria-hidden="true" tabindex="-1"></a><span class="at">#[</span>ink<span class="at">(</span>message<span class="at">)]</span></span>
<span id="cb130-3"><a href="#cb130-3" aria-hidden="true" tabindex="-1"></a><span class="kw">pub</span> <span class="kw">fn</span> inefficient_calculation(<span class="op">&amp;</span><span class="kw">self</span>) <span class="op">-&gt;</span> <span class="dt">u32</span> <span class="op">{</span></span>
<span id="cb130-4"><a href="#cb130-4" aria-hidden="true" tabindex="-1"></a>    <span class="kw">let</span> a <span class="op">=</span> <span class="kw">self</span><span class="op">.</span>balances<span class="op">.</span>get(user1)<span class="op">.</span>unwrap_or(<span class="dv">0</span>)<span class="op">;</span></span>
<span id="cb130-5"><a href="#cb130-5" aria-hidden="true" tabindex="-1"></a>    <span class="kw">let</span> b <span class="op">=</span> <span class="kw">self</span><span class="op">.</span>balances<span class="op">.</span>get(user1)<span class="op">.</span>unwrap_or(<span class="dv">0</span>)<span class="op">;</span> <span class="co">// Duplicate read!</span></span>
<span id="cb130-6"><a href="#cb130-6" aria-hidden="true" tabindex="-1"></a>    <span class="kw">let</span> c <span class="op">=</span> <span class="kw">self</span><span class="op">.</span>balances<span class="op">.</span>get(user2)<span class="op">.</span>unwrap_or(<span class="dv">0</span>)<span class="op">;</span></span>
<span id="cb130-7"><a href="#cb130-7" aria-hidden="true" tabindex="-1"></a>    a <span class="op">+</span> b <span class="op">+</span> c</span>
<span id="cb130-8"><a href="#cb130-8" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb130-9"><a href="#cb130-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb130-10"><a href="#cb130-10" aria-hidden="true" tabindex="-1"></a><span class="co">// ✅ Efficient: Cache storage reads</span></span>
<span id="cb130-11"><a href="#cb130-11" aria-hidden="true" tabindex="-1"></a><span class="at">#[</span>ink<span class="at">(</span>message<span class="at">)]</span></span>
<span id="cb130-12"><a href="#cb130-12" aria-hidden="true" tabindex="-1"></a><span class="kw">pub</span> <span class="kw">fn</span> efficient_calculation(<span class="op">&amp;</span><span class="kw">self</span>) <span class="op">-&gt;</span> <span class="dt">u32</span> <span class="op">{</span></span>
<span id="cb130-13"><a href="#cb130-13" aria-hidden="true" tabindex="-1"></a>    <span class="kw">let</span> user1_balance <span class="op">=</span> <span class="kw">self</span><span class="op">.</span>balances<span class="op">.</span>get(user1)<span class="op">.</span>unwrap_or(<span class="dv">0</span>)<span class="op">;</span></span>
<span id="cb130-14"><a href="#cb130-14" aria-hidden="true" tabindex="-1"></a>    <span class="kw">let</span> user2_balance <span class="op">=</span> <span class="kw">self</span><span class="op">.</span>balances<span class="op">.</span>get(user2)<span class="op">.</span>unwrap_or(<span class="dv">0</span>)<span class="op">;</span></span>
<span id="cb130-15"><a href="#cb130-15" aria-hidden="true" tabindex="-1"></a>    user1_balance <span class="op">*</span> <span class="dv">2</span> <span class="op">+</span> user2_balance</span>
<span id="cb130-16"><a href="#cb130-16" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<h3 id="gas-estimation-tools">Gas Estimation Tools</h3>
<div class="sourceCode" id="cb131"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb131-1"><a href="#cb131-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Estimate gas for dry run</span></span>
<span id="cb131-2"><a href="#cb131-2" aria-hidden="true" tabindex="-1"></a><span class="ex">cargo</span> contract call <span class="at">--contract</span> <span class="va">$CONTRACT_ADDRESS</span> <span class="dt">\</span></span>
<span id="cb131-3"><a href="#cb131-3" aria-hidden="true" tabindex="-1"></a>                   <span class="at">--message</span> transfer <span class="dt">\</span></span>
<span id="cb131-4"><a href="#cb131-4" aria-hidden="true" tabindex="-1"></a>                   <span class="at">--args</span> <span class="va">$TO</span> <span class="va">$AMOUNT</span> <span class="dt">\</span></span>
<span id="cb131-5"><a href="#cb131-5" aria-hidden="true" tabindex="-1"></a>                   <span class="at">--dry-run</span> <span class="dt">\</span></span>
<span id="cb131-6"><a href="#cb131-6" aria-hidden="true" tabindex="-1"></a>                   <span class="at">--gas-limit</span> 1000000</span></code></pre></div>
<h2 id="common-performance-pitfalls">Common Performance Pitfalls</h2>
<ol type="1">
<li><strong>Large Vector Operations</strong>: Use <code>Mapping</code>
instead of <code>Vec</code> for large datasets</li>
<li><strong>Redundant Storage Access</strong>: Cache frequently accessed
values</li>
<li><strong>Inefficient Loops</strong>: Limit loop iterations and use
batch operations</li>
<li><strong>Oversized Types</strong>: Use appropriately sized integer
types</li>
</ol>
<h2 id="summary-7">Summary</h2>
<p>Effective debugging and optimization ensure your contracts perform
efficiently in production:</p>
<ul>
<li>Use <code>debug_println!</code> for development debugging</li>
<li>Analyze gas consumption patterns</li>
<li>Optimize storage access patterns</li>
<li>Monitor performance metrics</li>
<li>Profile and benchmark critical operations</li>
</ul>
<p>With proper debugging and optimization techniques, your contracts
will run efficiently and provide clear feedback during development and
production operation.</p>
<hr />
<h1
id="chapter-9-from-localhost-to-live-deployment-and-interaction">Chapter
9: From Localhost to Live: Deployment and Interaction</h1>
<p>Moving from development to production requires understanding
deployment workflows, network configuration, and interaction patterns.
This chapter covers the complete deployment lifecycle from local testing
to mainnet deployment.</p>
<h2 id="local-development-environment">Local Development
Environment</h2>
<h3 id="setting-up-a-local-test-network">Setting Up a Local Test
Network</h3>
<div class="sourceCode" id="cb132"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb132-1"><a href="#cb132-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Install and run a local polkadot-sdk node with contracts support</span></span>
<span id="cb132-2"><a href="#cb132-2" aria-hidden="true" tabindex="-1"></a><span class="ex">cargo</span> install contracts-node <span class="at">--git</span> https://github.com/paritytech/substrate-contracts-node.git</span>
<span id="cb132-3"><a href="#cb132-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb132-4"><a href="#cb132-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Start local development node</span></span>
<span id="cb132-5"><a href="#cb132-5" aria-hidden="true" tabindex="-1"></a><span class="ex">substrate-contracts-node</span> <span class="at">--dev</span> <span class="at">--tmp</span></span>
<span id="cb132-6"><a href="#cb132-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb132-7"><a href="#cb132-7" aria-hidden="true" tabindex="-1"></a><span class="co"># The node will output connection information:</span></span>
<span id="cb132-8"><a href="#cb132-8" aria-hidden="true" tabindex="-1"></a><span class="co"># Local node identity: 12D3KooW...</span></span>
<span id="cb132-9"><a href="#cb132-9" aria-hidden="true" tabindex="-1"></a><span class="co"># Running JSON-RPC HTTP server: addr=127.0.0.1:9933</span></span>
<span id="cb132-10"><a href="#cb132-10" aria-hidden="true" tabindex="-1"></a><span class="co"># Running JSON-RPC WS server: addr=127.0.0.1:9944</span></span></code></pre></div>
<h3 id="contract-deployment-process">Contract Deployment Process</h3>
<div class="sourceCode" id="cb133"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb133-1"><a href="#cb133-1" aria-hidden="true" tabindex="-1"></a><span class="co"># 1. Build the contract</span></span>
<span id="cb133-2"><a href="#cb133-2" aria-hidden="true" tabindex="-1"></a><span class="ex">cargo</span> contract build <span class="at">--release</span></span>
<span id="cb133-3"><a href="#cb133-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb133-4"><a href="#cb133-4" aria-hidden="true" tabindex="-1"></a><span class="co"># 2. Deploy (instantiate) the contract</span></span>
<span id="cb133-5"><a href="#cb133-5" aria-hidden="true" tabindex="-1"></a><span class="ex">cargo</span> contract instantiate <span class="dt">\</span></span>
<span id="cb133-6"><a href="#cb133-6" aria-hidden="true" tabindex="-1"></a>    <span class="at">--constructor</span> new <span class="dt">\</span></span>
<span id="cb133-7"><a href="#cb133-7" aria-hidden="true" tabindex="-1"></a>    <span class="at">--args</span> 1000000 <span class="st">&quot;MyToken&quot;</span> <span class="st">&quot;MTK&quot;</span> 18 <span class="dt">\</span></span>
<span id="cb133-8"><a href="#cb133-8" aria-hidden="true" tabindex="-1"></a>    <span class="at">--suri</span> //Alice <span class="dt">\</span></span>
<span id="cb133-9"><a href="#cb133-9" aria-hidden="true" tabindex="-1"></a>    <span class="at">--url</span> ws://127.0.0.1:9944</span>
<span id="cb133-10"><a href="#cb133-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb133-11"><a href="#cb133-11" aria-hidden="true" tabindex="-1"></a><span class="co"># 3. Call contract methods</span></span>
<span id="cb133-12"><a href="#cb133-12" aria-hidden="true" tabindex="-1"></a><span class="ex">cargo</span> contract call <span class="dt">\</span></span>
<span id="cb133-13"><a href="#cb133-13" aria-hidden="true" tabindex="-1"></a>    <span class="at">--contract</span> 5GrwvaEF5zXb26Fz9rcQpDWS57CtERHpNehXCPcNoHGKutQY <span class="dt">\</span></span>
<span id="cb133-14"><a href="#cb133-14" aria-hidden="true" tabindex="-1"></a>    <span class="at">--message</span> transfer <span class="dt">\</span></span>
<span id="cb133-15"><a href="#cb133-15" aria-hidden="true" tabindex="-1"></a>    <span class="at">--args</span> 5FHneW46xGXgs5mUiveU4sbTyGBzmstUspZC92UhjJM694ty 1000 <span class="dt">\</span></span>
<span id="cb133-16"><a href="#cb133-16" aria-hidden="true" tabindex="-1"></a>    <span class="at">--suri</span> //Alice <span class="dt">\</span></span>
<span id="cb133-17"><a href="#cb133-17" aria-hidden="true" tabindex="-1"></a>    <span class="at">--url</span> ws://127.0.0.1:9944</span></code></pre></div>
<h2 id="using-contracts-ui">Using Contracts UI</h2>
<p>The Contracts UI provides a graphical interface for contract
interaction:</p>
<ol type="1">
<li><strong>Connect to Network</strong>: Navigate to <a
href="https://contracts-ui.substrate.io/">contracts-ui.substrate.io</a></li>
<li><strong>Upload Contract</strong>: Upload your <code>.contract</code>
file</li>
<li><strong>Instantiate</strong>: Deploy with constructor
parameters</li>
<li><strong>Interact</strong>: Call messages through the UI</li>
</ol>
<h3 id="ui-workflow-example">UI Workflow Example</h3>
<div class="sourceCode" id="cb134"><pre
class="sourceCode markdown"><code class="sourceCode markdown"><span id="cb134-1"><a href="#cb134-1" aria-hidden="true" tabindex="-1"></a><span class="ss">1. </span>Open Contracts UI</span>
<span id="cb134-2"><a href="#cb134-2" aria-hidden="true" tabindex="-1"></a><span class="ss">2. </span>Connect to ws://127.0.0.1:9944</span>
<span id="cb134-3"><a href="#cb134-3" aria-hidden="true" tabindex="-1"></a><span class="ss">3. </span>Click &quot;Upload a new contract&quot;</span>
<span id="cb134-4"><a href="#cb134-4" aria-hidden="true" tabindex="-1"></a><span class="ss">4. </span>Upload mytoken.contract file</span>
<span id="cb134-5"><a href="#cb134-5" aria-hidden="true" tabindex="-1"></a><span class="ss">5. </span>Click &quot;Deploy&quot; and fill constructor parameters:</span>
<span id="cb134-6"><a href="#cb134-6" aria-hidden="true" tabindex="-1"></a><span class="ss">   - </span>total_supply: 1000000</span>
<span id="cb134-7"><a href="#cb134-7" aria-hidden="true" tabindex="-1"></a><span class="ss">   - </span>name: &quot;MyToken&quot;</span>
<span id="cb134-8"><a href="#cb134-8" aria-hidden="true" tabindex="-1"></a><span class="ss">   - </span>symbol: &quot;MTK&quot;</span>
<span id="cb134-9"><a href="#cb134-9" aria-hidden="true" tabindex="-1"></a><span class="ss">   - </span>decimals: 18</span>
<span id="cb134-10"><a href="#cb134-10" aria-hidden="true" tabindex="-1"></a><span class="ss">6. </span>Click &quot;Deploy&quot; and sign transaction</span>
<span id="cb134-11"><a href="#cb134-11" aria-hidden="true" tabindex="-1"></a><span class="ss">7. </span>Navigate to deployed contract</span>
<span id="cb134-12"><a href="#cb134-12" aria-hidden="true" tabindex="-1"></a><span class="ss">8. </span>Call &quot;transfer&quot; message with recipient and amount</span></code></pre></div>
<h2 id="production-deployment-considerations">Production Deployment
Considerations</h2>
<h3 id="network-selection">Network Selection</h3>
<p><strong>Testnet Deployment (Recommended First):</strong></p>
<div class="sourceCode" id="cb135"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb135-1"><a href="#cb135-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Deploy to a testnet first (example with Rococo Contracts parachain)</span></span>
<span id="cb135-2"><a href="#cb135-2" aria-hidden="true" tabindex="-1"></a><span class="ex">cargo</span> contract instantiate <span class="dt">\</span></span>
<span id="cb135-3"><a href="#cb135-3" aria-hidden="true" tabindex="-1"></a>    <span class="at">--constructor</span> new <span class="dt">\</span></span>
<span id="cb135-4"><a href="#cb135-4" aria-hidden="true" tabindex="-1"></a>    <span class="at">--args</span> 1000000 <span class="st">&quot;MyToken&quot;</span> <span class="st">&quot;MTK&quot;</span> 18 <span class="dt">\</span></span>
<span id="cb135-5"><a href="#cb135-5" aria-hidden="true" tabindex="-1"></a>    <span class="at">--suri</span> <span class="st">&quot;your mnemonic phrase here&quot;</span> <span class="dt">\</span></span>
<span id="cb135-6"><a href="#cb135-6" aria-hidden="true" tabindex="-1"></a>    <span class="at">--url</span> wss://rococo-contracts-rpc.polkadot.io</span></code></pre></div>
<p><strong>Mainnet Deployment:</strong></p>
<div class="sourceCode" id="cb136"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb136-1"><a href="#cb136-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Deploy to mainnet (example)</span></span>
<span id="cb136-2"><a href="#cb136-2" aria-hidden="true" tabindex="-1"></a><span class="ex">cargo</span> contract instantiate <span class="dt">\</span></span>
<span id="cb136-3"><a href="#cb136-3" aria-hidden="true" tabindex="-1"></a>    <span class="at">--constructor</span> new <span class="dt">\</span></span>
<span id="cb136-4"><a href="#cb136-4" aria-hidden="true" tabindex="-1"></a>    <span class="at">--args</span> 1000000 <span class="st">&quot;MyToken&quot;</span> <span class="st">&quot;MTK&quot;</span> 18 <span class="dt">\</span></span>
<span id="cb136-5"><a href="#cb136-5" aria-hidden="true" tabindex="-1"></a>    <span class="at">--suri</span> <span class="st">&quot;your secure mnemonic phrase&quot;</span> <span class="dt">\</span></span>
<span id="cb136-6"><a href="#cb136-6" aria-hidden="true" tabindex="-1"></a>    <span class="at">--url</span> wss://mainnet-contracts-rpc.polkadot.io</span></code></pre></div>
<h3 id="security-checklist-for-production">Security Checklist for
Production</h3>
<ul class="task-list">
<li><label><input type="checkbox" />Contract audited by security
professionals</label></li>
<li><label><input type="checkbox" />All tests passing (unit,
integration, E2E)</label></li>
<li><label><input type="checkbox" />Gas limits tested and
optimized</label></li>
<li><label><input type="checkbox" />Access controls properly
implemented</label></li>
<li><label><input type="checkbox" />Emergency pause mechanisms in
place</label></li>
<li><label><input type="checkbox" />Upgrade mechanisms tested (if
applicable)</label></li>
<li><label><input type="checkbox" />Event emission verified</label></li>
<li><label><input type="checkbox" />Cross-contract calls
validated</label></li>
</ul>
<h3 id="deployment-script-example">Deployment Script Example</h3>
<div class="sourceCode" id="cb137"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb137-1"><a href="#cb137-1" aria-hidden="true" tabindex="-1"></a><span class="co">#!/bin/bash</span></span>
<span id="cb137-2"><a href="#cb137-2" aria-hidden="true" tabindex="-1"></a><span class="co"># deploy.sh - Production deployment script</span></span>
<span id="cb137-3"><a href="#cb137-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb137-4"><a href="#cb137-4" aria-hidden="true" tabindex="-1"></a><span class="bu">set</span> <span class="at">-e</span></span>
<span id="cb137-5"><a href="#cb137-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb137-6"><a href="#cb137-6" aria-hidden="true" tabindex="-1"></a><span class="va">NETWORK</span><span class="op">=</span><span class="va">${1</span><span class="op">:-</span><span class="st">&quot;testnet&quot;</span><span class="va">}</span></span>
<span id="cb137-7"><a href="#cb137-7" aria-hidden="true" tabindex="-1"></a><span class="va">CONTRACT_NAME</span><span class="op">=</span><span class="va">${2</span><span class="op">:-</span><span class="st">&quot;my_token&quot;</span><span class="va">}</span></span>
<span id="cb137-8"><a href="#cb137-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb137-9"><a href="#cb137-9" aria-hidden="true" tabindex="-1"></a><span class="bu">echo</span> <span class="st">&quot;Deploying </span><span class="va">$CONTRACT_NAME</span><span class="st"> to </span><span class="va">$NETWORK</span><span class="st">&quot;</span></span>
<span id="cb137-10"><a href="#cb137-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb137-11"><a href="#cb137-11" aria-hidden="true" tabindex="-1"></a><span class="co"># Build optimized contract</span></span>
<span id="cb137-12"><a href="#cb137-12" aria-hidden="true" tabindex="-1"></a><span class="bu">echo</span> <span class="st">&quot;Building contract...&quot;</span></span>
<span id="cb137-13"><a href="#cb137-13" aria-hidden="true" tabindex="-1"></a><span class="ex">cargo</span> contract build <span class="at">--release</span></span>
<span id="cb137-14"><a href="#cb137-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb137-15"><a href="#cb137-15" aria-hidden="true" tabindex="-1"></a><span class="co"># Verify build artifacts</span></span>
<span id="cb137-16"><a href="#cb137-16" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> <span class="bu">[</span> <span class="ot">!</span> <span class="ot">-f</span> <span class="st">&quot;target/ink/</span><span class="va">$CONTRACT_NAME</span><span class="st">.contract&quot;</span> <span class="bu">]</span><span class="kw">;</span> <span class="cf">then</span></span>
<span id="cb137-17"><a href="#cb137-17" aria-hidden="true" tabindex="-1"></a>    <span class="bu">echo</span> <span class="st">&quot;Error: Contract build failed&quot;</span></span>
<span id="cb137-18"><a href="#cb137-18" aria-hidden="true" tabindex="-1"></a>    <span class="bu">exit</span> 1</span>
<span id="cb137-19"><a href="#cb137-19" aria-hidden="true" tabindex="-1"></a><span class="cf">fi</span></span>
<span id="cb137-20"><a href="#cb137-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb137-21"><a href="#cb137-21" aria-hidden="true" tabindex="-1"></a><span class="co"># Deploy based on network</span></span>
<span id="cb137-22"><a href="#cb137-22" aria-hidden="true" tabindex="-1"></a><span class="cf">case</span> <span class="va">$NETWORK</span> <span class="kw">in</span></span>
<span id="cb137-23"><a href="#cb137-23" aria-hidden="true" tabindex="-1"></a>    <span class="st">&quot;testnet&quot;</span><span class="kw">)</span></span>
<span id="cb137-24"><a href="#cb137-24" aria-hidden="true" tabindex="-1"></a>        <span class="va">URL</span><span class="op">=</span><span class="st">&quot;wss://rococo-contracts-rpc.polkadot.io&quot;</span></span>
<span id="cb137-25"><a href="#cb137-25" aria-hidden="true" tabindex="-1"></a>        <span class="va">SURI</span><span class="op">=</span><span class="st">&quot;//Alice&quot;</span>  <span class="co"># Test account</span></span>
<span id="cb137-26"><a href="#cb137-26" aria-hidden="true" tabindex="-1"></a>        <span class="cf">;;</span></span>
<span id="cb137-27"><a href="#cb137-27" aria-hidden="true" tabindex="-1"></a>    <span class="st">&quot;mainnet&quot;</span><span class="kw">)</span></span>
<span id="cb137-28"><a href="#cb137-28" aria-hidden="true" tabindex="-1"></a>        <span class="va">URL</span><span class="op">=</span><span class="st">&quot;wss://mainnet-contracts-rpc.polkadot.io&quot;</span></span>
<span id="cb137-29"><a href="#cb137-29" aria-hidden="true" tabindex="-1"></a>        <span class="va">SURI</span><span class="op">=</span><span class="st">&quot;</span><span class="va">$PRODUCTION_SURI</span><span class="st">&quot;</span>  <span class="co"># Production account from env</span></span>
<span id="cb137-30"><a href="#cb137-30" aria-hidden="true" tabindex="-1"></a>        <span class="cf">;;</span></span>
<span id="cb137-31"><a href="#cb137-31" aria-hidden="true" tabindex="-1"></a>    <span class="pp">*</span><span class="kw">)</span></span>
<span id="cb137-32"><a href="#cb137-32" aria-hidden="true" tabindex="-1"></a>        <span class="bu">echo</span> <span class="st">&quot;Unknown network: </span><span class="va">$NETWORK</span><span class="st">&quot;</span></span>
<span id="cb137-33"><a href="#cb137-33" aria-hidden="true" tabindex="-1"></a>        <span class="bu">exit</span> 1</span>
<span id="cb137-34"><a href="#cb137-34" aria-hidden="true" tabindex="-1"></a>        <span class="cf">;;</span></span>
<span id="cb137-35"><a href="#cb137-35" aria-hidden="true" tabindex="-1"></a><span class="cf">esac</span></span>
<span id="cb137-36"><a href="#cb137-36" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb137-37"><a href="#cb137-37" aria-hidden="true" tabindex="-1"></a><span class="bu">echo</span> <span class="st">&quot;Deploying to </span><span class="va">$URL</span><span class="st">...&quot;</span></span>
<span id="cb137-38"><a href="#cb137-38" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb137-39"><a href="#cb137-39" aria-hidden="true" tabindex="-1"></a><span class="co"># Deploy contract</span></span>
<span id="cb137-40"><a href="#cb137-40" aria-hidden="true" tabindex="-1"></a><span class="va">CONTRACT_ADDRESS</span><span class="op">=</span><span class="va">$(</span><span class="ex">cargo</span> contract instantiate <span class="dt">\</span></span>
<span id="cb137-41"><a href="#cb137-41" aria-hidden="true" tabindex="-1"></a>    <span class="at">--constructor</span> new <span class="dt">\</span></span>
<span id="cb137-42"><a href="#cb137-42" aria-hidden="true" tabindex="-1"></a>    <span class="at">--args</span> 1000000 <span class="st">&quot;ProductionToken&quot;</span> <span class="st">&quot;PROD&quot;</span> 18 <span class="dt">\</span></span>
<span id="cb137-43"><a href="#cb137-43" aria-hidden="true" tabindex="-1"></a>    <span class="at">--suri</span> <span class="st">&quot;</span><span class="va">$SURI</span><span class="st">&quot;</span> <span class="dt">\</span></span>
<span id="cb137-44"><a href="#cb137-44" aria-hidden="true" tabindex="-1"></a>    <span class="at">--url</span> <span class="st">&quot;</span><span class="va">$URL</span><span class="st">&quot;</span> <span class="dt">\</span></span>
<span id="cb137-45"><a href="#cb137-45" aria-hidden="true" tabindex="-1"></a>    <span class="at">--output-json</span> <span class="kw">|</span> <span class="ex">jq</span> <span class="at">-r</span> <span class="st">&#39;.contract&#39;</span><span class="va">)</span></span>
<span id="cb137-46"><a href="#cb137-46" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb137-47"><a href="#cb137-47" aria-hidden="true" tabindex="-1"></a><span class="bu">echo</span> <span class="st">&quot;Contract deployed at: </span><span class="va">$CONTRACT_ADDRESS</span><span class="st">&quot;</span></span>
<span id="cb137-48"><a href="#cb137-48" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb137-49"><a href="#cb137-49" aria-hidden="true" tabindex="-1"></a><span class="co"># Verify deployment</span></span>
<span id="cb137-50"><a href="#cb137-50" aria-hidden="true" tabindex="-1"></a><span class="bu">echo</span> <span class="st">&quot;Verifying deployment...&quot;</span></span>
<span id="cb137-51"><a href="#cb137-51" aria-hidden="true" tabindex="-1"></a><span class="ex">cargo</span> contract call <span class="dt">\</span></span>
<span id="cb137-52"><a href="#cb137-52" aria-hidden="true" tabindex="-1"></a>    <span class="at">--contract</span> <span class="st">&quot;</span><span class="va">$CONTRACT_ADDRESS</span><span class="st">&quot;</span> <span class="dt">\</span></span>
<span id="cb137-53"><a href="#cb137-53" aria-hidden="true" tabindex="-1"></a>    <span class="at">--message</span> total_supply <span class="dt">\</span></span>
<span id="cb137-54"><a href="#cb137-54" aria-hidden="true" tabindex="-1"></a>    <span class="at">--suri</span> <span class="st">&quot;</span><span class="va">$SURI</span><span class="st">&quot;</span> <span class="dt">\</span></span>
<span id="cb137-55"><a href="#cb137-55" aria-hidden="true" tabindex="-1"></a>    <span class="at">--url</span> <span class="st">&quot;</span><span class="va">$URL</span><span class="st">&quot;</span> <span class="dt">\</span></span>
<span id="cb137-56"><a href="#cb137-56" aria-hidden="true" tabindex="-1"></a>    <span class="at">--dry-run</span></span>
<span id="cb137-57"><a href="#cb137-57" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb137-58"><a href="#cb137-58" aria-hidden="true" tabindex="-1"></a><span class="bu">echo</span> <span class="st">&quot;Deployment successful!&quot;</span></span></code></pre></div>
<h2 id="contract-interaction-patterns">Contract Interaction
Patterns</h2>
<h3 id="cli-interaction-examples">CLI Interaction Examples</h3>
<div class="sourceCode" id="cb138"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb138-1"><a href="#cb138-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Query contract state (dry run - no gas cost)</span></span>
<span id="cb138-2"><a href="#cb138-2" aria-hidden="true" tabindex="-1"></a><span class="ex">cargo</span> contract call <span class="dt">\</span></span>
<span id="cb138-3"><a href="#cb138-3" aria-hidden="true" tabindex="-1"></a>    <span class="at">--contract</span> <span class="va">$CONTRACT_ADDR</span> <span class="dt">\</span></span>
<span id="cb138-4"><a href="#cb138-4" aria-hidden="true" tabindex="-1"></a>    <span class="at">--message</span> balance_of <span class="dt">\</span></span>
<span id="cb138-5"><a href="#cb138-5" aria-hidden="true" tabindex="-1"></a>    <span class="at">--args</span> 5GrwvaEF5zXb26Fz9rcQpDWS57CtERHpNehXCPcNoHGKutQY <span class="dt">\</span></span>
<span id="cb138-6"><a href="#cb138-6" aria-hidden="true" tabindex="-1"></a>    <span class="at">--suri</span> //Alice <span class="dt">\</span></span>
<span id="cb138-7"><a href="#cb138-7" aria-hidden="true" tabindex="-1"></a>    <span class="at">--dry-run</span></span>
<span id="cb138-8"><a href="#cb138-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb138-9"><a href="#cb138-9" aria-hidden="true" tabindex="-1"></a><span class="co"># Execute state-changing transaction</span></span>
<span id="cb138-10"><a href="#cb138-10" aria-hidden="true" tabindex="-1"></a><span class="ex">cargo</span> contract call <span class="dt">\</span></span>
<span id="cb138-11"><a href="#cb138-11" aria-hidden="true" tabindex="-1"></a>    <span class="at">--contract</span> <span class="va">$CONTRACT_ADDR</span> <span class="dt">\</span></span>
<span id="cb138-12"><a href="#cb138-12" aria-hidden="true" tabindex="-1"></a>    <span class="at">--message</span> transfer <span class="dt">\</span></span>
<span id="cb138-13"><a href="#cb138-13" aria-hidden="true" tabindex="-1"></a>    <span class="at">--args</span> 5FHneW46xGXgs5mUiveU4sbTyGBzmstUspZC92UhjJM694ty 1000 <span class="dt">\</span></span>
<span id="cb138-14"><a href="#cb138-14" aria-hidden="true" tabindex="-1"></a>    <span class="at">--suri</span> //Alice <span class="dt">\</span></span>
<span id="cb138-15"><a href="#cb138-15" aria-hidden="true" tabindex="-1"></a>    <span class="at">--gas-limit</span> 100000000000 <span class="dt">\</span></span>
<span id="cb138-16"><a href="#cb138-16" aria-hidden="true" tabindex="-1"></a>    <span class="at">--proof-size</span> 1000000</span></code></pre></div>
<h3 id="javascripttypescript-integration">JavaScript/TypeScript
Integration</h3>
<div class="sourceCode" id="cb139"><pre
class="sourceCode typescript"><code class="sourceCode typescript"><span id="cb139-1"><a href="#cb139-1" aria-hidden="true" tabindex="-1"></a><span class="co">// contract-client.ts</span></span>
<span id="cb139-2"><a href="#cb139-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> { ApiPromise<span class="op">,</span> WsProvider } <span class="im">from</span> <span class="st">&#39;@polkadot/api&#39;</span><span class="op">;</span></span>
<span id="cb139-3"><a href="#cb139-3" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> { ContractPromise } <span class="im">from</span> <span class="st">&#39;@polkadot/api-contract&#39;</span><span class="op">;</span></span>
<span id="cb139-4"><a href="#cb139-4" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> metadata <span class="im">from</span> <span class="st">&#39;./metadata.json&#39;</span><span class="op">;</span></span>
<span id="cb139-5"><a href="#cb139-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb139-6"><a href="#cb139-6" aria-hidden="true" tabindex="-1"></a><span class="kw">async</span> <span class="kw">function</span> <span class="fu">connectToContract</span>() {</span>
<span id="cb139-7"><a href="#cb139-7" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> wsProvider <span class="op">=</span> <span class="kw">new</span> <span class="fu">WsProvider</span>(<span class="st">&#39;ws://127.0.0.1:9944&#39;</span>)<span class="op">;</span></span>
<span id="cb139-8"><a href="#cb139-8" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> api <span class="op">=</span> <span class="cf">await</span> ApiPromise<span class="op">.</span><span class="fu">create</span>({ provider<span class="op">:</span> wsProvider })<span class="op">;</span></span>
<span id="cb139-9"><a href="#cb139-9" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb139-10"><a href="#cb139-10" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> contractAddress <span class="op">=</span> <span class="st">&#39;5GrwvaEF5zXb26Fz9rcQpDWS57CtERHpNehXCPcNoHGKutQY&#39;</span><span class="op">;</span></span>
<span id="cb139-11"><a href="#cb139-11" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> contract <span class="op">=</span> <span class="kw">new</span> <span class="fu">ContractPromise</span>(api<span class="op">,</span> metadata<span class="op">,</span> contractAddress)<span class="op">;</span></span>
<span id="cb139-12"><a href="#cb139-12" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb139-13"><a href="#cb139-13" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> { api<span class="op">,</span> contract }<span class="op">;</span></span>
<span id="cb139-14"><a href="#cb139-14" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb139-15"><a href="#cb139-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb139-16"><a href="#cb139-16" aria-hidden="true" tabindex="-1"></a><span class="kw">async</span> <span class="kw">function</span> <span class="fu">queryBalance</span>(userAddress<span class="op">:</span> <span class="dt">string</span>) {</span>
<span id="cb139-17"><a href="#cb139-17" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> { contract } <span class="op">=</span> <span class="cf">await</span> <span class="fu">connectToContract</span>()<span class="op">;</span></span>
<span id="cb139-18"><a href="#cb139-18" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb139-19"><a href="#cb139-19" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> { result<span class="op">,</span> output } <span class="op">=</span> <span class="cf">await</span> contract<span class="op">.</span><span class="at">query</span><span class="op">.</span><span class="fu">balanceOf</span>(</span>
<span id="cb139-20"><a href="#cb139-20" aria-hidden="true" tabindex="-1"></a>        userAddress<span class="op">,</span></span>
<span id="cb139-21"><a href="#cb139-21" aria-hidden="true" tabindex="-1"></a>        { gasLimit<span class="op">:</span> <span class="op">-</span><span class="dv">1</span> }<span class="op">,</span></span>
<span id="cb139-22"><a href="#cb139-22" aria-hidden="true" tabindex="-1"></a>        userAddress</span>
<span id="cb139-23"><a href="#cb139-23" aria-hidden="true" tabindex="-1"></a>    )<span class="op">;</span></span>
<span id="cb139-24"><a href="#cb139-24" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb139-25"><a href="#cb139-25" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (result<span class="op">.</span><span class="at">isOk</span>) {</span>
<span id="cb139-26"><a href="#cb139-26" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> output<span class="op">?.</span><span class="fu">toHuman</span>()<span class="op">;</span></span>
<span id="cb139-27"><a href="#cb139-27" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb139-28"><a href="#cb139-28" aria-hidden="true" tabindex="-1"></a>    <span class="cf">throw</span> <span class="kw">new</span> <span class="bu">Error</span>(<span class="st">&#39;Query failed&#39;</span>)<span class="op">;</span></span>
<span id="cb139-29"><a href="#cb139-29" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb139-30"><a href="#cb139-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb139-31"><a href="#cb139-31" aria-hidden="true" tabindex="-1"></a><span class="kw">async</span> <span class="kw">function</span> <span class="fu">transferTokens</span>(fromKeypair<span class="op">:</span> <span class="dt">any</span><span class="op">,</span> to<span class="op">:</span> <span class="dt">string</span><span class="op">,</span> amount<span class="op">:</span> <span class="dt">number</span>) {</span>
<span id="cb139-32"><a href="#cb139-32" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> { api<span class="op">,</span> contract } <span class="op">=</span> <span class="cf">await</span> <span class="fu">connectToContract</span>()<span class="op">;</span></span>
<span id="cb139-33"><a href="#cb139-33" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb139-34"><a href="#cb139-34" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> tx <span class="op">=</span> contract<span class="op">.</span><span class="at">tx</span><span class="op">.</span><span class="fu">transfer</span>(</span>
<span id="cb139-35"><a href="#cb139-35" aria-hidden="true" tabindex="-1"></a>        { gasLimit<span class="op">:</span> <span class="dv">100000000000</span> }<span class="op">,</span></span>
<span id="cb139-36"><a href="#cb139-36" aria-hidden="true" tabindex="-1"></a>        to<span class="op">,</span></span>
<span id="cb139-37"><a href="#cb139-37" aria-hidden="true" tabindex="-1"></a>        amount</span>
<span id="cb139-38"><a href="#cb139-38" aria-hidden="true" tabindex="-1"></a>    )<span class="op">;</span></span>
<span id="cb139-39"><a href="#cb139-39" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb139-40"><a href="#cb139-40" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="kw">new</span> <span class="bu">Promise</span>((resolve<span class="op">,</span> reject) <span class="kw">=&gt;</span> {</span>
<span id="cb139-41"><a href="#cb139-41" aria-hidden="true" tabindex="-1"></a>        tx<span class="op">.</span><span class="fu">signAndSend</span>(fromKeypair<span class="op">,</span> (result) <span class="kw">=&gt;</span> {</span>
<span id="cb139-42"><a href="#cb139-42" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> (result<span class="op">.</span><span class="at">status</span><span class="op">.</span><span class="at">isFinalized</span>) {</span>
<span id="cb139-43"><a href="#cb139-43" aria-hidden="true" tabindex="-1"></a>                <span class="fu">resolve</span>(result)<span class="op">;</span></span>
<span id="cb139-44"><a href="#cb139-44" aria-hidden="true" tabindex="-1"></a>            } <span class="cf">else</span> <span class="cf">if</span> (result<span class="op">.</span><span class="at">status</span><span class="op">.</span><span class="at">isDropped</span>) {</span>
<span id="cb139-45"><a href="#cb139-45" aria-hidden="true" tabindex="-1"></a>                <span class="fu">reject</span>(<span class="kw">new</span> <span class="bu">Error</span>(<span class="st">&#39;Transaction dropped&#39;</span>))<span class="op">;</span></span>
<span id="cb139-46"><a href="#cb139-46" aria-hidden="true" tabindex="-1"></a>            }</span>
<span id="cb139-47"><a href="#cb139-47" aria-hidden="true" tabindex="-1"></a>        })<span class="op">;</span></span>
<span id="cb139-48"><a href="#cb139-48" aria-hidden="true" tabindex="-1"></a>    })<span class="op">;</span></span>
<span id="cb139-49"><a href="#cb139-49" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<h2 id="monitoring-and-maintenance">Monitoring and Maintenance</h2>
<h3 id="event-monitoring">Event Monitoring</h3>
<div class="sourceCode" id="cb140"><pre
class="sourceCode typescript"><code class="sourceCode typescript"><span id="cb140-1"><a href="#cb140-1" aria-hidden="true" tabindex="-1"></a><span class="co">// event-monitor.ts</span></span>
<span id="cb140-2"><a href="#cb140-2" aria-hidden="true" tabindex="-1"></a><span class="kw">async</span> <span class="kw">function</span> <span class="fu">monitorTransferEvents</span>() {</span>
<span id="cb140-3"><a href="#cb140-3" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> { api<span class="op">,</span> contract } <span class="op">=</span> <span class="cf">await</span> <span class="fu">connectToContract</span>()<span class="op">;</span></span>
<span id="cb140-4"><a href="#cb140-4" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb140-5"><a href="#cb140-5" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Subscribe to contract events</span></span>
<span id="cb140-6"><a href="#cb140-6" aria-hidden="true" tabindex="-1"></a>    <span class="cf">await</span> api<span class="op">.</span><span class="at">query</span><span class="op">.</span><span class="at">system</span><span class="op">.</span><span class="fu">events</span>((events) <span class="kw">=&gt;</span> {</span>
<span id="cb140-7"><a href="#cb140-7" aria-hidden="true" tabindex="-1"></a>        events<span class="op">.</span><span class="fu">forEach</span>((record) <span class="kw">=&gt;</span> {</span>
<span id="cb140-8"><a href="#cb140-8" aria-hidden="true" tabindex="-1"></a>            <span class="kw">const</span> { <span class="bu">event</span> } <span class="op">=</span> record<span class="op">;</span></span>
<span id="cb140-9"><a href="#cb140-9" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb140-10"><a href="#cb140-10" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> (api<span class="op">.</span><span class="at">events</span><span class="op">.</span><span class="at">contracts</span><span class="op">.</span><span class="at">ContractEmitted</span><span class="op">.</span><span class="fu">is</span>(<span class="bu">event</span>)) {</span>
<span id="cb140-11"><a href="#cb140-11" aria-hidden="true" tabindex="-1"></a>                <span class="kw">const</span> [contractAddress<span class="op">,</span> data] <span class="op">=</span> <span class="bu">event</span><span class="op">.</span><span class="at">data</span><span class="op">;</span></span>
<span id="cb140-12"><a href="#cb140-12" aria-hidden="true" tabindex="-1"></a>                </span>
<span id="cb140-13"><a href="#cb140-13" aria-hidden="true" tabindex="-1"></a>                <span class="co">// Decode contract event</span></span>
<span id="cb140-14"><a href="#cb140-14" aria-hidden="true" tabindex="-1"></a>                <span class="kw">const</span> decodedEvent <span class="op">=</span> contract<span class="op">.</span><span class="at">abi</span><span class="op">.</span><span class="fu">decodeEvent</span>(data)<span class="op">;</span></span>
<span id="cb140-15"><a href="#cb140-15" aria-hidden="true" tabindex="-1"></a>                </span>
<span id="cb140-16"><a href="#cb140-16" aria-hidden="true" tabindex="-1"></a>                <span class="cf">if</span> (decodedEvent<span class="op">.</span><span class="at">event</span><span class="op">.</span><span class="at">identifier</span> <span class="op">===</span> <span class="st">&#39;Transfer&#39;</span>) {</span>
<span id="cb140-17"><a href="#cb140-17" aria-hidden="true" tabindex="-1"></a>                    <span class="bu">console</span><span class="op">.</span><span class="fu">log</span>(<span class="st">&#39;Transfer event:&#39;</span><span class="op">,</span> decodedEvent<span class="op">.</span><span class="at">args</span>)<span class="op">;</span></span>
<span id="cb140-18"><a href="#cb140-18" aria-hidden="true" tabindex="-1"></a>                }</span>
<span id="cb140-19"><a href="#cb140-19" aria-hidden="true" tabindex="-1"></a>            }</span>
<span id="cb140-20"><a href="#cb140-20" aria-hidden="true" tabindex="-1"></a>        })<span class="op">;</span></span>
<span id="cb140-21"><a href="#cb140-21" aria-hidden="true" tabindex="-1"></a>    })<span class="op">;</span></span>
<span id="cb140-22"><a href="#cb140-22" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<h3 id="health-checks">Health Checks</h3>
<div class="sourceCode" id="cb141"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb141-1"><a href="#cb141-1" aria-hidden="true" tabindex="-1"></a><span class="co">#!/bin/bash</span></span>
<span id="cb141-2"><a href="#cb141-2" aria-hidden="true" tabindex="-1"></a><span class="co"># health-check.sh</span></span>
<span id="cb141-3"><a href="#cb141-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb141-4"><a href="#cb141-4" aria-hidden="true" tabindex="-1"></a><span class="va">CONTRACT_ADDR</span><span class="op">=</span><span class="st">&quot;5GrwvaEF5zXb26Fz9rcQpDWS57CtERHpNehXCPcNoHGKutQY&quot;</span></span>
<span id="cb141-5"><a href="#cb141-5" aria-hidden="true" tabindex="-1"></a><span class="va">URL</span><span class="op">=</span><span class="st">&quot;wss://rococo-contracts-rpc.polkadot.io&quot;</span></span>
<span id="cb141-6"><a href="#cb141-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb141-7"><a href="#cb141-7" aria-hidden="true" tabindex="-1"></a><span class="co"># Check if contract is responsive</span></span>
<span id="cb141-8"><a href="#cb141-8" aria-hidden="true" tabindex="-1"></a><span class="bu">echo</span> <span class="st">&quot;Checking contract health...&quot;</span></span>
<span id="cb141-9"><a href="#cb141-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb141-10"><a href="#cb141-10" aria-hidden="true" tabindex="-1"></a><span class="va">RESPONSE</span><span class="op">=</span><span class="va">$(</span><span class="ex">cargo</span> contract call <span class="dt">\</span></span>
<span id="cb141-11"><a href="#cb141-11" aria-hidden="true" tabindex="-1"></a>    <span class="at">--contract</span> <span class="va">$CONTRACT_ADDR</span> <span class="dt">\</span></span>
<span id="cb141-12"><a href="#cb141-12" aria-hidden="true" tabindex="-1"></a>    <span class="at">--message</span> total_supply <span class="dt">\</span></span>
<span id="cb141-13"><a href="#cb141-13" aria-hidden="true" tabindex="-1"></a>    <span class="at">--suri</span> //Alice <span class="dt">\</span></span>
<span id="cb141-14"><a href="#cb141-14" aria-hidden="true" tabindex="-1"></a>    <span class="at">--url</span> <span class="va">$URL</span> <span class="dt">\</span></span>
<span id="cb141-15"><a href="#cb141-15" aria-hidden="true" tabindex="-1"></a>    <span class="at">--dry-run</span> <span class="dt">\</span></span>
<span id="cb141-16"><a href="#cb141-16" aria-hidden="true" tabindex="-1"></a>    <span class="at">--output-json</span> <span class="dv">2</span><span class="op">&gt;</span>/dev/null<span class="va">)</span></span>
<span id="cb141-17"><a href="#cb141-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb141-18"><a href="#cb141-18" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> <span class="bu">[</span> <span class="va">$?</span> <span class="ot">-eq</span> 0 <span class="bu">]</span><span class="kw">;</span> <span class="cf">then</span></span>
<span id="cb141-19"><a href="#cb141-19" aria-hidden="true" tabindex="-1"></a>    <span class="va">TOTAL_SUPPLY</span><span class="op">=</span><span class="va">$(</span><span class="bu">echo</span> <span class="va">$RESPONSE</span> <span class="kw">|</span> <span class="ex">jq</span> <span class="at">-r</span> <span class="st">&#39;.data.Ok&#39;</span><span class="va">)</span></span>
<span id="cb141-20"><a href="#cb141-20" aria-hidden="true" tabindex="-1"></a>    <span class="bu">echo</span> <span class="st">&quot;✅ Contract healthy - Total supply: </span><span class="va">$TOTAL_SUPPLY</span><span class="st">&quot;</span></span>
<span id="cb141-21"><a href="#cb141-21" aria-hidden="true" tabindex="-1"></a><span class="cf">else</span></span>
<span id="cb141-22"><a href="#cb141-22" aria-hidden="true" tabindex="-1"></a>    <span class="bu">echo</span> <span class="st">&quot;❌ Contract health check failed&quot;</span></span>
<span id="cb141-23"><a href="#cb141-23" aria-hidden="true" tabindex="-1"></a>    <span class="bu">exit</span> 1</span>
<span id="cb141-24"><a href="#cb141-24" aria-hidden="true" tabindex="-1"></a><span class="cf">fi</span></span></code></pre></div>
<h2 id="summary-8">Summary</h2>
<p>Successfully deploying and maintaining ink! contracts in production
requires:</p>
<p><strong>Deployment Pipeline:</strong> - Local testing with
substrate-contracts-node - Testnet validation before mainnet deployment
- Automated deployment scripts with proper error handling</p>
<p><strong>Interaction Methods:</strong> - CLI tools for direct contract
interaction - Web UI for user-friendly management -
JavaScript/TypeScript SDKs for application integration</p>
<p><strong>Production Readiness:</strong> - Comprehensive security
audits - Performance optimization and gas testing - Monitoring and
alerting systems - Emergency response procedures</p>
<p><strong>Maintenance Operations:</strong> - Event monitoring for
application state tracking - Health checks for contract availability -
Performance monitoring for gas optimization - Upgrade procedures for
contract evolution</p>
<p>With proper deployment and interaction patterns, your ink! contracts
can operate reliably in production environments while providing clear
interfaces for users and applications.</p>
<hr />
<h1
id="chapter-10-capstone-project-building-a-decentralized-autonomous-organization-dao">Chapter
10: Capstone Project: Building a Decentralized Autonomous Organization
(DAO)</h1>
<p>To bring the pieces together, we implement a DAO that people can join
by paying a fee, where members can propose actions, vote within a
window, and—if thresholds are met—execute the proposal: transfer from a
treasury, change membership fees, adjust voting parameters, or update
membership itself. The storage is a handful of mappings and counters;
the rules are ordinary but explicit; the messages are few and well
named; the errors speak plainly. The contract emits events when members
join, proposals appear, votes are cast, and actions are executed. Tests
cover creation, joining, proposing, voting, and execution, and they
check the edge cases where good systems often fail: double votes,
expired windows, insufficient funds, unauthorized calls. It is not a
governance revolution—it is a working, audited‑by‑tests example that you
can grow into your own culture.</p>
<p>This capstone project synthesizes everything you’ve learned by
building a complete DAO contract. We’ll implement membership management,
proposal creation and voting, treasury management, and governance
mechanisms that demonstrate production-ready ink! development.</p>
<h2 id="dao-architecture-overview">DAO Architecture Overview</h2>
<p>Our DAO will feature: - <strong>Membership System</strong>: Join by
payment, member verification - <strong>Proposal Management</strong>:
Create, vote on, and execute proposals - <strong>Treasury
Management</strong>: Collective fund management -
<strong>Governance</strong>: Configurable voting parameters and
thresholds</p>
<h2 id="core-dao-contract-implementation">Core DAO Contract
Implementation</h2>
<div class="sourceCode" id="cb142"><pre
class="sourceCode rust"><code class="sourceCode rust"><span id="cb142-1"><a href="#cb142-1" aria-hidden="true" tabindex="-1"></a><span class="at">#![</span>cfg_attr<span class="at">(</span>not<span class="at">(</span>feature <span class="op">=</span> <span class="st">&quot;std&quot;</span><span class="at">)</span><span class="op">,</span> no_std<span class="at">)]</span></span>
<span id="cb142-2"><a href="#cb142-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb142-3"><a href="#cb142-3" aria-hidden="true" tabindex="-1"></a><span class="at">#[</span><span class="pp">ink::</span>contract<span class="at">]</span></span>
<span id="cb142-4"><a href="#cb142-4" aria-hidden="true" tabindex="-1"></a><span class="kw">mod</span> dao <span class="op">{</span></span>
<span id="cb142-5"><a href="#cb142-5" aria-hidden="true" tabindex="-1"></a>    <span class="kw">use</span> <span class="pp">ink::storage::</span>Mapping<span class="op">;</span></span>
<span id="cb142-6"><a href="#cb142-6" aria-hidden="true" tabindex="-1"></a>    <span class="kw">use</span> <span class="pp">ink::prelude::</span><span class="op">{</span><span class="pp">vec::</span><span class="dt">Vec</span><span class="op">,</span> <span class="pp">string::</span><span class="dt">String</span><span class="op">};</span></span>
<span id="cb142-7"><a href="#cb142-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb142-8"><a href="#cb142-8" aria-hidden="true" tabindex="-1"></a>    <span class="co">/// The DAO storage structure</span></span>
<span id="cb142-9"><a href="#cb142-9" aria-hidden="true" tabindex="-1"></a>    <span class="at">#[</span>ink<span class="at">(</span>storage<span class="at">)]</span></span>
<span id="cb142-10"><a href="#cb142-10" aria-hidden="true" tabindex="-1"></a>    <span class="kw">pub</span> <span class="kw">struct</span> Dao <span class="op">{</span></span>
<span id="cb142-11"><a href="#cb142-11" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Membership management</span></span>
<span id="cb142-12"><a href="#cb142-12" aria-hidden="true" tabindex="-1"></a>        members<span class="op">:</span> Mapping<span class="op">&lt;</span>AccountId<span class="op">,</span> Member<span class="op">&gt;,</span></span>
<span id="cb142-13"><a href="#cb142-13" aria-hidden="true" tabindex="-1"></a>        member_count<span class="op">:</span> <span class="dt">u32</span><span class="op">,</span></span>
<span id="cb142-14"><a href="#cb142-14" aria-hidden="true" tabindex="-1"></a>        membership_fee<span class="op">:</span> Balance<span class="op">,</span></span>
<span id="cb142-15"><a href="#cb142-15" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb142-16"><a href="#cb142-16" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Proposal management  </span></span>
<span id="cb142-17"><a href="#cb142-17" aria-hidden="true" tabindex="-1"></a>        proposals<span class="op">:</span> Mapping<span class="op">&lt;</span><span class="dt">u32</span><span class="op">,</span> Proposal<span class="op">&gt;,</span></span>
<span id="cb142-18"><a href="#cb142-18" aria-hidden="true" tabindex="-1"></a>        next_proposal_id<span class="op">:</span> <span class="dt">u32</span><span class="op">,</span></span>
<span id="cb142-19"><a href="#cb142-19" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb142-20"><a href="#cb142-20" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Voting configuration</span></span>
<span id="cb142-21"><a href="#cb142-21" aria-hidden="true" tabindex="-1"></a>        voting_period<span class="op">:</span> <span class="dt">u64</span><span class="op">,</span>        <span class="co">// Milliseconds</span></span>
<span id="cb142-22"><a href="#cb142-22" aria-hidden="true" tabindex="-1"></a>        quorum_threshold<span class="op">:</span> <span class="dt">u32</span><span class="op">,</span>     <span class="co">// Percentage (0-100)</span></span>
<span id="cb142-23"><a href="#cb142-23" aria-hidden="true" tabindex="-1"></a>        approval_threshold<span class="op">:</span> <span class="dt">u32</span><span class="op">,</span>   <span class="co">// Percentage (0-100)</span></span>
<span id="cb142-24"><a href="#cb142-24" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb142-25"><a href="#cb142-25" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Treasury</span></span>
<span id="cb142-26"><a href="#cb142-26" aria-hidden="true" tabindex="-1"></a>        treasury_balance<span class="op">:</span> Balance<span class="op">,</span></span>
<span id="cb142-27"><a href="#cb142-27" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb142-28"><a href="#cb142-28" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Governance</span></span>
<span id="cb142-29"><a href="#cb142-29" aria-hidden="true" tabindex="-1"></a>        owner<span class="op">:</span> AccountId<span class="op">,</span></span>
<span id="cb142-30"><a href="#cb142-30" aria-hidden="true" tabindex="-1"></a>        paused<span class="op">:</span> <span class="dt">bool</span><span class="op">,</span></span>
<span id="cb142-31"><a href="#cb142-31" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb142-32"><a href="#cb142-32" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb142-33"><a href="#cb142-33" aria-hidden="true" tabindex="-1"></a>    <span class="co">/// Member information</span></span>
<span id="cb142-34"><a href="#cb142-34" aria-hidden="true" tabindex="-1"></a>    <span class="at">#[</span>derive<span class="at">(</span><span class="bu">Debug</span><span class="op">,</span> <span class="bu">Clone</span><span class="op">,</span> <span class="bu">PartialEq</span><span class="op">,</span> <span class="bu">Eq</span><span class="op">,</span> <span class="pp">scale::</span>Encode<span class="op">,</span> <span class="pp">scale::</span>Decode<span class="at">)]</span></span>
<span id="cb142-35"><a href="#cb142-35" aria-hidden="true" tabindex="-1"></a>    <span class="at">#[</span>cfg_attr<span class="at">(</span>feature <span class="op">=</span> <span class="st">&quot;std&quot;</span><span class="op">,</span> derive<span class="at">(</span><span class="pp">scale_info::</span>TypeInfo<span class="at">))]</span></span>
<span id="cb142-36"><a href="#cb142-36" aria-hidden="true" tabindex="-1"></a>    <span class="kw">pub</span> <span class="kw">struct</span> Member <span class="op">{</span></span>
<span id="cb142-37"><a href="#cb142-37" aria-hidden="true" tabindex="-1"></a>        <span class="kw">pub</span> joined_at<span class="op">:</span> <span class="dt">u64</span><span class="op">,</span></span>
<span id="cb142-38"><a href="#cb142-38" aria-hidden="true" tabindex="-1"></a>        <span class="kw">pub</span> voting_power<span class="op">:</span> <span class="dt">u32</span><span class="op">,</span></span>
<span id="cb142-39"><a href="#cb142-39" aria-hidden="true" tabindex="-1"></a>        <span class="kw">pub</span> proposals_created<span class="op">:</span> <span class="dt">u32</span><span class="op">,</span></span>
<span id="cb142-40"><a href="#cb142-40" aria-hidden="true" tabindex="-1"></a>        <span class="kw">pub</span> votes_cast<span class="op">:</span> <span class="dt">u32</span><span class="op">,</span></span>
<span id="cb142-41"><a href="#cb142-41" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb142-42"><a href="#cb142-42" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb142-43"><a href="#cb142-43" aria-hidden="true" tabindex="-1"></a>    <span class="co">/// Proposal structure</span></span>
<span id="cb142-44"><a href="#cb142-44" aria-hidden="true" tabindex="-1"></a>    <span class="at">#[</span>derive<span class="at">(</span><span class="bu">Debug</span><span class="op">,</span> <span class="bu">Clone</span><span class="op">,</span> <span class="bu">PartialEq</span><span class="op">,</span> <span class="bu">Eq</span><span class="op">,</span> <span class="pp">scale::</span>Encode<span class="op">,</span> <span class="pp">scale::</span>Decode<span class="at">)]</span></span>
<span id="cb142-45"><a href="#cb142-45" aria-hidden="true" tabindex="-1"></a>    <span class="at">#[</span>cfg_attr<span class="at">(</span>feature <span class="op">=</span> <span class="st">&quot;std&quot;</span><span class="op">,</span> derive<span class="at">(</span><span class="pp">scale_info::</span>TypeInfo<span class="at">))]</span></span>
<span id="cb142-46"><a href="#cb142-46" aria-hidden="true" tabindex="-1"></a>    <span class="kw">pub</span> <span class="kw">struct</span> Proposal <span class="op">{</span></span>
<span id="cb142-47"><a href="#cb142-47" aria-hidden="true" tabindex="-1"></a>        <span class="kw">pub</span> id<span class="op">:</span> <span class="dt">u32</span><span class="op">,</span></span>
<span id="cb142-48"><a href="#cb142-48" aria-hidden="true" tabindex="-1"></a>        <span class="kw">pub</span> proposer<span class="op">:</span> AccountId<span class="op">,</span></span>
<span id="cb142-49"><a href="#cb142-49" aria-hidden="true" tabindex="-1"></a>        <span class="kw">pub</span> title<span class="op">:</span> <span class="dt">String</span><span class="op">,</span></span>
<span id="cb142-50"><a href="#cb142-50" aria-hidden="true" tabindex="-1"></a>        <span class="kw">pub</span> description<span class="op">:</span> <span class="dt">String</span><span class="op">,</span></span>
<span id="cb142-51"><a href="#cb142-51" aria-hidden="true" tabindex="-1"></a>        <span class="kw">pub</span> proposal_type<span class="op">:</span> ProposalType<span class="op">,</span></span>
<span id="cb142-52"><a href="#cb142-52" aria-hidden="true" tabindex="-1"></a>        <span class="kw">pub</span> created_at<span class="op">:</span> <span class="dt">u64</span><span class="op">,</span></span>
<span id="cb142-53"><a href="#cb142-53" aria-hidden="true" tabindex="-1"></a>        <span class="kw">pub</span> voting_deadline<span class="op">:</span> <span class="dt">u64</span><span class="op">,</span></span>
<span id="cb142-54"><a href="#cb142-54" aria-hidden="true" tabindex="-1"></a>        <span class="kw">pub</span> status<span class="op">:</span> ProposalStatus<span class="op">,</span></span>
<span id="cb142-55"><a href="#cb142-55" aria-hidden="true" tabindex="-1"></a>        <span class="kw">pub</span> yes_votes<span class="op">:</span> <span class="dt">u32</span><span class="op">,</span></span>
<span id="cb142-56"><a href="#cb142-56" aria-hidden="true" tabindex="-1"></a>        <span class="kw">pub</span> no_votes<span class="op">:</span> <span class="dt">u32</span><span class="op">,</span></span>
<span id="cb142-57"><a href="#cb142-57" aria-hidden="true" tabindex="-1"></a>        <span class="kw">pub</span> voters<span class="op">:</span> <span class="dt">Vec</span><span class="op">&lt;</span>AccountId<span class="op">&gt;,</span></span>
<span id="cb142-58"><a href="#cb142-58" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb142-59"><a href="#cb142-59" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb142-60"><a href="#cb142-60" aria-hidden="true" tabindex="-1"></a>    <span class="co">/// Types of proposals</span></span>
<span id="cb142-61"><a href="#cb142-61" aria-hidden="true" tabindex="-1"></a>    <span class="at">#[</span>derive<span class="at">(</span><span class="bu">Debug</span><span class="op">,</span> <span class="bu">Clone</span><span class="op">,</span> <span class="bu">PartialEq</span><span class="op">,</span> <span class="bu">Eq</span><span class="op">,</span> <span class="pp">scale::</span>Encode<span class="op">,</span> <span class="pp">scale::</span>Decode<span class="at">)]</span></span>
<span id="cb142-62"><a href="#cb142-62" aria-hidden="true" tabindex="-1"></a>    <span class="at">#[</span>cfg_attr<span class="at">(</span>feature <span class="op">=</span> <span class="st">&quot;std&quot;</span><span class="op">,</span> derive<span class="at">(</span><span class="pp">scale_info::</span>TypeInfo<span class="at">))]</span></span>
<span id="cb142-63"><a href="#cb142-63" aria-hidden="true" tabindex="-1"></a>    <span class="kw">pub</span> <span class="kw">enum</span> ProposalType <span class="op">{</span></span>
<span id="cb142-64"><a href="#cb142-64" aria-hidden="true" tabindex="-1"></a>        <span class="co">/// Transfer funds from treasury</span></span>
<span id="cb142-65"><a href="#cb142-65" aria-hidden="true" tabindex="-1"></a>        TreasuryTransfer <span class="op">{</span> to<span class="op">:</span> AccountId<span class="op">,</span> amount<span class="op">:</span> Balance <span class="op">},</span></span>
<span id="cb142-66"><a href="#cb142-66" aria-hidden="true" tabindex="-1"></a>        <span class="co">/// Change membership fee</span></span>
<span id="cb142-67"><a href="#cb142-67" aria-hidden="true" tabindex="-1"></a>        ChangeMembershipFee <span class="op">{</span> new_fee<span class="op">:</span> Balance <span class="op">},</span></span>
<span id="cb142-68"><a href="#cb142-68" aria-hidden="true" tabindex="-1"></a>        <span class="co">/// Change voting parameters</span></span>
<span id="cb142-69"><a href="#cb142-69" aria-hidden="true" tabindex="-1"></a>        ChangeVotingConfig <span class="op">{</span> </span>
<span id="cb142-70"><a href="#cb142-70" aria-hidden="true" tabindex="-1"></a>            voting_period<span class="op">:</span> <span class="dt">Option</span><span class="op">&lt;</span><span class="dt">u64</span><span class="op">&gt;,</span></span>
<span id="cb142-71"><a href="#cb142-71" aria-hidden="true" tabindex="-1"></a>            quorum_threshold<span class="op">:</span> <span class="dt">Option</span><span class="op">&lt;</span><span class="dt">u32</span><span class="op">&gt;,</span></span>
<span id="cb142-72"><a href="#cb142-72" aria-hidden="true" tabindex="-1"></a>            approval_threshold<span class="op">:</span> <span class="dt">Option</span><span class="op">&lt;</span><span class="dt">u32</span><span class="op">&gt;,</span></span>
<span id="cb142-73"><a href="#cb142-73" aria-hidden="true" tabindex="-1"></a>        <span class="op">},</span></span>
<span id="cb142-74"><a href="#cb142-74" aria-hidden="true" tabindex="-1"></a>        <span class="co">/// Add/remove member (for governance)</span></span>
<span id="cb142-75"><a href="#cb142-75" aria-hidden="true" tabindex="-1"></a>        MembershipChange <span class="op">{</span> account<span class="op">:</span> AccountId<span class="op">,</span> add<span class="op">:</span> <span class="dt">bool</span> <span class="op">},</span></span>
<span id="cb142-76"><a href="#cb142-76" aria-hidden="true" tabindex="-1"></a>        <span class="co">/// Generic proposal for discussion</span></span>
<span id="cb142-77"><a href="#cb142-77" aria-hidden="true" tabindex="-1"></a>        General<span class="op">,</span></span>
<span id="cb142-78"><a href="#cb142-78" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb142-79"><a href="#cb142-79" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb142-80"><a href="#cb142-80" aria-hidden="true" tabindex="-1"></a>    <span class="at">#[</span>derive<span class="at">(</span><span class="bu">Debug</span><span class="op">,</span> <span class="bu">Clone</span><span class="op">,</span> <span class="bu">PartialEq</span><span class="op">,</span> <span class="bu">Eq</span><span class="op">,</span> <span class="pp">scale::</span>Encode<span class="op">,</span> <span class="pp">scale::</span>Decode<span class="at">)]</span></span>
<span id="cb142-81"><a href="#cb142-81" aria-hidden="true" tabindex="-1"></a>    <span class="at">#[</span>cfg_attr<span class="at">(</span>feature <span class="op">=</span> <span class="st">&quot;std&quot;</span><span class="op">,</span> derive<span class="at">(</span><span class="pp">scale_info::</span>TypeInfo<span class="at">))]</span></span>
<span id="cb142-82"><a href="#cb142-82" aria-hidden="true" tabindex="-1"></a>    <span class="kw">pub</span> <span class="kw">enum</span> ProposalStatus <span class="op">{</span></span>
<span id="cb142-83"><a href="#cb142-83" aria-hidden="true" tabindex="-1"></a>        Active<span class="op">,</span></span>
<span id="cb142-84"><a href="#cb142-84" aria-hidden="true" tabindex="-1"></a>        Passed<span class="op">,</span></span>
<span id="cb142-85"><a href="#cb142-85" aria-hidden="true" tabindex="-1"></a>        Failed<span class="op">,</span></span>
<span id="cb142-86"><a href="#cb142-86" aria-hidden="true" tabindex="-1"></a>        Executed<span class="op">,</span></span>
<span id="cb142-87"><a href="#cb142-87" aria-hidden="true" tabindex="-1"></a>        Cancelled<span class="op">,</span></span>
<span id="cb142-88"><a href="#cb142-88" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb142-89"><a href="#cb142-89" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb142-90"><a href="#cb142-90" aria-hidden="true" tabindex="-1"></a>    <span class="co">/// Contract errors</span></span>
<span id="cb142-91"><a href="#cb142-91" aria-hidden="true" tabindex="-1"></a>    <span class="at">#[</span>derive<span class="at">(</span><span class="bu">Debug</span><span class="op">,</span> <span class="bu">PartialEq</span><span class="op">,</span> <span class="bu">Eq</span><span class="op">,</span> <span class="pp">scale::</span>Encode<span class="op">,</span> <span class="pp">scale::</span>Decode<span class="at">)]</span></span>
<span id="cb142-92"><a href="#cb142-92" aria-hidden="true" tabindex="-1"></a>    <span class="at">#[</span>cfg_attr<span class="at">(</span>feature <span class="op">=</span> <span class="st">&quot;std&quot;</span><span class="op">,</span> derive<span class="at">(</span><span class="pp">scale_info::</span>TypeInfo<span class="at">))]</span></span>
<span id="cb142-93"><a href="#cb142-93" aria-hidden="true" tabindex="-1"></a>    <span class="kw">pub</span> <span class="kw">enum</span> <span class="bu">Error</span> <span class="op">{</span></span>
<span id="cb142-94"><a href="#cb142-94" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Membership errors</span></span>
<span id="cb142-95"><a href="#cb142-95" aria-hidden="true" tabindex="-1"></a>        NotMember<span class="op">,</span></span>
<span id="cb142-96"><a href="#cb142-96" aria-hidden="true" tabindex="-1"></a>        AlreadyMember<span class="op">,</span></span>
<span id="cb142-97"><a href="#cb142-97" aria-hidden="true" tabindex="-1"></a>        InsufficientMembershipFee<span class="op">,</span></span>
<span id="cb142-98"><a href="#cb142-98" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb142-99"><a href="#cb142-99" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Proposal errors</span></span>
<span id="cb142-100"><a href="#cb142-100" aria-hidden="true" tabindex="-1"></a>        ProposalNotFound<span class="op">,</span></span>
<span id="cb142-101"><a href="#cb142-101" aria-hidden="true" tabindex="-1"></a>        ProposalNotActive<span class="op">,</span></span>
<span id="cb142-102"><a href="#cb142-102" aria-hidden="true" tabindex="-1"></a>        VotingPeriodExpired<span class="op">,</span></span>
<span id="cb142-103"><a href="#cb142-103" aria-hidden="true" tabindex="-1"></a>        AlreadyVoted<span class="op">,</span></span>
<span id="cb142-104"><a href="#cb142-104" aria-hidden="true" tabindex="-1"></a>        InvalidProposalType<span class="op">,</span></span>
<span id="cb142-105"><a href="#cb142-105" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb142-106"><a href="#cb142-106" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Authorization errors</span></span>
<span id="cb142-107"><a href="#cb142-107" aria-hidden="true" tabindex="-1"></a>        Unauthorized<span class="op">,</span></span>
<span id="cb142-108"><a href="#cb142-108" aria-hidden="true" tabindex="-1"></a>        NotOwner<span class="op">,</span></span>
<span id="cb142-109"><a href="#cb142-109" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb142-110"><a href="#cb142-110" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Treasury errors</span></span>
<span id="cb142-111"><a href="#cb142-111" aria-hidden="true" tabindex="-1"></a>        InsufficientTreasuryFunds<span class="op">,</span></span>
<span id="cb142-112"><a href="#cb142-112" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb142-113"><a href="#cb142-113" aria-hidden="true" tabindex="-1"></a>        <span class="co">// State errors</span></span>
<span id="cb142-114"><a href="#cb142-114" aria-hidden="true" tabindex="-1"></a>        ContractPaused<span class="op">,</span></span>
<span id="cb142-115"><a href="#cb142-115" aria-hidden="true" tabindex="-1"></a>        InvalidParameters<span class="op">,</span></span>
<span id="cb142-116"><a href="#cb142-116" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb142-117"><a href="#cb142-117" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Arithmetic errors</span></span>
<span id="cb142-118"><a href="#cb142-118" aria-hidden="true" tabindex="-1"></a>        ArithmeticOverflow<span class="op">,</span></span>
<span id="cb142-119"><a href="#cb142-119" aria-hidden="true" tabindex="-1"></a>        ArithmeticUnderflow<span class="op">,</span></span>
<span id="cb142-120"><a href="#cb142-120" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb142-121"><a href="#cb142-121" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb142-122"><a href="#cb142-122" aria-hidden="true" tabindex="-1"></a>    <span class="co">/// Events</span></span>
<span id="cb142-123"><a href="#cb142-123" aria-hidden="true" tabindex="-1"></a>    <span class="at">#[</span>ink<span class="at">(</span>event<span class="at">)]</span></span>
<span id="cb142-124"><a href="#cb142-124" aria-hidden="true" tabindex="-1"></a>    <span class="kw">pub</span> <span class="kw">struct</span> MemberJoined <span class="op">{</span></span>
<span id="cb142-125"><a href="#cb142-125" aria-hidden="true" tabindex="-1"></a>        <span class="at">#[</span>ink<span class="at">(</span>topic<span class="at">)]</span></span>
<span id="cb142-126"><a href="#cb142-126" aria-hidden="true" tabindex="-1"></a>        account<span class="op">:</span> AccountId<span class="op">,</span></span>
<span id="cb142-127"><a href="#cb142-127" aria-hidden="true" tabindex="-1"></a>        fee_paid<span class="op">:</span> Balance<span class="op">,</span></span>
<span id="cb142-128"><a href="#cb142-128" aria-hidden="true" tabindex="-1"></a>        timestamp<span class="op">:</span> <span class="dt">u64</span><span class="op">,</span></span>
<span id="cb142-129"><a href="#cb142-129" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb142-130"><a href="#cb142-130" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb142-131"><a href="#cb142-131" aria-hidden="true" tabindex="-1"></a>    <span class="at">#[</span>ink<span class="at">(</span>event<span class="at">)]</span></span>
<span id="cb142-132"><a href="#cb142-132" aria-hidden="true" tabindex="-1"></a>    <span class="kw">pub</span> <span class="kw">struct</span> ProposalCreated <span class="op">{</span></span>
<span id="cb142-133"><a href="#cb142-133" aria-hidden="true" tabindex="-1"></a>        <span class="at">#[</span>ink<span class="at">(</span>topic<span class="at">)]</span></span>
<span id="cb142-134"><a href="#cb142-134" aria-hidden="true" tabindex="-1"></a>        proposal_id<span class="op">:</span> <span class="dt">u32</span><span class="op">,</span></span>
<span id="cb142-135"><a href="#cb142-135" aria-hidden="true" tabindex="-1"></a>        <span class="at">#[</span>ink<span class="at">(</span>topic<span class="at">)]</span></span>
<span id="cb142-136"><a href="#cb142-136" aria-hidden="true" tabindex="-1"></a>        proposer<span class="op">:</span> AccountId<span class="op">,</span></span>
<span id="cb142-137"><a href="#cb142-137" aria-hidden="true" tabindex="-1"></a>        title<span class="op">:</span> <span class="dt">String</span><span class="op">,</span></span>
<span id="cb142-138"><a href="#cb142-138" aria-hidden="true" tabindex="-1"></a>        proposal_type<span class="op">:</span> ProposalType<span class="op">,</span></span>
<span id="cb142-139"><a href="#cb142-139" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb142-140"><a href="#cb142-140" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb142-141"><a href="#cb142-141" aria-hidden="true" tabindex="-1"></a>    <span class="at">#[</span>ink<span class="at">(</span>event<span class="at">)]</span></span>
<span id="cb142-142"><a href="#cb142-142" aria-hidden="true" tabindex="-1"></a>    <span class="kw">pub</span> <span class="kw">struct</span> VoteCast <span class="op">{</span></span>
<span id="cb142-143"><a href="#cb142-143" aria-hidden="true" tabindex="-1"></a>        <span class="at">#[</span>ink<span class="at">(</span>topic<span class="at">)]</span></span>
<span id="cb142-144"><a href="#cb142-144" aria-hidden="true" tabindex="-1"></a>        proposal_id<span class="op">:</span> <span class="dt">u32</span><span class="op">,</span></span>
<span id="cb142-145"><a href="#cb142-145" aria-hidden="true" tabindex="-1"></a>        <span class="at">#[</span>ink<span class="at">(</span>topic<span class="at">)]</span></span>
<span id="cb142-146"><a href="#cb142-146" aria-hidden="true" tabindex="-1"></a>        voter<span class="op">:</span> AccountId<span class="op">,</span></span>
<span id="cb142-147"><a href="#cb142-147" aria-hidden="true" tabindex="-1"></a>        vote<span class="op">:</span> <span class="dt">bool</span><span class="op">,</span> <span class="co">// true = yes, false = no</span></span>
<span id="cb142-148"><a href="#cb142-148" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb142-149"><a href="#cb142-149" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb142-150"><a href="#cb142-150" aria-hidden="true" tabindex="-1"></a>    <span class="at">#[</span>ink<span class="at">(</span>event<span class="at">)]</span></span>
<span id="cb142-151"><a href="#cb142-151" aria-hidden="true" tabindex="-1"></a>    <span class="kw">pub</span> <span class="kw">struct</span> ProposalExecuted <span class="op">{</span></span>
<span id="cb142-152"><a href="#cb142-152" aria-hidden="true" tabindex="-1"></a>        <span class="at">#[</span>ink<span class="at">(</span>topic<span class="at">)]</span></span>
<span id="cb142-153"><a href="#cb142-153" aria-hidden="true" tabindex="-1"></a>        proposal_id<span class="op">:</span> <span class="dt">u32</span><span class="op">,</span></span>
<span id="cb142-154"><a href="#cb142-154" aria-hidden="true" tabindex="-1"></a>        success<span class="op">:</span> <span class="dt">bool</span><span class="op">,</span></span>
<span id="cb142-155"><a href="#cb142-155" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb142-156"><a href="#cb142-156" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb142-157"><a href="#cb142-157" aria-hidden="true" tabindex="-1"></a>    <span class="at">#[</span>ink<span class="at">(</span>event<span class="at">)]</span></span>
<span id="cb142-158"><a href="#cb142-158" aria-hidden="true" tabindex="-1"></a>    <span class="kw">pub</span> <span class="kw">struct</span> TreasuryDeposit <span class="op">{</span></span>
<span id="cb142-159"><a href="#cb142-159" aria-hidden="true" tabindex="-1"></a>        <span class="at">#[</span>ink<span class="at">(</span>topic<span class="at">)]</span></span>
<span id="cb142-160"><a href="#cb142-160" aria-hidden="true" tabindex="-1"></a>        from<span class="op">:</span> AccountId<span class="op">,</span></span>
<span id="cb142-161"><a href="#cb142-161" aria-hidden="true" tabindex="-1"></a>        amount<span class="op">:</span> Balance<span class="op">,</span></span>
<span id="cb142-162"><a href="#cb142-162" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb142-163"><a href="#cb142-163" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb142-164"><a href="#cb142-164" aria-hidden="true" tabindex="-1"></a>    <span class="kw">impl</span> Dao <span class="op">{</span></span>
<span id="cb142-165"><a href="#cb142-165" aria-hidden="true" tabindex="-1"></a>        <span class="co">/// Constructor - Initialize the DAO</span></span>
<span id="cb142-166"><a href="#cb142-166" aria-hidden="true" tabindex="-1"></a>        <span class="at">#[</span>ink<span class="at">(</span>constructor<span class="at">)]</span></span>
<span id="cb142-167"><a href="#cb142-167" aria-hidden="true" tabindex="-1"></a>        <span class="kw">pub</span> <span class="kw">fn</span> new(</span>
<span id="cb142-168"><a href="#cb142-168" aria-hidden="true" tabindex="-1"></a>            membership_fee<span class="op">:</span> Balance<span class="op">,</span></span>
<span id="cb142-169"><a href="#cb142-169" aria-hidden="true" tabindex="-1"></a>            voting_period<span class="op">:</span> <span class="dt">u64</span><span class="op">,</span></span>
<span id="cb142-170"><a href="#cb142-170" aria-hidden="true" tabindex="-1"></a>            quorum_threshold<span class="op">:</span> <span class="dt">u32</span><span class="op">,</span></span>
<span id="cb142-171"><a href="#cb142-171" aria-hidden="true" tabindex="-1"></a>            approval_threshold<span class="op">:</span> <span class="dt">u32</span><span class="op">,</span></span>
<span id="cb142-172"><a href="#cb142-172" aria-hidden="true" tabindex="-1"></a>        ) <span class="op">-&gt;</span> <span class="dt">Result</span><span class="op">&lt;</span><span class="dt">Self</span><span class="op">,</span> <span class="bu">Error</span><span class="op">&gt;</span> <span class="op">{</span></span>
<span id="cb142-173"><a href="#cb142-173" aria-hidden="true" tabindex="-1"></a>            <span class="co">// Validate parameters</span></span>
<span id="cb142-174"><a href="#cb142-174" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> voting_period <span class="op">==</span> <span class="dv">0</span> <span class="op">{</span></span>
<span id="cb142-175"><a href="#cb142-175" aria-hidden="true" tabindex="-1"></a>                <span class="cf">return</span> <span class="cn">Err</span>(<span class="bu">Error</span><span class="pp">::</span>InvalidParameters)<span class="op">;</span></span>
<span id="cb142-176"><a href="#cb142-176" aria-hidden="true" tabindex="-1"></a>            <span class="op">}</span></span>
<span id="cb142-177"><a href="#cb142-177" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb142-178"><a href="#cb142-178" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> quorum_threshold <span class="op">&gt;</span> <span class="dv">100</span> <span class="op">||</span> approval_threshold <span class="op">&gt;</span> <span class="dv">100</span> <span class="op">{</span></span>
<span id="cb142-179"><a href="#cb142-179" aria-hidden="true" tabindex="-1"></a>                <span class="cf">return</span> <span class="cn">Err</span>(<span class="bu">Error</span><span class="pp">::</span>InvalidParameters)<span class="op">;</span></span>
<span id="cb142-180"><a href="#cb142-180" aria-hidden="true" tabindex="-1"></a>            <span class="op">}</span></span>
<span id="cb142-181"><a href="#cb142-181" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb142-182"><a href="#cb142-182" aria-hidden="true" tabindex="-1"></a>            <span class="kw">let</span> caller <span class="op">=</span> <span class="dt">Self</span><span class="pp">::</span>env()<span class="op">.</span>caller()<span class="op">;</span></span>
<span id="cb142-183"><a href="#cb142-183" aria-hidden="true" tabindex="-1"></a>            <span class="kw">let</span> current_time <span class="op">=</span> <span class="dt">Self</span><span class="pp">::</span>env()<span class="op">.</span>block_timestamp()<span class="op">;</span></span>
<span id="cb142-184"><a href="#cb142-184" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb142-185"><a href="#cb142-185" aria-hidden="true" tabindex="-1"></a>            <span class="kw">let</span> <span class="kw">mut</span> dao <span class="op">=</span> <span class="dt">Self</span> <span class="op">{</span></span>
<span id="cb142-186"><a href="#cb142-186" aria-hidden="true" tabindex="-1"></a>                members<span class="op">:</span> <span class="pp">Mapping::</span><span class="kw">default</span>()<span class="op">,</span></span>
<span id="cb142-187"><a href="#cb142-187" aria-hidden="true" tabindex="-1"></a>                member_count<span class="op">:</span> <span class="dv">0</span><span class="op">,</span></span>
<span id="cb142-188"><a href="#cb142-188" aria-hidden="true" tabindex="-1"></a>                membership_fee<span class="op">,</span></span>
<span id="cb142-189"><a href="#cb142-189" aria-hidden="true" tabindex="-1"></a>                proposals<span class="op">:</span> <span class="pp">Mapping::</span><span class="kw">default</span>()<span class="op">,</span></span>
<span id="cb142-190"><a href="#cb142-190" aria-hidden="true" tabindex="-1"></a>                next_proposal_id<span class="op">:</span> <span class="dv">1</span><span class="op">,</span></span>
<span id="cb142-191"><a href="#cb142-191" aria-hidden="true" tabindex="-1"></a>                voting_period<span class="op">,</span></span>
<span id="cb142-192"><a href="#cb142-192" aria-hidden="true" tabindex="-1"></a>                quorum_threshold<span class="op">,</span></span>
<span id="cb142-193"><a href="#cb142-193" aria-hidden="true" tabindex="-1"></a>                approval_threshold<span class="op">,</span></span>
<span id="cb142-194"><a href="#cb142-194" aria-hidden="true" tabindex="-1"></a>                treasury_balance<span class="op">:</span> <span class="dv">0</span><span class="op">,</span></span>
<span id="cb142-195"><a href="#cb142-195" aria-hidden="true" tabindex="-1"></a>                owner<span class="op">:</span> caller<span class="op">,</span></span>
<span id="cb142-196"><a href="#cb142-196" aria-hidden="true" tabindex="-1"></a>                paused<span class="op">:</span> <span class="cn">false</span><span class="op">,</span></span>
<span id="cb142-197"><a href="#cb142-197" aria-hidden="true" tabindex="-1"></a>            <span class="op">};</span></span>
<span id="cb142-198"><a href="#cb142-198" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb142-199"><a href="#cb142-199" aria-hidden="true" tabindex="-1"></a>            <span class="co">// Owner automatically becomes first member</span></span>
<span id="cb142-200"><a href="#cb142-200" aria-hidden="true" tabindex="-1"></a>            <span class="kw">let</span> founder_member <span class="op">=</span> Member <span class="op">{</span></span>
<span id="cb142-201"><a href="#cb142-201" aria-hidden="true" tabindex="-1"></a>                joined_at<span class="op">:</span> current_time<span class="op">,</span></span>
<span id="cb142-202"><a href="#cb142-202" aria-hidden="true" tabindex="-1"></a>                voting_power<span class="op">:</span> <span class="dv">1</span><span class="op">,</span></span>
<span id="cb142-203"><a href="#cb142-203" aria-hidden="true" tabindex="-1"></a>                proposals_created<span class="op">:</span> <span class="dv">0</span><span class="op">,</span></span>
<span id="cb142-204"><a href="#cb142-204" aria-hidden="true" tabindex="-1"></a>                votes_cast<span class="op">:</span> <span class="dv">0</span><span class="op">,</span></span>
<span id="cb142-205"><a href="#cb142-205" aria-hidden="true" tabindex="-1"></a>            <span class="op">};</span></span>
<span id="cb142-206"><a href="#cb142-206" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb142-207"><a href="#cb142-207" aria-hidden="true" tabindex="-1"></a>            dao<span class="op">.</span>members<span class="op">.</span>insert(caller<span class="op">,</span> <span class="op">&amp;</span>founder_member)<span class="op">;</span></span>
<span id="cb142-208"><a href="#cb142-208" aria-hidden="true" tabindex="-1"></a>            dao<span class="op">.</span>member_count <span class="op">=</span> <span class="dv">1</span><span class="op">;</span></span>
<span id="cb142-209"><a href="#cb142-209" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb142-210"><a href="#cb142-210" aria-hidden="true" tabindex="-1"></a>            <span class="cn">Ok</span>(dao)</span>
<span id="cb142-211"><a href="#cb142-211" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb142-212"><a href="#cb142-212" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb142-213"><a href="#cb142-213" aria-hidden="true" tabindex="-1"></a>        <span class="co">/// Join the DAO by paying membership fee</span></span>
<span id="cb142-214"><a href="#cb142-214" aria-hidden="true" tabindex="-1"></a>        <span class="at">#[</span>ink<span class="at">(</span>message<span class="op">,</span> payable<span class="at">)]</span></span>
<span id="cb142-215"><a href="#cb142-215" aria-hidden="true" tabindex="-1"></a>        <span class="kw">pub</span> <span class="kw">fn</span> join() <span class="op">-&gt;</span> <span class="dt">Result</span><span class="op">&lt;</span>()<span class="op">,</span> <span class="bu">Error</span><span class="op">&gt;</span> <span class="op">{</span></span>
<span id="cb142-216"><a href="#cb142-216" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> <span class="kw">self</span><span class="op">.</span>paused <span class="op">{</span></span>
<span id="cb142-217"><a href="#cb142-217" aria-hidden="true" tabindex="-1"></a>                <span class="cf">return</span> <span class="cn">Err</span>(<span class="bu">Error</span><span class="pp">::</span>ContractPaused)<span class="op">;</span></span>
<span id="cb142-218"><a href="#cb142-218" aria-hidden="true" tabindex="-1"></a>            <span class="op">}</span></span>
<span id="cb142-219"><a href="#cb142-219" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb142-220"><a href="#cb142-220" aria-hidden="true" tabindex="-1"></a>            <span class="kw">let</span> caller <span class="op">=</span> <span class="kw">self</span><span class="op">.</span>env()<span class="op">.</span>caller()<span class="op">;</span></span>
<span id="cb142-221"><a href="#cb142-221" aria-hidden="true" tabindex="-1"></a>            <span class="kw">let</span> payment <span class="op">=</span> <span class="kw">self</span><span class="op">.</span>env()<span class="op">.</span>transferred_value()<span class="op">;</span></span>
<span id="cb142-222"><a href="#cb142-222" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb142-223"><a href="#cb142-223" aria-hidden="true" tabindex="-1"></a>            <span class="co">// Check if already a member</span></span>
<span id="cb142-224"><a href="#cb142-224" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> <span class="kw">self</span><span class="op">.</span>members<span class="op">.</span>contains(caller) <span class="op">{</span></span>
<span id="cb142-225"><a href="#cb142-225" aria-hidden="true" tabindex="-1"></a>                <span class="cf">return</span> <span class="cn">Err</span>(<span class="bu">Error</span><span class="pp">::</span>AlreadyMember)<span class="op">;</span></span>
<span id="cb142-226"><a href="#cb142-226" aria-hidden="true" tabindex="-1"></a>            <span class="op">}</span></span>
<span id="cb142-227"><a href="#cb142-227" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb142-228"><a href="#cb142-228" aria-hidden="true" tabindex="-1"></a>            <span class="co">// Check membership fee</span></span>
<span id="cb142-229"><a href="#cb142-229" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> payment <span class="op">&lt;</span> <span class="kw">self</span><span class="op">.</span>membership_fee <span class="op">{</span></span>
<span id="cb142-230"><a href="#cb142-230" aria-hidden="true" tabindex="-1"></a>                <span class="cf">return</span> <span class="cn">Err</span>(<span class="bu">Error</span><span class="pp">::</span>InsufficientMembershipFee)<span class="op">;</span></span>
<span id="cb142-231"><a href="#cb142-231" aria-hidden="true" tabindex="-1"></a>            <span class="op">}</span></span>
<span id="cb142-232"><a href="#cb142-232" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb142-233"><a href="#cb142-233" aria-hidden="true" tabindex="-1"></a>            <span class="co">// Add member</span></span>
<span id="cb142-234"><a href="#cb142-234" aria-hidden="true" tabindex="-1"></a>            <span class="kw">let</span> member <span class="op">=</span> Member <span class="op">{</span></span>
<span id="cb142-235"><a href="#cb142-235" aria-hidden="true" tabindex="-1"></a>                joined_at<span class="op">:</span> <span class="kw">self</span><span class="op">.</span>env()<span class="op">.</span>block_timestamp()<span class="op">,</span></span>
<span id="cb142-236"><a href="#cb142-236" aria-hidden="true" tabindex="-1"></a>                voting_power<span class="op">:</span> <span class="dv">1</span><span class="op">,</span></span>
<span id="cb142-237"><a href="#cb142-237" aria-hidden="true" tabindex="-1"></a>                proposals_created<span class="op">:</span> <span class="dv">0</span><span class="op">,</span></span>
<span id="cb142-238"><a href="#cb142-238" aria-hidden="true" tabindex="-1"></a>                votes_cast<span class="op">:</span> <span class="dv">0</span><span class="op">,</span></span>
<span id="cb142-239"><a href="#cb142-239" aria-hidden="true" tabindex="-1"></a>            <span class="op">};</span></span>
<span id="cb142-240"><a href="#cb142-240" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb142-241"><a href="#cb142-241" aria-hidden="true" tabindex="-1"></a>            <span class="kw">self</span><span class="op">.</span>members<span class="op">.</span>insert(caller<span class="op">,</span> <span class="op">&amp;</span>member)<span class="op">;</span></span>
<span id="cb142-242"><a href="#cb142-242" aria-hidden="true" tabindex="-1"></a>            <span class="kw">self</span><span class="op">.</span>member_count <span class="op">+=</span> <span class="dv">1</span><span class="op">;</span></span>
<span id="cb142-243"><a href="#cb142-243" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb142-244"><a href="#cb142-244" aria-hidden="true" tabindex="-1"></a>            <span class="co">// Add payment to treasury</span></span>
<span id="cb142-245"><a href="#cb142-245" aria-hidden="true" tabindex="-1"></a>            <span class="kw">self</span><span class="op">.</span>treasury_balance <span class="op">=</span> <span class="kw">self</span><span class="op">.</span>treasury_balance</span>
<span id="cb142-246"><a href="#cb142-246" aria-hidden="true" tabindex="-1"></a>                <span class="op">.</span>checked_add(payment)</span>
<span id="cb142-247"><a href="#cb142-247" aria-hidden="true" tabindex="-1"></a>                <span class="op">.</span>ok_or(<span class="bu">Error</span><span class="pp">::</span>ArithmeticOverflow)<span class="op">?;</span></span>
<span id="cb142-248"><a href="#cb142-248" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb142-249"><a href="#cb142-249" aria-hidden="true" tabindex="-1"></a>            <span class="co">// Refund excess payment</span></span>
<span id="cb142-250"><a href="#cb142-250" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> payment <span class="op">&gt;</span> <span class="kw">self</span><span class="op">.</span>membership_fee <span class="op">{</span></span>
<span id="cb142-251"><a href="#cb142-251" aria-hidden="true" tabindex="-1"></a>                <span class="kw">let</span> refund <span class="op">=</span> payment <span class="op">-</span> <span class="kw">self</span><span class="op">.</span>membership_fee<span class="op">;</span></span>
<span id="cb142-252"><a href="#cb142-252" aria-hidden="true" tabindex="-1"></a>                <span class="kw">self</span><span class="op">.</span>env()<span class="op">.</span>transfer(caller<span class="op">,</span> refund)<span class="op">.</span>map_err(<span class="op">|</span>_<span class="op">|</span> <span class="bu">Error</span><span class="pp">::</span>ArithmeticUnderflow)<span class="op">?;</span></span>
<span id="cb142-253"><a href="#cb142-253" aria-hidden="true" tabindex="-1"></a>            <span class="op">}</span></span>
<span id="cb142-254"><a href="#cb142-254" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb142-255"><a href="#cb142-255" aria-hidden="true" tabindex="-1"></a>            <span class="kw">self</span><span class="op">.</span>env()<span class="op">.</span>emit_event(MemberJoined <span class="op">{</span></span>
<span id="cb142-256"><a href="#cb142-256" aria-hidden="true" tabindex="-1"></a>                account<span class="op">:</span> caller<span class="op">,</span></span>
<span id="cb142-257"><a href="#cb142-257" aria-hidden="true" tabindex="-1"></a>                fee_paid<span class="op">:</span> <span class="kw">self</span><span class="op">.</span>membership_fee<span class="op">,</span></span>
<span id="cb142-258"><a href="#cb142-258" aria-hidden="true" tabindex="-1"></a>                timestamp<span class="op">:</span> <span class="kw">self</span><span class="op">.</span>env()<span class="op">.</span>block_timestamp()<span class="op">,</span></span>
<span id="cb142-259"><a href="#cb142-259" aria-hidden="true" tabindex="-1"></a>            <span class="op">}</span>)<span class="op">;</span></span>
<span id="cb142-260"><a href="#cb142-260" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb142-261"><a href="#cb142-261" aria-hidden="true" tabindex="-1"></a>            <span class="cn">Ok</span>(())</span>
<span id="cb142-262"><a href="#cb142-262" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb142-263"><a href="#cb142-263" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb142-264"><a href="#cb142-264" aria-hidden="true" tabindex="-1"></a>        <span class="co">/// Create a new proposal</span></span>
<span id="cb142-265"><a href="#cb142-265" aria-hidden="true" tabindex="-1"></a>        <span class="at">#[</span>ink<span class="at">(</span>message<span class="at">)]</span></span>
<span id="cb142-266"><a href="#cb142-266" aria-hidden="true" tabindex="-1"></a>        <span class="kw">pub</span> <span class="kw">fn</span> create_proposal(</span>
<span id="cb142-267"><a href="#cb142-267" aria-hidden="true" tabindex="-1"></a>            <span class="op">&amp;</span><span class="kw">mut</span> <span class="kw">self</span><span class="op">,</span></span>
<span id="cb142-268"><a href="#cb142-268" aria-hidden="true" tabindex="-1"></a>            title<span class="op">:</span> <span class="dt">String</span><span class="op">,</span></span>
<span id="cb142-269"><a href="#cb142-269" aria-hidden="true" tabindex="-1"></a>            description<span class="op">:</span> <span class="dt">String</span><span class="op">,</span></span>
<span id="cb142-270"><a href="#cb142-270" aria-hidden="true" tabindex="-1"></a>            proposal_type<span class="op">:</span> ProposalType<span class="op">,</span></span>
<span id="cb142-271"><a href="#cb142-271" aria-hidden="true" tabindex="-1"></a>        ) <span class="op">-&gt;</span> <span class="dt">Result</span><span class="op">&lt;</span><span class="dt">u32</span><span class="op">,</span> <span class="bu">Error</span><span class="op">&gt;</span> <span class="op">{</span></span>
<span id="cb142-272"><a href="#cb142-272" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> <span class="kw">self</span><span class="op">.</span>paused <span class="op">{</span></span>
<span id="cb142-273"><a href="#cb142-273" aria-hidden="true" tabindex="-1"></a>                <span class="cf">return</span> <span class="cn">Err</span>(<span class="bu">Error</span><span class="pp">::</span>ContractPaused)<span class="op">;</span></span>
<span id="cb142-274"><a href="#cb142-274" aria-hidden="true" tabindex="-1"></a>            <span class="op">}</span></span>
<span id="cb142-275"><a href="#cb142-275" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb142-276"><a href="#cb142-276" aria-hidden="true" tabindex="-1"></a>            <span class="kw">let</span> caller <span class="op">=</span> <span class="kw">self</span><span class="op">.</span>env()<span class="op">.</span>caller()<span class="op">;</span></span>
<span id="cb142-277"><a href="#cb142-277" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb142-278"><a href="#cb142-278" aria-hidden="true" tabindex="-1"></a>            <span class="co">// Only members can create proposals</span></span>
<span id="cb142-279"><a href="#cb142-279" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> <span class="op">!</span><span class="kw">self</span><span class="op">.</span>is_member(caller) <span class="op">{</span></span>
<span id="cb142-280"><a href="#cb142-280" aria-hidden="true" tabindex="-1"></a>                <span class="cf">return</span> <span class="cn">Err</span>(<span class="bu">Error</span><span class="pp">::</span>NotMember)<span class="op">;</span></span>
<span id="cb142-281"><a href="#cb142-281" aria-hidden="true" tabindex="-1"></a>            <span class="op">}</span></span>
<span id="cb142-282"><a href="#cb142-282" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb142-283"><a href="#cb142-283" aria-hidden="true" tabindex="-1"></a>            <span class="co">// Validate proposal parameters</span></span>
<span id="cb142-284"><a href="#cb142-284" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> title<span class="op">.</span>is_empty() <span class="op">||</span> description<span class="op">.</span>is_empty() <span class="op">{</span></span>
<span id="cb142-285"><a href="#cb142-285" aria-hidden="true" tabindex="-1"></a>                <span class="cf">return</span> <span class="cn">Err</span>(<span class="bu">Error</span><span class="pp">::</span>InvalidParameters)<span class="op">;</span></span>
<span id="cb142-286"><a href="#cb142-286" aria-hidden="true" tabindex="-1"></a>            <span class="op">}</span></span>
<span id="cb142-287"><a href="#cb142-287" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb142-288"><a href="#cb142-288" aria-hidden="true" tabindex="-1"></a>            <span class="co">// Validate proposal type specific parameters</span></span>
<span id="cb142-289"><a href="#cb142-289" aria-hidden="true" tabindex="-1"></a>            <span class="kw">self</span><span class="op">.</span>validate_proposal_type(<span class="op">&amp;</span>proposal_type)<span class="op">?;</span></span>
<span id="cb142-290"><a href="#cb142-290" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb142-291"><a href="#cb142-291" aria-hidden="true" tabindex="-1"></a>            <span class="kw">let</span> proposal_id <span class="op">=</span> <span class="kw">self</span><span class="op">.</span>next_proposal_id<span class="op">;</span></span>
<span id="cb142-292"><a href="#cb142-292" aria-hidden="true" tabindex="-1"></a>            <span class="kw">let</span> current_time <span class="op">=</span> <span class="kw">self</span><span class="op">.</span>env()<span class="op">.</span>block_timestamp()<span class="op">;</span></span>
<span id="cb142-293"><a href="#cb142-293" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb142-294"><a href="#cb142-294" aria-hidden="true" tabindex="-1"></a>            <span class="kw">let</span> proposal <span class="op">=</span> Proposal <span class="op">{</span></span>
<span id="cb142-295"><a href="#cb142-295" aria-hidden="true" tabindex="-1"></a>                id<span class="op">:</span> proposal_id<span class="op">,</span></span>
<span id="cb142-296"><a href="#cb142-296" aria-hidden="true" tabindex="-1"></a>                proposer<span class="op">:</span> caller<span class="op">,</span></span>
<span id="cb142-297"><a href="#cb142-297" aria-hidden="true" tabindex="-1"></a>                title<span class="op">:</span> title<span class="op">.</span>clone()<span class="op">,</span></span>
<span id="cb142-298"><a href="#cb142-298" aria-hidden="true" tabindex="-1"></a>                description<span class="op">,</span></span>
<span id="cb142-299"><a href="#cb142-299" aria-hidden="true" tabindex="-1"></a>                proposal_type<span class="op">:</span> proposal_type<span class="op">.</span>clone()<span class="op">,</span></span>
<span id="cb142-300"><a href="#cb142-300" aria-hidden="true" tabindex="-1"></a>                created_at<span class="op">:</span> current_time<span class="op">,</span></span>
<span id="cb142-301"><a href="#cb142-301" aria-hidden="true" tabindex="-1"></a>                voting_deadline<span class="op">:</span> current_time <span class="op">+</span> <span class="kw">self</span><span class="op">.</span>voting_period<span class="op">,</span></span>
<span id="cb142-302"><a href="#cb142-302" aria-hidden="true" tabindex="-1"></a>                status<span class="op">:</span> <span class="pp">ProposalStatus::</span>Active<span class="op">,</span></span>
<span id="cb142-303"><a href="#cb142-303" aria-hidden="true" tabindex="-1"></a>                yes_votes<span class="op">:</span> <span class="dv">0</span><span class="op">,</span></span>
<span id="cb142-304"><a href="#cb142-304" aria-hidden="true" tabindex="-1"></a>                no_votes<span class="op">:</span> <span class="dv">0</span><span class="op">,</span></span>
<span id="cb142-305"><a href="#cb142-305" aria-hidden="true" tabindex="-1"></a>                voters<span class="op">:</span> <span class="dt">Vec</span><span class="pp">::</span>new()<span class="op">,</span></span>
<span id="cb142-306"><a href="#cb142-306" aria-hidden="true" tabindex="-1"></a>            <span class="op">};</span></span>
<span id="cb142-307"><a href="#cb142-307" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb142-308"><a href="#cb142-308" aria-hidden="true" tabindex="-1"></a>            <span class="kw">self</span><span class="op">.</span>proposals<span class="op">.</span>insert(proposal_id<span class="op">,</span> <span class="op">&amp;</span>proposal)<span class="op">;</span></span>
<span id="cb142-309"><a href="#cb142-309" aria-hidden="true" tabindex="-1"></a>            <span class="kw">self</span><span class="op">.</span>next_proposal_id <span class="op">+=</span> <span class="dv">1</span><span class="op">;</span></span>
<span id="cb142-310"><a href="#cb142-310" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb142-311"><a href="#cb142-311" aria-hidden="true" tabindex="-1"></a>            <span class="co">// Update member stats</span></span>
<span id="cb142-312"><a href="#cb142-312" aria-hidden="true" tabindex="-1"></a>            <span class="kw">let</span> <span class="kw">mut</span> member <span class="op">=</span> <span class="kw">self</span><span class="op">.</span>members<span class="op">.</span>get(caller)<span class="op">.</span>unwrap()<span class="op">;</span></span>
<span id="cb142-313"><a href="#cb142-313" aria-hidden="true" tabindex="-1"></a>            member<span class="op">.</span>proposals_created <span class="op">+=</span> <span class="dv">1</span><span class="op">;</span></span>
<span id="cb142-314"><a href="#cb142-314" aria-hidden="true" tabindex="-1"></a>            <span class="kw">self</span><span class="op">.</span>members<span class="op">.</span>insert(caller<span class="op">,</span> <span class="op">&amp;</span>member)<span class="op">;</span></span>
<span id="cb142-315"><a href="#cb142-315" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb142-316"><a href="#cb142-316" aria-hidden="true" tabindex="-1"></a>            <span class="kw">self</span><span class="op">.</span>env()<span class="op">.</span>emit_event(ProposalCreated <span class="op">{</span></span>
<span id="cb142-317"><a href="#cb142-317" aria-hidden="true" tabindex="-1"></a>                proposal_id<span class="op">,</span></span>
<span id="cb142-318"><a href="#cb142-318" aria-hidden="true" tabindex="-1"></a>                proposer<span class="op">:</span> caller<span class="op">,</span></span>
<span id="cb142-319"><a href="#cb142-319" aria-hidden="true" tabindex="-1"></a>                title<span class="op">,</span></span>
<span id="cb142-320"><a href="#cb142-320" aria-hidden="true" tabindex="-1"></a>                proposal_type<span class="op">,</span></span>
<span id="cb142-321"><a href="#cb142-321" aria-hidden="true" tabindex="-1"></a>            <span class="op">}</span>)<span class="op">;</span></span>
<span id="cb142-322"><a href="#cb142-322" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb142-323"><a href="#cb142-323" aria-hidden="true" tabindex="-1"></a>            <span class="cn">Ok</span>(proposal_id)</span>
<span id="cb142-324"><a href="#cb142-324" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb142-325"><a href="#cb142-325" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb142-326"><a href="#cb142-326" aria-hidden="true" tabindex="-1"></a>        <span class="co">/// Vote on a proposal</span></span>
<span id="cb142-327"><a href="#cb142-327" aria-hidden="true" tabindex="-1"></a>        <span class="at">#[</span>ink<span class="at">(</span>message<span class="at">)]</span></span>
<span id="cb142-328"><a href="#cb142-328" aria-hidden="true" tabindex="-1"></a>        <span class="kw">pub</span> <span class="kw">fn</span> vote(<span class="op">&amp;</span><span class="kw">mut</span> <span class="kw">self</span><span class="op">,</span> proposal_id<span class="op">:</span> <span class="dt">u32</span><span class="op">,</span> vote<span class="op">:</span> <span class="dt">bool</span>) <span class="op">-&gt;</span> <span class="dt">Result</span><span class="op">&lt;</span>()<span class="op">,</span> <span class="bu">Error</span><span class="op">&gt;</span> <span class="op">{</span></span>
<span id="cb142-329"><a href="#cb142-329" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> <span class="kw">self</span><span class="op">.</span>paused <span class="op">{</span></span>
<span id="cb142-330"><a href="#cb142-330" aria-hidden="true" tabindex="-1"></a>                <span class="cf">return</span> <span class="cn">Err</span>(<span class="bu">Error</span><span class="pp">::</span>ContractPaused)<span class="op">;</span></span>
<span id="cb142-331"><a href="#cb142-331" aria-hidden="true" tabindex="-1"></a>            <span class="op">}</span></span>
<span id="cb142-332"><a href="#cb142-332" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb142-333"><a href="#cb142-333" aria-hidden="true" tabindex="-1"></a>            <span class="kw">let</span> caller <span class="op">=</span> <span class="kw">self</span><span class="op">.</span>env()<span class="op">.</span>caller()<span class="op">;</span></span>
<span id="cb142-334"><a href="#cb142-334" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb142-335"><a href="#cb142-335" aria-hidden="true" tabindex="-1"></a>            <span class="co">// Only members can vote</span></span>
<span id="cb142-336"><a href="#cb142-336" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> <span class="op">!</span><span class="kw">self</span><span class="op">.</span>is_member(caller) <span class="op">{</span></span>
<span id="cb142-337"><a href="#cb142-337" aria-hidden="true" tabindex="-1"></a>                <span class="cf">return</span> <span class="cn">Err</span>(<span class="bu">Error</span><span class="pp">::</span>NotMember)<span class="op">;</span></span>
<span id="cb142-338"><a href="#cb142-338" aria-hidden="true" tabindex="-1"></a>            <span class="op">}</span></span>
<span id="cb142-339"><a href="#cb142-339" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb142-340"><a href="#cb142-340" aria-hidden="true" tabindex="-1"></a>            <span class="kw">let</span> <span class="kw">mut</span> proposal <span class="op">=</span> <span class="kw">self</span><span class="op">.</span>proposals<span class="op">.</span>get(proposal_id)</span>
<span id="cb142-341"><a href="#cb142-341" aria-hidden="true" tabindex="-1"></a>                <span class="op">.</span>ok_or(<span class="bu">Error</span><span class="pp">::</span>ProposalNotFound)<span class="op">?;</span></span>
<span id="cb142-342"><a href="#cb142-342" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb142-343"><a href="#cb142-343" aria-hidden="true" tabindex="-1"></a>            <span class="co">// Check proposal status</span></span>
<span id="cb142-344"><a href="#cb142-344" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> proposal<span class="op">.</span>status <span class="op">!=</span> <span class="pp">ProposalStatus::</span>Active <span class="op">{</span></span>
<span id="cb142-345"><a href="#cb142-345" aria-hidden="true" tabindex="-1"></a>                <span class="cf">return</span> <span class="cn">Err</span>(<span class="bu">Error</span><span class="pp">::</span>ProposalNotActive)<span class="op">;</span></span>
<span id="cb142-346"><a href="#cb142-346" aria-hidden="true" tabindex="-1"></a>            <span class="op">}</span></span>
<span id="cb142-347"><a href="#cb142-347" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb142-348"><a href="#cb142-348" aria-hidden="true" tabindex="-1"></a>            <span class="co">// Check voting deadline</span></span>
<span id="cb142-349"><a href="#cb142-349" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> <span class="kw">self</span><span class="op">.</span>env()<span class="op">.</span>block_timestamp() <span class="op">&gt;</span> proposal<span class="op">.</span>voting_deadline <span class="op">{</span></span>
<span id="cb142-350"><a href="#cb142-350" aria-hidden="true" tabindex="-1"></a>                <span class="cf">return</span> <span class="cn">Err</span>(<span class="bu">Error</span><span class="pp">::</span>VotingPeriodExpired)<span class="op">;</span></span>
<span id="cb142-351"><a href="#cb142-351" aria-hidden="true" tabindex="-1"></a>            <span class="op">}</span></span>
<span id="cb142-352"><a href="#cb142-352" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb142-353"><a href="#cb142-353" aria-hidden="true" tabindex="-1"></a>            <span class="co">// Check if already voted</span></span>
<span id="cb142-354"><a href="#cb142-354" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> proposal<span class="op">.</span>voters<span class="op">.</span>contains(<span class="op">&amp;</span>caller) <span class="op">{</span></span>
<span id="cb142-355"><a href="#cb142-355" aria-hidden="true" tabindex="-1"></a>                <span class="cf">return</span> <span class="cn">Err</span>(<span class="bu">Error</span><span class="pp">::</span>AlreadyVoted)<span class="op">;</span></span>
<span id="cb142-356"><a href="#cb142-356" aria-hidden="true" tabindex="-1"></a>            <span class="op">}</span></span>
<span id="cb142-357"><a href="#cb142-357" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb142-358"><a href="#cb142-358" aria-hidden="true" tabindex="-1"></a>            <span class="co">// Cast vote</span></span>
<span id="cb142-359"><a href="#cb142-359" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> vote <span class="op">{</span></span>
<span id="cb142-360"><a href="#cb142-360" aria-hidden="true" tabindex="-1"></a>                proposal<span class="op">.</span>yes_votes <span class="op">+=</span> <span class="dv">1</span><span class="op">;</span></span>
<span id="cb142-361"><a href="#cb142-361" aria-hidden="true" tabindex="-1"></a>            <span class="op">}</span> <span class="cf">else</span> <span class="op">{</span></span>
<span id="cb142-362"><a href="#cb142-362" aria-hidden="true" tabindex="-1"></a>                proposal<span class="op">.</span>no_votes <span class="op">+=</span> <span class="dv">1</span><span class="op">;</span></span>
<span id="cb142-363"><a href="#cb142-363" aria-hidden="true" tabindex="-1"></a>            <span class="op">}</span></span>
<span id="cb142-364"><a href="#cb142-364" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb142-365"><a href="#cb142-365" aria-hidden="true" tabindex="-1"></a>            proposal<span class="op">.</span>voters<span class="op">.</span>push(caller)<span class="op">;</span></span>
<span id="cb142-366"><a href="#cb142-366" aria-hidden="true" tabindex="-1"></a>            <span class="kw">self</span><span class="op">.</span>proposals<span class="op">.</span>insert(proposal_id<span class="op">,</span> <span class="op">&amp;</span>proposal)<span class="op">;</span></span>
<span id="cb142-367"><a href="#cb142-367" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb142-368"><a href="#cb142-368" aria-hidden="true" tabindex="-1"></a>            <span class="co">// Update member stats</span></span>
<span id="cb142-369"><a href="#cb142-369" aria-hidden="true" tabindex="-1"></a>            <span class="kw">let</span> <span class="kw">mut</span> member <span class="op">=</span> <span class="kw">self</span><span class="op">.</span>members<span class="op">.</span>get(caller)<span class="op">.</span>unwrap()<span class="op">;</span></span>
<span id="cb142-370"><a href="#cb142-370" aria-hidden="true" tabindex="-1"></a>            member<span class="op">.</span>votes_cast <span class="op">+=</span> <span class="dv">1</span><span class="op">;</span></span>
<span id="cb142-371"><a href="#cb142-371" aria-hidden="true" tabindex="-1"></a>            <span class="kw">self</span><span class="op">.</span>members<span class="op">.</span>insert(caller<span class="op">,</span> <span class="op">&amp;</span>member)<span class="op">;</span></span>
<span id="cb142-372"><a href="#cb142-372" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb142-373"><a href="#cb142-373" aria-hidden="true" tabindex="-1"></a>            <span class="kw">self</span><span class="op">.</span>env()<span class="op">.</span>emit_event(VoteCast <span class="op">{</span></span>
<span id="cb142-374"><a href="#cb142-374" aria-hidden="true" tabindex="-1"></a>                proposal_id<span class="op">,</span></span>
<span id="cb142-375"><a href="#cb142-375" aria-hidden="true" tabindex="-1"></a>                voter<span class="op">:</span> caller<span class="op">,</span></span>
<span id="cb142-376"><a href="#cb142-376" aria-hidden="true" tabindex="-1"></a>                vote<span class="op">,</span></span>
<span id="cb142-377"><a href="#cb142-377" aria-hidden="true" tabindex="-1"></a>            <span class="op">}</span>)<span class="op">;</span></span>
<span id="cb142-378"><a href="#cb142-378" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb142-379"><a href="#cb142-379" aria-hidden="true" tabindex="-1"></a>            <span class="co">// Check if proposal can be finalized</span></span>
<span id="cb142-380"><a href="#cb142-380" aria-hidden="true" tabindex="-1"></a>            <span class="kw">self</span><span class="op">.</span>try_finalize_proposal(proposal_id)<span class="op">?;</span></span>
<span id="cb142-381"><a href="#cb142-381" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb142-382"><a href="#cb142-382" aria-hidden="true" tabindex="-1"></a>            <span class="cn">Ok</span>(())</span>
<span id="cb142-383"><a href="#cb142-383" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb142-384"><a href="#cb142-384" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb142-385"><a href="#cb142-385" aria-hidden="true" tabindex="-1"></a>        <span class="co">/// Execute a passed proposal</span></span>
<span id="cb142-386"><a href="#cb142-386" aria-hidden="true" tabindex="-1"></a>        <span class="at">#[</span>ink<span class="at">(</span>message<span class="at">)]</span></span>
<span id="cb142-387"><a href="#cb142-387" aria-hidden="true" tabindex="-1"></a>        <span class="kw">pub</span> <span class="kw">fn</span> execute_proposal(<span class="op">&amp;</span><span class="kw">mut</span> <span class="kw">self</span><span class="op">,</span> proposal_id<span class="op">:</span> <span class="dt">u32</span>) <span class="op">-&gt;</span> <span class="dt">Result</span><span class="op">&lt;</span>()<span class="op">,</span> <span class="bu">Error</span><span class="op">&gt;</span> <span class="op">{</span></span>
<span id="cb142-388"><a href="#cb142-388" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> <span class="kw">self</span><span class="op">.</span>paused <span class="op">{</span></span>
<span id="cb142-389"><a href="#cb142-389" aria-hidden="true" tabindex="-1"></a>                <span class="cf">return</span> <span class="cn">Err</span>(<span class="bu">Error</span><span class="pp">::</span>ContractPaused)<span class="op">;</span></span>
<span id="cb142-390"><a href="#cb142-390" aria-hidden="true" tabindex="-1"></a>            <span class="op">}</span></span>
<span id="cb142-391"><a href="#cb142-391" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb142-392"><a href="#cb142-392" aria-hidden="true" tabindex="-1"></a>            <span class="kw">let</span> <span class="kw">mut</span> proposal <span class="op">=</span> <span class="kw">self</span><span class="op">.</span>proposals<span class="op">.</span>get(proposal_id)</span>
<span id="cb142-393"><a href="#cb142-393" aria-hidden="true" tabindex="-1"></a>                <span class="op">.</span>ok_or(<span class="bu">Error</span><span class="pp">::</span>ProposalNotFound)<span class="op">?;</span></span>
<span id="cb142-394"><a href="#cb142-394" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb142-395"><a href="#cb142-395" aria-hidden="true" tabindex="-1"></a>            <span class="co">// Check proposal status</span></span>
<span id="cb142-396"><a href="#cb142-396" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> proposal<span class="op">.</span>status <span class="op">!=</span> <span class="pp">ProposalStatus::</span>Passed <span class="op">{</span></span>
<span id="cb142-397"><a href="#cb142-397" aria-hidden="true" tabindex="-1"></a>                <span class="cf">return</span> <span class="cn">Err</span>(<span class="bu">Error</span><span class="pp">::</span>InvalidParameters)<span class="op">;</span></span>
<span id="cb142-398"><a href="#cb142-398" aria-hidden="true" tabindex="-1"></a>            <span class="op">}</span></span>
<span id="cb142-399"><a href="#cb142-399" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb142-400"><a href="#cb142-400" aria-hidden="true" tabindex="-1"></a>            <span class="co">// Execute based on proposal type</span></span>
<span id="cb142-401"><a href="#cb142-401" aria-hidden="true" tabindex="-1"></a>            <span class="kw">let</span> execution_result <span class="op">=</span> <span class="kw">self</span><span class="op">.</span>execute_proposal_action(<span class="op">&amp;</span>proposal<span class="op">.</span>proposal_type)<span class="op">;</span></span>
<span id="cb142-402"><a href="#cb142-402" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb142-403"><a href="#cb142-403" aria-hidden="true" tabindex="-1"></a>            <span class="co">// Update proposal status</span></span>
<span id="cb142-404"><a href="#cb142-404" aria-hidden="true" tabindex="-1"></a>            proposal<span class="op">.</span>status <span class="op">=</span> <span class="cf">if</span> execution_result<span class="op">.</span>is_ok() <span class="op">{</span></span>
<span id="cb142-405"><a href="#cb142-405" aria-hidden="true" tabindex="-1"></a>                <span class="pp">ProposalStatus::</span>Executed</span>
<span id="cb142-406"><a href="#cb142-406" aria-hidden="true" tabindex="-1"></a>            <span class="op">}</span> <span class="cf">else</span> <span class="op">{</span></span>
<span id="cb142-407"><a href="#cb142-407" aria-hidden="true" tabindex="-1"></a>                <span class="pp">ProposalStatus::</span>Failed</span>
<span id="cb142-408"><a href="#cb142-408" aria-hidden="true" tabindex="-1"></a>            <span class="op">};</span></span>
<span id="cb142-409"><a href="#cb142-409" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb142-410"><a href="#cb142-410" aria-hidden="true" tabindex="-1"></a>            <span class="kw">self</span><span class="op">.</span>proposals<span class="op">.</span>insert(proposal_id<span class="op">,</span> <span class="op">&amp;</span>proposal)<span class="op">;</span></span>
<span id="cb142-411"><a href="#cb142-411" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb142-412"><a href="#cb142-412" aria-hidden="true" tabindex="-1"></a>            <span class="kw">self</span><span class="op">.</span>env()<span class="op">.</span>emit_event(ProposalExecuted <span class="op">{</span></span>
<span id="cb142-413"><a href="#cb142-413" aria-hidden="true" tabindex="-1"></a>                proposal_id<span class="op">,</span></span>
<span id="cb142-414"><a href="#cb142-414" aria-hidden="true" tabindex="-1"></a>                success<span class="op">:</span> execution_result<span class="op">.</span>is_ok()<span class="op">,</span></span>
<span id="cb142-415"><a href="#cb142-415" aria-hidden="true" tabindex="-1"></a>            <span class="op">}</span>)<span class="op">;</span></span>
<span id="cb142-416"><a href="#cb142-416" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb142-417"><a href="#cb142-417" aria-hidden="true" tabindex="-1"></a>            execution_result</span>
<span id="cb142-418"><a href="#cb142-418" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb142-419"><a href="#cb142-419" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb142-420"><a href="#cb142-420" aria-hidden="true" tabindex="-1"></a>        <span class="co">/// Deposit funds to treasury</span></span>
<span id="cb142-421"><a href="#cb142-421" aria-hidden="true" tabindex="-1"></a>        <span class="at">#[</span>ink<span class="at">(</span>message<span class="op">,</span> payable<span class="at">)]</span></span>
<span id="cb142-422"><a href="#cb142-422" aria-hidden="true" tabindex="-1"></a>        <span class="kw">pub</span> <span class="kw">fn</span> deposit_to_treasury(<span class="op">&amp;</span><span class="kw">mut</span> <span class="kw">self</span>) <span class="op">-&gt;</span> <span class="dt">Result</span><span class="op">&lt;</span>()<span class="op">,</span> <span class="bu">Error</span><span class="op">&gt;</span> <span class="op">{</span></span>
<span id="cb142-423"><a href="#cb142-423" aria-hidden="true" tabindex="-1"></a>            <span class="kw">let</span> amount <span class="op">=</span> <span class="kw">self</span><span class="op">.</span>env()<span class="op">.</span>transferred_value()<span class="op">;</span></span>
<span id="cb142-424"><a href="#cb142-424" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb142-425"><a href="#cb142-425" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> amount <span class="op">==</span> <span class="dv">0</span> <span class="op">{</span></span>
<span id="cb142-426"><a href="#cb142-426" aria-hidden="true" tabindex="-1"></a>                <span class="cf">return</span> <span class="cn">Err</span>(<span class="bu">Error</span><span class="pp">::</span>InvalidParameters)<span class="op">;</span></span>
<span id="cb142-427"><a href="#cb142-427" aria-hidden="true" tabindex="-1"></a>            <span class="op">}</span></span>
<span id="cb142-428"><a href="#cb142-428" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb142-429"><a href="#cb142-429" aria-hidden="true" tabindex="-1"></a>            <span class="kw">self</span><span class="op">.</span>treasury_balance <span class="op">=</span> <span class="kw">self</span><span class="op">.</span>treasury_balance</span>
<span id="cb142-430"><a href="#cb142-430" aria-hidden="true" tabindex="-1"></a>                <span class="op">.</span>checked_add(amount)</span>
<span id="cb142-431"><a href="#cb142-431" aria-hidden="true" tabindex="-1"></a>                <span class="op">.</span>ok_or(<span class="bu">Error</span><span class="pp">::</span>ArithmeticOverflow)<span class="op">?;</span></span>
<span id="cb142-432"><a href="#cb142-432" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb142-433"><a href="#cb142-433" aria-hidden="true" tabindex="-1"></a>            <span class="kw">self</span><span class="op">.</span>env()<span class="op">.</span>emit_event(TreasuryDeposit <span class="op">{</span></span>
<span id="cb142-434"><a href="#cb142-434" aria-hidden="true" tabindex="-1"></a>                from<span class="op">:</span> <span class="kw">self</span><span class="op">.</span>env()<span class="op">.</span>caller()<span class="op">,</span></span>
<span id="cb142-435"><a href="#cb142-435" aria-hidden="true" tabindex="-1"></a>                amount<span class="op">,</span></span>
<span id="cb142-436"><a href="#cb142-436" aria-hidden="true" tabindex="-1"></a>            <span class="op">}</span>)<span class="op">;</span></span>
<span id="cb142-437"><a href="#cb142-437" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb142-438"><a href="#cb142-438" aria-hidden="true" tabindex="-1"></a>            <span class="cn">Ok</span>(())</span>
<span id="cb142-439"><a href="#cb142-439" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb142-440"><a href="#cb142-440" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb142-441"><a href="#cb142-441" aria-hidden="true" tabindex="-1"></a>        <span class="co">// ========== VIEW FUNCTIONS ==========</span></span>
<span id="cb142-442"><a href="#cb142-442" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb142-443"><a href="#cb142-443" aria-hidden="true" tabindex="-1"></a>        <span class="co">/// Check if account is a member</span></span>
<span id="cb142-444"><a href="#cb142-444" aria-hidden="true" tabindex="-1"></a>        <span class="at">#[</span>ink<span class="at">(</span>message<span class="at">)]</span></span>
<span id="cb142-445"><a href="#cb142-445" aria-hidden="true" tabindex="-1"></a>        <span class="kw">pub</span> <span class="kw">fn</span> is_member(<span class="op">&amp;</span><span class="kw">self</span><span class="op">,</span> account<span class="op">:</span> AccountId) <span class="op">-&gt;</span> <span class="dt">bool</span> <span class="op">{</span></span>
<span id="cb142-446"><a href="#cb142-446" aria-hidden="true" tabindex="-1"></a>            <span class="kw">self</span><span class="op">.</span>members<span class="op">.</span>contains(account)</span>
<span id="cb142-447"><a href="#cb142-447" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb142-448"><a href="#cb142-448" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb142-449"><a href="#cb142-449" aria-hidden="true" tabindex="-1"></a>        <span class="co">/// Get member information</span></span>
<span id="cb142-450"><a href="#cb142-450" aria-hidden="true" tabindex="-1"></a>        <span class="at">#[</span>ink<span class="at">(</span>message<span class="at">)]</span></span>
<span id="cb142-451"><a href="#cb142-451" aria-hidden="true" tabindex="-1"></a>        <span class="kw">pub</span> <span class="kw">fn</span> get_member(<span class="op">&amp;</span><span class="kw">self</span><span class="op">,</span> account<span class="op">:</span> AccountId) <span class="op">-&gt;</span> <span class="dt">Option</span><span class="op">&lt;</span>Member<span class="op">&gt;</span> <span class="op">{</span></span>
<span id="cb142-452"><a href="#cb142-452" aria-hidden="true" tabindex="-1"></a>            <span class="kw">self</span><span class="op">.</span>members<span class="op">.</span>get(account)</span>
<span id="cb142-453"><a href="#cb142-453" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb142-454"><a href="#cb142-454" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb142-455"><a href="#cb142-455" aria-hidden="true" tabindex="-1"></a>        <span class="co">/// Get proposal information</span></span>
<span id="cb142-456"><a href="#cb142-456" aria-hidden="true" tabindex="-1"></a>        <span class="at">#[</span>ink<span class="at">(</span>message<span class="at">)]</span></span>
<span id="cb142-457"><a href="#cb142-457" aria-hidden="true" tabindex="-1"></a>        <span class="kw">pub</span> <span class="kw">fn</span> get_proposal(<span class="op">&amp;</span><span class="kw">self</span><span class="op">,</span> proposal_id<span class="op">:</span> <span class="dt">u32</span>) <span class="op">-&gt;</span> <span class="dt">Option</span><span class="op">&lt;</span>Proposal<span class="op">&gt;</span> <span class="op">{</span></span>
<span id="cb142-458"><a href="#cb142-458" aria-hidden="true" tabindex="-1"></a>            <span class="kw">self</span><span class="op">.</span>proposals<span class="op">.</span>get(proposal_id)</span>
<span id="cb142-459"><a href="#cb142-459" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb142-460"><a href="#cb142-460" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb142-461"><a href="#cb142-461" aria-hidden="true" tabindex="-1"></a>        <span class="co">/// Get DAO statistics</span></span>
<span id="cb142-462"><a href="#cb142-462" aria-hidden="true" tabindex="-1"></a>        <span class="at">#[</span>ink<span class="at">(</span>message<span class="at">)]</span></span>
<span id="cb142-463"><a href="#cb142-463" aria-hidden="true" tabindex="-1"></a>        <span class="kw">pub</span> <span class="kw">fn</span> get_dao_info(<span class="op">&amp;</span><span class="kw">self</span>) <span class="op">-&gt;</span> DaoInfo <span class="op">{</span></span>
<span id="cb142-464"><a href="#cb142-464" aria-hidden="true" tabindex="-1"></a>            DaoInfo <span class="op">{</span></span>
<span id="cb142-465"><a href="#cb142-465" aria-hidden="true" tabindex="-1"></a>                member_count<span class="op">:</span> <span class="kw">self</span><span class="op">.</span>member_count<span class="op">,</span></span>
<span id="cb142-466"><a href="#cb142-466" aria-hidden="true" tabindex="-1"></a>                proposal_count<span class="op">:</span> <span class="kw">self</span><span class="op">.</span>next_proposal_id <span class="op">-</span> <span class="dv">1</span><span class="op">,</span></span>
<span id="cb142-467"><a href="#cb142-467" aria-hidden="true" tabindex="-1"></a>                treasury_balance<span class="op">:</span> <span class="kw">self</span><span class="op">.</span>treasury_balance<span class="op">,</span></span>
<span id="cb142-468"><a href="#cb142-468" aria-hidden="true" tabindex="-1"></a>                membership_fee<span class="op">:</span> <span class="kw">self</span><span class="op">.</span>membership_fee<span class="op">,</span></span>
<span id="cb142-469"><a href="#cb142-469" aria-hidden="true" tabindex="-1"></a>                voting_period<span class="op">:</span> <span class="kw">self</span><span class="op">.</span>voting_period<span class="op">,</span></span>
<span id="cb142-470"><a href="#cb142-470" aria-hidden="true" tabindex="-1"></a>                quorum_threshold<span class="op">:</span> <span class="kw">self</span><span class="op">.</span>quorum_threshold<span class="op">,</span></span>
<span id="cb142-471"><a href="#cb142-471" aria-hidden="true" tabindex="-1"></a>                approval_threshold<span class="op">:</span> <span class="kw">self</span><span class="op">.</span>approval_threshold<span class="op">,</span></span>
<span id="cb142-472"><a href="#cb142-472" aria-hidden="true" tabindex="-1"></a>            <span class="op">}</span></span>
<span id="cb142-473"><a href="#cb142-473" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb142-474"><a href="#cb142-474" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb142-475"><a href="#cb142-475" aria-hidden="true" tabindex="-1"></a>        <span class="co">// ========== INTERNAL FUNCTIONS ==========</span></span>
<span id="cb142-476"><a href="#cb142-476" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb142-477"><a href="#cb142-477" aria-hidden="true" tabindex="-1"></a>        <span class="co">/// Validate proposal type parameters</span></span>
<span id="cb142-478"><a href="#cb142-478" aria-hidden="true" tabindex="-1"></a>        <span class="kw">fn</span> validate_proposal_type(<span class="op">&amp;</span><span class="kw">self</span><span class="op">,</span> proposal_type<span class="op">:</span> <span class="op">&amp;</span>ProposalType) <span class="op">-&gt;</span> <span class="dt">Result</span><span class="op">&lt;</span>()<span class="op">,</span> <span class="bu">Error</span><span class="op">&gt;</span> <span class="op">{</span></span>
<span id="cb142-479"><a href="#cb142-479" aria-hidden="true" tabindex="-1"></a>            <span class="cf">match</span> proposal_type <span class="op">{</span></span>
<span id="cb142-480"><a href="#cb142-480" aria-hidden="true" tabindex="-1"></a>                <span class="pp">ProposalType::</span>TreasuryTransfer <span class="op">{</span> amount<span class="op">,</span> <span class="op">..</span> <span class="op">}</span> <span class="op">=&gt;</span> <span class="op">{</span></span>
<span id="cb142-481"><a href="#cb142-481" aria-hidden="true" tabindex="-1"></a>                    <span class="cf">if</span> <span class="op">*</span>amount <span class="op">&gt;</span> <span class="kw">self</span><span class="op">.</span>treasury_balance <span class="op">{</span></span>
<span id="cb142-482"><a href="#cb142-482" aria-hidden="true" tabindex="-1"></a>                        <span class="cf">return</span> <span class="cn">Err</span>(<span class="bu">Error</span><span class="pp">::</span>InsufficientTreasuryFunds)<span class="op">;</span></span>
<span id="cb142-483"><a href="#cb142-483" aria-hidden="true" tabindex="-1"></a>                    <span class="op">}</span></span>
<span id="cb142-484"><a href="#cb142-484" aria-hidden="true" tabindex="-1"></a>                <span class="op">}</span></span>
<span id="cb142-485"><a href="#cb142-485" aria-hidden="true" tabindex="-1"></a>                <span class="pp">ProposalType::</span>ChangeMembershipFee <span class="op">{</span> new_fee <span class="op">}</span> <span class="op">=&gt;</span> <span class="op">{</span></span>
<span id="cb142-486"><a href="#cb142-486" aria-hidden="true" tabindex="-1"></a>                    <span class="cf">if</span> <span class="op">*</span>new_fee <span class="op">==</span> <span class="dv">0</span> <span class="op">{</span></span>
<span id="cb142-487"><a href="#cb142-487" aria-hidden="true" tabindex="-1"></a>                        <span class="cf">return</span> <span class="cn">Err</span>(<span class="bu">Error</span><span class="pp">::</span>InvalidParameters)<span class="op">;</span></span>
<span id="cb142-488"><a href="#cb142-488" aria-hidden="true" tabindex="-1"></a>                    <span class="op">}</span></span>
<span id="cb142-489"><a href="#cb142-489" aria-hidden="true" tabindex="-1"></a>                <span class="op">}</span></span>
<span id="cb142-490"><a href="#cb142-490" aria-hidden="true" tabindex="-1"></a>                <span class="pp">ProposalType::</span>ChangeVotingConfig <span class="op">{</span> </span>
<span id="cb142-491"><a href="#cb142-491" aria-hidden="true" tabindex="-1"></a>                    quorum_threshold<span class="op">,</span> </span>
<span id="cb142-492"><a href="#cb142-492" aria-hidden="true" tabindex="-1"></a>                    approval_threshold<span class="op">,</span> </span>
<span id="cb142-493"><a href="#cb142-493" aria-hidden="true" tabindex="-1"></a>                    <span class="op">..</span> </span>
<span id="cb142-494"><a href="#cb142-494" aria-hidden="true" tabindex="-1"></a>                <span class="op">}</span> <span class="op">=&gt;</span> <span class="op">{</span></span>
<span id="cb142-495"><a href="#cb142-495" aria-hidden="true" tabindex="-1"></a>                    <span class="cf">if</span> <span class="kw">let</span> <span class="cn">Some</span>(quorum) <span class="op">=</span> quorum_threshold <span class="op">{</span></span>
<span id="cb142-496"><a href="#cb142-496" aria-hidden="true" tabindex="-1"></a>                        <span class="cf">if</span> <span class="op">*</span>quorum <span class="op">&gt;</span> <span class="dv">100</span> <span class="op">{</span></span>
<span id="cb142-497"><a href="#cb142-497" aria-hidden="true" tabindex="-1"></a>                            <span class="cf">return</span> <span class="cn">Err</span>(<span class="bu">Error</span><span class="pp">::</span>InvalidParameters)<span class="op">;</span></span>
<span id="cb142-498"><a href="#cb142-498" aria-hidden="true" tabindex="-1"></a>                        <span class="op">}</span></span>
<span id="cb142-499"><a href="#cb142-499" aria-hidden="true" tabindex="-1"></a>                    <span class="op">}</span></span>
<span id="cb142-500"><a href="#cb142-500" aria-hidden="true" tabindex="-1"></a>                    <span class="cf">if</span> <span class="kw">let</span> <span class="cn">Some</span>(approval) <span class="op">=</span> approval_threshold <span class="op">{</span></span>
<span id="cb142-501"><a href="#cb142-501" aria-hidden="true" tabindex="-1"></a>                        <span class="cf">if</span> <span class="op">*</span>approval <span class="op">&gt;</span> <span class="dv">100</span> <span class="op">{</span></span>
<span id="cb142-502"><a href="#cb142-502" aria-hidden="true" tabindex="-1"></a>                            <span class="cf">return</span> <span class="cn">Err</span>(<span class="bu">Error</span><span class="pp">::</span>InvalidParameters)<span class="op">;</span></span>
<span id="cb142-503"><a href="#cb142-503" aria-hidden="true" tabindex="-1"></a>                        <span class="op">}</span></span>
<span id="cb142-504"><a href="#cb142-504" aria-hidden="true" tabindex="-1"></a>                    <span class="op">}</span></span>
<span id="cb142-505"><a href="#cb142-505" aria-hidden="true" tabindex="-1"></a>                <span class="op">}</span></span>
<span id="cb142-506"><a href="#cb142-506" aria-hidden="true" tabindex="-1"></a>                _ <span class="op">=&gt;</span> <span class="op">{}</span> <span class="co">// Other types are always valid</span></span>
<span id="cb142-507"><a href="#cb142-507" aria-hidden="true" tabindex="-1"></a>            <span class="op">}</span></span>
<span id="cb142-508"><a href="#cb142-508" aria-hidden="true" tabindex="-1"></a>            <span class="cn">Ok</span>(())</span>
<span id="cb142-509"><a href="#cb142-509" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb142-510"><a href="#cb142-510" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb142-511"><a href="#cb142-511" aria-hidden="true" tabindex="-1"></a>        <span class="co">/// Try to finalize proposal if voting thresholds are met</span></span>
<span id="cb142-512"><a href="#cb142-512" aria-hidden="true" tabindex="-1"></a>        <span class="kw">fn</span> try_finalize_proposal(<span class="op">&amp;</span><span class="kw">mut</span> <span class="kw">self</span><span class="op">,</span> proposal_id<span class="op">:</span> <span class="dt">u32</span>) <span class="op">-&gt;</span> <span class="dt">Result</span><span class="op">&lt;</span>()<span class="op">,</span> <span class="bu">Error</span><span class="op">&gt;</span> <span class="op">{</span></span>
<span id="cb142-513"><a href="#cb142-513" aria-hidden="true" tabindex="-1"></a>            <span class="kw">let</span> <span class="kw">mut</span> proposal <span class="op">=</span> <span class="kw">self</span><span class="op">.</span>proposals<span class="op">.</span>get(proposal_id)<span class="op">.</span>unwrap()<span class="op">;</span></span>
<span id="cb142-514"><a href="#cb142-514" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb142-515"><a href="#cb142-515" aria-hidden="true" tabindex="-1"></a>            <span class="kw">let</span> total_votes <span class="op">=</span> proposal<span class="op">.</span>yes_votes <span class="op">+</span> proposal<span class="op">.</span>no_votes<span class="op">;</span></span>
<span id="cb142-516"><a href="#cb142-516" aria-hidden="true" tabindex="-1"></a>            <span class="kw">let</span> quorum_required <span class="op">=</span> (<span class="kw">self</span><span class="op">.</span>member_count <span class="op">*</span> <span class="kw">self</span><span class="op">.</span>quorum_threshold) <span class="op">/</span> <span class="dv">100</span><span class="op">;</span></span>
<span id="cb142-517"><a href="#cb142-517" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb142-518"><a href="#cb142-518" aria-hidden="true" tabindex="-1"></a>            <span class="co">// Check if quorum is reached</span></span>
<span id="cb142-519"><a href="#cb142-519" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> total_votes <span class="op">&gt;=</span> quorum_required <span class="op">{</span></span>
<span id="cb142-520"><a href="#cb142-520" aria-hidden="true" tabindex="-1"></a>                <span class="kw">let</span> approval_required <span class="op">=</span> (total_votes <span class="op">*</span> <span class="kw">self</span><span class="op">.</span>approval_threshold) <span class="op">/</span> <span class="dv">100</span><span class="op">;</span></span>
<span id="cb142-521"><a href="#cb142-521" aria-hidden="true" tabindex="-1"></a>                </span>
<span id="cb142-522"><a href="#cb142-522" aria-hidden="true" tabindex="-1"></a>                <span class="co">// Check if proposal passes</span></span>
<span id="cb142-523"><a href="#cb142-523" aria-hidden="true" tabindex="-1"></a>                <span class="cf">if</span> proposal<span class="op">.</span>yes_votes <span class="op">&gt;=</span> approval_required <span class="op">{</span></span>
<span id="cb142-524"><a href="#cb142-524" aria-hidden="true" tabindex="-1"></a>                    proposal<span class="op">.</span>status <span class="op">=</span> <span class="pp">ProposalStatus::</span>Passed<span class="op">;</span></span>
<span id="cb142-525"><a href="#cb142-525" aria-hidden="true" tabindex="-1"></a>                <span class="op">}</span> <span class="cf">else</span> <span class="op">{</span></span>
<span id="cb142-526"><a href="#cb142-526" aria-hidden="true" tabindex="-1"></a>                    proposal<span class="op">.</span>status <span class="op">=</span> <span class="pp">ProposalStatus::</span>Failed<span class="op">;</span></span>
<span id="cb142-527"><a href="#cb142-527" aria-hidden="true" tabindex="-1"></a>                <span class="op">}</span></span>
<span id="cb142-528"><a href="#cb142-528" aria-hidden="true" tabindex="-1"></a>                </span>
<span id="cb142-529"><a href="#cb142-529" aria-hidden="true" tabindex="-1"></a>                <span class="kw">self</span><span class="op">.</span>proposals<span class="op">.</span>insert(proposal_id<span class="op">,</span> <span class="op">&amp;</span>proposal)<span class="op">;</span></span>
<span id="cb142-530"><a href="#cb142-530" aria-hidden="true" tabindex="-1"></a>            <span class="op">}</span></span>
<span id="cb142-531"><a href="#cb142-531" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb142-532"><a href="#cb142-532" aria-hidden="true" tabindex="-1"></a>            <span class="cn">Ok</span>(())</span>
<span id="cb142-533"><a href="#cb142-533" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb142-534"><a href="#cb142-534" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb142-535"><a href="#cb142-535" aria-hidden="true" tabindex="-1"></a>        <span class="co">/// Execute proposal action</span></span>
<span id="cb142-536"><a href="#cb142-536" aria-hidden="true" tabindex="-1"></a>        <span class="kw">fn</span> execute_proposal_action(<span class="op">&amp;</span><span class="kw">mut</span> <span class="kw">self</span><span class="op">,</span> proposal_type<span class="op">:</span> <span class="op">&amp;</span>ProposalType) <span class="op">-&gt;</span> <span class="dt">Result</span><span class="op">&lt;</span>()<span class="op">,</span> <span class="bu">Error</span><span class="op">&gt;</span> <span class="op">{</span></span>
<span id="cb142-537"><a href="#cb142-537" aria-hidden="true" tabindex="-1"></a>            <span class="cf">match</span> proposal_type <span class="op">{</span></span>
<span id="cb142-538"><a href="#cb142-538" aria-hidden="true" tabindex="-1"></a>                <span class="pp">ProposalType::</span>TreasuryTransfer <span class="op">{</span> to<span class="op">,</span> amount <span class="op">}</span> <span class="op">=&gt;</span> <span class="op">{</span></span>
<span id="cb142-539"><a href="#cb142-539" aria-hidden="true" tabindex="-1"></a>                    <span class="cf">if</span> <span class="kw">self</span><span class="op">.</span>treasury_balance <span class="op">&lt;</span> <span class="op">*</span>amount <span class="op">{</span></span>
<span id="cb142-540"><a href="#cb142-540" aria-hidden="true" tabindex="-1"></a>                        <span class="cf">return</span> <span class="cn">Err</span>(<span class="bu">Error</span><span class="pp">::</span>InsufficientTreasuryFunds)<span class="op">;</span></span>
<span id="cb142-541"><a href="#cb142-541" aria-hidden="true" tabindex="-1"></a>                    <span class="op">}</span></span>
<span id="cb142-542"><a href="#cb142-542" aria-hidden="true" tabindex="-1"></a>                    </span>
<span id="cb142-543"><a href="#cb142-543" aria-hidden="true" tabindex="-1"></a>                    <span class="kw">self</span><span class="op">.</span>treasury_balance <span class="op">-=</span> amount<span class="op">;</span></span>
<span id="cb142-544"><a href="#cb142-544" aria-hidden="true" tabindex="-1"></a>                    <span class="kw">self</span><span class="op">.</span>env()<span class="op">.</span>transfer(<span class="op">*</span>to<span class="op">,</span> <span class="op">*</span>amount)</span>
<span id="cb142-545"><a href="#cb142-545" aria-hidden="true" tabindex="-1"></a>                        <span class="op">.</span>map_err(<span class="op">|</span>_<span class="op">|</span> <span class="bu">Error</span><span class="pp">::</span>ArithmeticUnderflow)<span class="op">?;</span></span>
<span id="cb142-546"><a href="#cb142-546" aria-hidden="true" tabindex="-1"></a>                <span class="op">}</span></span>
<span id="cb142-547"><a href="#cb142-547" aria-hidden="true" tabindex="-1"></a>                <span class="pp">ProposalType::</span>ChangeMembershipFee <span class="op">{</span> new_fee <span class="op">}</span> <span class="op">=&gt;</span> <span class="op">{</span></span>
<span id="cb142-548"><a href="#cb142-548" aria-hidden="true" tabindex="-1"></a>                    <span class="kw">self</span><span class="op">.</span>membership_fee <span class="op">=</span> <span class="op">*</span>new_fee<span class="op">;</span></span>
<span id="cb142-549"><a href="#cb142-549" aria-hidden="true" tabindex="-1"></a>                <span class="op">}</span></span>
<span id="cb142-550"><a href="#cb142-550" aria-hidden="true" tabindex="-1"></a>                <span class="pp">ProposalType::</span>ChangeVotingConfig <span class="op">{</span> </span>
<span id="cb142-551"><a href="#cb142-551" aria-hidden="true" tabindex="-1"></a>                    voting_period<span class="op">,</span></span>
<span id="cb142-552"><a href="#cb142-552" aria-hidden="true" tabindex="-1"></a>                    quorum_threshold<span class="op">,</span></span>
<span id="cb142-553"><a href="#cb142-553" aria-hidden="true" tabindex="-1"></a>                    approval_threshold<span class="op">,</span></span>
<span id="cb142-554"><a href="#cb142-554" aria-hidden="true" tabindex="-1"></a>                <span class="op">}</span> <span class="op">=&gt;</span> <span class="op">{</span></span>
<span id="cb142-555"><a href="#cb142-555" aria-hidden="true" tabindex="-1"></a>                    <span class="cf">if</span> <span class="kw">let</span> <span class="cn">Some</span>(period) <span class="op">=</span> voting_period <span class="op">{</span></span>
<span id="cb142-556"><a href="#cb142-556" aria-hidden="true" tabindex="-1"></a>                        <span class="kw">self</span><span class="op">.</span>voting_period <span class="op">=</span> <span class="op">*</span>period<span class="op">;</span></span>
<span id="cb142-557"><a href="#cb142-557" aria-hidden="true" tabindex="-1"></a>                    <span class="op">}</span></span>
<span id="cb142-558"><a href="#cb142-558" aria-hidden="true" tabindex="-1"></a>                    <span class="cf">if</span> <span class="kw">let</span> <span class="cn">Some</span>(quorum) <span class="op">=</span> quorum_threshold <span class="op">{</span></span>
<span id="cb142-559"><a href="#cb142-559" aria-hidden="true" tabindex="-1"></a>                        <span class="kw">self</span><span class="op">.</span>quorum_threshold <span class="op">=</span> <span class="op">*</span>quorum<span class="op">;</span></span>
<span id="cb142-560"><a href="#cb142-560" aria-hidden="true" tabindex="-1"></a>                    <span class="op">}</span></span>
<span id="cb142-561"><a href="#cb142-561" aria-hidden="true" tabindex="-1"></a>                    <span class="cf">if</span> <span class="kw">let</span> <span class="cn">Some</span>(approval) <span class="op">=</span> approval_threshold <span class="op">{</span></span>
<span id="cb142-562"><a href="#cb142-562" aria-hidden="true" tabindex="-1"></a>                        <span class="kw">self</span><span class="op">.</span>approval_threshold <span class="op">=</span> <span class="op">*</span>approval<span class="op">;</span></span>
<span id="cb142-563"><a href="#cb142-563" aria-hidden="true" tabindex="-1"></a>                    <span class="op">}</span></span>
<span id="cb142-564"><a href="#cb142-564" aria-hidden="true" tabindex="-1"></a>                <span class="op">}</span></span>
<span id="cb142-565"><a href="#cb142-565" aria-hidden="true" tabindex="-1"></a>                <span class="pp">ProposalType::</span>MembershipChange <span class="op">{</span> account<span class="op">,</span> add <span class="op">}</span> <span class="op">=&gt;</span> <span class="op">{</span></span>
<span id="cb142-566"><a href="#cb142-566" aria-hidden="true" tabindex="-1"></a>                    <span class="cf">if</span> <span class="op">*</span>add <span class="op">{</span></span>
<span id="cb142-567"><a href="#cb142-567" aria-hidden="true" tabindex="-1"></a>                        <span class="cf">if</span> <span class="op">!</span><span class="kw">self</span><span class="op">.</span>members<span class="op">.</span>contains(<span class="op">*</span>account) <span class="op">{</span></span>
<span id="cb142-568"><a href="#cb142-568" aria-hidden="true" tabindex="-1"></a>                            <span class="kw">let</span> member <span class="op">=</span> Member <span class="op">{</span></span>
<span id="cb142-569"><a href="#cb142-569" aria-hidden="true" tabindex="-1"></a>                                joined_at<span class="op">:</span> <span class="kw">self</span><span class="op">.</span>env()<span class="op">.</span>block_timestamp()<span class="op">,</span></span>
<span id="cb142-570"><a href="#cb142-570" aria-hidden="true" tabindex="-1"></a>                                voting_power<span class="op">:</span> <span class="dv">1</span><span class="op">,</span></span>
<span id="cb142-571"><a href="#cb142-571" aria-hidden="true" tabindex="-1"></a>                                proposals_created<span class="op">:</span> <span class="dv">0</span><span class="op">,</span></span>
<span id="cb142-572"><a href="#cb142-572" aria-hidden="true" tabindex="-1"></a>                                votes_cast<span class="op">:</span> <span class="dv">0</span><span class="op">,</span></span>
<span id="cb142-573"><a href="#cb142-573" aria-hidden="true" tabindex="-1"></a>                            <span class="op">};</span></span>
<span id="cb142-574"><a href="#cb142-574" aria-hidden="true" tabindex="-1"></a>                            <span class="kw">self</span><span class="op">.</span>members<span class="op">.</span>insert(<span class="op">*</span>account<span class="op">,</span> <span class="op">&amp;</span>member)<span class="op">;</span></span>
<span id="cb142-575"><a href="#cb142-575" aria-hidden="true" tabindex="-1"></a>                            <span class="kw">self</span><span class="op">.</span>member_count <span class="op">+=</span> <span class="dv">1</span><span class="op">;</span></span>
<span id="cb142-576"><a href="#cb142-576" aria-hidden="true" tabindex="-1"></a>                        <span class="op">}</span></span>
<span id="cb142-577"><a href="#cb142-577" aria-hidden="true" tabindex="-1"></a>                    <span class="op">}</span> <span class="cf">else</span> <span class="op">{</span></span>
<span id="cb142-578"><a href="#cb142-578" aria-hidden="true" tabindex="-1"></a>                        <span class="cf">if</span> <span class="kw">self</span><span class="op">.</span>members<span class="op">.</span>contains(<span class="op">*</span>account) <span class="op">{</span></span>
<span id="cb142-579"><a href="#cb142-579" aria-hidden="true" tabindex="-1"></a>                            <span class="kw">self</span><span class="op">.</span>members<span class="op">.</span>remove(<span class="op">*</span>account)<span class="op">;</span></span>
<span id="cb142-580"><a href="#cb142-580" aria-hidden="true" tabindex="-1"></a>                            <span class="kw">self</span><span class="op">.</span>member_count <span class="op">-=</span> <span class="dv">1</span><span class="op">;</span></span>
<span id="cb142-581"><a href="#cb142-581" aria-hidden="true" tabindex="-1"></a>                        <span class="op">}</span></span>
<span id="cb142-582"><a href="#cb142-582" aria-hidden="true" tabindex="-1"></a>                    <span class="op">}</span></span>
<span id="cb142-583"><a href="#cb142-583" aria-hidden="true" tabindex="-1"></a>                <span class="op">}</span></span>
<span id="cb142-584"><a href="#cb142-584" aria-hidden="true" tabindex="-1"></a>                <span class="pp">ProposalType::</span>General <span class="op">=&gt;</span> <span class="op">{</span></span>
<span id="cb142-585"><a href="#cb142-585" aria-hidden="true" tabindex="-1"></a>                    <span class="co">// General proposals don&#39;t have executable actions</span></span>
<span id="cb142-586"><a href="#cb142-586" aria-hidden="true" tabindex="-1"></a>                <span class="op">}</span></span>
<span id="cb142-587"><a href="#cb142-587" aria-hidden="true" tabindex="-1"></a>            <span class="op">}</span></span>
<span id="cb142-588"><a href="#cb142-588" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb142-589"><a href="#cb142-589" aria-hidden="true" tabindex="-1"></a>            <span class="cn">Ok</span>(())</span>
<span id="cb142-590"><a href="#cb142-590" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb142-591"><a href="#cb142-591" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb142-592"><a href="#cb142-592" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb142-593"><a href="#cb142-593" aria-hidden="true" tabindex="-1"></a>    <span class="co">/// DAO information structure</span></span>
<span id="cb142-594"><a href="#cb142-594" aria-hidden="true" tabindex="-1"></a>    <span class="at">#[</span>derive<span class="at">(</span><span class="bu">Debug</span><span class="op">,</span> <span class="bu">PartialEq</span><span class="op">,</span> <span class="bu">Eq</span><span class="op">,</span> <span class="pp">scale::</span>Encode<span class="op">,</span> <span class="pp">scale::</span>Decode<span class="at">)]</span></span>
<span id="cb142-595"><a href="#cb142-595" aria-hidden="true" tabindex="-1"></a>    <span class="at">#[</span>cfg_attr<span class="at">(</span>feature <span class="op">=</span> <span class="st">&quot;std&quot;</span><span class="op">,</span> derive<span class="at">(</span><span class="pp">scale_info::</span>TypeInfo<span class="at">))]</span></span>
<span id="cb142-596"><a href="#cb142-596" aria-hidden="true" tabindex="-1"></a>    <span class="kw">pub</span> <span class="kw">struct</span> DaoInfo <span class="op">{</span></span>
<span id="cb142-597"><a href="#cb142-597" aria-hidden="true" tabindex="-1"></a>        <span class="kw">pub</span> member_count<span class="op">:</span> <span class="dt">u32</span><span class="op">,</span></span>
<span id="cb142-598"><a href="#cb142-598" aria-hidden="true" tabindex="-1"></a>        <span class="kw">pub</span> proposal_count<span class="op">:</span> <span class="dt">u32</span><span class="op">,</span></span>
<span id="cb142-599"><a href="#cb142-599" aria-hidden="true" tabindex="-1"></a>        <span class="kw">pub</span> treasury_balance<span class="op">:</span> Balance<span class="op">,</span></span>
<span id="cb142-600"><a href="#cb142-600" aria-hidden="true" tabindex="-1"></a>        <span class="kw">pub</span> membership_fee<span class="op">:</span> Balance<span class="op">,</span></span>
<span id="cb142-601"><a href="#cb142-601" aria-hidden="true" tabindex="-1"></a>        <span class="kw">pub</span> voting_period<span class="op">:</span> <span class="dt">u64</span><span class="op">,</span></span>
<span id="cb142-602"><a href="#cb142-602" aria-hidden="true" tabindex="-1"></a>        <span class="kw">pub</span> quorum_threshold<span class="op">:</span> <span class="dt">u32</span><span class="op">,</span></span>
<span id="cb142-603"><a href="#cb142-603" aria-hidden="true" tabindex="-1"></a>        <span class="kw">pub</span> approval_threshold<span class="op">:</span> <span class="dt">u32</span><span class="op">,</span></span>
<span id="cb142-604"><a href="#cb142-604" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb142-605"><a href="#cb142-605" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb142-606"><a href="#cb142-606" aria-hidden="true" tabindex="-1"></a>    <span class="co">/// Comprehensive test suite</span></span>
<span id="cb142-607"><a href="#cb142-607" aria-hidden="true" tabindex="-1"></a>    <span class="at">#[</span>cfg<span class="at">(</span>test<span class="at">)]</span></span>
<span id="cb142-608"><a href="#cb142-608" aria-hidden="true" tabindex="-1"></a>    <span class="kw">mod</span> tests <span class="op">{</span></span>
<span id="cb142-609"><a href="#cb142-609" aria-hidden="true" tabindex="-1"></a>        <span class="kw">use</span> <span class="kw">super</span><span class="pp">::</span><span class="op">*;</span></span>
<span id="cb142-610"><a href="#cb142-610" aria-hidden="true" tabindex="-1"></a>        <span class="kw">use</span> <span class="pp">ink::env::</span>test<span class="op">;</span></span>
<span id="cb142-611"><a href="#cb142-611" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb142-612"><a href="#cb142-612" aria-hidden="true" tabindex="-1"></a>        <span class="kw">fn</span> accounts() <span class="op">-&gt;</span> <span class="pp">ink::env::test::</span>DefaultAccounts<span class="op">&lt;</span><span class="pp">ink::env::</span>DefaultEnvironment<span class="op">&gt;</span> <span class="op">{</span></span>
<span id="cb142-613"><a href="#cb142-613" aria-hidden="true" tabindex="-1"></a>            <span class="pp">ink::env::test::default_accounts::</span><span class="op">&lt;</span><span class="pp">ink::env::</span>DefaultEnvironment<span class="op">&gt;</span>()</span>
<span id="cb142-614"><a href="#cb142-614" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb142-615"><a href="#cb142-615" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb142-616"><a href="#cb142-616" aria-hidden="true" tabindex="-1"></a>        <span class="kw">fn</span> setup_dao() <span class="op">-&gt;</span> Dao <span class="op">{</span></span>
<span id="cb142-617"><a href="#cb142-617" aria-hidden="true" tabindex="-1"></a>            <span class="kw">let</span> accounts <span class="op">=</span> accounts()<span class="op">;</span></span>
<span id="cb142-618"><a href="#cb142-618" aria-hidden="true" tabindex="-1"></a>            <span class="pp">test::set_caller::</span><span class="op">&lt;</span><span class="pp">ink::env::</span>DefaultEnvironment<span class="op">&gt;</span>(accounts<span class="op">.</span>alice)<span class="op">;</span></span>
<span id="cb142-619"><a href="#cb142-619" aria-hidden="true" tabindex="-1"></a>            <span class="pp">Dao::</span>new(<span class="dv">1000</span><span class="op">,</span> <span class="dv">86400000</span><span class="op">,</span> <span class="dv">50</span><span class="op">,</span> <span class="dv">60</span>)<span class="op">.</span>unwrap() <span class="co">// 24h voting, 50% quorum, 60% approval</span></span>
<span id="cb142-620"><a href="#cb142-620" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb142-621"><a href="#cb142-621" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb142-622"><a href="#cb142-622" aria-hidden="true" tabindex="-1"></a>        <span class="at">#[</span><span class="pp">ink::</span>test<span class="at">]</span></span>
<span id="cb142-623"><a href="#cb142-623" aria-hidden="true" tabindex="-1"></a>        <span class="kw">fn</span> constructor_works() <span class="op">{</span></span>
<span id="cb142-624"><a href="#cb142-624" aria-hidden="true" tabindex="-1"></a>            <span class="kw">let</span> dao <span class="op">=</span> setup_dao()<span class="op">;</span></span>
<span id="cb142-625"><a href="#cb142-625" aria-hidden="true" tabindex="-1"></a>            <span class="kw">let</span> accounts <span class="op">=</span> accounts()<span class="op">;</span></span>
<span id="cb142-626"><a href="#cb142-626" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb142-627"><a href="#cb142-627" aria-hidden="true" tabindex="-1"></a>            <span class="pp">assert_eq!</span>(dao<span class="op">.</span>member_count<span class="op">,</span> <span class="dv">1</span>)<span class="op">;</span></span>
<span id="cb142-628"><a href="#cb142-628" aria-hidden="true" tabindex="-1"></a>            <span class="pp">assert!</span>(dao<span class="op">.</span>is_member(accounts<span class="op">.</span>alice))<span class="op">;</span></span>
<span id="cb142-629"><a href="#cb142-629" aria-hidden="true" tabindex="-1"></a>            <span class="pp">assert_eq!</span>(dao<span class="op">.</span>membership_fee<span class="op">,</span> <span class="dv">1000</span>)<span class="op">;</span></span>
<span id="cb142-630"><a href="#cb142-630" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb142-631"><a href="#cb142-631" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb142-632"><a href="#cb142-632" aria-hidden="true" tabindex="-1"></a>        <span class="at">#[</span><span class="pp">ink::</span>test<span class="at">]</span></span>
<span id="cb142-633"><a href="#cb142-633" aria-hidden="true" tabindex="-1"></a>        <span class="kw">fn</span> join_membership_works() <span class="op">{</span></span>
<span id="cb142-634"><a href="#cb142-634" aria-hidden="true" tabindex="-1"></a>            <span class="kw">let</span> <span class="kw">mut</span> dao <span class="op">=</span> setup_dao()<span class="op">;</span></span>
<span id="cb142-635"><a href="#cb142-635" aria-hidden="true" tabindex="-1"></a>            <span class="kw">let</span> accounts <span class="op">=</span> accounts()<span class="op">;</span></span>
<span id="cb142-636"><a href="#cb142-636" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb142-637"><a href="#cb142-637" aria-hidden="true" tabindex="-1"></a>            <span class="pp">test::set_caller::</span><span class="op">&lt;</span><span class="pp">ink::env::</span>DefaultEnvironment<span class="op">&gt;</span>(accounts<span class="op">.</span>bob)<span class="op">;</span></span>
<span id="cb142-638"><a href="#cb142-638" aria-hidden="true" tabindex="-1"></a>            <span class="pp">test::set_value_transferred::</span><span class="op">&lt;</span><span class="pp">ink::env::</span>DefaultEnvironment<span class="op">&gt;</span>(<span class="dv">1000</span>)<span class="op">;</span></span>
<span id="cb142-639"><a href="#cb142-639" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb142-640"><a href="#cb142-640" aria-hidden="true" tabindex="-1"></a>            <span class="pp">assert_eq!</span>(dao<span class="op">.</span>join()<span class="op">,</span> <span class="cn">Ok</span>(()))<span class="op">;</span></span>
<span id="cb142-641"><a href="#cb142-641" aria-hidden="true" tabindex="-1"></a>            <span class="pp">assert_eq!</span>(dao<span class="op">.</span>member_count<span class="op">,</span> <span class="dv">2</span>)<span class="op">;</span></span>
<span id="cb142-642"><a href="#cb142-642" aria-hidden="true" tabindex="-1"></a>            <span class="pp">assert!</span>(dao<span class="op">.</span>is_member(accounts<span class="op">.</span>bob))<span class="op">;</span></span>
<span id="cb142-643"><a href="#cb142-643" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb142-644"><a href="#cb142-644" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb142-645"><a href="#cb142-645" aria-hidden="true" tabindex="-1"></a>        <span class="at">#[</span><span class="pp">ink::</span>test<span class="at">]</span></span>
<span id="cb142-646"><a href="#cb142-646" aria-hidden="true" tabindex="-1"></a>        <span class="kw">fn</span> create_proposal_works() <span class="op">{</span></span>
<span id="cb142-647"><a href="#cb142-647" aria-hidden="true" tabindex="-1"></a>            <span class="kw">let</span> <span class="kw">mut</span> dao <span class="op">=</span> setup_dao()<span class="op">;</span></span>
<span id="cb142-648"><a href="#cb142-648" aria-hidden="true" tabindex="-1"></a>            <span class="kw">let</span> accounts <span class="op">=</span> accounts()<span class="op">;</span></span>
<span id="cb142-649"><a href="#cb142-649" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb142-650"><a href="#cb142-650" aria-hidden="true" tabindex="-1"></a>            <span class="kw">let</span> proposal_id <span class="op">=</span> dao<span class="op">.</span>create_proposal(</span>
<span id="cb142-651"><a href="#cb142-651" aria-hidden="true" tabindex="-1"></a>                <span class="st">&quot;Test Proposal&quot;</span><span class="op">.</span>to_string()<span class="op">,</span></span>
<span id="cb142-652"><a href="#cb142-652" aria-hidden="true" tabindex="-1"></a>                <span class="st">&quot;A test proposal for the DAO&quot;</span><span class="op">.</span>to_string()<span class="op">,</span></span>
<span id="cb142-653"><a href="#cb142-653" aria-hidden="true" tabindex="-1"></a>                <span class="pp">ProposalType::</span>General<span class="op">,</span></span>
<span id="cb142-654"><a href="#cb142-654" aria-hidden="true" tabindex="-1"></a>            )<span class="op">.</span>unwrap()<span class="op">;</span></span>
<span id="cb142-655"><a href="#cb142-655" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb142-656"><a href="#cb142-656" aria-hidden="true" tabindex="-1"></a>            <span class="pp">assert_eq!</span>(proposal_id<span class="op">,</span> <span class="dv">1</span>)<span class="op">;</span></span>
<span id="cb142-657"><a href="#cb142-657" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb142-658"><a href="#cb142-658" aria-hidden="true" tabindex="-1"></a>            <span class="kw">let</span> proposal <span class="op">=</span> dao<span class="op">.</span>get_proposal(proposal_id)<span class="op">.</span>unwrap()<span class="op">;</span></span>
<span id="cb142-659"><a href="#cb142-659" aria-hidden="true" tabindex="-1"></a>            <span class="pp">assert_eq!</span>(proposal<span class="op">.</span>proposer<span class="op">,</span> accounts<span class="op">.</span>alice)<span class="op">;</span></span>
<span id="cb142-660"><a href="#cb142-660" aria-hidden="true" tabindex="-1"></a>            <span class="pp">assert_eq!</span>(proposal<span class="op">.</span>status<span class="op">,</span> <span class="pp">ProposalStatus::</span>Active)<span class="op">;</span></span>
<span id="cb142-661"><a href="#cb142-661" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb142-662"><a href="#cb142-662" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb142-663"><a href="#cb142-663" aria-hidden="true" tabindex="-1"></a>        <span class="at">#[</span><span class="pp">ink::</span>test<span class="at">]</span></span>
<span id="cb142-664"><a href="#cb142-664" aria-hidden="true" tabindex="-1"></a>        <span class="kw">fn</span> voting_works() <span class="op">{</span></span>
<span id="cb142-665"><a href="#cb142-665" aria-hidden="true" tabindex="-1"></a>            <span class="kw">let</span> <span class="kw">mut</span> dao <span class="op">=</span> setup_dao()<span class="op">;</span></span>
<span id="cb142-666"><a href="#cb142-666" aria-hidden="true" tabindex="-1"></a>            <span class="kw">let</span> accounts <span class="op">=</span> accounts()<span class="op">;</span></span>
<span id="cb142-667"><a href="#cb142-667" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb142-668"><a href="#cb142-668" aria-hidden="true" tabindex="-1"></a>            <span class="co">// Add another member</span></span>
<span id="cb142-669"><a href="#cb142-669" aria-hidden="true" tabindex="-1"></a>            <span class="pp">test::set_caller::</span><span class="op">&lt;</span><span class="pp">ink::env::</span>DefaultEnvironment<span class="op">&gt;</span>(accounts<span class="op">.</span>bob)<span class="op">;</span></span>
<span id="cb142-670"><a href="#cb142-670" aria-hidden="true" tabindex="-1"></a>            <span class="pp">test::set_value_transferred::</span><span class="op">&lt;</span><span class="pp">ink::env::</span>DefaultEnvironment<span class="op">&gt;</span>(<span class="dv">1000</span>)<span class="op">;</span></span>
<span id="cb142-671"><a href="#cb142-671" aria-hidden="true" tabindex="-1"></a>            dao<span class="op">.</span>join()<span class="op">.</span>unwrap()<span class="op">;</span></span>
<span id="cb142-672"><a href="#cb142-672" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb142-673"><a href="#cb142-673" aria-hidden="true" tabindex="-1"></a>            <span class="co">// Create proposal</span></span>
<span id="cb142-674"><a href="#cb142-674" aria-hidden="true" tabindex="-1"></a>            <span class="pp">test::set_caller::</span><span class="op">&lt;</span><span class="pp">ink::env::</span>DefaultEnvironment<span class="op">&gt;</span>(accounts<span class="op">.</span>alice)<span class="op">;</span></span>
<span id="cb142-675"><a href="#cb142-675" aria-hidden="true" tabindex="-1"></a>            <span class="kw">let</span> proposal_id <span class="op">=</span> dao<span class="op">.</span>create_proposal(</span>
<span id="cb142-676"><a href="#cb142-676" aria-hidden="true" tabindex="-1"></a>                <span class="st">&quot;Test Proposal&quot;</span><span class="op">.</span>to_string()<span class="op">,</span></span>
<span id="cb142-677"><a href="#cb142-677" aria-hidden="true" tabindex="-1"></a>                <span class="st">&quot;Description&quot;</span><span class="op">.</span>to_string()<span class="op">,</span></span>
<span id="cb142-678"><a href="#cb142-678" aria-hidden="true" tabindex="-1"></a>                <span class="pp">ProposalType::</span>General<span class="op">,</span></span>
<span id="cb142-679"><a href="#cb142-679" aria-hidden="true" tabindex="-1"></a>            )<span class="op">.</span>unwrap()<span class="op">;</span></span>
<span id="cb142-680"><a href="#cb142-680" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb142-681"><a href="#cb142-681" aria-hidden="true" tabindex="-1"></a>            <span class="co">// Vote</span></span>
<span id="cb142-682"><a href="#cb142-682" aria-hidden="true" tabindex="-1"></a>            <span class="pp">assert_eq!</span>(dao<span class="op">.</span>vote(proposal_id<span class="op">,</span> <span class="cn">true</span>)<span class="op">,</span> <span class="cn">Ok</span>(()))<span class="op">;</span></span>
<span id="cb142-683"><a href="#cb142-683" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb142-684"><a href="#cb142-684" aria-hidden="true" tabindex="-1"></a>            <span class="kw">let</span> proposal <span class="op">=</span> dao<span class="op">.</span>get_proposal(proposal_id)<span class="op">.</span>unwrap()<span class="op">;</span></span>
<span id="cb142-685"><a href="#cb142-685" aria-hidden="true" tabindex="-1"></a>            <span class="pp">assert_eq!</span>(proposal<span class="op">.</span>yes_votes<span class="op">,</span> <span class="dv">1</span>)<span class="op">;</span></span>
<span id="cb142-686"><a href="#cb142-686" aria-hidden="true" tabindex="-1"></a>            <span class="pp">assert!</span>(proposal<span class="op">.</span>voters<span class="op">.</span>contains(<span class="op">&amp;</span>accounts<span class="op">.</span>alice))<span class="op">;</span></span>
<span id="cb142-687"><a href="#cb142-687" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb142-688"><a href="#cb142-688" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb142-689"><a href="#cb142-689" aria-hidden="true" tabindex="-1"></a>        <span class="at">#[</span><span class="pp">ink::</span>test<span class="at">]</span></span>
<span id="cb142-690"><a href="#cb142-690" aria-hidden="true" tabindex="-1"></a>        <span class="kw">fn</span> treasury_transfer_proposal_works() <span class="op">{</span></span>
<span id="cb142-691"><a href="#cb142-691" aria-hidden="true" tabindex="-1"></a>            <span class="kw">let</span> <span class="kw">mut</span> dao <span class="op">=</span> setup_dao()<span class="op">;</span></span>
<span id="cb142-692"><a href="#cb142-692" aria-hidden="true" tabindex="-1"></a>            <span class="kw">let</span> accounts <span class="op">=</span> accounts()<span class="op">;</span></span>
<span id="cb142-693"><a href="#cb142-693" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb142-694"><a href="#cb142-694" aria-hidden="true" tabindex="-1"></a>            <span class="co">// Add funds to treasury</span></span>
<span id="cb142-695"><a href="#cb142-695" aria-hidden="true" tabindex="-1"></a>            <span class="pp">test::set_value_transferred::</span><span class="op">&lt;</span><span class="pp">ink::env::</span>DefaultEnvironment<span class="op">&gt;</span>(<span class="dv">5000</span>)<span class="op">;</span></span>
<span id="cb142-696"><a href="#cb142-696" aria-hidden="true" tabindex="-1"></a>            dao<span class="op">.</span>deposit_to_treasury()<span class="op">.</span>unwrap()<span class="op">;</span></span>
<span id="cb142-697"><a href="#cb142-697" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb142-698"><a href="#cb142-698" aria-hidden="true" tabindex="-1"></a>            <span class="co">// Create treasury transfer proposal</span></span>
<span id="cb142-699"><a href="#cb142-699" aria-hidden="true" tabindex="-1"></a>            <span class="kw">let</span> proposal_id <span class="op">=</span> dao<span class="op">.</span>create_proposal(</span>
<span id="cb142-700"><a href="#cb142-700" aria-hidden="true" tabindex="-1"></a>                <span class="st">&quot;Treasury Transfer&quot;</span><span class="op">.</span>to_string()<span class="op">,</span></span>
<span id="cb142-701"><a href="#cb142-701" aria-hidden="true" tabindex="-1"></a>                <span class="st">&quot;Transfer funds to Bob&quot;</span><span class="op">.</span>to_string()<span class="op">,</span></span>
<span id="cb142-702"><a href="#cb142-702" aria-hidden="true" tabindex="-1"></a>                <span class="pp">ProposalType::</span>TreasuryTransfer <span class="op">{</span></span>
<span id="cb142-703"><a href="#cb142-703" aria-hidden="true" tabindex="-1"></a>                    to<span class="op">:</span> accounts<span class="op">.</span>bob<span class="op">,</span></span>
<span id="cb142-704"><a href="#cb142-704" aria-hidden="true" tabindex="-1"></a>                    amount<span class="op">:</span> <span class="dv">1000</span><span class="op">,</span></span>
<span id="cb142-705"><a href="#cb142-705" aria-hidden="true" tabindex="-1"></a>                <span class="op">},</span></span>
<span id="cb142-706"><a href="#cb142-706" aria-hidden="true" tabindex="-1"></a>            )<span class="op">.</span>unwrap()<span class="op">;</span></span>
<span id="cb142-707"><a href="#cb142-707" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb142-708"><a href="#cb142-708" aria-hidden="true" tabindex="-1"></a>            <span class="co">// Vote to pass the proposal</span></span>
<span id="cb142-709"><a href="#cb142-709" aria-hidden="true" tabindex="-1"></a>            dao<span class="op">.</span>vote(proposal_id<span class="op">,</span> <span class="cn">true</span>)<span class="op">.</span>unwrap()<span class="op">;</span></span>
<span id="cb142-710"><a href="#cb142-710" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb142-711"><a href="#cb142-711" aria-hidden="true" tabindex="-1"></a>            <span class="co">// Check if proposal passed (with single member, 100% voted yes)</span></span>
<span id="cb142-712"><a href="#cb142-712" aria-hidden="true" tabindex="-1"></a>            <span class="kw">let</span> proposal <span class="op">=</span> dao<span class="op">.</span>get_proposal(proposal_id)<span class="op">.</span>unwrap()<span class="op">;</span></span>
<span id="cb142-713"><a href="#cb142-713" aria-hidden="true" tabindex="-1"></a>            <span class="pp">assert_eq!</span>(proposal<span class="op">.</span>status<span class="op">,</span> <span class="pp">ProposalStatus::</span>Passed)<span class="op">;</span></span>
<span id="cb142-714"><a href="#cb142-714" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb142-715"><a href="#cb142-715" aria-hidden="true" tabindex="-1"></a>            <span class="co">// Execute proposal</span></span>
<span id="cb142-716"><a href="#cb142-716" aria-hidden="true" tabindex="-1"></a>            <span class="kw">let</span> initial_treasury <span class="op">=</span> dao<span class="op">.</span>treasury_balance<span class="op">;</span></span>
<span id="cb142-717"><a href="#cb142-717" aria-hidden="true" tabindex="-1"></a>            dao<span class="op">.</span>execute_proposal(proposal_id)<span class="op">.</span>unwrap()<span class="op">;</span></span>
<span id="cb142-718"><a href="#cb142-718" aria-hidden="true" tabindex="-1"></a>            <span class="pp">assert_eq!</span>(dao<span class="op">.</span>treasury_balance<span class="op">,</span> initial_treasury <span class="op">-</span> <span class="dv">1000</span>)<span class="op">;</span></span>
<span id="cb142-719"><a href="#cb142-719" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb142-720"><a href="#cb142-720" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb142-721"><a href="#cb142-721" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<h2 id="dao-usage-examples">DAO Usage Examples</h2>
<h3 id="deploying-and-setting-up-the-dao">Deploying and Setting Up the
DAO</h3>
<div class="sourceCode" id="cb143"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb143-1"><a href="#cb143-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Build the DAO contract</span></span>
<span id="cb143-2"><a href="#cb143-2" aria-hidden="true" tabindex="-1"></a><span class="ex">cargo</span> contract build <span class="at">--release</span></span>
<span id="cb143-3"><a href="#cb143-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb143-4"><a href="#cb143-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Deploy with initial parameters</span></span>
<span id="cb143-5"><a href="#cb143-5" aria-hidden="true" tabindex="-1"></a><span class="ex">cargo</span> contract instantiate <span class="dt">\</span></span>
<span id="cb143-6"><a href="#cb143-6" aria-hidden="true" tabindex="-1"></a>    <span class="at">--constructor</span> new <span class="dt">\</span></span>
<span id="cb143-7"><a href="#cb143-7" aria-hidden="true" tabindex="-1"></a>    <span class="at">--args</span> 1000000000000 604800000 40 66 <span class="dt">\ </span> <span class="co"># 0.001 token fee, 7 day voting, 40% quorum, 66% approval</span></span>
<span id="cb143-8"><a href="#cb143-8" aria-hidden="true" tabindex="-1"></a>    <span class="ex">--suri</span> //Alice <span class="dt">\</span></span>
<span id="cb143-9"><a href="#cb143-9" aria-hidden="true" tabindex="-1"></a>    <span class="at">--url</span> ws://127.0.0.1:9944</span></code></pre></div>
<h3 id="interacting-with-the-dao">Interacting with the DAO</h3>
<div class="sourceCode" id="cb144"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb144-1"><a href="#cb144-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Join the DAO as a member</span></span>
<span id="cb144-2"><a href="#cb144-2" aria-hidden="true" tabindex="-1"></a><span class="ex">cargo</span> contract call <span class="dt">\</span></span>
<span id="cb144-3"><a href="#cb144-3" aria-hidden="true" tabindex="-1"></a>    <span class="at">--contract</span> <span class="va">$DAO_ADDRESS</span> <span class="dt">\</span></span>
<span id="cb144-4"><a href="#cb144-4" aria-hidden="true" tabindex="-1"></a>    <span class="at">--message</span> join <span class="dt">\</span></span>
<span id="cb144-5"><a href="#cb144-5" aria-hidden="true" tabindex="-1"></a>    <span class="at">--value</span> 1000000000000 <span class="dt">\</span></span>
<span id="cb144-6"><a href="#cb144-6" aria-hidden="true" tabindex="-1"></a>    <span class="at">--suri</span> //Bob</span>
<span id="cb144-7"><a href="#cb144-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb144-8"><a href="#cb144-8" aria-hidden="true" tabindex="-1"></a><span class="co"># Create a proposal</span></span>
<span id="cb144-9"><a href="#cb144-9" aria-hidden="true" tabindex="-1"></a><span class="ex">cargo</span> contract call <span class="dt">\</span></span>
<span id="cb144-10"><a href="#cb144-10" aria-hidden="true" tabindex="-1"></a>    <span class="at">--contract</span> <span class="va">$DAO_ADDRESS</span> <span class="dt">\</span></span>
<span id="cb144-11"><a href="#cb144-11" aria-hidden="true" tabindex="-1"></a>    <span class="at">--message</span> create_proposal <span class="dt">\</span></span>
<span id="cb144-12"><a href="#cb144-12" aria-hidden="true" tabindex="-1"></a>    <span class="at">--args</span> <span class="st">&quot;Increase Marketing Budget&quot;</span> <span class="st">&quot;Proposal to allocate 10 DOT for marketing initiatives&quot;</span> General <span class="dt">\</span></span>
<span id="cb144-13"><a href="#cb144-13" aria-hidden="true" tabindex="-1"></a>    <span class="at">--suri</span> //Bob</span>
<span id="cb144-14"><a href="#cb144-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb144-15"><a href="#cb144-15" aria-hidden="true" tabindex="-1"></a><span class="co"># Vote on proposal</span></span>
<span id="cb144-16"><a href="#cb144-16" aria-hidden="true" tabindex="-1"></a><span class="ex">cargo</span> contract call <span class="dt">\</span></span>
<span id="cb144-17"><a href="#cb144-17" aria-hidden="true" tabindex="-1"></a>    <span class="at">--contract</span> <span class="va">$DAO_ADDRESS</span> <span class="dt">\</span></span>
<span id="cb144-18"><a href="#cb144-18" aria-hidden="true" tabindex="-1"></a>    <span class="at">--message</span> vote <span class="dt">\</span></span>
<span id="cb144-19"><a href="#cb144-19" aria-hidden="true" tabindex="-1"></a>    <span class="at">--args</span> 1 true <span class="dt">\</span></span>
<span id="cb144-20"><a href="#cb144-20" aria-hidden="true" tabindex="-1"></a>    <span class="at">--suri</span> //Bob</span>
<span id="cb144-21"><a href="#cb144-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb144-22"><a href="#cb144-22" aria-hidden="true" tabindex="-1"></a><span class="co"># Check DAO information</span></span>
<span id="cb144-23"><a href="#cb144-23" aria-hidden="true" tabindex="-1"></a><span class="ex">cargo</span> contract call <span class="dt">\</span></span>
<span id="cb144-24"><a href="#cb144-24" aria-hidden="true" tabindex="-1"></a>    <span class="at">--contract</span> <span class="va">$DAO_ADDRESS</span> <span class="dt">\</span></span>
<span id="cb144-25"><a href="#cb144-25" aria-hidden="true" tabindex="-1"></a>    <span class="at">--message</span> get_dao_info <span class="dt">\</span></span>
<span id="cb144-26"><a href="#cb144-26" aria-hidden="true" tabindex="-1"></a>    <span class="at">--suri</span> //Alice <span class="dt">\</span></span>
<span id="cb144-27"><a href="#cb144-27" aria-hidden="true" tabindex="-1"></a>    <span class="at">--dry-run</span></span></code></pre></div>
<h2 id="summary-9">Summary</h2>
<p>This DAO implementation demonstrates production-ready ink!
development:</p>
<p><strong>Core Features Implemented:</strong> - <strong>Membership
Management</strong>: Paid membership with member tracking -
<strong>Proposal System</strong>: Flexible proposal types with
configurable parameters - <strong>Voting Mechanism</strong>: Democratic
voting with quorum and approval thresholds - <strong>Treasury
Management</strong>: Collective fund management with proposal-based
spending - <strong>Governance</strong>: Self-modifying parameters
through proposals</p>
<p><strong>Advanced Patterns Demonstrated:</strong> -
<strong>Comprehensive Error Handling</strong>: Specific error types for
different failure modes - <strong>Event Emission</strong>: Rich event
system for off-chain tracking - <strong>Access Control</strong>:
Member-only operations and proposal validation - <strong>State
Management</strong>: Complex state transitions and consistency
guarantees - <strong>Gas Optimization</strong>: Efficient storage
patterns and batch operations</p>
<p><strong>Testing Strategy:</strong> - <strong>Unit Tests</strong>:
Core functionality validation - <strong>Integration Scenarios</strong>:
Multi-step workflows - <strong>Edge Case Handling</strong>: Boundary
conditions and error states</p>
<p><strong>Security Considerations:</strong> - <strong>Arithmetic
Safety</strong>: Overflow/underflow protection - <strong>Access
Control</strong>: Proper authorization checks - <strong>State
Validation</strong>: Consistent state transitions - <strong>Economic
Security</strong>: Membership fees and treasury protection</p>
<p>This DAO serves as a complete example of how to build sophisticated,
production-ready smart contracts using ink!. The patterns and techniques
demonstrated here can be adapted and extended for a wide variety of
decentralized applications.</p>
<hr />
<h1 id="appendix-cheatsheets-and-further-resources">Appendix:
Cheatsheets and Further Resources</h1>
<p>This appendix provides quick reference materials for ink!
development, including command cheatsheets, common patterns, and
resources for continued learning.</p>
<h2 id="cargo-contract-cheatsheet">cargo contract Cheatsheet</h2>
<h3 id="project-management">Project Management</h3>
<div class="sourceCode" id="cb145"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb145-1"><a href="#cb145-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Create new ink! project</span></span>
<span id="cb145-2"><a href="#cb145-2" aria-hidden="true" tabindex="-1"></a><span class="ex">cargo</span> contract new <span class="op">&lt;</span>contract_name<span class="op">&gt;</span></span>
<span id="cb145-3"><a href="#cb145-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb145-4"><a href="#cb145-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Build contract</span></span>
<span id="cb145-5"><a href="#cb145-5" aria-hidden="true" tabindex="-1"></a><span class="ex">cargo</span> contract build <span class="pp">[--</span><span class="ss">release</span><span class="pp">]</span></span>
<span id="cb145-6"><a href="#cb145-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb145-7"><a href="#cb145-7" aria-hidden="true" tabindex="-1"></a><span class="co"># Check contract without building</span></span>
<span id="cb145-8"><a href="#cb145-8" aria-hidden="true" tabindex="-1"></a><span class="ex">cargo</span> contract check</span>
<span id="cb145-9"><a href="#cb145-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb145-10"><a href="#cb145-10" aria-hidden="true" tabindex="-1"></a><span class="co"># Generate contract documentation</span></span>
<span id="cb145-11"><a href="#cb145-11" aria-hidden="true" tabindex="-1"></a><span class="ex">cargo</span> doc <span class="at">--open</span></span></code></pre></div>
<h3 id="deployment-and-interaction">Deployment and Interaction</h3>
<div class="sourceCode" id="cb146"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb146-1"><a href="#cb146-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Deploy contract to network</span></span>
<span id="cb146-2"><a href="#cb146-2" aria-hidden="true" tabindex="-1"></a><span class="ex">cargo</span> contract instantiate <span class="dt">\</span></span>
<span id="cb146-3"><a href="#cb146-3" aria-hidden="true" tabindex="-1"></a>    <span class="at">--constructor</span> <span class="op">&lt;</span>constructor_name<span class="op">&gt;</span> <span class="dt">\</span></span>
<span id="cb146-4"><a href="#cb146-4" aria-hidden="true" tabindex="-1"></a>    <span class="at">--args</span> <span class="op">&lt;</span>arg1<span class="op">&gt;</span> <span class="op">&lt;</span>arg2<span class="op">&gt;</span> ... <span class="dt">\</span></span>
<span id="cb146-5"><a href="#cb146-5" aria-hidden="true" tabindex="-1"></a>    <span class="at">--suri</span> <span class="op">&lt;</span>signer<span class="op">&gt;</span> <span class="dt">\</span></span>
<span id="cb146-6"><a href="#cb146-6" aria-hidden="true" tabindex="-1"></a>    <span class="at">--url</span> <span class="op">&lt;</span>endpoint<span class="op">&gt;</span> <span class="dt">\</span></span>
<span id="cb146-7"><a href="#cb146-7" aria-hidden="true" tabindex="-1"></a>    [--value <span class="op">&lt;</span>amount<span class="op">&gt;</span>] <span class="dt">\</span></span>
<span id="cb146-8"><a href="#cb146-8" aria-hidden="true" tabindex="-1"></a>    [--gas-limit <span class="op">&lt;</span>limit<span class="op">&gt;</span>] <span class="dt">\</span></span>
<span id="cb146-9"><a href="#cb146-9" aria-hidden="true" tabindex="-1"></a>    [--salt <span class="op">&lt;</span>salt<span class="op">&gt;</span>]</span>
<span id="cb146-10"><a href="#cb146-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb146-11"><a href="#cb146-11" aria-hidden="true" tabindex="-1"></a><span class="co"># Call contract message</span></span>
<span id="cb146-12"><a href="#cb146-12" aria-hidden="true" tabindex="-1"></a><span class="ex">cargo</span> contract call <span class="dt">\</span></span>
<span id="cb146-13"><a href="#cb146-13" aria-hidden="true" tabindex="-1"></a>    <span class="at">--contract</span> <span class="op">&lt;</span>address<span class="op">&gt;</span> <span class="dt">\</span></span>
<span id="cb146-14"><a href="#cb146-14" aria-hidden="true" tabindex="-1"></a>    <span class="at">--message</span> <span class="op">&lt;</span>message_name<span class="op">&gt;</span> <span class="dt">\</span></span>
<span id="cb146-15"><a href="#cb146-15" aria-hidden="true" tabindex="-1"></a>    <span class="at">--args</span> <span class="op">&lt;</span>arg1<span class="op">&gt;</span> <span class="op">&lt;</span>arg2<span class="op">&gt;</span> ... <span class="dt">\</span></span>
<span id="cb146-16"><a href="#cb146-16" aria-hidden="true" tabindex="-1"></a>    <span class="at">--suri</span> <span class="op">&lt;</span>signer<span class="op">&gt;</span> <span class="dt">\</span></span>
<span id="cb146-17"><a href="#cb146-17" aria-hidden="true" tabindex="-1"></a>    <span class="at">--url</span> <span class="op">&lt;</span>endpoint<span class="op">&gt;</span> <span class="dt">\</span></span>
<span id="cb146-18"><a href="#cb146-18" aria-hidden="true" tabindex="-1"></a>    [--value <span class="op">&lt;</span>amount<span class="op">&gt;</span>] <span class="dt">\</span></span>
<span id="cb146-19"><a href="#cb146-19" aria-hidden="true" tabindex="-1"></a>    [--gas-limit <span class="op">&lt;</span>limit<span class="op">&gt;</span>] <span class="dt">\</span></span>
<span id="cb146-20"><a href="#cb146-20" aria-hidden="true" tabindex="-1"></a>    <span class="pp">[--</span><span class="ss">dry</span><span class="pp">-</span><span class="ss">run</span><span class="pp">]</span></span>
<span id="cb146-21"><a href="#cb146-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb146-22"><a href="#cb146-22" aria-hidden="true" tabindex="-1"></a><span class="co"># Upload contract code (without instantiation)</span></span>
<span id="cb146-23"><a href="#cb146-23" aria-hidden="true" tabindex="-1"></a><span class="ex">cargo</span> contract upload <span class="dt">\</span></span>
<span id="cb146-24"><a href="#cb146-24" aria-hidden="true" tabindex="-1"></a>    <span class="at">--suri</span> <span class="op">&lt;</span>signer<span class="op">&gt;</span> <span class="dt">\</span></span>
<span id="cb146-25"><a href="#cb146-25" aria-hidden="true" tabindex="-1"></a>    <span class="at">--url</span> <span class="op">&lt;</span>endpoint<span class="op">&gt;</span></span>
<span id="cb146-26"><a href="#cb146-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb146-27"><a href="#cb146-27" aria-hidden="true" tabindex="-1"></a><span class="co"># Remove contract from chain</span></span>
<span id="cb146-28"><a href="#cb146-28" aria-hidden="true" tabindex="-1"></a><span class="ex">cargo</span> contract remove <span class="dt">\</span></span>
<span id="cb146-29"><a href="#cb146-29" aria-hidden="true" tabindex="-1"></a>    <span class="at">--contract</span> <span class="op">&lt;</span>address<span class="op">&gt;</span> <span class="dt">\</span></span>
<span id="cb146-30"><a href="#cb146-30" aria-hidden="true" tabindex="-1"></a>    <span class="at">--suri</span> <span class="op">&lt;</span>signer<span class="op">&gt;</span> <span class="dt">\</span></span>
<span id="cb146-31"><a href="#cb146-31" aria-hidden="true" tabindex="-1"></a>    <span class="at">--url</span> <span class="op">&lt;</span>endpoint<span class="op">&gt;</span></span></code></pre></div>
<h3 id="information-and-verification">Information and Verification</h3>
<div class="sourceCode" id="cb147"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb147-1"><a href="#cb147-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Get contract info</span></span>
<span id="cb147-2"><a href="#cb147-2" aria-hidden="true" tabindex="-1"></a><span class="ex">cargo</span> contract info <span class="op">&lt;</span>contract_file.contract<span class="op">&gt;</span></span>
<span id="cb147-3"><a href="#cb147-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb147-4"><a href="#cb147-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Verify contract on chain</span></span>
<span id="cb147-5"><a href="#cb147-5" aria-hidden="true" tabindex="-1"></a><span class="ex">cargo</span> contract verify <span class="dt">\</span></span>
<span id="cb147-6"><a href="#cb147-6" aria-hidden="true" tabindex="-1"></a>    <span class="at">--contract</span> <span class="op">&lt;</span>address<span class="op">&gt;</span> <span class="dt">\</span></span>
<span id="cb147-7"><a href="#cb147-7" aria-hidden="true" tabindex="-1"></a>    <span class="at">--url</span> <span class="op">&lt;</span>endpoint<span class="op">&gt;</span></span>
<span id="cb147-8"><a href="#cb147-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb147-9"><a href="#cb147-9" aria-hidden="true" tabindex="-1"></a><span class="co"># Download contract metadata</span></span>
<span id="cb147-10"><a href="#cb147-10" aria-hidden="true" tabindex="-1"></a><span class="ex">cargo</span> contract download <span class="dt">\</span></span>
<span id="cb147-11"><a href="#cb147-11" aria-hidden="true" tabindex="-1"></a>    <span class="at">--contract</span> <span class="op">&lt;</span>address<span class="op">&gt;</span> <span class="dt">\</span></span>
<span id="cb147-12"><a href="#cb147-12" aria-hidden="true" tabindex="-1"></a>    <span class="at">--url</span> <span class="op">&lt;</span>endpoint<span class="op">&gt;</span></span></code></pre></div>
<h2 id="self.env-reference">self.env() Reference</h2>
<h3 id="account-information">Account Information</h3>
<div class="sourceCode" id="cb148"><pre
class="sourceCode rust"><code class="sourceCode rust"><span id="cb148-1"><a href="#cb148-1" aria-hidden="true" tabindex="-1"></a><span class="co">// Get the caller of current message</span></span>
<span id="cb148-2"><a href="#cb148-2" aria-hidden="true" tabindex="-1"></a><span class="kw">let</span> caller<span class="op">:</span> AccountId <span class="op">=</span> <span class="kw">self</span><span class="op">.</span>env()<span class="op">.</span>caller()<span class="op">;</span></span>
<span id="cb148-3"><a href="#cb148-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb148-4"><a href="#cb148-4" aria-hidden="true" tabindex="-1"></a><span class="co">// Get this contract&#39;s account ID</span></span>
<span id="cb148-5"><a href="#cb148-5" aria-hidden="true" tabindex="-1"></a><span class="kw">let</span> contract_id<span class="op">:</span> AccountId <span class="op">=</span> <span class="kw">self</span><span class="op">.</span>env()<span class="op">.</span>account_id()<span class="op">;</span></span>
<span id="cb148-6"><a href="#cb148-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb148-7"><a href="#cb148-7" aria-hidden="true" tabindex="-1"></a><span class="co">// Get contract&#39;s current balance</span></span>
<span id="cb148-8"><a href="#cb148-8" aria-hidden="true" tabindex="-1"></a><span class="kw">let</span> balance<span class="op">:</span> Balance <span class="op">=</span> <span class="kw">self</span><span class="op">.</span>env()<span class="op">.</span>balance()<span class="op">;</span></span>
<span id="cb148-9"><a href="#cb148-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb148-10"><a href="#cb148-10" aria-hidden="true" tabindex="-1"></a><span class="co">// Get transferred value (for payable messages)</span></span>
<span id="cb148-11"><a href="#cb148-11" aria-hidden="true" tabindex="-1"></a><span class="kw">let</span> value<span class="op">:</span> Balance <span class="op">=</span> <span class="kw">self</span><span class="op">.</span>env()<span class="op">.</span>transferred_value()<span class="op">;</span></span></code></pre></div>
<h3 id="block-information">Block Information</h3>
<div class="sourceCode" id="cb149"><pre
class="sourceCode rust"><code class="sourceCode rust"><span id="cb149-1"><a href="#cb149-1" aria-hidden="true" tabindex="-1"></a><span class="co">// Get current block number</span></span>
<span id="cb149-2"><a href="#cb149-2" aria-hidden="true" tabindex="-1"></a><span class="kw">let</span> block_number<span class="op">:</span> <span class="dt">u32</span> <span class="op">=</span> <span class="kw">self</span><span class="op">.</span>env()<span class="op">.</span>block_number()<span class="op">;</span></span>
<span id="cb149-3"><a href="#cb149-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb149-4"><a href="#cb149-4" aria-hidden="true" tabindex="-1"></a><span class="co">// Get current block timestamp (milliseconds since Unix epoch)</span></span>
<span id="cb149-5"><a href="#cb149-5" aria-hidden="true" tabindex="-1"></a><span class="kw">let</span> timestamp<span class="op">:</span> <span class="dt">u64</span> <span class="op">=</span> <span class="kw">self</span><span class="op">.</span>env()<span class="op">.</span>block_timestamp()<span class="op">;</span></span></code></pre></div>
<h3 id="transaction-operations">Transaction Operations</h3>
<div class="sourceCode" id="cb150"><pre
class="sourceCode rust"><code class="sourceCode rust"><span id="cb150-1"><a href="#cb150-1" aria-hidden="true" tabindex="-1"></a><span class="co">// Transfer native tokens</span></span>
<span id="cb150-2"><a href="#cb150-2" aria-hidden="true" tabindex="-1"></a><span class="kw">self</span><span class="op">.</span>env()<span class="op">.</span>transfer(recipient<span class="op">,</span> amount)<span class="op">?;</span></span>
<span id="cb150-3"><a href="#cb150-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb150-4"><a href="#cb150-4" aria-hidden="true" tabindex="-1"></a><span class="co">// Emit contract event</span></span>
<span id="cb150-5"><a href="#cb150-5" aria-hidden="true" tabindex="-1"></a><span class="kw">self</span><span class="op">.</span>env()<span class="op">.</span>emit_event(MyEvent <span class="op">{</span> field<span class="op">:</span> value <span class="op">}</span>)<span class="op">;</span></span>
<span id="cb150-6"><a href="#cb150-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb150-7"><a href="#cb150-7" aria-hidden="true" tabindex="-1"></a><span class="co">// Terminate contract and transfer remaining balance</span></span>
<span id="cb150-8"><a href="#cb150-8" aria-hidden="true" tabindex="-1"></a><span class="kw">self</span><span class="op">.</span>env()<span class="op">.</span>terminate_contract(beneficiary)<span class="op">;</span></span></code></pre></div>
<h3 id="gas-and-weight">Gas and Weight</h3>
<div class="sourceCode" id="cb151"><pre
class="sourceCode rust"><code class="sourceCode rust"><span id="cb151-1"><a href="#cb151-1" aria-hidden="true" tabindex="-1"></a><span class="co">// Get remaining gas</span></span>
<span id="cb151-2"><a href="#cb151-2" aria-hidden="true" tabindex="-1"></a><span class="kw">let</span> gas_left <span class="op">=</span> <span class="kw">self</span><span class="op">.</span>env()<span class="op">.</span>gas_left()<span class="op">;</span></span>
<span id="cb151-3"><a href="#cb151-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb151-4"><a href="#cb151-4" aria-hidden="true" tabindex="-1"></a><span class="co">// Get weight limit</span></span>
<span id="cb151-5"><a href="#cb151-5" aria-hidden="true" tabindex="-1"></a><span class="kw">let</span> weight_limit <span class="op">=</span> <span class="kw">self</span><span class="op">.</span>env()<span class="op">.</span>weight_to_fee(weight)<span class="op">;</span></span></code></pre></div>
<h2 id="common-patterns-quick-reference">Common Patterns Quick
Reference</h2>
<h3 id="storage-patterns">Storage Patterns</h3>
<div class="sourceCode" id="cb152"><pre
class="sourceCode rust"><code class="sourceCode rust"><span id="cb152-1"><a href="#cb152-1" aria-hidden="true" tabindex="-1"></a><span class="co">// Basic storage with Mapping</span></span>
<span id="cb152-2"><a href="#cb152-2" aria-hidden="true" tabindex="-1"></a><span class="at">#[</span>ink<span class="at">(</span>storage<span class="at">)]</span></span>
<span id="cb152-3"><a href="#cb152-3" aria-hidden="true" tabindex="-1"></a><span class="kw">pub</span> <span class="kw">struct</span> MyContract <span class="op">{</span></span>
<span id="cb152-4"><a href="#cb152-4" aria-hidden="true" tabindex="-1"></a>    value<span class="op">:</span> <span class="dt">u32</span><span class="op">,</span></span>
<span id="cb152-5"><a href="#cb152-5" aria-hidden="true" tabindex="-1"></a>    balances<span class="op">:</span> Mapping<span class="op">&lt;</span>AccountId<span class="op">,</span> Balance<span class="op">&gt;,</span></span>
<span id="cb152-6"><a href="#cb152-6" aria-hidden="true" tabindex="-1"></a>    data<span class="op">:</span> Lazy<span class="op">&lt;</span>LargeStruct<span class="op">&gt;,</span></span>
<span id="cb152-7"><a href="#cb152-7" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb152-8"><a href="#cb152-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb152-9"><a href="#cb152-9" aria-hidden="true" tabindex="-1"></a><span class="co">// Access patterns</span></span>
<span id="cb152-10"><a href="#cb152-10" aria-hidden="true" tabindex="-1"></a><span class="kw">let</span> balance <span class="op">=</span> <span class="kw">self</span><span class="op">.</span>balances<span class="op">.</span>get(account)<span class="op">.</span>unwrap_or(<span class="dv">0</span>)<span class="op">;</span></span>
<span id="cb152-11"><a href="#cb152-11" aria-hidden="true" tabindex="-1"></a><span class="kw">self</span><span class="op">.</span>balances<span class="op">.</span>insert(account<span class="op">,</span> <span class="op">&amp;</span>new_balance)<span class="op">;</span></span>
<span id="cb152-12"><a href="#cb152-12" aria-hidden="true" tabindex="-1"></a><span class="kw">self</span><span class="op">.</span>balances<span class="op">.</span>remove(account)<span class="op">;</span></span></code></pre></div>
<h3 id="error-handling">Error Handling</h3>
<div class="sourceCode" id="cb153"><pre
class="sourceCode rust"><code class="sourceCode rust"><span id="cb153-1"><a href="#cb153-1" aria-hidden="true" tabindex="-1"></a><span class="co">// Define custom errors</span></span>
<span id="cb153-2"><a href="#cb153-2" aria-hidden="true" tabindex="-1"></a><span class="at">#[</span>derive<span class="at">(</span><span class="bu">Debug</span><span class="op">,</span> <span class="bu">PartialEq</span><span class="op">,</span> <span class="bu">Eq</span><span class="op">,</span> <span class="pp">scale::</span>Encode<span class="op">,</span> <span class="pp">scale::</span>Decode<span class="at">)]</span></span>
<span id="cb153-3"><a href="#cb153-3" aria-hidden="true" tabindex="-1"></a><span class="at">#[</span>cfg_attr<span class="at">(</span>feature <span class="op">=</span> <span class="st">&quot;std&quot;</span><span class="op">,</span> derive<span class="at">(</span><span class="pp">scale_info::</span>TypeInfo<span class="at">))]</span></span>
<span id="cb153-4"><a href="#cb153-4" aria-hidden="true" tabindex="-1"></a><span class="kw">pub</span> <span class="kw">enum</span> <span class="bu">Error</span> <span class="op">{</span></span>
<span id="cb153-5"><a href="#cb153-5" aria-hidden="true" tabindex="-1"></a>    InsufficientBalance<span class="op">,</span></span>
<span id="cb153-6"><a href="#cb153-6" aria-hidden="true" tabindex="-1"></a>    Unauthorized<span class="op">,</span></span>
<span id="cb153-7"><a href="#cb153-7" aria-hidden="true" tabindex="-1"></a>    InvalidInput<span class="op">,</span></span>
<span id="cb153-8"><a href="#cb153-8" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb153-9"><a href="#cb153-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb153-10"><a href="#cb153-10" aria-hidden="true" tabindex="-1"></a><span class="co">// Use in messages</span></span>
<span id="cb153-11"><a href="#cb153-11" aria-hidden="true" tabindex="-1"></a><span class="at">#[</span>ink<span class="at">(</span>message<span class="at">)]</span></span>
<span id="cb153-12"><a href="#cb153-12" aria-hidden="true" tabindex="-1"></a><span class="kw">pub</span> <span class="kw">fn</span> transfer(<span class="op">&amp;</span><span class="kw">mut</span> <span class="kw">self</span><span class="op">,</span> to<span class="op">:</span> AccountId<span class="op">,</span> amount<span class="op">:</span> Balance) <span class="op">-&gt;</span> <span class="dt">Result</span><span class="op">&lt;</span>()<span class="op">,</span> <span class="bu">Error</span><span class="op">&gt;</span> <span class="op">{</span></span>
<span id="cb153-13"><a href="#cb153-13" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Safe arithmetic</span></span>
<span id="cb153-14"><a href="#cb153-14" aria-hidden="true" tabindex="-1"></a>    <span class="kw">let</span> new_balance <span class="op">=</span> <span class="kw">self</span><span class="op">.</span>balance</span>
<span id="cb153-15"><a href="#cb153-15" aria-hidden="true" tabindex="-1"></a>        <span class="op">.</span>checked_sub(amount)</span>
<span id="cb153-16"><a href="#cb153-16" aria-hidden="true" tabindex="-1"></a>        <span class="op">.</span>ok_or(<span class="bu">Error</span><span class="pp">::</span>InsufficientBalance)<span class="op">?;</span></span>
<span id="cb153-17"><a href="#cb153-17" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb153-18"><a href="#cb153-18" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Update state</span></span>
<span id="cb153-19"><a href="#cb153-19" aria-hidden="true" tabindex="-1"></a>    <span class="kw">self</span><span class="op">.</span>balance <span class="op">=</span> new_balance<span class="op">;</span></span>
<span id="cb153-20"><a href="#cb153-20" aria-hidden="true" tabindex="-1"></a>    <span class="cn">Ok</span>(())</span>
<span id="cb153-21"><a href="#cb153-21" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<h3 id="event-patterns">Event Patterns</h3>
<div class="sourceCode" id="cb154"><pre
class="sourceCode rust"><code class="sourceCode rust"><span id="cb154-1"><a href="#cb154-1" aria-hidden="true" tabindex="-1"></a><span class="co">// Define events with topics</span></span>
<span id="cb154-2"><a href="#cb154-2" aria-hidden="true" tabindex="-1"></a><span class="at">#[</span>ink<span class="at">(</span>event<span class="at">)]</span></span>
<span id="cb154-3"><a href="#cb154-3" aria-hidden="true" tabindex="-1"></a><span class="kw">pub</span> <span class="kw">struct</span> Transfer <span class="op">{</span></span>
<span id="cb154-4"><a href="#cb154-4" aria-hidden="true" tabindex="-1"></a>    <span class="at">#[</span>ink<span class="at">(</span>topic<span class="at">)]</span></span>
<span id="cb154-5"><a href="#cb154-5" aria-hidden="true" tabindex="-1"></a>    from<span class="op">:</span> <span class="dt">Option</span><span class="op">&lt;</span>AccountId<span class="op">&gt;,</span></span>
<span id="cb154-6"><a href="#cb154-6" aria-hidden="true" tabindex="-1"></a>    <span class="at">#[</span>ink<span class="at">(</span>topic<span class="at">)]</span></span>
<span id="cb154-7"><a href="#cb154-7" aria-hidden="true" tabindex="-1"></a>    to<span class="op">:</span> <span class="dt">Option</span><span class="op">&lt;</span>AccountId<span class="op">&gt;,</span></span>
<span id="cb154-8"><a href="#cb154-8" aria-hidden="true" tabindex="-1"></a>    value<span class="op">:</span> Balance<span class="op">,</span></span>
<span id="cb154-9"><a href="#cb154-9" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb154-10"><a href="#cb154-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb154-11"><a href="#cb154-11" aria-hidden="true" tabindex="-1"></a><span class="co">// Emit events</span></span>
<span id="cb154-12"><a href="#cb154-12" aria-hidden="true" tabindex="-1"></a><span class="kw">self</span><span class="op">.</span>env()<span class="op">.</span>emit_event(Transfer <span class="op">{</span></span>
<span id="cb154-13"><a href="#cb154-13" aria-hidden="true" tabindex="-1"></a>    from<span class="op">:</span> <span class="cn">Some</span>(caller)<span class="op">,</span></span>
<span id="cb154-14"><a href="#cb154-14" aria-hidden="true" tabindex="-1"></a>    to<span class="op">:</span> <span class="cn">Some</span>(recipient)<span class="op">,</span></span>
<span id="cb154-15"><a href="#cb154-15" aria-hidden="true" tabindex="-1"></a>    value<span class="op">:</span> amount<span class="op">,</span></span>
<span id="cb154-16"><a href="#cb154-16" aria-hidden="true" tabindex="-1"></a><span class="op">}</span>)<span class="op">;</span></span></code></pre></div>
<h3 id="access-control">Access Control</h3>
<div class="sourceCode" id="cb155"><pre
class="sourceCode rust"><code class="sourceCode rust"><span id="cb155-1"><a href="#cb155-1" aria-hidden="true" tabindex="-1"></a><span class="co">// Owner-only modifier pattern</span></span>
<span id="cb155-2"><a href="#cb155-2" aria-hidden="true" tabindex="-1"></a><span class="kw">fn</span> ensure_owner(<span class="op">&amp;</span><span class="kw">self</span>) <span class="op">-&gt;</span> <span class="dt">Result</span><span class="op">&lt;</span>()<span class="op">,</span> <span class="bu">Error</span><span class="op">&gt;</span> <span class="op">{</span></span>
<span id="cb155-3"><a href="#cb155-3" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="kw">self</span><span class="op">.</span>env()<span class="op">.</span>caller() <span class="op">!=</span> <span class="kw">self</span><span class="op">.</span>owner <span class="op">{</span></span>
<span id="cb155-4"><a href="#cb155-4" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="cn">Err</span>(<span class="bu">Error</span><span class="pp">::</span>Unauthorized)<span class="op">;</span></span>
<span id="cb155-5"><a href="#cb155-5" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb155-6"><a href="#cb155-6" aria-hidden="true" tabindex="-1"></a>    <span class="cn">Ok</span>(())</span>
<span id="cb155-7"><a href="#cb155-7" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb155-8"><a href="#cb155-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb155-9"><a href="#cb155-9" aria-hidden="true" tabindex="-1"></a><span class="co">// Role-based access control</span></span>
<span id="cb155-10"><a href="#cb155-10" aria-hidden="true" tabindex="-1"></a><span class="kw">fn</span> has_role(<span class="op">&amp;</span><span class="kw">self</span><span class="op">,</span> role<span class="op">:</span> Role<span class="op">,</span> account<span class="op">:</span> AccountId) <span class="op">-&gt;</span> <span class="dt">bool</span> <span class="op">{</span></span>
<span id="cb155-11"><a href="#cb155-11" aria-hidden="true" tabindex="-1"></a>    <span class="kw">self</span><span class="op">.</span>roles<span class="op">.</span>get((role<span class="op">,</span> account))<span class="op">.</span>is_some()</span>
<span id="cb155-12"><a href="#cb155-12" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<h3 id="cross-contract-calls">Cross-Contract Calls</h3>
<div class="sourceCode" id="cb156"><pre
class="sourceCode rust"><code class="sourceCode rust"><span id="cb156-1"><a href="#cb156-1" aria-hidden="true" tabindex="-1"></a><span class="co">// Define interface</span></span>
<span id="cb156-2"><a href="#cb156-2" aria-hidden="true" tabindex="-1"></a><span class="at">#[</span><span class="pp">ink::</span>trait_definition<span class="at">]</span></span>
<span id="cb156-3"><a href="#cb156-3" aria-hidden="true" tabindex="-1"></a><span class="kw">pub</span> <span class="kw">trait</span> MyInterface <span class="op">{</span></span>
<span id="cb156-4"><a href="#cb156-4" aria-hidden="true" tabindex="-1"></a>    <span class="at">#[</span>ink<span class="at">(</span>message<span class="at">)]</span></span>
<span id="cb156-5"><a href="#cb156-5" aria-hidden="true" tabindex="-1"></a>    <span class="kw">fn</span> external_method(<span class="op">&amp;</span><span class="kw">self</span><span class="op">,</span> param<span class="op">:</span> <span class="dt">u32</span>) <span class="op">-&gt;</span> <span class="dt">Result</span><span class="op">&lt;</span><span class="dt">u32</span><span class="op">,</span> <span class="bu">Error</span><span class="op">&gt;;</span></span>
<span id="cb156-6"><a href="#cb156-6" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb156-7"><a href="#cb156-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb156-8"><a href="#cb156-8" aria-hidden="true" tabindex="-1"></a><span class="co">// Call external contract</span></span>
<span id="cb156-9"><a href="#cb156-9" aria-hidden="true" tabindex="-1"></a><span class="kw">let</span> external<span class="op">:</span> <span class="pp">ink::contract_ref!</span>(MyInterface) <span class="op">=</span> external_address<span class="op">.</span>into()<span class="op">;</span></span>
<span id="cb156-10"><a href="#cb156-10" aria-hidden="true" tabindex="-1"></a><span class="kw">let</span> result <span class="op">=</span> external<span class="op">.</span>external_method(value)<span class="op">?;</span></span></code></pre></div>
<h2 id="testing-patterns">Testing Patterns</h2>
<h3 id="unit-test-setup">Unit Test Setup</h3>
<div class="sourceCode" id="cb157"><pre
class="sourceCode rust"><code class="sourceCode rust"><span id="cb157-1"><a href="#cb157-1" aria-hidden="true" tabindex="-1"></a><span class="at">#[</span>cfg<span class="at">(</span>test<span class="at">)]</span></span>
<span id="cb157-2"><a href="#cb157-2" aria-hidden="true" tabindex="-1"></a><span class="kw">mod</span> tests <span class="op">{</span></span>
<span id="cb157-3"><a href="#cb157-3" aria-hidden="true" tabindex="-1"></a>    <span class="kw">use</span> <span class="kw">super</span><span class="pp">::</span><span class="op">*;</span></span>
<span id="cb157-4"><a href="#cb157-4" aria-hidden="true" tabindex="-1"></a>    <span class="kw">use</span> <span class="pp">ink::env::</span>test<span class="op">;</span></span>
<span id="cb157-5"><a href="#cb157-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb157-6"><a href="#cb157-6" aria-hidden="true" tabindex="-1"></a>    <span class="kw">fn</span> default_accounts() <span class="op">-&gt;</span> <span class="pp">ink::env::test::</span>DefaultAccounts<span class="op">&lt;</span><span class="pp">ink::env::</span>DefaultEnvironment<span class="op">&gt;</span> <span class="op">{</span></span>
<span id="cb157-7"><a href="#cb157-7" aria-hidden="true" tabindex="-1"></a>        <span class="pp">ink::env::test::default_accounts::</span><span class="op">&lt;</span><span class="pp">ink::env::</span>DefaultEnvironment<span class="op">&gt;</span>()</span>
<span id="cb157-8"><a href="#cb157-8" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb157-9"><a href="#cb157-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb157-10"><a href="#cb157-10" aria-hidden="true" tabindex="-1"></a>    <span class="kw">fn</span> setup_contract() <span class="op">-&gt;</span> MyContract <span class="op">{</span></span>
<span id="cb157-11"><a href="#cb157-11" aria-hidden="true" tabindex="-1"></a>        <span class="kw">let</span> accounts <span class="op">=</span> default_accounts()<span class="op">;</span></span>
<span id="cb157-12"><a href="#cb157-12" aria-hidden="true" tabindex="-1"></a>        <span class="pp">test::set_caller::</span><span class="op">&lt;</span><span class="pp">ink::env::</span>DefaultEnvironment<span class="op">&gt;</span>(accounts<span class="op">.</span>alice)<span class="op">;</span></span>
<span id="cb157-13"><a href="#cb157-13" aria-hidden="true" tabindex="-1"></a>        <span class="pp">MyContract::</span>new()</span>
<span id="cb157-14"><a href="#cb157-14" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb157-15"><a href="#cb157-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb157-16"><a href="#cb157-16" aria-hidden="true" tabindex="-1"></a>    <span class="at">#[</span><span class="pp">ink::</span>test<span class="at">]</span></span>
<span id="cb157-17"><a href="#cb157-17" aria-hidden="true" tabindex="-1"></a>    <span class="kw">fn</span> test_name() <span class="op">{</span></span>
<span id="cb157-18"><a href="#cb157-18" aria-hidden="true" tabindex="-1"></a>        <span class="kw">let</span> <span class="kw">mut</span> contract <span class="op">=</span> setup_contract()<span class="op">;</span></span>
<span id="cb157-19"><a href="#cb157-19" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Test logic here</span></span>
<span id="cb157-20"><a href="#cb157-20" aria-hidden="true" tabindex="-1"></a>        <span class="pp">assert_eq!</span>(contract<span class="op">.</span>get_value()<span class="op">,</span> expected_value)<span class="op">;</span></span>
<span id="cb157-21"><a href="#cb157-21" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb157-22"><a href="#cb157-22" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<h3 id="e2e-test-setup">E2E Test Setup</h3>
<div class="sourceCode" id="cb158"><pre
class="sourceCode rust"><code class="sourceCode rust"><span id="cb158-1"><a href="#cb158-1" aria-hidden="true" tabindex="-1"></a><span class="at">#[</span>cfg<span class="at">(</span>all<span class="at">(</span>test<span class="op">,</span> feature <span class="op">=</span> <span class="st">&quot;e2e-tests&quot;</span><span class="at">))]</span></span>
<span id="cb158-2"><a href="#cb158-2" aria-hidden="true" tabindex="-1"></a><span class="kw">mod</span> e2e_tests <span class="op">{</span></span>
<span id="cb158-3"><a href="#cb158-3" aria-hidden="true" tabindex="-1"></a>    <span class="kw">use</span> <span class="kw">super</span><span class="pp">::</span><span class="op">*;</span></span>
<span id="cb158-4"><a href="#cb158-4" aria-hidden="true" tabindex="-1"></a>    <span class="kw">use</span> <span class="pp">ink_e2e::</span>build_message<span class="op">;</span></span>
<span id="cb158-5"><a href="#cb158-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb158-6"><a href="#cb158-6" aria-hidden="true" tabindex="-1"></a>    <span class="kw">type</span> E2EResult<span class="op">&lt;</span>T<span class="op">&gt;</span> <span class="op">=</span> <span class="pp">std::result::</span><span class="dt">Result</span><span class="op">&lt;</span>T<span class="op">,</span> <span class="dt">Box</span><span class="op">&lt;</span><span class="kw">dyn</span> <span class="pp">std::error::</span><span class="bu">Error</span><span class="op">&gt;&gt;;</span></span>
<span id="cb158-7"><a href="#cb158-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb158-8"><a href="#cb158-8" aria-hidden="true" tabindex="-1"></a>    <span class="at">#[</span><span class="pp">ink_e2e::</span>test<span class="at">]</span></span>
<span id="cb158-9"><a href="#cb158-9" aria-hidden="true" tabindex="-1"></a>    <span class="kw">async</span> <span class="kw">fn</span> e2e_test(<span class="kw">mut</span> client<span class="op">:</span> <span class="pp">ink_e2e::</span>Client<span class="op">&lt;</span>C<span class="op">,</span> E<span class="op">&gt;</span>) <span class="op">-&gt;</span> E2EResult<span class="op">&lt;</span>()<span class="op">&gt;</span> <span class="op">{</span></span>
<span id="cb158-10"><a href="#cb158-10" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Deploy contract</span></span>
<span id="cb158-11"><a href="#cb158-11" aria-hidden="true" tabindex="-1"></a>        <span class="kw">let</span> constructor <span class="op">=</span> <span class="pp">MyContractRef::</span>new()<span class="op">;</span></span>
<span id="cb158-12"><a href="#cb158-12" aria-hidden="true" tabindex="-1"></a>        <span class="kw">let</span> contract_account_id <span class="op">=</span> client</span>
<span id="cb158-13"><a href="#cb158-13" aria-hidden="true" tabindex="-1"></a>            <span class="op">.</span>instantiate(<span class="st">&quot;my_contract&quot;</span><span class="op">,</span> <span class="op">&amp;</span><span class="pp">ink_e2e::</span>alice()<span class="op">,</span> constructor<span class="op">,</span> <span class="dv">0</span><span class="op">,</span> <span class="cn">None</span>)</span>
<span id="cb158-14"><a href="#cb158-14" aria-hidden="true" tabindex="-1"></a>            <span class="op">.</span><span class="kw">await</span></span>
<span id="cb158-15"><a href="#cb158-15" aria-hidden="true" tabindex="-1"></a>            <span class="op">.</span>expect(<span class="st">&quot;instantiate failed&quot;</span>)</span>
<span id="cb158-16"><a href="#cb158-16" aria-hidden="true" tabindex="-1"></a>            <span class="op">.</span>account_id<span class="op">;</span></span>
<span id="cb158-17"><a href="#cb158-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb158-18"><a href="#cb158-18" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Call message</span></span>
<span id="cb158-19"><a href="#cb158-19" aria-hidden="true" tabindex="-1"></a>        <span class="kw">let</span> message <span class="op">=</span> <span class="pp">build_message::</span><span class="op">&lt;</span>MyContractRef<span class="op">&gt;</span>(contract_account_id<span class="op">.</span>clone())</span>
<span id="cb158-20"><a href="#cb158-20" aria-hidden="true" tabindex="-1"></a>            <span class="op">.</span>call(<span class="op">|</span>contract<span class="op">|</span> contract<span class="op">.</span>my_message())<span class="op">;</span></span>
<span id="cb158-21"><a href="#cb158-21" aria-hidden="true" tabindex="-1"></a>        <span class="kw">let</span> result <span class="op">=</span> client<span class="op">.</span>call(<span class="op">&amp;</span><span class="pp">ink_e2e::</span>alice()<span class="op">,</span> message<span class="op">,</span> <span class="dv">0</span><span class="op">,</span> <span class="cn">None</span>)<span class="op">.</span><span class="kw">await</span><span class="op">;</span></span>
<span id="cb158-22"><a href="#cb158-22" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb158-23"><a href="#cb158-23" aria-hidden="true" tabindex="-1"></a>        <span class="pp">assert!</span>(result<span class="op">.</span>is_ok())<span class="op">;</span></span>
<span id="cb158-24"><a href="#cb158-24" aria-hidden="true" tabindex="-1"></a>        <span class="cn">Ok</span>(())</span>
<span id="cb158-25"><a href="#cb158-25" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb158-26"><a href="#cb158-26" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<h2 id="build-configuration">Build Configuration</h2>
<h3 id="cargo.toml-template">Cargo.toml Template</h3>
<div class="sourceCode" id="cb159"><pre
class="sourceCode toml"><code class="sourceCode toml"><span id="cb159-1"><a href="#cb159-1" aria-hidden="true" tabindex="-1"></a><span class="kw">[package]</span></span>
<span id="cb159-2"><a href="#cb159-2" aria-hidden="true" tabindex="-1"></a><span class="dt">name</span> <span class="op">=</span> <span class="st">&quot;my_contract&quot;</span></span>
<span id="cb159-3"><a href="#cb159-3" aria-hidden="true" tabindex="-1"></a><span class="dt">version</span> <span class="op">=</span> <span class="st">&quot;0.1.0&quot;</span></span>
<span id="cb159-4"><a href="#cb159-4" aria-hidden="true" tabindex="-1"></a><span class="dt">authors</span> <span class="op">=</span> <span class="op">[</span><span class="st">&quot;Your Name &lt;your.email@example.com&gt;&quot;</span><span class="op">]</span></span>
<span id="cb159-5"><a href="#cb159-5" aria-hidden="true" tabindex="-1"></a><span class="dt">edition</span> <span class="op">=</span> <span class="st">&quot;2021&quot;</span></span>
<span id="cb159-6"><a href="#cb159-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb159-7"><a href="#cb159-7" aria-hidden="true" tabindex="-1"></a><span class="kw">[dependencies]</span></span>
<span id="cb159-8"><a href="#cb159-8" aria-hidden="true" tabindex="-1"></a><span class="dt">ink</span> <span class="op">=</span> <span class="op">{ </span><span class="dt">version</span><span class="op"> =</span> <span class="st">&quot;4.3&quot;</span><span class="op">, </span><span class="dt">default-features</span><span class="op"> =</span> <span class="cn">false</span><span class="op"> }</span></span>
<span id="cb159-9"><a href="#cb159-9" aria-hidden="true" tabindex="-1"></a><span class="dt">scale</span> <span class="op">=</span> <span class="op">{ </span><span class="dt">package</span><span class="op"> =</span> <span class="st">&quot;parity-scale-codec&quot;</span><span class="op">, </span><span class="dt">version</span><span class="op"> =</span> <span class="st">&quot;3&quot;</span><span class="op">, </span><span class="dt">default-features</span><span class="op"> =</span> <span class="cn">false</span><span class="op">, </span><span class="dt">features</span><span class="op"> =</span> <span class="op">[</span><span class="st">&quot;derive&quot;</span><span class="op">] }</span></span>
<span id="cb159-10"><a href="#cb159-10" aria-hidden="true" tabindex="-1"></a><span class="dt">scale-info</span> <span class="op">=</span> <span class="op">{ </span><span class="dt">version</span><span class="op"> =</span> <span class="st">&quot;2.6&quot;</span><span class="op">, </span><span class="dt">default-features</span><span class="op"> =</span> <span class="cn">false</span><span class="op">, </span><span class="dt">features</span><span class="op"> =</span> <span class="op">[</span><span class="st">&quot;derive&quot;</span><span class="op">], </span><span class="dt">optional</span><span class="op"> =</span> <span class="cn">true</span><span class="op"> }</span></span>
<span id="cb159-11"><a href="#cb159-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb159-12"><a href="#cb159-12" aria-hidden="true" tabindex="-1"></a><span class="kw">[dev-dependencies]</span></span>
<span id="cb159-13"><a href="#cb159-13" aria-hidden="true" tabindex="-1"></a><span class="dt">ink_e2e</span> <span class="op">=</span> <span class="st">&quot;4.3&quot;</span></span>
<span id="cb159-14"><a href="#cb159-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb159-15"><a href="#cb159-15" aria-hidden="true" tabindex="-1"></a><span class="kw">[lib]</span></span>
<span id="cb159-16"><a href="#cb159-16" aria-hidden="true" tabindex="-1"></a><span class="dt">path</span> <span class="op">=</span> <span class="st">&quot;lib.rs&quot;</span></span>
<span id="cb159-17"><a href="#cb159-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb159-18"><a href="#cb159-18" aria-hidden="true" tabindex="-1"></a><span class="kw">[features]</span></span>
<span id="cb159-19"><a href="#cb159-19" aria-hidden="true" tabindex="-1"></a><span class="dt">default</span> <span class="op">=</span> <span class="op">[</span><span class="st">&quot;std&quot;</span><span class="op">]</span></span>
<span id="cb159-20"><a href="#cb159-20" aria-hidden="true" tabindex="-1"></a><span class="dt">std</span> <span class="op">=</span> <span class="op">[</span></span>
<span id="cb159-21"><a href="#cb159-21" aria-hidden="true" tabindex="-1"></a>    <span class="st">&quot;ink/std&quot;</span><span class="op">,</span></span>
<span id="cb159-22"><a href="#cb159-22" aria-hidden="true" tabindex="-1"></a>    <span class="st">&quot;scale/std&quot;</span><span class="op">,</span></span>
<span id="cb159-23"><a href="#cb159-23" aria-hidden="true" tabindex="-1"></a>    <span class="st">&quot;scale-info/std&quot;</span><span class="op">,</span></span>
<span id="cb159-24"><a href="#cb159-24" aria-hidden="true" tabindex="-1"></a><span class="op">]</span></span>
<span id="cb159-25"><a href="#cb159-25" aria-hidden="true" tabindex="-1"></a><span class="dt">ink-as-dependency</span> <span class="op">=</span> <span class="op">[]</span></span>
<span id="cb159-26"><a href="#cb159-26" aria-hidden="true" tabindex="-1"></a><span class="dt">e2e-tests</span> <span class="op">=</span> <span class="op">[]</span></span>
<span id="cb159-27"><a href="#cb159-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb159-28"><a href="#cb159-28" aria-hidden="true" tabindex="-1"></a><span class="kw">[profile.release]</span></span>
<span id="cb159-29"><a href="#cb159-29" aria-hidden="true" tabindex="-1"></a><span class="dt">overflow-checks</span> <span class="op">=</span> <span class="cn">false</span></span>
<span id="cb159-30"><a href="#cb159-30" aria-hidden="true" tabindex="-1"></a><span class="dt">lto</span> <span class="op">=</span> <span class="cn">true</span></span>
<span id="cb159-31"><a href="#cb159-31" aria-hidden="true" tabindex="-1"></a><span class="dt">codegen-units</span> <span class="op">=</span> <span class="dv">1</span></span>
<span id="cb159-32"><a href="#cb159-32" aria-hidden="true" tabindex="-1"></a><span class="dt">panic</span> <span class="op">=</span> <span class="st">&quot;abort&quot;</span></span></code></pre></div>
<h3 id="optimization-settings">Optimization Settings</h3>
<div class="sourceCode" id="cb160"><pre
class="sourceCode toml"><code class="sourceCode toml"><span id="cb160-1"><a href="#cb160-1" aria-hidden="true" tabindex="-1"></a><span class="co"># .cargo/config.toml</span></span>
<span id="cb160-2"><a href="#cb160-2" aria-hidden="true" tabindex="-1"></a><span class="kw">[build]</span></span>
<span id="cb160-3"><a href="#cb160-3" aria-hidden="true" tabindex="-1"></a><span class="dt">target</span> <span class="op">=</span> <span class="st">&quot;wasm32-unknown-unknown&quot;</span></span>
<span id="cb160-4"><a href="#cb160-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb160-5"><a href="#cb160-5" aria-hidden="true" tabindex="-1"></a><span class="kw">[target.wasm32-unknown-unknown]</span></span>
<span id="cb160-6"><a href="#cb160-6" aria-hidden="true" tabindex="-1"></a><span class="dt">rustflags</span> <span class="op">=</span> <span class="op">[</span></span>
<span id="cb160-7"><a href="#cb160-7" aria-hidden="true" tabindex="-1"></a>  <span class="st">&quot;-C&quot;</span><span class="op">,</span> <span class="st">&quot;link-arg=-z&quot;</span><span class="op">,</span></span>
<span id="cb160-8"><a href="#cb160-8" aria-hidden="true" tabindex="-1"></a>  <span class="st">&quot;-C&quot;</span><span class="op">,</span> <span class="st">&quot;link-arg=stack-size=65536&quot;</span><span class="op">,</span></span>
<span id="cb160-9"><a href="#cb160-9" aria-hidden="true" tabindex="-1"></a>  <span class="st">&quot;-C&quot;</span><span class="op">,</span> <span class="st">&quot;link-arg=--import-memory&quot;</span><span class="op">,</span></span>
<span id="cb160-10"><a href="#cb160-10" aria-hidden="true" tabindex="-1"></a>  <span class="st">&quot;-C&quot;</span><span class="op">,</span> <span class="st">&quot;target-feature=+bulk-memory&quot;</span><span class="op">,</span></span>
<span id="cb160-11"><a href="#cb160-11" aria-hidden="true" tabindex="-1"></a><span class="op">]</span></span></code></pre></div>
<h2 id="network-endpoints">Network Endpoints</h2>
<h3 id="testnet-endpoints">Testnet Endpoints</h3>
<div class="sourceCode" id="cb161"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb161-1"><a href="#cb161-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Rococo Contracts Parachain (Testnet)</span></span>
<span id="cb161-2"><a href="#cb161-2" aria-hidden="true" tabindex="-1"></a><span class="ex">wss://rococo-contracts-rpc.polkadot.io</span></span>
<span id="cb161-3"><a href="#cb161-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb161-4"><a href="#cb161-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Local Development Node</span></span>
<span id="cb161-5"><a href="#cb161-5" aria-hidden="true" tabindex="-1"></a><span class="ex">ws://127.0.0.1:9944</span></span></code></pre></div>
<h3 id="development-tools">Development Tools</h3>
<div class="sourceCode" id="cb162"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb162-1"><a href="#cb162-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Install local contracts node</span></span>
<span id="cb162-2"><a href="#cb162-2" aria-hidden="true" tabindex="-1"></a><span class="ex">cargo</span> install contracts-node <span class="at">--git</span> https://github.com/paritytech/substrate-contracts-node.git</span>
<span id="cb162-3"><a href="#cb162-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb162-4"><a href="#cb162-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Start local node</span></span>
<span id="cb162-5"><a href="#cb162-5" aria-hidden="true" tabindex="-1"></a><span class="ex">substrate-contracts-node</span> <span class="at">--dev</span> <span class="at">--tmp</span></span>
<span id="cb162-6"><a href="#cb162-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb162-7"><a href="#cb162-7" aria-hidden="true" tabindex="-1"></a><span class="co"># Contracts UI</span></span>
<span id="cb162-8"><a href="#cb162-8" aria-hidden="true" tabindex="-1"></a><span class="ex">https://ui.use.ink/</span></span></code></pre></div>
<h2 id="common-error-solutions">Common Error Solutions</h2>
<h3 id="compilation-errors">Compilation Errors</h3>
<div class="sourceCode" id="cb163"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb163-1"><a href="#cb163-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Error: &quot;could not find `Cargo.toml`&quot;</span></span>
<span id="cb163-2"><a href="#cb163-2" aria-hidden="true" tabindex="-1"></a><span class="co"># Solution: Run commands from project root directory</span></span>
<span id="cb163-3"><a href="#cb163-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb163-4"><a href="#cb163-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Error: &quot;target `wasm32-unknown-unknown` not found&quot;</span></span>
<span id="cb163-5"><a href="#cb163-5" aria-hidden="true" tabindex="-1"></a><span class="co"># Solution: Add WebAssembly target</span></span>
<span id="cb163-6"><a href="#cb163-6" aria-hidden="true" tabindex="-1"></a><span class="ex">rustup</span> target add wasm32-unknown-unknown</span>
<span id="cb163-7"><a href="#cb163-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb163-8"><a href="#cb163-8" aria-hidden="true" tabindex="-1"></a><span class="co"># Error: &quot;cargo-contract not found&quot;</span></span>
<span id="cb163-9"><a href="#cb163-9" aria-hidden="true" tabindex="-1"></a><span class="co"># Solution: Install cargo-contract</span></span>
<span id="cb163-10"><a href="#cb163-10" aria-hidden="true" tabindex="-1"></a><span class="ex">cargo</span> install cargo-contract <span class="at">--force</span></span></code></pre></div>
<h3 id="runtime-errors">Runtime Errors</h3>
<div class="sourceCode" id="cb164"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb164-1"><a href="#cb164-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Error: &quot;Module not found&quot;</span></span>
<span id="cb164-2"><a href="#cb164-2" aria-hidden="true" tabindex="-1"></a><span class="co"># Solution: Check contract address and network</span></span>
<span id="cb164-3"><a href="#cb164-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb164-4"><a href="#cb164-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Error: &quot;Insufficient gas&quot;</span></span>
<span id="cb164-5"><a href="#cb164-5" aria-hidden="true" tabindex="-1"></a><span class="co"># Solution: Increase gas limit</span></span>
<span id="cb164-6"><a href="#cb164-6" aria-hidden="true" tabindex="-1"></a><span class="ex">--gas-limit</span> 100000000000</span>
<span id="cb164-7"><a href="#cb164-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb164-8"><a href="#cb164-8" aria-hidden="true" tabindex="-1"></a><span class="co"># Error: &quot;Insufficient balance&quot;</span></span>
<span id="cb164-9"><a href="#cb164-9" aria-hidden="true" tabindex="-1"></a><span class="co"># Solution: Fund account or reduce transfer amount</span></span></code></pre></div>
<h2 id="further-resources">Further Resources</h2>
<h3 id="official-documentation">Official Documentation</h3>
<ul>
<li><a href="https://use.ink/">ink! Documentation</a></li>
<li><a href="https://docs.polkadot.com/">polkadot-sdk
Documentation</a></li>
</ul>
<h3 id="community-resources">Community Resources</h3>
<ul>
<li><a href="https://substrate.stackexchange.com/">polkadot-sdk Stack
Exchange</a></li>
<li><a href="https://github.com/use-ink/ink">GitHub Repository</a></li>
</ul>
<h3 id="educational-content">Educational Content</h3>
<ul>
<li><a href="https://github.com/use-ink/ink-examples">ink! Examples
Repository</a></li>
</ul>
<h3 id="development-tools-1">Development Tools</h3>
<ul>
<li><a href="https://ui.use.ink/">Contracts UI</a></li>
<li><a href="https://polkadot.js.org/apps/">Polkadot.js Apps</a></li>
<li><a
href="https://github.com/paritytech/substrate-contracts-node">polkadot-sdk
Contracts Node</a></li>
</ul>
<h3 id="security-resources">Security Resources</h3>
<ul>
<li><a href="https://use.ink/docs/v6/linter/overview">ink!
Linter</a></li>
</ul>
<p>This appendix serves as your quick reference guide for daily ink!
development. Bookmark it for easy access to commands, patterns, and
resources that will accelerate your smart contract development
workflow.</p>
<hr />
<h2 id="about-this-book">About This Book</h2>
<p>This book was created to provide a comprehensive guide to ink! smart
contract development on Substrate. It covers everything from basic
concepts to advanced production patterns, including:</p>
<ul>
<li>Complete development environment setup</li>
<li>Storage management and optimization</li>
<li>Advanced design patterns and architectures</li>
<li>Comprehensive testing strategies</li>
<li>Security best practices</li>
<li>Production deployment workflows</li>
<li>A complete DAO implementation project</li>
</ul>
<h3 id="technical-specifications">Technical Specifications</h3>
<ul>
<li><strong>ink! Version</strong>: 6.x series</li>
<li><strong>Rust Edition</strong>: 2021</li>
<li><strong>Primary Toolchain</strong>: cargo-contract</li>
<li><strong>Target Environment</strong>: WebAssembly (WASM)</li>
<li><strong>Blockchain Framework</strong>: polkadot-sdk with
pallet-contracts</li>
</ul>
<h3 id="contributing">Contributing</h3>
<p>This book is designed to be a living resource for the ink! community.
For updates, corrections, or contributions, please refer to the project
repository: https://github.com/niklabh/inkbook.</p>
<h3 id="license">License</h3>
<p>This work is intended for educational purposes and represents best
practices as of the publication date. Smart contract development
involves financial risks, and readers should conduct thorough testing
and security audits before deploying contracts in production
environments.</p>
<hr />
<p><em>End of Book</em></p>
</body>
</html>
